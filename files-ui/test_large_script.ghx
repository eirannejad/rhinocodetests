<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<Archive name="Root">
  <!--Grasshopper archive-->
  <!--Grasshopper and GH_IO.dll are copyrighted by Robert McNeel & Associates-->
  <!--Archive generated by GH_IO.dll file utility library {0.2.0002}-->
  <items count="1">
    <item name="ArchiveVersion" type_name="gh_version" type_code="80">
      <Major>0</Major>
      <Minor>2</Minor>
      <Revision>2</Revision>
    </item>
  </items>
  <chunks count="2">
    <chunk name="Definition">
      <items count="1">
        <item name="plugin_version" type_name="gh_version" type_code="80">
          <Major>1</Major>
          <Minor>0</Minor>
          <Revision>8</Revision>
        </item>
      </items>
      <chunks count="5">
        <chunk name="DocumentHeader">
          <items count="5">
            <item name="DocumentID" type_name="gh_guid" type_code="9">21989228-0aa5-4bc5-9448-e3b79fd43de9</item>
            <item name="Preview" type_name="gh_string" type_code="10">Shaded</item>
            <item name="PreviewMeshType" type_name="gh_int32" type_code="3">1</item>
            <item name="PreviewNormal" type_name="gh_drawing_color" type_code="36">
              <ARGB>100;150;0;0</ARGB>
            </item>
            <item name="PreviewSelected" type_name="gh_drawing_color" type_code="36">
              <ARGB>100;0;150;0</ARGB>
            </item>
          </items>
        </chunk>
        <chunk name="DefinitionProperties">
          <items count="4">
            <item name="Date" type_name="gh_date" type_code="8">638738281461440368</item>
            <item name="Description" type_name="gh_string" type_code="10"></item>
            <item name="KeepOpen" type_name="gh_bool" type_code="1">false</item>
            <item name="Name" type_name="gh_string" type_code="10">test_large_script.ghx</item>
          </items>
          <chunks count="3">
            <chunk name="Revisions">
              <items count="1">
                <item name="RevisionCount" type_name="gh_int32" type_code="3">0</item>
              </items>
            </chunk>
            <chunk name="Projection">
              <items count="2">
                <item name="Target" type_name="gh_drawing_point" type_code="30">
                  <X>247</X>
                  <Y>130</Y>
                </item>
                <item name="Zoom" type_name="gh_single" type_code="5">1.384083</item>
              </items>
            </chunk>
            <chunk name="Views">
              <items count="1">
                <item name="ViewCount" type_name="gh_int32" type_code="3">0</item>
              </items>
            </chunk>
          </chunks>
        </chunk>
        <chunk name="RcpLayout">
          <items count="1">
            <item name="GroupCount" type_name="gh_int32" type_code="3">0</item>
          </items>
        </chunk>
        <chunk name="GHALibraries">
          <items count="1">
            <item name="Count" type_name="gh_int32" type_code="3">1</item>
          </items>
          <chunks count="1">
            <chunk name="Library" index="0">
              <items count="4">
                <item name="Author" type_name="gh_string" type_code="10">Robert McNeel &amp; Associates</item>
                <item name="Id" type_name="gh_guid" type_code="9">00000000-0000-0000-0000-000000000000</item>
                <item name="Name" type_name="gh_string" type_code="10">Grasshopper</item>
                <item name="Version" type_name="gh_string" type_code="10">8.17.25030.1000</item>
              </items>
            </chunk>
          </chunks>
        </chunk>
        <chunk name="DefinitionObjects">
          <items count="1">
            <item name="ObjectCount" type_name="gh_int32" type_code="3">1</item>
          </items>
          <chunks count="1">
            <chunk name="Object" index="0">
              <items count="2">
                <item name="GUID" type_name="gh_guid" type_code="9">719467e6-7cf5-4848-99b0-c5dd57e5442c</item>
                <item name="Name" type_name="gh_string" type_code="10">Python 3 Script</item>
              </items>
              <chunks count="1">
                <chunk name="Container">
                  <items count="15">
                    <item name="Description" type_name="gh_string" type_code="10"></item>
                    <item name="GraftStandardOutputLines" type_name="gh_bool" type_code="1">true</item>
                    <item name="InstanceGuid" type_name="gh_guid" type_code="9">8059dcc4-a701-416f-b32d-a4aadc366d9a</item>
                    <item name="Locked" type_name="gh_bool" type_code="1">true</item>
                    <item name="MarshGuids" type_name="gh_bool" type_code="1">true</item>
                    <item name="MarshInputs" type_name="gh_bool" type_code="1">true</item>
                    <item name="MarshOutputs" type_name="gh_bool" type_code="1">true</item>
                    <item name="Name" type_name="gh_string" type_code="10">Python 3 Script</item>
                    <item name="NickName" type_name="gh_string" type_code="10">Py3</item>
                    <item name="ScriptComponentVersion" type_name="gh_int32" type_code="3">3</item>
                    <item name="Tooltip" type_name="gh_string" type_code="10"></item>
                    <item name="UsingLibraryInputParam" type_name="gh_bool" type_code="1">false</item>
                    <item name="UsingScriptInputParam" type_name="gh_bool" type_code="1">false</item>
                    <item name="UsingScriptOutputParam" type_name="gh_bool" type_code="1">false</item>
                    <item name="UsingStandardOutputParam" type_name="gh_bool" type_code="1">true</item>
                  </items>
                  <chunks count="4">
                    <chunk name="Attributes">
                      <items count="3">
                        <item name="Bounds" type_name="gh_drawing_rectanglef" type_code="35">
                          <X>117</X>
                          <Y>84</Y>
                          <W>72</W>
                          <H>44</H>
                        </item>
                        <item name="Pivot" type_name="gh_drawing_pointf" type_code="31">
                          <X>146</X>
                          <Y>106</Y>
                        </item>
                        <item name="Selected" type_name="gh_bool" type_code="1">true</item>
                      </items>
                    </chunk>
                    <chunk name="ParameterData">
                      <items count="6">
                        <item name="InputCount" type_name="gh_int32" type_code="3">2</item>
                        <item name="InputId" index="0" type_name="gh_guid" type_code="9">08908df5-fa14-4982-9ab2-1aa0927566aa</item>
                        <item name="InputId" index="1" type_name="gh_guid" type_code="9">08908df5-fa14-4982-9ab2-1aa0927566aa</item>
                        <item name="OutputCount" type_name="gh_int32" type_code="3">2</item>
                        <item name="OutputId" index="0" type_name="gh_guid" type_code="9">3ede854e-c753-40eb-84cb-b48008f14fd4</item>
                        <item name="OutputId" index="1" type_name="gh_guid" type_code="9">08908df5-fa14-4982-9ab2-1aa0927566aa</item>
                      </items>
                      <chunks count="4">
                        <chunk name="InputParam" index="0">
                          <items count="13">
                            <item name="AllowTreeAccess" type_name="gh_bool" type_code="1">true</item>
                            <item name="Description" type_name="gh_string" type_code="10">rhinoscriptsyntax geometry</item>
                            <item name="InstanceGuid" type_name="gh_guid" type_code="9">9faeda23-5b80-4229-addf-1747751402b5</item>
                            <item name="Locked" type_name="gh_bool" type_code="1">true</item>
                            <item name="Name" type_name="gh_string" type_code="10">x</item>
                            <item name="NickName" type_name="gh_string" type_code="10">x</item>
                            <item name="Optional" type_name="gh_bool" type_code="1">true</item>
                            <item name="ScriptParamAccess" type_name="gh_int32" type_code="3">0</item>
                            <item name="ScriptParameterVersion" type_name="gh_int32" type_code="3">2</item>
                            <item name="ShowTypeHints" type_name="gh_bool" type_code="1">true</item>
                            <item name="SourceCount" type_name="gh_int32" type_code="3">0</item>
                            <item name="ToolTip" type_name="gh_string" type_code="10"></item>
                            <item name="TypeHintID" type_name="gh_guid" type_code="9">1c282eeb-dd16-439f-94e4-7d92b542fe8b</item>
                          </items>
                          <chunks count="2">
                            <chunk name="Attributes">
                              <items count="3">
                                <item name="Bounds" type_name="gh_drawing_rectanglef" type_code="35">
                                  <X>119</X>
                                  <Y>86</Y>
                                  <W>12</W>
                                  <H>20</H>
                                </item>
                                <item name="Pivot" type_name="gh_drawing_pointf" type_code="31">
                                  <X>126.5</X>
                                  <Y>96</Y>
                                </item>
                                <item name="Selected" type_name="gh_bool" type_code="1">true</item>
                              </items>
                            </chunk>
                            <chunk name="ConverterData">
                              <items count="2">
                                <item name="AssemblyName" type_name="gh_string" type_code="10">System.Private.CoreLib</item>
                                <item name="TypeName" type_name="gh_string" type_code="10">System.Object</item>
                              </items>
                            </chunk>
                          </chunks>
                        </chunk>
                        <chunk name="InputParam" index="1">
                          <items count="13">
                            <item name="AllowTreeAccess" type_name="gh_bool" type_code="1">true</item>
                            <item name="Description" type_name="gh_string" type_code="10">rhinoscriptsyntax geometry</item>
                            <item name="InstanceGuid" type_name="gh_guid" type_code="9">5e3b9eda-a833-4db9-a647-2d15f1a9dc17</item>
                            <item name="Locked" type_name="gh_bool" type_code="1">true</item>
                            <item name="Name" type_name="gh_string" type_code="10">y</item>
                            <item name="NickName" type_name="gh_string" type_code="10">y</item>
                            <item name="Optional" type_name="gh_bool" type_code="1">true</item>
                            <item name="ScriptParamAccess" type_name="gh_int32" type_code="3">0</item>
                            <item name="ScriptParameterVersion" type_name="gh_int32" type_code="3">2</item>
                            <item name="ShowTypeHints" type_name="gh_bool" type_code="1">true</item>
                            <item name="SourceCount" type_name="gh_int32" type_code="3">0</item>
                            <item name="ToolTip" type_name="gh_string" type_code="10"></item>
                            <item name="TypeHintID" type_name="gh_guid" type_code="9">1c282eeb-dd16-439f-94e4-7d92b542fe8b</item>
                          </items>
                          <chunks count="2">
                            <chunk name="Attributes">
                              <items count="3">
                                <item name="Bounds" type_name="gh_drawing_rectanglef" type_code="35">
                                  <X>119</X>
                                  <Y>106</Y>
                                  <W>12</W>
                                  <H>20</H>
                                </item>
                                <item name="Pivot" type_name="gh_drawing_pointf" type_code="31">
                                  <X>126.5</X>
                                  <Y>116</Y>
                                </item>
                                <item name="Selected" type_name="gh_bool" type_code="1">true</item>
                              </items>
                            </chunk>
                            <chunk name="ConverterData">
                              <items count="2">
                                <item name="AssemblyName" type_name="gh_string" type_code="10">System.Private.CoreLib</item>
                                <item name="TypeName" type_name="gh_string" type_code="10">System.Object</item>
                              </items>
                            </chunk>
                          </chunks>
                        </chunk>
                        <chunk name="OutputParam" index="0">
                          <items count="7">
                            <item name="Description" type_name="gh_string" type_code="10">Standard output and error contents collected during script run</item>
                            <item name="InstanceGuid" type_name="gh_guid" type_code="9">81a81d0b-fab6-42f9-9a76-6b3cd959edad</item>
                            <item name="Locked" type_name="gh_bool" type_code="1">true</item>
                            <item name="Name" type_name="gh_string" type_code="10">out</item>
                            <item name="NickName" type_name="gh_string" type_code="10">out</item>
                            <item name="Optional" type_name="gh_bool" type_code="1">false</item>
                            <item name="SourceCount" type_name="gh_int32" type_code="3">0</item>
                          </items>
                          <chunks count="1">
                            <chunk name="Attributes">
                              <items count="3">
                                <item name="Bounds" type_name="gh_drawing_rectanglef" type_code="35">
                                  <X>161</X>
                                  <Y>86</Y>
                                  <W>26</W>
                                  <H>20</H>
                                </item>
                                <item name="Pivot" type_name="gh_drawing_pointf" type_code="31">
                                  <X>174</X>
                                  <Y>96</Y>
                                </item>
                                <item name="Selected" type_name="gh_bool" type_code="1">true</item>
                              </items>
                            </chunk>
                          </chunks>
                        </chunk>
                        <chunk name="OutputParam" index="1">
                          <items count="13">
                            <item name="AllowTreeAccess" type_name="gh_bool" type_code="1">false</item>
                            <item name="Description" type_name="gh_string" type_code="10">rhinoscriptsyntax geometry</item>
                            <item name="InstanceGuid" type_name="gh_guid" type_code="9">74d74857-c867-479b-805a-ddd4520ae737</item>
                            <item name="Locked" type_name="gh_bool" type_code="1">true</item>
                            <item name="Name" type_name="gh_string" type_code="10">a</item>
                            <item name="NickName" type_name="gh_string" type_code="10">a</item>
                            <item name="Optional" type_name="gh_bool" type_code="1">false</item>
                            <item name="ScriptParamAccess" type_name="gh_int32" type_code="3">0</item>
                            <item name="ScriptParameterVersion" type_name="gh_int32" type_code="3">2</item>
                            <item name="ShowTypeHints" type_name="gh_bool" type_code="1">true</item>
                            <item name="SourceCount" type_name="gh_int32" type_code="3">0</item>
                            <item name="ToolTip" type_name="gh_string" type_code="10"></item>
                            <item name="TypeHintID" type_name="gh_guid" type_code="9">1c282eeb-dd16-439f-94e4-7d92b542fe8b</item>
                          </items>
                          <chunks count="2">
                            <chunk name="Attributes">
                              <items count="3">
                                <item name="Bounds" type_name="gh_drawing_rectanglef" type_code="35">
                                  <X>161</X>
                                  <Y>106</Y>
                                  <W>26</W>
                                  <H>20</H>
                                </item>
                                <item name="Pivot" type_name="gh_drawing_pointf" type_code="31">
                                  <X>174</X>
                                  <Y>116</Y>
                                </item>
                                <item name="Selected" type_name="gh_bool" type_code="1">true</item>
                              </items>
                            </chunk>
                            <chunk name="ConverterData">
                              <items count="2">
                                <item name="AssemblyName" type_name="gh_string" type_code="10">System.Private.CoreLib</item>
                                <item name="TypeName" type_name="gh_string" type_code="10">System.Object</item>
                              </items>
                            </chunk>
                          </chunks>
                        </chunk>
                      </chunks>
                    </chunk>
                    <chunk name="Script">
                      <items count="5">
                        <item name="MarshGuids" type_name="gh_bool" type_code="1">true</item>
                        <item name="MarshInputs" type_name="gh_bool" type_code="1">true</item>
                        <item name="MarshOutputs" type_name="gh_bool" type_code="1">true</item>
                        <item name="Text" type_name="gh_string" type_code="10">IiIicHlSZXZpdCByb290IGxldmVsIGNvbmZpZyBmb3IgYWxsIHB5cmV2aXQgc3ViLW1vZHVsZXMuDQoNCkV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBEQiwgVUkNCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBQeVJldml0RXhjZXB0aW9uLCBQeVJldml0SU9FcnJvcg0KDQogICAgICAgICMgcHlyZXZpdCBtb2R1bGUgaGFzIGdsb2JhbCBpbnN0YW5jZSBvZiB0aGUNCiAgICAgICAgIyBfSG9zdEFwcFBvc3RhYmxlQ29tbWFuZCBhbmQgX0V4ZWN1dG9yUGFyYW1zIGNsYXNzZXMgYWxyZWFkeSBjcmVhdGVkDQogICAgICAgICMgaW1wb3J0IGFuZCB1c2UgdGhlbSBsaWtlIGJlbG93DQogICAgICAgIGZyb20gcHlyZXZpdCBpbXBvcnQgSE9TVF9BUFANCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBFWEVDX1BBUkFNUw0KICAgICAgICBgYGANCiIiIg0KI3B5bGludDogZGlzYWJsZT1XMDcwMyxDMDMwMixDMDEwMyxDMDQxMyxyYWlzZS1taXNzaW5nLWZyb20NCmltcG9ydCBzeXMNCmltcG9ydCBvcw0KaW1wb3J0IG9zLnBhdGggYXMgb3ANCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IG5hbWVkdHVwbGUNCmltcG9ydCB0cmFjZWJhY2sNCmltcG9ydCByZQ0KDQppbXBvcnQgY2xyICAjIHB5bGludDogZGlzYWJsZT1FMDQwMQ0KDQppbXBvcnQgU3lzdGVtDQppbXBvcnQgU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzIGFzIFNSSQ0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IGNvbXBhdA0KDQpQWVJFVklUX0FERE9OX05BTUUgPSAncHlSZXZpdCcNClBZUkVWSVRfQ0xJX05BTUUgPSAncHlyZXZpdC5leGUnDQoNCiMgZXh0cmFjdCB2ZXJzaW9uIGZyb20gdmVyc2lvbiBmaWxlDQpWRVJTSU9OX1NUUklORyA9ICcwLjAuJw0Kd2l0aCBvcGVuKG9wLmpvaW4ob3AuZGlybmFtZShfX2ZpbGVfXyksICd2ZXJzaW9uJyksICdyJykgYXMgdmVyc2lvbl9maWxlOg0KICAgIFZFUlNJT05fU1RSSU5HID0gdmVyc2lvbl9maWxlLnJlYWQoKQ0KbWF0Y2hlcyA9IHJlLmZpbmRhbGwocicoXGQrKVwuKFxkKylcLihcZCspXC4/KC4rKT8nLCBWRVJTSU9OX1NUUklORylbMF0NCmlmIGxlbihtYXRjaGVzKSA9PSA0Og0KICAgIFZFUlNJT05fTUFKT1IsIFZFUlNJT05fTUlOT1IsIFZFUlNJT05fUEFUQ0gsIEJVSUxEX01FVEFEQVRBID0gbWF0Y2hlcw0KZWxzZToNCiAgICBWRVJTSU9OX01BSk9SLCBWRVJTSU9OX01JTk9SLCBWRVJTSU9OX1BBVENIID0gbWF0Y2hlcw0KICAgIEJVSUxEX01FVEFEQVRBID0gIiINCg0KdHJ5Og0KICAgIFZFUlNJT05fTUFKT1IgPSBpbnQoVkVSU0lPTl9NQUpPUikNCiAgICBWRVJTSU9OX01JTk9SID0gaW50KFZFUlNJT05fTUlOT1IpDQogICAgVkVSU0lPTl9QQVRDSCA9IGludChWRVJTSU9OX1BBVENIKQ0KZXhjZXB0Og0KICAgIHJhaXNlIEV4Y2VwdGlvbignQ3JpdGljYWwgRXJyb3IuIENhbiBub3QgZGV0ZXJtaW5lIHB5UmV2aXQgdmVyc2lvbi4nKQ0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KIyBjb25maWcgZW52aXJvbm1lbnQgcGF0aHMNCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiMgbWFpbiBweXJldml0IHJlcG8gZm9sZGVyDQp0cnk6DQogICAgIyAzIHN0ZXBzIGJhY2sgZm9yIDxob21lPi9MaWIvcHlyZXZpdA0KICAgIEhPTUVfRElSID0gb3AuZGlybmFtZShvcC5kaXJuYW1lKG9wLmRpcm5hbWUoX19maWxlX18pKSkNCmV4Y2VwdCBOYW1lRXJyb3I6DQogICAgcmFpc2UgRXhjZXB0aW9uKCdDcml0aWNhbCBFcnJvci4gQ2FuIG5vdCBmaW5kIGhvbWUgZGlyZWN0b3J5LicpDQoNCiMgRGV0ZXJtaW5lIGRvdG5ldCBydW50aW1lDQpET1RORVRfUlVOVElNRV9JRCA9ICJuZXRmeCINCmlmIFN5c3RlbS5FbnZpcm9ubWVudC5WZXJzaW9uLk1ham9yID49IDUgb3IgXA0KICAgICAgICAoIi5ORVQgQ29yZSIgaW4gU1JJLlJ1bnRpbWVJbmZvcm1hdGlvbi5GcmFtZXdvcmtEZXNjcmlwdGlvbik6DQogICAgRE9UTkVUX1JVTlRJTUVfSUQgPSAibmV0Y29yZSINCg0KSVNfRE9UTkVUX0NPUkUgPSBET1RORVRfUlVOVElNRV9JRCA9PSAibmV0Y29yZSINCg0KIyBCSU4gZGlyZWN0b3J5DQpCSU5fRElSID0gb3Auam9pbihIT01FX0RJUiwgJ2JpbicsIERPVE5FVF9SVU5USU1FX0lEKQ0KDQojIG1haW4gcHlyZXZpdCBsaWIgZm9sZGVycw0KTUFJTl9MSUJfRElSID0gb3Auam9pbihIT01FX0RJUiwgJ3B5cmV2aXRsaWInKQ0KTUlTQ19MSUJfRElSID0gb3Auam9pbihIT01FX0RJUiwgJ3NpdGUtcGFja2FnZXMnKQ0KDQojIHBhdGggdG8gcHlyZXZpdCBtb2R1bGUNCk1PRFVMRV9ESVIgPSBvcC5qb2luKE1BSU5fTElCX0RJUiwgJ3B5cmV2aXQnKQ0KDQojIGxvYWRlciBkaXJlY3RvcnkNCkxPQURFUl9ESVIgPSBvcC5qb2luKE1PRFVMRV9ESVIsICdsb2FkZXInKQ0KDQojIHJ1bnRpbWUgZGlyZWN0b3J5DQpSVU5USU1FX0RJUiA9IG9wLmpvaW4oTU9EVUxFX0RJUiwgJ3J1bnRpbWUnKQ0KDQojIGFkZGluIGRpcmVjdG9yeQ0KQURESU5fRElSID0gb3Auam9pbihMT0FERVJfRElSLCAnYWRkaW4nKQ0KDQojIGlmIGxvYWRlciBtb2R1bGUgaXMgYXZhaWxhYmxlIG1lYW5zIHB5UmV2aXQgaXMgYmVpbmcgZXhlY3V0ZWQgYnkgUmV2aXQuDQppbXBvcnQgcHlyZXZpdC5lbmdpbmUgYXMgZW5nDQppZiBlbmcuRW5naW5lVmVyc2lvbiAhPSAwMDA6DQogICAgRU5HSU5FU19ESVIgPSBvcC5qb2luKEJJTl9ESVIsICdlbmdpbmVzJywgZW5nLkVuZ2luZVZlcnNpb24pDQojIG90aGVyd2lzZSBpdCBtaWdodCBiZSB1bmRlciB0ZXN0LCBvciBkb2N1bWVudGF0aW9uIHByb2Nlc3NpbmcuDQojIHNvIGxldCdzIGtlZXAgdGhlIHN5bWJvbHMgYnV0IHNldCB0byBOb25lIChmYWtlIHRoZSBzeW1ib2xzKQ0KZWxzZToNCiAgICBFTkdJTkVTX0RJUiA9IE5vbmUNCg0KIyBhZGQgdGhlIGZyYW1ld29yayBkbGwgcGF0aCB0byB0aGUgc2VhcmNoIHBhdGhzDQpzeXMucGF0aC5hcHBlbmQoQklOX0RJUikNCnN5cy5wYXRoLmFwcGVuZChBRERJTl9ESVIpDQpzeXMucGF0aC5hcHBlbmQoRU5HSU5FU19ESVIpDQoNCg0KUFlSRVZJVF9DTElfUEFUSCA9IG9wLmpvaW4oSE9NRV9ESVIsICdiaW4nLCBQWVJFVklUX0NMSV9OQU1FKQ0KDQoNCiMgbm93IHdlIGNhbiBzdGFydCBpbXBvcnRpbmcgc3R1ZmYNCmZyb20gcHlyZXZpdC5jb21wYXQgaW1wb3J0IHNhZmVfc3RydHlwZQ0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgUHJvY2Vzcw0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgV2luZG93cw0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgRm9ybXMNCmZyb20gcHlyZXZpdCBpbXBvcnQgYXBpDQpmcm9tIHB5cmV2aXQuYXBpIGltcG9ydCBEQiwgVUksIEFwcGxpY2F0aW9uU2VydmljZXMsIEFkV2luZG93cw0KDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojIEJhc2UgRXhjZXB0aW9ucw0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KVFJBQ0VCQUNLX1RJVExFID0gJ1RyYWNlYmFjazonDQoNCg0KIyBHZW5lcmFsIEV4Y2VwdGlvbnMNCmNsYXNzIFB5UmV2aXRFeGNlcHRpb24oRXhjZXB0aW9uKToNCiAgICAiIiJDb21tb24gYmFzZSBjbGFzcyBmb3IgYWxsIHB5UmV2aXQgZXhjZXB0aW9ucy4NCg0KICAgIFBhcmFtZXRlcnMgYXJncyBhbmQgbWVzc2FnZSBhcmUgZGVyaXZlZCBmcm9tIEV4Y2VwdGlvbiBjbGFzcy4NCiAgICAiIiINCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBtc2coc2VsZik6DQogICAgICAgICIiIlJldHVybiBleGNlcHRpb24gbWVzc2FnZS4iIiINCiAgICAgICAgaWYgc2VsZi5hcmdzOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuYXJnc1swXSAjcHlsaW50OiBkaXNhYmxlPUUxMTM2DQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByZXR1cm4gJycNCg0KICAgIGRlZiBfX3JlcHJfXyhzZWxmKToNCiAgICAgICAgcmV0dXJuIHN0cihzZWxmKQ0KDQogICAgZGVmIF9fc3RyX18oc2VsZik6DQogICAgICAgICIiIlByb2Nlc3Mgc3RhY2sgdHJhY2UgYW5kIHByZXBhcmUgcmVwb3J0IGZvciBvdXRwdXQgd2luZG93LiIiIg0KICAgICAgICBzeXMuZXhjX3R5cGUsIHN5cy5leGNfdmFsdWUsIHN5cy5leGNfdHJhY2ViYWNrID0gc3lzLmV4Y19pbmZvKCkNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgdGJfcmVwb3J0ID0gdHJhY2ViYWNrLmZvcm1hdF90YihzeXMuZXhjX3RyYWNlYmFjaylbMF0NCiAgICAgICAgICAgIGlmIHNlbGYubXNnOg0KICAgICAgICAgICAgICAgIHJldHVybiAne31cblxue31cbnt9Jy5mb3JtYXQoc2VsZi5tc2csDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUUkFDRUJBQ0tfVElUTEUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Yl9yZXBvcnQpDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHJldHVybiAne31cbnt9Jy5mb3JtYXQoVFJBQ0VCQUNLX1RJVExFLCB0Yl9yZXBvcnQpDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgICAgICByZXR1cm4gRXhjZXB0aW9uLl9fc3RyX18oc2VsZikNCg0KDQpjbGFzcyBQeVJldml0SU9FcnJvcihQeVJldml0RXhjZXB0aW9uKToNCiAgICAiIiJDb21tb24gYmFzZSBjbGFzcyBmb3IgYWxsIHB5UmV2aXQgaW8tcmVsYXRlZCBleGNlcHRpb25zLiIiIg0KDQoNCmNsYXNzIFB5UmV2aXRDUHl0aG9uTm90U3VwcG9ydGVkKFB5UmV2aXRFeGNlcHRpb24pOg0KICAgICIiIkV4Y2VwdGlvbiBmb3IgZmVhdHVyZXMgbm90IHN1cHBvcnRlZCB1bmRlciBDUHl0aG9uLiIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmZWF0dXJlX25hbWUpOg0KICAgICAgICBzdXBlcihQeVJldml0Q1B5dGhvbk5vdFN1cHBvcnRlZCwgc2VsZikuX19pbml0X18oKQ0KICAgICAgICBzZWxmLmZlYXR1cmVfbmFtZSA9IGZlYXR1cmVfbmFtZQ0KDQogICAgZGVmIF9fc3RyX18oc2VsZik6DQogICAgICAgIHJldHVybiBzZWxmLm1zZw0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIG1zZyhzZWxmKToNCiAgICAgICAgIiIiUmV0dXJuIGV4Y2VwdGlvbiBtZXNzYWdlLiIiIg0KICAgICAgICByZXR1cm4gJ1wie31cIiBpcyBub3QgY3VycmVudGx5IHN1cHBvcnRlZCB1bmRlciBDUHl0aG9uJyBcDQogICAgICAgICAgICAgICAgLmZvcm1hdChzZWxmLmZlYXR1cmVfbmFtZSkNCg0KDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojIFdyYXBwZXIgZm9yIF9fcmV2aXRfXyBidWlsdGluIHBhcmFtZXRlciBzZXQgaW4gc2NvcGUgYnkgQyMgU2NyaXB0IEV4ZWN1dG9yDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojIG5hbWVkdHVwbGUgZm9yIHBhc3NpbmcgaW5mb3JtYXRpb24gYWJvdXQgYSBQb3N0YWJsZUNvbW1hbmQNCl9Ib3N0QXBwUG9zdGFibGVDb21tYW5kID0gbmFtZWR0dXBsZSgnX0hvc3RBcHBQb3N0YWJsZUNvbW1hbmQnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsnbmFtZScsICdrZXknLCAnaWQnLCAncnZ0b2JqJ10pDQoiIiJQcml2YXRlIG5hbWVkdHVwbGUgZm9yIHBhc3NpbmcgaW5mb3JtYXRpb24gYWJvdXQgYSBQb3N0YWJsZUNvbW1hbmQNCg0KQXR0cmlidXRlczoNCiAgICBuYW1lIChzdHIpOiBQb3N0YWJsZSBjb21tYW5kIG5hbWUNCiAgICBrZXkgKHN0cik6IFBvc3RhYmxlIGNvbW1hbmQga2V5IHN0cmluZw0KICAgIGlkIChpbnQpOiBQb3N0YWJsZSBjb21tYW5kIGlkDQogICAgcnZ0b2JqIChgYFJldml0Q29tbWFuZElkYGApOiBQb3N0YWJsZSBjb21tYW5kIElkIE9iamVjdA0KIiIiDQoNCg0KY2xhc3MgX0hvc3RBcHBsaWNhdGlvbihvYmplY3QpOg0KICAgICIiIlByaXZhdGUgV3JhcHBlciBmb3IgQ3VycmVudCBJbnN0YW5jZSBvZiBSZXZpdC4NCg0KICAgIFByb3ZpZGVzIHZlcnNpb24gaW5mbyBhbmQgY29tcGFyaXNvbiBmdW5jdGlvbmFsaXR5LCBhbG9uZ3NpZGUgcHJvdmlkaW5nDQogICAgaW5mbyBvbiB0aGUgYWN0aXZlIHNjcmVlbiwgYWN0aXZlIGRvY3VtZW50IGFuZCB1aS1kb2N1bWVudCwgYXZhaWxhYmxlDQogICAgcG9zdGFibGUgY29tbWFuZHMsIGFuZCBvdGhlciBmdW5jdGlvbmFsaXR5Lg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgICAgICBgYGBweXRob24NCiAgICAgICAgICAgIGhvc3RhcHAgPSBfSG9zdEFwcGxpY2F0aW9uKCkNCiAgICAgICAgICAgIGhvc3RhcHAuaXNfbmV3ZXJfdGhhbigyMDE3KQ0KICAgICAgICAgICAgYGBgDQogICAgIiIiDQoNCiAgICBkZWYgX19pbml0X18oc2VsZik6DQogICAgICAgIHNlbGYuX3Bvc3RhYmxlX2NtZHMgPSBbXQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHVpYXBwKHNlbGYpOg0KICAgICAgICAiIiJSZXR1cm4gVUlBcHBsaWNhdGlvbiBwcm92aWRlZCB0byB0aGUgcnVubmluZyBjb21tYW5kLiIiIg0KICAgICAgICBpZiBpc2luc3RhbmNlKF9fcmV2aXRfXywgVUkuVUlBcHBsaWNhdGlvbik6ICAjcHlsaW50OiBkaXNhYmxlPXVuZGVmaW5lZC12YXJpYWJsZQ0KICAgICAgICAgICAgcmV0dXJuIF9fcmV2aXRfXyAgI3B5bGludDogZGlzYWJsZT11bmRlZmluZWQtdmFyaWFibGUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBhcHAoc2VsZik6DQogICAgICAgICIiIlJldHVybiBBcHBsaWNhdGlvbiBwcm92aWRlZCB0byB0aGUgcnVubmluZyBjb21tYW5kLiIiIg0KICAgICAgICBpZiBzZWxmLnVpYXBwOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYudWlhcHAuQXBwbGljYXRpb24NCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKF9fcmV2aXRfXywgQXBwbGljYXRpb25TZXJ2aWNlcy5BcHBsaWNhdGlvbik6ICAjcHlsaW50OiBkaXNhYmxlPXVuZGVmaW5lZC12YXJpYWJsZQ0KICAgICAgICAgICAgcmV0dXJuIF9fcmV2aXRfXyAgI3B5bGludDogZGlzYWJsZT11bmRlZmluZWQtdmFyaWFibGUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBhZGRpbl9pZChzZWxmKToNCiAgICAgICAgIiIiUmV0dXJuIGFjdGl2ZSBhZGRpbiBpZC4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuYXBwLkFjdGl2ZUFkZEluSWQNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBoYXNfYXBpX2NvbnRleHQoc2VsZik6DQogICAgICAgICIiIkRldGVybWluZSBpZiBob3N0IGFwcGxpY2F0aW9uIGlzIGluIEFQSSBjb250ZXh0LiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5hcHAuQWN0aXZlQWRkSW5JZCBpcyBub3QgTm9uZQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHVpZG9jKHNlbGYpOg0KICAgICAgICAiIiJSZXR1cm4gYWN0aXZlIFVJRG9jdW1lbnQuIiIiDQogICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYudWlhcHAsICdBY3RpdmVVSURvY3VtZW50JywgTm9uZSkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBkb2Moc2VsZik6DQogICAgICAgICIiIlJldHVybiBhY3RpdmUgRG9jdW1lbnQuIiIiDQogICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYudWlkb2MsICdEb2N1bWVudCcsIE5vbmUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgYWN0aXZlX3ZpZXcoc2VsZik6DQogICAgICAgICIiIlJldHVybiB2aWV3IHRoYXQgaXMgYWN0aXZlIChVSURvY3VtZW50LkFjdGl2ZVZpZXcpLiIiIg0KICAgICAgICByZXR1cm4gZ2V0YXR0cihzZWxmLnVpZG9jLCAnQWN0aXZlVmlldycsIE5vbmUpDQoNCiAgICBAYWN0aXZlX3ZpZXcuc2V0dGVyDQogICAgZGVmIGFjdGl2ZV92aWV3KHNlbGYsIHZhbHVlKToNCiAgICAgICAgIiIiU2V0IHRoZSBhY3RpdmUgdmlldyBpbiB1c2VyIGludGVyZmFjZS4iIiINCiAgICAgICAgc2V0YXR0cihzZWxmLnVpZG9jLCAnQWN0aXZlVmlldycsIHZhbHVlKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGRvY3Moc2VsZik6DQogICAgICAgICIiIlJldHVybiA6b2JqOmBsaXN0YCBvZiBvcGVuIDpvYmo6YERvY3VtZW50YCBvYmplY3RzLiIiIg0KICAgICAgICByZXR1cm4gZ2V0YXR0cihzZWxmLmFwcCwgJ0RvY3VtZW50cycsIE5vbmUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgYXZhaWxhYmxlX3NlcnZlcnMoc2VsZik6DQogICAgICAgICIiIlJldHVybiA6b2JqOmBsaXN0YCBvZiBhdmFpbGFibGUgUmV2aXQgc2VydmVyIG5hbWVzLiIiIg0KICAgICAgICByZXR1cm4gbGlzdChzZWxmLmFwcC5HZXRSZXZpdFNlcnZlck5ldHdvcmtIb3N0cygpKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHZlcnNpb24oc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIHZlcnNpb24gbnVtYmVyIChlLmcuICcyMDE4JykuIiIiDQogICAgICAgIHJldHVybiBzZWxmLmFwcC5WZXJzaW9uTnVtYmVyDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgc3VidmVyc2lvbihzZWxmKToNCiAgICAgICAgIiIic3RyOiBSZXR1cm4gc3VidmVyc2lvbiBudW1iZXIgKGUuZy4gJzIwMTguMycpLiIiIg0KICAgICAgICBpZiBoYXNhdHRyKHNlbGYuYXBwLCAnU3ViVmVyc2lvbk51bWJlcicpOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuYXBwLlN1YlZlcnNpb25OdW1iZXINCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiAne30uMCcuZm9ybWF0KHNlbGYudmVyc2lvbikNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB2ZXJzaW9uX25hbWUoc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIHZlcnNpb24gbmFtZSAoZS5nLiAnQXV0b2Rlc2sgUmV2aXQgMjAxOCcpLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5hcHAuVmVyc2lvbk5hbWUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBidWlsZChzZWxmKToNCiAgICAgICAgIiIic3RyOiBSZXR1cm4gYnVpbGQgbnVtYmVyIChlLmcuICcyMDE3MDkyN18xNTE1KHg2NCknKS4iIiINCiAgICAgICAgaWYgaW50KHNlbGYudmVyc2lvbikgPj0gMjAyMToNCiAgICAgICAgICAgICMgdXNlcyBsYWJzIG1vZHVsZSB0aGF0IGlzIGltcG9ydGVkIGxhdGVyIGluIHRoaXMgY29kZQ0KICAgICAgICAgICAgcmV0dXJuIGxhYnMuZXh0cmFjdF9idWlsZF9mcm9tX2V4ZShzZWxmLnByb2NfcGF0aCkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmFwcC5WZXJzaW9uQnVpbGQNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBzZXJpYWxfbm8oc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIHNlcmlhbCBudW1iZXIgbnVtYmVyIChlLmcuICc1NjktMDk3MDQ4MjgnKS4iIiINCiAgICAgICAgcmV0dXJuIGFwaS5nZXRfcHJvZHVjdF9zZXJpYWxfbnVtYmVyKCkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBwcmV0dHlfbmFtZShzZWxmKToNCiAgICAgICAgIiIiUmV0dXJucyB0aGUgcHJldHR5IG5hbWUgb2YgdGhlIGhvc3QuDQoNCiAgICAgICAgRXhhbXBsZXM6DQogICAgICAgICAgICBBdXRvZGVzayBSZXZpdCAyMDE5LjIgYnVpbGQ6IDIwMTkwODA4XzA5MDAoeDY0KQ0KDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICAoc3RyKTogUHJldHR5IG5hbWUgb2YgdGhlIGhvc3QNCiAgICAgICAgIiIiDQogICAgICAgIGhvc3RfbmFtZSA9IHNlbGYudmVyc2lvbl9uYW1lDQogICAgICAgIGlmIHNlbGYuaXNfbmV3ZXJfdGhhbigyMDE3KToNCiAgICAgICAgICAgIGhvc3RfbmFtZSA9IGhvc3RfbmFtZS5yZXBsYWNlKHNlbGYudmVyc2lvbiwgc2VsZi5zdWJ2ZXJzaW9uKQ0KICAgICAgICByZXR1cm4gIiVzIGJ1aWxkOiAlcyIgJSAoaG9zdF9uYW1lLCBzZWxmLmJ1aWxkKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGlzX2RlbW8oc2VsZik6DQogICAgICAgICIiImJvb2w6IERldGVybWluZSBpZiBwcm9kdWN0IGlzIHVzaW5nIGRlbW8gbGljZW5zZS4iIiINCiAgICAgICAgcmV0dXJuIGFwaS5pc19wcm9kdWN0X2RlbW8oKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGxhbmd1YWdlKHNlbGYpOg0KICAgICAgICAiIiJzdHI6IFJldHVybiBsYW5ndWFnZSB0eXBlIChlLmcuICdMYW5ndWFnZVR5cGUuRW5nbGlzaF9VU0EnKS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuYXBwLkxhbmd1YWdlDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgdXNlcm5hbWUoc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIHRoZSB1c2VybmFtZSBmcm9tIFJldml0IEFQSSAoQXBwbGljYXRpb24uVXNlcm5hbWUpLiIiIg0KICAgICAgICB1bmFtZSA9IHNlbGYuYXBwLlVzZXJuYW1lDQogICAgICAgIHVuYW1lID0gdW5hbWUuc3BsaXQoJ0AnKVswXSAgIyBpZiB1c2VybmFtZSBpcyBlbWFpbA0KICAgICAgICAjIHJlbW92aW5nIGRvdHMgc2luY2UgdXNlcm5hbWUgd2lsbCBiZSB1c2VkIGluIGZpbGUgbmFtaW5nDQogICAgICAgIHVuYW1lID0gdW5hbWUucmVwbGFjZSgnLicsICcnKQ0KICAgICAgICByZXR1cm4gdW5hbWUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBwcm9jKHNlbGYpOg0KICAgICAgICAiIiJTeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzczogUmV0dXJuIGN1cnJlbnQgcHJvY2VzcyBvYmplY3QuIiIiDQogICAgICAgIHJldHVybiBQcm9jZXNzLkdldEN1cnJlbnRQcm9jZXNzKCkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBwcm9jX2lkKHNlbGYpOg0KICAgICAgICAiIiJpbnQ6IFJldHVybiBjdXJyZW50IHByb2Nlc3MgaWQuIiIiDQogICAgICAgIHJldHVybiBQcm9jZXNzLkdldEN1cnJlbnRQcm9jZXNzKCkuSWQNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBwcm9jX25hbWUoc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIGN1cnJlbnQgcHJvY2VzcyBuYW1lLiIiIg0KICAgICAgICByZXR1cm4gUHJvY2Vzcy5HZXRDdXJyZW50UHJvY2VzcygpLlByb2Nlc3NOYW1lDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgcHJvY19wYXRoKHNlbGYpOg0KICAgICAgICAiIiJzdHI6IFJldHVybiBmaWxlIHBhdGggZm9yIHRoZSBjdXJyZW50IHByb2Nlc3MgbWFpbiBtb2R1bGUuIiIiDQogICAgICAgIHJldHVybiBQcm9jZXNzLkdldEN1cnJlbnRQcm9jZXNzKCkuTWFpbk1vZHVsZS5GaWxlTmFtZQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHByb2Nfd2luZG93KHNlbGYpOg0KICAgICAgICAiIiJgYGludHB0cmBgOiBSZXR1cm4gaGFuZGxlIHRvIGN1cnJlbnQgcHJvY2VzcyB3aW5kb3cuIiIiDQogICAgICAgIGlmIHNlbGYuaXNfbmV3ZXJfdGhhbigyMDE5LCBvcl9lcXVhbD1UcnVlKToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnVpYXBwLk1haW5XaW5kb3dIYW5kbGUNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBBZFdpbmRvd3MuQ29tcG9uZW50TWFuYWdlci5BcHBsaWNhdGlvbldpbmRvdw0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHByb2Nfc2NyZWVuKHNlbGYpOg0KICAgICAgICAiIiJgYGludHB0cmBgOiBSZXR1cm4gaGFuZGxlIHRvIHNjcmVlbiBob3N0aW5nIGN1cnJlbnQgcHJvY2Vzcy4iIiINCiAgICAgICAgcmV0dXJuIEZvcm1zLlNjcmVlbi5Gcm9tSGFuZGxlKHNlbGYucHJvY193aW5kb3cpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgcHJvY19zY3JlZW5fd29ya2FyZWEoc2VsZik6DQogICAgICAgICIiImBgU3lzdGVtLkRyYXdpbmcuUmVjdGFuZ2xlYGA6IFJldHVybiBzY3JlZW4gd29ya2luZyBhcmVhLiIiIg0KICAgICAgICBzY3JlZW4gPSBIT1NUX0FQUC5wcm9jX3NjcmVlbg0KICAgICAgICBpZiBzY3JlZW46DQogICAgICAgICAgICByZXR1cm4gc2NyZWVuLldvcmtpbmdBcmVhDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgcHJvY19zY3JlZW5fc2NhbGVmYWN0b3Ioc2VsZik6DQogICAgICAgICIiImZsb2F0OiBSZXR1cm4gc2NhbGluZyBmb3Igc2NyZWVuIGhvc3RpbmcgY3VycmVudCBwcm9jZXNzLiIiIg0KICAgICAgICBzY3JlZW4gPSBIT1NUX0FQUC5wcm9jX3NjcmVlbg0KICAgICAgICBpZiBzY3JlZW46DQogICAgICAgICAgICBhY3R1YWxfd2RpdGggPSBXaW5kb3dzLlN5c3RlbVBhcmFtZXRlcnMuUHJpbWFyeVNjcmVlbldpZHRoDQogICAgICAgICAgICBzY2FsZWRfd2lkdGggPSBzY3JlZW4uUHJpbWFyeVNjcmVlbi5Xb3JraW5nQXJlYS5XaWR0aA0KICAgICAgICAgICAgcmV0dXJuIGFicyhzY2FsZWRfd2lkdGggLyBhY3R1YWxfd2RpdGgpDQoNCiAgICBkZWYgaXNfbmV3ZXJfdGhhbihzZWxmLCB2ZXJzaW9uLCBvcl9lcXVhbD1GYWxzZSk6DQogICAgICAgICIiImJvb2w6IFJldHVybiBUcnVlIGlmIGhvc3QgYXBwIGlzIG5ld2VyIHRoYW4gcHJvdmlkZWQgdmVyc2lvbi4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgdmVyc2lvbiAoc3RyIG9yIGludCk6IHZlcnNpb24gdG8gY2hlY2sgYWdhaW5zdC4NCiAgICAgICAgICAgIG9yX2VxdWFsIChib29sKTogV2hldGhlciB0byBpbmNsdWRlIGB2ZXJzaW9uYCBpbiB0aGUgY29tcGFyaXNvbg0KICAgICAgICAiIiINCiAgICAgICAgaWYgb3JfZXF1YWw6DQogICAgICAgICAgICByZXR1cm4gaW50KHNlbGYudmVyc2lvbikgPj0gaW50KHZlcnNpb24pDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByZXR1cm4gaW50KHNlbGYudmVyc2lvbikgPiBpbnQodmVyc2lvbikNCg0KICAgIGRlZiBpc19vbGRlcl90aGFuKHNlbGYsIHZlcnNpb24pOg0KICAgICAgICAiIiJib29sOiBSZXR1cm4gVHJ1ZSBpZiBob3N0IGFwcCBpcyBvbGRlciB0aGFuIHByb3ZpZGVkIHZlcnNpb24uDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIHZlcnNpb24gKHN0ciBvciBpbnQpOiB2ZXJzaW9uIHRvIGNoZWNrIGFnYWluc3QuDQogICAgICAgICIiIg0KICAgICAgICByZXR1cm4gaW50KHNlbGYudmVyc2lvbikgPCBpbnQodmVyc2lvbikNCg0KICAgIGRlZiBpc19leGFjdGx5KHNlbGYsIHZlcnNpb24pOg0KICAgICAgICAiIiJib29sOiBSZXR1cm4gVHJ1ZSBpZiBob3N0IGFwcCBpcyBlcXVhbCB0byBwcm92aWRlZCB2ZXJzaW9uLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICB2ZXJzaW9uIChzdHIgb3IgaW50KTogdmVyc2lvbiB0byBjaGVjayBhZ2FpbnN0Lg0KICAgICAgICAiIiINCiAgICAgICAgcmV0dXJuIGludChzZWxmLnZlcnNpb24pID09IGludCh2ZXJzaW9uKQ0KDQogICAgZGVmIGdldF9wb3N0YWJsZV9jb21tYW5kcyhzZWxmKToNCiAgICAgICAgIiIiUmV0dXJuIGxpc3Qgb2YgcG9zdGFibGUgY29tbWFuZHMuDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChsaXN0W19Ib3N0QXBwUG9zdGFibGVDb21tYW5kXSk6IHBvc3RhYmxlIGNvbW1hbmRzLg0KICAgICAgICAiIiINCiAgICAgICAgIyBpZiBsaXN0IG9mIHBvc3RhYmxlIGNvbW1hbmRzIGlzIF9ub3RfIGFscmVhZHkgY3JlYXRlZA0KICAgICAgICAjIG1ha2UgdGhlIGxpc3QgYW5kIHN0b3JlIGluIGluc3RhbmNlIHBhcmFtZXRlcg0KICAgICAgICBpZiBub3Qgc2VsZi5fcG9zdGFibGVfY21kczoNCiAgICAgICAgICAgIGZvciBwYyBpbiBVSS5Qb3N0YWJsZUNvbW1hbmQuR2V0VmFsdWVzKFVJLlBvc3RhYmxlQ29tbWFuZCk6DQogICAgICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgICAgICByY2lkID0gVUkuUmV2aXRDb21tYW5kSWQuTG9va3VwUG9zdGFibGVDb21tYW5kSWQocGMpDQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3Bvc3RhYmxlX2NtZHMuYXBwZW5kKA0KICAgICAgICAgICAgICAgICAgICAgICAgIyB3cmFwIHBvc3RhYmxlIGNvbW1hbmQgaW5mbyBpbiBjdXN0b20gbmFtZWR0dXBsZQ0KICAgICAgICAgICAgICAgICAgICAgICAgX0hvc3RBcHBQb3N0YWJsZUNvbW1hbmQobmFtZT1zYWZlX3N0cnR5cGUocGMpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PXJjaWQuTmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkPXJjaWQuSWQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBydnRvYmo9cmNpZCkNCiAgICAgICAgICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOg0KICAgICAgICAgICAgICAgICAgICAjIGlmIGFueSBlcnJvciBvY2N1cmVkIHdoZW4gcXVlcnlpbmcgcG9zdGFibGUgY29tbWFuZA0KICAgICAgICAgICAgICAgICAgICAjIG9yIGl0cyBpbmZvLCBwYXNzIHNpbGVudGx5DQogICAgICAgICAgICAgICAgICAgIHBhc3MNCg0KICAgICAgICByZXR1cm4gc2VsZi5fcG9zdGFibGVfY21kcw0KDQogICAgZGVmIHBvc3RfY29tbWFuZChzZWxmLCBjb21tYW5kX2lkKToNCiAgICAgICAgIiIiUmVxdWVzdCBSZXZpdCB0byBydW4gYSBjb21tYW5kLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBjb21tYW5kX2lkIChzdHIpOiBjb21tYW5kIGlkZW50aWZpZXIgZS5nLiBJRF9SRVZJVF9TQVZFX0FTX1RFTVBMQVRFDQogICAgICAgICIiIg0KICAgICAgICBjb21tYW5kX2lkID0gVUkuUmV2aXRDb21tYW5kSWQuTG9va3VwQ29tbWFuZElkKGNvbW1hbmRfaWQpDQogICAgICAgIHNlbGYudWlhcHAuUG9zdENvbW1hbmQoY29tbWFuZF9pZCkNCg0KDQoNCnRyeToNCiAgICAjIENyZWF0ZSBhbiBpbnRhbmNlIG9mIGhvc3QgYXBwbGljYXRpb24gd3JhcHBlcg0KICAgICMgbWFraW5nIHN1cmUgX19yZXZpdF9fIGlzIGF2YWlsYWJsZQ0KICAgIEhPU1RfQVBQID0gX0hvc3RBcHBsaWNhdGlvbigpDQpleGNlcHQgRXhjZXB0aW9uOg0KICAgIHJhaXNlIEV4Y2VwdGlvbignQ3JpdGljYWwgRXJyb3I6IEhvc3Qgc29mdHdhcmUgaXMgbm90IHN1cHBvcnRlZC4gJw0KICAgICAgICAgICAgICAgICAgICAnKF9fcmV2aXRfXyBoYW5kbGUgaXMgbm90IGF2YWlsYWJsZSknKQ0KDQoNCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiMgV3JhcHBlciB0byBhY2Nlc3MgYnVpbHRpbiBwYXJhbWV0ZXJzIHNldCBpbiBzY29wZSBieSBDIyBTY3JpcHQgRXhlY3V0b3INCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCmNsYXNzIF9FeGVjdXRvclBhcmFtcyhvYmplY3QpOg0KICAgICIiIlByaXZhdGUgV3JhcHBlciB0aGF0IHByb3ZpZGVzIHJ1bnRpbWUgZW52aXJvbm1lbnQgaW5mby4iIiINCg0KICAgIEBwcm9wZXJ0eSAgICMgcmVhZC1vbmx5DQogICAgZGVmIGV4ZWNfaWQoc2VsZik6DQogICAgICAgICIiIlJldHVybiBleGVjdXRpb24gdW5pcXVlIGlkLiIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICByZXR1cm4gX19leGVjaWRfXw0KICAgICAgICBleGNlcHQgTmFtZUVycm9yOg0KICAgICAgICAgICAgcGFzcw0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkLW9ubHkNCiAgICBkZWYgZXhlY190aW1lc3RhbXAoc2VsZik6DQogICAgICAgICIiIlJldHVybiBleGVjdXRpb24gdGltZXN0YW1wLiIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICByZXR1cm4gX190aW1lc3RhbXBfXw0KICAgICAgICBleGNlcHQgTmFtZUVycm9yOg0KICAgICAgICAgICAgcGFzcw0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkLW9ubHkNCiAgICBkZWYgZW5naW5lX2lkKHNlbGYpOg0KICAgICAgICAiIiJSZXR1cm4gZW5naW5lIGlkLiIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICByZXR1cm4gX19jYWNoZWRlbmdpbmVpZF9fDQogICAgICAgIGV4Y2VwdCBOYW1lRXJyb3I6DQogICAgICAgICAgICBwYXNzDQoNCiAgICBAcHJvcGVydHkgICAjIHJlYWQtb25seQ0KICAgIGRlZiBlbmdpbmVfdmVyKHNlbGYpOg0KICAgICAgICAiIiJzdHI6IFJldHVybiBQeVJldml0TG9hZGVyLlNjcmlwdEV4ZWN1dG9yIGhhcmRjb2RlZCB2ZXJzaW9uLiIiIg0KICAgICAgICBpZiBlbmcuU2NyaXB0RXhlY3V0b3I6DQogICAgICAgICAgICByZXR1cm4gZW5nLlNjcmlwdEV4ZWN1dG9yLkVuZ2luZVZlcnNpb24NCg0KICAgIEBwcm9wZXJ0eSAgIyByZWFkLW9ubHkNCiAgICBkZWYgY2FjaGVkX2VuZ2luZShzZWxmKToNCiAgICAgICAgIiIiYm9vbDogQ2hlY2sgd2hldGhlciBweXJldml0IGlzIHJ1bm5pbmcgb24gYSBjYWNoZWQgZW5naW5lLiIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICByZXR1cm4gX19jYWNoZWRlbmdpbmVfXw0KICAgICAgICBleGNlcHQgTmFtZUVycm9yOg0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICBAcHJvcGVydHkgICMgcmVhZC1vbmx5DQogICAgZGVmIGZpcnN0X2xvYWQoc2VsZik6DQogICAgICAgICIiImJvb2w6IENoZWNrIHdoZXRoZXIgcHlyZXZpdCBpcyBub3QgcnVubmluZyBpbiBweXJldml0IGNvbW1hbmQuIiIiDQogICAgICAgICMgaWYgbm8gb3V0cHV0IHdpbmRvdyBpcyBzZXQgYnkgdGhlIGV4ZWN1dG9yLCBpdCBtZWFucyB0aGF0IHB5UmV2aXQNCiAgICAgICAgIyBpcyBsb2FkaW5nIGF0IFJldml0IHN0YXJ0dXAgKG5vdCByZWxvYWRpbmcpDQogICAgICAgIHJldHVybiBUcnVlIGlmIHNlbGYud2luZG93X2hhbmRsZSBpcyBOb25lIGVsc2UgRmFsc2UNCg0KICAgIEBwcm9wZXJ0eSAgICMgcmVhZC1vbmx5DQogICAgZGVmIHNjcmlwdF9ydW50aW1lKHNlbGYpOg0KICAgICAgICAiIiJgYFB5UmV2aXRMYWJzLlB5UmV2aXQuUnVudGltZS5TY3JpcHRSdW50aW1lYGA6IFJldHVybiBjb21tYW5kLiIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICByZXR1cm4gX19zY3JpcHRydW50aW1lX18NCiAgICAgICAgZXhjZXB0IE5hbWVFcnJvcjoNCiAgICAgICAgICAgIHJldHVybiBOb25lDQoNCiAgICBAcHJvcGVydHkgICAjIHJlYWQtb25seQ0KICAgIGRlZiBvdXRwdXRfc3RyZWFtKHNlbGYpOg0KICAgICAgICAiIiJSZXR1cm4gU2NyaXB0SU8uIiIiDQogICAgICAgIGlmIHNlbGYuc2NyaXB0X3J1bnRpbWU6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5zY3JpcHRfcnVudGltZS5PdXRwdXRTdHJlYW0NCg0KICAgIEBwcm9wZXJ0eSAgICMgcmVhZC1vbmx5DQogICAgZGVmIHNjcmlwdF9kYXRhKHNlbGYpOg0KICAgICAgICAiIiJSZXR1cm4gU2NyaXB0UnVudGltZS5TY3JpcHREYXRhLiIiIg0KICAgICAgICBpZiBzZWxmLnNjcmlwdF9ydW50aW1lOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2NyaXB0X3J1bnRpbWUuU2NyaXB0RGF0YQ0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkLW9ubHkNCiAgICBkZWYgc2NyaXB0X3J1bnRpbWVfY2ZncyhzZWxmKToNCiAgICAgICAgIiIiUmV0dXJuIFNjcmlwdFJ1bnRpbWUuU2NyaXB0UnVudGltZUNvbmZpZ3MuIiIiDQogICAgICAgIGlmIHNlbGYuc2NyaXB0X3J1bnRpbWU6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5zY3JpcHRfcnVudGltZS5TY3JpcHRSdW50aW1lQ29uZmlncw0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkLW9ubHkNCiAgICBkZWYgZW5naW5lX2NmZ3Moc2VsZik6DQogICAgICAgICIiIlJldHVybiBTY3JpcHRSdW50aW1lLlNjcmlwdFJ1bnRpbWVDb25maWdzLiIiIg0KICAgICAgICBpZiBzZWxmLnNjcmlwdF9ydW50aW1lOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2NyaXB0X3J1bnRpbWUuRW5naW5lQ29uZmlncw0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGNvbW1hbmRfbW9kZShzZWxmKToNCiAgICAgICAgIiIiYm9vbDogQ2hlY2sgaWYgcHlyZXZpdCBpcyBydW5uaW5nIGluIHB5cmV2aXQgY29tbWFuZCBjb250ZXh0LiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5zY3JpcHRfcnVudGltZSBpcyBub3QgTm9uZQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGV2ZW50X3NlbmRlcihzZWxmKToNCiAgICAgICAgIiIiYGBPYmplY3RgYDogUmV0dXJuIGV2ZW50IHNlbmRlciBvYmplY3QuIiIiDQogICAgICAgIGlmIHNlbGYuc2NyaXB0X3J1bnRpbWVfY2ZnczoNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcmlwdF9ydW50aW1lX2NmZ3MuRXZlbnRTZW5kZXINCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBldmVudF9hcmdzKHNlbGYpOg0KICAgICAgICAiIiJgYERCLlJldml0QVBJRXZlbnRBcmdzYGA6IFJldHVybiBldmVudCBhcmd1bWVudHMgb2JqZWN0LiIiIg0KICAgICAgICBpZiBzZWxmLnNjcmlwdF9ydW50aW1lX2NmZ3M6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5zY3JpcHRfcnVudGltZV9jZmdzLkV2ZW50QXJncw0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGV2ZW50X2RvYyhzZWxmKToNCiAgICAgICAgIiIiYGBEQi5Eb2N1bWVudGBgOiBSZXR1cm4gZG9jdW1lbnQgc2V0IGluIGV2ZW50IGFyZ3MgaWYgYXZhaWxhYmxlLiIiIg0KICAgICAgICBpZiBzZWxmLmV2ZW50X2FyZ3M6DQogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYuZXZlbnRfYXJncywgJ0RvY3VtZW50Jyk6DQogICAgICAgICAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZi5ldmVudF9hcmdzLCAnRG9jdW1lbnQnKQ0KICAgICAgICAgICAgZWxpZiBoYXNhdHRyKHNlbGYuZXZlbnRfYXJncywgJ0FjdGl2ZURvY3VtZW50Jyk6DQogICAgICAgICAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZi5ldmVudF9hcmdzLCAnQWN0aXZlRG9jdW1lbnQnKQ0KICAgICAgICAgICAgZWxpZiBoYXNhdHRyKHNlbGYuZXZlbnRfYXJncywgJ0N1cnJlbnREb2N1bWVudCcpOg0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYuZXZlbnRfYXJncywgJ0N1cnJlbnREb2N1bWVudCcpDQogICAgICAgICAgICBlbGlmIGhhc2F0dHIoc2VsZi5ldmVudF9hcmdzLCAnR2V0RG9jdW1lbnQnKToNCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5ldmVudF9hcmdzLkdldERvY3VtZW50KCkNCg0KICAgIEBwcm9wZXJ0eSAgICMgcmVhZC1vbmx5DQogICAgZGVmIG5lZWRzX3JlZnJlc2hlZF9lbmdpbmUoc2VsZik6DQogICAgICAgICIiImJvb2w6IENoZWNrIGlmIGNvbW1hbmQgbmVlZHMgYSBuZXdseSByZWZyZXNoZWQgSXJvblB5dGhvbiBlbmdpbmUuIiIiDQogICAgICAgIGlmIHNlbGYuc2NyaXB0X3J1bnRpbWVfY2ZnczoNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcmlwdF9ydW50aW1lX2NmZ3MuUmVmcmVzaEVuZ2luZQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICBAcHJvcGVydHkgICAjIHJlYWQtb25seQ0KICAgIGRlZiBkZWJ1Z19tb2RlKHNlbGYpOg0KICAgICAgICAiIiJib29sOiBDaGVjayBpZiBjb21tYW5kIGlzIGluIGRlYnVnIG1vZGUuIiIiDQogICAgICAgIGlmIHNlbGYuc2NyaXB0X3J1bnRpbWVfY2ZnczoNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcmlwdF9ydW50aW1lX2NmZ3MuRGVidWdNb2RlDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgIEBwcm9wZXJ0eSAgICMgcmVhZC1vbmx5DQogICAgZGVmIGNvbmZpZ19tb2RlKHNlbGYpOg0KICAgICAgICAiIiJib29sOiBDaGVjayBpZiBjb21tYW5kIGlzIGluIGNvbmZpZyBtb2RlLiIiIg0KICAgICAgICBpZiBzZWxmLnNjcmlwdF9ydW50aW1lX2NmZ3M6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5zY3JpcHRfcnVudGltZV9jZmdzLkNvbmZpZ01vZGUNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkLW9ubHkNCiAgICBkZWYgZXhlY3V0ZWRfZnJvbV91aShzZWxmKToNCiAgICAgICAgIiIiYm9vbDogQ2hlY2sgaWYgY29tbWFuZCB3YXMgZXhlY3V0ZWQgZnJvbSB1aS4iIiINCiAgICAgICAgaWYgc2VsZi5zY3JpcHRfcnVudGltZV9jZmdzOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2NyaXB0X3J1bnRpbWVfY2Zncy5FeGVjdXRlZEZyb21VSQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICBAcHJvcGVydHkgICAjIHJlYWQtb25seQ0KICAgIGRlZiBuZWVkc19jbGVhbl9lbmdpbmUoc2VsZik6DQogICAgICAgICIiImJvb2w6IENoZWNrIGlmIGNvbW1hbmQgbmVlZHMgYSBjbGVhbiBJcm9uUHl0aG9uIGVuZ2luZS4iIiINCiAgICAgICAgaWYgc2VsZi5lbmdpbmVfY2ZnczoNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmVuZ2luZV9jZmdzLkNsZWFuRW5naW5lDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgIEBwcm9wZXJ0eSAgICMgcmVhZC1vbmx5DQogICAgZGVmIG5lZWRzX2Z1bGxmcmFtZV9lbmdpbmUoc2VsZik6DQogICAgICAgICIiImJvb2w6IENoZWNrIGlmIGNvbW1hbmQgbmVlZHMgYSBmdWxsLWZyYW1lIElyb25QeXRob24gZW5naW5lLiIiIg0KICAgICAgICBpZiBzZWxmLmVuZ2luZV9jZmdzOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuZW5naW5lX2NmZ3MuRnVsbEZyYW1lRW5naW5lDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgIEBwcm9wZXJ0eSAgICMgcmVhZC1vbmx5DQogICAgZGVmIG5lZWRzX3BlcnNpc3RlbnRfZW5naW5lKHNlbGYpOg0KICAgICAgICAiIiJib29sOiBDaGVjayBpZiBjb21tYW5kIG5lZWRzIGEgcGVyc2lzdGVudCBJcm9uUHl0aG9uIGVuZ2luZS4iIiINCiAgICAgICAgaWYgc2VsZi5lbmdpbmVfY2ZnczoNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmVuZ2luZV9jZmdzLlBlcnNpc3RlbnRFbmdpbmUNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkDQogICAgZGVmIHdpbmRvd19oYW5kbGUoc2VsZik6DQogICAgICAgICIiIk91dHB1dCB3aW5kb3cgaGFuZGxlLiIiIg0KICAgICAgICBpZiBzZWxmLnNjcmlwdF9ydW50aW1lOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2NyaXB0X3J1bnRpbWUuT3V0cHV0V2luZG93DQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgY29tbWFuZF9kYXRhKHNlbGYpOg0KICAgICAgICAiIiJFeHRlcm5hbENvbW1hbmREYXRhOiBSZXR1cm4gY3VycmVudCBjb21tYW5kIGRhdGEuIiIiDQogICAgICAgIGlmIHNlbGYuc2NyaXB0X3J1bnRpbWVfY2ZnczoNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcmlwdF9ydW50aW1lX2NmZ3MuQ29tbWFuZERhdGENCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBjb21tYW5kX2VsZW1lbnRzKHNlbGYpOg0KICAgICAgICAiIiJgYERCLkVsZW1lbnRTZXRgYDogUmV0dXJuIGVsZW1lbnRzIHBhc3NlZCB0byBieSBSZXZpdC4iIiINCiAgICAgICAgaWYgc2VsZi5zY3JpcHRfcnVudGltZV9jZmdzOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2NyaXB0X3J1bnRpbWVfY2Zncy5TZWxlY3RlZEVsZW1lbnRzDQoNCiAgICBAcHJvcGVydHkgICAjIHJlYWQtb25seQ0KICAgIGRlZiBjb21tYW5kX3BhdGgoc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIGN1cnJlbnQgY29tbWFuZCBwYXRoLiIiIg0KICAgICAgICBpZiAnX19jb21tYW5kcGF0aF9fJyBpbiBfX2J1aWx0aW5zX18gXA0KICAgICAgICAgICAgICAgIGFuZCBfX2J1aWx0aW5zX19bJ19fY29tbWFuZHBhdGhfXyddOg0KICAgICAgICAgICAgcmV0dXJuIF9fYnVpbHRpbnNfX1snX19jb21tYW5kcGF0aF9fJ10NCiAgICAgICAgZWxpZiBzZWxmLnNjcmlwdF9ydW50aW1lOg0KICAgICAgICAgICAgcmV0dXJuIG9wLmRpcm5hbWUoc2VsZi5zY3JpcHRfcnVudGltZS5TY3JpcHREYXRhLlNjcmlwdFBhdGgpDQoNCiAgICBAcHJvcGVydHkgICAjIHJlYWQtb25seQ0KICAgIGRlZiBjb21tYW5kX2NvbmZpZ19wYXRoKHNlbGYpOg0KICAgICAgICAiIiJzdHI6IFJldHVybiBjdXJyZW50IGNvbW1hbmQgY29uZmlnIHNjcmlwdCBwYXRoLiIiIg0KICAgICAgICBpZiAnX19jb25maWdjb21tYW5kcGF0aF9fJyBpbiBfX2J1aWx0aW5zX18gXA0KICAgICAgICAgICAgICAgIGFuZCBfX2J1aWx0aW5zX19bJ19fY29uZmlnY29tbWFuZHBhdGhfXyddOg0KICAgICAgICAgICAgcmV0dXJuIF9fYnVpbHRpbnNfX1snX19jb25maWdjb21tYW5kcGF0aF9fJ10NCiAgICAgICAgZWxpZiBzZWxmLnNjcmlwdF9ydW50aW1lOg0KICAgICAgICAgICAgcmV0dXJuIG9wLmRpcm5hbWUoc2VsZi5zY3JpcHRfcnVudGltZS5TY3JpcHREYXRhLkNvbmZpZ1NjcmlwdFBhdGgpDQoNCiAgICBAcHJvcGVydHkgICAjIHJlYWQtb25seQ0KICAgIGRlZiBjb21tYW5kX25hbWUoc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIGN1cnJlbnQgY29tbWFuZCBuYW1lLiIiIg0KICAgICAgICBpZiAnX19jb21tYW5kbmFtZV9fJyBpbiBfX2J1aWx0aW5zX18gXA0KICAgICAgICAgICAgICAgIGFuZCBfX2J1aWx0aW5zX19bJ19fY29tbWFuZG5hbWVfXyddOg0KICAgICAgICAgICAgcmV0dXJuIF9fYnVpbHRpbnNfX1snX19jb21tYW5kbmFtZV9fJ10NCiAgICAgICAgZWxpZiBzZWxmLnNjcmlwdF9ydW50aW1lOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2NyaXB0X3J1bnRpbWUuU2NyaXB0RGF0YS5Db21tYW5kTmFtZQ0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkLW9ubHkNCiAgICBkZWYgY29tbWFuZF9idW5kbGUoc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIGN1cnJlbnQgY29tbWFuZCBidW5kbGUgbmFtZS4iIiINCiAgICAgICAgaWYgJ19fY29tbWFuZGJ1bmRsZV9fJyBpbiBfX2J1aWx0aW5zX18gXA0KICAgICAgICAgICAgICAgIGFuZCBfX2J1aWx0aW5zX19bJ19fY29tbWFuZGJ1bmRsZV9fJ106DQogICAgICAgICAgICByZXR1cm4gX19idWlsdGluc19fWydfX2NvbW1hbmRidW5kbGVfXyddDQogICAgICAgIGVsaWYgc2VsZi5zY3JpcHRfcnVudGltZToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcmlwdF9ydW50aW1lLlNjcmlwdERhdGEuQ29tbWFuZEJ1bmRsZQ0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkLW9ubHkNCiAgICBkZWYgY29tbWFuZF9leHRlbnNpb24oc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIGN1cnJlbnQgY29tbWFuZCBleHRlbnNpb24gbmFtZS4iIiINCiAgICAgICAgaWYgJ19fY29tbWFuZGV4dGVuc2lvbl9fJyBpbiBfX2J1aWx0aW5zX18gXA0KICAgICAgICAgICAgICAgIGFuZCBfX2J1aWx0aW5zX19bJ19fY29tbWFuZGV4dGVuc2lvbl9fJ106DQogICAgICAgICAgICByZXR1cm4gX19idWlsdGluc19fWydfX2NvbW1hbmRleHRlbnNpb25fXyddDQogICAgICAgIGVsaWYgc2VsZi5zY3JpcHRfcnVudGltZToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcmlwdF9ydW50aW1lLlNjcmlwdERhdGEuQ29tbWFuZEV4dGVuc2lvbg0KDQogICAgQHByb3BlcnR5ICAgIyByZWFkLW9ubHkNCiAgICBkZWYgY29tbWFuZF91bmlxdWVpZChzZWxmKToNCiAgICAgICAgIiIic3RyOiBSZXR1cm4gY3VycmVudCBjb21tYW5kIHVuaXF1ZSBpZC4iIiINCiAgICAgICAgaWYgJ19fY29tbWFuZHVuaXF1ZWlkX18nIGluIF9fYnVpbHRpbnNfXyBcDQogICAgICAgICAgICAgICAgYW5kIF9fYnVpbHRpbnNfX1snX19jb21tYW5kdW5pcXVlaWRfXyddOg0KICAgICAgICAgICAgcmV0dXJuIF9fYnVpbHRpbnNfX1snX19jb21tYW5kdW5pcXVlaWRfXyddDQogICAgICAgIGVsaWYgc2VsZi5zY3JpcHRfcnVudGltZToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnNjcmlwdF9ydW50aW1lLlNjcmlwdERhdGEuQ29tbWFuZFVuaXF1ZUlkDQoNCiAgICBAcHJvcGVydHkgICAjIHJlYWQtb25seQ0KICAgIGRlZiBjb21tYW5kX2NvbnRyb2xpZChzZWxmKToNCiAgICAgICAgIiIic3RyOiBSZXR1cm4gY3VycmVudCBjb21tYW5kIGNvbnRyb2wgaWQuIiIiDQogICAgICAgIGlmICdfX2NvbW1hbmRjb250cm9saWRfXycgaW4gX19idWlsdGluc19fIFwNCiAgICAgICAgICAgICAgICBhbmQgX19idWlsdGluc19fWydfX2NvbW1hbmRjb250cm9saWRfXyddOg0KICAgICAgICAgICAgcmV0dXJuIF9fYnVpbHRpbnNfX1snX19jb21tYW5kY29udHJvbGlkX18nXQ0KICAgICAgICBlbGlmIHNlbGYuc2NyaXB0X3J1bnRpbWU6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5zY3JpcHRfcnVudGltZS5TY3JpcHREYXRhLkNvbW1hbmRDb250cm9sSWQNCg0KICAgIEBwcm9wZXJ0eSAgICMgcmVhZC1vbmx5DQogICAgZGVmIGNvbW1hbmRfdWlidXR0b24oc2VsZik6DQogICAgICAgICIiInN0cjogUmV0dXJuIGN1cnJlbnQgY29tbWFuZCB1aSBidXR0b24uIiIiDQogICAgICAgIGlmICdfX3VpYnV0dG9uX18nIGluIF9fYnVpbHRpbnNfXyBcDQogICAgICAgICAgICAgICAgYW5kIF9fYnVpbHRpbnNfX1snX191aWJ1dHRvbl9fJ106DQogICAgICAgICAgICByZXR1cm4gX19idWlsdGluc19fWydfX3VpYnV0dG9uX18nXQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGRvY19tb2RlKHNlbGYpOg0KICAgICAgICAiIiJib29sOiBDaGVjayBpZiBweXJldml0IGlzIHJ1bm5pbmcgYnkgZG9jIGdlbmVyYXRvci4iIiINCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgcmV0dXJuIF9fc3BoaW54X18NCiAgICAgICAgZXhjZXB0IE5hbWVFcnJvcjoNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHJlc3VsdF9kaWN0KHNlbGYpOg0KICAgICAgICAiIiJgYERpY3Rpb25hcnk8U3RyaW5nLCBTdHJpbmc+YGA6IFJldHVybiByZXN1bHRzIGRpY3QgZm9yIGxvZ2dpbmcuIiIiDQogICAgICAgIGlmIHNlbGYuc2NyaXB0X3J1bnRpbWU6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5zY3JpcHRfcnVudGltZS5HZXRSZXN1bHRzRGljdGlvbmFyeSgpDQoNCg0KIyBjcmVhdGUgYW4gaW5zdGFuY2Ugb2YgX0V4ZWN1dG9yUGFyYW1zIHdyYXBwaW5nIGN1cnJlbnQgcnVudGltZS4NCkVYRUNfUEFSQU1TID0gX0V4ZWN1dG9yUGFyYW1zKCkNCg0KDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojIHR5cGUgdG8gc2FmZWx5IGdldCBkb2N1bWVudCBpbnN0YW5jZSBmcm9tIGFwcCBvciBldmVudCBhcmdzDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoNCmNsYXNzIF9Eb2NzR2V0dGVyKG9iamVjdCk6DQogICAgIiIiSW5zdGFuY2UgdG8gc2FmZWx5IGdldCBkb2N1bWVudCBmcm9tIEhPU1RfQVBQIGluc3RhbmNlIG9yIEVYRUNfUEFSQU1TLiIiIg0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGRvYyhzZWxmKToNCiAgICAgICAgIiIiQWN0aXZlIGRvY3VtZW50LiIiIg0KICAgICAgICByZXR1cm4gSE9TVF9BUFAuZG9jIG9yIEVYRUNfUEFSQU1TLmV2ZW50X2RvYw0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGRvY3Moc2VsZik6DQogICAgICAgICIiIkxpc3Qgb2YgYWN0aXZlIGRvY3VtZW50cy4iIiINCiAgICAgICAgcmV0dXJuIEhPU1RfQVBQLmRvY3MNCg0KDQpET0NTID0gX0RvY3NHZXR0ZXIoKQ0KDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojIGNvbmZpZyB1c2VyIGVudmlyb25tZW50IHBhdGhzDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojIHVzZXIgZW52IHBhdGhzDQppZiBFWEVDX1BBUkFNUy5kb2NfbW9kZToNCiAgICBBTExVU0VSX1BST0dSQU1EQVRBID0gVVNFUl9ST0FNSU5HX0RJUiA9IFVTRVJfU1lTX1RFTVAgPSBVU0VSX0RFU0tUT1AgPSBcDQogICAgRVhURU5TSU9OU19ERUZBVUxUX0RJUiA9IFRISVJEUEFSVFlfRVhURU5TSU9OU19ERUZBVUxUX0RJUiA9ICcgJw0KZWxzZToNCiAgICBBTExVU0VSX1BST0dSQU1EQVRBID0gb3MuZ2V0ZW52KCdwcm9ncmFtZGF0YScpDQogICAgVVNFUl9ST0FNSU5HX0RJUiA9IG9zLmdldGVudignYXBwZGF0YScpDQogICAgVVNFUl9TWVNfVEVNUCA9IG9zLmdldGVudigndGVtcCcpDQogICAgVVNFUl9ERVNLVE9QID0gb3AuZXhwYW5kdmFycygnJXVzZXJwcm9maWxlJVxcZGVza3RvcCcpDQoNCiAgICAjIHZlcmlmeSBkaXJlY3RvcnkgcGVyIGlzc3VlICMzNjkNCiAgICBpZiBub3QgVVNFUl9ERVNLVE9QIG9yIG5vdCBvcC5leGlzdHMoVVNFUl9ERVNLVE9QKToNCiAgICAgICAgVVNFUl9ERVNLVE9QID0gVVNFUl9TWVNfVEVNUA0KDQogICAgIyBkZWZhdWx0IGV4dGVuc2lvbnMgZGlyZWN0b3J5DQogICAgRVhURU5TSU9OU19ERUZBVUxUX0RJUiA9IG9wLmpvaW4oSE9NRV9ESVIsICdleHRlbnNpb25zJykNCiAgICBUSElSRFBBUlRZX0VYVEVOU0lPTlNfREVGQVVMVF9ESVIgPSBcDQogICAgICAgIG9wLmpvaW4oVVNFUl9ST0FNSU5HX0RJUiwgUFlSRVZJVF9BRERPTl9OQU1FLCAnRXh0ZW5zaW9ucycpDQoNCiMgY3JlYXRlIHBhdGhzIGZvciBweXJldml0IGZpbGVzDQppZiBFWEVDX1BBUkFNUy5kb2NfbW9kZToNCiAgICBQWVJFVklUX0FMTFVTRVJfQVBQX0RJUiA9IFBZUkVWSVRfQVBQX0RJUiA9IFBZUkVWSVRfVkVSU0lPTl9BUFBfRElSID0gJyAnDQplbHNlOg0KICAgICMgcHlyZXZpdCBmaWxlIGRpcmVjdG9yeQ0KICAgIFBZUkVWSVRfQUxMVVNFUl9BUFBfRElSID0gb3Auam9pbihBTExVU0VSX1BST0dSQU1EQVRBLCBQWVJFVklUX0FERE9OX05BTUUpDQogICAgUFlSRVZJVF9BUFBfRElSID0gb3Auam9pbihVU0VSX1JPQU1JTkdfRElSLCBQWVJFVklUX0FERE9OX05BTUUpDQogICAgUFlSRVZJVF9WRVJTSU9OX0FQUF9ESVIgPSBvcC5qb2luKFBZUkVWSVRfQVBQX0RJUiwgSE9TVF9BUFAudmVyc2lvbikNCg0KICAgICMgYWRkIHJ1bnRpbWUgcGF0aHMgdG8gc3lzLnBhdGhzDQogICAgIyB0aGlzIHdpbGwgYWxsb3cgaW1wb3J0aW5nIGFueSBkeW5hbWljYWxseSBjb21waWxlZCBETExzIHRoYXQNCiAgICAjIHdvdWxkIGJlIHBsYWNlZCB1bmRlciB0aGlzIHBhdGhzLg0KICAgIGZvciBweXJ2dF9hcHBfZGlyIGluIFtQWVJFVklUX0FQUF9ESVIsDQogICAgICAgICAgICAgICAgICAgICAgICAgIFBZUkVWSVRfVkVSU0lPTl9BUFBfRElSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICBUSElSRFBBUlRZX0VYVEVOU0lPTlNfREVGQVVMVF9ESVJdOg0KICAgICAgICBpZiBub3Qgb3AuaXNkaXIocHlydnRfYXBwX2Rpcik6DQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgb3MubWtkaXIocHlydnRfYXBwX2RpcikNCiAgICAgICAgICAgICAgICBzeXMucGF0aC5hcHBlbmQocHlydnRfYXBwX2RpcikNCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRFeGNlcHRpb24oJ0NhbiBub3QgYWNjZXNzIHB5UmV2aXQgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ZvbGRlciBhdDoge30gfCB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQocHlydnRfYXBwX2RpciwgZXJyKSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHN5cy5wYXRoLmFwcGVuZChweXJ2dF9hcHBfZGlyKQ0KDQoNCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiMgc3RhbmRhcmQgcHJlZml4ZXMgZm9yIG5hbWluZyBweXJldml0IGZpbGVzIChjb25maWcsIGFwcGRhdGEgYW5kIHRlbXAgZmlsZXMpDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQppZiBFWEVDX1BBUkFNUy5kb2NfbW9kZToNCiAgICBQWVJFVklUX0ZJTEVfUFJFRklYX1VOSVZFUlNBTCA9IFBZUkVWSVRfRklMRV9QUkVGSVggPSBcDQogICAgICAgIFBZUkVWSVRfRklMRV9QUkVGSVhfU1RBTVBFRCA9IE5vbmUNCiAgICBQWVJFVklUX0ZJTEVfUFJFRklYX1VOSVZFUlNBTF9VU0VSID0gUFlSRVZJVF9GSUxFX1BSRUZJWF9VU0VSID0gXA0KICAgICAgICBQWVJFVklUX0ZJTEVfUFJFRklYX1NUQU1QRURfVVNFUiA9IE5vbmUNCmVsc2U6DQogICAgIyBlLmcuIHB5UmV2aXRfDQogICAgUFlSRVZJVF9GSUxFX1BSRUZJWF9VTklWRVJTQUwgPSAne31fJy5mb3JtYXQoUFlSRVZJVF9BRERPTl9OQU1FKQ0KICAgIFBZUkVWSVRfRklMRV9QUkVGSVhfVU5JVkVSU0FMX1JFR0VYID0gXA0KICAgICAgICByJ14nICsgUFlSRVZJVF9BRERPTl9OQU1FICsgcidfKD9QPGZuYW1lPi4rKScNCg0KICAgICMgZS5nLiBweVJldml0XzIwMThfDQogICAgUFlSRVZJVF9GSUxFX1BSRUZJWCA9ICd7fV97fV8nLmZvcm1hdChQWVJFVklUX0FERE9OX05BTUUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBIT1NUX0FQUC52ZXJzaW9uKQ0KICAgIFBZUkVWSVRfRklMRV9QUkVGSVhfUkVHRVggPSBcDQogICAgICAgIHInXicgKyBQWVJFVklUX0FERE9OX05BTUUgKyByJ18oP1A8dmVyc2lvbj5cZHs0fSlfKD9QPGZuYW1lPi4rKScNCg0KICAgICMgZS5nLiBweVJldml0XzIwMThfMTQ0MjJfDQogICAgUFlSRVZJVF9GSUxFX1BSRUZJWF9TVEFNUEVEID0gJ3t9X3t9X3t9XycuZm9ybWF0KFBZUkVWSVRfQURET05fTkFNRSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSE9TVF9BUFAudmVyc2lvbiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSE9TVF9BUFAucHJvY19pZCkNCiAgICBQWVJFVklUX0ZJTEVfUFJFRklYX1NUQU1QRURfUkVHRVggPSBcDQogICAgICAgIHInXicgKyBQWVJFVklUX0FERE9OX05BTUUgXA0KICAgICAgICArIHInXyg/UDx2ZXJzaW9uPlxkezR9KV8oP1A8cGlkPlxkKylfKD9QPGZuYW1lPi4rKScNCg0KICAgICMgZS5nLiBweVJldml0X2VpcmFubmVqYWRfDQogICAgUFlSRVZJVF9GSUxFX1BSRUZJWF9VTklWRVJTQUxfVVNFUiA9ICd7fV97fV8nLmZvcm1hdChQWVJFVklUX0FERE9OX05BTUUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBIT1NUX0FQUC51c2VybmFtZSkNCiAgICBQWVJFVklUX0ZJTEVfUFJFRklYX1VOSVZFUlNBTF9VU0VSX1JFR0VYID0gXA0KICAgICAgICByJ14nICsgUFlSRVZJVF9BRERPTl9OQU1FICsgcidfKD9QPHVzZXI+LispXyg/UDxmbmFtZT4uKyknDQoNCiAgICAjIGUuZy4gcHlSZXZpdF8yMDE4X2VpcmFubmVqYWRfDQogICAgUFlSRVZJVF9GSUxFX1BSRUZJWF9VU0VSID0gJ3t9X3t9X3t9XycuZm9ybWF0KFBZUkVWSVRfQURET05fTkFNRSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSE9TVF9BUFAudmVyc2lvbiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSE9TVF9BUFAudXNlcm5hbWUpDQogICAgUFlSRVZJVF9GSUxFX1BSRUZJWF9VU0VSX1JFR0VYID0gXA0KICAgICAgICByJ14nICsgUFlSRVZJVF9BRERPTl9OQU1FIFwNCiAgICAgICAgKyByJ18oP1A8dmVyc2lvbj5cZHs0fSlfKD9QPHVzZXI+LispXyg/UDxmbmFtZT4uKyknDQoNCiAgICAjIGUuZy4gcHlSZXZpdF8yMDE4X2VpcmFubmVqYWRfMTQ0MjJfDQogICAgUFlSRVZJVF9GSUxFX1BSRUZJWF9TVEFNUEVEX1VTRVIgPSAne31fe31fe31fe31fJy5mb3JtYXQoUFlSRVZJVF9BRERPTl9OQU1FLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEhPU1RfQVBQLnZlcnNpb24sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSE9TVF9BUFAudXNlcm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSE9TVF9BUFAucHJvY19pZCkNCiAgICBQWVJFVklUX0ZJTEVfUFJFRklYX1NUQU1QRURfVVNFUl9SRUdFWCA9IFwNCiAgICAgICAgcideJyArIFBZUkVWSVRfQURET05fTkFNRSBcDQogICAgICAgICsgcidfKD9QPHZlcnNpb24+XGR7NH0pXyg/UDx1c2VyPi4rKV8oP1A8cGlkPlxkKylfKD9QPGZuYW1lPi4rKScNCg0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KIyBjb25maWcgbGFicyBtb2R1bGVzDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQpmcm9tIHB5cmV2aXQgaW1wb3J0IGxhYnMNCg0KDQoiIiJQcm92aWRlIGFjY2VzcyB0byBEb3ROZXQgRnJhbWV3b3JrLg0KDQpFeGFtcGxlczoNCiAgICBgYGBweXRob24NCiAgICBmcm9tIHB5cmV2aXQuZnJhbWV3b3JrIGltcG9ydCBBc3NlbWJseSwgV2luZG93cw0KICAgIGBgYA0KIiIiDQoNCiNweWxpbnQ6IGRpc2FibGU9VzA3MDMsQzAzMDIsQzAxMDMsVzA2MTQsRTA0MDEsVzA2MTEsQzA0MTMsdW5ncm91cGVkLWltcG9ydHMNCmltcG9ydCBvcy5wYXRoIGFzIG9wDQpmcm9tIHB5cmV2aXQuY29tcGF0IGltcG9ydCBQWTMsIFBZMg0KDQppbXBvcnQgY2xyDQppbXBvcnQgU3lzdGVtDQoNCg0KIyBuZXRjb3JlIGluaXQNCmlmIGludChfX3Jldml0X18uQXBwbGljYXRpb24uVmVyc2lvbk51bWJlcikgPj0gMjAyNToNCiAgICBjbHIuQWRkUmVmZXJlbmNlKCdTeXN0ZW0uUnVudGltZScpDQogICAgY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLlRleHQuUmVndWxhckV4cHJlc3Npb25zJykNCiAgICBjbHIuQWRkUmVmZXJlbmNlKCdTeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzcycpDQogICAgY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLklPLkZpbGVTeXN0ZW0uRHJpdmVJbmZvJykNCiAgICBjbHIuQWRkUmVmZXJlbmNlKCdTeXN0ZW0uTmV0LldlYkNsaWVudCcpDQogICAgY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLk5ldC5SZXF1ZXN0cycpDQogICAgY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLk5ldC5XZWJQcm94eScpDQogICAgY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLlJ1bnRpbWUuU2VyaWFsaXphdGlvbi5Gb3JtYXR0ZXJzJykNCiAgICBjbHIuQWRkUmVmZXJlbmNlKCdTeXN0ZW0uUmVmbGVjdGlvbi5FbWl0JykNCiAgICBjbHIuQWRkUmVmZXJlbmNlKCdMb2thZC5JTFBhY2snKQ0KICAgIGNsci5BZGRSZWZlcmVuY2UoJ1N5c3RlbS5Db21wb25lbnRNb2RlbCcpDQogICAgY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLk9iamVjdE1vZGVsJykNCiAgICBjbHIuQWRkUmVmZXJlbmNlKCdTeXN0ZW0uRGlhZ25vc3RpY3MuRmlsZVZlcnNpb25JbmZvJykNCg0KY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLkNvcmUnKQ0KY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLk1hbmFnZW1lbnQnKQ0KY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLldpbmRvd3MuRm9ybXMnKQ0KY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLkRyYXdpbmcnKQ0KY2xyLkFkZFJlZmVyZW5jZSgnUHJlc2VudGF0aW9uQ29yZScpDQpjbHIuQWRkUmVmZXJlbmNlKCdQcmVzZW50YXRpb25GcmFtZXdvcmsnKQ0KY2xyLkFkZFJlZmVyZW5jZSgnU3lzdGVtLlhtbC5MaW5xJykNCmNsci5BZGRSZWZlcmVuY2UoJ1dpbmRvd3NCYXNlJykNCg0KIyBhZGQgbGlucSBleHRlbnNpb25zPw0KaWYgUFkyOg0KICAgIGNsci5JbXBvcnRFeHRlbnNpb25zKFN5c3RlbS5MaW5xKQ0KDQpmcm9tIFN5c3RlbSBpbXBvcnQgQXBwRG9tYWluLCBWZXJzaW9uDQpmcm9tIFN5c3RlbSBpbXBvcnQgVHlwZQ0KZnJvbSBTeXN0ZW0gaW1wb3J0IFVyaSwgVXJpS2luZCwgR3VpZA0KZnJvbSBTeXN0ZW0gaW1wb3J0IEV2ZW50SGFuZGxlcg0KZnJvbSBTeXN0ZW0gaW1wb3J0IEFycmF5LCBJbnRQdHIsIEVudW0sIEJ5dGUNCmZyb20gU3lzdGVtIGltcG9ydCBDb252ZXJ0DQpmcm9tIFN5c3RlbS5UZXh0IGltcG9ydCBFbmNvZGluZw0KZnJvbSBTeXN0ZW0uVGV4dC5SZWd1bGFyRXhwcmVzc2lvbnMgaW1wb3J0IFJlZ2V4DQpmcm9tIFN5c3RlbS5Db2xsZWN0aW9ucyBpbXBvcnQgT2JqZWN0TW9kZWwNCmZyb20gU3lzdGVtLkNvbGxlY3Rpb25zLk9iamVjdE1vZGVsIGltcG9ydCBPYnNlcnZhYmxlQ29sbGVjdGlvbg0KZnJvbSBTeXN0ZW0uQ29sbGVjdGlvbnMgaW1wb3J0IElFbnVtZXJhdG9yLCBJRW51bWVyYWJsZQ0KZnJvbSBTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYyBpbXBvcnQgTGlzdCwgRGljdGlvbmFyeQ0KZnJvbSBTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYyBpbXBvcnQgSUxpc3QsIElEaWN0aW9uYXJ5DQpmcm9tIFN5c3RlbS5Db2xsZWN0aW9ucy5HZW5lcmljIGltcG9ydCBLZXlWYWx1ZVBhaXINCmZyb20gU3lzdGVtIGltcG9ydCBEYXRlVGltZSwgRGF0ZVRpbWVPZmZzZXQNCg0KZnJvbSBTeXN0ZW0gaW1wb3J0IERpYWdub3N0aWNzDQpmcm9tIFN5c3RlbS5EaWFnbm9zdGljcyBpbXBvcnQgUHJvY2Vzcw0KZnJvbSBTeXN0ZW0uRGlhZ25vc3RpY3MgaW1wb3J0IFN0b3B3YXRjaA0KDQpmcm9tIFN5c3RlbSBpbXBvcnQgUmVmbGVjdGlvbg0KZnJvbSBTeXN0ZW0uUmVmbGVjdGlvbiBpbXBvcnQgQXNzZW1ibHksIEFzc2VtYmx5TmFtZQ0KZnJvbSBTeXN0ZW0uUmVmbGVjdGlvbiBpbXBvcnQgVHlwZUF0dHJpYnV0ZXMsIE1ldGhvZEF0dHJpYnV0ZXMNCmZyb20gU3lzdGVtLlJlZmxlY3Rpb24gaW1wb3J0IENhbGxpbmdDb252ZW50aW9ucw0KZnJvbSBTeXN0ZW0uUmVmbGVjdGlvbiBpbXBvcnQgQmluZGluZ0ZsYWdzDQpmcm9tIFN5c3RlbS5SZWZsZWN0aW9uLkVtaXQgaW1wb3J0IEFzc2VtYmx5QnVpbGRlckFjY2Vzcw0KZnJvbSBTeXN0ZW0uUmVmbGVjdGlvbi5FbWl0IGltcG9ydCBDdXN0b21BdHRyaWJ1dGVCdWlsZGVyLCBPcENvZGVzDQoNCmZyb20gU3lzdGVtIGltcG9ydCBJTw0KZnJvbSBTeXN0ZW0uSU8gaW1wb3J0IElPRXhjZXB0aW9uLCBEcml2ZUluZm8sIFBhdGgsIFN0cmluZ1JlYWRlciwgRmlsZQ0KDQpmcm9tIFN5c3RlbSBpbXBvcnQgTmV0DQpmcm9tIFN5c3RlbS5OZXQgaW1wb3J0IFdlYkNsaWVudCwgV2ViUmVxdWVzdCwgV2ViUHJveHkNCg0KZnJvbSBTeXN0ZW0gaW1wb3J0IENvbXBvbmVudE1vZGVsDQpmcm9tIFN5c3RlbSBpbXBvcnQgRHJhd2luZw0KZnJvbSBTeXN0ZW0gaW1wb3J0IFdpbmRvd3MNCmZyb20gU3lzdGVtLldpbmRvd3MgaW1wb3J0IEZvcm1zDQpmcm9tIFN5c3RlbS5XaW5kb3dzLkZvcm1zIGltcG9ydCBDbGlwYm9hcmQNCmZyb20gU3lzdGVtLldpbmRvd3MgaW1wb3J0IENvbnRyb2xzDQpmcm9tIFN5c3RlbS5XaW5kb3dzIGltcG9ydCBEb2N1bWVudHMNCmZyb20gU3lzdGVtLldpbmRvd3MgaW1wb3J0IE1lZGlhDQpmcm9tIFN5c3RlbS5XaW5kb3dzIGltcG9ydCBUaHJlYWRpbmcNCmZyb20gU3lzdGVtLldpbmRvd3MgaW1wb3J0IEludGVyb3ANCmZyb20gU3lzdGVtLldpbmRvd3MgaW1wb3J0IElucHV0DQpmcm9tIFN5c3RlbS5XaW5kb3dzIGltcG9ydCBEYXRhDQpmcm9tIFN5c3RlbS5XaW5kb3dzIGltcG9ydCBSZXNvdXJjZURpY3Rpb25hcnkNCmZyb20gU3lzdGVtLldpbmRvd3MuTWVkaWEgaW1wb3J0IEltYWdpbmcsIFNvbGlkQ29sb3JCcnVzaCwgQ29sb3INCmZyb20gU3lzdGVtIGltcG9ydCBNYXRoDQpmcm9tIFN5c3RlbS5NYW5hZ2VtZW50IGltcG9ydCBNYW5hZ2VtZW50T2JqZWN0U2VhcmNoZXINCmZyb20gU3lzdGVtLlJ1bnRpbWUuU2VyaWFsaXphdGlvbiBpbXBvcnQgRm9ybWF0dGVyU2VydmljZXMNCmZyb20gU3lzdGVtLkxpbnEgaW1wb3J0IEVudW1lcmFibGUNCg0KaW1wb3J0IHB5cmV2aXQuZW5naW5lIGFzIGVuZw0KDQoNCkFTU0VNQkxZX0ZJTEVfVFlQRSA9ICdkbGwnDQpBU1NFTUJMWV9GSUxFX0VYVCA9ICcuZGxsJw0KDQoNCmlweV9hc3NtbmFtZSA9ICd7cHJlZml4fUlyb25QeXRob24nLmZvcm1hdChwcmVmaXg9ZW5nLkVuZ2luZVByZWZpeCkNCmlweV9kbGxwYXRoID0gb3Auam9pbihlbmcuRW5naW5lUGF0aCwgaXB5X2Fzc21uYW1lICsgQVNTRU1CTFlfRklMRV9FWFQpDQppZiBQWTM6DQogICAgY2xyLkFkZFJlZmVyZW5jZShpcHlfZGxscGF0aCkNCmVsc2U6DQogICAgY2xyLkFkZFJlZmVyZW5jZVRvRmlsZUFuZFBhdGgoaXB5X2RsbHBhdGgpDQoNCmltcG9ydCBJcm9uUHl0aG9uDQoNCiMgV1BGDQp3cGYgPSBOb25lDQp3cGZfYXNzbW5hbWUgPSAne3ByZWZpeH1Jcm9uUHl0aG9uLldwZicuZm9ybWF0KHByZWZpeD1lbmcuRW5naW5lUHJlZml4KQ0Kd3BmX2RsbHBhdGggPSBvcC5qb2luKGVuZy5FbmdpbmVQYXRoLCB3cGZfYXNzbW5hbWUgKyBBU1NFTUJMWV9GSUxFX0VYVCkNCnRyeToNCiAgICBjbHIuQWRkUmVmZXJlbmNlKHdwZl9hc3NtbmFtZSkNCiAgICBpZiBQWTM6DQogICAgICAgIHdwZiA9IElyb25QeXRob24uTW9kdWxlcy5XcGYNCiAgICBlbHNlOg0KICAgICAgICBpbXBvcnQgd3BmDQpleGNlcHQgRXhjZXB0aW9uOg0KICAgIGNsci5BZGRSZWZlcmVuY2VUb0ZpbGVBbmRQYXRoKHdwZl9kbGxwYXRoKQ0KICAgIGltcG9ydCB3cGYNCg0KDQojIFNRTGl0ZQ0Kc3FsaXRlMyA9IE5vbmUNCnNxbGl0ZTNfYXNzbW5hbWUgPSAne3ByZWZpeH1Jcm9uUHl0aG9uLlNRTGl0ZScuZm9ybWF0KHByZWZpeD1lbmcuRW5naW5lUHJlZml4KQ0Kc3FsaXRlM19kbGxwYXRoID0gb3Auam9pbihlbmcuRW5naW5lUGF0aCwgc3FsaXRlM19hc3NtbmFtZSArIEFTU0VNQkxZX0ZJTEVfRVhUKQ0KdHJ5Og0KICAgIGNsci5BZGRSZWZlcmVuY2Uoc3FsaXRlM19hc3NtbmFtZSkNCiAgICBpZiBQWTM6DQogICAgICAgIHNxbGl0ZTMgPSBJcm9uUHl0aG9uLlNRTGl0ZQ0KICAgIGVsc2U6DQogICAgICAgIGltcG9ydCBzcWxpdGUzDQpleGNlcHQgRXhjZXB0aW9uOg0KICAgIGNsci5BZGRSZWZlcmVuY2VUb0ZpbGVBbmRQYXRoKHNxbGl0ZTNfZGxscGF0aCkNCiAgICBpbXBvcnQgc3FsaXRlMw0KDQoNCkNQRGlhbG9ncyA9IE5vbmUNCnRyeToNCiAgICBjbHIuQWRkUmVmZXJlbmNlKCdNaWNyb3NvZnQuV2luZG93c0FQSUNvZGVQYWNrJykNCiAgICBjbHIuQWRkUmVmZXJlbmNlKCdNaWNyb3NvZnQuV2luZG93c0FQSUNvZGVQYWNrLlNoZWxsJykNCiAgICBpbXBvcnQgTWljcm9zb2Z0LldpbmRvd3NBUElDb2RlUGFjay5EaWFsb2dzIGFzIENQRGlhbG9ncyAjcHlsaW50OiBkaXNhYmxlPXVuZ3JvdXBlZC1pbXBvcnRzDQpleGNlcHQgRXhjZXB0aW9uOg0KICAgIHBhc3MNCg0KDQojIHRyeSBsb2FkaW5nIHNvbWUgdXRpbGl0eSBtb2R1bGVzIHNoaXBwZWQgd2l0aCByZXZpdA0KTlNKc29uID0gTm9uZQ0KdHJ5Og0KICAgIGNsci5BZGRSZWZlcmVuY2UoJ3B5UmV2aXRMYWJzLkpzb24nKQ0KICAgIGltcG9ydCBweVJldml0TGFicy5Kc29uIGFzIE5TSnNvbg0KZXhjZXB0IEV4Y2VwdGlvbjoNCiAgICBwYXNzDQoNCmNsci5BZGRSZWZlcmVuY2UoJ3B5UmV2aXRMYWJzLkVtb2ppcycpDQppbXBvcnQgcHlSZXZpdExhYnMuRW1vamlzIGFzIEVtb2ppcw0KDQoNCiMgZG8gbm90IGltcG9ydCBhbnl0aGluZyBmcm9tIHB5cmV2aXQgYmVmb3JlIHRoaXMNCmZyb20gcHlyZXZpdCBpbXBvcnQgQklOX0RJUg0KDQoNCmRlZiBnZXRfdHlwZShmd19vYmplY3QpOg0KICAgICIiIlJldHVybiBDTFIgdHlwZSBvZiBhbiBvYmplY3QuIiIiDQogICAgcmV0dXJuIGNsci5HZXRDbHJUeXBlKGZ3X29iamVjdCkNCg0KDQpkZWYgZ2V0X2RsbF9maWxlKGFzc2VtYmx5X25hbWUpOg0KICAgICIiIlJldHVybiBwYXRoIHRvIGdpdmVuIGFzc2VtYmx5IG5hbWUuIiIiDQogICAgYWRkaW5fZmlsZSA9IG9wLmpvaW4oQklOX0RJUiwgYXNzZW1ibHlfbmFtZSArICcuZGxsJykNCiAgICBpZiBvcC5leGlzdHMoYWRkaW5fZmlsZSk6DQogICAgICAgIHJldHVybiBhZGRpbl9maWxlDQoNCg0KZGVmIGdldF9jdXJyZW50X3RocmVhZF9pZCgpOg0KICAgICIiIlJldHVybiBtYW5hZ2VlZCB0aHJlYWQgaWQgb2YgY3VycmVudCB0aHJlYWQuIiIiDQogICAgcmV0dXJuIFN5c3RlbS5UaHJlYWRpbmcuVGhyZWFkLkN1cnJlbnRUaHJlYWQuTWFuYWdlZFRocmVhZElkDQoNCiIiIkhhbmRsZSByZWFkaW5nIGFuZCBwYXJzaW5nLCB3cml0aW4gYW5kIHNhdmluZyBvZiBhbGwgdXNlciBjb25maWd1cmF0aW9ucy4NCg0KVGhpcyBtb2R1bGUgaGFuZGxlcyB0aGUgcmVhZGluZyBhbmQgd3JpdGluZyBvZiB0aGUgcHlSZXZpdCBjb25maWd1cmF0aW9uIGZpbGVzLg0KSXQncyBiZWVuIHVzZWQgZXh0ZW5zaXZlbHkgYnkgcHlSZXZpdCBzdWItbW9kdWxlcy4gdXNlcl9jb25maWcgaXMNCnNldCB1cCBhdXRvbWF0aWNhbGx5IGluIHRoZSBnbG9iYWwgc2NvcGUgYnkgdGhpcyBtb2R1bGUgYW5kIGNhbiBiZSBpbXBvcnRlZA0KaW50byBzY3JpcHRzIGFuZCBvdGhlciBtb2R1bGVzIHRvIGFjY2VzcyB0aGUgZGVmYXVsdCBjb25maWd1cmF0aW9ucy4NCg0KQWxsIG90aGVyIG1vZHVsZXMgdXNlIHRoaXMgbW9kdWxlIHRvIHF1ZXJ5IHVzZXIgY29uZmlnLg0KDQpFeGFtcGxlczoNCiAgICBgYGBweXRob24NCiAgICBmcm9tIHB5cmV2aXQudXNlcmNvbmZpZyBpbXBvcnQgdXNlcl9jb25maWcNCiAgICB1c2VyX2NvbmZpZy5hZGRfc2VjdGlvbignbmV3c2VjdGlvbicpDQogICAgdXNlcl9jb25maWcubmV3c2VjdGlvbi5wcm9wZXJ0eSA9IHZhbHVlDQogICAgdXNlcl9jb25maWcubmV3c2VjdGlvbi5nZXRfb3B0aW9uKCdwcm9wZXJ0eScsIGRlZmF1bHRfdmFsdWUpDQogICAgdXNlcl9jb25maWcuc2F2ZV9jaGFuZ2VzKCkNCiAgICBgYGANCg0KDQpUaGUgdXNlcl9jb25maWcgb2JqZWN0IGlzIGFsc28gdGhlIGRlc3RpbmF0aW9uIGZvciByZWFkaW5nIGFuZCB3cml0aW5nDQpjb25maWd1cmF0aW9uIGJ5IHB5UmV2aXQgc2NyaXB0cyB0aHJvdWdoIDpmdW5jOmBnZXRfY29uZmlnYCBvZg0KOm1vZDpgcHlyZXZpdC5zY3JpcHRgIG1vZHVsZS4gSGVyZSBpcyB0aGUgZnVuY3Rpb24gc291cmNlOg0KDQouLiBsaXRlcmFsaW5jbHVkZTo6IC4uLy4uL3B5cmV2aXRsaWIvcHlyZXZpdC9zY3JpcHQucHkNCiAgICA6cHlvYmplY3Q6IGdldF9jb25maWcNCg0KRXhhbXBsZXM6DQogICAgYGBgcHl0aG9uDQogICAgZnJvbSBweXJldml0IGltcG9ydCBzY3JpcHQNCiAgICBjZmcgPSBzY3JpcHQuZ2V0X2NvbmZpZygpDQogICAgY2ZnLnByb3BlcnR5ID0gdmFsdWUNCiAgICBjZmcuZ2V0X29wdGlvbigncHJvcGVydHknLCBkZWZhdWx0X3ZhbHVlKQ0KICAgIHNjcmlwdC5zYXZlX2NvbmZpZygpDQogICAgYGBgDQoiIiINCiNweWxpbnQ6IGRpc2FibGU9QzAxMDMsQzA0MTMsVzA3MDMNCmltcG9ydCBvcw0KaW1wb3J0IG9zLnBhdGggYXMgb3ANCg0KZnJvbSBweXJldml0IGltcG9ydCBFWEVDX1BBUkFNUywgSE9NRV9ESVIsIEhPU1RfQVBQLCBJU19ET1RORVRfQ09SRQ0KZnJvbSBweXJldml0IGltcG9ydCBQeVJldml0RXhjZXB0aW9uDQpmcm9tIHB5cmV2aXQgaW1wb3J0IEVYVEVOU0lPTlNfREVGQVVMVF9ESVIsIFRISVJEUEFSVFlfRVhURU5TSU9OU19ERUZBVUxUX0RJUg0KZnJvbSBweXJldml0IGltcG9ydCBQWVJFVklUX0FMTFVTRVJfQVBQX0RJUiwgUFlSRVZJVF9BUFBfRElSDQpmcm9tIHB5cmV2aXQuY29tcGF0IGltcG9ydCB3aW5yZWcgYXMgd3INCg0KZnJvbSBweXJldml0LmxhYnMgaW1wb3J0IFB5UmV2aXQNCg0KZnJvbSBweXJldml0IGltcG9ydCBjb3JldXRpbHMNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGFwcGRhdGENCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGNvbmZpZ3BhcnNlcg0KZnJvbSBweXJldml0LmNvcmV1dGlscyBpbXBvcnQgbG9nZ2VyDQpmcm9tIHB5cmV2aXQudmVyc2lvbm1nciBpbXBvcnQgdXBncmFkZQ0KDQoNCkRFRkFVTFRfQ1NWX1NFUEFSQVRPUiA9ICcsJw0KDQoNCm1sb2dnZXIgPSBsb2dnZXIuZ2V0X2xvZ2dlcihfX25hbWVfXykNCg0KDQpDT05TVFMgPSBQeVJldml0LlB5UmV2aXRDb25zdHMNCg0KDQpjbGFzcyBQeVJldml0Q29uZmlnKGNvbmZpZ3BhcnNlci5QeVJldml0Q29uZmlnUGFyc2VyKToNCiAgICAiIiJQcm92aWRlIHJlYWQvd3JpdGUgYWNjZXNzIHRvIHB5UmV2aXQgY29uZmlndXJhdGlvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIGNmZ19maWxlX3BhdGggKHN0cik6IGZ1bGwgcGF0aCB0byBjb25maWcgZmlsZSB0byBiZSB1c2VkLg0KICAgICAgICBjb25maWdfdHlwZSAoc3RyKTogdHlwZSBvZiBjb25maWcgZmlsZQ0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBjZmcgPSBQeVJldml0Q29uZmlnKGNmZ19maWxlX3BhdGgpDQogICAgICAgIGNmZy5hZGRfc2VjdGlvbignc2VjdGlvbm5hbWUnKQ0KICAgICAgICBjZmcuc2VjdGlvbm5hbWUucHJvcGVydHkgPSB2YWx1ZQ0KICAgICAgICBjZmcuc2VjdGlvbm5hbWUuZ2V0X29wdGlvbigncHJvcGVydHknLCBkZWZhdWx0X3ZhbHVlKQ0KICAgICAgICBjZmcuc2F2ZV9jaGFuZ2VzKCkNCiAgICAgICAgYGBgDQogICAgIiIiDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgY2ZnX2ZpbGVfcGF0aD1Ob25lLCBjb25maWdfdHlwZT0nVW5rbm93bicpOg0KICAgICAgICAiIiJMb2FkIHNldHRpbmdzIGZyb20gcHJvdmlkZWQgY29uZmlnIGZpbGUgYW5kIHNldHVwIHBhcnNlci4iIiINCiAgICAgICAgIyB0cnkgb3BlbmluZyBhbmQgcmVhZGluZyBjb25maWcgZmlsZSBpbiBvcmRlci4NCiAgICAgICAgc3VwZXIoUHlSZXZpdENvbmZpZywgc2VsZikuX19pbml0X18oY2ZnX2ZpbGVfcGF0aD1jZmdfZmlsZV9wYXRoKQ0KDQogICAgICAgICMgc2V0IGxvZyBtb2RlIG9uIHRoZSBsb2dnZXIgbW9kdWxlIGJhc2VkIG9uDQogICAgICAgICMgdXNlciBzZXR0aW5ncyAob3ZlcnJpZGluZyB0aGUgZGVmYXVsdHMpDQogICAgICAgIHNlbGYuX3VwZGF0ZV9lbnYoKQ0KICAgICAgICBzZWxmLl9hZG1pbiA9IGNvbmZpZ190eXBlID09ICdBZG1pbicNCiAgICAgICAgc2VsZi5jb25maWdfdHlwZSA9IGNvbmZpZ190eXBlDQoNCiAgICBkZWYgX3VwZGF0ZV9lbnYoc2VsZik6DQogICAgICAgICMgdXBkYXRlIHRoZSBkZWJ1ZyBsZXZlbCBiYXNlZCBvbiB1c2VyIGNvbmZpZw0KICAgICAgICBtbG9nZ2VyLnJlc2V0X2xldmVsKCkNCg0KICAgICAgICB0cnk6DQogICAgICAgICAgICAjIGZpcnN0IGNoZWNrIHRvIHNlZSBpZiBjb21tYW5kIGlzIG5vdCBpbiBmb3JjZWQgZGVidWcgbW9kZQ0KICAgICAgICAgICAgaWYgbm90IEVYRUNfUEFSQU1TLmRlYnVnX21vZGU6DQogICAgICAgICAgICAgICAgaWYgc2VsZi5jb3JlLmRlYnVnOg0KICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLnNldF9kZWJ1Z19tb2RlKCkNCiAgICAgICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRGVidWcgbW9kZSBpcyBlbmFibGVkIGluIHVzZXIgc2V0dGluZ3MuJykNCiAgICAgICAgICAgICAgICBlbGlmIHNlbGYuY29yZS52ZXJib3NlOg0KICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLnNldF92ZXJib3NlX21vZGUoKQ0KDQogICAgICAgICAgICBsb2dnZXIuc2V0X2ZpbGVfbG9nZ2luZyhzZWxmLmNvcmUuZmlsZWxvZ2dpbmcpDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZW52X3VwZGF0ZV9lcnI6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdFcnJvciB1cGRhdGluZyBlbnYgdmFyaWFibGUgcGVyIHVzZXIgY29uZmlnLiB8ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgZW52X3VwZGF0ZV9lcnIpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgY29uZmlnX2ZpbGUoc2VsZik6DQogICAgICAgICIiIkN1cnJlbnQgY29uZmlnIGZpbGUgcGF0aC4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuX2NmZ19maWxlX3BhdGgNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBlbnZpcm9ubWVudChzZWxmKToNCiAgICAgICAgIiIiRW52aXJvbm1lbnQgc2VjdGlvbi4iIiINCiAgICAgICAgaWYgbm90IHNlbGYuaGFzX3NlY3Rpb24oQ09OU1RTLkVudkNvbmZpZ3NTZWN0aW9uTmFtZSk6DQogICAgICAgICAgICBzZWxmLmFkZF9zZWN0aW9uKENPTlNUUy5FbnZDb25maWdzU2VjdGlvbk5hbWUpDQogICAgICAgIHJldHVybiBzZWxmLmdldF9zZWN0aW9uKENPTlNUUy5FbnZDb25maWdzU2VjdGlvbk5hbWUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgY29yZShzZWxmKToNCiAgICAgICAgIiIiQ29yZSBzZWN0aW9uLiIiIg0KICAgICAgICBpZiBub3Qgc2VsZi5oYXNfc2VjdGlvbihDT05TVFMuQ29uZmlnc0NvcmVTZWN0aW9uKToNCiAgICAgICAgICAgIHNlbGYuYWRkX3NlY3Rpb24oQ09OU1RTLkNvbmZpZ3NDb3JlU2VjdGlvbikNCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X3NlY3Rpb24oQ09OU1RTLkNvbmZpZ3NDb3JlU2VjdGlvbikNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiByb3V0ZXMoc2VsZik6DQogICAgICAgICIiIlJvdXRlcyBzZWN0aW9uLiIiIg0KICAgICAgICBpZiBub3Qgc2VsZi5oYXNfc2VjdGlvbihDT05TVFMuQ29uZmlnc1JvdXRlc1NlY3Rpb24pOg0KICAgICAgICAgICAgc2VsZi5hZGRfc2VjdGlvbihDT05TVFMuQ29uZmlnc1JvdXRlc1NlY3Rpb24pDQogICAgICAgIHJldHVybiBzZWxmLmdldF9zZWN0aW9uKENPTlNUUy5Db25maWdzUm91dGVzU2VjdGlvbikNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB0ZWxlbWV0cnkoc2VsZik6DQogICAgICAgICIiIlRlbGVtZXRyeSBzZWN0aW9uLiIiIg0KICAgICAgICBpZiBub3Qgc2VsZi5oYXNfc2VjdGlvbihDT05TVFMuQ29uZmlnc1RlbGVtZXRyeVNlY3Rpb24pOg0KICAgICAgICAgICAgc2VsZi5hZGRfc2VjdGlvbihDT05TVFMuQ29uZmlnc1RlbGVtZXRyeVNlY3Rpb24pDQogICAgICAgIHJldHVybiBzZWxmLmdldF9zZWN0aW9uKENPTlNUUy5Db25maWdzVGVsZW1ldHJ5U2VjdGlvbikNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBiaW5fY2FjaGUoc2VsZik6DQogICAgICAgICIiIiJXaGV0aGVyIHRvIHVzZSB0aGUgY2FjaGUgZm9yIGV4dGVuc2lvbnMuIiIiDQogICAgICAgIHJldHVybiBzZWxmLmNvcmUuZ2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzQmluYXJ5Q2FjaGVLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzQmluYXJ5Q2FjaGVEZWZhdWx0LA0KICAgICAgICApDQoNCiAgICBAYmluX2NhY2hlLnNldHRlcg0KICAgIGRlZiBiaW5fY2FjaGUoc2VsZiwgc3RhdGUpOg0KICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzQmluYXJ5Q2FjaGVLZXksDQogICAgICAgICAgICB2YWx1ZT1zdGF0ZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgY2hlY2tfdXBkYXRlcyhzZWxmKToNCiAgICAgICAgIiIiV2hldGhlciB0byBjaGVjayBmb3IgdXBkYXRlcy4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NDaGVja1VwZGF0ZXNLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzQ2hlY2tVcGRhdGVzRGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQGNoZWNrX3VwZGF0ZXMuc2V0dGVyDQogICAgZGVmIGNoZWNrX3VwZGF0ZXMoc2VsZiwgc3RhdGUpOg0KICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzQ2hlY2tVcGRhdGVzS2V5LA0KICAgICAgICAgICAgdmFsdWU9c3RhdGUNCiAgICAgICAgKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGF1dG9fdXBkYXRlKHNlbGYpOg0KICAgICAgICAiIiJXaGV0aGVyIHRvIGF1dG9tYXRpY2FsbHkgdXBkYXRlIHB5UmV2aXQuIiIiDQogICAgICAgIHJldHVybiBzZWxmLmNvcmUuZ2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzQXV0b1VwZGF0ZUtleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NBdXRvVXBkYXRlRGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQGF1dG9fdXBkYXRlLnNldHRlcg0KICAgIGRlZiBhdXRvX3VwZGF0ZShzZWxmLCBzdGF0ZSk6DQogICAgICAgIHNlbGYuY29yZS5zZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NBdXRvVXBkYXRlS2V5LA0KICAgICAgICAgICAgdmFsdWU9c3RhdGUNCiAgICAgICAgKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHJvY2tldF9tb2RlKHNlbGYpOg0KICAgICAgICAiIiJXaGV0aGVyIHRvIGVuYWJsZSByb2NrZXQgbW9kZS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NSb2NrZXRNb2RlS2V5LA0KICAgICAgICAgICAgZGVmYXVsdF92YWx1ZT1DT05TVFMuQ29uZmlnc1JvY2tldE1vZGVEZWZhdWx0LA0KICAgICAgICApDQoNCiAgICBAcm9ja2V0X21vZGUuc2V0dGVyDQogICAgZGVmIHJvY2tldF9tb2RlKHNlbGYsIHN0YXRlKToNCiAgICAgICAgc2VsZi5jb3JlLnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1JvY2tldE1vZGVLZXksDQogICAgICAgICAgICB2YWx1ZT1zdGF0ZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgbG9nX2xldmVsKHNlbGYpOg0KICAgICAgICAiIiJMb2dnaW5nIGxldmVsLiIiIg0KICAgICAgICBpZiBzZWxmLmNvcmUuZ2V0X29wdGlvbigNCiAgICAgICAgICAgICAgICBDT05TVFMuQ29uZmlnc0RlYnVnS2V5LA0KICAgICAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NEZWJ1Z0RlZmF1bHQsDQogICAgICAgICAgICApOg0KICAgICAgICAgICAgcmV0dXJuIFB5UmV2aXQuUHlSZXZpdExvZ0xldmVscy5EZWJ1Zw0KICAgICAgICBlbGlmIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgICAgIENPTlNUUy5Db25maWdzVmVyYm9zZUtleSwNCiAgICAgICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzVmVyYm9zZURlZmF1bHQsDQogICAgICAgICAgICApOg0KICAgICAgICAgICAgcmV0dXJuIFB5UmV2aXQuUHlSZXZpdExvZ0xldmVscy5WZXJib3NlDQogICAgICAgIHJldHVybiBQeVJldml0LlB5UmV2aXRMb2dMZXZlbHMuUXVpZXQNCg0KICAgIEBsb2dfbGV2ZWwuc2V0dGVyDQogICAgZGVmIGxvZ19sZXZlbChzZWxmLCBzdGF0ZSk6DQogICAgICAgIGlmIHN0YXRlID09IFB5UmV2aXQuUHlSZXZpdExvZ0xldmVscy5EZWJ1ZzoNCiAgICAgICAgICAgIHNlbGYuY29yZS5zZXRfb3B0aW9uKENPTlNUUy5Db25maWdzRGVidWdLZXksIFRydWUpDQogICAgICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbihDT05TVFMuQ29uZmlnc1ZlcmJvc2VLZXksIFRydWUpDQogICAgICAgIGVsaWYgc3RhdGUgPT0gUHlSZXZpdC5QeVJldml0TG9nTGV2ZWxzLlZlcmJvc2U6DQogICAgICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbihDT05TVFMuQ29uZmlnc0RlYnVnS2V5LCBGYWxzZSkNCiAgICAgICAgICAgIHNlbGYuY29yZS5zZXRfb3B0aW9uKENPTlNUUy5Db25maWdzVmVyYm9zZUtleSwgVHJ1ZSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNlbGYuY29yZS5zZXRfb3B0aW9uKENPTlNUUy5Db25maWdzRGVidWdLZXksIEZhbHNlKQ0KICAgICAgICAgICAgc2VsZi5jb3JlLnNldF9vcHRpb24oQ09OU1RTLkNvbmZpZ3NWZXJib3NlS2V5LCBGYWxzZSkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBmaWxlX2xvZ2dpbmcoc2VsZik6DQogICAgICAgICIiIldoZXRoZXIgdG8gZW5hYmxlIGZpbGUgbG9nZ2luZy4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NGaWxlTG9nZ2luZ0tleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NGaWxlTG9nZ2luZ0RlZmF1bHQsDQogICAgICAgICkNCg0KICAgIEBmaWxlX2xvZ2dpbmcuc2V0dGVyDQogICAgZGVmIGZpbGVfbG9nZ2luZyhzZWxmLCBzdGF0ZSk6DQogICAgICAgIHNlbGYuY29yZS5zZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NGaWxlTG9nZ2luZ0tleSwNCiAgICAgICAgICAgIHZhbHVlPXN0YXRlDQogICAgICAgICkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBzdGFydHVwbG9nX3RpbWVvdXQoc2VsZik6DQogICAgICAgICIiIlRpbWVvdXQgZm9yIHRoZSBzdGFydHVwIGxvZy4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NTdGFydHVwTG9nVGltZW91dEtleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NTdGFydHVwTG9nVGltZW91dERlZmF1bHQsDQogICAgICAgICkNCg0KICAgIEBzdGFydHVwbG9nX3RpbWVvdXQuc2V0dGVyDQogICAgZGVmIHN0YXJ0dXBsb2dfdGltZW91dChzZWxmLCB0aW1lb3V0KToNCiAgICAgICAgc2VsZi5jb3JlLnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1N0YXJ0dXBMb2dUaW1lb3V0S2V5LA0KICAgICAgICAgICAgdmFsdWU9dGltZW91dA0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgcmVxdWlyZWRfaG9zdF9idWlsZChzZWxmKToNCiAgICAgICAgIiIiSG9zdCBidWlsZCByZXF1aXJlZCB0byBydW4gdGhlIGNvbW1hbmRzLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5jb3JlLmdldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1JlcXVpcmVkSG9zdEJ1aWxkS2V5LA0KICAgICAgICAgICAgZGVmYXVsdF92YWx1ZT0iIiwNCiAgICAgICAgKQ0KDQogICAgQHJlcXVpcmVkX2hvc3RfYnVpbGQuc2V0dGVyDQogICAgZGVmIHJlcXVpcmVkX2hvc3RfYnVpbGQoc2VsZiwgYnVpbGRudW1iZXIpOg0KICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzUmVxdWlyZWRIb3N0QnVpbGRLZXksDQogICAgICAgICAgICB2YWx1ZT1idWlsZG51bWJlcg0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgbWluX2hvc3RfZHJpdmVmcmVlc3BhY2Uoc2VsZik6DQogICAgICAgICIiIk1pbmltdW0gZnJlZSBzcGFjZSBmb3IgcnVubmluZyB0aGUgY29tbWFuZHMuIiIiDQogICAgICAgIHJldHVybiBzZWxmLmNvcmUuZ2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzTWluRHJpdmVTcGFjZUtleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NNaW5Ecml2ZVNwYWNlRGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQG1pbl9ob3N0X2RyaXZlZnJlZXNwYWNlLnNldHRlcg0KICAgIGRlZiBtaW5faG9zdF9kcml2ZWZyZWVzcGFjZShzZWxmLCBmcmVlc3BhY2UpOg0KICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzTWluRHJpdmVTcGFjZUtleSwNCiAgICAgICAgICAgIHZhbHVlPWZyZWVzcGFjZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgbG9hZF9iZXRhKHNlbGYpOg0KICAgICAgICAiIiJXaGV0aGVyIHRvIGxvYWQgY29tbWFuZHMgaW4gYmV0YS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NMb2FkQmV0YUtleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NMb2FkQmV0YURlZmF1bHQsDQogICAgICAgICkNCg0KICAgIEBsb2FkX2JldGEuc2V0dGVyDQogICAgZGVmIGxvYWRfYmV0YShzZWxmLCBzdGF0ZSk6DQogICAgICAgIHNlbGYuY29yZS5zZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NMb2FkQmV0YUtleSwNCiAgICAgICAgICAgIHZhbHVlPXN0YXRlDQogICAgICAgICkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBjcHl0aG9uX2VuZ2luZV92ZXJzaW9uKHNlbGYpOg0KICAgICAgICAiIiJDUHl0aG9uIGVuZ2luZSB2ZXJzaW9uIHRvIHVzZS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NDUHl0aG9uRW5naW5lS2V5LA0KICAgICAgICAgICAgZGVmYXVsdF92YWx1ZT1DT05TVFMuQ29uZmlnc0NQeXRob25FbmdpbmVEZWZhdWx0LA0KICAgICAgICApDQoNCiAgICBAY3B5dGhvbl9lbmdpbmVfdmVyc2lvbi5zZXR0ZXINCiAgICBkZWYgY3B5dGhvbl9lbmdpbmVfdmVyc2lvbihzZWxmLCB2ZXJzaW9uKToNCiAgICAgICAgc2VsZi5jb3JlLnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc0NQeXRob25FbmdpbmVLZXksDQogICAgICAgICAgICB2YWx1ZT1pbnQodmVyc2lvbikNCiAgICAgICAgKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHVzZXJfbG9jYWxlKHNlbGYpOg0KICAgICAgICAiIiJVc2VyIGxvY2FsZS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NMb2NhbGVLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPSIiLA0KICAgICAgICApDQoNCiAgICBAdXNlcl9sb2NhbGUuc2V0dGVyDQogICAgZGVmIHVzZXJfbG9jYWxlKHNlbGYsIGxvY2FsX2NvZGUpOg0KICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzTG9jYWxlS2V5LA0KICAgICAgICAgICAgdmFsdWU9bG9jYWxfY29kZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgb3V0cHV0X3N0eWxlc2hlZXQoc2VsZik6DQogICAgICAgICIiIlN0eWxlc2hlZXQgdXNlZCBmb3Igb3V0cHV0LiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5jb3JlLmdldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc091dHB1dFN0eWxlU2hlZXQsDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPSIiLA0KICAgICAgICApDQoNCiAgICBAb3V0cHV0X3N0eWxlc2hlZXQuc2V0dGVyDQogICAgZGVmIG91dHB1dF9zdHlsZXNoZWV0KHNlbGYsIHN0eWxlc2hlZXRfZmlsZXBhdGgpOg0KICAgICAgICBpZiBzdHlsZXNoZWV0X2ZpbGVwYXRoOg0KICAgICAgICAgICAgc2VsZi5jb3JlLnNldF9vcHRpb24oDQogICAgICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NPdXRwdXRTdHlsZVNoZWV0LA0KICAgICAgICAgICAgICAgIHZhbHVlPXN0eWxlc2hlZXRfZmlsZXBhdGgNCiAgICAgICAgICAgICkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNlbGYuY29yZS5yZW1vdmVfb3B0aW9uKENPTlNUUy5Db25maWdzT3V0cHV0U3R5bGVTaGVldCkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiByb3V0ZXNfaG9zdChzZWxmKToNCiAgICAgICAgIiIiUm91dGVzIEFQSSBob3N0LiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5yb3V0ZXMuZ2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzUm91dGVzSG9zdEtleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NSb3V0ZXNIb3N0RGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQHJvdXRlc19ob3N0LnNldHRlcg0KICAgIGRlZiByb3V0ZXNfaG9zdChzZWxmLCByb3V0ZXNfaG9zdCk6DQogICAgICAgIHNlbGYucm91dGVzLnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1JvdXRlc0hvc3RLZXksDQogICAgICAgICAgICB2YWx1ZT1yb3V0ZXNfaG9zdA0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgcm91dGVzX3BvcnQoc2VsZik6DQogICAgICAgICIiIkFQSSByb3V0ZXMgcG9ydC4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYucm91dGVzLmdldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1JvdXRlc1BvcnRLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzUm91dGVzUG9ydERlZmF1bHQsDQogICAgICAgICkNCg0KICAgIEByb3V0ZXNfcG9ydC5zZXR0ZXINCiAgICBkZWYgcm91dGVzX3BvcnQoc2VsZiwgcG9ydCk6DQogICAgICAgIHNlbGYucm91dGVzLnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1JvdXRlc1BvcnRLZXksDQogICAgICAgICAgICB2YWx1ZT1wb3J0DQogICAgICAgICkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBsb2FkX2NvcmVfYXBpKHNlbGYpOg0KICAgICAgICAiIiJXaGV0aGVyIHRvIGxvYWQgcHlSZXZpdCBjb3JlIGFwaS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYucm91dGVzLmdldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc0xvYWRDb3JlQVBJS2V5LA0KICAgICAgICAgICAgZGVmYXVsdF92YWx1ZT1DT05TVFMuQ29uZmlnc0NvbmZpZ3NMb2FkQ29yZUFQSURlZmF1bHQsDQogICAgICAgICkNCg0KICAgIEBsb2FkX2NvcmVfYXBpLnNldHRlcg0KICAgIGRlZiBsb2FkX2NvcmVfYXBpKHNlbGYsIHN0YXRlKToNCiAgICAgICAgc2VsZi5yb3V0ZXMuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzTG9hZENvcmVBUElLZXksDQogICAgICAgICAgICB2YWx1ZT1zdGF0ZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgdGVsZW1ldHJ5X3V0Y190aW1lc3RhbXAoc2VsZik6DQogICAgICAgICIiIldoZXRoZXIgdG8gdXNlIFVUQyB0aW1lc3RhbXBzIGluIHRlbGVtZXRyeS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYudGVsZW1ldHJ5LmdldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1RlbGVtZXRyeVVUQ1RpbWVzdGFtcHNLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzVGVsZW1ldHJ5VVRDVGltZXN0YW1wc0RlZmF1bHQsDQogICAgICAgICkNCg0KICAgIEB0ZWxlbWV0cnlfdXRjX3RpbWVzdGFtcC5zZXR0ZXINCiAgICBkZWYgdGVsZW1ldHJ5X3V0Y190aW1lc3RhbXAoc2VsZiwgc3RhdGUpOg0KICAgICAgICBzZWxmLnRlbGVtZXRyeS5zZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NUZWxlbWV0cnlVVENUaW1lc3RhbXBzS2V5LA0KICAgICAgICAgICAgdmFsdWU9c3RhdGUNCiAgICAgICAgKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHRlbGVtZXRyeV9zdGF0dXMoc2VsZik6DQogICAgICAgICIiIlRlbGVtZXRyeSBzdGF0dXMuIiIiDQogICAgICAgIHJldHVybiBzZWxmLnRlbGVtZXRyeS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NUZWxlbWV0cnlTdGF0dXNLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzVGVsZW1ldHJ5U3RhdHVzRGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQHRlbGVtZXRyeV9zdGF0dXMuc2V0dGVyDQogICAgZGVmIHRlbGVtZXRyeV9zdGF0dXMoc2VsZiwgc3RhdGUpOg0KICAgICAgICBzZWxmLnRlbGVtZXRyeS5zZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NUZWxlbWV0cnlTdGF0dXNLZXksDQogICAgICAgICAgICB2YWx1ZT1zdGF0ZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgdGVsZW1ldHJ5X2ZpbGVfZGlyKHNlbGYpOg0KICAgICAgICAiIiJUZWxlbWV0cnkgZmlsZSBkaXJlY3RvcnkuIiIiDQogICAgICAgIHJldHVybiBzZWxmLnRlbGVtZXRyeS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NUZWxlbWV0cnlGaWxlRGlyS2V5LA0KICAgICAgICAgICAgZGVmYXVsdF92YWx1ZT0iIiwNCiAgICAgICAgKQ0KDQogICAgQHRlbGVtZXRyeV9maWxlX2Rpci5zZXR0ZXINCiAgICBkZWYgdGVsZW1ldHJ5X2ZpbGVfZGlyKHNlbGYsIGZpbGVwYXRoKToNCiAgICAgICAgc2VsZi50ZWxlbWV0cnkuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzVGVsZW1ldHJ5RmlsZURpcktleSwNCiAgICAgICAgICAgIHZhbHVlPWZpbGVwYXRoDQogICAgICAgICkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB0ZWxlbWV0cnlfc2VydmVyX3VybChzZWxmKToNCiAgICAgICAgIiIiVGVsZW1ldHJ5IHNlcnZlciBVUkwuIiIiDQogICAgICAgIHJldHVybiBzZWxmLnRlbGVtZXRyeS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NUZWxlbWV0cnlTZXJ2ZXJVcmxLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPSIiLA0KICAgICAgICApDQoNCiAgICBAdGVsZW1ldHJ5X3NlcnZlcl91cmwuc2V0dGVyDQogICAgZGVmIHRlbGVtZXRyeV9zZXJ2ZXJfdXJsKHNlbGYsIHNlcnZlcl91cmwpOg0KICAgICAgICBzZWxmLnRlbGVtZXRyeS5zZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NUZWxlbWV0cnlTZXJ2ZXJVcmxLZXksDQogICAgICAgICAgICB2YWx1ZT1zZXJ2ZXJfdXJsDQogICAgICAgICkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB0ZWxlbWV0cnlfaW5jbHVkZV9ob29rcyhzZWxmKToNCiAgICAgICAgIiIiV2hldGhlciB0byBpbmNsdWRlIGhvb2tzIGluIHRlbGVtZXRyeS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYudGVsZW1ldHJ5LmdldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1RlbGVtZXRyeUluY2x1ZGVIb29rc0tleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NUZWxlbWV0cnlJbmNsdWRlSG9va3NEZWZhdWx0LA0KICAgICAgICApDQoNCiAgICBAdGVsZW1ldHJ5X2luY2x1ZGVfaG9va3Muc2V0dGVyDQogICAgZGVmIHRlbGVtZXRyeV9pbmNsdWRlX2hvb2tzKHNlbGYsIHN0YXRlKToNCiAgICAgICAgc2VsZi50ZWxlbWV0cnkuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzVGVsZW1ldHJ5SW5jbHVkZUhvb2tzS2V5LA0KICAgICAgICAgICAgdmFsdWU9c3RhdGUNCiAgICAgICAgKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGFwcHRlbGVtZXRyeV9zdGF0dXMoc2VsZik6DQogICAgICAgICIiIlRlbGVtZXRyeSBzdGF0dXMuIiIiDQogICAgICAgIHJldHVybiBzZWxmLnRlbGVtZXRyeS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NBcHBUZWxlbWV0cnlTdGF0dXNLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzQXBwVGVsZW1ldHJ5U3RhdHVzRGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQGFwcHRlbGVtZXRyeV9zdGF0dXMuc2V0dGVyDQogICAgZGVmIGFwcHRlbGVtZXRyeV9zdGF0dXMoc2VsZiwgc3RhdGUpOg0KICAgICAgICBzZWxmLnRlbGVtZXRyeS5zZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NBcHBUZWxlbWV0cnlTdGF0dXNLZXksDQogICAgICAgICAgICB2YWx1ZT1zdGF0ZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgYXBwdGVsZW1ldHJ5X3NlcnZlcl91cmwoc2VsZik6DQogICAgICAgICIiIkFwcCB0ZWxlbWV0cnkgc2VydmVyIFVSTC4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYudGVsZW1ldHJ5LmdldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc0FwcFRlbGVtZXRyeVNlcnZlclVybEtleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9IiIsDQogICAgICAgICkNCg0KICAgIEBhcHB0ZWxlbWV0cnlfc2VydmVyX3VybC5zZXR0ZXINCiAgICBkZWYgYXBwdGVsZW1ldHJ5X3NlcnZlcl91cmwoc2VsZiwgc2VydmVyX3VybCk6DQogICAgICAgIHNlbGYudGVsZW1ldHJ5LnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc0FwcFRlbGVtZXRyeVNlcnZlclVybEtleSwNCiAgICAgICAgICAgIHZhbHVlPXNlcnZlcl91cmwNCiAgICAgICAgKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGFwcHRlbGVtZXRyeV9ldmVudF9mbGFncyhzZWxmKToNCiAgICAgICAgIiIiVGVsZW1ldHJ5IGV2ZW50IGZsYWdzLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi50ZWxlbWV0cnkuZ2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzQXBwVGVsZW1ldHJ5RXZlbnRGbGFnc0tleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9IiIsDQogICAgICAgICkNCg0KICAgIEBhcHB0ZWxlbWV0cnlfZXZlbnRfZmxhZ3Muc2V0dGVyDQogICAgZGVmIGFwcHRlbGVtZXRyeV9ldmVudF9mbGFncyhzZWxmLCBmbGFncyk6DQogICAgICAgIHNlbGYudGVsZW1ldHJ5LnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc0FwcFRlbGVtZXRyeUV2ZW50RmxhZ3NLZXksDQogICAgICAgICAgICB2YWx1ZT1mbGFncw0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgdXNlcl9jYW5fdXBkYXRlKHNlbGYpOg0KICAgICAgICAiIiJXaGV0aGVyIHRoZSB1c2VyIGNhbiB1cGRhdGUgcHlSZXZpdCByZXBvcy4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NVc2VyQ2FuVXBkYXRlS2V5LA0KICAgICAgICAgICAgZGVmYXVsdF92YWx1ZT1DT05TVFMuQ29uZmlnc1VzZXJDYW5VcGRhdGVEZWZhdWx0LA0KICAgICAgICApDQoNCiAgICBAdXNlcl9jYW5fdXBkYXRlLnNldHRlcg0KICAgIGRlZiB1c2VyX2Nhbl91cGRhdGUoc2VsZiwgc3RhdGUpOg0KICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzVXNlckNhblVwZGF0ZUtleSwNCiAgICAgICAgICAgIHZhbHVlPXN0YXRlDQogICAgICAgICkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB1c2VyX2Nhbl9leHRlbmQoc2VsZik6DQogICAgICAgICIiIldoZXRoZXIgdGhlIHVzZXIgY2FuIG1hbmFnZSBweVJldml0IEV4dGVuc2lvbnMuIiIiDQogICAgICAgIHJldHVybiBzZWxmLmNvcmUuZ2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzVXNlckNhbkV4dGVuZEtleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NVc2VyQ2FuRXh0ZW5kRGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQHVzZXJfY2FuX2V4dGVuZC5zZXR0ZXINCiAgICBkZWYgdXNlcl9jYW5fZXh0ZW5kKHNlbGYsIHN0YXRlKToNCiAgICAgICAgc2VsZi5jb3JlLnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1VzZXJDYW5FeHRlbmRLZXksDQogICAgICAgICAgICB2YWx1ZT1zdGF0ZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgdXNlcl9jYW5fY29uZmlnKHNlbGYpOg0KICAgICAgICAiIiJXaGV0aGVyIHRoZSB1c2VyIGNhbiBhY2Nlc3MgdGhlIGNvbmZpZ3VyYXRpb24uIiIiDQogICAgICAgIHJldHVybiBzZWxmLmNvcmUuZ2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzVXNlckNhbkNvbmZpZ0tleSwNCiAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9Q09OU1RTLkNvbmZpZ3NVc2VyQ2FuQ29uZmlnRGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQHVzZXJfY2FuX2NvbmZpZy5zZXR0ZXINCiAgICBkZWYgdXNlcl9jYW5fY29uZmlnKHNlbGYsIHN0YXRlKToNCiAgICAgICAgc2VsZi5jb3JlLnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc1VzZXJDYW5Db25maWdLZXksDQogICAgICAgICAgICB2YWx1ZT1zdGF0ZQ0KICAgICAgICApDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgY29sb3JpemVfZG9jcyhzZWxmKToNCiAgICAgICAgIiIiV2hldGhlciB0byBlbmFibGUgdGhlIGRvY3VtZW50IGNvbG9yaXplci4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NDb2xvcml6ZURvY3NLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzQ29sb3JpemVEb2NzRGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQGNvbG9yaXplX2RvY3Muc2V0dGVyDQogICAgZGVmIGNvbG9yaXplX2RvY3Moc2VsZiwgc3RhdGUpOg0KICAgICAgICBzZWxmLmNvcmUuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzQ29sb3JpemVEb2NzS2V5LA0KICAgICAgICAgICAgdmFsdWU9c3RhdGUNCiAgICAgICAgKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHRvb2x0aXBfZGVidWdfaW5mbyhzZWxmKToNCiAgICAgICAgIiIiV2hldGhlciB0byBhcHBlbmQgZGVidWcgaW5mbyBvbiB0b29sdGlwcy4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuY29yZS5nZXRfb3B0aW9uKA0KICAgICAgICAgICAgQ09OU1RTLkNvbmZpZ3NBcHBlbmRUb29sdGlwRXhLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPUNPTlNUUy5Db25maWdzQXBwZW5kVG9vbHRpcEV4RGVmYXVsdCwNCiAgICAgICAgKQ0KDQogICAgQHRvb2x0aXBfZGVidWdfaW5mby5zZXR0ZXINCiAgICBkZWYgdG9vbHRpcF9kZWJ1Z19pbmZvKHNlbGYsIHN0YXRlKToNCiAgICAgICAgc2VsZi5jb3JlLnNldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuQ29uZmlnc0FwcGVuZFRvb2x0aXBFeEtleSwNCiAgICAgICAgICAgIHZhbHVlPXN0YXRlDQogICAgICAgICkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiByb3V0ZXNfc2VydmVyKHNlbGYpOg0KICAgICAgICAiIiJXaGV0aGVyIHRoZSBzZXJ2ZXIgcm91dGVzIGFyZSBlbmFibGVkLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5yb3V0ZXMuZ2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzUm91dGVzU2VydmVyS2V5LA0KICAgICAgICAgICAgZGVmYXVsdF92YWx1ZT1DT05TVFMuQ29uZmlnc1JvdXRlc1NlcnZlckRlZmF1bHQsDQogICAgICAgICkNCg0KICAgIEByb3V0ZXNfc2VydmVyLnNldHRlcg0KICAgIGRlZiByb3V0ZXNfc2VydmVyKHNlbGYsIHN0YXRlKToNCiAgICAgICAgc2VsZi5yb3V0ZXMuc2V0X29wdGlvbigNCiAgICAgICAgICAgIENPTlNUUy5Db25maWdzUm91dGVzU2VydmVyS2V5LA0KICAgICAgICAgICAgdmFsdWU9c3RhdGUNCiAgICAgICAgKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHJlc3BlY3RfbGFuZ3VhZ2VfZGlyZWN0aW9uKHNlbGYpOg0KICAgICAgICAiIiJXaGV0aGVyIHRoZSBzeXN0ZW0gcmVzcGVjdHMgdGhlIGxhbmd1YWdlIGRpcmVjdGlvbi4iIiINCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICBAcmVzcGVjdF9sYW5ndWFnZV9kaXJlY3Rpb24uc2V0dGVyDQogICAgZGVmIHJlc3BlY3RfbGFuZ3VhZ2VfZGlyZWN0aW9uKHNlbGYsIHN0YXRlKToNCiAgICAgICAgcGFzcw0KDQogICAgZGVmIGdldF9jb25maWdfdmVyc2lvbihzZWxmKToNCiAgICAgICAgIiIiUmV0dXJuIHZlcnNpb24gb2YgY29uZmlnIGZpbGUgdXNlZCBmb3IgY2hhbmdlIGRldGVjdGlvbi4NCg0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgKHN0cik6IGhhc2ggb2YgdGhlIGNvbmZpZyBmaWxlDQogICAgICAgICIiIg0KICAgICAgICByZXR1cm4gc2VsZi5nZXRfY29uZmlnX2ZpbGVfaGFzaCgpDQoNCiAgICBkZWYgZ2V0X3RoaXJkcGFydHlfZXh0X3Jvb3RfZGlycyhzZWxmLCBpbmNsdWRlX2RlZmF1bHQ9VHJ1ZSk6DQogICAgICAgICIiIlJldHVybiBhIGxpc3Qgb2YgZXh0ZXJuYWwgZXh0ZW5zaW9uIGRpcmVjdG9yaWVzIHNldCBieSB0aGUgdXNlci4NCg0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgKGxpc3Rbc3RyXSk6IEV4dGVybmFsIHVzZXIgZXh0ZW5zaW9uIGRpcmVjdG9yaWVzLg0KICAgICAgICAiIiINCiAgICAgICAgZGlyX2xpc3QgPSBzZXQoKQ0KICAgICAgICBpZiBpbmNsdWRlX2RlZmF1bHQ6DQogICAgICAgICAgICAjIGFkZCBkZWZhdWx0IGV4dCBwYXRoDQogICAgICAgICAgICBkaXJfbGlzdC5hZGQoVEhJUkRQQVJUWV9FWFRFTlNJT05TX0RFRkFVTFRfRElSKQ0KICAgICAgICB0cnk6DQogICAgICAgICAgICBkaXJfbGlzdC51cGRhdGUoWw0KICAgICAgICAgICAgICAgIG9wLmV4cGFuZHZhcnMob3Aubm9ybXBhdGgoeCkpDQogICAgICAgICAgICAgICAgZm9yIHggaW4gc2VsZi5jb3JlLmdldF9vcHRpb24oDQogICAgICAgICAgICAgICAgICAgIENPTlNUUy5Db25maWdzVXNlckV4dGVuc2lvbnNLZXksDQogICAgICAgICAgICAgICAgICAgIGRlZmF1bHRfdmFsdWU9W10NCiAgICAgICAgICAgICAgICApXSkNCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyByZWFkX2VycjoNCiAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoJ0Vycm9yIHJlYWRpbmcgbGlzdCBvZiB1c2VyIGV4dGVuc2lvbiBmb2xkZXJzLiB8ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZF9lcnIpDQoNCiAgICAgICAgcmV0dXJuIFt4IGZvciB4IGluIGRpcl9saXN0IGlmIG9wLmV4aXN0cyh4KV0NCg0KICAgIGRlZiBnZXRfZXh0X3Jvb3RfZGlycyhzZWxmKToNCiAgICAgICAgIiIiUmV0dXJuIGEgbGlzdCBvZiBhbGwgZXh0ZW5zaW9uIGRpcmVjdG9yaWVzLg0KDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICAobGlzdFtzdHJdKTogdXNlciBleHRlbnNpb24gZGlyZWN0b3JpZXMuDQoNCiAgICAgICAgIiIiDQogICAgICAgIGRpcl9saXN0ID0gc2V0KCkNCiAgICAgICAgaWYgb3AuZXhpc3RzKEVYVEVOU0lPTlNfREVGQVVMVF9ESVIpOg0KICAgICAgICAgICAgZGlyX2xpc3QuYWRkKEVYVEVOU0lPTlNfREVGQVVMVF9ESVIpDQogICAgICAgIGRpcl9saXN0LnVwZGF0ZShzZWxmLmdldF90aGlyZHBhcnR5X2V4dF9yb290X2RpcnMoKSkNCiAgICAgICAgcmV0dXJuIGxpc3QoZGlyX2xpc3QpDQoNCiAgICBkZWYgZ2V0X2V4dF9zb3VyY2VzKHNlbGYpOg0KICAgICAgICAiIiJSZXR1cm4gYSBsaXN0IG9mIGV4dGVuc2lvbiBkZWZpbml0aW9uIHNvdXJjZSBmaWxlcy4iIiINCiAgICAgICAgZXh0X3NvdXJjZXMgPSBzZWxmLmVudmlyb25tZW50LmdldF9vcHRpb24oDQogICAgICAgICAgICBDT05TVFMuRW52Q29uZmlnc0V4dGVuc2lvbkxvb2t1cFNvdXJjZXNLZXksDQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlPVtdLA0KICAgICAgICApDQogICAgICAgIHJldHVybiBsaXN0KHNldChleHRfc291cmNlcykpDQoNCiAgICBkZWYgc2V0X3RoaXJkcGFydHlfZXh0X3Jvb3RfZGlycyhzZWxmLCBwYXRoX2xpc3QpOg0KICAgICAgICAiIiJVcGRhdGVzIGxpc3Qgb2YgZXh0ZXJuYWwgZXh0ZW5zaW9uIGRpcmVjdG9yaWVzIGluIGNvbmZpZyBmaWxlLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBwYXRoX2xpc3QgKGxpc3Rbc3RyXSk6IGxpc3Qgb2YgZXh0ZXJuYWwgZXh0ZW5zaW9uIHBhdGhzDQogICAgICAgICIiIg0KICAgICAgICBmb3IgZXh0X3BhdGggaW4gcGF0aF9saXN0Og0KICAgICAgICAgICAgaWYgbm90IG9wLmV4aXN0cyhleHRfcGF0aCk6DQogICAgICAgICAgICAgICAgcmFpc2UgUHlSZXZpdEV4Y2VwdGlvbigiUGF0aCBcIiVzXCIgZG9lcyBub3QgZXhpc3QuIiAlIGV4dF9wYXRoKQ0KDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHNlbGYuY29yZS51c2VyZXh0ZW5zaW9ucyA9IFwNCiAgICAgICAgICAgICAgICBbb3Aubm9ybXBhdGgoeCkgZm9yIHggaW4gcGF0aF9saXN0XQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHdyaXRlX2VycjoNCiAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoJ0Vycm9yIHNldHRpbmcgbGlzdCBvZiB1c2VyIGV4dGVuc2lvbiBmb2xkZXJzLiB8ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGVfZXJyKQ0KDQogICAgZGVmIGdldF9jdXJyZW50X2F0dGFjaG1lbnQoc2VsZik6DQogICAgICAgICIiIlJldHVybiBjdXJyZW50IHB5UmV2aXQgYXR0YWNobWVudC4iIiINCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgcmV0dXJuIFB5UmV2aXQuUHlSZXZpdEF0dGFjaG1lbnRzLkdldEF0dGFjaGVkKGludChIT1NUX0FQUC52ZXJzaW9uKSkNCiAgICAgICAgZXhjZXB0IFB5UmV2aXRFeGNlcHRpb24gYXMgZXg6DQogICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCdFcnJvciBnZXR0aW5nIGN1cnJlbnQgYXR0YWNobWVudC4gfCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgICAgIGV4KQ0KDQogICAgZGVmIGdldF9hY3RpdmVfY3B5dGhvbl9lbmdpbmUoc2VsZik6DQogICAgICAgICIiIlJldHVybiBhY3RpdmUgY3B5dGhvbiBlbmdpbmUuIiIiDQogICAgICAgIGVuZ2luZXMgPSBbXQ0KICAgICAgICAjIHRyeSBvdCBmaW5kIGF0dGFjaG1lbnQgYW5kIGdldCBlbmdpbmVzIGZyb20gdGhlIGNsb25lDQogICAgICAgIGF0dGFjaG1lbnQgPSBzZWxmLmdldF9jdXJyZW50X2F0dGFjaG1lbnQoKQ0KICAgICAgICBpZiBhdHRhY2htZW50IGFuZCBhdHRhY2htZW50LkNsb25lOg0KICAgICAgICAgICAgZW5naW5lcyA9IGF0dGFjaG1lbnQuQ2xvbmUuR2V0TmV0Q29yZUVuZ2luZXMoKSBpZiBJU19ET1RORVRfQ09SRSBlbHNlIGF0dGFjaG1lbnQuQ2xvbmUuR2V0TmV0RnhFbmdpbmVzKCkNCiAgICAgICAgIyBpZiBjYW4gbm90IGZpbmQgYXR0YWNobWVudCwgaW5zdGFudGlhdGUgYSB0ZW1wIGNsb25lDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgY2xvbmUgPSBQeVJldml0LlB5UmV2aXRDbG9uZShjbG9uZVBhdGg9SE9NRV9ESVIpDQogICAgICAgICAgICAgICAgZW5naW5lcyA9IGNsb25lLkdldE5ldENvcmVFbmdpbmVzKCkgaWYgSVNfRE9UTkVUX0NPUkUgZWxzZSBjbG9uZS5HZXROZXRGeEVuZ2luZXMoKQ0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBjRXg6DQogICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnQ2FuIG5vdCBjcmVhdGUgY2xvbmUgZnJvbSBwYXRoOiAlcycsIHN0cihjRXgpKQ0KDQogICAgICAgICMgZmluZCBjcHl0aG9uIGVuZ2luZXMNCiAgICAgICAgY3B5X2VuZ2luZXNfZGljdCA9IHsNCiAgICAgICAgICAgIHguVmVyc2lvbjogeCBmb3IgeCBpbiBlbmdpbmVzDQogICAgICAgICAgICBpZiAnY3B5dGhvbicgaW4geC5LZXJuZWxOYW1lLmxvd2VyKCkNCiAgICAgICAgICAgIH0NCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnY3B5dGhvbiBlbmdpbmVzIGRpY3Q6ICVzJywgY3B5X2VuZ2luZXNfZGljdCkNCg0KICAgICAgICBpZiBjcHlfZW5naW5lc19kaWN0Og0KICAgICAgICAgICAgIyBncmFiIGNweXRob24gZW5naW5lIGNvbmZpZ3VyZWQgdG8gYmUgdXNlZCBieSB1c2VyDQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgY3B5ZW5naW5lX3ZlciA9IGludChzZWxmLmNweXRob25fZW5naW5lX3ZlcnNpb24pDQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOg0KICAgICAgICAgICAgICAgIGNweWVuZ2luZV92ZXIgPSAwMDANCg0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgIHJldHVybiBjcHlfZW5naW5lc19kaWN0W2NweWVuZ2luZV92ZXJdDQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6DQogICAgICAgICAgICAgICAgIyByZXR1cm4gdGhlIGxhdGVzdCBjcHl0aG9uIGVuZ2luZQ0KICAgICAgICAgICAgICAgIHJldHVybiBtYXgoDQogICAgICAgICAgICAgICAgICAgIGNweV9lbmdpbmVzX2RpY3QudmFsdWVzKCksIGtleT1sYW1iZGEgeDogeC5WZXJzaW9uLlZlcnNpb24NCiAgICAgICAgICAgICAgICApDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCdDYW4gbm90IGRldGVybWluZSBjcHl0aG9uIGVuZ2luZXMgZm9yICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ2N1cnJlbnQgYXR0YWNobWVudDogJXMnLCBhdHRhY2htZW50KQ0KDQogICAgZGVmIHNldF9hY3RpdmVfY3B5dGhvbl9lbmdpbmUoc2VsZiwgcHlyZXZpdF9lbmdpbmUpOg0KICAgICAgICAiIiJTZXQgdGhlIGFjdGl2ZSBDUHl0aG9uIGVuZ2luZS4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgcHlyZXZpdF9lbmdpbmUgKFB5UmV2aXRFbmdpbmUpOiBweXRob24gZW5naW5lIHRvIHNldCBhcyBhY3RpdmUNCiAgICAgICAgIiIiDQogICAgICAgIHNlbGYuY3B5dGhvbl9lbmdpbmVfdmVyc2lvbiA9IHB5cmV2aXRfZW5naW5lLlZlcnNpb24NCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBpc19yZWFkb25seShzZWxmKToNCiAgICAgICAgIiIiYm9vbDogd2hldGhlciB0aGUgY29uZmlnIGlzIHJlYWQgb25seS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuX2FkbWluDQoNCiAgICBkZWYgc2F2ZV9jaGFuZ2VzKHNlbGYpOg0KICAgICAgICAiIiJTYXZlIHVzZXIgY29uZmlnIGludG8gYXNzb2NpYXRlZCBjb25maWcgZmlsZS4iIiINCiAgICAgICAgaWYgbm90IHNlbGYuX2FkbWluIGFuZCBzZWxmLmNvbmZpZ19maWxlOg0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgIHN1cGVyKFB5UmV2aXRDb25maWcsIHNlbGYpLnNhdmUoKQ0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBzYXZlX2VycjoNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCdDYW4gbm90IHNhdmUgdXNlciBjb25maWcgdG86ICVzIHwgJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jb25maWdfZmlsZSwgc2F2ZV9lcnIpDQoNCiAgICAgICAgICAgICMgYWRqdXN0IGVudmlyb25tZW50IHBlciB1c2VyIGNvbmZpZ3VyYXRpb25zDQogICAgICAgICAgICBzZWxmLl91cGRhdGVfZW52KCkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0NvbmZpZyBpcyBpbiBhZG1pbiBtb2RlLiBTa2lwcGluZyBzYXZlLicpDQoNCiAgICBAc3RhdGljbWV0aG9kDQogICAgZGVmIGdldF9saXN0X3NlcGFyYXRvcigpOg0KICAgICAgICAiIiJHZXQgbGlzdCBzZXBhcmF0b3IgZGVmaW5lZCBpbiB1c2VyIG9zIHJlZ2lvbmFsIHNldHRpbmdzLiIiIg0KICAgICAgICBpbnRrZXkgPSBjb3JldXRpbHMuZ2V0X3JlZ19rZXkod3IuSEtFWV9DVVJSRU5UX1VTRVIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByJ0NvbnRyb2wgUGFuZWxcSW50ZXJuYXRpb25hbCcpDQogICAgICAgIGlmIGludGtleToNCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICByZXR1cm4gd3IuUXVlcnlWYWx1ZUV4KGludGtleSwgJ3NMaXN0JylbMF0NCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgICAgICAgICAgcmV0dXJuIERFRkFVTFRfQ1NWX1NFUEFSQVRPUg0KDQoNCmRlZiBmaW5kX2NvbmZpZ19maWxlKHRhcmdldF9wYXRoKToNCiAgICAiIiJGaW5kIGNvbmZpZyBmaWxlIGluIHRhcmdldCBwYXRoLiIiIg0KICAgIHJldHVybiBQeVJldml0LlB5UmV2aXRDb25zdHMuRmluZENvbmZpZ0ZpbGVJbkRpcmVjdG9yeSh0YXJnZXRfcGF0aCkNCg0KDQpkZWYgdmVyaWZ5X2NvbmZpZ3MoY29uZmlnX2ZpbGVfcGF0aD1Ob25lKToNCiAgICAiIiJDcmVhdGUgYSB1c2VyIHNldHRpbmdzIGZpbGUuDQoNCiAgICBpZiBjb25maWdfZmlsZV9wYXRoIGlzIG5vdCBwcm92aWRlZCwgY29uZmlncyB3aWxsIGJlIGluIG1lbW9yeSBvbmx5DQoNCiAgICBBcmdzOg0KICAgICAgICBjb25maWdfZmlsZV9wYXRoIChzdHIsIG9wdGlvbmFsKTogY29uZmlnIGZpbGUgZnVsbCBuYW1lIGFuZCBwYXRoDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAocHlyZXZpdC51c2VyY29uZmlnLlB5UmV2aXRDb25maWcpOiBweVJldml0IGNvbmZpZyBmaWxlIGhhbmRsZXINCiAgICAiIiINCiAgICBpZiBjb25maWdfZmlsZV9wYXRoOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDcmVhdGluZyBkZWZhdWx0IGNvbmZpZyBmaWxlIGF0OiAlcycsIGNvbmZpZ19maWxlX3BhdGgpDQogICAgICAgIGNvcmV1dGlscy50b3VjaChjb25maWdfZmlsZV9wYXRoKQ0KDQogICAgdHJ5Og0KICAgICAgICBwYXJzZXIgPSBQeVJldml0Q29uZmlnKGNmZ19maWxlX3BhdGg9Y29uZmlnX2ZpbGVfcGF0aCkNCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHJlYWRfZXJyOg0KICAgICAgICAjIGNhbiBub3QgY3JlYXRlIGRlZmF1bHQgdXNlciBjb25maWcgZmlsZSB1bmRlciBhcHBkYXRhIGZvbGRlcg0KICAgICAgICBtbG9nZ2VyLndhcm5pbmcoJ0NhbiBub3QgY3JlYXRlIGNvbmZpZyBmaWxlIHVuZGVyOiAlcyB8ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ19maWxlX3BhdGgsIHJlYWRfZXJyKQ0KICAgICAgICBwYXJzZXIgPSBQeVJldml0Q29uZmlnKCkNCg0KICAgIHJldHVybiBwYXJzZXINCg0KDQpMT0NBTF9DT05GSUdfRklMRSA9IEFETUlOX0NPTkZJR19GSUxFID0gVVNFUl9DT05GSUdfRklMRSA9IENPTkZJR19GSUxFID0gJycNCnVzZXJfY29uZmlnID0gTm9uZQ0KDQojIGxvY2F0aW9uIGZvciBkZWZhdWx0IHB5UmV2aXQgY29uZmlnIGZpbGVzDQppZiBub3QgRVhFQ19QQVJBTVMuZG9jX21vZGU6DQogICAgTE9DQUxfQ09ORklHX0ZJTEUgPSBmaW5kX2NvbmZpZ19maWxlKEhPTUVfRElSKQ0KICAgIEFETUlOX0NPTkZJR19GSUxFID0gZmluZF9jb25maWdfZmlsZShQWVJFVklUX0FMTFVTRVJfQVBQX0RJUikNCiAgICBVU0VSX0NPTkZJR19GSUxFID0gZmluZF9jb25maWdfZmlsZShQWVJFVklUX0FQUF9ESVIpDQoNCiAgICAjIGRlY2lkZSB3aGljaCBjb25maWcgZmlsZSB0byB1c2UNCiAgICAjIGNoZWNrIGlmIGEgY29uZmlnIGZpbGUgaXMgaW5zaWRlIHRoZSByZXBvLiBmb3IgZGV2ZWxvcGVycyBjb25maWcgb3ZlcnJpZGUNCiAgICBpZiBMT0NBTF9DT05GSUdfRklMRToNCiAgICAgICAgQ09ORklHX1RZUEUgPSAnTG9jYWwnDQogICAgICAgIENPTkZJR19GSUxFID0gTE9DQUxfQ09ORklHX0ZJTEUNCg0KICAgICMgY2hlY2sgdG8gc2VlIGlmIHRoZXJlIGlzIGFueSBjb25maWcgZmlsZSBwcm92aWRlZCBieSBhZG1pbg0KICAgIGVsaWYgQURNSU5fQ09ORklHX0ZJTEUgXA0KICAgICAgICAgICAgYW5kIG9zLmFjY2VzcyhBRE1JTl9DT05GSUdfRklMRSwgb3MuV19PSykgXA0KICAgICAgICAgICAgYW5kIG5vdCBVU0VSX0NPTkZJR19GSUxFOg0KICAgICAgICAjIGlmIHllcywgY29weSB0aGF0IGFuZCB1c2UgYXMgZGVmYXVsdA0KICAgICAgICAjIGlmIGFkbWluIGNvbmZpZyBmaWxlIGlzIHdyaXRhYmxlIGl0IG1lYW5zIGl0IGlzIHByb3ZpZGVkDQogICAgICAgICMgdG8gYm9vdHN0cmFwIHRoZSBmaXJzdCBweVJldml0IHJ1bg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBDT05GSUdfVFlQRSA9ICdTZWVkJw0KICAgICAgICAgICAgIyBtYWtlIGEgbG9jYWwgY29weSBpZiBvbmUgZG9lcyBub3QgZXhpc3QNCiAgICAgICAgICAgIFB5UmV2aXQuUHlSZXZpdENvbmZpZ3MuU2V0dXBDb25maWcoQURNSU5fQ09ORklHX0ZJTEUpDQogICAgICAgICAgICBDT05GSUdfRklMRSA9IGZpbmRfY29uZmlnX2ZpbGUoUFlSRVZJVF9BUFBfRElSKQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGFkbWluRXg6DQogICAgICAgICAgICAjIGlmIGluaXQgb3BlcmF0aW9uIGZhaWxlZCwgbWFrZSBhIG5ldyBjb25maWcgZmlsZQ0KICAgICAgICAgICAgQ09ORklHX1RZUEUgPSAnTmV3Jw0KICAgICAgICAgICAgIyBzZXR1cCBjb25maWcgZmlsZSBuYW1lIGFuZCBwYXRoDQogICAgICAgICAgICBDT05GSUdfRklMRSA9IGFwcGRhdGEuZ2V0X3VuaXZlcnNhbF9kYXRhX2ZpbGUoZmlsZV9pZD0nY29uZmlnJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2V4dD0naW5pJykNCiAgICAgICAgICAgIG1sb2dnZXIud2FybmluZygNCiAgICAgICAgICAgICAgICAnRmFpbGVkIHRvIGluaXRpYWxpemUgY29uZmlnIGZyb20gc2VlZCBmaWxlIGF0ICVzXG4nDQogICAgICAgICAgICAgICAgJ1VzaW5nIGRlZmF1bHQgY29uZmlnIGZpbGUnLA0KICAgICAgICAgICAgICAgIEFETUlOX0NPTkZJR19GSUxFDQogICAgICAgICAgICApDQoNCiAgICAjIHVubGVzcyBpdCdzIGxvY2tlZC4gdGhlbiByZWFkIHRoYXQgY29uZmlnIGZpbGUgYW5kIHNldCBhZG1pbi1tb2RlDQogICAgZWxpZiBBRE1JTl9DT05GSUdfRklMRSBcDQogICAgICAgICAgICBhbmQgbm90IG9zLmFjY2VzcyhBRE1JTl9DT05GSUdfRklMRSwgb3MuV19PSyk6DQogICAgICAgIENPTkZJR19UWVBFID0gJ0FkbWluJw0KICAgICAgICBDT05GSUdfRklMRSA9IEFETUlOX0NPTkZJR19GSUxFDQoNCiAgICAjIGlmIGEgY29uZmlnIGZpbGUgaXMgYXZhaWxhYmxlIGZvciB1c2VyIHVzZSB0aGF0DQogICAgZWxpZiBVU0VSX0NPTkZJR19GSUxFOg0KICAgICAgICBDT05GSUdfVFlQRSA9ICdVc2VyJw0KICAgICAgICBDT05GSUdfRklMRSA9IFVTRVJfQ09ORklHX0ZJTEUNCg0KICAgICMgaWYgbm90aGluZyBjYW4gYmUgZm91bmQsIG1ha2UgYSBuZXcgb25lDQogICAgZWxzZToNCiAgICAgICAgQ09ORklHX1RZUEUgPSAnTmV3Jw0KICAgICAgICAjIHNldHVwIGNvbmZpZyBmaWxlIG5hbWUgYW5kIHBhdGgNCiAgICAgICAgQ09ORklHX0ZJTEUgPSBhcHBkYXRhLmdldF91bml2ZXJzYWxfZGF0YV9maWxlKGZpbGVfaWQ9J2NvbmZpZycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2V4dD0naW5pJykNCg0KICAgIG1sb2dnZXIuZGVidWcoJ1VzaW5nICVzIGNvbmZpZyBmaWxlOiAlcycsIENPTkZJR19UWVBFLCBDT05GSUdfRklMRSkNCg0KICAgICMgcmVhZCBjb25maWcsIG9yIHNldHVwIGRlZmF1bHQgY29uZmlnIGZpbGUgaWYgbm90IGF2YWlsYWJsZQ0KICAgICMgdGhpcyBwdXNoZXMgcmVhZGluZyBzZXR0aW5ncyBhdCBmaXJzdCBpbXBvcnQgb2YgdGhpcyBtb2R1bGUuDQogICAgdHJ5Og0KICAgICAgICB2ZXJpZnlfY29uZmlncyhDT05GSUdfRklMRSkNCiAgICAgICAgdXNlcl9jb25maWcgPSBQeVJldml0Q29uZmlnKGNmZ19maWxlX3BhdGg9Q09ORklHX0ZJTEUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWdfdHlwZT1DT05GSUdfVFlQRSkNCiAgICAgICAgdXBncmFkZS51cGdyYWRlX3VzZXJfY29uZmlnKHVzZXJfY29uZmlnKQ0KICAgICAgICB1c2VyX2NvbmZpZy5zYXZlX2NoYW5nZXMoKQ0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgY2ZnX2VycjoNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnQ2FuIG5vdCByZWFkIGNvbmZpbmcgZmlsZSBhdDogJXMgfCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgQ09ORklHX0ZJTEUsIGNmZ19lcnIpDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ1VzaW5nIGNvbmZpZ3MgaW4gbWVtb3J5Li4uJykNCiAgICAgICAgdXNlcl9jb25maWcgPSB2ZXJpZnlfY29uZmlncygpDQoNCiIiIk1pc2MgSGVscGVyIGZ1bmN0aW9ucyBmb3IgcHlSZXZpdC4NCg0KRXhhbXBsZXM6DQogICAgYGBgcHl0aG9uDQogICAgZnJvbSBweXJldml0IGltcG9ydCBjb3JldXRpbHMNCiAgICBjb3JldXRpbHMuY2xlYW51cF9zdHJpbmcoJ3NvbWUgc3RyaW5nJykNCiAgICBgYGANCiIiIg0KI3B5bGludDogZGlzYWJsZT1pbnZhbGlkLW5hbWUNCmltcG9ydCBvcw0KaW1wb3J0IG9zLnBhdGggYXMgb3ANCmltcG9ydCByZQ0KaW1wb3J0IGFzdA0KaW1wb3J0IGhhc2hsaWINCmltcG9ydCB0aW1lDQppbXBvcnQgZGF0ZXRpbWUNCmltcG9ydCBzaHV0aWwNCmltcG9ydCByYW5kb20NCmltcG9ydCBzdGF0DQppbXBvcnQgY29kZWNzDQppbXBvcnQgbWF0aA0KaW1wb3J0IHNvY2tldA0KZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgZGVmYXVsdGRpY3QNCg0KI3B5bGludDogZGlzYWJsZT1FMDQwMQ0KZnJvbSBweXJldml0IGltcG9ydCBIT1NUX0FQUCwgUHlSZXZpdEV4Y2VwdGlvbg0KZnJvbSBweXJldml0IGltcG9ydCBjb21wYXQNCmZyb20gcHlyZXZpdC5jb21wYXQgaW1wb3J0IFBZMywgUFkyDQpmcm9tIHB5cmV2aXQuY29tcGF0IGltcG9ydCBzYWZlX3N0cnR5cGUNCmZyb20gcHlyZXZpdC5jb21wYXQgaW1wb3J0IHdpbnJlZyBhcyB3cg0KZnJvbSBweXJldml0IGltcG9ydCBmcmFtZXdvcmsNCmZyb20gcHlyZXZpdCBpbXBvcnQgYXBpDQoNCiMgUkU6IGh0dHBzOi8vZ2l0aHViLmNvbS9laXJhbm5lamFkL3B5UmV2aXQvaXNzdWVzLzQxMw0KIyBpbXBvcnQgdXVpZA0KZnJvbSBTeXN0ZW0gaW1wb3J0IEd1aWQNCg0KI3B5bGludDogZGlzYWJsZT1XMDcwMyxDMDMwMg0KREVGQVVMVF9TRVBBUkFUT1IgPSAnOycNCg0KIyBleHRyYWN0ZWQgZnJvbQ0KIyBodHRwczovL3d3dy5maWxlZm9ybWF0LmluZm8vaW5mby91bmljb2RlL2Jsb2NrL2dlbmVyYWxfcHVuY3R1YXRpb24vaW1hZ2VzLmh0bQ0KVU5JQ09ERV9OT05QUklOVEFCTEVfQ0hBUlMgPSBbDQogICAgdSdcdTIwMDAnLCB1J1x1MjAwMScsIHUnXHUyMDAyJywgdSdcdTIwMDMnLCB1J1x1MjAwNCcsIHUnXHUyMDA1JywgdSdcdTIwMDYnLA0KICAgIHUnXHUyMDA3JywgdSdcdTIwMDgnLCB1J1x1MjAwOScsIHUnXHUyMDBBJywgdSdcdTIwMEInLCB1J1x1MjAwQycsIHUnXHUyMDBEJywNCiAgICB1J1x1MjAwRScsIHUnXHUyMDBGJywNCiAgICB1J1x1MjAyOCcsIHUnXHUyMDI5JywgdSdcdTIwMkEnLCB1J1x1MjAyQicsIHUnXHUyMDJDJywgdSdcdTIwMkQnLCB1J1x1MjAyRScsDQogICAgdSdcdTIwMkYnLA0KICAgIHUnXHUyMDVGJywgdSdcdTIwNjAnLA0KICAgIHUnXHUyMDY2JywgdSdcdTIwNjcnLCB1J1x1MjA2OCcsIHUnXHUyMDY5JywgdSdcdTIwNkEnLCB1J1x1MjA2QicsIHUnXHUyMDZDJw0KICAgIHUnXHUyMDZEJywgdSdcdTIwNkUnLCB1J1x1MjA2RicNCiAgICBdDQoNCg0KY2xhc3MgVGltZXIob2JqZWN0KToNCiAgICAiIiJUaW1lciBjbGFzcyB1c2luZyBweXRob24gbmF0aXZlIHRpbWUgbW9kdWxlLg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICB0aW1lciA9IFRpbWVyKCkNCiAgICAgICAgdGltZXIuZ2V0X3RpbWUoKQ0KICAgICAgICBgYGANCiAgICAgICAgMTINCiAgICAiIiINCg0KICAgIGRlZiBfX2luaXRfXyhzZWxmKToNCiAgICAgICAgIiIiSW5pdGlhbGl6ZSBhbmQgU3RhcnQgVGltZXIuIiIiDQogICAgICAgIHNlbGYuc3RhcnQgPSB0aW1lLnRpbWUoKQ0KDQogICAgZGVmIHJlc3RhcnQoc2VsZik6DQogICAgICAgICIiIlJlc3RhcnQgVGltZXIuIiIiDQogICAgICAgIHNlbGYuc3RhcnQgPSB0aW1lLnRpbWUoKQ0KDQogICAgZGVmIGdldF90aW1lKHNlbGYpOg0KICAgICAgICAiIiJHZXQgRWxhcHNlZCBUaW1lLiIiIg0KICAgICAgICByZXR1cm4gdGltZS50aW1lKCkgLSBzZWxmLnN0YXJ0DQoNCg0KY2xhc3MgU2NyaXB0RmlsZVBhcnNlcihvYmplY3QpOg0KICAgICIiIlBhcnNlIHB5dGhvbiBzY3JpcHQgdG8gZXh0cmFjdCB2YXJpYWJsZXMgYW5kIGRvY3N0cmluZ3MuDQoNCiAgICBQcmltYXJpbHkgZGVzaWduZWQgdG8gYXNzaXN0IHB5UmV2aXQgaW4gZGV0ZXJtaW5pbmcgc2NyaXB0IGNvbmZpZ3VyYXRpb25zDQogICAgYnV0IGNhbiB3b3JrIGZvciBhbnkgcHl0aG9uIHNjcmlwdC4NCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZmluZGVyID0gU2NyaXB0RmlsZVBhcnNlcignL3BhdGgvdG8vY29yZXV0aWxzL19faW5pdF9fLnB5JykNCiAgICAgICAgZmluZGVyLmRvY3N0cmluZygpDQogICAgICAgIGBgYA0KICAgICAgICAiTWlzYyBIZWxwZXIgZnVuY3Rpb25zIGZvciBweVJldml0LiINCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZpbmRlci5leHRyYWN0X3BhcmFtKCdTb21lVmFsdWUnLCBbXSkNCiAgICAgICAgYGBgDQogICAgICAgIFtdDQogICAgIiIiDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgZmlsZV9hZGRyZXNzKToNCiAgICAgICAgIiIiSW5pdGlhbGl6ZSBhbmQgcmVhZCBwcm92aWRlZCBweXRob24gc2NyaXB0Lg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBmaWxlX2FkZHJlc3MgKHN0cik6IHB5dGhvbiBzY3JpcHQgZmlsZSBwYXRoDQogICAgICAgICIiIg0KICAgICAgICBzZWxmLmFzdF90cmVlID0gTm9uZQ0KICAgICAgICBzZWxmLmZpbGVfYWRkciA9IGZpbGVfYWRkcmVzcw0KICAgICAgICB3aXRoIGNvZGVjcy5vcGVuKGZpbGVfYWRkcmVzcywgJ3InLCAndXRmLTgnKSBhcyBzb3VyY2VfZmlsZToNCiAgICAgICAgICAgIGNvbnRlbnRzID0gc291cmNlX2ZpbGUucmVhZCgpDQogICAgICAgICAgICBpZiBjb250ZW50czoNCiAgICAgICAgICAgICAgICBzZWxmLmFzdF90cmVlID0gYXN0LnBhcnNlKGNvbnRlbnRzKQ0KDQogICAgZGVmIGV4dHJhY3Rfbm9kZV92YWx1ZShzZWxmLCBub2RlKToNCiAgICAgICAgIiIiTWFudWFsIGV4dHJhY3Rpb24gb2YgdmFsdWVzIGZyb20gbm9kZS4iIiINCiAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuQXNzaWduKToNCiAgICAgICAgICAgIG5vZGVfdmFsdWUgPSBub2RlLnZhbHVlDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBub2RlX3ZhbHVlID0gbm9kZQ0KDQogICAgICAgIGlmIGlzaW5zdGFuY2Uobm9kZV92YWx1ZSwgYXN0Lk51bSk6DQogICAgICAgICAgICByZXR1cm4gbm9kZV92YWx1ZS5uDQogICAgICAgIGVsaWYgUFkyIGFuZCBpc2luc3RhbmNlKG5vZGVfdmFsdWUsIGFzdC5OYW1lKToNCiAgICAgICAgICAgIHJldHVybiBub2RlX3ZhbHVlLmlkDQogICAgICAgIGVsaWYgUFkzIGFuZCBpc2luc3RhbmNlKG5vZGVfdmFsdWUsIGFzdC5OYW1lQ29uc3RhbnQpOg0KICAgICAgICAgICAgcmV0dXJuIG5vZGVfdmFsdWUudmFsdWUNCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKG5vZGVfdmFsdWUsIGFzdC5TdHIpOg0KICAgICAgICAgICAgcmV0dXJuIG5vZGVfdmFsdWUucw0KICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZV92YWx1ZSwgYXN0Lkxpc3QpOg0KICAgICAgICAgICAgcmV0dXJuIG5vZGVfdmFsdWUuZWx0cw0KICAgICAgICBlbGlmIGlzaW5zdGFuY2Uobm9kZV92YWx1ZSwgYXN0LkRpY3QpOg0KICAgICAgICAgICAgcmV0dXJuIHtzZWxmLmV4dHJhY3Rfbm9kZV92YWx1ZShrKTpzZWxmLmV4dHJhY3Rfbm9kZV92YWx1ZSh2KQ0KICAgICAgICAgICAgICAgICAgICBmb3IgaywgdiBpbiB6aXAobm9kZV92YWx1ZS5rZXlzLCBub2RlX3ZhbHVlLnZhbHVlcyl9DQoNCiAgICBkZWYgZ2V0X2RvY3N0cmluZyhzZWxmKToNCiAgICAgICAgIiIiR2V0IGdsb2JhbCBkb2NzdHJpbmcuIiIiDQogICAgICAgIGlmIHNlbGYuYXN0X3RyZWU6DQogICAgICAgICAgICBkb2Nfc3RyID0gYXN0LmdldF9kb2NzdHJpbmcoc2VsZi5hc3RfdHJlZSkNCiAgICAgICAgICAgIGlmIGRvY19zdHI6DQogICAgICAgICAgICAgICAgcmV0dXJuIGRvY19zdHIuZGVjb2RlKCd1dGYtOCcpDQoNCiAgICBkZWYgZXh0cmFjdF9wYXJhbShzZWxmLCBwYXJhbV9uYW1lLCBkZWZhdWx0X3ZhbHVlPU5vbmUpOg0KICAgICAgICAiIiJGaW5kIHZhcmlhYmxlIGFuZCBleHRyYWN0IGl0cyB2YWx1ZS4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgcGFyYW1fbmFtZSAoc3RyKTogdmFyaWFibGUgbmFtZQ0KICAgICAgICAgICAgZGVmYXVsdF92YWx1ZSAoYW55KToNCiAgICAgICAgICAgICAgICBkZWZhdWx0IHZhbHVlIHRvIGJlIHJldHVybmVkIGlmIHZhcmlhYmxlIGRvZXMgbm90IGV4aXN0DQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChBbnkpOiB2YWx1ZSBvZiB0aGUgdmFyaWFibGUgb3IgTm9uZQ0KICAgICAgICAiIiINCiAgICAgICAgaWYgc2VsZi5hc3RfdHJlZToNCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICBmb3Igbm9kZSBpbiBhc3QuaXRlcl9jaGlsZF9ub2RlcyhzZWxmLmFzdF90cmVlKToNCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShub2RlLCBhc3QuQXNzaWduKToNCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciB0YXJnZXQgaW4gbm9kZS50YXJnZXRzOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIodGFyZ2V0LCAnaWQnKSBcDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmQgdGFyZ2V0LmlkID09IHBhcmFtX25hbWU6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhc3QubGl0ZXJhbF9ldmFsKG5vZGUudmFsdWUpDQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGVycjoNCiAgICAgICAgICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKCdFcnJvciBwYXJzaW5nIHBhcmFtZXRlcjoge30gJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2luIHNjcmlwdCBmaWxlIGZvciA6IHt9IHwge30nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KHBhcmFtX25hbWUsIHNlbGYuZmlsZV9hZGRyLCBlcnIpKQ0KICAgICAgICByZXR1cm4gZGVmYXVsdF92YWx1ZQ0KDQoNCmNsYXNzIEZpbGVXYXRjaGVyKG9iamVjdCk6DQogICAgIiIiU2ltcGxlIGZpbGUgdmVyc2lvbiB3YXRjaGVyLg0KDQogICAgVGhpcyBpcyBhIHNpbXBsZSB1dGlsaXR5IGNsYXNzIHRvIGxvb2sgZm9yIGNoYW5nZXMgaW4gYSBmaWxlIGJhc2VkIG9uDQogICAgaXRzIHRpbWVzdGFtcC4NCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGANCiAgICAgICAgd2F0Y2hlciA9IEZpbGVXYXRjaGVyKCcvcGF0aC90by9maWxlLmV4dCcpDQogICAgICAgIHdhdGNoZXIuaGFzX2NoYW5nZWQNCiAgICAgICAgYGBgDQogICAgICAgIFRydWUNCiAgICAiIiINCg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmaWxlcGF0aCk6DQogICAgICAgICIiIkluaXRpYWxpemUgYW5kIHJlYWQgdGltZXN0YW1wIG9mIHByb3ZpZGVkIGZpbGUuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIGZpbGVwYXRoIChzdHIpOiBmaWxlIHBhdGgNCiAgICAgICAgIiIiDQogICAgICAgIHNlbGYuX2NhY2hlZF9zdGFtcCA9IDANCiAgICAgICAgc2VsZi5fZmlsZXBhdGggPSBmaWxlcGF0aA0KICAgICAgICBzZWxmLnVwZGF0ZV90c3RhbXAoKQ0KDQogICAgZGVmIHVwZGF0ZV90c3RhbXAoc2VsZik6DQogICAgICAgICIiIlVwZGF0ZSB0aGUgY2FjaGVkIHRpbWVzdGFtcCBmb3IgbGF0ZXIgY29tcGFyaXNvbi4iIiINCiAgICAgICAgc2VsZi5fY2FjaGVkX3N0YW1wID0gb3Muc3RhdChzZWxmLl9maWxlcGF0aCkuc3RfbXRpbWUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBoYXNfY2hhbmdlZChzZWxmKToNCiAgICAgICAgIiIiQ29tcGFyZSBjdXJyZW50IGZpbGUgdGltZXN0YW1wIHRvIHRoZSBjYWNoZWQgdGltZXN0YW1wLiIiIg0KICAgICAgICByZXR1cm4gb3Muc3RhdChzZWxmLl9maWxlcGF0aCkuc3RfbXRpbWUgIT0gc2VsZi5fY2FjaGVkX3N0YW1wDQoNCg0KY2xhc3MgU2FmZURpY3QoZGljdCk6DQogICAgIiIiRGljdGlvbmFyeSB0aGF0IGRvZXMgbm90IGZhaWwgb24gYW55IGtleS4NCg0KICAgIFRoaXMgaXMgYSBkaWN0aW9uYXJ5IHN1YmNsYXNzIHRvIGhlbHAgd2l0aCBzdHJpbmcgZm9ybWF0dGluZyB3aXRoIHVua25vd24NCiAgICBrZXkgdmFsdWVzLg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBzdHJpbmcgPSAne3RhcmdldH0ge2F0dHJ9IGlzIHtjb2xvcn0uJw0KICAgICAgICBzYWZlZGljdCA9IFNhZmVEaWN0KHsndGFyZ2V0JzogJ0FwcGxlJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2F0dHInOiAgICdDb2xvcid9KQ0KICAgICAgICBzdHJpbmcuZm9ybWF0KHNhZmVkaWN0KSAgIyB3aWxsIG5vdCBmYWlsIHdpdGggbWlzc2luZyAnY29sb3InIGtleQ0KICAgICAgICBgYGANCiAgICAgICAgJ0FwcGxlIENvbG9yIGlzIHtjb2xvcn0uJw0KICAgICIiIg0KDQogICAgZGVmIF9fbWlzc2luZ19fKHNlbGYsIGtleSk6DQogICAgICAgIHJldHVybiAneycgKyBrZXkgKyAnfScNCg0KDQpkZWYgZ2V0X2FsbF9zdWJjbGFzc2VzKHBhcmVudF9jbGFzc2VzKToNCiAgICAiIiJSZXR1cm4gYWxsIHN1YmNsYXNzZXMgb2YgYSBweXRob24gY2xhc3MuDQoNCiAgICBBcmdzOg0KICAgICAgICBwYXJlbnRfY2xhc3NlcyAobGlzdCk6IGxpc3Qgb2YgcHl0aG9uIGNsYXNzZXMNCg0KICAgIFJldHVybnM6DQogICAgICAgIChsaXN0KTogbGlzdCBvZiBweXRob24gc3ViY2xhc3Nlcw0KICAgICIiIg0KICAgIHN1Yl9jbGFzc2VzID0gW10NCiAgICAjIGlmIHN1cGVyLWNsYXNzLCBnZXQgYSBsaXN0IG9mIHN1Yi1jbGFzc2VzLg0KICAgICMgT3RoZXJ3aXNlIHVzZSBjb21wb25lbnRfY2xhc3MgdG8gY3JlYXRlIG9iamVjdHMuDQogICAgZm9yIHBhcmVudF9jbGFzcyBpbiBwYXJlbnRfY2xhc3NlczoNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgZGVyaXZlZF9jbGFzc2VzID0gcGFyZW50X2NsYXNzLl9fc3ViY2xhc3Nlc19fKCkNCiAgICAgICAgICAgIGlmIG5vdCBkZXJpdmVkX2NsYXNzZXM6DQogICAgICAgICAgICAgICAgc3ViX2NsYXNzZXMuYXBwZW5kKHBhcmVudF9jbGFzcykNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgc3ViX2NsYXNzZXMuZXh0ZW5kKGRlcml2ZWRfY2xhc3NlcykNCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOg0KICAgICAgICAgICAgc3ViX2NsYXNzZXMuYXBwZW5kKHBhcmVudF9jbGFzcykNCiAgICByZXR1cm4gc3ViX2NsYXNzZXMNCg0KDQpkZWYgZ2V0X3N1Yl9mb2xkZXJzKHNlYXJjaF9mb2xkZXIpOg0KICAgICIiIkdldCBhIGxpc3Qgb2YgYWxsIHN1YmZvbGRlcnMgZGlyZWN0bHkgaW5zaWRlIHByb3ZpZGVkIGZvbGRlci4NCg0KICAgIEFyZ3M6DQogICAgICAgIHNlYXJjaF9mb2xkZXIgKHN0cik6IGZvbGRlciBwYXRoDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtzdHJdKTogbGlzdCBvZiBzdWJmb2xkZXIgbmFtZXMNCiAgICAiIiINCiAgICBzdWJfZm9sZGVycyA9IFtdDQogICAgZm9yIHN1Yl9mb2xkZXIgaW4gb3MubGlzdGRpcihzZWFyY2hfZm9sZGVyKToNCiAgICAgICAgaWYgb3AuaXNkaXIob3Auam9pbihzZWFyY2hfZm9sZGVyLCBzdWJfZm9sZGVyKSk6DQogICAgICAgICAgICBzdWJfZm9sZGVycy5hcHBlbmQoc3ViX2ZvbGRlcikNCiAgICByZXR1cm4gc3ViX2ZvbGRlcnMNCg0KDQpkZWYgdmVyaWZ5X2RpcmVjdG9yeShmb2xkZXIpOg0KICAgICIiIkNoZWNrIGlmIHRoZSBmb2xkZXIgZXhpc3RzIGFuZCBpZiBub3QgY3JlYXRlIHRoZSBmb2xkZXIuDQoNCiAgICBBcmdzOg0KICAgICAgICBmb2xkZXIgKHN0cik6IHBhdGggb2YgZm9sZGVyIHRvIHZlcmlmeQ0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IHBhdGggb2YgdmVyaWZpZWQgZm9sZGVyLCBlcXVhbHMgdG8gcHJvdmlkZWQgZm9sZGVyDQoNCiAgICBSYWlzZXM6DQogICAgICAgIE9TRXJyb3I6IG9uIGZvbGRlciBjcmVhdGlvbiBlcnJvci4NCiAgICAiIiINCiAgICBpZiBub3Qgb3AuZXhpc3RzKGZvbGRlcik6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgIG9zLm1ha2VkaXJzKGZvbGRlcikNCiAgICAgICAgZXhjZXB0IE9TRXJyb3IgYXMgZXJyOg0KICAgICAgICAgICAgcmFpc2UgZXJyDQogICAgcmV0dXJuIGZvbGRlcg0KDQoNCmRlZiBqb2luX3N0cmluZ3Moc3RyX2xpc3QsIHNlcGFyYXRvcj1ERUZBVUxUX1NFUEFSQVRPUik6DQogICAgIiIiSm9pbiBzdHJpbmdzIHVzaW5nIHByb3ZpZGVkIHNlcGFyYXRvci4NCg0KICAgIEFyZ3M6DQogICAgICAgIHN0cl9saXN0IChsaXN0KTogbGlzdCBvZiBzdHJpbmcgdmFsdWVzDQogICAgICAgIHNlcGFyYXRvciAoc3RyKTogc2luZ2xlIHNlcGFyYXRvciBjaGFyYWN0ZXIsDQogICAgICAgICAgICBkZWZhdWx0cyB0byBERUZBVUxUX1NFUEFSQVRPUg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IGpvaW5lZCBzdHJpbmcNCiAgICAiIiINCiAgICBpZiBzdHJfbGlzdDoNCiAgICAgICAgaWYgYW55KG5vdCBpc2luc3RhbmNlKHgsIHN0cikgZm9yIHggaW4gc3RyX2xpc3QpOg0KICAgICAgICAgICAgc3RyX2xpc3QgPSBbc3RyKHgpIGZvciB4IGluIHN0cl9saXN0XQ0KICAgICAgICByZXR1cm4gc2VwYXJhdG9yLmpvaW4oc3RyX2xpc3QpDQogICAgcmV0dXJuICcnDQoNCg0KIyBjaGFyYWN0ZXIgcmVwbGFjZW1lbnQgbGlzdCBmb3IgY2xlYW5pbmcgdXAgZmlsZSBuYW1lcw0KU1BFQ0lBTF9DSEFSUyA9IHsnICc6ICcnLA0KICAgICAgICAgICAgICAgICAnfic6ICcnLA0KICAgICAgICAgICAgICAgICAnISc6ICdFWENMQU0nLA0KICAgICAgICAgICAgICAgICAnQCc6ICdBVCcsDQogICAgICAgICAgICAgICAgICcjJzogJ1NIQVJQJywNCiAgICAgICAgICAgICAgICAgJyQnOiAnRE9MTEFSJywNCiAgICAgICAgICAgICAgICAgJyUnOiAnUEVSQ0VOVCcsDQogICAgICAgICAgICAgICAgICdeJzogJycsDQogICAgICAgICAgICAgICAgICcmJzogJ0FORCcsDQogICAgICAgICAgICAgICAgICcqJzogJ1NUQVInLA0KICAgICAgICAgICAgICAgICAnKyc6ICdQTFVTJywNCiAgICAgICAgICAgICAgICAgJzsnOiAnJywgJzonOiAnJywgJywnOiAnJywgJ1wiJzogJycsDQogICAgICAgICAgICAgICAgICd7JzogJycsICd9JzogJycsICdbJzogJycsICddJzogJycsIHInXCgnOiAnJywgcidcKSc6ICcnLA0KICAgICAgICAgICAgICAgICAnLSc6ICdNSU5VUycsDQogICAgICAgICAgICAgICAgICc9JzogJ0VRVUFMUycsDQogICAgICAgICAgICAgICAgICc8JzogJycsICc+JzogJycsDQogICAgICAgICAgICAgICAgICc/JzogJ1FNQVJLJywNCiAgICAgICAgICAgICAgICAgJy4nOiAnRE9UJywNCiAgICAgICAgICAgICAgICAgJ18nOiAnVU5ERVJTJywNCiAgICAgICAgICAgICAgICAgJ3wnOiAnVkVSVCcsDQogICAgICAgICAgICAgICAgIHInXC8nOiAnJywgJ1xcJzogJyd9DQoNCg0KZGVmIGNsZWFudXBfc3RyaW5nKGlucHV0X3N0ciwgc2tpcD1Ob25lKToNCiAgICAiIiJSZXBsYWNlIHNwZWNpYWwgY2hhcmFjdGVycyBpbiBzdHJpbmcgd2l0aCBhbm90aGVyIHN0cmluZy4NCg0KICAgIFRoaXMgZnVuY3Rpb24gd2FzIGNyZWF0ZWQgdG8gaGVscCBjbGVhbnVwIHB5UmV2aXQgY29tbWFuZCB1bmlxdWUgbmFtZXMgZnJvbQ0KICAgIGFueSBzcGVjaWFsIGNoYXJhY3RlcnMgc28gQyMgY2xhc3MgbmFtZXMgY2FuIGJlIGNyZWF0ZWQgYmFzZWQgb24gdGhvc2UNCiAgICB1bmlxdWUgbmFtZXMuDQoNCiAgICBgYGNvcmV1dGlscy5TUEVDSUFMX0NIQVJTYGAgaXMgdGhlIGNvbnZlcnNpb24gdGFibGUgZm9yIHRoaXMgZnVuY3Rpb24uDQoNCiAgICBBcmdzOg0KICAgICAgICBpbnB1dF9zdHIgKHN0cik6IGlucHV0IHN0cmluZyB0byBiZSBjbGVhbmVkDQogICAgICAgIHNraXAgKENvbnRhaW5lcltzdHJdKTogc3BlY2lhbCBjaGFyYWN0ZXJzIHRvIGtlZXANCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgc3JjX3N0ciA9ICdURVNUQFNvbWUqPHZhbHVlPicNCiAgICAgICAgY2xlYW51cF9zdHJpbmcoc3JjX3N0cikNCiAgICAgICAgYGBgDQogICAgICAgICJURVNUQVRTb21lU1RBUnZhbHVlIg0KICAgICIiIg0KICAgICMgcmVtb3ZlIHNwYWNlcyBhbmQgc3BlY2lhbCBjaGFyYWN0ZXJzIGZyb20gc3RyaW5ncw0KICAgIGZvciBjaGFyLCByZXBsIGluIFNQRUNJQUxfQ0hBUlMuaXRlbXMoKToNCiAgICAgICAgaWYgc2tpcCBhbmQgY2hhciBpbiBza2lwOg0KICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgaW5wdXRfc3RyID0gaW5wdXRfc3RyLnJlcGxhY2UoY2hhciwgcmVwbCkNCg0KICAgIHJldHVybiBpbnB1dF9zdHINCg0KDQpkZWYgZ2V0X3Jldml0X2luc3RhbmNlX2NvdW50KCk6DQogICAgIiIiUmV0dXJuIG51bWJlciBvZiBvcGVuIGhvc3QgYXBwIGluc3RhbmNlcy4NCg0KICAgIFJldHVybnM6DQogICAgICAgIChpbnQpOiBudW1iZXIgb2Ygb3BlbiBob3N0IGFwcCBpbnN0YW5jZXMuDQogICAgIiIiDQogICAgcmV0dXJuIGxlbihsaXN0KGZyYW1ld29yay5Qcm9jZXNzLkdldFByb2Nlc3Nlc0J5TmFtZShIT1NUX0FQUC5wcm9jX25hbWUpKSkNCg0KDQpkZWYgcnVuX3Byb2Nlc3MocHJvYywgY3dkPSdDOicpOg0KICAgICIiIlJ1biBzaGVsbCBwcm9jZXNzIHNpbGVudGx5Lg0KDQogICAgQXJnczoNCiAgICAgICAgcHJvYyAoc3RyKTogcHJvY2VzcyBleGVjdXRpdmUgbmFtZQ0KICAgICAgICBjd2QgKHN0cik6IGN1cnJlbnQgd29ya2luZyBkaXJlY3RvcnkNCg0KICAgIEV4bWFwbGU6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBydW5fcHJvY2Vzcygnbm90ZXBhZC5leGUnLCAnYzovJykNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgaW1wb3J0IHN1YnByb2Nlc3MNCiAgICByZXR1cm4gc3VicHJvY2Vzcy5Qb3Blbihwcm9jLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3dkPWN3ZCwgc2hlbGw9VHJ1ZSkNCg0KDQpkZWYgaW5zcGVjdF9jYWxsaW5nX3Njb3BlX2xvY2FsX3Zhcih2YXJpYWJsZV9uYW1lKToNCiAgICAiIiJUcmFjZSBiYWNrIHRoZSBzdGFjayB0byBmaW5kIHRoZSB2YXJpYWJsZSBpbiB0aGUgY2FsbGVyIGxvY2FsIHN0YWNrLg0KDQogICAgUHlSZXZpdExvYWRlciBkZWZpbmVzIF9fcmV2aXRfXyBpbiBidWlsdGlucyBhbmQgX193aW5kb3dfXyBpbiBsb2NhbHMuDQogICAgVGh1cywgbW9kdWxlcyBoYXZlIGFjY2VzcyB0byBfX3Jldml0X18gYnV0IG5vdCB0byBfX3dpbmRvd19fLg0KICAgIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBmaW5kIF9fd2luZG93X18gaW4gdGhlIGNhbGxlciBzdGFjay4NCg0KICAgIEFyZ3M6DQogICAgICAgIHZhcmlhYmxlX25hbWUgKHN0cik6IHZhcmlhYmxlIG5hbWUgdG8gbG9vayB1cCBpbiBjYWxsZXIgbG9jYWwgc2NvcGUNCiAgICAiIiINCiAgICBpbXBvcnQgaW5zcGVjdA0KDQogICAgZnJhbWUgPSBpbnNwZWN0LnN0YWNrKClbMV1bMF0NCiAgICB3aGlsZSB2YXJpYWJsZV9uYW1lIG5vdCBpbiBmcmFtZS5mX2xvY2FsczoNCiAgICAgICAgZnJhbWUgPSBmcmFtZS5mX2JhY2sNCiAgICAgICAgaWYgZnJhbWUgaXMgTm9uZToNCiAgICAgICAgICAgIHJldHVybiBOb25lDQogICAgcmV0dXJuIGZyYW1lLmZfbG9jYWxzW3ZhcmlhYmxlX25hbWVdDQoNCg0KZGVmIGluc3BlY3RfY2FsbGluZ19zY29wZV9nbG9iYWxfdmFyKHZhcmlhYmxlX25hbWUpOg0KICAgICIiIlRyYWNlIGJhY2sgdGhlIHN0YWNrIHRvIGZpbmQgdGhlIHZhcmlhYmxlIGluIHRoZSBjYWxsZXIgZ2xvYmFsIHN0YWNrLg0KDQogICAgQXJnczoNCiAgICAgICAgdmFyaWFibGVfbmFtZSAoc3RyKTogdmFyaWFibGUgbmFtZSB0byBsb29rIHVwIGluIGNhbGxlciBnbG9iYWwgc2NvcGUNCiAgICAiIiINCiAgICBpbXBvcnQgaW5zcGVjdA0KDQogICAgZnJhbWUgPSBpbnNwZWN0LnN0YWNrKClbMV1bMF0NCiAgICB3aGlsZSB2YXJpYWJsZV9uYW1lIG5vdCBpbiBmcmFtZS5mX2dsb2JhbHM6DQogICAgICAgIGZyYW1lID0gZnJhbWUuZl9iYWNrDQogICAgICAgIGlmIGZyYW1lIGlzIE5vbmU6DQogICAgICAgICAgICByZXR1cm4gTm9uZQ0KICAgIHJldHVybiBmcmFtZS5mX2xvY2Fsc1t2YXJpYWJsZV9uYW1lXQ0KDQoNCmRlZiBtYWtlX2Nhbm9uaWNhbF9uYW1lKCphcmdzKToNCiAgICAiIiJKb2luIGFyZ3VtZW50cyB3aXRoIGRvdCBjcmVhdGluZyBhIHVuaXF1ZSBpZC4NCg0KICAgIEFyZ3M6DQogICAgICAgICphcmdzIChzdHIpOiBWYXJpYWJsZSBsZW5ndGggYXJndW1lbnQgbGlzdA0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IGRvdCBzZXBhcmF0ZWQgdW5pcXVlIG5hbWUNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgbWFrZV9jYW5vbmljYWxfbmFtZSgnc29tZW5hbWUnLCAnc29tZWlkJywgJ3R4dCcpDQogICAgICAgIGBgYA0KICAgICAgICAic29tZW5hbWUuc29tZWlkLnR4dCINCiAgICAiIiINCiAgICByZXR1cm4gJy4nLmpvaW4oYXJncykNCg0KDQpkZWYgZ2V0X2Nhbm9uaWNhbF9wYXJ0cyhjYW5vbmljYWxfc3RyaW5nKToNCiAgICAiIiJTcGxvdHMgYXJndW1lbnQgdXNpbmcgZG90LCByZXR1cm5pbmcgYWxsIGNvbXBvc2luZyBwYXJ0cy4NCg0KICAgIEFyZ3M6DQogICAgICAgIGNhbm9uaWNhbF9zdHJpbmcgKHN0cik6IFNvdXJjZSBzdHJpbmcgZS5nLiAiQ29uZmlnLlN1YkNvbmZpZyINCg0KICAgIFJldHVybnM6DQogICAgICAgIChsaXN0W3N0cl0pOiBsaXN0IG9mIGNvbXBvc2luZyBwYXJ0cw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBnZXRfY2Fub25pY2FsX3BhcnRzKCJDb25maWcuU3ViQ29uZmlnIikNCiAgICAgICAgYGBgDQogICAgICAgIFsnQ29uZmlnJywgJ1N1YkNvbmZpZyddDQogICAgIiIiDQogICAgcmV0dXJuIGNhbm9uaWNhbF9zdHJpbmcuc3BsaXQoJy4nKQ0KDQoNCmRlZiBnZXRfZmlsZV9uYW1lKGZpbGVfcGF0aCk6DQogICAgIiIiUmV0dXJuIGZpbGUgYmFzZW5hbWUgb2YgdGhlIGdpdmVuIGZpbGUuDQoNCiAgICBBcmdzOg0KICAgICAgICBmaWxlX3BhdGggKHN0cik6IGZpbGUgcGF0aA0KICAgICIiIg0KICAgIHJldHVybiBvcC5zcGxpdGV4dChvcC5iYXNlbmFtZShmaWxlX3BhdGgpKVswXQ0KDQoNCmRlZiBnZXRfc3RyX2hhc2goc291cmNlX3N0cik6DQogICAgIiIiQ2FsY3VsYXRlIGhhc2ggdmFsdWUgb2YgZ2l2ZW4gc3RyaW5nLg0KDQogICAgQ3VycmVudCBpbXBsZW1lbnRhdGlvbiB1c2VzIDpmdW5jOmBoYXNobGliLm1kNWAgaGFzaCBmdW5jdGlvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIHNvdXJjZV9zdHIgKHN0cik6IHNvdXJjZSBzdHINCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIpOiBoYXNoIHZhbHVlIGFzIHN0cmluZw0KICAgICIiIg0KICAgIHJldHVybiBoYXNobGliLm1kNShzb3VyY2Vfc3RyLmVuY29kZSgndXRmLTgnLCAnaWdub3JlJykpLmhleGRpZ2VzdCgpDQoNCg0KZGVmIGNhbGN1bGF0ZV9kaXJfaGFzaChkaXJfcGF0aCwgZGlyX2ZpbHRlciwgZmlsZV9maWx0ZXIpOg0KICAgIHIiIiJDcmVhdGUgYSB1bmlxdWUgaGFzaCB0byByZXByZXNlbnQgc3RhdGUgb2YgZGlyZWN0b3J5Lg0KDQogICAgQXJnczoNCiAgICAgICAgZGlyX3BhdGggKHN0cik6IHRhcmdldCBkaXJlY3RvcnkNCiAgICAgICAgZGlyX2ZpbHRlciAoc3RyKTogZXhjbHVkZSBkaXJlY3RvcmllcyBtYXRjaGluZyB0aGlzIHJlZ2V4DQogICAgICAgIGZpbGVfZmlsdGVyIChzdHIpOiBleGNsdWRlIGZpbGVzIG1hdGNoaW5nIHRoaXMgcmVnZXgNCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIpOiBoYXNoIHZhbHVlIGFzIHN0cmluZw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBjYWxjdWxhdGVfZGlyX2hhc2goc291cmNlX3BhdGgsICdcLmV4dGVuc2lvbicsICdcLmpzb24nKQ0KICAgICAgICBgYGANCiAgICAgICAgIjFhODg1YTBjYWU5OWY1M2Q2MDg4YjlmN2NlZTNiZjRkIg0KICAgICIiIg0KICAgIG10aW1lX3N1bSA9IDANCiAgICBmb3Igcm9vdCwgZGlycywgZmlsZXMgaW4gb3Mud2FsayhkaXJfcGF0aCk6ICNweWxpbnQ6IGRpc2FibGU9VzA2MTINCiAgICAgICAgaWYgcmUuc2VhcmNoKGRpcl9maWx0ZXIsIG9wLmJhc2VuYW1lKHJvb3QpLCBmbGFncz1yZS5JR05PUkVDQVNFKToNCiAgICAgICAgICAgIG10aW1lX3N1bSArPSBvcC5nZXRtdGltZShyb290KQ0KICAgICAgICAgICAgZm9yIGZpbGVuYW1lIGluIGZpbGVzOg0KICAgICAgICAgICAgICAgIGlmIHJlLnNlYXJjaChmaWxlX2ZpbHRlciwgZmlsZW5hbWUsIGZsYWdzPXJlLklHTk9SRUNBU0UpOg0KICAgICAgICAgICAgICAgICAgICBtb2R0aW1lID0gb3AuZ2V0bXRpbWUob3Auam9pbihyb290LCBmaWxlbmFtZSkpDQogICAgICAgICAgICAgICAgICAgIG10aW1lX3N1bSArPSBtb2R0aW1lDQogICAgcmV0dXJuIGdldF9zdHJfaGFzaChzYWZlX3N0cnR5cGUobXRpbWVfc3VtKSkNCg0KDQpkZWYgcHJlcGFyZV9odG1sX3N0cihpbnB1dF9zdHJpbmcpOg0KICAgICIiIlJlZm9ybWF0IGh0bWwgc3RyaW5nIGFuZCBwcmVwYXJlIGZvciBweVJldml0IG91dHB1dCB3aW5kb3cuDQoNCiAgICBweVJldml0IG91dHB1dCB3aW5kb3cgcmVuZGVycyBodG1sIGNvbnRlbnQuIEJ1dCB0aGlzIG1lYW5zIHRoYXQgPCBhbmQgPg0KICAgIGNoYXJhY3RlcnMgaW4gb3V0cHV0cyBmcm9tIHB5dGhvbiAoZS5nLiA8Y2xhc3MgYXQgeHh4Pikgd2lsbCBiZSB0cmVhdGVkDQogICAgYXMgaHRtbCB0YWdzLiBUbyBhdm9pZCB0aGlzLCBhbGwgPD4gY2hhcmFjdGVycyB0aGF0IGFyZSBkZWZpbmluZw0KICAgIGh0bWwgY29udGVudCBuZWVkIHRvIGJlIHJlcGxhY2VkIHdpdGggc3BlY2lhbCBwaHJhc2VzLiBweVJldml0IG91dHB1dA0KICAgIGxhdGVyIHRyYW5zbGF0ZXMgdGhlc2UgcGhyYXNlcyBiYWNrIGluIHRvIDwgYW5kID4uIFRoYXQgaXMgaG93IHB5UmV2aXQNCiAgICBkaXN0aW5xdWlzaGVzIGJldHdlZW4gPD4gcHJpbnRlZCBmcm9tIHB5dGhvbiBhbmQgPD4gdGhhdCBkZWZpbmUgaHRtbC4NCg0KICAgIEFyZ3M6DQogICAgICAgIGlucHV0X3N0cmluZyAoc3RyKTogaW5wdXQgaHRtbCBzdHJpbmcNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgcHJlcGFyZV9odG1sX3N0cignPHA+U29tZSB0ZXh0PC9wPicpDQogICAgICAgIGBgYA0KICAgICAgICAiJmNsdDtwJmNndDtTb21lIHRleHQmY2x0Oy9wJmNndDsiDQogICAgIiIiDQogICAgcmV0dXJuIGlucHV0X3N0cmluZy5yZXBsYWNlKCc8JywgJyZjbHQ7JykucmVwbGFjZSgnPicsICcmY2d0OycpDQoNCg0KZGVmIHJldmVyc2VfaHRtbChpbnB1dF9odG1sKToNCiAgICAiIiJSZWZvcm1hdCBjb2RpZmllZCBweVJldml0IG91dHB1dCBodG1sIHN0cmluZyBiYWNrIHRvIG5vcm1hbCBodG1sLg0KDQogICAgcHlSZXZpdCBvdXRwdXQgd2luZG93IHJlbmRlcnMgaHRtbCBjb250ZW50LiBCdXQgdGhpcyBtZWFucyB0aGF0IDwgYW5kID4NCiAgICBjaGFyYWN0ZXJzIGluIG91dHB1dHMgZnJvbSBweXRob24gKGUuZy4gPGNsYXNzIGF0IHh4eD4pIHdpbGwgYmUgdHJlYXRlZA0KICAgIGFzIGh0bWwgdGFncy4gVG8gYXZvaWQgdGhpcywgYWxsIDw+IGNoYXJhY3RlcnMgdGhhdCBhcmUgZGVmaW5pbmcNCiAgICBodG1sIGNvbnRlbnQgbmVlZCB0byBiZSByZXBsYWNlZCB3aXRoIHNwZWNpYWwgcGhyYXNlcy4gcHlSZXZpdCBvdXRwdXQNCiAgICBsYXRlciB0cmFuc2xhdGVzIHRoZXNlIHBocmFzZXMgYmFjayBpbiB0byA8IGFuZCA+LiBUaGF0IGlzIGhvdyBweVJldml0DQogICAgZGlzdGlucXVpc2hlcyBiZXR3ZWVuIDw+IHByaW50ZWQgZnJvbSBweXRob24gYW5kIDw+IHRoYXQgZGVmaW5lIGh0bWwuDQoNCiAgICBBcmdzOg0KICAgICAgICBpbnB1dF9odG1sIChzdHIpOiBpbnB1dCBjb2RpZmllZCBodG1sIHN0cmluZw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBwcmVwYXJlX2h0bWxfc3RyKCcmY2x0O3AmY2d0O1NvbWUgdGV4dCZjbHQ7L3AmY2d0OycpDQogICAgICAgIGBgYA0KICAgICAgICAiPHA+U29tZSB0ZXh0PC9wPiINCiAgICAiIiINCiAgICByZXR1cm4gaW5wdXRfaHRtbC5yZXBsYWNlKCcmY2x0OycsICc8JykucmVwbGFjZSgnJmNndDsnLCAnPicpDQoNCg0KZGVmIGVzY2FwZV9mb3JfaHRtbChpbnB1dF9zdHJpbmcpOg0KICAgIHJldHVybiBpbnB1dF9zdHJpbmcucmVwbGFjZSgnPCcsICcmbHQ7JykucmVwbGFjZSgnPicsICcmZ3Q7JykNCg0KDQojIGRlZiBjaGVja19pbnRlcm5ldF9jb25uZWN0aW9uKCk6DQogICAgIyBpbXBvcnQgdXJsbGliMg0KICAgICMNCiAgICAjIGRlZiBpbnRlcm5ldF9vbigpOg0KICAgICMgICAgIHRyeToNCiAgICAjICAgICAgICAgdXJsbGliMi51cmxvcGVuKCdodHRwOi8vMjE2LjU4LjE5Mi4xNDInLCB0aW1lb3V0PTEpDQogICAgIyAgICAgICAgIHJldHVybiBUcnVlDQogICAgIyAgICAgZXhjZXB0IHVybGxpYjIuVVJMRXJyb3IgYXMgZXJyOg0KICAgICMgICAgICAgICByZXR1cm4gRmFsc2UNCg0KDQpkZWYgY2FuX2FjY2Vzc191cmwodXJsX3RvX29wZW4sIHRpbWVvdXQ9MTAwMCk6DQogICAgIiIiQ2hlY2sgaWYgdXJsIGlzIGFjY2Vzc2libGUgd2l0aGluIHRpbWVvdXQuDQoNCiAgICBBcmdzOg0KICAgICAgICB1cmxfdG9fb3BlbiAoc3RyKTogdXJsIHRvIGNoZWNrIGFjY2VzcyBmb3INCiAgICAgICAgdGltZW91dCAoaW50KTogdGltZW91dCBpbiBtaWxsaXNlY29uZHMNCg0KICAgIFJldHVybnM6DQogICAgICAgIChib29sKTogdHJ1ZSBpZiBhY2Nlc3NpYmxlDQogICAgIiIiDQogICAgdHJ5Og0KICAgICAgICBjbGllbnQgPSBmcmFtZXdvcmsuV2ViUmVxdWVzdC5DcmVhdGUodXJsX3RvX29wZW4pDQogICAgICAgIGNsaWVudC5NZXRob2QgPSAiSEVBRCINCiAgICAgICAgY2xpZW50LlRpbWVvdXQgPSB0aW1lb3V0DQogICAgICAgIGNsaWVudC5Qcm94eSA9IGZyYW1ld29yay5XZWJQcm94eS5HZXREZWZhdWx0UHJveHkoKQ0KICAgICAgICByZXNwb25zZSA9IGNsaWVudC5HZXRSZXNwb25zZSgpDQogICAgICAgIHJlc3BvbnNlLkdldFJlc3BvbnNlU3RyZWFtKCkNCiAgICAgICAgcmV0dXJuIFRydWUNCiAgICBleGNlcHQgRXhjZXB0aW9uOg0KICAgICAgICByZXR1cm4gRmFsc2UNCg0KDQpkZWYgcmVhZF91cmwodXJsX3RvX29wZW4pOg0KICAgICIiIkdldCB0aGUgdXJsIGFuZCByZXR1cm4gcmVzcG9uc2UuDQoNCiAgICBBcmdzOg0KICAgICAgICB1cmxfdG9fb3BlbiAoc3RyKTogdXJsIHRvIGNoZWNrIGFjY2VzcyBmb3INCiAgICAiIiINCiAgICBjbGllbnQgPSBmcmFtZXdvcmsuV2ViQ2xpZW50KCkNCiAgICByZXR1cm4gY2xpZW50LkRvd25sb2FkU3RyaW5nKHVybF90b19vcGVuKQ0KDQoNCmRlZiBjaGVja19pbnRlcm5ldF9jb25uZWN0aW9uKHRpbWVvdXQ9MTAwMCk6DQogICAgIiIiQ2hlY2sgaWYgaW50ZXJuZXQgY29ubmVjdGlvbiBpcyBhdmFpbGFibGUuDQoNCiAgICBQaW5ncyBhIGZldyB3ZWxsLWtub3duIHdlYnNpdGVzIHRvIGNoZWNrIGlmIGludGVybmV0IGNvbm5lY3Rpb24gaXMgcHJlc2VudC4NCg0KICAgIEFyZ3M6DQogICAgICAgIHRpbWVvdXQgKGludCk6IHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogdXJsIGlmIGludGVybmV0IGNvbm5lY3Rpb24gaXMgcHJlc2VudCwgTm9uZSBpZiBubyBpbnRlcm5ldC4NCiAgICAiIiINCiAgICBzb2xpZF91cmxzID0gWyJodHRwOi8vZ29vZ2xlLmNvbS8iLA0KICAgICAgICAgICAgICAgICAgImh0dHA6Ly9naXRodWIuY29tLyIsDQogICAgICAgICAgICAgICAgICAiaHR0cDovL2JpdGJ1Y2tldC5jb20vIiwNCiAgICAgICAgICAgICAgICAgICJodHRwOi8vYWlydGFibGUuY29tLyIsDQogICAgICAgICAgICAgICAgICAiaHR0cDovL3RvZG9pc3QuY29tLyIsDQogICAgICAgICAgICAgICAgICAiaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tLyIsDQogICAgICAgICAgICAgICAgICAiaHR0cDovL3R3aXR0ZXIuY29tLyIsDQogICAgICAgICAgICAgICAgICAiaHR0cDovL3lvdXR1YmUuY29tLyJdDQogICAgcmFuZG9tLnNodWZmbGUoc29saWRfdXJscykNCiAgICBmb3IgdXJsIGluIHNvbGlkX3VybHM6DQogICAgICAgIGlmIGNhbl9hY2Nlc3NfdXJsKHVybCwgdGltZW91dCk6DQogICAgICAgICAgICByZXR1cm4gdXJsDQoNCiAgICByZXR1cm4gTm9uZQ0KDQoNCmRlZiB0b3VjaChmbmFtZSwgdGltZXM9Tm9uZSk6DQogICAgIiIiVXBkYXRlIHRoZSB0aW1lc3RhbXAgb24gdGhlIGdpdmVuIGZpbGUuDQoNCiAgICBBcmdzOg0KICAgICAgICBmbmFtZSAoc3RyKTogdGFyZ2V0IGZpbGUgcGF0aA0KICAgICAgICB0aW1lcyAoaW50KTogbnVtYmVyIG9mIHRpbWVzIHRvIHRvdWNoIHRoZSBmaWxlDQogICAgIiIiDQogICAgd2l0aCBvcGVuKGZuYW1lLCAnYScpOg0KICAgICAgICBvcy51dGltZShmbmFtZSwgdGltZXMpDQoNCg0KZGVmIHJlYWRfc291cmNlX2ZpbGUoc291cmNlX2ZpbGVfcGF0aCk6DQogICAgIiIiUmVhZCB0ZXh0IGZpbGUgYW5kIHJldHVybiBjb250ZW50cy4NCg0KICAgIEFyZ3M6DQogICAgICAgIHNvdXJjZV9maWxlX3BhdGggKHN0cik6IHRhcmdldCBmaWxlIHBhdGgNCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIpOiBmaWxlIGNvbnRlbnRzDQoNCiAgICBSYWlzZXM6DQogICAgICAgIFB5UmV2aXRFeGNlcHRpb246IG9uIHJlYWQgZXJyb3INCiAgICAiIiINCiAgICB0cnk6DQogICAgICAgIHdpdGggb3Blbihzb3VyY2VfZmlsZV9wYXRoLCAncicpIGFzIGNvZGVfZmlsZToNCiAgICAgICAgICAgIHJldHVybiBjb2RlX2ZpbGUucmVhZCgpDQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyByZWFkX2VycjoNCiAgICAgICAgcmFpc2UgUHlSZXZpdEV4Y2VwdGlvbignRXJyb3IgcmVhZGluZyBzb3VyY2UgZmlsZToge30gfCB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KHNvdXJjZV9maWxlX3BhdGgsIHJlYWRfZXJyKSkNCg0KDQpkZWYgb3Blbl9mb2xkZXJfaW5fZXhwbG9yZXIoZm9sZGVyX3BhdGgpOg0KICAgICIiIk9wZW4gZ2l2ZW4gZm9sZGVyIGluIFdpbmRvd3MgRXhwbG9yZXIuDQoNCiAgICBBcmdzOg0KICAgICAgICBmb2xkZXJfcGF0aCAoc3RyKTogZGlyZWN0b3J5IHBhdGgNCiAgICAiIiINCiAgICBpbXBvcnQgc3VicHJvY2Vzcw0KICAgIHN1YnByb2Nlc3MuUG9wZW4ocidleHBsb3JlciAvb3Blbiwie30iJw0KICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChvcy5wYXRoLm5vcm1wYXRoKGZvbGRlcl9wYXRoKSkpDQoNCg0KZGVmIHNob3dfZW50cnlfaW5fZXhwbG9yZXIoZW50cnlfcGF0aCk6DQogICAgIiIiU2hvdyBnaXZlbiBlbnRyeSBpbiBXaW5kb3dzIEV4cGxvcmVyLg0KDQogICAgQXJnczoNCiAgICAgICAgZW50cnlfcGF0aCAoc3RyKTogZGlyZWN0b3J5IG9yIGZpbGUgcGF0aA0KICAgICIiIg0KICAgIGltcG9ydCBzdWJwcm9jZXNzDQogICAgc3VicHJvY2Vzcy5Qb3BlbihyJ2V4cGxvcmVyIC9zZWxlY3QsInt9IicNCiAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQob3MucGF0aC5ub3JtcGF0aChlbnRyeV9wYXRoKSkpDQoNCg0KZGVmIGZ1bGx5X3JlbW92ZV9kaXIoZGlyX3BhdGgpOg0KICAgICIiIlJlbW92ZSBkaXJlY3RvcnkgcmVjdXJzaXZlbHkuDQoNCiAgICBBcmdzOg0KICAgICAgICBkaXJfcGF0aCAoc3RyKTogZGlyZWN0b3J5IHBhdGgNCiAgICAiIiINCiAgICBkZWYgZGVsX3J3KGFjdGlvbiwgbmFtZSwgZXhjKTogICAjcHlsaW50OiBkaXNhYmxlPVcwNjEzDQogICAgICAgICIiIkZvcmNlIGRlbGV0ZSBlbnRyeS4iIiINCiAgICAgICAgb3MuY2htb2QobmFtZSwgc3RhdC5TX0lXUklURSkNCiAgICAgICAgb3MucmVtb3ZlKG5hbWUpDQoNCiAgICBzaHV0aWwucm10cmVlKGRpcl9wYXRoLCBvbmVycm9yPWRlbF9ydykNCg0KDQpkZWYgY2xlYW51cF9maWxlbmFtZShmaWxlX25hbWUsIHdpbmRvd3Nfc2FmZT1GYWxzZSk6DQogICAgIiIiQ2xlYW51cCBmaWxlIG5hbWUgZnJvbSBzcGVjaWFsIGNoYXJhY3RlcnMuDQoNCiAgICBBcmdzOg0KICAgICAgICBmaWxlX25hbWUgKHN0cik6IGZpbGUgbmFtZQ0KICAgICAgICB3aW5kb3dzX3NhZmUgKGJvb2wpOiB3aGV0aGVyIHRvIHVzZSB3aW5kb3dzIHNhZmUgY2hhcmFjdGVycw0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IGNsZWFuZWQgdXAgZmlsZSBuYW1lDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGNsZWFudXBfZmlsZW5hbWUoJ015ZmlsZS0oMykudHh0JykNCiAgICAgICAgYGBgDQogICAgICAgICJNeWZpbGUoMykudHh0Ig0KDQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBjbGVhbnVwX2ZpbGVuYW1lKCdQZXJmb3JhdGlvbnMgMS84IiAoTmV3KScpDQogICAgICAgIGBgYA0KICAgICAgICAiUGVyZm9yYXRpb25zIDE4IChOZXcpLnR4dCINCiAgICAiIiINCiAgICBpZiB3aW5kb3dzX3NhZmU6DQogICAgICAgIHJldHVybiByZS5zdWIocidbXC86Kj8iPD58XScsICcnLCBmaWxlX25hbWUpDQogICAgZWxzZToNCiAgICAgICAgcmV0dXJuIHJlLnN1YihyJ1teXHdfLigpIC0jXXxbIl0nLCAnJywgZmlsZV9uYW1lKQ0KDQoNCmRlZiBfaW5jX29yX2RlY19zdHJpbmcoc3RyX2lkLCBzaGlmdCwgcmVmaXQ9RmFsc2UsIGxvZ2dlcj1Ob25lKToNCiAgICAiIiJJbmNyZW1lbnQgb3IgZGVjcmVtZW50IGlkZW50aWZpZXIuDQoNCiAgICBBcmdzOg0KICAgICAgICBzdHJfaWQgKHN0cik6IGlkZW50aWZpZXIgZS5nLiBBMzEwYQ0KICAgICAgICBzaGlmdCAoaW50KTogbnVtYmVyIG9mIHN0ZXBzIHRvIGNoYW5nZSB0aGUgaWRlbnRpZmllcg0KICAgICAgICByZWZpdCAoYm9vbCk6IHdoZXRoZXIgdG8gcmVmaXQgdGhlIGlkZW50aWZpZXINCiAgICAgICAgbG9nZ2VyIChsb2dnaW5nLkxvZ2dlcik6IGxvZ2dlcg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IG1vZGlmaWVkIGlkZW50aWZpZXINCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgX2luY19vcl9kZWNfc3RyaW5nKCdBMzE5eicpDQogICAgICAgIGBgYA0KICAgICAgICAnQTMyMGEnDQogICAgIiIiDQogICAgIyBpZiBubyBzaGlmdCwgcmV0dXJuIGdpdmVuIHN0cmluZw0KICAgIGlmIHNoaWZ0ID09IDA6DQogICAgICAgIHJldHVybiBzdHJfaWQNCg0KICAgICMgb3RoZXJ3aXNlIGxldHMgcHJvY2VzcyB0aGUgc2hpZnQNCiAgICBuZXh0X3N0ciA9ICIiDQogICAgaW5kZXggPSBsZW4oc3RyX2lkKSAtIDENCiAgICBjYXJyeSA9IHNoaWZ0DQoNCiAgICB3aGlsZSBpbmRleCA+PSAwOg0KICAgICAgICAjIHBpY2sgY2hhcnMgZnJvbSByaWdodA0KICAgICAgICAjIEExLjEwMWEgPC0tDQogICAgICAgIHRoaXNfY2hhciA9IHN0cl9pZFtpbmRleF0NCg0KICAgICAgICAjIGRldGVybWluZSBjaGFyYWN0ZXIgcmFuZ2UgKCMgb2YgY2hhcnMsIHN0YXJ0aW5nIGluZGV4KQ0KICAgICAgICBpZiB0aGlzX2NoYXIuaXNkaWdpdCgpOg0KICAgICAgICAgICAgY2hhcl9yYW5nZSA9ICgnMCcsICc5JykNCiAgICAgICAgZWxpZiB0aGlzX2NoYXIuaXNhbHBoYSgpOg0KICAgICAgICAgICAgIyBpZiB0aGlzX2NoYXIuaXN1cHBlcigpDQogICAgICAgICAgICBjaGFyX3JhbmdlID0gKCdBJywgJ1onKQ0KICAgICAgICAgICAgaWYgdGhpc19jaGFyLmlzbG93ZXIoKToNCiAgICAgICAgICAgICAgICBjaGFyX3JhbmdlID0gKCdhJywgJ3onKQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgbmV4dF9zdHIgKz0gdGhpc19jaGFyDQogICAgICAgICAgICBpbmRleCAtPSAxDQogICAgICAgICAgICBjb250aW51ZQ0KDQogICAgICAgICMgZ2V0IGNoYXJhY3RlciByYW5nZSBwcm9wZXJ0aWVzDQogICAgICAgIGRpcmVjdGlvbiA9IGludChjYXJyeSAvIGFicyhjYXJyeSkpIGlmIGNhcnJ5ICE9IDAgZWxzZSAxDQogICAgICAgIHN0YXJ0X2NoYXIsIGVuZF9jaGFyID0gXA0KICAgICAgICAgICAgY2hhcl9yYW5nZSBpZiBkaXJlY3Rpb24gPiAwIGVsc2UgY2hhcl9yYW5nZVs6Oi0xXQ0KICAgICAgICBjaGFyX3N0ZXBzID0gYWJzKG9yZChlbmRfY2hhcikgLSBvcmQoc3RhcnRfY2hhcikpICsgMQ0KICAgICAgICAjIGNhbGN1bGF0ZSBvZmZzZXQNCg0KICAgICAgICAjIHBvc2l0aXZlIGNhcnJ5IC0+IHN0YXJ0X2NoYXI9MCAgICBlbmRfY2hhcj05DQogICAgICAgICMgKy0tLS0tLS0tLS0rKyAgICAgICAgKysgICAgICAgICAgKyAgY2hhcl9zdGVwcw0KICAgICAgICAjICstLS0tLS0tLSsgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3QNCiAgICAgICAgIyAgICAgICAgICArLS0tLS0tLS0tLS0tLS0tKyAgICAgICAgICBjYXJyeSAoYWJzKQ0KICAgICAgICAjIDAxMjM0NTY3WzhdOTAxMjM0NTY3ODkwMVsyXTM0NTY3ODkNCiAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tKz09KyAgICAgICAgICBvZmZzZXQNCg0KICAgICAgICAjIG5lZ2F0aXZlIGNhcnJ5IC0+IHN0YXJ0X2NoYXI9OSAgICBlbmRfY2hhcj0wDQogICAgICAgICMgKy0tLS0tLS0tLS0rKyAgICAgICAgKysgICAgICAgICAgKyAgY2hhcl9zdGVwcw0KICAgICAgICAjICstLS0tLS0tKyAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3QNCiAgICAgICAgIyAgICAgICAgICstLS0tLS0tLS0tLS0tLS0rICAgICAgICAgICBjYXJyeSAoYWJzKQ0KICAgICAgICAjIDk4NzY1NDNbMl0xMDk4NzY1NDMyMTA5WzhdNzY1NDMyMTANCiAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tKz0rICAgICAgICAgICBvZmZzZXQNCg0KICAgICAgICBkaXN0ID0gYWJzKG9yZCh0aGlzX2NoYXIpIC0gb3JkKHN0YXJ0X2NoYXIpKQ0KICAgICAgICBvZmZzZXQgPSAoZGlzdCArIGFicyhjYXJyeSkpICUgY2hhcl9zdGVwcw0KICAgICAgICBuZXh0X2NoYXIgPSBjaHIob3JkKHN0YXJ0X2NoYXIpICsgKG9mZnNldCAqIGRpcmVjdGlvbikpDQogICAgICAgIG5leHRfc3RyICs9IG5leHRfY2hhcg0KICAgICAgICBjYXJyeSA9IGludCgoZGlzdCArIGFicyhjYXJyeSkpIC8gY2hhcl9zdGVwcykgKiBkaXJlY3Rpb24NCiAgICAgICAgaWYgbG9nZ2VyOg0KICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKA0KICAgICAgICAgICAgICAgICdcInt9XCIgaW5kZXg9e30gc3RhcnRfY2hhcj1cInt9XCIgZW5kX2NoYXI9XCJ7fVwiICcNCiAgICAgICAgICAgICAgICAnbmV4dF9jYXJyeT17fSBkaXJlY3Rpb249e30gZGlzdD17fSBvZmZzZXQ9e30gbmV4dF9jaGFyPVwie31cIicNCiAgICAgICAgICAgICAgICAuZm9ybWF0KA0KICAgICAgICAgICAgICAgICAgICB0aGlzX2NoYXIsDQogICAgICAgICAgICAgICAgICAgIGluZGV4LA0KICAgICAgICAgICAgICAgICAgICBzdGFydF9jaGFyLA0KICAgICAgICAgICAgICAgICAgICBlbmRfY2hhciwNCiAgICAgICAgICAgICAgICAgICAgY2FycnksDQogICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbiwNCiAgICAgICAgICAgICAgICAgICAgZGlzdCwNCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LA0KICAgICAgICAgICAgICAgICAgICBuZXh0X2NoYXIpKQ0KICAgICAgICBpbmRleCAtPSAxDQogICAgICAgICMgcmVmaXQgdGhlIGZpbmFsIHZhbHVlDQogICAgICAgICMgMDA5IC0tPiA5DQogICAgICAgICMgWlpBIC0tPiBaQQ0KICAgICAgICBpZiByZWZpdCBhbmQgaW5kZXggPT0gLTE6DQogICAgICAgICAgICBpZiBjYXJyeSA+IDA6DQogICAgICAgICAgICAgICAgc3RyX2lkID0gc3RhcnRfY2hhciArIHN0cl9pZA0KICAgICAgICAgICAgICAgIGlmIHN0YXJ0X2NoYXIuaXNhbHBoYSgpOg0KICAgICAgICAgICAgICAgICAgICBjYXJyeSAtPSAxDQogICAgICAgICAgICAgICAgaW5kZXggPSAwDQogICAgICAgICAgICBlbGlmIGRpcmVjdGlvbiA9PSAtMToNCiAgICAgICAgICAgICAgICBpZiBuZXh0X3N0ci5lbmRzd2l0aChzdGFydF9jaGFyKToNCiAgICAgICAgICAgICAgICAgICAgbmV4dF9zdHIgPSBuZXh0X3N0cls6LTFdDQogICAgICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgbmV4dF9zdHIuZW5kc3dpdGgoZW5kX2NoYXIpOg0KICAgICAgICAgICAgICAgICAgICAgICAgbmV4dF9zdHIgPSBuZXh0X3N0cls6LTFdDQoNCiAgICByZXR1cm4gbmV4dF9zdHJbOjotMV0NCg0KDQpkZWYgaW5jcmVtZW50X3N0cihpbnB1dF9zdHIsIHN0ZXA9MSwgZXhwYW5kPUZhbHNlKToNCiAgICAiIiJJbmNyZW1lbmV0IGlkZW50aWZpZXIuDQoNCiAgICBBcmdzOg0KICAgICAgICBpbnB1dF9zdHIgKHN0cik6IGlkZW50aWZpZXIgZS5nLiBBMzEwYQ0KICAgICAgICBzdGVwIChpbnQpOiBudW1iZXIgb2Ygc3RlcHMgdG8gY2hhbmdlIHRoZSBpZGVudGlmaWVyDQogICAgICAgIGV4cGFuZCAoYm9vbCk6IHJlbW92ZXMgbGVhZGluZyB6ZXJvZXMgYW5kIGR1cGxpY2F0ZSBsZXR0ZXJzDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogbW9kaWZpZWQgaWRlbnRpZmllcg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBpbmNyZW1lbnRfc3RyKCdBMzE5eicpDQogICAgICAgIGBgYA0KICAgICAgICAnQTMyMGEnDQogICAgIiIiDQogICAgcmV0dXJuIF9pbmNfb3JfZGVjX3N0cmluZyhpbnB1dF9zdHIsIGFicyhzdGVwKSwgcmVmaXQ9ZXhwYW5kKQ0KDQoNCmRlZiBkZWNyZW1lbnRfc3RyKGlucHV0X3N0ciwgc3RlcD0xLCBzaHJpbms9RmFsc2UpOg0KICAgICIiIkRlY3JlbWVudCBpZGVudGlmaWVyLg0KDQogICAgQXJnczoNCiAgICAgICAgaW5wdXRfc3RyIChzdHIpOiBpZGVudGlmaWVyIGUuZy4gQTMxMGENCiAgICAgICAgc3RlcCAoaW50KTogbnVtYmVyIG9mIHN0ZXBzIHRvIGNoYW5nZSB0aGUgaWRlbnRpZmllcg0KICAgICAgICBzaHJpbmsgKGJvb2wpOiByZW1vdmVzIGxlYWRpbmcgemVyb2VzIG9yIGR1cGxpY2F0ZSBsZXR0ZXJzIA0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IG1vZGlmaWVkIGlkZW50aWZpZXINCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZGVjcmVtZW50X3N0cignQTMxMGEnKQ0KICAgICAgICBgYGANCiAgICAgICAgJ0EzMDl6Jw0KICAgICIiIg0KICAgIHJldHVybiBfaW5jX29yX2RlY19zdHJpbmcoaW5wdXRfc3RyLCAtYWJzKHN0ZXApLCByZWZpdD1zaHJpbmspDQoNCg0KZGVmIGV4dGVuZF9jb3VudGVyKGlucHV0X3N0ciwgdXBwZXI9VHJ1ZSwgdXNlX3plcm89RmFsc2UpOg0KICAgICIiIkFkZCBhIG5ldyBsZXZlbCB0byBpZGVudGlmaWVyLiBlLmcuIEEzMTAgLT4gQTMxMEEuDQoNCiAgICBBcmdzOg0KICAgICAgICBpbnB1dF9zdHIgKHN0cik6IGlkZW50aWZpZXIgZS5nLiBBMzEwDQogICAgICAgIHVwcGVyIChib29sKTogdXNlIFVQUEVSQ0FTRSBjaGFyYWN0ZXJzIGZvciBleHRlbnNpb24NCiAgICAgICAgdXNlX3plcm8gKGJvb2wpOiBzdGFydCBmcm9tIDAgZm9yIG51bWVyaWMgZXh0ZW5zaW9uDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogZXh0ZW5kZWQgaWRlbnRpZmllcg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBleHRlbmRfY291bnRlcignQTMxMCcpDQogICAgICAgIGBgYA0KICAgICAgICAnQTMxMEEnDQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBleHRlbmRfY291bnRlcignQTMxMEEnLCB1c2VfemVybz1UcnVlKQ0KICAgICAgICBgYGANCiAgICAgICAgJ0EzMTBBMCcNCiAgICAiIiINCiAgICBpZiBpbnB1dF9zdHJbLTFdLmlzZGlnaXQoKToNCiAgICAgICAgcmV0dXJuIGlucHV0X3N0ciArICgiQSIgaWYgdXBwZXIgZWxzZSAiYSIpDQogICAgZWxzZToNCiAgICAgICAgcmV0dXJuIGlucHV0X3N0ciArICgiMCIgaWYgdXNlX3plcm8gZWxzZSAiMSIpDQoNCg0KZGVmIGZpbHRlcl9udWxsX2l0ZW1zKHNyY19saXN0KToNCiAgICAiIiJSZW1vdmUgTm9uZSBpdGVtcyBpbiB0aGUgZ2l2ZW4gbGlzdC4NCg0KICAgIEFyZ3M6DQogICAgICAgIHNyY19saXN0IChsaXN0W0FueV0pOiBsaXN0IG9mIGFueSBpdGVtcw0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGxpc3RbQW55XSk6IGNsZWFuZWQgbGlzdA0KICAgICIiIg0KICAgIHJldHVybiBsaXN0KGZpbHRlcihib29sLCBzcmNfbGlzdCkpDQoNCg0KZGVmIHJldmVyc2VfZGljdChpbnB1dF9kaWN0KToNCiAgICAiIiJSZXZlcnNlIHRoZSBrZXksIHZhbHVlIHBhaXJzLg0KDQogICAgQXJnczoNCiAgICAgICAgaW5wdXRfZGljdCAoZGljdCk6IHNvdXJjZSBvcmRlcmVkIGRpY3QNCg0KICAgIFJldHVybnM6DQogICAgICAgIChkZWZhdWx0ZGljdCk6IHJldmVyc2VkIGRpY3Rpb25hcnkNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgcmV2ZXJzZV9kaWN0KHsxOiAyLCAzOiA0fSkNCiAgICAgICAgYGBgDQogICAgICAgIGRlZmF1bHRkaWN0KDx0eXBlICdsaXN0Jz4sIHsyOiBbMV0sIDQ6IFszXX0pDQogICAgIiIiDQogICAgb3V0cHV0X2RpY3QgPSBkZWZhdWx0ZGljdChsaXN0KQ0KICAgIGZvciBrZXksIHZhbHVlIGluIGlucHV0X2RpY3QuaXRlbXMoKToNCiAgICAgICAgb3V0cHV0X2RpY3RbdmFsdWVdLmFwcGVuZChrZXkpDQogICAgcmV0dXJuIG91dHB1dF9kaWN0DQoNCg0KZGVmIHRpbWVzdGFtcCgpOg0KICAgICIiIlJldHVybiB0aW1lc3RhbXAgZm9yIGN1cnJlbnQgdGltZS4NCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIpOiB0aW1lc3RhbXAgaW4gc3RyaW5nIGZvcm1hdA0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICB0aW1lc3RhbXAoKQ0KICAgICAgICBgYGANCiAgICAgICAgJzAxMDAzMDc1MDMyNTA2ODA4Jw0KICAgICIiIg0KICAgIHJldHVybiBkYXRldGltZS5kYXRldGltZS5ub3coKS5zdHJmdGltZSgiJW0laiVIJU0lUyVmIikNCg0KDQpkZWYgY3VycmVudF90aW1lKCk6DQogICAgIiIiUmV0dXJuIGZvcm1hdHRlZCBjdXJyZW50IHRpbWUuDQoNCiAgICBDdXJyZW50IGltcGxlbWVudGF0aW9uIHVzZXMgJUg6JU06JVMgdG8gZm9ybWF0IHRpbWUuDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogZm9ybWF0dGVkIGN1cnJlbnQgdGltZS4NCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgY3VycmVudF90aW1lKCkNCiAgICAgICAgYGBgDQogICAgICAgICcwNzo1MDo1MycNCiAgICAiIiINCiAgICByZXR1cm4gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikNCg0KDQpkZWYgY3VycmVudF9kYXRlKCk6DQogICAgIiIiUmV0dXJuIGZvcm1hdHRlZCBjdXJyZW50IGRhdGUuDQoNCiAgICBDdXJyZW50IGltcGxlbWVudGF0aW9uIHVzZXMgJVktJW0tJWQgdG8gZm9ybWF0IGRhdGUuDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogZm9ybWF0dGVkIGN1cnJlbnQgZGF0ZS4NCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgY3VycmVudF9kYXRlKCkNCiAgICAgICAgYGBgDQogICAgICAgICcyMDE4LTAxLTAzJw0KICAgICIiIg0KICAgIHJldHVybiBkYXRldGltZS5kYXRldGltZS5ub3coKS5zdHJmdGltZSgiJVktJW0tJWQiKQ0KDQoNCmRlZiBpc19ibGFuayhpbnB1dF9zdHJpbmcpOg0KICAgICIiIkNoZWNrIGlmIGlucHV0IHN0cmluZyBpcyBibGFuayAobXVsdGlwbGUgd2hpdGUgc3BhY2VzIGlzIGJsYW5rKS4NCg0KICAgIEFyZ3M6DQogICAgICAgIGlucHV0X3N0cmluZyAoc3RyKTogaW5wdXQgc3RyaW5nDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoYm9vbCk6IFRydWUgaWYgc3RyaW5nIGlzIGJsYW5rDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGlzX2JsYW5rKCcgICAnKQ0KICAgICAgICBgYGANCiAgICAgICAgVHJ1ZQ0KICAgICIiIg0KICAgIGlmIGlucHV0X3N0cmluZyBhbmQgaW5wdXRfc3RyaW5nLnN0cmlwKCk6DQogICAgICAgIHJldHVybiBGYWxzZQ0KICAgIHJldHVybiBUcnVlDQoNCg0KZGVmIGlzX3VybF92YWxpZCh1cmxfc3RyaW5nKToNCiAgICAiIiJDaGVjayBpZiBnaXZlbiBVUkwgaXMgaW4gdmFsaWQgZm9ybWF0Lg0KDQogICAgQXJnczoNCiAgICAgICAgdXJsX3N0cmluZyAoc3RyKTogVVJMIHN0cmluZw0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGJvb2wpOiBUcnVlIGlmIFVSTCBpcyBpbiB2YWxpZCBmb3JtYXQNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgaXNfdXJsX3ZhbGlkKCdodHRwczovL3d3dy5nb29nbGUuY29tJykNCiAgICAgICAgYGBgDQogICAgICAgIFRydWUNCiAgICAiIiINCiAgICByZWdleCA9IHJlLmNvbXBpbGUoDQogICAgICAgIHInXig/Omh0dHB8ZnRwKXM/Oi8vJyAgICAgICAgICAgICAgICAgICAjIGh0dHA6Ly8gb3IgaHR0cHM6Ly8NCiAgICAgICAgcicoPzooPzpbQS1aMC05XSg/OltBLVowLTktXXswLDYxfVtBLVowLTldKT9cLikrJw0KICAgICAgICByJyg/OltBLVpdezIsNn1cLj98W0EtWjAtOS1dezIsfVwuPyl8JyAgIyBkb21haW4uLi4NCiAgICAgICAgcidsb2NhbGhvc3R8JyAgICAgICAgICAgICAgICAgICAgICAgICAgICMgbG9jYWxob3N0Li4uDQogICAgICAgIHInXGR7MSwzfVwuXGR7MSwzfVwuXGR7MSwzfVwuXGR7MSwzfSknICAjIC4uLm9yIGlwDQogICAgICAgIHInKD86OlxkKyk/JyAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIG9wdGlvbmFsIHBvcnQNCiAgICAgICAgcicoPzovP3xbLz9dXFMrKSQnLCByZS5JR05PUkVDQVNFKQ0KDQogICAgcmV0dXJuIHJlZ2V4Lm1hdGNoKHVybF9zdHJpbmcpDQoNCg0KZGVmIHJlZm9ybWF0X3N0cmluZyhvcmlnX3N0ciwgb3JpZ19mb3JtYXQsIG5ld19mb3JtYXQpOg0KICAgICIiIlJlZm9ybWF0IGEgc3RyaW5nIGludG8gYSBuZXcgZm9ybWF0Lg0KDQogICAgRXh0cmFjdHMgaW5mb3JtYXRpb24gZnJvbSBhIHN0cmluZyBiYXNlZCBvbiBhIGdpdmVuIHBhdHRlcm4sDQogICAgYW5kIHJlY3JlYXRlcyBhIG5ldyBzdHJpbmcgYmFzZWQgb24gdGhlIGdpdmVuIG5ldyBwYXR0ZXJuLg0KDQogICAgQXJnczoNCiAgICAgICAgb3JpZ19zdHIgKHN0cik6IE9yaWdpbmFsIHN0cmluZyB0byBiZSByZWZvcm1hdHRlZA0KICAgICAgICBvcmlnX2Zvcm1hdCAoc3RyKTogUGF0dGVybiBvZiB0aGUgb3JpZ2luYWwgc3RyIChkYXRhIHRvIGJlIGV4dHJhY3RlZCkNCiAgICAgICAgbmV3X2Zvcm1hdCAoc3RyKTogTmV3IHBhdHRlcm4gKGhvdyB0byByZWNvbXBvc2UgdGhlIGRhdGEpDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogUmVmb3JtYXR0ZWQgc3RyaW5nDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIHJlZm9ybWF0X3N0cmluZygnMTUwIC0gRkxPT1IvQ0VJTElORyAtIFdEIC0gMSBIUiAtIEZMT09SIEFTU0VNQkxZJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3NlY3Rpb259IC0ge2xvY30gLSB7bWF0fSAtIHtyYXRpbmd9IC0ge25hbWV9JywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3NlY3Rpb259OnttYXR9OntyYXRpbmd9IC0ge25hbWV9ICh7bG9jfSknKSkNCiAgICAgICAgYGBgDQogICAgICAgICcxNTA6V0Q6MSBIUiAtIEZMT09SIEFTU0VNQkxZIChGTE9PUi9DRUlMSU5HKScNCiAgICAiIiINCiAgICAjIGZpbmQgdGhlIHRhZ3MNCiAgICB0YWdfZXh0cmFjdG9yID0gcmUuY29tcGlsZSgneyguKz8pfScpDQogICAgdGFncyA9IHRhZ19leHRyYWN0b3IuZmluZGFsbChvcmlnX2Zvcm1hdCkNCg0KICAgICMgcmVwbGFjZSB0aGUgdGFncyB3aXRoIHJlZ2V4IHBhdHRlcm5zDQogICAgIyB0byBjcmVhdGUgYSByZWdleCBwYXR0ZXJuIHRoYXQgZmluZHMgdmFsdWVzDQogICAgdGFnX3JlcGxhY2VyID0gcmUuY29tcGlsZSgney4rP30nKQ0KICAgIHZhbHVlX2V4dHJhY3Rvcl9wYXR0ZXJuID0gdGFnX3JlcGxhY2VyLnN1YignKC4rKScsIG9yaWdfZm9ybWF0KQ0KICAgICMgZmluZCBhbGwgdmFsdWVzDQogICAgdmFsdWVfZXh0cmFjdG9yID0gcmUuY29tcGlsZSh2YWx1ZV9leHRyYWN0b3JfcGF0dGVybikNCiAgICBtYXRjaCA9IHZhbHVlX2V4dHJhY3Rvci5tYXRjaChvcmlnX3N0cikNCiAgICB2YWx1ZXMgPSBtYXRjaC5ncm91cHMoKQ0KDQogICAgIyBjcmVhdGUgYSBkaWN0aW9uYXJ5IG9mIHRhZ3MgYW5kIHZhbHVlcw0KICAgIHJlZm9ybWF0X2RpY3QgPSB7fQ0KICAgIGZvciBrZXksIHZhbHVlIGluIHppcCh0YWdzLCB2YWx1ZXMpOg0KICAgICAgICByZWZvcm1hdF9kaWN0W2tleV0gPSB2YWx1ZQ0KDQogICAgIyB1c2UgZGljdGlvbmFyeSB0byByZWZvcm1hdCB0aGUgc3RyaW5nIGludG8gbmV3DQogICAgcmV0dXJuIG5ld19mb3JtYXQuZm9ybWF0KCoqcmVmb3JtYXRfZGljdCkNCg0KDQpkZWYgZ2V0X21hcHBlZF9kcml2ZXNfZGljdCgpOg0KICAgICIiIlJldHVybiBhIGRpY3Rpb25hcnkgb2YgY3VycmVudGx5IG1hcHBlZCBuZXR3b3JrIGRyaXZlcy4iIiINCiAgICBzZWFyY2hlciA9IGZyYW1ld29yay5NYW5hZ2VtZW50T2JqZWN0U2VhcmNoZXIoDQogICAgICAgICJyb290XFxDSU1WMiIsDQogICAgICAgICJTRUxFQ1QgKiBGUk9NIFdpbjMyX01hcHBlZExvZ2ljYWxEaXNrIg0KICAgICAgICApDQoNCiAgICByZXR1cm4ge3hbJ0RldmljZUlEJ106IHhbJ1Byb3ZpZGVyTmFtZSddIGZvciB4IGluIHNlYXJjaGVyLkdldCgpfQ0KDQoNCmRlZiBkbGV0dGVyX3RvX3VuYyhkbGV0dGVyX3BhdGgpOg0KICAgICIiIkNvbnZlcnQgZHJpdmUgbGV0dGVyIHBhdGggaW50byBVTkMgcGF0aCBvZiB0aGF0IGRyaXZlLg0KDQogICAgQXJnczoNCiAgICAgICAgZGxldHRlcl9wYXRoIChzdHIpOiBkcml2ZSBsZXR0ZXIgcGF0aA0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IFVOQyBwYXRoDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgICMgYXNzdW1pbmcgSjogaXMgbWFwcGVkIHRvIC8vZmlsZXN0b3JlL3NlcnZlci9qZHJpdmUNCiAgICAgICAgZGxldHRlcl90b191bmMoJ0o6L3NvbWVmaWxlLnR4dCcpDQogICAgICAgIGBgYA0KICAgICAgICAnLy9maWxlc3RvcmUvc2VydmVyL2pkcml2ZS9zb21lZmlsZS50eHQnDQogICAgIiIiDQogICAgZHJpdmVzID0gZ2V0X21hcHBlZF9kcml2ZXNfZGljdCgpDQogICAgZGxldHRlciA9IGRsZXR0ZXJfcGF0aFs6Ml0NCiAgICBmb3IgbWFwcGVkX2RyaXZlLCBzZXJ2ZXJfcGF0aCBpbiBkcml2ZXMuaXRlbXMoKToNCiAgICAgICAgaWYgZGxldHRlci5sb3dlcigpID09IG1hcHBlZF9kcml2ZS5sb3dlcigpOg0KICAgICAgICAgICAgcmV0dXJuIGRsZXR0ZXJfcGF0aC5yZXBsYWNlKGRsZXR0ZXIsIHNlcnZlcl9wYXRoKQ0KDQoNCmRlZiB1bmNfdG9fZGxldHRlcih1bmNfcGF0aCk6DQogICAgIiIiQ29udmVydCBVTkMgcGF0aCBpbnRvIGRyaXZlIGxldHRlciBwYXRoLg0KDQogICAgQXJnczoNCiAgICAgICAgdW5jX3BhdGggKHN0cik6IFVOQyBwYXRoDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogZHJpdmUgbGV0dGVyIHBhdGgNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgIyBhc3N1bWluZyBKOiBpcyBtYXBwZWQgdG8gLy9maWxlc3RvcmUvc2VydmVyL2pkcml2ZQ0KICAgICAgICB1bmNfdG9fZGxldHRlcignLy9maWxlc3RvcmUvc2VydmVyL2pkcml2ZS9zb21lZmlsZS50eHQnKQ0KICAgICAgICBgYGANCiAgICAgICAgJ0o6L3NvbWVmaWxlLnR4dCcNCiAgICAiIiINCiAgICBkcml2ZXMgPSBnZXRfbWFwcGVkX2RyaXZlc19kaWN0KCkNCiAgICBmb3IgbWFwcGVkX2RyaXZlLCBzZXJ2ZXJfcGF0aCBpbiBkcml2ZXMuaXRlbXMoKToNCiAgICAgICAgaWYgc2VydmVyX3BhdGggaW4gdW5jX3BhdGg6DQogICAgICAgICAgICByZXR1cm4gdW5jX3BhdGgucmVwbGFjZShzZXJ2ZXJfcGF0aCwgbWFwcGVkX2RyaXZlKQ0KDQoNCmRlZiByYW5kb21fY29sb3IoKToNCiAgICAiIiJSZXR1cm4gYSByYW5kb20gY29sb3IgY2hhbm5lbCB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLiIiIg0KICAgIHJldHVybiByYW5kb20ucmFuZGludCgwLCAyNTUpDQoNCg0KZGVmIHJhbmRvbV9hbHBoYSgpOg0KICAgICIiIlJldHVybiBhIHJhbmRvbSBhbHBoYSB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAxLjAwKS4iIiINCiAgICByZXR1cm4gcm91bmQocmFuZG9tLnJhbmRvbSgpLCAyKQ0KDQoNCmRlZiByYW5kb21faGV4X2NvbG9yKCk6DQogICAgIiIiUmV0dXJuIGEgcmFuZG9tIGNvbG9yIGluIGhleCBmb3JtYXQuDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIHJhbmRvbV9oZXhfY29sb3IoKQ0KICAgICAgICBgYGANCiAgICAgICAgJyNGRjAwMDAnDQogICAgIiIiDQogICAgcmV0dXJuICcjJTAyWCUwMlglMDJYJyAlIChyYW5kb21fY29sb3IoKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbV9jb2xvcigpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX2NvbG9yKCkpDQoNCg0KZGVmIHJhbmRvbV9yZ2JfY29sb3IoKToNCiAgICAiIiJSZXR1cm4gYSByYW5kb20gY29sb3IgaW4gcmdiIGZvcm1hdC4NCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgcmFuZG9tX3JnYl9jb2xvcigpDQogICAgICAgIGBgYA0KICAgICAgICAncmdiKDI1NSwgMCwgMCknDQogICAgIiIiDQogICAgcmV0dXJuICdyZ2IoJWQsICVkLCAlZCknICUgKHJhbmRvbV9jb2xvcigpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5kb21fY29sb3IoKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX2NvbG9yKCkpDQoNCg0KZGVmIHJhbmRvbV9yZ2JhX2NvbG9yKCk6DQogICAgIiIiUmV0dXJuIGEgcmFuZG9tIGNvbG9yIGluIHJnYmEgZm9ybWF0Lg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICByYW5kb21fcmdiYV9jb2xvcigpDQogICAgICAgIGBgYA0KICAgICAgICAncmdiYSgyNTUsIDAsIDAsIDAuNSknDQogICAgIiIiDQogICAgcmV0dXJuICdyZ2JhKCVkLCAlZCwgJWQsICUuMmYpJyAlIChyYW5kb21fY29sb3IoKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbV9jb2xvcigpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX2NvbG9yKCksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5kb21fYWxwaGEoKSkNCg0KDQpkZWYgZXh0cmFjdF9yYW5nZShmb3JtYXR0ZWRfc3RyLCBtYXhfcmFuZ2U9NTAwKToNCiAgICAiIiJFeHRyYWN0IHJhbmdlIGZyb20gZm9ybWF0dGVkIHN0cmluZy4NCg0KICAgIFN0cmluZyBtdXN0IGJlIGZvcm1hdHRlZCBhcyBiZWxvdw0KICAgIEExMDMgICAgICAgICAgICBObyByYW5nZQ0KICAgIEExMDMtQTEwNiAgICAgICBBMTAzIHRvIEExMDYNCiAgICBBMTAzOkExMDYgICAgICAgQTEwMyB0byBBMTA2DQogICAgQTEwMyxBMTA1YSAgICAgIEExMDMgYW5kIEExMDVhDQogICAgQTEwMztBMTA1YSAgICAgIEExMDMgYW5kIEExMDVhDQoNCiAgICBBcmdzOg0KICAgICAgICBmb3JtYXR0ZWRfc3RyIChzdHIpOiBzdHJpbmcgc3BlY2lmeWluZyByYW5nZQ0KICAgICAgICBtYXhfcmFuZ2UgKGludCk6IG1heGltdW0gbnVtYmVyIG9mIGl0ZW1zIHRvIGNyZWF0ZS4NCg0KICAgIFJldHVybnM6DQogICAgICAgIChsaXN0W3N0cl0pOiBuYW1lcyBpbiB0aGUgc3BlY2lmaWVkIHJhbmdlDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGV4cmFjdF9yYW5nZSgnQTEwMzpBMTA2JykNCiAgICAgICAgYGBgDQogICAgICAgIFsnQTEwMycsICdBMTA0JywgJ0ExMDUnLCAnQTEwNiddDQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBleHJhY3RfcmFuZ2UoJ1MyMDMtUzIwNicpDQogICAgICAgIGBgYA0KICAgICAgICBbJ1MyMDMnLCAnUzIwNCcsICdTMjA1JywgJ1MyMDYnXQ0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZXhyYWN0X3JhbmdlKCdNMDBBLE0wMEInKQ0KICAgICAgICBgYGANCiAgICAgICAgWydNMDBBJywgJ00wMEInXQ0KICAgICIiIg0KICAgIGZvciByY2hhciwgcmNoYXJ0eXBlIGluIHsnOjonOiAncmFuZ2UnLCAnLS0nOiAncmFuZ2UnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLCc6ICdsaXN0JywgJzsnOiAnbGlzdCd9Lml0ZW1zKCk6DQogICAgICAgIGlmIHJjaGFyIGluIGZvcm1hdHRlZF9zdHI6DQogICAgICAgICAgICBpZiByY2hhcnR5cGUgPT0gJ3JhbmdlJyBcDQogICAgICAgICAgICAgICAgICAgIGFuZCBmb3JtYXR0ZWRfc3RyLmNvdW50KHJjaGFyKSA9PSAxOg0KICAgICAgICAgICAgICAgIGl0ZW1zID0gW10NCiAgICAgICAgICAgICAgICBzdGFydCwgZW5kID0gZm9ybWF0dGVkX3N0ci5zcGxpdChyY2hhcikNCiAgICAgICAgICAgICAgICBhc3NlcnQgbGVuKHN0YXJ0KSA9PSBsZW4oZW5kKSwgXA0KICAgICAgICAgICAgICAgICAgICAnUmFuZ2Ugc3RhcnQgYW5kIGVuZCBtdXN0IGhhdmUgc2FtZSBsZW5ndGgnDQogICAgICAgICAgICAgICAgaXRlbXMuYXBwZW5kKHN0YXJ0KQ0KICAgICAgICAgICAgICAgIGl0ZW0gPSBpbmNyZW1lbnRfc3RyKHN0YXJ0LCAxKQ0KICAgICAgICAgICAgICAgIHNhZmVfY291bnRlciA9IDANCiAgICAgICAgICAgICAgICB3aGlsZSBpdGVtICE9IGVuZDoNCiAgICAgICAgICAgICAgICAgICAgaXRlbXMuYXBwZW5kKGl0ZW0pDQogICAgICAgICAgICAgICAgICAgIGl0ZW0gPSBpbmNyZW1lbnRfc3RyKGl0ZW0sIDEpDQogICAgICAgICAgICAgICAgICAgIHNhZmVfY291bnRlciArPSAxDQogICAgICAgICAgICAgICAgICAgIGFzc2VydCBzYWZlX2NvdW50ZXIgPCBtYXhfcmFuZ2UsICdNYXggcmFuZ2UgcmVhY2hlZC4nDQogICAgICAgICAgICAgICAgaXRlbXMuYXBwZW5kKGVuZCkNCiAgICAgICAgICAgICAgICByZXR1cm4gaXRlbXMNCiAgICAgICAgICAgIGVsaWYgcmNoYXJ0eXBlID09ICdsaXN0JzoNCiAgICAgICAgICAgICAgICByZXR1cm4gW3guc3RyaXAoKSBmb3IgeCBpbiBmb3JtYXR0ZWRfc3RyLnNwbGl0KHJjaGFyKV0NCiAgICByZXR1cm4gW2Zvcm1hdHRlZF9zdHJdDQoNCg0KZGVmIGNoZWNrX2VuY29kaW5nX2JvbShmaWxlbmFtZSwgYm9tX2J5dGVzPWNvZGVjcy5CT01fVVRGOCk6DQogICAgIiIiQ2hlY2sgaWYgZ2l2ZW4gZmlsZSBjb250YWlucyB0aGUgZ2l2ZW4gQk9NIGJ5dGVzIGF0IHRoZSBzdGFydC4NCg0KICAgIEFyZ3M6DQogICAgICAgIGZpbGVuYW1lIChzdHIpOiBmaWxlIHBhdGgNCiAgICAgICAgYm9tX2J5dGVzIChieXRlcywgb3B0aW9uYWwpOiBCT00gYnl0ZXMgdG8gY2hlY2sNCiAgICAiIiINCiAgICB3aXRoIG9wZW4oZmlsZW5hbWUsICdyYicpIGFzIHJ0ZmlsZToNCiAgICAgICAgcmV0dXJuIHJ0ZmlsZS5yZWFkKClbOmxlbihib21fYnl0ZXMpXSA9PSBib21fYnl0ZXMNCg0KDQpkZWYgaGFzX25vbnByaW50YWJsZShpbnB1dF9zdHIpOg0KICAgICIiIkNoZWNrIGlucHV0IHN0cmluZyBmb3Igbm9uLXByaW50YWJsZSBjaGFyYWN0ZXJzLg0KDQogICAgQXJnczoNCiAgICAgICAgaW5wdXRfc3RyIChzdHIpOiBpbnB1dCBzdHJpbmcNCg0KICAgIFJldHVybnM6DQogICAgICAgIChib29sKTogVHJ1ZSBpZiBjb250YWlucyBub24tcHJpbnRhYmxlIGNoYXJhY3RlcnMNCiAgICAiIiINCiAgICByZXR1cm4gYW55KFt4IGluIGlucHV0X3N0ciBmb3IgeCBpbiBVTklDT0RFX05PTlBSSU5UQUJMRV9DSEFSU10pDQoNCg0KZGVmIGdldF9lbnVtX3ZhbHVlcyhlbnVtX3R5cGUpOg0KICAgICIiIlJldHVybnMgZW51bSB2YWx1ZXMuIiIiDQogICAgcmV0dXJuIGZyYW1ld29yay5FbnVtLkdldFZhbHVlcyhlbnVtX3R5cGUpDQoNCg0KZGVmIGdldF9lbnVtX3ZhbHVlKGVudW1fdHlwZSwgdmFsdWVfc3RyaW5nKToNCiAgICAiIiJSZXR1cm4gZW51bSB2YWx1ZSBtYXRjaGluZyBnaXZlbiB2YWx1ZSBzdHJpbmcgKGNhc2UgaW5zZW5zaXRpdmUpLiIiIg0KICAgIGZvciBmdHlwZSBpbiBnZXRfZW51bV92YWx1ZXMoZW51bV90eXBlKToNCiAgICAgICAgaWYgc3RyKGZ0eXBlKS5sb3dlcigpID09IHZhbHVlX3N0cmluZy5sb3dlcigpOg0KICAgICAgICAgICAgcmV0dXJuIGZ0eXBlDQoNCg0KZGVmIGdldF9lbnVtX25vbmUoZW51bV90eXBlKToNCiAgICAiIiJSZXR1cm5zIHRoZSBOb25lIHZhbHVlIGluIGdpdmVuIEVudW0uIiIiDQogICAgZm9yIHZhbCBpbiBnZXRfZW51bV92YWx1ZXMoZW51bV90eXBlKToNCiAgICAgICAgaWYgc3RyKHZhbCkgPT0gJ05vbmUnOg0KICAgICAgICAgICAgcmV0dXJuIHZhbA0KDQoNCmRlZiBleHRyYWN0X2d1aWQoc291cmNlX3N0cik6DQogICAgIiIiRXh0cmFjdCBHVUlEIG51bWJlciBmcm9tIGEgc3RyaW5nLiIiIg0KICAgIGd1aWRfbWF0Y2ggPSByZS5tYXRjaCgiLiooWzAtOUEtRmEtZl17OH0iDQogICAgICAgICAgICAgICAgICAgICAgICAgICJbLV1bMC05QS1GYS1mXXs0fSINCiAgICAgICAgICAgICAgICAgICAgICAgICAgIlstXVswLTlBLUZhLWZdezR9Ig0KICAgICAgICAgICAgICAgICAgICAgICAgICAiWy1dWzAtOUEtRmEtZl17NH0iDQogICAgICAgICAgICAgICAgICAgICAgICAgICJbLV1bMC05QS1GYS1mXXsxMn0pLioiLCBzb3VyY2Vfc3RyKQ0KICAgIGlmIGd1aWRfbWF0Y2g6DQogICAgICAgIHJldHVybiBndWlkX21hdGNoLmdyb3VwcygpWzBdDQoNCg0KZGVmIGZvcm1hdF9oZXhfcmdiKHJnYl92YWx1ZSk6DQogICAgIiIiRm9ybWF0cyByZ2IgdmFsdWUgYXMgI1JHQiB2YWx1ZSBzdHJpbmcuIiIiDQogICAgaWYgaXNpbnN0YW5jZShyZ2JfdmFsdWUsIHN0cik6DQogICAgICAgIGlmIG5vdCByZ2JfdmFsdWUuc3RhcnRzd2l0aCgnIycpOg0KICAgICAgICAgICAgcmV0dXJuICcjJXMnICUgcmdiX3ZhbHVlDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByZXR1cm4gcmdiX3ZhbHVlDQogICAgZWxpZiBpc2luc3RhbmNlKHJnYl92YWx1ZSwgaW50KToNCiAgICAgICAgcmV0dXJuICcjJXgnICUgcmdiX3ZhbHVlDQoNCg0KZGVmIG5ld191dWlkKCk6DQogICAgIiIiQ3JlYXRlIGEgbmV3IFVVSUQgKHVzaW5nIGRvdG5ldCBHdWlkLk5ld0d1aWQpLiIiIg0KICAgICMgUkU6IGh0dHBzOi8vZ2l0aHViLmNvbS9laXJhbm5lamFkL3B5UmV2aXQvaXNzdWVzLzQxMw0KICAgICMgcmV0dXJuIHV1aWQudXVpZDEoKQ0KICAgIHJldHVybiBzdHIoR3VpZC5OZXdHdWlkKCkpDQoNCg0KZGVmIGlzX2JveF92aXNpYmxlX29uX3NjcmVlbnMobGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0KToNCiAgICAiIiJDaGVjayBpZiBnaXZlbiBib3ggaXMgdmlzaWJsZSBvbiBhbnkgc2NyZWVuLiIiIg0KICAgIGJvdW5kcyA9IFwNCiAgICAgICAgZnJhbWV3b3JrLkRyYXdpbmcuUmVjdGFuZ2xlKA0KICAgICAgICAgICAgZnJhbWV3b3JrLkNvbnZlcnQuVG9JbnQzMigwIGlmIG1hdGguaXNuYW4obGVmdCkgZWxzZSBsZWZ0KSwNCiAgICAgICAgICAgIGZyYW1ld29yay5Db252ZXJ0LlRvSW50MzIoMCBpZiBtYXRoLmlzbmFuKHRvcCkgZWxzZSB0b3ApLA0KICAgICAgICAgICAgZnJhbWV3b3JrLkNvbnZlcnQuVG9JbnQzMigwIGlmIG1hdGguaXNuYW4od2lkdGgpIGVsc2Ugd2lkdGgpLA0KICAgICAgICAgICAgZnJhbWV3b3JrLkNvbnZlcnQuVG9JbnQzMigwIGlmIG1hdGguaXNuYW4oaGVpZ2h0KSBlbHNlIGhlaWdodCkNCiAgICAgICAgICAgICkNCiAgICBmb3Igc2NyIGluIGZyYW1ld29yay5Gb3Jtcy5TY3JlZW4uQWxsU2NyZWVuczoNCiAgICAgICAgaWYgYm91bmRzLkludGVyc2VjdHNXaXRoKHNjci5Cb3VuZHMpOg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICByZXR1cm4gRmFsc2UNCg0KDQpkZWYgZnV6enlfc2VhcmNoX3JhdGlvKHRhcmdldF9zdHJpbmcsIHNmaWx0ZXIsIHJlZ2V4PUZhbHNlKToNCiAgICAiIiJNYXRjaCB0YXJnZXQgc3RyaW5nIGFnYWluc3QgdGhlIGZpbHRlciBhbmQgcmV0dXJuIGEgbWF0Y2ggcmF0aW8uDQoNCiAgICBBcmdzOg0KICAgICAgICB0YXJnZXRfc3RyaW5nIChzdHIpOiB0YXJnZXQgc3RyaW5nDQogICAgICAgIHNmaWx0ZXIgKHN0cik6IHNlYXJjaCB0ZXJtDQogICAgICAgIHJlZ2V4IChib29sKTogdHJlYXQgdGhlIHNmaWx0ZXIgYXMgcmVndWxhciBleHByZXNzaW9uIHBhdHRlcm4NCg0KICAgIFJldHVybnM6DQogICAgICAgIChpbnQpOiBpbnRlZ2VyIGJldHdlZW4gMCB0byAxMDAsIHdpdGggMTAwIGJlaW5nIHRoZSBleGFjdCBtYXRjaA0KICAgICIiIg0KICAgIHRzdHJpbmcgPSB0YXJnZXRfc3RyaW5nDQoNCiAgICAjIHByb2Nlc3MgcmVnZXggaGVyZS4gSXQncyBhIHllcyBubyBzaXR1YXRpb24gKDEwMCBvciAwKQ0KICAgIGlmIHJlZ2V4Og0KICAgICAgICB0cnk6DQogICAgICAgICAgICBpZiByZS5zZWFyY2goc2ZpbHRlciwgdHN0cmluZyk6DQogICAgICAgICAgICAgICAgcmV0dXJuIDEwMA0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOg0KICAgICAgICAgICAgcGFzcw0KICAgICAgICByZXR1cm4gMA0KDQogICAgIyAxMDAgZm9yIGlkZW50aWNhbCBtYXRjaGVzDQogICAgaWYgc2ZpbHRlciA9PSB0c3RyaW5nOg0KICAgICAgICByZXR1cm4gMTAwDQoNCiAgICAjIDk4IHRvIDk5IHJlc2VydmVkICgyIHNjb3JlcykNCg0KICAgICMgOTcgZm9yIGlkZW50aWNhbCBub24tY2FzZS1zZW5zaXRpdmUgbWF0Y2hlcw0KICAgIGxvd2VyX3RzdHJpbmcgPSB0c3RyaW5nLmxvd2VyKCkNCiAgICBsb3dlcl9zZmlsdGVyX3N0ciA9IHNmaWx0ZXIubG93ZXIoKQ0KICAgIGlmIGxvd2VyX3NmaWx0ZXJfc3RyID09IGxvd2VyX3RzdHJpbmc6DQogICAgICAgIHJldHVybiA5Nw0KDQogICAgIyA5NSAgdG8gOTYgcmVzZXJ2ZWQgKDIgc2NvcmVzKQ0KDQogICAgIyA5MyB0byA5NCBmb3IgaW5jbHVzaW9uIG1hdGNoZXMNCiAgICBpZiBzZmlsdGVyIGluIHRzdHJpbmc6DQogICAgICAgIHJldHVybiA5NA0KICAgIGlmIGxvd2VyX3NmaWx0ZXJfc3RyIGluIGxvd2VyX3RzdHJpbmc6DQogICAgICAgIHJldHVybiA5Mw0KDQogICAgIyA5MSAgdG8gOTIgcmVzZXJ2ZWQgKDIgc2NvcmVzKQ0KDQogICAgIyMgODAgdG8gOTAgZm9yIHBhcnRzIG1hdGNoZXMNCiAgICB0c3RyaW5nX3BhcnRzID0gdHN0cmluZy5zcGxpdCgpDQogICAgc2ZpbHRlcl9wYXJ0cyA9IHNmaWx0ZXIuc3BsaXQoKQ0KICAgIGlmIGFsbCh4IGluIHRzdHJpbmdfcGFydHMgZm9yIHggaW4gc2ZpbHRlcl9wYXJ0cyk6DQogICAgICAgIHJldHVybiA5MA0KDQogICAgIyA4OCB0byA4OSByZXNlcnZlZCAoMiBzY29yZXMpDQoNCiAgICBsb3dlcl90c3RyaW5nX3BhcnRzID0gW3gubG93ZXIoKSBmb3IgeCBpbiB0c3RyaW5nX3BhcnRzXQ0KICAgIGxvd2VyX3NmaWx0ZXJfcGFydHMgPSBbeC5sb3dlcigpIGZvciB4IGluIHNmaWx0ZXJfcGFydHNdDQogICAgIyBleGNsdWRlIG92ZXJyaWRlDQogICAgaWYgYW55KHhbMF0gPT0gJyEnIGZvciB4IGluIHNmaWx0ZXJfcGFydHMpOg0KICAgICAgICBleGNsdWRlX2luZGljZXMgPSBbDQogICAgICAgICAgICBsb3dlcl9zZmlsdGVyX3BhcnRzLmluZGV4KGkpIGZvciBpIGluIGxvd2VyX3NmaWx0ZXJfcGFydHMNCiAgICAgICAgICAgIGlmIGlbMF0gPT0gJyEnDQogICAgICAgIF0NCiAgICAgICAgZXhjbHVkZV9pbmRpY2VzLnJldmVyc2UoKQ0KICAgICAgICBleGNsdWRlX2xpc3QgPSBbDQogICAgICAgICAgICBsb3dlcl9zZmlsdGVyX3BhcnRzLnBvcChpKSBmb3IgaSBpbiBleGNsdWRlX2luZGljZXMNCiAgICAgICAgXQ0KICAgICAgICBmb3IgZSBpbiBleGNsdWRlX2xpc3Q6DQogICAgICAgICAgICAjIGRvZXNuJ3QgY29udGFpbg0KICAgICAgICAgICAgaWYgbGVuKGUpID4gMToNCiAgICAgICAgICAgICAgICBleGNsdWRlX3N0cmluZyA9IGVbMTpdDQogICAgICAgICAgICAgICAgaWYgYW55KA0KICAgICAgICAgICAgICAgICAgICAgICAgW2V4Y2x1ZGVfc3RyaW5nIGluDQogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0IGZvciBwYXJ0IGluIGxvd2VyX3RzdHJpbmdfcGFydHNdDQogICAgICAgICAgICAgICAgKToNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDANCiAgICBpZiBhbGwoeCBpbiBsb3dlcl90c3RyaW5nX3BhcnRzIGZvciB4IGluIGxvd2VyX3NmaWx0ZXJfcGFydHMpOg0KICAgICAgICByZXR1cm4gODcNCg0KICAgICMgODUgdG8gODYgcmVzZXJ2ZWQgKDIgc2NvcmVzKQ0KDQogICAgaWYgYWxsKHggaW4gdHN0cmluZyBmb3IgeCBpbiBzZmlsdGVyX3BhcnRzKToNCiAgICAgICAgcmV0dXJuIDg0DQoNCiAgICAjIDgyIHRvIDgzIHJlc2VydmVkICgyIHNjb3JlcykNCg0KICAgIGlmIGFsbCh4IGluIGxvd2VyX3RzdHJpbmcgZm9yIHggaW4gbG93ZXJfc2ZpbHRlcl9wYXJ0cyk6DQogICAgICAgIHJldHVybiA4MQ0KDQogICAgIyA4MCByZXNlcnZlZA0KDQogICAgcmV0dXJuIDANCg0KDQpkZWYgZ2V0X2V4ZV92ZXJzaW9uKGV4ZXBhdGgpOg0KICAgICIiIkV4dHJhY3QgUHJvZHVjdCBWZXJzaW9uIHZhbHVlIGZyb20gRVhFIGZpbGUuIiIiDQogICAgdmVyc2lvbl9pbmZvID0gZnJhbWV3b3JrLkRpYWdub3N0aWNzLkZpbGVWZXJzaW9uSW5mby5HZXRWZXJzaW9uSW5mbyhleGVwYXRoKQ0KICAgIHJldHVybiB2ZXJzaW9uX2luZm8uUHJvZHVjdFZlcnNpb24NCg0KDQpkZWYgZ2V0X3JlZ19rZXkoa2V5LCBzdWJrZXkpOg0KICAgICIiIkdldCB2YWx1ZSBvZiB0aGUgZ2l2ZW4gV2luZG93cyByZWdpc3RyeSBrZXkgYW5kIHN1YmtleS4NCg0KICAgIEFyZ3M6DQogICAgICAgIGtleSAoUHlIS0VZKTogcGFyZW50IHJlZ2lzdHJ5IGtleQ0KICAgICAgICBzdWJrZXkgKHN0cik6IHN1YmtleSBwYXRoDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoUHlIS0VZKTogcmVnaXN0cnkga2V5IGlmIGZvdW5kLCBOb25lIGlmIG5vdCBmb3VuZA0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBnZXRfcmVnX2tleSh3ci5IS0VZX0NVUlJFTlRfVVNFUiwgJ0NvbnRyb2wgUGFuZWwvSW50ZXJuYXRpb25hbCcpDQogICAgICAgIGBgYA0KICAgICAgICA8UHlIS0VZIGF0IDB4Li4uPg0KICAgICIiIg0KICAgIHRyeToNCiAgICAgICAgcmV0dXJuIHdyLk9wZW5LZXkoa2V5LCBzdWJrZXksIDAsIHdyLktFWV9SRUFEKQ0KICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgIHJldHVybiBOb25lDQoNCg0KZGVmIGtpbGxfdGFza3ModGFza19uYW1lKToNCiAgICAiIiJLaWxsIHJ1bm5pbmcgdGFza3MgbWF0Y2hpbmcgdGFza19uYW1lLg0KDQogICAgQXJnczoNCiAgICAgICAgdGFza19uYW1lIChzdHIpOiB0YXNrIG5hbWUNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAga2lsbF90YXNrcygnUmV2aXQuZXhlJykNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgb3Muc3lzdGVtKCJ0YXNra2lsbCAvZiAvaW0gJXMiICUgdGFza19uYW1lKQ0KDQoNCmRlZiBpbnQyaGV4X2xvbmcobnVtYmVyKToNCiAgICAiIiJJbnRlZ2VyIHRvIGhleGFkZWNpbWFsIHN0cmluZy4iIiINCiAgICAjIHB5dGhvbiAyIGZpeCBvZiBhZGRpbiAnTCcgdG8gbG9uZyBpbnRlZ2Vycw0KICAgIHJldHVybiBoZXgobnVtYmVyKS5yZXBsYWNlKCdMJywgJycpDQoNCg0KZGVmIGhleDJpbnRfbG9uZyhoZXhfc3RyaW5nKToNCiAgICAiIiJIZXhhZGVjaW1hbCBzdHJpbmcgdG8gSW50ZWdlci4iIiINCiAgICAjIHB5dGhvbiAyIGZpeCBvZiBhZGRpbiAnTCcgdG8gbG9uZyBpbnRlZ2Vycw0KICAgIGhleF9zdHJpbmcucmVwbGFjZSgnTCcsICcnKQ0KICAgIHJldHVybiBpbnQoaGV4X3N0cmluZywgMTYpDQoNCg0KZGVmIHNwbGl0X3dvcmRzKGlucHV0X3N0cmluZyk6DQogICAgIiIiU3BsaXRzIGdpdmVuIHN0cmluZyBieSB1cHBlcmNhc2UgY2hhcmFjdGVycy4NCg0KICAgIEFyZ3M6DQogICAgICAgIGlucHV0X3N0cmluZyAoc3RyKTogaW5wdXQgc3RyaW5nDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtzdHJdKTogc3BsaXQgc3RyaW5nDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIHNwbGl0X3dvcmRzKCJVSUFwcGxpY2F0aW9uX0FwcGxpY2F0aW9uQ2xvc2luZyIpDQogICAgICAgIGBgYA0KICAgICAgICBbJ1VJQXBwbGljYXRpb24nLCAnQXBwbGljYXRpb24nLCAnQ2xvc2luZyddDQogICAgIiIiDQogICAgcGFydHMgPSBbXQ0KICAgIHBhcnQgPSAiIg0KICAgIGZvciBjIGluIGlucHV0X3N0cmluZzoNCiAgICAgICAgaWYgYy5pc2FscGhhKCk6DQogICAgICAgICAgICBpZiBjLmlzdXBwZXIoKSBhbmQgcGFydCBhbmQgcGFydFstMV0uaXNsb3dlcigpOg0KICAgICAgICAgICAgICAgIGlmIHBhcnQ6DQogICAgICAgICAgICAgICAgICAgIHBhcnRzLmFwcGVuZChwYXJ0LnN0cmlwKCkpDQogICAgICAgICAgICAgICAgcGFydCA9IGMNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcGFydCArPSBjDQogICAgcGFydHMuYXBwZW5kKHBhcnQpDQogICAgcmV0dXJuIHBhcnRzDQoNCg0KZGVmIGdldF9wYXBlcl9zaXplcyhwcmludGVyX25hbWU9Tm9uZSk6DQogICAgIiIiR2V0IHBhcGVyIHNpemVzIGRlZmluZWQgb24gdGhpcyBzeXN0ZW0uDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtdKTogbGlzdCBvZiBwYXBlcnNpemUgaW5zdGFuY2VzDQogICAgIiIiDQogICAgcHJpbnRfc2V0dGluZ3MgPSBmcmFtZXdvcmsuRHJhd2luZy5QcmludGluZy5QcmludGVyU2V0dGluZ3MoKQ0KICAgIGlmIHByaW50ZXJfbmFtZToNCiAgICAgICAgcHJpbnRfc2V0dGluZ3MuUHJpbnRlck5hbWUgPSBwcmludGVyX25hbWUNCiAgICByZXR1cm4gbGlzdChwcmludF9zZXR0aW5ncy5QYXBlclNpemVzKQ0KDQoNCmRlZiBnZXRfaW50ZWdlcl9sZW5ndGgobnVtYmVyKToNCiAgICAiIiJSZXR1cm4gZGlnaXQgbGVuZ3RoIG9mIGdpdmVuIG51bWJlci4iIiINCiAgICByZXR1cm4gMSBpZiBudW1iZXIgPT0gMCBlbHNlIChtYXRoLmZsb29yKG1hdGgubG9nMTAobnVtYmVyKSkgKyAxKQ0KDQoNCmRlZiBnZXRfbXlfaXAoKToNCiAgICAiIiJSZXR1cm4gbG9jYWwgaXAgYWRkcmVzcyBvZiB0aGlzIG1hY2hpbmUuIiIiDQogICAgcmV0dXJuIHNvY2tldC5nZXRob3N0YnluYW1lKHNvY2tldC5nZXRob3N0bmFtZSgpKQ0KDQoiIiJDaGFydHMgZW5naW5lIGZvciBvdXRwdXQgd2luZG93LiIiIg0KIyBweWxpbnQ6IGRpc2FibGU9QzAxMDMNCmZyb20ganNvbiBpbXBvcnQgSlNPTkVuY29kZXINCg0KZnJvbSBweXJldml0LmNvcmV1dGlscyBpbXBvcnQgdGltZXN0YW1wLCByYW5kb21fcmdiYV9jb2xvcg0KDQojIENIQVJUU19FTkdJTkUgPSAnQ2hhcnQuanMnDQpDSEFSVFNfRU5HSU5FID0gJ0NoYXJ0LmJ1bmRsZS5qcycNCg0KIyBjaGFydC5qcyBjaGFydCB0eXBlcw0KTElORV9DSEFSVCA9ICdsaW5lJw0KQkFSX0NIQVJUID0gJ2JhcicNClJBREFSX0NIQVJUID0gJ3JhZGFyJw0KUE9MQVJfQ0hBUlQgPSAncG9sYXJBcmVhJw0KUElFX0NIQVJUID0gJ3BpZScNCkRPVUdITlVUX0NIQVJUID0gJ2RvdWdobnV0Jw0KQlVCQkxFX0NIQVJUID0gJ2J1YmJsZScNCg0KDQpDSEFSVFNfSlNfUEFUSCA9IFwNCiAgICAiaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvQ2hhcnQuanMve3ZlcnNpb259L0NoYXJ0Lm1pbi5qcyINCg0KDQpTQ1JJUFRfVEVNUExBVEUgPSBcDQogICAgInZhciBjdHggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgne2NhbnZhc19pZH0nKS5nZXRDb250ZXh0KCcyZCcpOyIgXA0KICAgICJ2YXIgY2hhcnQgPSBuZXcgQ2hhcnQoY3R4LCB7Y2FudmFzX2NvZGV9KTsiDQoNCg0KY2xhc3MgX0NoYXJ0c0RhdGFTZXRFbmNvZGUoSlNPTkVuY29kZXIpOg0KICAgICIiIkpTT04gZW5jb2RlciBmb3IgY2hhcnQgZGF0YSBzZXRzLiIiIg0KICAgIGRlZiBkZWZhdWx0KHNlbGYsIGRhdGFzZXRfb2JqKTogICMgcHlsaW50OiBkaXNhYmxlPUUwMjAyLCBXMDIyMQ0KICAgICAgICBkYXRhX2RpY3QgPSBkYXRhc2V0X29iai5fX2RpY3RfXy5jb3B5KCkNCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gZGF0YV9kaWN0Lml0ZW1zKCk6DQogICAgICAgICAgICBpZiBrZXkuc3RhcnRzd2l0aCgnXycpIG9yIHZhbHVlID09ICcnIG9yIHZhbHVlID09IFtdOg0KICAgICAgICAgICAgICAgIGRhdGFfZGljdC5wb3Aoa2V5KQ0KDQogICAgICAgIHJldHVybiBkYXRhX2RpY3QNCg0KDQpjbGFzcyBQeVJldml0T3V0cHV0Q2hhcnRPcHRpb25zKG9iamVjdCk6DQogICAgIiIiQ2hhcnQgb3B0aW9ucyB3cmFwcGVyIG9iamVjdC4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZik6DQogICAgICAgIHBhc3MNCg0KDQpjbGFzcyBQeVJldml0T3V0cHV0Q2hhcnREYXRhc2V0KG9iamVjdCk6DQogICAgIiIiQ2hhcnQgZGF0YXNldCB3cmFwcGVyIG9iamVjdC4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgbGFiZWwpOg0KICAgICAgICBzZWxmLmxhYmVsID0gbGFiZWwNCiAgICAgICAgc2VsZi5kYXRhID0gW10NCiAgICAgICAgc2VsZi5iYWNrZ3JvdW5kQ29sb3IgPSAnJw0KDQogICAgZGVmIHNldF9jb2xvcihzZWxmLCAqYXJncyk6DQogICAgICAgICIiIlNldCBkYXRhc2V0IGNvbG9yLg0KDQogICAgICAgIEFyZ3VtZW50cyBhcmUgZXhwZWN0ZWQgdG8gYmUgUiwgRywgQiwgQSB2YWx1ZXMuDQoNCiAgICAgICAgRXhhbXBsZXM6DQogICAgICAgICAgICBgYGBweXRob24NCiAgICAgICAgICAgIGRhdGFzZXRfb2JqLnNldF9jb2xvcigweEZGLCAweDhDLCAweDhELCAwLjgpDQogICAgICAgICAgICBgYGANCiAgICAgICAgIiIiDQogICAgICAgIGlmIGxlbihhcmdzKSA9PSA0Og0KICAgICAgICAgICAgc2VsZi5iYWNrZ3JvdW5kQ29sb3IgPSAncmdiYSh7fSx7fSx7fSx7fSknLmZvcm1hdChhcmdzWzBdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzWzFdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzWzJdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzWzNdKQ0KICAgICAgICBlbGlmIGxlbihhcmdzKSA9PSAxOg0KICAgICAgICAgICAgc2VsZi5iYWNrZ3JvdW5kQ29sb3IgPSAne30nLmZvcm1hdChhcmdzWzBdKQ0KDQoNCmNsYXNzIFB5UmV2aXRPdXRwdXRDaGFydERhdGEob2JqZWN0KToNCiAgICAiIiJDaGFydCBkYXRhIHdyYXBwZXIgb2JqZWN0LiIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmKToNCiAgICAgICAgc2VsZi5sYWJlbHMgPSAnJw0KICAgICAgICBzZWxmLmRhdGFzZXRzID0gW10NCg0KICAgIGRlZiBuZXdfZGF0YXNldChzZWxmLCBkYXRhc2V0X2xhYmVsKToNCiAgICAgICAgIiIiQ3JlYXRlIG5ldyBkYXRhIHNldC4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgZGF0YXNldF9sYWJlbCAoc3RyKTogZGF0YXNldCBsYWJlbA0KDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICAoUHlSZXZpdE91dHB1dENoYXJ0RGF0YXNldCk6IGRhdGFzZXQgd3JhcHBlciBvYmplY3QNCg0KICAgICAgICBFeGFtcGxlczoNCiAgICAgICAgICAgIGBgYHB5dGhvbg0KICAgICAgICAgICAgY2hhcnQuZGF0YS5uZXdfZGF0YXNldCgnc2V0X2EnKQ0KICAgICAgICAgICAgYGBgDQogICAgICAgICIiIg0KICAgICAgICBuZXdfZGF0YXNldCA9IFB5UmV2aXRPdXRwdXRDaGFydERhdGFzZXQoZGF0YXNldF9sYWJlbCkNCiAgICAgICAgc2VsZi5kYXRhc2V0cy5hcHBlbmQobmV3X2RhdGFzZXQpDQogICAgICAgIHJldHVybiBuZXdfZGF0YXNldA0KDQoNCmNsYXNzIFB5UmV2aXRPdXRwdXRDaGFydChvYmplY3QpOg0KICAgICIiIkNoYXJ0IHdyYXBwZXIgb2JqZWN0IGZvciBvdXRwdXQgd2luZG93Lg0KDQogICAgQXR0cmlidXRlczoNCiAgICAgICAgb3V0cHV0IChweXJldml0Lm91dHB1dC5QeVJldml0T3V0cHV0V2luZG93KToNCiAgICAgICAgICAgIG91dHB1dCB3aW5kb3cgd3JhcHBlciBvYmplY3QNCiAgICAgICAgY2hhcnRfdHlwZSAoc3RyKTogY2hhcnQgdHlwZSBuYW1lDQogICAgIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIG91dHB1dCwgY2hhcnRfdHlwZT1MSU5FX0NIQVJULCB2ZXJzaW9uPU5vbmUpOg0KICAgICAgICBzZWxmLl9vdXRwdXQgPSBvdXRwdXQNCiAgICAgICAgc2VsZi5fc3R5bGUgPSBOb25lDQogICAgICAgIHNlbGYuX3dpZHRoID0gc2VsZi5faGVpZ2h0ID0gTm9uZQ0KICAgICAgICBzZWxmLl92ZXJzaW9uID0gdmVyc2lvbiBvciAnMi44LjAnDQoNCiAgICAgICAgc2VsZi50eXBlID0gY2hhcnRfdHlwZQ0KICAgICAgICBzZWxmLmRhdGEgPSBQeVJldml0T3V0cHV0Q2hhcnREYXRhKCkNCg0KICAgICAgICBzZWxmLm9wdGlvbnMgPSBQeVJldml0T3V0cHV0Q2hhcnRPcHRpb25zKCkNCiAgICAgICAgIyAjIGNvbW1vbiBjaGFydCBvcHRpb25zIGFuZCB0aGVpciBkZWZhdWx0IHZhbHVlcw0KICAgICAgICAjIGNoYXJ0Lm9wdGlvbnMucmVzcG9uc2l2ZSA9IFRydWUNCiAgICAgICAgIyBjaGFydC5vcHRpb25zLnJlc3BvbnNpdmVBbmltYXRpb25EdXJhdGlvbiA9IDANCiAgICAgICAgIyBjaGFydC5vcHRpb25zLm1haW50YWluQXNwZWN0UmF0aW8gPSBUcnVlDQogICAgICAgICMNCiAgICAgICAgIyAjIGxheW91dCBvcHRpb25zDQogICAgICAgICMgY2hhcnQub3B0aW9ucy5sYXlvdXQgPSB7J3BhZGRpbmcnOiAwfQ0KICAgICAgICAjDQogICAgICAgICMgIyB0aXRsZSBvcHRpb25zDQogICAgICAgICMgIyBwb3NpdGlvbjoNCiAgICAgICAgIyAjIFBvc2l0aW9uIG9mIHRoZSB0aXRsZS4gUG9zc2libGUgdmFsdWVzIGFyZSAndG9wJywNCiAgICAgICAgIyAjICdsZWZ0JywgJ2JvdHRvbScgYW5kICdyaWdodCcuDQogICAgICAgICMgY2hhcnQub3B0aW9ucy50aXRsZSA9IHsnZGlzcGxheSc6IEZhbHNlLA0KICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgJ3Bvc2l0aW9uJzogJ3RvcCcsDQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAnZnVsbFdpZHRoJzogVHJ1ZSwNCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICdmb250U2l6ZSc6IDEyLA0KICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgJ2ZvbnRGYW1pbHknOiAnQXJpYWwnLA0KICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgJ2ZvbnRDb2xvcic6ICcjNjY2JywNCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICdmb250U3R5bGUnOiAnYm9sZCcsDQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAncGFkZGluZyc6IDEwLA0KICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgJ3RleHQnOiAnJw0KICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAjDQogICAgICAgICMgIyBsZWdlbmQgb3B0aW9ucw0KICAgICAgICAjIGNoYXJ0Lm9wdGlvbnMubGVnZW5kID0geydkaXNwbGF5JzogVHJ1ZSwNCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAncG9zaXRpb24nOiAndG9wJywNCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAnZnVsbFdpZHRoJzogVHJ1ZSwNCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAncmV2ZXJzZSc6IEZhbHNlLA0KICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbHMnOiB7J2JveFdpZHRoJzogNDAsDQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZm9udFNpemUnOiAxMiwNCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmb250U3R5bGUnOiAnbm9ybWFsJywNCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmb250Q29sb3InOiAnIzY2NicsDQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZm9udEZhbWlseSc6ICdBcmlhbCcsDQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncGFkZGluZyc6IDEwLA0KICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZVBvaW50U3R5bGUnOiBUcnVlDQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAjDQogICAgICAgICMgIyB0b29sdGlwcyBvcHRpb25zDQogICAgICAgICMgIyBpbnRlcnNlY3Q6DQogICAgICAgICMgIyBpZiB0cnVlLCB0aGUgdG9vbHRpcCBtb2RlIGFwcGxpZXMgb25seSB3aGVuIHRoZSBtb3VzZQ0KICAgICAgICAjICMgcG9zaXRpb24gaW50ZXJzZWN0cyB3aXRoIGFuIGVsZW1lbnQuDQogICAgICAgICMgIyBJZiBmYWxzZSwgdGhlIG1vZGUgd2lsbCBiZSBhcHBsaWVkIGF0IGFsbCB0aW1lcw0KICAgICAgICAjIGNoYXJ0Lm9wdGlvbnMudG9vbHRpcHMgPSB7J2VuYWJsZWQnOiBUcnVlLA0KICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ludGVyc2VjdCc6IFRydWUsDQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmFja2dyb3VuZENvbG9yJzogJ3JnYmEoMCwwLDAsMC44KScsDQogICAgICAgICMgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2FyZXRTaXplJzogNSwNCiAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICdkaXNwbGF5Q29sb3JzJzogVHJ1ZX0NCg0KICAgIGRlZiBfc2V0dXBfY2hhcnRzKHNlbGYpOg0KICAgICAgICBjdXJfaGVhZCA9IHNlbGYuX291dHB1dC5nZXRfaGVhZF9odG1sKCkNCiAgICAgICAgY2hhcnRzX2pzX3BhdGggPSBDSEFSVFNfSlNfUEFUSC5mb3JtYXQodmVyc2lvbj1zZWxmLl92ZXJzaW9uKQ0KICAgICAgICBpZiBjaGFydHNfanNfcGF0aCBub3QgaW4gY3VyX2hlYWQ6DQogICAgICAgICAgICBzZWxmLl9vdXRwdXQuaW5qZWN0X3NjcmlwdCgnJywgeydzcmMnOiBjaGFydHNfanNfcGF0aH0pDQoNCiAgICBAc3RhdGljbWV0aG9kDQogICAgZGVmIF9tYWtlX2NhbnZhc191bmlxdWVfaWQoKToNCiAgICAgICAgcmV0dXJuICdjaGFydHt9Jy5mb3JtYXQodGltZXN0YW1wKCkpDQoNCiAgICBkZWYgX21ha2VfY2FudmFzX2NvZGUoc2VsZiwgY2FudmFzX2lkKToNCiAgICAgICAgYXR0cmlicyA9ICcnDQogICAgICAgIGF0dHJpYnMgKz0gJyBpZD0ie30iJy5mb3JtYXQoY2FudmFzX2lkKQ0KICAgICAgICBpZiBzZWxmLl9zdHlsZToNCiAgICAgICAgICAgIGF0dHJpYnMgKz0gJyBzdHlsZT0ie30iJy5mb3JtYXQoc2VsZi5fc3R5bGUpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBpZiBzZWxmLl93aWR0aDoNCiAgICAgICAgICAgICAgICBhdHRyaWJzICs9ICcgd2lkdGg9Int9cHgiJy5mb3JtYXQoc2VsZi5fd2lkdGgpDQogICAgICAgICAgICBpZiBzZWxmLl9oZWlnaHQ6DQogICAgICAgICAgICAgICAgYXR0cmlicyArPSAnIGhlaWdodD0ie31weCInLmZvcm1hdChzZWxmLl9oZWlnaHQpDQoNCiAgICAgICAgcmV0dXJuICc8Y2FudmFzIHt9PjwvY2FudmFzPicuZm9ybWF0KGF0dHJpYnMpDQoNCiAgICBkZWYgX21ha2VfY2hhcnRzX3NjcmlwdChzZWxmLCBjYW52YXNfaWQpOg0KICAgICAgICByZXR1cm4gU0NSSVBUX1RFTVBMQVRFLmZvcm1hdCgNCiAgICAgICAgICAgIGNhbnZhc19pZD1jYW52YXNfaWQsDQogICAgICAgICAgICBjYW52YXNfY29kZT1fQ2hhcnRzRGF0YVNldEVuY29kZSgpLmVuY29kZShzZWxmKSkNCg0KICAgIGRlZiByYW5kb21pemVfY29sb3JzKHNlbGYpOg0KICAgICAgICAiIiJSYW5kb21pemUgY2hhcnQgZGF0YXNldHMgY29sb3JzLiIiIg0KICAgICAgICBpZiBzZWxmLnR5cGUgaW4gW1BPTEFSX0NIQVJULCBQSUVfQ0hBUlQsIERPVUdITlVUX0NIQVJUXToNCiAgICAgICAgICAgIGZvciBkYXRhc2V0IGluIHNlbGYuZGF0YS5kYXRhc2V0czoNCiAgICAgICAgICAgICAgICBkYXRhc2V0LmJhY2tncm91bmRDb2xvciA9IFtyYW5kb21fcmdiYV9jb2xvcigpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UoMCwgbGVuKGRhdGFzZXQuZGF0YSkpXQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgZm9yIGRhdGFzZXQgaW4gc2VsZi5kYXRhLmRhdGFzZXRzOg0KICAgICAgICAgICAgICAgIGRhdGFzZXQuYmFja2dyb3VuZENvbG9yID0gcmFuZG9tX3JnYmFfY29sb3IoKQ0KDQogICAgZGVmIHNldF93aWR0aChzZWxmLCB3aWR0aCk6DQogICAgICAgICIiIlNldCBjaGFydCB3aWR0aCBvbiBvdXRwdXQgd2luZG93LiIiIg0KICAgICAgICBzZWxmLl93aWR0aCA9IHdpZHRoDQoNCiAgICBkZWYgc2V0X2hlaWdodChzZWxmLCBoZWlnaHQpOg0KICAgICAgICAiIiJTZXQgY2hhcnQgaGVpZ2h0IG9uIG91dHB1dCB3aW5kb3cuIiIiDQogICAgICAgIHNlbGYuX2hlaWdodCA9IGhlaWdodA0KDQogICAgZGVmIHNldF9zdHlsZShzZWxmLCBodG1sX3N0eWxlKToNCiAgICAgICAgIiIiU2V0IGNoYXJ0IHN0eWxpbmcuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIGh0bWxfc3R5bGUgKHN0cik6IGlubGluZSBodG1sIGNzcyBzdHlsaW5nIHN0cmluZw0KDQogICAgICAgIEV4YW1wbGVzOg0KICAgICAgICAgICAgYGBgcHl0aG9uDQogICAgICAgICAgICBjaGFydC5zZXRfc3R5bGUoJ2hlaWdodDoxNTBweCcpDQogICAgICAgICAgICBgYGANCiAgICAgICAgIiIiDQogICAgICAgIHNlbGYuX3N0eWxlID0gaHRtbF9zdHlsZQ0KDQogICAgZGVmIGRyYXcoc2VsZik6DQogICAgICAgICIiIlJlcXVlc3QgY2hhcnQgdG8gZHJhdyBpdHNlbGYgb24gb3V0cHV0IHdpbmRvdy4iIiINCiAgICAgICAgc2VsZi5fc2V0dXBfY2hhcnRzKCkNCiAgICAgICAgIyBzZXR1cCBjYW52YXMNCiAgICAgICAgY2FudmFzX2lkID0gc2VsZi5fbWFrZV9jYW52YXNfdW5pcXVlX2lkKCkNCiAgICAgICAgY2FudmFzX2NvZGUgPSBzZWxmLl9tYWtlX2NhbnZhc19jb2RlKGNhbnZhc19pZCkNCiAgICAgICAgc2VsZi5fb3V0cHV0LnByaW50X2h0bWwoY2FudmFzX2NvZGUpDQogICAgICAgICMgbWFrZSB0aGUgY29kZQ0KICAgICAgICBqc19jb2RlID0gc2VsZi5fbWFrZV9jaGFydHNfc2NyaXB0KGNhbnZhc19pZCkNCiAgICAgICAgc2VsZi5fb3V0cHV0LmluamVjdF9zY3JpcHQoanNfY29kZSwgYm9keT1UcnVlKQ0KDQoiIiJCYXNlIG1vZHVsZSBmb3IgcHlSZXZpdCBjb25maWcgcGFyc2luZy4iIiINCmltcG9ydCBqc29uDQppbXBvcnQgY29kZWNzDQpmcm9tIHB5cmV2aXQuY29tcGF0IGltcG9ydCBjb25maWdwYXJzZXINCg0KZnJvbSBweXJldml0IGltcG9ydCBQeVJldml0RXhjZXB0aW9uLCBQeVJldml0SU9FcnJvcg0KZnJvbSBweXJldml0IGltcG9ydCBjb3JldXRpbHMNCg0KI3B5bGludDogZGlzYWJsZT1XMDcwMyxDMDMwMg0KS0VZX1ZBTFVFX1RSVUUgPSAiVHJ1ZSINCktFWV9WQUxVRV9GQUxTRSA9ICJGYWxzZSINCg0KDQpjbGFzcyBQeVJldml0Q29uZmlnU2VjdGlvblBhcnNlcihvYmplY3QpOg0KICAgICIiIkNvbmZpZyBzZWN0aW9uIHBhcnNlciBvYmplY3QuIEhhbmRsZSBzZWN0aW9uIG9wdGlvbnMuIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZ19wYXJzZXIsIHNlY3Rpb25fbmFtZSk6DQogICAgICAgIHNlbGYuX3BhcnNlciA9IGNvbmZpZ19wYXJzZXINCiAgICAgICAgc2VsZi5fc2VjdGlvbl9uYW1lID0gc2VjdGlvbl9uYW1lDQoNCiAgICBkZWYgX19pdGVyX18oc2VsZik6DQogICAgICAgIHJldHVybiBpdGVyKHNlbGYuX3BhcnNlci5vcHRpb25zKHNlbGYuX3NlY3Rpb25fbmFtZSkpDQoNCiAgICBkZWYgX19zdHJfXyhzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuX3NlY3Rpb25fbmFtZQ0KDQogICAgZGVmIF9fcmVwcl9fKHNlbGYpOg0KICAgICAgICByZXR1cm4gJzxQeVJldml0Q29uZmlnU2VjdGlvblBhcnNlciBvYmplY3QgJyAgICBcDQogICAgICAgICAgICAgICAnYXQgMHh7MDowMTZ4fSAnICAgICAgICAgICAgICAgICAgICAgICAgIFwNCiAgICAgICAgICAgICAgICdjb25maWcgc2VjdGlvbiBcJ3sxfVwnPicgICAgICAgICAgICAgICAgXA0KICAgICAgICAgICAgICAgLmZvcm1hdChpZChzZWxmKSwgc2VsZi5fc2VjdGlvbl9uYW1lKQ0KDQogICAgZGVmIF9fZ2V0YXR0cl9fKHNlbGYsIHBhcmFtX25hbWUpOg0KICAgICAgICB0cnk6DQogICAgICAgICAgICB2YWx1ZSA9IHNlbGYuX3BhcnNlci5nZXQoc2VsZi5fc2VjdGlvbl9uYW1lLCBwYXJhbV9uYW1lKQ0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHModmFsdWUpICAjcHlsaW50OiBkaXNhYmxlPVcwMTIzDQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoNCiAgICAgICAgICAgICAgICAgICAgIyB0cnkgZml4IGxlZ2FjeSBmb3JtYXRzDQogICAgICAgICAgICAgICAgICAgICMgY2xlYW51cCBweXRob24gc3R5bGUgdHJ1ZSwgZmFsc2UgdmFsdWVzDQogICAgICAgICAgICAgICAgICAgIGlmIHZhbHVlID09IEtFWV9WQUxVRV9UUlVFOg0KICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBqc29uLmR1bXBzKFRydWUpDQogICAgICAgICAgICAgICAgICAgIGVsaWYgdmFsdWUgPT0gS0VZX1ZBTFVFX0ZBTFNFOg0KICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBqc29uLmR1bXBzKEZhbHNlKQ0KICAgICAgICAgICAgICAgICAgICAjIGNsZWFudXAgc3RyaW5nIHJlcHJlc2VudGF0aW9ucw0KICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoJ1wnJywgJyInKS5lbmNvZGUoJ3N0cmluZy1lc2NhcGUnKQ0KICAgICAgICAgICAgICAgICAgICAjIHRyeSBwYXJzaW5nIGFnYWluDQogICAgICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmxvYWRzKHZhbHVlKSAgI3B5bGludDogZGlzYWJsZT1XMDEyMw0KICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOg0KICAgICAgICAgICAgICAgICAgICAgICAgIyBpZiBmYWlsZWQgYWdhaW4gdGhlbiB0aGUgdmFsdWUgaXMgYSBzdHJpbmcNCiAgICAgICAgICAgICAgICAgICAgICAgICMgYnV0IGlzIG5vdCBlbmNhcHN1bGF0ZWQgaW4gcXVvdGVzDQogICAgICAgICAgICAgICAgICAgICAgICAjIGUuZy4gb3B0aW9uID0gQzpcVXNlcnNcRGVza3RvcA0KICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zdHJpcCgpDQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgdmFsdWUuc3RhcnRzd2l0aCgnKCcpIFwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3Igbm90IHZhbHVlLnN0YXJ0c3dpdGgoJ1snKSBcDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yIG5vdCB2YWx1ZS5zdGFydHN3aXRoKCd7Jyk6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSAiXCIlc1wiIiAlIHZhbHVlDQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2Fkcyh2YWx1ZSkgICNweWxpbnQ6IGRpc2FibGU9VzAxMjMNCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlDQogICAgICAgIGV4Y2VwdCAoY29uZmlncGFyc2VyLk5vT3B0aW9uRXJyb3IsIGNvbmZpZ3BhcnNlci5Ob1NlY3Rpb25FcnJvcik6DQogICAgICAgICAgICByYWlzZSBBdHRyaWJ1dGVFcnJvcignUGFyYW1ldGVyIGRvZXMgbm90IGV4aXN0IGluIGNvbmZpZyBmaWxlOiB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQocGFyYW1fbmFtZSkpDQoNCiAgICBkZWYgX19zZXRhdHRyX18oc2VsZiwgcGFyYW1fbmFtZSwgdmFsdWUpOg0KICAgICAgICAjIGNoZWNrIGFnYWlzdCB1c2VkIGF0dHJpYnV0ZSBuYW1lcw0KICAgICAgICBpZiBwYXJhbV9uYW1lIGluIFsnX3BhcnNlcicsICdfc2VjdGlvbl9uYW1lJ106DQogICAgICAgICAgICBzdXBlcihQeVJldml0Q29uZmlnU2VjdGlvblBhcnNlciwgc2VsZikuX19zZXRhdHRyX18ocGFyYW1fbmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgICMgaWYgbm90IHVzZWQgYnkgdGhpcyBvYmplY3QsIHRoZW4gc2V0IGEgY29uZmlnIHNlY3Rpb24NCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fcGFyc2VyLnNldChzZWxmLl9zZWN0aW9uX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1fbmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqc29uLmR1bXBzKHZhbHVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VwYXJhdG9ycz0oJywnLCAnOicpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5zdXJlX2FzY2lpPUZhbHNlKSkNCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgc2V0X2VycjoNCiAgICAgICAgICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKCdFcnJvciBzZXR0aW5nIHBhcmFtZXRlciB2YWx1ZS4gJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wge30nLmZvcm1hdChzZXRfZXJyKSkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBoZWFkZXIoc2VsZik6DQogICAgICAgICIiIlNlY3Rpb24gaGVhZGVyLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5fc2VjdGlvbl9uYW1lDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgc3ViaGVhZGVyKHNlbGYpOg0KICAgICAgICAiIiJTZWN0aW9uIHN1Yi1oZWFkZXIgZS5nLiBTZWN0aW9uLlN1YlNlY3Rpb24uIiIiDQogICAgICAgIHJldHVybiBjb3JldXRpbHMuZ2V0X2Nhbm9uaWNhbF9wYXJ0cyhzZWxmLmhlYWRlcilbLTFdDQoNCiAgICBkZWYgaGFzX29wdGlvbihzZWxmLCBvcHRpb25fbmFtZSk6DQogICAgICAgICIiIkNoZWNrIGlmIHNlY3Rpb24gY29udGFpbnMgZ2l2ZW4gb3B0aW9uLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5fcGFyc2VyLmhhc19vcHRpb24oc2VsZi5fc2VjdGlvbl9uYW1lLCBvcHRpb25fbmFtZSkNCg0KICAgIGRlZiBnZXRfb3B0aW9uKHNlbGYsIG9wX25hbWUsIGRlZmF1bHRfdmFsdWU9Tm9uZSk6DQogICAgICAgICIiIkdldCBvcHRpb24gdmFsdWUgb3IgcmV0dXJuIGRlZmF1bHQuIiIiDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9fZ2V0YXR0cl9fKG9wX25hbWUpDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgb3B0X2dldF9lcnI6DQogICAgICAgICAgICBpZiBkZWZhdWx0X3ZhbHVlIGlzIG5vdCBOb25lOg0KICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0X3ZhbHVlDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHJhaXNlIG9wdF9nZXRfZXJyDQoNCiAgICBkZWYgc2V0X29wdGlvbihzZWxmLCBvcF9uYW1lLCB2YWx1ZSk6DQogICAgICAgICIiIlNldCB2YWx1ZSBvZiBnaXZlbiBvcHRpb24uIiIiDQogICAgICAgIHNlbGYuX19zZXRhdHRyX18ob3BfbmFtZSwgdmFsdWUpDQoNCiAgICBkZWYgcmVtb3ZlX29wdGlvbihzZWxmLCBvcHRpb25fbmFtZSk6DQogICAgICAgICIiIlJlbW92ZSBnaXZlbiBvcHRpb24gZnJvbSBzZWN0aW9uLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5fcGFyc2VyLnJlbW92ZV9vcHRpb24oc2VsZi5fc2VjdGlvbl9uYW1lLCBvcHRpb25fbmFtZSkNCg0KICAgIGRlZiBoYXNfc3Vic2VjdGlvbihzZWxmLCBzZWN0aW9uX25hbWUpOg0KICAgICAgICAiIiJDaGVjayBpZiBzZWN0aW9uIGhhcyBhbnkgc3Vic2VjdGlvbnMuIiIiDQogICAgICAgIHJldHVybiBUcnVlIGlmIHNlbGYuZ2V0X3N1YnNlY3Rpb24oc2VjdGlvbl9uYW1lKSBlbHNlIEZhbHNlDQoNCiAgICBkZWYgYWRkX3N1YnNlY3Rpb24oc2VsZiwgc2VjdGlvbl9uYW1lKToNCiAgICAgICAgIiIiQWRkIHN1YnNlY3Rpb24gdG8gc2VjdGlvbi4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuX3BhcnNlci5hZGRfc2VjdGlvbigNCiAgICAgICAgICAgIGNvcmV1dGlscy5tYWtlX2Nhbm9uaWNhbF9uYW1lKHNlbGYuX3NlY3Rpb25fbmFtZSwgc2VjdGlvbl9uYW1lKQ0KICAgICAgICApDQoNCiAgICBkZWYgZ2V0X3N1YnNlY3Rpb25zKHNlbGYpOg0KICAgICAgICAiIiJHZXQgYWxsIHN1YnNlY3Rpb25zLiIiIg0KICAgICAgICBzdWJzZWN0aW9ucyA9IFtdDQogICAgICAgIGZvciBzZWN0aW9uX25hbWUgaW4gc2VsZi5fcGFyc2VyLnNlY3Rpb25zKCk6DQogICAgICAgICAgICBpZiBzZWN0aW9uX25hbWUuc3RhcnRzd2l0aChzZWxmLl9zZWN0aW9uX25hbWUgKyAnLicpOg0KICAgICAgICAgICAgICAgIHN1YnNlYyA9IFB5UmV2aXRDb25maWdTZWN0aW9uUGFyc2VyKHNlbGYuX3BhcnNlciwgc2VjdGlvbl9uYW1lKQ0KICAgICAgICAgICAgICAgIHN1YnNlY3Rpb25zLmFwcGVuZChzdWJzZWMpDQogICAgICAgIHJldHVybiBzdWJzZWN0aW9ucw0KDQogICAgZGVmIGdldF9zdWJzZWN0aW9uKHNlbGYsIHNlY3Rpb25fbmFtZSk6DQogICAgICAgICIiIkdldCBzdWJzZWN0aW9uIHdpdGggZ2l2ZW4gbmFtZS4iIiINCiAgICAgICAgZm9yIHN1YnNlY3Rpb24gaW4gc2VsZi5nZXRfc3Vic2VjdGlvbnMoKToNCiAgICAgICAgICAgIGlmIHN1YnNlY3Rpb24uc3ViaGVhZGVyID09IHNlY3Rpb25fbmFtZToNCiAgICAgICAgICAgICAgICByZXR1cm4gc3Vic2VjdGlvbg0KDQoNCmNsYXNzIFB5UmV2aXRDb25maWdQYXJzZXIob2JqZWN0KToNCiAgICAiIiJDb25maWcgcGFyc2VyIG9iamVjdC4gSGFuZGxlIGNvbmZpZyBzZWN0aW9ucyBhbmQgaW8uIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNmZ19maWxlX3BhdGg9Tm9uZSk6DQogICAgICAgIHNlbGYuX2NmZ19maWxlX3BhdGggPSBjZmdfZmlsZV9wYXRoDQogICAgICAgIHNlbGYuX3BhcnNlciA9IGNvbmZpZ3BhcnNlci5Db25maWdQYXJzZXIoKQ0KICAgICAgICBpZiBzZWxmLl9jZmdfZmlsZV9wYXRoOg0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgIHdpdGggY29kZWNzLm9wZW4oc2VsZi5fY2ZnX2ZpbGVfcGF0aCwgJ3InLCAndXRmLTgnKSBhcyBjZmdfZmlsZToNCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcGFyc2VyLnJlYWRmcChjZmdfZmlsZSkNCiAgICAgICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgSU9FcnJvcik6DQogICAgICAgICAgICAgICAgcmFpc2UgUHlSZXZpdElPRXJyb3IoKQ0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyByZWFkX2VycjoNCiAgICAgICAgICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKHJlYWRfZXJyKQ0KDQogICAgZGVmIF9faXRlcl9fKHNlbGYpOg0KICAgICAgICByZXR1cm4gaXRlcihbc2VsZi5nZXRfc2VjdGlvbih4KSBmb3IgeCBpbiBzZWxmLl9wYXJzZXIuc2VjdGlvbnMoKV0pDQoNCiAgICBkZWYgX19nZXRhdHRyX18oc2VsZiwgc2VjdGlvbl9uYW1lKToNCiAgICAgICAgaWYgc2VsZi5fcGFyc2VyLmhhc19zZWN0aW9uKHNlY3Rpb25fbmFtZSk6DQogICAgICAgICAgICAjIGJ1aWxkIGEgc2VjdGlvbiBwYXJzZXIgb2JqZWN0IGFuZCByZXR1cm4NCiAgICAgICAgICAgIHJldHVybiBQeVJldml0Q29uZmlnU2VjdGlvblBhcnNlcihzZWxmLl9wYXJzZXIsIHNlY3Rpb25fbmFtZSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJhaXNlIEF0dHJpYnV0ZUVycm9yKA0KICAgICAgICAgICAgICAgICdTZWN0aW9uIFwie31cIiBkb2VzIG5vdCBleGlzdCBpbiBjb25maWcgZmlsZS4nDQogICAgICAgICAgICAgICAgLmZvcm1hdChzZWN0aW9uX25hbWUpKQ0KDQogICAgZGVmIGdldF9jb25maWdfZmlsZV9oYXNoKHNlbGYpOg0KICAgICAgICAiIiJHZXQgY2FsY3VsYXRlZCB1bmlxdWUgaGFzaCBmb3IgdGhpcyBjb25maWcuDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChzdHIpOiBoYXNoIG9mIHRoZSBjb25maWcuDQogICAgICAgICIiIg0KICAgICAgICB3aXRoIGNvZGVjcy5vcGVuKHNlbGYuX2NmZ19maWxlX3BhdGgsICdyJywgJ3V0Zi04JykgYXMgY2ZnX2ZpbGU6DQogICAgICAgICAgICBjZmdfaGFzaCA9IGNvcmV1dGlscy5nZXRfc3RyX2hhc2goY2ZnX2ZpbGUucmVhZCgpKQ0KDQogICAgICAgIHJldHVybiBjZmdfaGFzaA0KDQogICAgZGVmIGhhc19zZWN0aW9uKHNlbGYsIHNlY3Rpb25fbmFtZSk6DQogICAgICAgICIiIkNoZWNrIGlmIGNvbmZpZyBjb250YWlucyBnaXZlbiBzZWN0aW9uLiIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBzZWxmLmdldF9zZWN0aW9uKHNlY3Rpb25fbmFtZSkNCiAgICAgICAgICAgIHJldHVybiBUcnVlDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgIGRlZiBhZGRfc2VjdGlvbihzZWxmLCBzZWN0aW9uX25hbWUpOg0KICAgICAgICAiIiJBZGQgc2VjdGlvbiB3aXRoIGdpdmVuIG5hbWUgdG8gY29uZmlnLiIiIg0KICAgICAgICBzZWxmLl9wYXJzZXIuYWRkX3NlY3Rpb24oc2VjdGlvbl9uYW1lKQ0KICAgICAgICByZXR1cm4gUHlSZXZpdENvbmZpZ1NlY3Rpb25QYXJzZXIoc2VsZi5fcGFyc2VyLCBzZWN0aW9uX25hbWUpDQoNCiAgICBkZWYgZ2V0X3NlY3Rpb24oc2VsZiwgc2VjdGlvbl9uYW1lKToNCiAgICAgICAgIiIiR2V0IHNlY3Rpb24gd2l0aCBnaXZlbiBuYW1lLg0KDQogICAgICAgIFJhaXNlczoNCiAgICAgICAgICAgIEF0dHJpYnV0ZUVycm9yOiBpZiBzZWN0aW9uIGlzIG1pc3NpbmcNCiAgICAgICAgIiIiDQogICAgICAgICMgY2hlY2sgaXMgc2VjdGlvbiB3aXRoIGZ1bGwgbmFtZSBpcyBhdmFpbGFibGUNCiAgICAgICAgaWYgc2VsZi5fcGFyc2VyLmhhc19zZWN0aW9uKHNlY3Rpb25fbmFtZSk6DQogICAgICAgICAgICByZXR1cm4gUHlSZXZpdENvbmZpZ1NlY3Rpb25QYXJzZXIoc2VsZi5fcGFyc2VyLCBzZWN0aW9uX25hbWUpDQoNCiAgICAgICAgIyBpZiBub3QgdHJ5IHRvIG1hdGNoIHdpdGggc2VjdGlvbl9uYW1lLnN1YnNlY3Rpb24NCiAgICAgICAgIyBpZiB0aGVyZSBpcyBhIHNlY3Rpb25fbmFtZS5zdWJzZWN0aW9uIGRlZmluZWQsIHRoYXQgc2hvdWxkIGJlDQogICAgICAgICMgdGhlIHNpZ24gdGhhdCB0aGUgc2VjdGlvbiBleGlzdHMNCiAgICAgICAgIyBzZWN0aW9uIG9iaiB0aGVuIHN1cHBvcnRzIGdldHRpbmcgYWxsIHN1YnNlY3Rpb25zDQogICAgICAgIGZvciBjZmdfc2VjdGlvbl9uYW1lIGluIHNlbGYuX3BhcnNlci5zZWN0aW9ucygpOg0KICAgICAgICAgICAgbWFzdGVyX3NlY3Rpb24gPSBjb3JldXRpbHMuZ2V0X2Nhbm9uaWNhbF9wYXJ0cyhjZmdfc2VjdGlvbl9uYW1lKVswXQ0KICAgICAgICAgICAgaWYgc2VjdGlvbl9uYW1lID09IG1hc3Rlcl9zZWN0aW9uOg0KICAgICAgICAgICAgICAgIHJldHVybiBQeVJldml0Q29uZmlnU2VjdGlvblBhcnNlcihzZWxmLl9wYXJzZXIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hc3Rlcl9zZWN0aW9uKQ0KDQogICAgICAgICMgaWYgbm8gbWF0Y2ggaGFwcGVuZWQgdGhlbiByYWlzZSBleGNlcHRpb24NCiAgICAgICAgcmFpc2UgQXR0cmlidXRlRXJyb3IoJ1NlY3Rpb24gZG9lcyBub3QgZXhpc3QgaW4gY29uZmlnIGZpbGUuJykNCg0KICAgIGRlZiByZW1vdmVfc2VjdGlvbihzZWxmLCBzZWN0aW9uX25hbWUpOg0KICAgICAgICAiIiJSZW1vdmUgc2VjdGlvbiBmcm9tIGNvbmZpZy4iIiINCiAgICAgICAgY2ZnX3NlY3Rpb24gPSBzZWxmLmdldF9zZWN0aW9uKHNlY3Rpb25fbmFtZSkNCiAgICAgICAgZm9yIGNmZ19zdWJzZWN0aW9uIGluIGNmZ19zZWN0aW9uLmdldF9zdWJzZWN0aW9ucygpOg0KICAgICAgICAgICAgc2VsZi5fcGFyc2VyLnJlbW92ZV9zZWN0aW9uKGNmZ19zdWJzZWN0aW9uLmhlYWRlcikNCiAgICAgICAgc2VsZi5fcGFyc2VyLnJlbW92ZV9zZWN0aW9uKGNmZ19zZWN0aW9uLmhlYWRlcikNCg0KICAgIGRlZiByZWxvYWQoc2VsZiwgY2ZnX2ZpbGVfcGF0aD1Ob25lKToNCiAgICAgICAgIiIiUmVsb2FkIGNvbmZpZyBmcm9tIG9yaWdpbmFsIG9yIGdpdmVuIGZpbGUuIiIiDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHdpdGggY29kZWNzLm9wZW4oY2ZnX2ZpbGVfcGF0aCBcDQogICAgICAgICAgICAgICAgICAgIG9yIHNlbGYuX2NmZ19maWxlX3BhdGgsICdyJywgJ3V0Zi04JykgYXMgY2ZnX2ZpbGU6DQogICAgICAgICAgICAgICAgc2VsZi5fcGFyc2VyLnJlYWRmcChjZmdfZmlsZSkNCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBJT0Vycm9yKToNCiAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRJT0Vycm9yKCkNCg0KICAgIGRlZiBzYXZlKHNlbGYsIGNmZ19maWxlX3BhdGg9Tm9uZSk6DQogICAgICAgICIiIlNhdmUgY29uZmlnIHRvIG9yaWdpbmFsIG9yIGdpdmVuIGZpbGUuIiIiDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHdpdGggY29kZWNzLm9wZW4oY2ZnX2ZpbGVfcGF0aCBcDQogICAgICAgICAgICAgICAgICAgIG9yIHNlbGYuX2NmZ19maWxlX3BhdGgsICd3JywgJ3V0Zi04JykgYXMgY2ZnX2ZpbGU6DQogICAgICAgICAgICAgICAgc2VsZi5fcGFyc2VyLndyaXRlKGNmZ19maWxlKQ0KICAgICAgICBleGNlcHQgKE9TRXJyb3IsIElPRXJyb3IpOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdElPRXJyb3IoKQ0KDQoiIiJCYXNlIG1vZHVsZSB0byBpbnRlcmFjdCB3aXRoIFJldml0IHJpYmJvbi4iIiINCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IE9yZGVyZWREaWN0DQoNCiNweWxpbnQ6IGRpc2FibGU9VzA3MDMsQzAzMDIsQzAxMDMNCmZyb20gcHlyZXZpdCBpbXBvcnQgSE9TVF9BUFAsIEVYRUNfUEFSQU1TLCBQeVJldml0RXhjZXB0aW9uDQpmcm9tIHB5cmV2aXQuY29tcGF0IGltcG9ydCBzYWZlX3N0cnR5cGUNCmZyb20gcHlyZXZpdCBpbXBvcnQgY29yZXV0aWxzDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzLmxvZ2dlciBpbXBvcnQgZ2V0X2xvZ2dlcg0KZnJvbSBweXJldml0LmNvcmV1dGlscyBpbXBvcnQgZW52dmFycw0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgU3lzdGVtLCBVcmksIFdpbmRvd3MNCmZyb20gcHlyZXZpdC5mcmFtZXdvcmsgaW1wb3J0IElPDQpmcm9tIHB5cmV2aXQuZnJhbWV3b3JrIGltcG9ydCBJbWFnaW5nDQpmcm9tIHB5cmV2aXQuZnJhbWV3b3JrIGltcG9ydCBCaW5kaW5nRmxhZ3MNCmZyb20gcHlyZXZpdC5mcmFtZXdvcmsgaW1wb3J0IE1lZGlhLCBDb252ZXJ0DQpmcm9tIHB5cmV2aXQuYXBpIGltcG9ydCBVSSwgQWRXaW5kb3dzLCBBZEludGVybmFsDQpmcm9tIHB5cmV2aXQucnVudGltZSBpbXBvcnQgdHlwZXMNCmZyb20gcHlyZXZpdC5yZXZpdCBpbXBvcnQgdWkNCg0KDQptbG9nZ2VyID0gZ2V0X2xvZ2dlcihfX25hbWVfXykNCg0KDQpQWVJFVklUX1RBQl9JREVOVElGSUVSID0gJ3B5cmV2aXRfdGFiJw0KDQpJQ09OX1NNQUxMID0gMTYNCklDT05fTUVESVVNID0gMjQNCklDT05fTEFSR0UgPSAzMg0KDQpERUZBVUxUX0RQSSA9IDk2DQoNCkRFRkFVTFRfVE9PTFRJUF9JTUFHRV9GT1JNQVQgPSAnLnBuZycNCkRFRkFVTFRfVE9PTFRJUF9WSURFT19GT1JNQVQgPSAnLnN3ZicNCmlmIG5vdCBFWEVDX1BBUkFNUy5kb2NfbW9kZSBhbmQgSE9TVF9BUFAuaXNfbmV3ZXJfdGhhbigyMDE5LCBvcl9lcXVhbD1UcnVlKToNCiAgICBERUZBVUxUX1RPT0xUSVBfVklERU9fRk9STUFUID0gJy5tcDQnDQoNCg0KZGVmIGFyZ2JfdG9fYnJ1c2goYXJnYl9jb2xvcik6DQogICAgIyBhcmdiX2NvbG9yIGlzIGZvcm1hdHRlZCBhcyAjQUFSUkdHQkINCiAgICBhID0gciA9IGcgPSBiID0gIkZGIg0KICAgIHRyeToNCiAgICAgICAgYiA9IGFyZ2JfY29sb3JbLTI6XQ0KICAgICAgICBnID0gYXJnYl9jb2xvclstNDotMl0NCiAgICAgICAgciA9IGFyZ2JfY29sb3JbLTY6LTRdDQogICAgICAgIGlmIGxlbihhcmdiX2NvbG9yKSA+IDc6DQogICAgICAgICAgICBhID0gYXJnYl9jb2xvclstODotNl0NCiAgICAgICAgcmV0dXJuIE1lZGlhLlNvbGlkQ29sb3JCcnVzaChNZWRpYS5Db2xvci5Gcm9tQXJnYigNCiAgICAgICAgICAgICAgICBDb252ZXJ0LlRvSW50MzIoIjB4IiArIGEsIDE2KSwNCiAgICAgICAgICAgICAgICBDb252ZXJ0LlRvSW50MzIoIjB4IiArIHIsIDE2KSwNCiAgICAgICAgICAgICAgICBDb252ZXJ0LlRvSW50MzIoIjB4IiArIGcsIDE2KSwNCiAgICAgICAgICAgICAgICBDb252ZXJ0LlRvSW50MzIoIjB4IiArIGIsIDE2KQ0KICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICkNCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGNvbG9yX2V4Og0KICAgICAgICBtbG9nZ2VyLmVycm9yKCJCYWQgY29sb3IgZm9ybWF0ICVzIHwgJXMiLCBhcmdiX2NvbG9yLCBjb2xvcl9leCkNCg0KDQpkZWYgbG9hZF9iaXRtYXBpbWFnZShpbWFnZV9maWxlKToNCiAgICAiIiJMb2FkIGdpdmVuIHBuZyBmaWxlLg0KDQogICAgQXJnczoNCiAgICAgICAgaW1hZ2VfZmlsZSAoc3RyKTogaW1hZ2UgZmlsZSBwYXRoDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoSW1hZ2luZy5CaXRtYXBJbWFnZSk6IGJpdG1hcCBpbWFnZSBvYmplY3QNCiAgICAiIiINCiAgICBiaXRtYXAgPSBJbWFnaW5nLkJpdG1hcEltYWdlKCkNCiAgICBiaXRtYXAuQmVnaW5Jbml0KCkNCiAgICBiaXRtYXAuVXJpU291cmNlID0gVXJpKGltYWdlX2ZpbGUpDQogICAgYml0bWFwLkNhY2hlT3B0aW9uID0gSW1hZ2luZy5CaXRtYXBDYWNoZU9wdGlvbi5PbkxvYWQNCiAgICBiaXRtYXAuQ3JlYXRlT3B0aW9ucyA9IEltYWdpbmcuQml0bWFwQ3JlYXRlT3B0aW9ucy5JZ25vcmVJbWFnZUNhY2hlDQogICAgYml0bWFwLkVuZEluaXQoKQ0KICAgIGJpdG1hcC5GcmVlemUoKQ0KICAgIHJldHVybiBiaXRtYXANCg0KDQojIEhlbHBlciBjbGFzc2VzIGFuZCBmdW5jdGlvbnMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KY2xhc3MgUHlSZXZpdFVJRXJyb3IoUHlSZXZpdEV4Y2VwdGlvbik6DQogICAgIiIiQ29tbW9uIGJhc2UgY2xhc3MgZm9yIGFsbCBweVJldml0IHVpLXJlbGF0ZWQgZXhjZXB0aW9ucy4iIiINCiAgICBwYXNzDQoNCg0KY2xhc3MgQnV0dG9uSWNvbnMob2JqZWN0KToNCiAgICAiIiJweVJldml0IHVpIGVsZW1lbnQgaWNvbi4NCg0KICAgIFVwb24gaW5pdCwgdGhpcyB0eXBlIHJlYWRzIHRoZSBnaXZlbiBpbWFnZSBmaWxlIGludG8gYW4gaW8gc3RyZWFtIGFuZA0KICAgIHJlbGVhc2VzIHRoZSBvcyBsb2NrIG9uIHRoZSBmaWxlLg0KDQogICAgQXJnczoNCiAgICAgICAgaW1hZ2VfZmlsZSAoc3RyKTogaW1hZ2UgZmlsZSBwYXRoIHRvIGJlIHVzZWQgYXMgaWNvbg0KDQogICAgQXR0cmlidXRlczoNCiAgICAgICAgaWNvbl9maWxlX3BhdGggKHN0cik6IGljb24gaW1hZ2UgZmlsZSBwYXRoDQogICAgICAgIGZpbGVzdHJlYW0gKElPLkZpbGVTdHJlYW0pOiBpbyBzdHJlYW0gY29udGFpbmluZyBpbWFnZSBiaW5hcnkgZGF0YQ0KICAgICIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBpbWFnZV9maWxlKToNCiAgICAgICAgc2VsZi5pY29uX2ZpbGVfcGF0aCA9IGltYWdlX2ZpbGUNCiAgICAgICAgc2VsZi5jaGVja19pY29uX3NpemUoKQ0KICAgICAgICBzZWxmLmZpbGVzdHJlYW0gPSBJTy5GaWxlU3RyZWFtKGltYWdlX2ZpbGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSU8uRmlsZU1vZGUuT3BlbiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJTy5GaWxlQWNjZXNzLlJlYWQpDQoNCiAgICBAc3RhdGljbWV0aG9kDQogICAgZGVmIHJlY29sb3VyKGltYWdlX2RhdGEsIHNpemUsIHN0cmlkZSwgY29sb3IpOg0KICAgICAgICAjIEZJWE1FOiBuZWVkcyBkb2MsIGFuZCBhcmd1bWVudCB0eXBlcw0KICAgICAgICAjIEJ1dHRvbkljb25zLnJlY29sb3VyKGltYWdlX2RhdGEsIGltYWdlX3NpemUsIHN0cmlkZSwgMHg4ZTQ0YWQpDQogICAgICAgIHN0ZXAgPSBzdHJpZGUgLyBzaXplDQogICAgICAgIGZvciBpIGluIHJhbmdlKDAsIHN0cmlkZSwgc3RlcCk6DQogICAgICAgICAgICBmb3IgaiBpbiByYW5nZSgwLCBzdHJpZGUsIHN0ZXApOg0KICAgICAgICAgICAgICAgIGlkeCA9IChpICogc2l6ZSkgKyBqDQogICAgICAgICAgICAgICAgIyBSID0gaW1hZ2VfZGF0YVtpZHgrMl0NCiAgICAgICAgICAgICAgICAjIEcgPSBpbWFnZV9kYXRhW2lkeCsxXQ0KICAgICAgICAgICAgICAgICMgQiA9IGltYWdlX2RhdGFbaWR4XQ0KICAgICAgICAgICAgICAgICMgbHVtaW5hbmNlID0gKDAuMjk5KlIgKyAwLjU4NypHICsgMC4xMTQqQikNCiAgICAgICAgICAgICAgICBpbWFnZV9kYXRhW2lkeF0gPSBjb2xvciA+PiAwICYgMHhmZiAgICAgICAjIGJsdWUNCiAgICAgICAgICAgICAgICBpbWFnZV9kYXRhW2lkeCsxXSA9IGNvbG9yID4+IDggJiAweGZmICAgICAjIGdyZWVuDQogICAgICAgICAgICAgICAgaW1hZ2VfZGF0YVtpZHgrMl0gPSBjb2xvciA+PiAxNiAmIDB4ZmYgICAgIyByZWQNCg0KICAgIGRlZiBjaGVja19pY29uX3NpemUoc2VsZik6DQogICAgICAgICIiIlZlcmlmeSBpY29uIHNpemUgaXMgd2l0aGluIGFjY2VwdGFibGUgcmFuZ2UuIiIiDQogICAgICAgIGltYWdlID0gU3lzdGVtLkRyYXdpbmcuSW1hZ2UuRnJvbUZpbGUoc2VsZi5pY29uX2ZpbGVfcGF0aCkNCiAgICAgICAgaW1hZ2Vfc2l6ZSA9IG1heChpbWFnZS5XaWR0aCwgaW1hZ2UuSGVpZ2h0KQ0KICAgICAgICBpZiBpbWFnZV9zaXplID4gOTY6DQogICAgICAgICAgICBtbG9nZ2VyLndhcm5pbmcoJ0ljb24gZmlsZSBpcyB0b28gbGFyZ2UuIExhcmdlIGljb25zIGFkdmVyc2VseSAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FmZmVjdCB0aGUgbG9hZCB0aW1lIHNpbmNlIHRoZXkgbmVlZCB0byBiZSAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2Nlc3NlZCBhbmQgYWRqdXN0ZWQgZm9yIHNjcmVlbiBzY2FsaW5nLiAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0tlZXAgaWNvbnMgYXQgbWF4IDk2eDk2IHBpeGVsczogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaWNvbl9maWxlX3BhdGgpDQoNCiAgICBkZWYgY3JlYXRlX2JpdG1hcChzZWxmLCBpY29uX3NpemUpOg0KICAgICAgICAiIiJSZXNhbXBsZXMgaW1hZ2UgYW5kIGNyZWF0ZXMgYml0bWFwIGZvciB0aGUgZ2l2ZW4gc2l6ZS4NCg0KICAgICAgICBJY29ucyBhcmUgYXNzdW1lZCB0byBiZSBzcXVhcmUuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIGljb25fc2l6ZSAoaW50KTogaWNvbiBzaXplICh3aWR0aCBvciBoZWlnaHQpDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChJbWFnaW5nLkJpdG1hcFNvdXJjZSk6IG9iamVjdCBjb250YWluaW5nIGltYWdlIGRhdGEgYXQgZ2l2ZW4gc2l6ZQ0KICAgICAgICAiIiINCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnQ3JlYXRpbmcgJXN4JXMgYml0bWFwIGZyb206ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICBpY29uX3NpemUsIGljb25fc2l6ZSwgc2VsZi5pY29uX2ZpbGVfcGF0aCkNCiAgICAgICAgYWRqdXN0ZWRfaWNvbl9zaXplID0gaWNvbl9zaXplICogMg0KICAgICAgICBhZGp1c3RlZF9kcGkgPSBERUZBVUxUX0RQSSAqIDINCiAgICAgICAgc2NyZWVuX3NjYWxpbmcgPSBIT1NUX0FQUC5wcm9jX3NjcmVlbl9zY2FsZWZhY3Rvcg0KDQogICAgICAgIHNlbGYuZmlsZXN0cmVhbS5TZWVrKDAsIElPLlNlZWtPcmlnaW4uQmVnaW4pDQogICAgICAgIGJhc2VfaW1hZ2UgPSBJbWFnaW5nLkJpdG1hcEltYWdlKCkNCiAgICAgICAgYmFzZV9pbWFnZS5CZWdpbkluaXQoKQ0KICAgICAgICBiYXNlX2ltYWdlLlN0cmVhbVNvdXJjZSA9IHNlbGYuZmlsZXN0cmVhbQ0KICAgICAgICBiYXNlX2ltYWdlLkRlY29kZVBpeGVsSGVpZ2h0ID0gaW50KGFkanVzdGVkX2ljb25fc2l6ZSAqIHNjcmVlbl9zY2FsaW5nKQ0KICAgICAgICBiYXNlX2ltYWdlLkVuZEluaXQoKQ0KICAgICAgICBzZWxmLmZpbGVzdHJlYW0uU2VlaygwLCBJTy5TZWVrT3JpZ2luLkJlZ2luKQ0KDQogICAgICAgIGltYWdlX3NpemUgPSBiYXNlX2ltYWdlLlBpeGVsV2lkdGgNCiAgICAgICAgaW1hZ2VfZm9ybWF0ID0gYmFzZV9pbWFnZS5Gb3JtYXQNCiAgICAgICAgaW1hZ2VfYnl0ZV9wZXJfcGl4ZWwgPSBpbnQoYmFzZV9pbWFnZS5Gb3JtYXQuQml0c1BlclBpeGVsIC8gOCkNCiAgICAgICAgcGFsZXR0ZSA9IGJhc2VfaW1hZ2UuUGFsZXR0ZQ0KDQogICAgICAgIHN0cmlkZSA9IGludChpbWFnZV9zaXplICogaW1hZ2VfYnl0ZV9wZXJfcGl4ZWwpDQogICAgICAgIGFycmF5X3NpemUgPSBzdHJpZGUgKiBpbWFnZV9zaXplDQogICAgICAgIGltYWdlX2RhdGEgPSBTeXN0ZW0uQXJyYXkuQ3JlYXRlSW5zdGFuY2UoU3lzdGVtLkJ5dGUsIGFycmF5X3NpemUpDQogICAgICAgIGJhc2VfaW1hZ2UuQ29weVBpeGVscyhpbWFnZV9kYXRhLCBzdHJpZGUsIDApDQoNCiAgICAgICAgc2NhbGVkX3NpemUgPSBpbnQoYWRqdXN0ZWRfaWNvbl9zaXplICogc2NyZWVuX3NjYWxpbmcpDQogICAgICAgIHNjYWxlZF9kcGkgPSBpbnQoYWRqdXN0ZWRfZHBpICogc2NyZWVuX3NjYWxpbmcpDQogICAgICAgIGJpdG1hcF9zb3VyY2UgPSBcDQogICAgICAgICAgICBJbWFnaW5nLkJpdG1hcFNvdXJjZS5DcmVhdGUoc2NhbGVkX3NpemUsIHNjYWxlZF9zaXplLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlZF9kcGksIHNjYWxlZF9kcGksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VfZm9ybWF0LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhbGV0dGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VfZGF0YSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpZGUpDQogICAgICAgIHJldHVybiBiaXRtYXBfc291cmNlDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgc21hbGxfYml0bWFwKHNlbGYpOg0KICAgICAgICAiIiJSZXNhbXBsZXMgaW1hZ2UgYW5kIGNyZWF0ZXMgYml0bWFwIGZvciBzaXplIDpvYmo6YElDT05fU01BTExgLg0KDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICAoSW1hZ2luZy5CaXRtYXBTb3VyY2UpOiBvYmplY3QgY29udGFpbmluZyBpbWFnZSBkYXRhIGF0IGdpdmVuIHNpemUNCiAgICAgICAgIiIiDQogICAgICAgIHJldHVybiBzZWxmLmNyZWF0ZV9iaXRtYXAoSUNPTl9TTUFMTCkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBtZWRpdW1fYml0bWFwKHNlbGYpOg0KICAgICAgICAiIiJSZXNhbXBsZXMgaW1hZ2UgYW5kIGNyZWF0ZXMgYml0bWFwIGZvciBzaXplIDpvYmo6YElDT05fTUVESVVNYC4NCg0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgKEltYWdpbmcuQml0bWFwU291cmNlKTogb2JqZWN0IGNvbnRhaW5pbmcgaW1hZ2UgZGF0YSBhdCBnaXZlbiBzaXplDQogICAgICAgICIiIg0KICAgICAgICByZXR1cm4gc2VsZi5jcmVhdGVfYml0bWFwKElDT05fTUVESVVNKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGxhcmdlX2JpdG1hcChzZWxmKToNCiAgICAgICAgIiIiUmVzYW1wbGVzIGltYWdlIGFuZCBjcmVhdGVzIGJpdG1hcCBmb3Igc2l6ZSA6b2JqOmBJQ09OX0xBUkdFYC4NCg0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgKEltYWdpbmcuQml0bWFwU291cmNlKTogb2JqZWN0IGNvbnRhaW5pbmcgaW1hZ2UgZGF0YSBhdCBnaXZlbiBzaXplDQogICAgICAgICIiIg0KICAgICAgICByZXR1cm4gc2VsZi5jcmVhdGVfYml0bWFwKElDT05fTEFSR0UpDQoNCg0KIyBTdXBlcmNsYXNzIHRvIGFsbCB1aSBpdGVtIGNsYXNzZXMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCmNsYXNzIEdlbmVyaWNQeVJldml0VUlDb250YWluZXIob2JqZWN0KToNCiAgICAiIiJDb21tb24gdHlwZSBmb3IgYWxsIHB5UmV2aXQgdWkgY29udGFpbmVycy4NCg0KICAgIEF0dHJpYnV0ZXM6DQogICAgICAgIG5hbWUgKHN0cik6IGNvbnRhaW5lciBuYW1lDQogICAgICAgIGl0ZW1kYXRhX21vZGUgKGJvb2wpOiBpZiBjb250YWluZXIgaXMgd3JhcHBpbmcgVUkuKkl0ZW1EYXRhDQogICAgIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYpOg0KICAgICAgICBzZWxmLm5hbWUgPSAnJw0KICAgICAgICBzZWxmLl9ydnRhcGlfb2JqZWN0ID0gTm9uZQ0KICAgICAgICBzZWxmLl9zdWJfcHlydnRfY29tcG9uZW50cyA9IE9yZGVyZWREaWN0KCkNCiAgICAgICAgc2VsZi5pdGVtZGF0YV9tb2RlID0gRmFsc2UNCiAgICAgICAgc2VsZi5fZGlydHkgPSBGYWxzZQ0KICAgICAgICBzZWxmLl92aXNpYmxlID0gTm9uZQ0KICAgICAgICBzZWxmLl9lbmFibGVkID0gTm9uZQ0KDQogICAgZGVmIF9faXRlcl9fKHNlbGYpOg0KICAgICAgICByZXR1cm4gaXRlcihzZWxmLl9zdWJfcHlydnRfY29tcG9uZW50cy52YWx1ZXMoKSkNCg0KICAgIGRlZiBfX3JlcHJfXyhzZWxmKToNCiAgICAgICAgcmV0dXJuICdOYW1lOiB7fSBSZXZpdEFQSU9iamVjdDoge30nLmZvcm1hdChzZWxmLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcnZ0YXBpX29iamVjdCkNCg0KICAgIGRlZiBfZ2V0X2NvbXBvbmVudChzZWxmLCBjbXBfbmFtZSk6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9zdWJfcHlydnRfY29tcG9uZW50c1tjbXBfbmFtZV0NCiAgICAgICAgZXhjZXB0IEtleUVycm9yOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0NhbiBub3QgcmV0cmlldmUgaXRlbSB7fSBmcm9tIHt9Jw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChjbXBfbmFtZSwgc2VsZikpDQoNCiAgICBkZWYgX2FkZF9jb21wb25lbnQoc2VsZiwgbmV3X2NvbXBvbmVudCk6DQogICAgICAgIHNlbGYuX3N1Yl9weXJ2dF9jb21wb25lbnRzW25ld19jb21wb25lbnQubmFtZV0gPSBuZXdfY29tcG9uZW50DQoNCiAgICBkZWYgX3JlbW92ZV9jb21wb25lbnQoc2VsZiwgZXhwaXJlZF9jbXBfbmFtZSk6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHNlbGYuX3N1Yl9weXJ2dF9jb21wb25lbnRzLnBvcChleHBpcmVkX2NtcF9uYW1lKQ0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6DQogICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignQ2FuIG5vdCByZW1vdmUgaXRlbSB7fSBmcm9tIHt9Jw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChleHBpcmVkX2NtcF9uYW1lLCBzZWxmKSkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB2aXNpYmxlKHNlbGYpOg0KICAgICAgICAiIiJJcyBjb250YWluZXIgdmlzaWJsZS4iIiINCiAgICAgICAgaWYgaGFzYXR0cihzZWxmLl9ydnRhcGlfb2JqZWN0LCAnVmlzaWJsZScpOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3J2dGFwaV9vYmplY3QuVmlzaWJsZQ0KICAgICAgICBlbGlmIGhhc2F0dHIoc2VsZi5fcnZ0YXBpX29iamVjdCwgJ0lzVmlzaWJsZScpOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3J2dGFwaV9vYmplY3QuSXNWaXNpYmxlDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5fdmlzaWJsZQ0KDQogICAgQHZpc2libGUuc2V0dGVyDQogICAgZGVmIHZpc2libGUoc2VsZiwgdmFsdWUpOg0KICAgICAgICBpZiBoYXNhdHRyKHNlbGYuX3J2dGFwaV9vYmplY3QsICdWaXNpYmxlJyk6DQogICAgICAgICAgICBzZWxmLl9ydnRhcGlfb2JqZWN0LlZpc2libGUgPSB2YWx1ZQ0KICAgICAgICBlbGlmIGhhc2F0dHIoc2VsZi5fcnZ0YXBpX29iamVjdCwgJ0lzVmlzaWJsZScpOg0KICAgICAgICAgICAgc2VsZi5fcnZ0YXBpX29iamVjdC5Jc1Zpc2libGUgPSB2YWx1ZQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgc2VsZi5fdmlzaWJsZSA9IHZhbHVlDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgZW5hYmxlZChzZWxmKToNCiAgICAgICAgIiIiSXMgY29udGFpbmVyIGVuYWJsZWQuIiIiDQogICAgICAgIGlmIGhhc2F0dHIoc2VsZi5fcnZ0YXBpX29iamVjdCwgJ0VuYWJsZWQnKToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9ydnRhcGlfb2JqZWN0LkVuYWJsZWQNCiAgICAgICAgZWxpZiBoYXNhdHRyKHNlbGYuX3J2dGFwaV9vYmplY3QsICdJc0VuYWJsZWQnKToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9ydnRhcGlfb2JqZWN0LklzRW5hYmxlZA0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2VuYWJsZWQNCg0KICAgIEBlbmFibGVkLnNldHRlcg0KICAgIGRlZiBlbmFibGVkKHNlbGYsIHZhbHVlKToNCiAgICAgICAgaWYgaGFzYXR0cihzZWxmLl9ydnRhcGlfb2JqZWN0LCAnRW5hYmxlZCcpOg0KICAgICAgICAgICAgc2VsZi5fcnZ0YXBpX29iamVjdC5FbmFibGVkID0gdmFsdWUNCiAgICAgICAgZWxpZiBoYXNhdHRyKHNlbGYuX3J2dGFwaV9vYmplY3QsICdJc0VuYWJsZWQnKToNCiAgICAgICAgICAgIHNlbGYuX3J2dGFwaV9vYmplY3QuSXNFbmFibGVkID0gdmFsdWUNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSB2YWx1ZQ0KDQogICAgZGVmIHByb2Nlc3NfZGVmZXJyZWQoc2VsZik6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGlmIHNlbGYuX3Zpc2libGUgaXMgbm90IE5vbmU6DQogICAgICAgICAgICAgICAgc2VsZi52aXNpYmxlID0gc2VsZi5fdmlzaWJsZQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHZpc2libGVfZXJyOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0Vycm9yIHNldHRpbmcgLnZpc2libGUge30gfCB7fSAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KHNlbGYsIHZpc2libGVfZXJyKSkNCg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBpZiBzZWxmLl9lbmFibGVkIGlzIG5vdCBOb25lOg0KICAgICAgICAgICAgICAgIHNlbGYuZW5hYmxlZCA9IHNlbGYuX2VuYWJsZWQNCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlbmFibGVfZXJyOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0Vycm9yIHNldHRpbmcgLmVuYWJsZWQge30gfCB7fSAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KHNlbGYsIGVuYWJsZV9lcnIpKQ0KDQogICAgZGVmIGdldF9ydnRhcGlfb2JqZWN0KHNlbGYpOg0KICAgICAgICAiIiJSZXR1cm4gdW5kZXJseWluZyBSZXZpdCBBUEkgb2JqZWN0IGZvciB0aGlzIGNvbnRhaW5lci4iIiINCiAgICAgICAgIyBGSVhNRTogcmV0dXJuIHR5cGUNCiAgICAgICAgcmV0dXJuIHNlbGYuX3J2dGFwaV9vYmplY3QNCg0KICAgIGRlZiBzZXRfcnZ0YXBpX29iamVjdChzZWxmLCBydnRhcGlfb2JqKToNCiAgICAgICAgIiIiU2V0IHVuZGVybHlpbmcgUmV2aXQgQVBJIG9iamVjdCBmb3IgdGhpcyBjb250YWluZXIuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIHJ2dGFwaV9vYmogKG9iaik6IFJldml0IEFQSSBjb250YWluZXIgb2JqZWN0DQogICAgICAgICIiIg0KICAgICAgICAjIEZJWE1FOiBydnRhcGlfb2JqIHR5cGUNCiAgICAgICAgc2VsZi5fcnZ0YXBpX29iamVjdCA9IHJ2dGFwaV9vYmoNCiAgICAgICAgc2VsZi5pdGVtZGF0YV9tb2RlID0gRmFsc2UNCiAgICAgICAgc2VsZi5fZGlydHkgPSBUcnVlDQoNCiAgICBkZWYgZ2V0X2Fkd2luZG93c19vYmplY3Qoc2VsZik6DQogICAgICAgICIiIlJldHVybiB1bmRlcmx5aW5nIEFkV2luZG93cyBBUEkgb2JqZWN0IGZvciB0aGlzIGNvbnRhaW5lci4iIiINCiAgICAgICAgIyBGSVhNRTogcmV0dXJuIHR5cGUNCiAgICAgICAgcnZ0YXBpX29iaiA9IHNlbGYuX3J2dGFwaV9vYmplY3QNCiAgICAgICAgZ2V0UmliYm9uSXRlbU1ldGhvZCA9IFwNCiAgICAgICAgICAgIHJ2dGFwaV9vYmouR2V0VHlwZSgpLkdldE1ldGhvZCgNCiAgICAgICAgICAgICAgICAnZ2V0UmliYm9uSXRlbScsDQogICAgICAgICAgICAgICAgQmluZGluZ0ZsYWdzLk5vblB1YmxpYyB8IEJpbmRpbmdGbGFncy5JbnN0YW5jZQ0KICAgICAgICAgICAgICAgICkNCiAgICAgICAgaWYgZ2V0UmliYm9uSXRlbU1ldGhvZDoNCiAgICAgICAgICAgIHJldHVybiBnZXRSaWJib25JdGVtTWV0aG9kLkludm9rZShydnRhcGlfb2JqLCBOb25lKQ0KDQogICAgZGVmIGdldF9mbGFnZ2VkX2NoaWxkcmVuKHNlbGYsIHN0YXRlPVRydWUpOg0KICAgICAgICAiIiJHZXQgYWxsIGNoaWxkcmVuIHdpdGggdGhlaXIgZmxhZyBlcXVhbCB0byBnaXZlbiBzdGF0ZS4NCg0KICAgICAgICBGbGFnZ2luZyBpcyBhIG1lY2hhbmlzbSB0byBtYXJrIGNlcnRhaW4gY29udGFpbmVycy4gVGhlcmUgYXJlIHZhcmlvdXMNCiAgICAgICAgcmVhc29ucyB0aGF0IGNvbnRhaW5lciBmbGFnZ2luZyBtaWdodCBiZSB1c2VkIGUuZy4gbWFya2luZyB1cGRhdGVkDQogICAgICAgIGNvbnRhaW5lcnMgb3IgdGhlIG9uZXMgaW4gbmVlZCBvZiBhbiB1cGRhdGUgb3IgcmVtb3ZhbC4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgc3RhdGUgKGJvb2wpOiBmbGFnIHN0YXRlIHRvIGZpbHRlciBjaGlsZHJlbg0KDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICAobGlzdFsqXSk6IGxpc3Qgb2YgZmlsdGVyZWQgY2hpbGQgb2JqZWN0cw0KICAgICAgICAiIiINCiAgICAgICAgIyBGSVhNRTogcmV0dXJuIHR5cGUNCiAgICAgICAgZmxhZ2dlZF9jbXBzID0gW10NCiAgICAgICAgZm9yIGNvbXBvbmVudCBpbiBzZWxmOg0KICAgICAgICAgICAgZmxhZ2dlZF9jbXBzLmV4dGVuZChjb21wb25lbnQuZ2V0X2ZsYWdnZWRfY2hpbGRyZW4oc3RhdGUpKQ0KICAgICAgICAgICAgaWYgY29tcG9uZW50LmlzX2RpcnR5KCkgPT0gc3RhdGU6DQogICAgICAgICAgICAgICAgZmxhZ2dlZF9jbXBzLmFwcGVuZChjb21wb25lbnQpDQogICAgICAgIHJldHVybiBmbGFnZ2VkX2NtcHMNCg0KICAgIGRlZiBrZXlzKHNlbGYpOg0KICAgICAgICAjIEZJWE1FOiB3aGF0IGRvZXMgdGhpcyBkbz8NCiAgICAgICAgbGlzdChzZWxmLl9zdWJfcHlydnRfY29tcG9uZW50cy5rZXlzKCkpDQoNCiAgICBkZWYgdmFsdWVzKHNlbGYpOg0KICAgICAgICAjIEZJWE1FOiB3aGF0IGRvZXMgdGhpcyBkbz8NCiAgICAgICAgbGlzdChzZWxmLl9zdWJfcHlydnRfY29tcG9uZW50cy52YWx1ZXMoKSkNCg0KICAgIEBzdGF0aWNtZXRob2QNCiAgICBkZWYgaXNfbmF0aXZlKCk6DQogICAgICAgICIiIklzIHRoaXMgY29udGFpbmVyIGdlbmVyYXRlZCBieSBweVJldml0IG9yIGlzIG5hdGl2ZS4iIiINCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICBkZWYgaXNfZGlydHkoc2VsZik6DQogICAgICAgICIiIklzIGRpcnR5IGZsYWcgc2V0LiIiIg0KICAgICAgICBpZiBzZWxmLl9kaXJ0eToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kaXJ0eQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgIyBjaGVjayBpZiB0aGVyZSBpcyBhbnkgZGlydHkgY2hpbGQNCiAgICAgICAgICAgIGZvciBjb21wb25lbnQgaW4gc2VsZjoNCiAgICAgICAgICAgICAgICBpZiBjb21wb25lbnQuaXNfZGlydHkoKToNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KDQogICAgZGVmIHNldF9kaXJ0eV9mbGFnKHNlbGYsIHN0YXRlPVRydWUpOg0KICAgICAgICAiIiJTZXQgZGlydHkgZmxhZyB0byBnaXZlbiBzdGF0ZS4NCg0KICAgICAgICBTZWUgLmdldF9mbGFnZ2VkX2NoaWxkcmVuKCkNCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgc3RhdGUgKGJvb2wpOiBzdGF0ZSB0byBzZXQgZmxhZw0KICAgICAgICAiIiINCiAgICAgICAgc2VsZi5fZGlydHkgPSBzdGF0ZQ0KDQogICAgZGVmIGNvbnRhaW5zKHNlbGYsIHB5cnZ0X2NtcF9uYW1lKToNCiAgICAgICAgIiIiQ2hlY2sgaWYgY29udGFpbmVyIGNvbnRhaW5zIGEgY29tcG9uZW50IHdpdGggZ2l2ZW4gbmFtZS4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgcHlydnRfY21wX25hbWUgKHN0cik6IHRhcmdldCBjb21wb25lbnQgbmFtZQ0KICAgICAgICAiIiINCiAgICAgICAgcmV0dXJuIHB5cnZ0X2NtcF9uYW1lIGluIHNlbGYuX3N1Yl9weXJ2dF9jb21wb25lbnRzLmtleXMoKQ0KDQogICAgZGVmIGZpbmRfY2hpbGQoc2VsZiwgY2hpbGRfbmFtZSk6DQogICAgICAgICIiIkZpbmQgYSBjb21wb25lbnQgd2l0aCBnaXZlbiBuYW1lIGluIGNoaWxkcmVuLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBjaGlsZF9uYW1lIChzdHIpOiB0YXJnZXQgY29tcG9uZW50IG5hbWUNCg0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgKEFueSk6IGNvbXBvbmVudCBvYmplY3QgaWYgZm91bmQsIG90aGVyd2lzZSBOb25lDQogICAgICAgICIiIg0KICAgICAgICBmb3Igc3ViX2NtcCBpbiBzZWxmLl9zdWJfcHlydnRfY29tcG9uZW50cy52YWx1ZXMoKToNCiAgICAgICAgICAgIGlmIGNoaWxkX25hbWUgPT0gc3ViX2NtcC5uYW1lOg0KICAgICAgICAgICAgICAgIHJldHVybiBzdWJfY21wDQogICAgICAgICAgICBlbGlmIGhhc2F0dHIoc3ViX2NtcCwgJ3VpX3RpdGxlJykgXA0KICAgICAgICAgICAgICAgICAgICBhbmQgY2hpbGRfbmFtZSA9PSBzdWJfY21wLnVpX3RpdGxlOg0KICAgICAgICAgICAgICAgIHJldHVybiBzdWJfY21wDQoNCiAgICAgICAgICAgIGNvbXBvbmVudCA9IHN1Yl9jbXAuZmluZF9jaGlsZChjaGlsZF9uYW1lKQ0KICAgICAgICAgICAgaWYgY29tcG9uZW50Og0KICAgICAgICAgICAgICAgIHJldHVybiBjb21wb25lbnQNCg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgZGVmIGFjdGl2YXRlKHNlbGYpOg0KICAgICAgICAiIiJBY3RpdmF0ZSB0aGlzIGNvbnRhaW5lciBpbiB1aS4iIiINCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgc2VsZi5lbmFibGVkID0gVHJ1ZQ0KICAgICAgICAgICAgc2VsZi52aXNpYmxlID0gVHJ1ZQ0KICAgICAgICAgICAgc2VsZi5fZGlydHkgPSBUcnVlDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignQ2FuIG5vdCBhY3RpdmF0ZToge30nLmZvcm1hdChzZWxmKSkNCg0KICAgIGRlZiBkZWFjdGl2YXRlKHNlbGYpOg0KICAgICAgICAiIiJEZWFjdGl2YXRlIHRoaXMgY29udGFpbmVyIGluIHVpLiIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBzZWxmLmVuYWJsZWQgPSBGYWxzZQ0KICAgICAgICAgICAgc2VsZi52aXNpYmxlID0gRmFsc2UNCiAgICAgICAgICAgIHNlbGYuX2RpcnR5ID0gVHJ1ZQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0NhbiBub3QgZGVhY3RpdmF0ZToge30nLmZvcm1hdChzZWxmKSkNCg0KICAgIGRlZiBnZXRfdXBkYXRlZF9pdGVtcyhzZWxmKToNCiAgICAgICAgIyBGSVhNRTogcmVkdW50YW50LCB0aGlzIGlzIGEgdXNlIGNhc2UgYW5kIHNob3VsZCBiZSBvbiB1aW1ha2VyIHNpZGU/DQogICAgICAgIHJldHVybiBzZWxmLmdldF9mbGFnZ2VkX2NoaWxkcmVuKCkNCg0KICAgIGRlZiBnZXRfdW5jaGFuZ2VkX2l0ZW1zKHNlbGYpOg0KICAgICAgICAjIEZJWE1FOiByZWR1bnRhbnQsIHRoaXMgaXMgYSB1c2UgY2FzZSBhbmQgc2hvdWxkIGJlIG9uIHVpbWFrZXIgc2lkZT8NCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X2ZsYWdnZWRfY2hpbGRyZW4oc3RhdGU9RmFsc2UpDQoNCiAgICBkZWYgcmVvcmRlcl9iZWZvcmUoc2VsZiwgaXRlbV9uYW1lLCByaXRlbV9uYW1lKToNCiAgICAgICAgIiIiUmVvcmRlciBhbmQgcGxhY2UgaXRlbV9uYW1lIGJlZm9yZSByaXRlbV9uYW1lLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBpdGVtX25hbWUgKHN0cik6IG5hbWUgb2YgY29tcG9uZW50IHRvIGJlIG1vdmVkDQogICAgICAgICAgICByaXRlbV9uYW1lIChzdHIpOiBuYW1lIG9mIGNvbXBvbmVudCB0aGF0IHNob3VsZCBiZSBvbiB0aGUgcmlnaHQNCiAgICAgICAgIiIiDQogICAgICAgIGFwaW9iaiA9IHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKQ0KICAgICAgICBsaXRlbV9pZHggPSByaXRlbV9pZHggPSBOb25lDQogICAgICAgIGlmIGhhc2F0dHIoYXBpb2JqLCAnUGFuZWxzJyk6DQogICAgICAgICAgICBmb3IgaXRlbSBpbiBhcGlvYmouUGFuZWxzOg0KICAgICAgICAgICAgICAgIGlmIGl0ZW0uU291cmNlLkF1dG9tYXRpb25OYW1lID09IGl0ZW1fbmFtZToNCiAgICAgICAgICAgICAgICAgICAgbGl0ZW1faWR4ID0gYXBpb2JqLlBhbmVscy5JbmRleE9mKGl0ZW0pDQogICAgICAgICAgICAgICAgZWxpZiBpdGVtLlNvdXJjZS5BdXRvbWF0aW9uTmFtZSA9PSByaXRlbV9uYW1lOg0KICAgICAgICAgICAgICAgICAgICByaXRlbV9pZHggPSBhcGlvYmouUGFuZWxzLkluZGV4T2YoaXRlbSkNCiAgICAgICAgICAgIGlmIGxpdGVtX2lkeCBhbmQgcml0ZW1faWR4Og0KICAgICAgICAgICAgICAgIGlmIGxpdGVtX2lkeCA8IHJpdGVtX2lkeDoNCiAgICAgICAgICAgICAgICAgICAgYXBpb2JqLlBhbmVscy5Nb3ZlKGxpdGVtX2lkeCwgcml0ZW1faWR4IC0gMSkNCiAgICAgICAgICAgICAgICBlbGlmIGxpdGVtX2lkeCA+IHJpdGVtX2lkeDoNCiAgICAgICAgICAgICAgICAgICAgYXBpb2JqLlBhbmVscy5Nb3ZlKGxpdGVtX2lkeCwgcml0ZW1faWR4KQ0KDQogICAgZGVmIHJlb3JkZXJfYmVmb3JlYWxsKHNlbGYsIGl0ZW1fbmFtZSk6DQogICAgICAgICIiIlJlb3JkZXIgYW5kIHBsYWNlIGl0ZW1fbmFtZSBiZWZvcmUgYWxsIG90aGVycy4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgaXRlbV9uYW1lIChzdHIpOiBuYW1lIG9mIGNvbXBvbmVudCB0byBiZSBtb3ZlZA0KICAgICAgICAiIiINCiAgICAgICAgIyBGSVhNRTogdmVyaWZ5IGRvY3MgZGVzY3JpcHRpb24gaXMgY29ycmVjdA0KICAgICAgICBhcGlvYmogPSBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkNCiAgICAgICAgbGl0ZW1faWR4ID0gTm9uZQ0KICAgICAgICBpZiBoYXNhdHRyKGFwaW9iaiwgJ1BhbmVscycpOg0KICAgICAgICAgICAgZm9yIGl0ZW0gaW4gYXBpb2JqLlBhbmVsczoNCiAgICAgICAgICAgICAgICBpZiBpdGVtLlNvdXJjZS5BdXRvbWF0aW9uTmFtZSA9PSBpdGVtX25hbWU6DQogICAgICAgICAgICAgICAgICAgIGxpdGVtX2lkeCA9IGFwaW9iai5QYW5lbHMuSW5kZXhPZihpdGVtKQ0KICAgICAgICAgICAgaWYgbGl0ZW1faWR4Og0KICAgICAgICAgICAgICAgIGFwaW9iai5QYW5lbHMuTW92ZShsaXRlbV9pZHgsIDApDQoNCiAgICBkZWYgcmVvcmRlcl9hZnRlcihzZWxmLCBpdGVtX25hbWUsIHJpdGVtX25hbWUpOg0KICAgICAgICAiIiJSZW9yZGVyIGFuZCBwbGFjZSBpdGVtX25hbWUgYWZ0ZXIgcml0ZW1fbmFtZS4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgaXRlbV9uYW1lIChzdHIpOiBuYW1lIG9mIGNvbXBvbmVudCB0byBiZSBtb3ZlZA0KICAgICAgICAgICAgcml0ZW1fbmFtZSAoc3RyKTogbmFtZSBvZiBjb21wb25lbnQgdGhhdCBzaG91bGQgYmUgb24gdGhlIGxlZnQNCiAgICAgICAgIiIiDQogICAgICAgIGFwaW9iaiA9IHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKQ0KICAgICAgICBsaXRlbV9pZHggPSByaXRlbV9pZHggPSBOb25lDQogICAgICAgIGlmIGhhc2F0dHIoYXBpb2JqLCAnUGFuZWxzJyk6DQogICAgICAgICAgICBmb3IgaXRlbSBpbiBhcGlvYmouUGFuZWxzOg0KICAgICAgICAgICAgICAgIGlmIGl0ZW0uU291cmNlLkF1dG9tYXRpb25OYW1lID09IGl0ZW1fbmFtZToNCiAgICAgICAgICAgICAgICAgICAgbGl0ZW1faWR4ID0gYXBpb2JqLlBhbmVscy5JbmRleE9mKGl0ZW0pDQogICAgICAgICAgICAgICAgZWxpZiBpdGVtLlNvdXJjZS5BdXRvbWF0aW9uTmFtZSA9PSByaXRlbV9uYW1lOg0KICAgICAgICAgICAgICAgICAgICByaXRlbV9pZHggPSBhcGlvYmouUGFuZWxzLkluZGV4T2YoaXRlbSkNCiAgICAgICAgICAgIGlmIGxpdGVtX2lkeCBhbmQgcml0ZW1faWR4Og0KICAgICAgICAgICAgICAgIGlmIGxpdGVtX2lkeCA8IHJpdGVtX2lkeDoNCiAgICAgICAgICAgICAgICAgICAgYXBpb2JqLlBhbmVscy5Nb3ZlKGxpdGVtX2lkeCwgcml0ZW1faWR4KQ0KICAgICAgICAgICAgICAgIGVsaWYgbGl0ZW1faWR4ID4gcml0ZW1faWR4Og0KICAgICAgICAgICAgICAgICAgICBhcGlvYmouUGFuZWxzLk1vdmUobGl0ZW1faWR4LCByaXRlbV9pZHggKyAxKQ0KDQogICAgZGVmIHJlb3JkZXJfYWZ0ZXJhbGwoc2VsZiwgaXRlbV9uYW1lKToNCiAgICAgICAgIiIiUmVvcmRlciBhbmQgcGxhY2UgaXRlbV9uYW1lIGFmdGVyIGFsbCBvdGhlcnMuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIGl0ZW1fbmFtZSAoc3RyKTogbmFtZSBvZiBjb21wb25lbnQgdG8gYmUgbW92ZWQNCiAgICAgICAgIiIiDQogICAgICAgIGFwaW9iaiA9IHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKQ0KICAgICAgICBsaXRlbV9pZHggPSBOb25lDQogICAgICAgIGlmIGhhc2F0dHIoYXBpb2JqLCAnUGFuZWxzJyk6DQogICAgICAgICAgICBmb3IgaXRlbSBpbiBhcGlvYmouUGFuZWxzOg0KICAgICAgICAgICAgICAgIGlmIGl0ZW0uU291cmNlLkF1dG9tYXRpb25OYW1lID09IGl0ZW1fbmFtZToNCiAgICAgICAgICAgICAgICAgICAgbGl0ZW1faWR4ID0gYXBpb2JqLlBhbmVscy5JbmRleE9mKGl0ZW0pDQogICAgICAgICAgICBpZiBsaXRlbV9pZHg6DQogICAgICAgICAgICAgICAgbWF4X2lkeCA9IGxlbihhcGlvYmouUGFuZWxzKSAtIDENCiAgICAgICAgICAgICAgICBhcGlvYmouUGFuZWxzLk1vdmUobGl0ZW1faWR4LCBtYXhfaWR4KQ0KDQoNCiMgQ2xhc3NlcyBob2xkaW5nIGV4aXN0aW5nIG5hdGl2ZSB1aSBlbGVtZW50cw0KIyAoVGhlc2UgZWxlbWVudHMgYXJlIG5hdGl2ZSBhbmQgY2FuIG5vdCBiZSBtb2RpZmllZCkgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCmNsYXNzIEdlbmVyaWNSZXZpdE5hdGl2ZVVJQ29udGFpbmVyKEdlbmVyaWNQeVJldml0VUlDb250YWluZXIpOg0KICAgICIiIkNvbW1vbiBiYXNlIHR5cGUgZm9yIG5hdGl2ZSBSZXZpdCBBUEkgVUkgY29udGFpbmVycy4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZik6DQogICAgICAgIEdlbmVyaWNQeVJldml0VUlDb250YWluZXIuX19pbml0X18oc2VsZikNCg0KICAgIEBzdGF0aWNtZXRob2QNCiAgICBkZWYgaXNfbmF0aXZlKCk6DQogICAgICAgICIiIklzIHRoaXMgY29udGFpbmVyIGdlbmVyYXRlZCBieSBweVJldml0IG9yIGlzIG5hdGl2ZS4iIiINCiAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgIGRlZiBhY3RpdmF0ZShzZWxmKToNCiAgICAgICAgIiIiQWN0aXZhdGUgdGhpcyBjb250YWluZXIgaW4gdWkuDQoNCiAgICAgICAgVW5kZXIgY3VycmVudCBpbXBsZW1lbnRhdGlvbiwgcmFpc2VzIFB5UmV2aXRVSUVycm9yIGV4Y2VwdGlvbiBhcw0KICAgICAgICBuYXRpdmUgUmV2aXQgQVBJIFVJIGNvbXBvbmVudHMgc2hvdWxkIG5vdCBiZSBjaGFuZ2VkLg0KICAgICAgICAiIiINCiAgICAgICAgcmV0dXJuIHNlbGYuZGVhY3RpdmF0ZSgpDQoNCiAgICBkZWYgZGVhY3RpdmF0ZShzZWxmKToNCiAgICAgICAgIiIiRGVhY3RpdmF0ZSB0aGlzIGNvbnRhaW5lciBpbiB1aS4NCg0KICAgICAgICBVbmRlciBjdXJyZW50IGltcGxlbWVudGF0aW9uLCByYWlzZXMgUHlSZXZpdFVJRXJyb3IgZXhjZXB0aW9uIGFzDQogICAgICAgIG5hdGl2ZSBSZXZpdCBBUEkgVUkgY29tcG9uZW50cyBzaG91bGQgbm90IGJlIGNoYW5nZWQuDQogICAgICAgICIiIg0KICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignQ2FuIG5vdCBkZS9hY3RpdmF0ZSBuYXRpdmUgaXRlbToge30nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQoc2VsZikpDQoNCg0KY2xhc3MgUmV2aXROYXRpdmVSaWJib25CdXR0b24oR2VuZXJpY1Jldml0TmF0aXZlVUlDb250YWluZXIpOg0KICAgICIiIlJldml0IEFQSSBVSSBuYXRpdmUgcmliYm9uIGJ1dHRvbi4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgYWR3bmRfcmliYm9uX2J1dHRvbik6DQogICAgICAgIEdlbmVyaWNSZXZpdE5hdGl2ZVVJQ29udGFpbmVyLl9faW5pdF9fKHNlbGYpDQoNCiAgICAgICAgc2VsZi5uYW1lID0gXA0KICAgICAgICAgICAgc2FmZV9zdHJ0eXBlKGFkd25kX3JpYmJvbl9idXR0b24uQXV0b21hdGlvbk5hbWUpXA0KICAgICAgICAgICAgLnJlcGxhY2UoJ1xyXG4nLCAnICcpDQogICAgICAgIHNlbGYuX3J2dGFwaV9vYmplY3QgPSBhZHduZF9yaWJib25fYnV0dG9uDQoNCg0KY2xhc3MgUmV2aXROYXRpdmVSaWJib25Hcm91cEl0ZW0oR2VuZXJpY1Jldml0TmF0aXZlVUlDb250YWluZXIpOg0KICAgICIiIlJldml0IEFQSSBVSSBuYXRpdmUgcmliYm9uIGJ1dHRvbi4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgYWR3bmRfcmliYm9uX2l0ZW0pOg0KICAgICAgICBHZW5lcmljUmV2aXROYXRpdmVVSUNvbnRhaW5lci5fX2luaXRfXyhzZWxmKQ0KDQogICAgICAgIHNlbGYubmFtZSA9IGFkd25kX3JpYmJvbl9pdGVtLlNvdXJjZS5UaXRsZQ0KICAgICAgICBzZWxmLl9ydnRhcGlfb2JqZWN0ID0gYWR3bmRfcmliYm9uX2l0ZW0NCg0KICAgICAgICAjIGZpbmRpbmcgY2hpbGRyZW4gb24gdGhpcyBidXR0b24gZ3JvdXANCiAgICAgICAgZm9yIGFkd25kX3JpYmJvbl9idXR0b24gaW4gYWR3bmRfcmliYm9uX2l0ZW0uSXRlbXM6DQogICAgICAgICAgICBzZWxmLl9hZGRfY29tcG9uZW50KFJldml0TmF0aXZlUmliYm9uQnV0dG9uKGFkd25kX3JpYmJvbl9idXR0b24pKQ0KDQogICAgZGVmIGJ1dHRvbihzZWxmLCBuYW1lKToNCiAgICAgICAgIiIiR2V0IGJ1dHRvbiBpdGVtIHdpdGggZ2l2ZW4gbmFtZS4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgbmFtZSAoc3RyKTogbmFtZSBvZiBidXR0b24gaXRlbSB0byBmaW5kDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChSZXZpdE5hdGl2ZVJpYmJvbkJ1dHRvbik6IGJ1dHRvbiBvYmplY3QgaWYgZm91bmQNCiAgICAgICAgIiIiDQogICAgICAgIHJldHVybiBzdXBlcihSZXZpdE5hdGl2ZVJpYmJvbkdyb3VwSXRlbSwgc2VsZikuX2dldF9jb21wb25lbnQobmFtZSkNCg0KDQpjbGFzcyBSZXZpdE5hdGl2ZVJpYmJvblBhbmVsKEdlbmVyaWNSZXZpdE5hdGl2ZVVJQ29udGFpbmVyKToNCiAgICAiIiJSZXZpdCBBUEkgVUkgbmF0aXZlIHJpYmJvbiBidXR0b24uIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFkd25kX3JpYmJvbl9wYW5lbCk6DQogICAgICAgIEdlbmVyaWNSZXZpdE5hdGl2ZVVJQ29udGFpbmVyLl9faW5pdF9fKHNlbGYpDQoNCiAgICAgICAgc2VsZi5uYW1lID0gYWR3bmRfcmliYm9uX3BhbmVsLlNvdXJjZS5UaXRsZQ0KICAgICAgICBzZWxmLl9ydnRhcGlfb2JqZWN0ID0gYWR3bmRfcmliYm9uX3BhbmVsDQoNCiAgICAgICAgYWxsX2Fkd25kX3JpYmJvbl9pdGVtcyA9IFtdDQogICAgICAgICMgZ2V0dGluZyBhIGxpc3Qgb2YgZXhpc3RpbmcgaXRlbXMgdW5kZXIgdGhpcyBwYW5lbA0KICAgICAgICAjIFJpYmJvbkZvbGRQYW5lbCBpdGVtcyBhcmUgbm90IHZpc2libGUuIHRoZXkgYXV0b21hdGljYWxseSBmb2xkDQogICAgICAgICMgYnV0dG9ucyBpbnRvIHN0YWNrIG9uIHJldml0IHVpIHJlc2l6ZSBzaW5jZSBSaWJib25Gb2xkUGFuZWwgYXJlDQogICAgICAgICMgbm90IHZpc2libGUgaXQgZG9lcyBub3QgbWFrZSBzZW5zZSB0byBjcmVhdGUgb2JqZWN0cyBmb3IgdGhlbS4NCiAgICAgICAgIyBUaGlzIHByZS1jbGVhbmVyIGxvb3AsIGZpbmRzIHRoZSBSaWJib25Gb2xkUGFuZWwgaXRlbXMgYW5kDQogICAgICAgICMgYWRkcyB0aGUgY2hpbGRyZW4gdG8gdGhlIG1haW4gbGlzdA0KICAgICAgICBmb3IgYWR3bmRfcmliYm9uX2l0ZW0gaW4gYWR3bmRfcmliYm9uX3BhbmVsLlNvdXJjZS5JdGVtczoNCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYWR3bmRfcmliYm9uX2l0ZW0sIEFkV2luZG93cy5SaWJib25Gb2xkUGFuZWwpOg0KICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgZm9yIHN1Yl9ydnRhcGlfaXRlbSBpbiBhZHduZF9yaWJib25faXRlbS5JdGVtczoNCiAgICAgICAgICAgICAgICAgICAgICAgIGFsbF9hZHduZF9yaWJib25faXRlbXMuYXBwZW5kKHN1Yl9ydnRhcGlfaXRlbSkNCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGFwcGVuZF9lcnI6DQogICAgICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0NhbiBub3QgZ2V0IFJpYmJvbkZvbGRQYW5lbCBjaGlsZHJlbjogJXMgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd8ICVzJywgYWR3bmRfcmliYm9uX2l0ZW0sIGFwcGVuZF9lcnIpDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIGFsbF9hZHduZF9yaWJib25faXRlbXMuYXBwZW5kKGFkd25kX3JpYmJvbl9pdGVtKQ0KDQogICAgICAgICMgcHJvY2Vzc2luZyB0aGUgcGFuZWwgc2xpZGVvdXQgZm9yIGV4aXNpbmcgcmliYm9uIGl0ZW1zDQogICAgICAgIGZvciBhZHduZF9zbGlkZW91dF9pdGVtIFwNCiAgICAgICAgICAgICAgICBpbiBhZHduZF9yaWJib25fcGFuZWwuU291cmNlLlNsaWRlT3V0UGFuZWxJdGVtc1ZpZXc6DQogICAgICAgICAgICBhbGxfYWR3bmRfcmliYm9uX2l0ZW1zLmFwcGVuZChhZHduZF9zbGlkZW91dF9pdGVtKQ0KDQogICAgICAgICMgcHJvY2Vzc2luZyB0aGUgY2xlYW5lZCBjaGlsZHJlbiBsaXN0IGFuZA0KICAgICAgICAjIGNyZWF0aW5nIHB5UmV2aXQgbmF0aXZlIHJpYmJvbiBvYmplY3RzDQogICAgICAgIGZvciBhZHduZF9yaWJib25faXRlbSBpbiBhbGxfYWR3bmRfcmliYm9uX2l0ZW1zOg0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYWR3bmRfcmliYm9uX2l0ZW0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBZFdpbmRvd3MuUmliYm9uQnV0dG9uKSBcDQogICAgICAgICAgICAgICAgICAgICAgICBvciBpc2luc3RhbmNlKGFkd25kX3JpYmJvbl9pdGVtLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBZFdpbmRvd3MuUmliYm9uVG9nZ2xlQnV0dG9uKToNCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fYWRkX2NvbXBvbmVudCgNCiAgICAgICAgICAgICAgICAgICAgICAgIFJldml0TmF0aXZlUmliYm9uQnV0dG9uKGFkd25kX3JpYmJvbl9pdGVtKSkNCiAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UoYWR3bmRfcmliYm9uX2l0ZW0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFkV2luZG93cy5SaWJib25TcGxpdEJ1dHRvbik6DQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9jb21wb25lbnQoDQogICAgICAgICAgICAgICAgICAgICAgICBSZXZpdE5hdGl2ZVJpYmJvbkdyb3VwSXRlbShhZHduZF9yaWJib25faXRlbSkpDQoNCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgYXBwZW5kX2VycjoNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDYW4gbm90IGNyZWF0ZSBuYXRpdmUgcmliYm9uIGl0ZW06ICVzICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd8ICVzJywgYWR3bmRfcmliYm9uX2l0ZW0sIGFwcGVuZF9lcnIpDQoNCiAgICBkZWYgcmliYm9uX2l0ZW0oc2VsZiwgaXRlbV9uYW1lKToNCiAgICAgICAgIiIiR2V0IHBhbmVsIGl0ZW0gd2l0aCBnaXZlbiBuYW1lLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBpdGVtX25hbWUgKHN0cik6IG5hbWUgb2YgcGFuZWwgaXRlbSB0byBmaW5kDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChvYmplY3QpOg0KICAgICAgICAgICAgICAgIHBhbmVsIGl0ZW0gaWYgZm91bmQsIGNvdWxkIGJlIDpvYmo6YFJldml0TmF0aXZlUmliYm9uQnV0dG9uYA0KICAgICAgICAgICAgICAgIG9yIDpvYmo6YFJldml0TmF0aXZlUmliYm9uR3JvdXBJdGVtYA0KICAgICAgICAiIiINCiAgICAgICAgcmV0dXJuIHN1cGVyKFJldml0TmF0aXZlUmliYm9uUGFuZWwsIHNlbGYpLl9nZXRfY29tcG9uZW50KGl0ZW1fbmFtZSkNCg0KDQpjbGFzcyBSZXZpdE5hdGl2ZVJpYmJvblRhYihHZW5lcmljUmV2aXROYXRpdmVVSUNvbnRhaW5lcik6DQogICAgIiIiUmV2aXQgQVBJIFVJIG5hdGl2ZSByaWJib24gdGFiLiIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhZHduZF9yaWJib25fdGFiKToNCiAgICAgICAgR2VuZXJpY1Jldml0TmF0aXZlVUlDb250YWluZXIuX19pbml0X18oc2VsZikNCg0KICAgICAgICBzZWxmLm5hbWUgPSBhZHduZF9yaWJib25fdGFiLlRpdGxlDQogICAgICAgIHNlbGYuX3J2dGFwaV9vYmplY3QgPSBhZHduZF9yaWJib25fdGFiDQoNCiAgICAgICAgIyBnZXR0aW5nIGEgbGlzdCBvZiBleGlzdGluZyBwYW5lbHMgdW5kZXIgdGhpcyB0YWINCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgZm9yIGFkd25kX3JpYmJvbl9wYW5lbCBpbiBhZHduZF9yaWJib25fdGFiLlBhbmVsczoNCiAgICAgICAgICAgICAgICAjIG9ubHkgbGlzdGluZyB2aXNpYmxlIHBhbmVscw0KICAgICAgICAgICAgICAgIGlmIGFkd25kX3JpYmJvbl9wYW5lbC5Jc1Zpc2libGU6DQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9jb21wb25lbnQoDQogICAgICAgICAgICAgICAgICAgICAgICBSZXZpdE5hdGl2ZVJpYmJvblBhbmVsKGFkd25kX3JpYmJvbl9wYW5lbCkNCiAgICAgICAgICAgICAgICAgICAgKQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGFwcGVuZF9lcnI6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDYW4gbm90IGdldCBuYXRpdmUgcGFuZWxzIGZvciB0aGlzIG5hdGl2ZSB0YWI6ICVzICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wgJXMnLCBhZHduZF9yaWJib25fdGFiLCBhcHBlbmRfZXJyKQ0KDQogICAgZGVmIHJpYmJvbl9wYW5lbChzZWxmLCBwYW5lbF9uYW1lKToNCiAgICAgICAgIiIiR2V0IHBhbmVsIHdpdGggZ2l2ZW4gbmFtZS4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgcGFuZWxfbmFtZSAoc3RyKTogbmFtZSBvZiBwYW5lbCB0byBmaW5kDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChSZXZpdE5hdGl2ZVJpYmJvblBhbmVsKTogcGFuZWwgaWYgZm91bmQNCiAgICAgICAgIiIiDQogICAgICAgIHJldHVybiBzdXBlcihSZXZpdE5hdGl2ZVJpYmJvblRhYiwgc2VsZikuX2dldF9jb21wb25lbnQocGFuZWxfbmFtZSkNCg0KICAgIEBzdGF0aWNtZXRob2QNCiAgICBkZWYgaXNfcHlyZXZpdF90YWIoKToNCiAgICAgICAgIiIiSXMgdGhpcyB0YWIgZ2VuZXJhdGVkIGJ5IHB5UmV2aXQuIiIiDQogICAgICAgIHJldHVybiBGYWxzZQ0KDQoNCiMgQ2xhc3NlcyBob2xkaW5nIG5vbi1uYXRpdmUgdWkgZWxlbWVudHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCmNsYXNzIF9QeVJldml0U2VwYXJhdG9yKEdlbmVyaWNQeVJldml0VUlDb250YWluZXIpOg0KICAgIGRlZiBfX2luaXRfXyhzZWxmKToNCiAgICAgICAgR2VuZXJpY1B5UmV2aXRVSUNvbnRhaW5lci5fX2luaXRfXyhzZWxmKQ0KICAgICAgICBzZWxmLm5hbWUgPSBjb3JldXRpbHMubmV3X3V1aWQoKQ0KICAgICAgICBzZWxmLml0ZW1kYXRhX21vZGUgPSBUcnVlDQoNCg0KY2xhc3MgX1B5UmV2aXRSaWJib25CdXR0b24oR2VuZXJpY1B5UmV2aXRVSUNvbnRhaW5lcik6DQogICAgZGVmIF9faW5pdF9fKHNlbGYsIHJpYmJvbl9idXR0b24pOg0KICAgICAgICBHZW5lcmljUHlSZXZpdFVJQ29udGFpbmVyLl9faW5pdF9fKHNlbGYpDQoNCiAgICAgICAgc2VsZi5uYW1lID0gcmliYm9uX2J1dHRvbi5OYW1lDQogICAgICAgIHNlbGYuX3J2dGFwaV9vYmplY3QgPSByaWJib25fYnV0dG9uDQoNCiAgICAgICAgIyB3aGVuIGNvbnRhaW5lciBpcyBpbiBpdGVtZGF0YV9tb2RlLCBzZWxmLl9ydnRhcGlfb2JqZWN0IGlzIGENCiAgICAgICAgIyBSaWJib25JdGVtRGF0YSBhbmQgbm90IGFuIGFjdHVhbCB1aSBpdGVtIGEgc3Vuc2VxdWVudCBjYWxsIHRvDQogICAgICAgICMgY3JlYXRlX2RhdGFfaXRlbXMgd2lsbCBjcmVhdGUgdWkgZm9yIFJpYmJvbkl0ZW1EYXRhIG9iamVjdHMNCiAgICAgICAgc2VsZi5pdGVtZGF0YV9tb2RlID0gaXNpbnN0YW5jZShzZWxmLl9ydnRhcGlfb2JqZWN0LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVJLlJpYmJvbkl0ZW1EYXRhKQ0KDQogICAgICAgIHNlbGYudWlfdGl0bGUgPSBzZWxmLm5hbWUNCiAgICAgICAgaWYgbm90IHNlbGYuaXRlbWRhdGFfbW9kZToNCiAgICAgICAgICAgIHNlbGYudWlfdGl0bGUgPSBzZWxmLl9ydnRhcGlfb2JqZWN0Lkl0ZW1UZXh0DQoNCiAgICAgICAgc2VsZi50b29sdGlwX2ltYWdlID0gc2VsZi50b29sdGlwX3ZpZGVvID0gTm9uZQ0KDQogICAgZGVmIHNldF9ydnRhcGlfb2JqZWN0KHNlbGYsIHJ2dGFwaV9vYmopOg0KICAgICAgICBHZW5lcmljUHlSZXZpdFVJQ29udGFpbmVyLnNldF9ydnRhcGlfb2JqZWN0KHNlbGYsIHJ2dGFwaV9vYmopDQogICAgICAgICMgdXBkYXRlIHRoZSB1aSB0aXRsZSBmb3IgdGhlIG5ld2x5IGFkZGVkIHJ2dGFwaV9vYmoNCiAgICAgICAgc2VsZi5fcnZ0YXBpX29iamVjdC5JdGVtVGV4dCA9IHNlbGYudWlfdGl0bGUNCg0KICAgIGRlZiBzZXRfaWNvbihzZWxmLCBpY29uX2ZpbGUsIGljb25fc2l6ZT1JQ09OX01FRElVTSk6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGJ1dHRvbl9pY29uID0gQnV0dG9uSWNvbnMoaWNvbl9maWxlKQ0KICAgICAgICAgICAgcnZ0YXBpX29iaiA9IHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKQ0KICAgICAgICAgICAgcnZ0YXBpX29iai5JbWFnZSA9IGJ1dHRvbl9pY29uLnNtYWxsX2JpdG1hcA0KICAgICAgICAgICAgaWYgaWNvbl9zaXplID09IElDT05fTEFSR0U6DQogICAgICAgICAgICAgICAgcnZ0YXBpX29iai5MYXJnZUltYWdlID0gYnV0dG9uX2ljb24ubGFyZ2VfYml0bWFwDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHJ2dGFwaV9vYmouTGFyZ2VJbWFnZSA9IGJ1dHRvbl9pY29uLm1lZGl1bV9iaXRtYXANCiAgICAgICAgICAgIHNlbGYuX2RpcnR5ID0gVHJ1ZQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGljb25fZXJyOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0Vycm9yIGluIGFwcGx5aW5nIGljb24gdG8gYnV0dG9uID4ge30gOiB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQoaWNvbl9maWxlLCBpY29uX2VycikpDQoNCiAgICBkZWYgc2V0X3Rvb2x0aXAoc2VsZiwgdG9vbHRpcCk6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGlmIHRvb2x0aXA6DQogICAgICAgICAgICAgICAgc2VsZi5nZXRfcnZ0YXBpX29iamVjdCgpLlRvb2xUaXAgPSB0b29sdGlwDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIGFkd2luZG93c19vYmogPSBzZWxmLmdldF9hZHdpbmRvd3Nfb2JqZWN0KCkNCiAgICAgICAgICAgICAgICBpZiBhZHdpbmRvd3Nfb2JqIGFuZCBhZHdpbmRvd3Nfb2JqLlRvb2xUaXA6DQogICAgICAgICAgICAgICAgICAgIGFkd2luZG93c19vYmouVG9vbFRpcC5Db250ZW50ID0gTm9uZQ0KICAgICAgICAgICAgc2VsZi5fZGlydHkgPSBUcnVlDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgdG9vbHRpcF9lcnI6DQogICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignSXRlbSBkb2VzIG5vdCBoYXZlIHRvb2x0aXAgcHJvcGVydHk6IHt9Jw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdCh0b29sdGlwX2VycikpDQoNCiAgICBkZWYgc2V0X3Rvb2x0aXBfZXh0KHNlbGYsIHRvb2x0aXBfZXh0KToNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgaWYgdG9vbHRpcF9leHQ6DQogICAgICAgICAgICAgICAgc2VsZi5nZXRfcnZ0YXBpX29iamVjdCgpLkxvbmdEZXNjcmlwdGlvbiA9IHRvb2x0aXBfZXh0DQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIGFkd2luZG93c19vYmogPSBzZWxmLmdldF9hZHdpbmRvd3Nfb2JqZWN0KCkNCiAgICAgICAgICAgICAgICBpZiBhZHdpbmRvd3Nfb2JqIGFuZCBhZHdpbmRvd3Nfb2JqLlRvb2xUaXA6DQogICAgICAgICAgICAgICAgICAgIGFkd2luZG93c19vYmouVG9vbFRpcC5FeHBhbmRlZENvbnRlbnQgPSBOb25lDQogICAgICAgICAgICBzZWxmLl9kaXJ0eSA9IFRydWUNCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyB0b29sdGlwX2VycjoNCiAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRVSUVycm9yKCdJdGVtIGRvZXMgbm90IGhhdmUgZXh0ZW5kZWQgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Rvb2x0aXAgcHJvcGVydHk6IHt9Jy5mb3JtYXQodG9vbHRpcF9lcnIpKQ0KDQogICAgZGVmIHNldF90b29sdGlwX2ltYWdlKHNlbGYsIHRvb2x0aXBfaW1hZ2UpOg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBhZHdpbmRvd3Nfb2JqID0gc2VsZi5nZXRfYWR3aW5kb3dzX29iamVjdCgpDQogICAgICAgICAgICBpZiBhZHdpbmRvd3Nfb2JqIGFuZCBhZHdpbmRvd3Nfb2JqLlRvb2xUaXA6DQogICAgICAgICAgICAgICAgYWR3aW5kb3dzX29iai5Ub29sVGlwLkV4cGFuZGVkSW1hZ2UgPSBcDQogICAgICAgICAgICAgICAgICAgIGxvYWRfYml0bWFwaW1hZ2UodG9vbHRpcF9pbWFnZSkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgc2VsZi50b29sdGlwX2ltYWdlID0gdG9vbHRpcF9pbWFnZQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHR0aW1hZ2VfZXJyOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0Vycm9yIHNldHRpbmcgdG9vbHRpcCBpbWFnZSB7fSB8IHt9ICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQodG9vbHRpcF9pbWFnZSwgdHRpbWFnZV9lcnIpKQ0KDQogICAgZGVmIHNldF90b29sdGlwX3ZpZGVvKHNlbGYsIHRvb2x0aXBfdmlkZW8pOg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBhZHdpbmRvd3Nfb2JqID0gc2VsZi5nZXRfYWR3aW5kb3dzX29iamVjdCgpDQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKS5Ub29sVGlwLCBzdHIpOg0KICAgICAgICAgICAgICAgIGV4VG9vbFRpcCA9IHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKS5Ub29sVGlwDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIGV4VG9vbFRpcCA9IE5vbmUNCiAgICAgICAgICAgIGlmIGFkd2luZG93c19vYmo6DQogICAgICAgICAgICAgICAgYWR3aW5kb3dzX29iai5Ub29sVGlwID0gQWRXaW5kb3dzLlJpYmJvblRvb2xUaXAoKQ0KICAgICAgICAgICAgICAgIGFkd2luZG93c19vYmouVG9vbFRpcC5UaXRsZSA9IHNlbGYudWlfdGl0bGUNCiAgICAgICAgICAgICAgICBhZHdpbmRvd3Nfb2JqLlRvb2xUaXAuQ29udGVudCA9IGV4VG9vbFRpcA0KICAgICAgICAgICAgICAgIF9TdGFja1BhbmVsID0gU3lzdGVtLldpbmRvd3MuQ29udHJvbHMuU3RhY2tQYW5lbCgpDQogICAgICAgICAgICAgICAgX3ZpZGVvID0gU3lzdGVtLldpbmRvd3MuQ29udHJvbHMuTWVkaWFFbGVtZW50KCkNCiAgICAgICAgICAgICAgICBfdmlkZW8uU291cmNlID0gVXJpKHRvb2x0aXBfdmlkZW8pDQogICAgICAgICAgICAgICAgX1N0YWNrUGFuZWwuQ2hpbGRyZW4uQWRkKF92aWRlbykNCiAgICAgICAgICAgICAgICBhZHdpbmRvd3Nfb2JqLlRvb2xUaXAuRXhwYW5kZWRDb250ZW50ID0gX1N0YWNrUGFuZWwNCiAgICAgICAgICAgICAgICBhZHdpbmRvd3Nfb2JqLlJlc29sdmVUb29sVGlwKCkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgc2VsZi50b29sdGlwX3ZpZGVvID0gdG9vbHRpcF92aWRlbw0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHR0dmlkZW9fZXJyOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0Vycm9yIHNldHRpbmcgdG9vbHRpcCB2aWRlbyB7fSB8IHt9ICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQodG9vbHRpcF92aWRlbywgdHR2aWRlb19lcnIpKQ0KDQogICAgZGVmIHNldF90b29sdGlwX21lZGlhKHNlbGYsIHRvb2x0aXBfbWVkaWEpOg0KICAgICAgICBpZiB0b29sdGlwX21lZGlhLmVuZHN3aXRoKERFRkFVTFRfVE9PTFRJUF9JTUFHRV9GT1JNQVQpOg0KICAgICAgICAgICAgc2VsZi5zZXRfdG9vbHRpcF9pbWFnZSh0b29sdGlwX21lZGlhKQ0KICAgICAgICBlbGlmIHRvb2x0aXBfbWVkaWEuZW5kc3dpdGgoREVGQVVMVF9UT09MVElQX1ZJREVPX0ZPUk1BVCk6DQogICAgICAgICAgICBzZWxmLnNldF90b29sdGlwX3ZpZGVvKHRvb2x0aXBfbWVkaWEpDQoNCiAgICBkZWYgcmVzZXRfaGlnaGxpZ2h0cyhzZWxmKToNCiAgICAgICAgaWYgaGFzYXR0cihBZEludGVybmFsLldpbmRvd3MsICdIaWdobGlnaHRNb2RlJyk6DQogICAgICAgICAgICBhZHdpbmRvd3Nfb2JqID0gc2VsZi5nZXRfYWR3aW5kb3dzX29iamVjdCgpDQogICAgICAgICAgICBpZiBhZHdpbmRvd3Nfb2JqOg0KICAgICAgICAgICAgICAgIGFkd2luZG93c19vYmouSGlnaGxpZ2h0ID0gXA0KICAgICAgICAgICAgICAgICAgICBjb3JldXRpbHMuZ2V0X2VudW1fbm9uZShBZEludGVybmFsLldpbmRvd3MuSGlnaGxpZ2h0TW9kZSkNCg0KICAgIGRlZiBoaWdobGlnaHRfYXNfbmV3KHNlbGYpOg0KICAgICAgICBpZiBoYXNhdHRyKEFkSW50ZXJuYWwuV2luZG93cywgJ0hpZ2hsaWdodE1vZGUnKToNCiAgICAgICAgICAgIGFkd2luZG93c19vYmogPSBzZWxmLmdldF9hZHdpbmRvd3Nfb2JqZWN0KCkNCiAgICAgICAgICAgIGlmIGFkd2luZG93c19vYmo6DQogICAgICAgICAgICAgICAgYWR3aW5kb3dzX29iai5IaWdobGlnaHQgPSBcDQogICAgICAgICAgICAgICAgICAgIEFkSW50ZXJuYWwuV2luZG93cy5IaWdobGlnaHRNb2RlLk5ldw0KDQogICAgZGVmIGhpZ2hsaWdodF9hc191cGRhdGVkKHNlbGYpOg0KICAgICAgICBpZiBoYXNhdHRyKEFkSW50ZXJuYWwuV2luZG93cywgJ0hpZ2hsaWdodE1vZGUnKToNCiAgICAgICAgICAgIGFkd2luZG93c19vYmogPSBzZWxmLmdldF9hZHdpbmRvd3Nfb2JqZWN0KCkNCiAgICAgICAgICAgIGlmIGFkd2luZG93c19vYmo6DQogICAgICAgICAgICAgICAgYWR3aW5kb3dzX29iai5IaWdobGlnaHQgPSBcDQogICAgICAgICAgICAgICAgICAgIEFkSW50ZXJuYWwuV2luZG93cy5IaWdobGlnaHRNb2RlLlVwZGF0ZWQNCg0KICAgIGRlZiBwcm9jZXNzX2RlZmVycmVkKHNlbGYpOg0KICAgICAgICBHZW5lcmljUHlSZXZpdFVJQ29udGFpbmVyLnByb2Nlc3NfZGVmZXJyZWQoc2VsZikNCg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBpZiBzZWxmLnRvb2x0aXBfaW1hZ2U6DQogICAgICAgICAgICAgICAgc2VsZi5zZXRfdG9vbHRpcF9pbWFnZShzZWxmLnRvb2x0aXBfaW1hZ2UpDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgdHR2aWRlb19lcnI6DQogICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignRXJyb3Igc2V0dGluZyBkZWZmZXJlZCB0b29sdGlwIGltYWdlIHt9IHwge30gJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChzZWxmLnRvb2x0aXBfdmlkZW8sIHR0dmlkZW9fZXJyKSkNCg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBpZiBzZWxmLnRvb2x0aXBfdmlkZW86DQogICAgICAgICAgICAgICAgc2VsZi5zZXRfdG9vbHRpcF92aWRlbyhzZWxmLnRvb2x0aXBfdmlkZW8pDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgdHR2aWRlb19lcnI6DQogICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignRXJyb3Igc2V0dGluZyBkZWZmZXJlZCB0b29sdGlwIHZpZGVvIHt9IHwge30gJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChzZWxmLnRvb2x0aXBfdmlkZW8sIHR0dmlkZW9fZXJyKSkNCg0KICAgIGRlZiBnZXRfY29udGV4dGhlbHAoc2VsZik6DQogICAgICAgIHJldHVybiBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuR2V0Q29udGV4dHVhbEhlbHAoKQ0KDQogICAgZGVmIHNldF9jb250ZXh0aGVscChzZWxmLCBjdHhoZWxwdXJsKToNCiAgICAgICAgaWYgY3R4aGVscHVybDoNCiAgICAgICAgICAgIGNoID0gVUkuQ29udGV4dHVhbEhlbHAoVUkuQ29udGV4dHVhbEhlbHBUeXBlLlVybCwgY3R4aGVscHVybCkNCiAgICAgICAgICAgIHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKS5TZXRDb250ZXh0dWFsSGVscChjaCkNCg0KICAgIGRlZiBzZXRfdGl0bGUoc2VsZiwgdWlfdGl0bGUpOg0KICAgICAgICBpZiBzZWxmLml0ZW1kYXRhX21vZGU6DQogICAgICAgICAgICBzZWxmLnVpX3RpdGxlID0gdWlfdGl0bGUNCiAgICAgICAgICAgIHNlbGYuX2RpcnR5ID0gVHJ1ZQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgc2VsZi5fcnZ0YXBpX29iamVjdC5JdGVtVGV4dCA9IHNlbGYudWlfdGl0bGUgPSB1aV90aXRsZQ0KICAgICAgICAgICAgc2VsZi5fZGlydHkgPSBUcnVlDQoNCiAgICBkZWYgZ2V0X3RpdGxlKHNlbGYpOg0KICAgICAgICBpZiBzZWxmLml0ZW1kYXRhX21vZGU6DQogICAgICAgICAgICByZXR1cm4gc2VsZi51aV90aXRsZQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3J2dGFwaV9vYmplY3QuSXRlbVRleHQNCg0KICAgIGRlZiBnZXRfY29udHJvbF9pZChzZWxmKToNCiAgICAgICAgYWR3aW5kb3dzX29iaiA9IHNlbGYuZ2V0X2Fkd2luZG93c19vYmplY3QoKQ0KICAgICAgICBpZiBhZHdpbmRvd3Nfb2JqIGFuZCBoYXNhdHRyKGFkd2luZG93c19vYmosICdJZCcpOg0KICAgICAgICAgICAgcmV0dXJuIGdldGF0dHIoYWR3aW5kb3dzX29iaiwgJ0lkJywgJycpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgYXNzZW1ibHlfbmFtZShzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuX3J2dGFwaV9vYmplY3QuQXNzZW1ibHlOYW1lDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgY2xhc3NfbmFtZShzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuX3J2dGFwaV9vYmplY3QuQ2xhc3NOYW1lDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgYXZhaWxhYmlsaXR5X2NsYXNzX25hbWUoc2VsZik6DQogICAgICAgIHJldHVybiBzZWxmLl9ydnRhcGlfb2JqZWN0LkF2YWlsYWJpbGl0eUNsYXNzTmFtZQ0KDQoNCmNsYXNzIF9QeVJldml0UmliYm9uR3JvdXBJdGVtKEdlbmVyaWNQeVJldml0VUlDb250YWluZXIpOg0KDQogICAgYnV0dG9uID0gR2VuZXJpY1B5UmV2aXRVSUNvbnRhaW5lci5fZ2V0X2NvbXBvbmVudA0KDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIHJpYmJvbl9pdGVtKToNCiAgICAgICAgR2VuZXJpY1B5UmV2aXRVSUNvbnRhaW5lci5fX2luaXRfXyhzZWxmKQ0KDQogICAgICAgIHNlbGYubmFtZSA9IHJpYmJvbl9pdGVtLk5hbWUNCiAgICAgICAgc2VsZi5fcnZ0YXBpX29iamVjdCA9IHJpYmJvbl9pdGVtDQoNCiAgICAgICAgIyB3aGVuIGNvbnRhaW5lciBpcyBpbiBpdGVtZGF0YV9tb2RlLCBzZWxmLl9ydnRhcGlfb2JqZWN0IGlzIGENCiAgICAgICAgIyBSaWJib25JdGVtRGF0YSBhbmQgbm90IGFuIGFjdHVhbCB1aSBpdGVtIHdoZW4gY29udGFpbmVyIGlzIGluDQogICAgICAgICMgaXRlbWRhdGFfbW9kZSwgb25seSB0aGUgbmVjZXNzYXJ5IFJpYmJvbkl0ZW1EYXRhIG9iamVjdHMgd2lsbA0KICAgICAgICAjIGJlIGNyZWF0ZWQgZm9yIGNoaWxkcmVuIGEgc3Vuc2VxdWVudCBjYWxsIHRvIGNyZWF0ZV9kYXRhX2l0ZW1zDQogICAgICAgICMgd2lsbCBjcmVhdGUgdWkgZm9yIFJpYmJvbkl0ZW1EYXRhIG9iamVjdHMNCiAgICAgICAgc2VsZi5pdGVtZGF0YV9tb2RlID0gaXNpbnN0YW5jZShzZWxmLl9ydnRhcGlfb2JqZWN0LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVJLlJpYmJvbkl0ZW1EYXRhKQ0KDQogICAgICAgICMgaWYgYnV0dG9uIGdyb3VwIHNob3dzIHRoZSBhY3RpdmUgYnV0dG9uIGljb24sIHRoZW4gdGhlIGNoaWxkDQogICAgICAgICMgYnV0dG9ucyBuZWVkIHRvIGhhdmUgbGFyZ2UgaWNvbnMNCiAgICAgICAgc2VsZi5fdXNlX2FjdGl2ZV9pdGVtX2ljb24gPSBzZWxmLmlzX3NwbGl0YnV0dG9uKCkNCg0KICAgICAgICAjIGJ5IGRlZmF1bHQgdGhlIGxhc3QgaXRlbSB1c2VkLCBzdGF5cyBvbiB0b3AgYXMgdGhlIGRlZmF1bHQgYnV0dG9uDQogICAgICAgIHNlbGYuX3N5bmNfd2l0aF9jdXJfaXRlbSA9IFRydWUNCg0KICAgICAgICAjIGdldHRpbmcgYSBsaXN0IG9mIGV4aXN0aW5nIGl0ZW1zIHVuZGVyIHRoaXMgaXRlbSBncm91cC4NCiAgICAgICAgaWYgbm90IHNlbGYuaXRlbWRhdGFfbW9kZToNCiAgICAgICAgICAgIGZvciByZXZpdF9idXR0b24gaW4gcmliYm9uX2l0ZW0uR2V0SXRlbXMoKToNCiAgICAgICAgICAgICAgICAjIGZlZWRpbmcgX3N1Yl9uYXRpdmVfcmliYm9uX2l0ZW1zIHdpdGggYW4gaW5zdGFuY2Ugb2YNCiAgICAgICAgICAgICAgICAjIF9QeVJldml0UmliYm9uQnV0dG9uIGZvciBleGlzdGluZyBidXR0b25zDQogICAgICAgICAgICAgICAgc2VsZi5fYWRkX2NvbXBvbmVudChfUHlSZXZpdFJpYmJvbkJ1dHRvbihyZXZpdF9idXR0b24pKQ0KDQogICAgZGVmIGlzX3NwbGl0YnV0dG9uKHNlbGYpOg0KICAgICAgICByZXR1cm4gaXNpbnN0YW5jZShzZWxmLl9ydnRhcGlfb2JqZWN0LCBVSS5TcGxpdEJ1dHRvbikgXA0KICAgICAgICAgICAgICAgb3IgaXNpbnN0YW5jZShzZWxmLl9ydnRhcGlfb2JqZWN0LCBVSS5TcGxpdEJ1dHRvbkRhdGEpDQoNCiAgICBkZWYgc2V0X3J2dGFwaV9vYmplY3Qoc2VsZiwgcnZ0YXBpX29iaik6DQogICAgICAgIEdlbmVyaWNQeVJldml0VUlDb250YWluZXIuc2V0X3J2dGFwaV9vYmplY3Qoc2VsZiwgcnZ0YXBpX29iaikNCiAgICAgICAgaWYgc2VsZi5pc19zcGxpdGJ1dHRvbigpOg0KICAgICAgICAgICAgc2VsZi5nZXRfcnZ0YXBpX29iamVjdCgpLklzU3luY2hyb25pemVkV2l0aEN1cnJlbnRJdGVtID0gXA0KICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfd2l0aF9jdXJfaXRlbQ0KDQogICAgZGVmIGNyZWF0ZV9kYXRhX2l0ZW1zKHNlbGYpOg0KICAgICAgICAjIGl0ZXJhdGUgdGhyb3VnaCBkYXRhIGl0ZW1zIGFuZCB0aGVpciBhc3NvY2lhdGVkIHJldml0DQogICAgICAgICMgYXBpIGRhdGEgb2JqZWN0cyBhbmQgY3JlYXRlIHVpIG9iamVjdHMNCiAgICAgICAgZm9yIHB5cnZ0X3VpX2l0ZW0gaW4gW3ggZm9yIHggaW4gc2VsZiBpZiB4Lml0ZW1kYXRhX21vZGVdOg0KICAgICAgICAgICAgcnZ0YXBpX2RhdGFfb2JqID0gcHlydnRfdWlfaXRlbS5nZXRfcnZ0YXBpX29iamVjdCgpDQoNCiAgICAgICAgICAgICMgY3JlYXRlIGl0ZW0gaW4gdWkgYW5kIGdldCBjb3JyZXNwb2RpbmcgcmV2aXQgdWkgb2JqZWN0cw0KICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShweXJ2dF91aV9pdGVtLCBfUHlSZXZpdFJpYmJvbkJ1dHRvbik6DQogICAgICAgICAgICAgICAgcnZ0YXBpX3JpYmJvbl9pdGVtID0gXA0KICAgICAgICAgICAgICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuQWRkUHVzaEJ1dHRvbihydnRhcGlfZGF0YV9vYmopDQogICAgICAgICAgICAgICAgcnZ0YXBpX3JpYmJvbl9pdGVtLkl0ZW1UZXh0ID0gcHlydnRfdWlfaXRlbS5nZXRfdGl0bGUoKQ0KDQogICAgICAgICAgICAgICAgIyByZXBsYWNlIGRhdGEgb2JqZWN0IHdpdGggdGhlIG5ld2x5IGNyZWF0ZSByaWJib24gaXRlbQ0KICAgICAgICAgICAgICAgIHB5cnZ0X3VpX2l0ZW0uc2V0X3J2dGFwaV9vYmplY3QocnZ0YXBpX3JpYmJvbl9pdGVtKQ0KDQogICAgICAgICAgICAgICAgIyBleHRlbmRlZCB0b29sdGlwcyAoaW1hZ2VzIGFuZCB2aWRlb3MpIGNhbiBvbmx5IGJlIGFwcGxpZWQgd2hlbg0KICAgICAgICAgICAgICAgICMgdGhlIHVpIGVsZW1lbnQgaXMgY3JlYXRlZA0KICAgICAgICAgICAgICAgIHB5cnZ0X3VpX2l0ZW0ucHJvY2Vzc19kZWZlcnJlZCgpDQoNCiAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShweXJ2dF91aV9pdGVtLCBfUHlSZXZpdFNlcGFyYXRvcik6DQogICAgICAgICAgICAgICAgc2VsZi5nZXRfcnZ0YXBpX29iamVjdCgpLkFkZFNlcGFyYXRvcigpDQoNCiAgICAgICAgc2VsZi5pdGVtZGF0YV9tb2RlID0gRmFsc2UNCg0KICAgIGRlZiBzeW5jX3dpdGhfY3VycmVudF9pdGVtKHNlbGYsIHN0YXRlKToNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgaWYgbm90IHNlbGYuaXRlbWRhdGFfbW9kZToNCiAgICAgICAgICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuSXNTeW5jaHJvbml6ZWRXaXRoQ3VycmVudEl0ZW0gPSBzdGF0ZQ0KICAgICAgICAgICAgc2VsZi5fc3luY193aXRoX2N1cl9pdGVtID0gc3RhdGUNCiAgICAgICAgICAgIHNlbGYuX2RpcnR5ID0gVHJ1ZQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHN5bmNfaXRlbV9lcnI6DQogICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignSXRlbSBpcyBub3QgYSBzcGxpdCBidXR0b24uICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd8IHt9Jy5mb3JtYXQoc3luY19pdGVtX2VycikpDQoNCiAgICBkZWYgc2V0X2ljb24oc2VsZiwgaWNvbl9maWxlLCBpY29uX3NpemU9SUNPTl9MQVJHRSk6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGJ1dHRvbl9pY29uID0gQnV0dG9uSWNvbnMoaWNvbl9maWxlKQ0KICAgICAgICAgICAgcnZ0YXBpX29iaiA9IHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKQ0KICAgICAgICAgICAgcnZ0YXBpX29iai5JbWFnZSA9IGJ1dHRvbl9pY29uLnNtYWxsX2JpdG1hcA0KICAgICAgICAgICAgaWYgaWNvbl9zaXplID09IElDT05fTEFSR0U6DQogICAgICAgICAgICAgICAgcnZ0YXBpX29iai5MYXJnZUltYWdlID0gYnV0dG9uX2ljb24ubGFyZ2VfYml0bWFwDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHJ2dGFwaV9vYmouTGFyZ2VJbWFnZSA9IGJ1dHRvbl9pY29uLm1lZGl1bV9iaXRtYXANCiAgICAgICAgICAgIHNlbGYuX2RpcnR5ID0gVHJ1ZQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGljb25fZXJyOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0Vycm9yIGluIGFwcGx5aW5nIGljb24gdG8gYnV0dG9uID4ge30gOiB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQoaWNvbl9maWxlLCBpY29uX2VycikpDQoNCiAgICBkZWYgZ2V0X2NvbnRleHRoZWxwKHNlbGYpOg0KICAgICAgICByZXR1cm4gc2VsZi5nZXRfcnZ0YXBpX29iamVjdCgpLkdldENvbnRleHR1YWxIZWxwKCkNCg0KICAgIGRlZiBzZXRfY29udGV4dGhlbHAoc2VsZiwgY3R4aGVscHVybCk6DQogICAgICAgIGlmIGN0eGhlbHB1cmw6DQogICAgICAgICAgICBjaCA9IFVJLkNvbnRleHR1YWxIZWxwKFVJLkNvbnRleHR1YWxIZWxwVHlwZS5VcmwsIGN0eGhlbHB1cmwpDQogICAgICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuU2V0Q29udGV4dHVhbEhlbHAoY2gpDQoNCiAgICBkZWYgcmVzZXRfaGlnaGxpZ2h0cyhzZWxmKToNCiAgICAgICAgaWYgaGFzYXR0cihBZEludGVybmFsLldpbmRvd3MsICdIaWdobGlnaHRNb2RlJyk6DQogICAgICAgICAgICBhZHdpbmRvd3Nfb2JqID0gc2VsZi5nZXRfYWR3aW5kb3dzX29iamVjdCgpDQogICAgICAgICAgICBpZiBhZHdpbmRvd3Nfb2JqOg0KICAgICAgICAgICAgICAgIGFkd2luZG93c19vYmouSGlnaGxpZ2h0RHJvcERvd24gPSBcDQogICAgICAgICAgICAgICAgICAgIGNvcmV1dGlscy5nZXRfZW51bV9ub25lKEFkSW50ZXJuYWwuV2luZG93cy5IaWdobGlnaHRNb2RlKQ0KDQogICAgZGVmIGhpZ2hsaWdodF9hc19uZXcoc2VsZik6DQogICAgICAgIGlmIGhhc2F0dHIoQWRJbnRlcm5hbC5XaW5kb3dzLCAnSGlnaGxpZ2h0TW9kZScpOg0KICAgICAgICAgICAgYWR3aW5kb3dzX29iaiA9IHNlbGYuZ2V0X2Fkd2luZG93c19vYmplY3QoKQ0KICAgICAgICAgICAgaWYgYWR3aW5kb3dzX29iajoNCiAgICAgICAgICAgICAgICBhZHdpbmRvd3Nfb2JqLkhpZ2hsaWdodERyb3BEb3duID0gXA0KICAgICAgICAgICAgICAgICAgICBBZEludGVybmFsLldpbmRvd3MuSGlnaGxpZ2h0TW9kZS5OZXcNCg0KICAgIGRlZiBoaWdobGlnaHRfYXNfdXBkYXRlZChzZWxmKToNCiAgICAgICAgaWYgaGFzYXR0cihBZEludGVybmFsLldpbmRvd3MsICdIaWdobGlnaHRNb2RlJyk6DQogICAgICAgICAgICBhZHdpbmRvd3Nfb2JqID0gc2VsZi5nZXRfYWR3aW5kb3dzX29iamVjdCgpDQogICAgICAgICAgICBpZiBhZHdpbmRvd3Nfb2JqOg0KICAgICAgICAgICAgICAgIGFkd2luZG93c19vYmouSGlnaGxpZ2h0RHJvcERvd24gPSBcDQogICAgICAgICAgICAgICAgICAgIEFkSW50ZXJuYWwuV2luZG93cy5IaWdobGlnaHRNb2RlLlVwZGF0ZWQNCg0KICAgIGRlZiBjcmVhdGVfcHVzaF9idXR0b24oc2VsZiwgYnV0dG9uX25hbWUsIGFzbV9sb2NhdGlvbiwgY2xhc3NfbmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb25fcGF0aD0nJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2x0aXA9JycsIHRvb2x0aXBfZXh0PScnLCB0b29sdGlwX21lZGlhPScnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4aGVscHVybD1Ob25lLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZhaWxfY2xhc3NfbmFtZT1Ob25lLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2lmX2V4aXN0cz1GYWxzZSwgdWlfdGl0bGU9Tm9uZSk6DQogICAgICAgIGlmIHNlbGYuY29udGFpbnMoYnV0dG9uX25hbWUpOg0KICAgICAgICAgICAgaWYgdXBkYXRlX2lmX2V4aXN0czoNCiAgICAgICAgICAgICAgICBleGlzdGluZ19pdGVtID0gc2VsZi5fZ2V0X2NvbXBvbmVudChidXR0b25fbmFtZSkNCiAgICAgICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgICAgICMgQXNzZW1ibHkgYW5kIENsYXNzIGluZm8gb2YgY3VycmVudCBhY3RpdmUgc2NyaXB0DQogICAgICAgICAgICAgICAgICAgICMgYnV0dG9uIGNhbiBub3QgYmUgdXBkYXRlZC4NCiAgICAgICAgICAgICAgICAgICAgaWYgYnV0dG9uX25hbWUgIT0gRVhFQ19QQVJBTVMuY29tbWFuZF9uYW1lOg0KICAgICAgICAgICAgICAgICAgICAgICAgcnZ0YXBpX29iaiA9IGV4aXN0aW5nX2l0ZW0uZ2V0X3J2dGFwaV9vYmplY3QoKQ0KICAgICAgICAgICAgICAgICAgICAgICAgcnZ0YXBpX29iai5Bc3NlbWJseU5hbWUgPSBhc21fbG9jYXRpb24NCiAgICAgICAgICAgICAgICAgICAgICAgIHJ2dGFwaV9vYmouQ2xhc3NOYW1lID0gY2xhc3NfbmFtZQ0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgYXZhaWxfY2xhc3NfbmFtZToNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ19pdGVtLmdldF9ydnRhcGlfb2JqZWN0KCkgXA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuQXZhaWxhYmlsaXR5Q2xhc3NOYW1lID0gYXZhaWxfY2xhc3NfbmFtZQ0KICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgYXNtX3VwZGF0ZV9lcnI6DQogICAgICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0Vycm9yIHVwZGF0aW5nIGJ1dHRvbiBhc20gaW5mbzogJXMgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd8ICVzJywgYnV0dG9uX25hbWUsIGFzbV91cGRhdGVfZXJyKQ0KDQogICAgICAgICAgICAgICAgaWYgbm90IGljb25fcGF0aDoNCiAgICAgICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnSWNvbiBub3Qgc2V0IGZvciAlcycsIGJ1dHRvbl9uYW1lKQ0KICAgICAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgICAgICMgaWYgYnV0dG9uIGdyb3VwIHNob3dzIHRoZSBhY3RpdmUgYnV0dG9uIGljb24sDQogICAgICAgICAgICAgICAgICAgICAgICAjIHRoZW4gdGhlIGNoaWxkIGJ1dHRvbnMgbmVlZCB0byBoYXZlIGxhcmdlIGljb25zDQogICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ19pdGVtLnNldF9pY29uKGljb25fcGF0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbl9zaXplPUlDT05fTEFSR0UNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fdXNlX2FjdGl2ZV9pdGVtX2ljb24NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBJQ09OX01FRElVTSkNCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFB5UmV2aXRVSUVycm9yIGFzIGljb25lcnI6DQogICAgICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCdFcnJvciBhZGRpbmcgaWNvbiBmb3IgJXMgfCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl9uYW1lLCBpY29uZXJyKQ0KDQogICAgICAgICAgICAgICAgZXhpc3RpbmdfaXRlbS5zZXRfdG9vbHRpcCh0b29sdGlwKQ0KICAgICAgICAgICAgICAgIGV4aXN0aW5nX2l0ZW0uc2V0X3Rvb2x0aXBfZXh0KHRvb2x0aXBfZXh0KQ0KICAgICAgICAgICAgICAgIGlmIHRvb2x0aXBfbWVkaWE6DQogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nX2l0ZW0uc2V0X3Rvb2x0aXBfbWVkaWEodG9vbHRpcF9tZWRpYSkNCg0KICAgICAgICAgICAgICAgICMgaWYgY3R4IGhlbHAgb24gdGhpcyBncm91cCBtYXRjaGVzIHRoZSBleGlzdGluZywNCiAgICAgICAgICAgICAgICAjIHVwZGF0ZSBzZWxmIGN0eCBiZWZvcmUgY2hhbmdpbmcgdGhlIGV4aXN0aW5nIGl0ZW0gY3R4IGhlbHANCiAgICAgICAgICAgICAgICBzZWxmX2N0eGhlbHAgPSBzZWxmLmdldF9jb250ZXh0aGVscCgpDQogICAgICAgICAgICAgICAgY3R4X2hlbHAgPSBleGlzdGluZ19pdGVtLmdldF9jb250ZXh0aGVscCgpDQogICAgICAgICAgICAgICAgaWYgc2VsZl9jdHhoZWxwIGFuZCBjdHhfaGVscCBcDQogICAgICAgICAgICAgICAgICAgICAgICBhbmQgc2VsZl9jdHhoZWxwLkhlbHBUeXBlID09IGN0eF9oZWxwLkhlbHBUeXBlIFwNCiAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBzZWxmX2N0eGhlbHAuSGVscFBhdGggPT0gY3R4X2hlbHAuSGVscFBhdGg6DQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0X2NvbnRleHRoZWxwKGN0eGhlbHB1cmwpDQogICAgICAgICAgICAgICAgIyBub3cgY2hhbmdlIHRoZSBleGlzdGluZyBpdGVtIGN0eCBoZWxwDQogICAgICAgICAgICAgICAgZXhpc3RpbmdfaXRlbS5zZXRfY29udGV4dGhlbHAoY3R4aGVscHVybCkNCg0KICAgICAgICAgICAgICAgIGlmIHVpX3RpdGxlOg0KICAgICAgICAgICAgICAgICAgICBleGlzdGluZ19pdGVtLnNldF90aXRsZSh1aV90aXRsZSkNCg0KICAgICAgICAgICAgICAgIGV4aXN0aW5nX2l0ZW0uYWN0aXZhdGUoKQ0KICAgICAgICAgICAgICAgIHJldHVybg0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignUHVzaCBidXR0b24gYWxyZWFkeSBleGl0cyBhbmQgdXBkYXRlICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXMgbm90IGFsbG93ZWQ6IHt9Jy5mb3JtYXQoYnV0dG9uX25hbWUpKQ0KDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ1BhcmVudCBkb2VzIG5vdCBpbmNsdWRlIHRoaXMgYnV0dG9uLiBDcmVhdGluZzogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl9uYW1lKQ0KICAgICAgICB0cnk6DQogICAgICAgICAgICBidXR0b25fZGF0YSA9IFwNCiAgICAgICAgICAgICAgICBVSS5QdXNoQnV0dG9uRGF0YShidXR0b25fbmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fbmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc21fbG9jYXRpb24sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NfbmFtZSkNCiAgICAgICAgICAgIGlmIGF2YWlsX2NsYXNzX25hbWU6DQogICAgICAgICAgICAgICAgYnV0dG9uX2RhdGEuQXZhaWxhYmlsaXR5Q2xhc3NOYW1lID0gYXZhaWxfY2xhc3NfbmFtZQ0KICAgICAgICAgICAgaWYgbm90IHNlbGYuaXRlbWRhdGFfbW9kZToNCiAgICAgICAgICAgICAgICByaWJib25fYnV0dG9uID0gXA0KICAgICAgICAgICAgICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuQWRkUHVzaEJ1dHRvbihidXR0b25fZGF0YSkNCiAgICAgICAgICAgICAgICBuZXdfYnV0dG9uID0gX1B5UmV2aXRSaWJib25CdXR0b24ocmliYm9uX2J1dHRvbikNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgbmV3X2J1dHRvbiA9IF9QeVJldml0UmliYm9uQnV0dG9uKGJ1dHRvbl9kYXRhKQ0KDQogICAgICAgICAgICBpZiB1aV90aXRsZToNCiAgICAgICAgICAgICAgICBuZXdfYnV0dG9uLnNldF90aXRsZSh1aV90aXRsZSkNCg0KICAgICAgICAgICAgaWYgbm90IGljb25fcGF0aDoNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdJY29uIG5vdCBzZXQgZm9yICVzJywgYnV0dG9uX25hbWUpDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0NyZWF0aW5nIGljb24gZm9yIHB1c2ggYnV0dG9uICVzIGZyb20gZmlsZTogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX25hbWUsIGljb25fcGF0aCkNCiAgICAgICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgICAgICMgaWYgYnV0dG9uIGdyb3VwIHNob3dzIHRoZSBhY3RpdmUgYnV0dG9uIGljb24sDQogICAgICAgICAgICAgICAgICAgICMgdGhlbiB0aGUgY2hpbGQgYnV0dG9ucyBuZWVkIHRvIGhhdmUgbGFyZ2UgaWNvbnMNCiAgICAgICAgICAgICAgICAgICAgbmV3X2J1dHRvbi5zZXRfaWNvbigNCiAgICAgICAgICAgICAgICAgICAgICAgIGljb25fcGF0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgIGljb25fc2l6ZT1JQ09OX0xBUkdFDQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl91c2VfYWN0aXZlX2l0ZW1faWNvbiBlbHNlIElDT05fTUVESVVNKQ0KICAgICAgICAgICAgICAgIGV4Y2VwdCBQeVJldml0VUlFcnJvciBhcyBpY29uZXJyOg0KICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdFcnJvciBhZGRpbmcgaWNvbiBmb3IgJXMgZnJvbSAlcyAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wgJXMnLCBidXR0b25fbmFtZSwgaWNvbl9wYXRoLCBpY29uZXJyKQ0KDQogICAgICAgICAgICBuZXdfYnV0dG9uLnNldF90b29sdGlwKHRvb2x0aXApDQogICAgICAgICAgICBuZXdfYnV0dG9uLnNldF90b29sdGlwX2V4dCh0b29sdGlwX2V4dCkNCiAgICAgICAgICAgIGlmIHRvb2x0aXBfbWVkaWE6DQogICAgICAgICAgICAgICAgbmV3X2J1dHRvbi5zZXRfdG9vbHRpcF9tZWRpYSh0b29sdGlwX21lZGlhKQ0KDQogICAgICAgICAgICBuZXdfYnV0dG9uLnNldF9jb250ZXh0aGVscChjdHhoZWxwdXJsKQ0KICAgICAgICAgICAgIyBpZiB0aGlzIGlzIHRoZSBmaXJzdCBidXR0b24gYmVpbmcgYWRkZWQNCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmtleXMoKToNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdTZXR0aW5nIGN0eCBoZWxwIG9uIHBhcmVudDogJXMnLCBjdHhoZWxwdXJsKQ0KICAgICAgICAgICAgICAgIHNlbGYuc2V0X2NvbnRleHRoZWxwKGN0eGhlbHB1cmwpDQoNCiAgICAgICAgICAgIG5ld19idXR0b24uc2V0X2RpcnR5X2ZsYWcoKQ0KICAgICAgICAgICAgc2VsZi5fYWRkX2NvbXBvbmVudChuZXdfYnV0dG9uKQ0KDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgY3JlYXRlX2VycjoNCiAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRVSUVycm9yKCdDYW4gbm90IGNyZWF0ZSBidXR0b24gJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wge30nLmZvcm1hdChjcmVhdGVfZXJyKSkNCg0KICAgIGRlZiBhZGRfc2VwYXJhdG9yKHNlbGYpOg0KICAgICAgICBpZiBub3Qgc2VsZi5pdGVtZGF0YV9tb2RlOg0KICAgICAgICAgICAgc2VsZi5nZXRfcnZ0YXBpX29iamVjdCgpLkFkZFNlcGFyYXRvcigpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBzZXBfY21wID0gX1B5UmV2aXRTZXBhcmF0b3IoKQ0KICAgICAgICAgICAgc2VsZi5fYWRkX2NvbXBvbmVudChzZXBfY21wKQ0KICAgICAgICBzZWxmLl9kaXJ0eSA9IFRydWUNCg0KDQpjbGFzcyBfUHlSZXZpdFJpYmJvblBhbmVsKEdlbmVyaWNQeVJldml0VUlDb250YWluZXIpOg0KDQogICAgYnV0dG9uID0gR2VuZXJpY1B5UmV2aXRVSUNvbnRhaW5lci5fZ2V0X2NvbXBvbmVudA0KICAgIHJpYmJvbl9pdGVtID0gR2VuZXJpY1B5UmV2aXRVSUNvbnRhaW5lci5fZ2V0X2NvbXBvbmVudA0KDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIHJ2dF9yaWJib25fcGFuZWwsIHBhcmVudF90YWIpOg0KICAgICAgICBHZW5lcmljUHlSZXZpdFVJQ29udGFpbmVyLl9faW5pdF9fKHNlbGYpDQoNCiAgICAgICAgc2VsZi5uYW1lID0gcnZ0X3JpYmJvbl9wYW5lbC5OYW1lDQogICAgICAgIHNlbGYuX3J2dGFwaV9vYmplY3QgPSBydnRfcmliYm9uX3BhbmVsDQoNCiAgICAgICAgc2VsZi5wYXJlbnRfdGFiID0gcGFyZW50X3RhYg0KDQogICAgICAgICMgd2hlbiBjb250YWluZXIgaXMgaW4gaXRlbWRhdGFfbW9kZSwgb25seSB0aGUgbmVjZXNzYXJ5DQogICAgICAgICMgUmliYm9uSXRlbURhdGEgb2JqZWN0cyB3aWxsIGJlIGNyZWF0ZWQgZm9yIGNoaWxkcmVuIGEgc3Vuc2VxdWVudA0KICAgICAgICAjIGNhbGwgdG8gY3JlYXRlX2RhdGFfaXRlbXMgd2lsbCBjcmVhdGUgdWkgZm9yIFJpYmJvbkl0ZW1EYXRhIG9iamVjdHMNCiAgICAgICAgIyBUaGlzIGlzIHNwZWNpZmljYWxseSBoZWxwZnVsIHdoZW4gY3JlYXRpbmcgc3RhY2tzIGluIHBhbmVscy4NCiAgICAgICAgIyBvcGVuX3N0YWNrIGFuZCBjbG9zZV9zdGFjayBjb250cm9sIHRoaXMgcGFyYW1ldGVyDQogICAgICAgIHNlbGYuaXRlbWRhdGFfbW9kZSA9IEZhbHNlDQoNCiAgICAgICAgIyBnZXR0aW5nIGEgbGlzdCBvZiBleGlzdGluZyBwYW5lbHMgdW5kZXIgdGhpcyB0YWINCiAgICAgICAgZm9yIHJldml0X3JpYmJvbl9pdGVtIGluIHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKS5HZXRJdGVtcygpOg0KICAgICAgICAgICAgIyBmZWVkaW5nIF9zdWJfbmF0aXZlX3JpYmJvbl9pdGVtcyB3aXRoIGFuIGluc3RhbmNlIG9mDQogICAgICAgICAgICAjIF9QeVJldml0UmliYm9uR3JvdXBJdGVtIGZvciBleGlzdGluZyBncm91cCBpdGVtcw0KICAgICAgICAgICAgIyBfUHlSZXZpdFJpYmJvblBhbmVsIHdpbGwgZmluZCBpdHMgZXhpc3RpbmcgcmliYm9uIGl0ZW1zIGludGVybmFsbHkNCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV2aXRfcmliYm9uX2l0ZW0sIFVJLlB1bGxkb3duQnV0dG9uKToNCiAgICAgICAgICAgICAgICBzZWxmLl9hZGRfY29tcG9uZW50KA0KICAgICAgICAgICAgICAgICAgICBfUHlSZXZpdFJpYmJvbkdyb3VwSXRlbShyZXZpdF9yaWJib25faXRlbSkpDQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocmV2aXRfcmliYm9uX2l0ZW0sIFVJLlB1c2hCdXR0b24pOg0KICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9jb21wb25lbnQoX1B5UmV2aXRSaWJib25CdXR0b24ocmV2aXRfcmliYm9uX2l0ZW0pKQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignQ2FuIG5vdCBkZXRlcm1pbiByaWJib24gaXRlbSB0eXBlOiB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KHJldml0X3JpYmJvbl9pdGVtKSkNCg0KICAgIGRlZiBnZXRfYWR3aW5kb3dzX29iamVjdChzZWxmKToNCiAgICAgICAgZm9yIHBhbmVsIGluIHNlbGYucGFyZW50X3RhYi5QYW5lbHM6DQogICAgICAgICAgICBpZiBwYW5lbC5Tb3VyY2UgYW5kIHBhbmVsLlNvdXJjZS5UaXRsZSA9PSBzZWxmLm5hbWU6DQogICAgICAgICAgICAgICAgcmV0dXJuIHBhbmVsDQoNCiAgICBkZWYgc2V0X2JhY2tncm91bmQoc2VsZiwgYXJnYl9jb2xvcik6DQogICAgICAgIHBhbmVsX2Fkd25kX29iaiA9IHNlbGYuZ2V0X2Fkd2luZG93c19vYmplY3QoKQ0KICAgICAgICBjb2xvciA9IGFyZ2JfdG9fYnJ1c2goYXJnYl9jb2xvcikNCiAgICAgICAgcGFuZWxfYWR3bmRfb2JqLkN1c3RvbVBhbmVsQmFja2dyb3VuZCA9IGNvbG9yDQogICAgICAgIHBhbmVsX2Fkd25kX29iai5DdXN0b21QYW5lbFRpdGxlQmFyQmFja2dyb3VuZCA9IGNvbG9yDQogICAgICAgIHBhbmVsX2Fkd25kX29iai5DdXN0b21TbGlkZU91dFBhbmVsQmFja2dyb3VuZCA9IGNvbG9yDQoNCiAgICBkZWYgcmVzZXRfYmFja2dyb3VuZHMoc2VsZik6DQogICAgICAgIHBhbmVsX2Fkd25kX29iaiA9IHNlbGYuZ2V0X2Fkd2luZG93c19vYmplY3QoKQ0KICAgICAgICBwYW5lbF9hZHduZF9vYmouQ3VzdG9tUGFuZWxCYWNrZ3JvdW5kID0gTm9uZQ0KICAgICAgICBwYW5lbF9hZHduZF9vYmouQ3VzdG9tUGFuZWxUaXRsZUJhckJhY2tncm91bmQgPSBOb25lDQogICAgICAgIHBhbmVsX2Fkd25kX29iai5DdXN0b21TbGlkZU91dFBhbmVsQmFja2dyb3VuZCA9IE5vbmUNCg0KICAgIGRlZiBzZXRfcGFuZWxfYmFja2dyb3VuZChzZWxmLCBhcmdiX2NvbG9yKToNCiAgICAgICAgcGFuZWxfYWR3bmRfb2JqID0gc2VsZi5nZXRfYWR3aW5kb3dzX29iamVjdCgpDQogICAgICAgIHBhbmVsX2Fkd25kX29iai5DdXN0b21QYW5lbEJhY2tncm91bmQgPSBcDQogICAgICAgICAgICBhcmdiX3RvX2JydXNoKGFyZ2JfY29sb3IpDQoNCiAgICBkZWYgc2V0X3RpdGxlX2JhY2tncm91bmQoc2VsZiwgYXJnYl9jb2xvcik6DQogICAgICAgIHBhbmVsX2Fkd25kX29iaiA9IHNlbGYuZ2V0X2Fkd2luZG93c19vYmplY3QoKQ0KICAgICAgICBwYW5lbF9hZHduZF9vYmouQ3VzdG9tUGFuZWxUaXRsZUJhckJhY2tncm91bmQgPSBcDQogICAgICAgICAgICBhcmdiX3RvX2JydXNoKGFyZ2JfY29sb3IpDQoNCiAgICBkZWYgc2V0X3NsaWRlb3V0X2JhY2tncm91bmQoc2VsZiwgYXJnYl9jb2xvcik6DQogICAgICAgIHBhbmVsX2Fkd25kX29iaiA9IHNlbGYuZ2V0X2Fkd2luZG93c19vYmplY3QoKQ0KICAgICAgICBwYW5lbF9hZHduZF9vYmouQ3VzdG9tU2xpZGVPdXRQYW5lbEJhY2tncm91bmQgPSBcDQogICAgICAgICAgICBhcmdiX3RvX2JydXNoKGFyZ2JfY29sb3IpDQoNCiAgICBkZWYgcmVzZXRfaGlnaGxpZ2h0cyhzZWxmKToNCiAgICAgICAgIyBubyBoaWdobGlnaHRpbmcgb3B0aW9ucyBmb3IgcGFuZWxzDQogICAgICAgIHBhc3MNCg0KICAgIGRlZiBoaWdobGlnaHRfYXNfbmV3KHNlbGYpOg0KICAgICAgICAjIG5vIGhpZ2hsaWdodGluZyBvcHRpb25zIGZvciBwYW5lbHMNCiAgICAgICAgcGFzcw0KDQogICAgZGVmIGhpZ2hsaWdodF9hc191cGRhdGVkKHNlbGYpOg0KICAgICAgICAjIG5vIGhpZ2hsaWdodGluZyBvcHRpb25zIGZvciBwYW5lbHMNCiAgICAgICAgcGFzcw0KDQogICAgZGVmIGdldF9jb2xsYXBzZShzZWxmKToNCiAgICAgICAgcGFuZWxfYWR3bmRfb2JqID0gc2VsZi5nZXRfYWR3aW5kb3dzX29iamVjdCgpDQogICAgICAgIHJldHVybiBwYW5lbF9hZHduZF9vYmouSXNDb2xsYXBzZWQNCg0KICAgIGRlZiBzZXRfY29sbGFwc2Uoc2VsZiwgc3RhdGUpOg0KICAgICAgICBwYW5lbF9hZHduZF9vYmogPSBzZWxmLmdldF9hZHdpbmRvd3Nfb2JqZWN0KCkNCiAgICAgICAgcGFuZWxfYWR3bmRfb2JqLklzQ29sbGFwc2VkID0gc3RhdGUNCg0KICAgIGRlZiBvcGVuX3N0YWNrKHNlbGYpOg0KICAgICAgICBzZWxmLml0ZW1kYXRhX21vZGUgPSBUcnVlDQoNCiAgICBkZWYgY2xvc2Vfc3RhY2soc2VsZik6DQogICAgICAgIHNlbGYuX2NyZWF0ZV9kYXRhX2l0ZW1zKCkNCg0KICAgIGRlZiBhZGRfc2VwYXJhdG9yKHNlbGYpOg0KICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuQWRkU2VwYXJhdG9yKCkNCiAgICAgICAgc2VsZi5fZGlydHkgPSBUcnVlDQoNCiAgICBkZWYgYWRkX3NsaWRlb3V0KHNlbGYpOg0KICAgICAgICB0cnk6DQogICAgICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuQWRkU2xpZGVPdXQoKQ0KICAgICAgICAgICAgc2VsZi5fZGlydHkgPSBUcnVlDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgc2xpZGVvdXRfZXJyOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0Vycm9yIGFkZGluZyBzbGlkZSBvdXQ6IHt9Jw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChzbGlkZW91dF9lcnIpKQ0KDQogICAgZGVmIF9jcmVhdGVfZGF0YV9pdGVtcyhzZWxmKToNCiAgICAgICAgIyBGSVhNRTogaWYgb25lIGl0ZW0gY2hhbmdlcyBpbiBzdGFjayBhbmQgb3RoZXJzIGRvbnQgY2hhbmdlLA0KICAgICAgICAjIGJ1dHRvbiB3aWxsIGJlIGNyZWF0ZWQgYXMgcHVzaGJ1dHRvbiBvdXQgb2Ygc3RhY2sNCiAgICAgICAgc2VsZi5pdGVtZGF0YV9tb2RlID0gRmFsc2UNCg0KICAgICAgICAjIGdldCBhIGxpc3Qgb2YgZGF0YSBpdGVtIG5hbWVzIGFuZCB0aGUNCiAgICAgICAgIyBhc3NvY2lhdGVkIHJldml0IGFwaSBkYXRhIG9iamVjdHMNCiAgICAgICAgcHlydnRfZGF0YV9pdGVtX25hbWVzID0gW3gubmFtZSBmb3IgeCBpbiBzZWxmIGlmIHguaXRlbWRhdGFfbW9kZV0NCiAgICAgICAgcnZ0YXBpX2RhdGFfb2JqcyA9IFt4LmdldF9ydnRhcGlfb2JqZWN0KCkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgeCBpbiBzZWxmIGlmIHguaXRlbWRhdGFfbW9kZV0NCg0KICAgICAgICAjIGxpc3Qgb2YgbmV3bHkgY3JlYXRlZCByZXZpdF9hcGkgcmliYm9uIGl0ZW1zDQogICAgICAgIGNyZWF0ZWRfcnZ0YXBpX3JpYmJvbl9pdGVtcyA9IFtdDQoNCiAgICAgICAgIyBjcmVhdGUgc3RhY2sgaXRlbXMgaW4gdWkgYW5kIGdldCBjb3JyZXNwb2RpbmcgcmV2aXQgdWkgb2JqZWN0cw0KICAgICAgICBkYXRhX29ial9jb3VudCA9IGxlbihydnRhcGlfZGF0YV9vYmpzKQ0KDQogICAgICAgICMgaWYgdGhlcmUgYXJlIHR3byBvciAzIGl0ZW1zLCBjcmVhdGUgYSBwcm9wZXIgc3RhY2sNCiAgICAgICAgaWYgZGF0YV9vYmpfY291bnQgPT0gMiBvciBkYXRhX29ial9jb3VudCA9PSAzOg0KICAgICAgICAgICAgY3JlYXRlZF9ydnRhcGlfcmliYm9uX2l0ZW1zID0gXA0KICAgICAgICAgICAgICAgIHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKS5BZGRTdGFja2VkSXRlbXMoKnJ2dGFwaV9kYXRhX29ianMpDQogICAgICAgICMgaWYgdGhlcmUgaXMgb25seSBvbmUgaXRlbSBhZGRlZCwNCiAgICAgICAgIyBhZGQgdGhhdCB0byBwYW5lbCBhbmQgZm9yZ2V0IGFib3V0IHN0YWNraW5nDQogICAgICAgIGVsaWYgZGF0YV9vYmpfY291bnQgPT0gMToNCiAgICAgICAgICAgIHJ2dGFwaV9wdXNoYnV0dG9uID0gXA0KICAgICAgICAgICAgICAgIHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKS5BZGRJdGVtKCpydnRhcGlfZGF0YV9vYmpzKQ0KICAgICAgICAgICAgY3JlYXRlZF9ydnRhcGlfcmliYm9uX2l0ZW1zLmFwcGVuZChydnRhcGlfcHVzaGJ1dHRvbikNCiAgICAgICAgIyBpZiBubyBpdGVtcyBoYXZlIGJlZW4gYWRkZWQsIGxvZyB0aGUgZW1wdHkgc3RhY2sgYW5kIHJldHVybg0KICAgICAgICBlbGlmIGRhdGFfb2JqX2NvdW50ID09IDA6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdObyBuZXcgaXRlbXMgaGFzIGJlZW4gYWRkZWQgdG8gc3RhY2suICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ1NraXBwaW5nIHN0YWNrIGNyZWF0aW9uLicpDQogICAgICAgICMgaWYgbm9uZSBvZiB0aGUgYWJvdmUsIG1vcmUgdGhhbiAzIGl0ZW1zIGhhdmUgYmVlbiBhZGRlZC4NCiAgICAgICAgIyBDbGVhbnVwIGRhdGEgaXRlbSBjYWNoZSBhbmQgcmFpc2UgYW4gZXJyb3IuDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBmb3IgcHlydnRfZGF0YV9pdGVtX25hbWUgaW4gcHlydnRfZGF0YV9pdGVtX25hbWVzOg0KICAgICAgICAgICAgICAgIHNlbGYuX3JlbW92ZV9jb21wb25lbnQocHlydnRfZGF0YV9pdGVtX25hbWUpDQogICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignQ2FuIG5vdCBjcmVhdGUgc3RhY2sgb2Yge30uICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTdGFjayBjYW4gb25seSBoYXZlIDIgb3IgMyBpdGVtcy4nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KGRhdGFfb2JqX2NvdW50KSkNCg0KICAgICAgICAjIG5vdyB0aGF0IGl0ZW1zIGFyZSBjcmVhdGVkIGFuZCByZXZpdCBhcGkgb2JqZWN0cyBhcmUgcmVhZHkNCiAgICAgICAgIyBpdGVyYXRlIG92ZXIgdGhlIHJpYmJvbiBpdGVtcyBhbmQgaW5qZWN0IHJldml0IGFwaSBvYmplY3RzDQogICAgICAgICMgaW50byB0aGUgY2hpbGQgcHlyZXZpdCBpdGVtcw0KICAgICAgICBmb3IgcnZ0YXBpX3JpYmJvbl9pdGVtLCBweXJ2dF9kYXRhX2l0ZW1fbmFtZSBcDQogICAgICAgICAgICAgICAgaW4gemlwKGNyZWF0ZWRfcnZ0YXBpX3JpYmJvbl9pdGVtcywgcHlydnRfZGF0YV9pdGVtX25hbWVzKToNCiAgICAgICAgICAgIHB5cnZ0X3VpX2l0ZW0gPSBzZWxmLl9nZXRfY29tcG9uZW50KHB5cnZ0X2RhdGFfaXRlbV9uYW1lKQ0KICAgICAgICAgICAgIyBweXJ2dF91aV9pdGVtIG9ubHkgaGFkIGJ1dHRvbiBkYXRhIGluZm8uDQogICAgICAgICAgICAjIE5vdyB0aGF0IHVpIHJpYmJvbiBpdGVtIGhhcyBjcmVhdGVkLCB1cGRhdGUgcHlydnRfdWlfaXRlbQ0KICAgICAgICAgICAgIyB3aXRoIGNvcnJlc3BvbmRpbmcgcmV2aXQgYXBpIG9iamVjdC4NCiAgICAgICAgICAgICMgLnNldF9ydnRhcGlfb2JqZWN0KCkgZGlzYWJsZXMgLml0ZW1kYXRhX21vZGUgc2luY2UNCiAgICAgICAgICAgICMgdGhleSdyZSBubyBsb25nZXIgZGF0YSBvYmplY3RzDQogICAgICAgICAgICBweXJ2dF91aV9pdGVtLnNldF9ydnRhcGlfb2JqZWN0KHJ2dGFwaV9yaWJib25faXRlbSkNCg0KICAgICAgICAgICAgIyBleHRlbmRlZCB0b29sdGlwcyAoaW1hZ2VzIGFuZCB2aWRlb3MpIGNhbiBvbmx5IGJlIGFwcGxpZWQgd2hlbg0KICAgICAgICAgICAgIyB0aGUgdWkgZWxlbWVudCBpcyBjcmVhdGVkDQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHB5cnZ0X3VpX2l0ZW0sIF9QeVJldml0UmliYm9uQnV0dG9uKToNCiAgICAgICAgICAgICAgICBweXJ2dF91aV9pdGVtLnByb2Nlc3NfZGVmZXJyZWQoKQ0KDQogICAgICAgICAgICAjIGlmIHB5cnZ0X3VpX2l0ZW0gaXMgYSBncm91cCwNCiAgICAgICAgICAgICMgY3JlYXRlIGNoaWxkcmVuIGFuZCB1cGRhdGUgZ3JvdXAgaXRlbSBkYXRhDQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHB5cnZ0X3VpX2l0ZW0sIF9QeVJldml0UmliYm9uR3JvdXBJdGVtKToNCiAgICAgICAgICAgICAgICBweXJ2dF91aV9pdGVtLmNyZWF0ZV9kYXRhX2l0ZW1zKCkNCg0KICAgIGRlZiBzZXRfZGxnbGF1bmNoZXIoc2VsZiwgZGxnX2J1dHRvbik6DQogICAgICAgIHBhbmVsX2Fkd25kX29iaiA9IHNlbGYuZ2V0X2Fkd2luZG93c19vYmplY3QoKQ0KICAgICAgICBidXR0b25fYWR3bmRfb2JqID0gZGxnX2J1dHRvbi5nZXRfYWR3aW5kb3dzX29iamVjdCgpDQogICAgICAgIHBhbmVsX2Fkd25kX29iai5Tb3VyY2UuSXRlbXMuUmVtb3ZlKGJ1dHRvbl9hZHduZF9vYmopDQogICAgICAgIHBhbmVsX2Fkd25kX29iai5Tb3VyY2UuRGlhbG9nTGF1bmNoZXIgPSBidXR0b25fYWR3bmRfb2JqDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0FkZGVkIHBhbmVsIGRpYWxvZyBidXR0b24gJXMnLCBkbGdfYnV0dG9uLm5hbWUpDQoNCiAgICBkZWYgY3JlYXRlX3B1c2hfYnV0dG9uKHNlbGYsIGJ1dHRvbl9uYW1lLCBhc21fbG9jYXRpb24sIGNsYXNzX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uX3BhdGg9JycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICB0b29sdGlwPScnLCB0b29sdGlwX2V4dD0nJywgdG9vbHRpcF9tZWRpYT0nJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eGhlbHB1cmw9Tm9uZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2YWlsX2NsYXNzX25hbWU9Tm9uZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9pZl9leGlzdHM9RmFsc2UsIHVpX3RpdGxlPU5vbmUpOg0KICAgICAgICBpZiBzZWxmLmNvbnRhaW5zKGJ1dHRvbl9uYW1lKToNCiAgICAgICAgICAgIGlmIHVwZGF0ZV9pZl9leGlzdHM6DQogICAgICAgICAgICAgICAgZXhpc3RpbmdfaXRlbSA9IHNlbGYuX2dldF9jb21wb25lbnQoYnV0dG9uX25hbWUpDQogICAgICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgICAgICAjIEFzc2VtYmx5IGFuZCBDbGFzcyBpbmZvIG9mIGN1cnJlbnQgYWN0aXZlDQogICAgICAgICAgICAgICAgICAgICMgc2NyaXB0IGJ1dHRvbiBjYW4gbm90IGJlIHVwZGF0ZWQuDQogICAgICAgICAgICAgICAgICAgIGlmIGJ1dHRvbl9uYW1lICE9IEVYRUNfUEFSQU1TLmNvbW1hbmRfbmFtZToNCiAgICAgICAgICAgICAgICAgICAgICAgIHJ2dGFwaV9vYmogPSBleGlzdGluZ19pdGVtLmdldF9ydnRhcGlfb2JqZWN0KCkNCiAgICAgICAgICAgICAgICAgICAgICAgIHJ2dGFwaV9vYmouQXNzZW1ibHlOYW1lID0gYXNtX2xvY2F0aW9uDQogICAgICAgICAgICAgICAgICAgICAgICBydnRhcGlfb2JqLkNsYXNzTmFtZSA9IGNsYXNzX25hbWUNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGF2YWlsX2NsYXNzX25hbWU6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcnZ0YXBpX29iai5BdmFpbGFiaWxpdHlDbGFzc05hbWUgPSBhdmFpbF9jbGFzc19uYW1lDQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBhc21fdXBkYXRlX2VycjoNCiAgICAgICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRXJyb3IgdXBkYXRpbmcgYnV0dG9uIGFzbSBpbmZvOiAlcyAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wgJXMnLCBidXR0b25fbmFtZSwgYXNtX3VwZGF0ZV9lcnIpDQoNCiAgICAgICAgICAgICAgICBleGlzdGluZ19pdGVtLnNldF90b29sdGlwKHRvb2x0aXApDQogICAgICAgICAgICAgICAgZXhpc3RpbmdfaXRlbS5zZXRfdG9vbHRpcF9leHQodG9vbHRpcF9leHQpDQogICAgICAgICAgICAgICAgaWYgdG9vbHRpcF9tZWRpYToNCiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdfaXRlbS5zZXRfdG9vbHRpcF9tZWRpYSh0b29sdGlwX21lZGlhKQ0KDQogICAgICAgICAgICAgICAgZXhpc3RpbmdfaXRlbS5zZXRfY29udGV4dGhlbHAoY3R4aGVscHVybCkNCg0KICAgICAgICAgICAgICAgIGlmIHVpX3RpdGxlOg0KICAgICAgICAgICAgICAgICAgICBleGlzdGluZ19pdGVtLnNldF90aXRsZSh1aV90aXRsZSkNCg0KICAgICAgICAgICAgICAgIGlmIG5vdCBpY29uX3BhdGg6DQogICAgICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0ljb24gbm90IHNldCBmb3IgJXMnLCBidXR0b25fbmFtZSkNCiAgICAgICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ19pdGVtLnNldF9pY29uKGljb25fcGF0aCwgaWNvbl9zaXplPUlDT05fTEFSR0UpDQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBQeVJldml0VUlFcnJvciBhcyBpY29uZXJyOg0KICAgICAgICAgICAgICAgICAgICAgICAgbWxvZ2dlci5lcnJvcignRXJyb3IgYWRkaW5nIGljb24gZm9yICVzICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wgJXMnLCBidXR0b25fbmFtZSwgaWNvbmVycikNCiAgICAgICAgICAgICAgICBleGlzdGluZ19pdGVtLmFjdGl2YXRlKCkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ1B1c2ggYnV0dG9uIGFscmVhZHkgZXhpdHMgYW5kIHVwZGF0ZSAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2lzIG5vdCBhbGxvd2VkOiB7fScuZm9ybWF0KGJ1dHRvbl9uYW1lKSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ1BhcmVudCBkb2VzIG5vdCBpbmNsdWRlIHRoaXMgYnV0dG9uLiBDcmVhdGluZzogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fbmFtZSkNCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICBidXR0b25fZGF0YSA9IFwNCiAgICAgICAgICAgICAgICAgICAgVUkuUHVzaEJ1dHRvbkRhdGEoYnV0dG9uX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl9uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc21fbG9jYXRpb24sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzX25hbWUpDQogICAgICAgICAgICAgICAgaWYgYXZhaWxfY2xhc3NfbmFtZToNCiAgICAgICAgICAgICAgICAgICAgYnV0dG9uX2RhdGEuQXZhaWxhYmlsaXR5Q2xhc3NOYW1lID0gYXZhaWxfY2xhc3NfbmFtZQ0KICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLml0ZW1kYXRhX21vZGU6DQogICAgICAgICAgICAgICAgICAgIHJpYmJvbl9idXR0b24gPSBcDQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuQWRkSXRlbShidXR0b25fZGF0YSkNCiAgICAgICAgICAgICAgICAgICAgbmV3X2J1dHRvbiA9IF9QeVJldml0UmliYm9uQnV0dG9uKHJpYmJvbl9idXR0b24pDQogICAgICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAgICAgbmV3X2J1dHRvbiA9IF9QeVJldml0UmliYm9uQnV0dG9uKGJ1dHRvbl9kYXRhKQ0KDQogICAgICAgICAgICAgICAgaWYgdWlfdGl0bGU6DQogICAgICAgICAgICAgICAgICAgIG5ld19idXR0b24uc2V0X3RpdGxlKHVpX3RpdGxlKQ0KDQogICAgICAgICAgICAgICAgaWYgbm90IGljb25fcGF0aDoNCiAgICAgICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnUGFyZW50IHVpIGl0ZW0gaXMgYSBwYW5lbCBhbmQgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYW5lbHMgZG9uXCd0IGhhdmUgaWNvbnMuJykNCiAgICAgICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDcmVhdGluZyBpY29uIGZvciBwdXNoIGJ1dHRvbiAlcyAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Zyb20gZmlsZTogJXMnLCBidXR0b25fbmFtZSwgaWNvbl9wYXRoKQ0KICAgICAgICAgICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgICAgICAgICBuZXdfYnV0dG9uLnNldF9pY29uKGljb25fcGF0aCwgaWNvbl9zaXplPUlDT05fTEFSR0UpDQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBQeVJldml0VUlFcnJvciBhcyBpY29uZXJyOg0KICAgICAgICAgICAgICAgICAgICAgICAgbWxvZ2dlci5lcnJvcignRXJyb3IgYWRkaW5nIGljb24gZm9yICVzIGZyb20gJXMgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnfCAlcycsIGJ1dHRvbl9uYW1lLCBpY29uX3BhdGgsIGljb25lcnIpDQoNCiAgICAgICAgICAgICAgICBuZXdfYnV0dG9uLnNldF90b29sdGlwKHRvb2x0aXApDQogICAgICAgICAgICAgICAgbmV3X2J1dHRvbi5zZXRfdG9vbHRpcF9leHQodG9vbHRpcF9leHQpDQogICAgICAgICAgICAgICAgaWYgdG9vbHRpcF9tZWRpYToNCiAgICAgICAgICAgICAgICAgICAgbmV3X2J1dHRvbi5zZXRfdG9vbHRpcF9tZWRpYSh0b29sdGlwX21lZGlhKQ0KDQogICAgICAgICAgICAgICAgbmV3X2J1dHRvbi5zZXRfY29udGV4dGhlbHAoY3R4aGVscHVybCkNCg0KICAgICAgICAgICAgICAgIG5ld19idXR0b24uc2V0X2RpcnR5X2ZsYWcoKQ0KICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9jb21wb25lbnQobmV3X2J1dHRvbikNCg0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBjcmVhdGVfZXJyOg0KICAgICAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRVSUVycm9yKCdDYW4gbm90IGNyZWF0ZSBidXR0b24gfCB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KGNyZWF0ZV9lcnIpKQ0KDQogICAgZGVmIF9jcmVhdGVfYnV0dG9uX2dyb3VwKHNlbGYsIHB1bGxkb3duZGF0YV90eXBlLCBpdGVtX25hbWUsIGljb25fcGF0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2lmX2V4aXN0cz1GYWxzZSk6DQogICAgICAgIGlmIHNlbGYuY29udGFpbnMoaXRlbV9uYW1lKToNCiAgICAgICAgICAgIGlmIHVwZGF0ZV9pZl9leGlzdHM6DQogICAgICAgICAgICAgICAgZXhpdGluZ19pdGVtID0gc2VsZi5fZ2V0X2NvbXBvbmVudChpdGVtX25hbWUpDQogICAgICAgICAgICAgICAgZXhpdGluZ19pdGVtLmFjdGl2YXRlKCkNCiAgICAgICAgICAgICAgICBpZiBpY29uX3BhdGg6DQogICAgICAgICAgICAgICAgICAgIGV4aXRpbmdfaXRlbS5zZXRfaWNvbihpY29uX3BhdGgpDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRVSUVycm9yKCdQdWxsIGRvd24gYnV0dG9uIGFscmVhZHkgZXhpdHMgYW5kICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndXBkYXRlIGlzIG5vdCBhbGxvd2VkOiB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KGl0ZW1fbmFtZSkpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdQYW5lbCBkb2VzIG5vdCBpbmNsdWRlIHRoaXMgcHVsbCBkb3duIGJ1dHRvbi4gJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAnQ3JlYXRpbmc6ICVzJywgaXRlbV9uYW1lKQ0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgICMgY3JlYXRpbmcgcHVsbCBkb3duIGJ1dHRvbiBkYXRhIGFuZCBhZGQgdG8gY2hpbGQgbGlzdA0KICAgICAgICAgICAgICAgIHBkYnV0dG9uX2RhdGEgPSBwdWxsZG93bmRhdGFfdHlwZShpdGVtX25hbWUsIGl0ZW1fbmFtZSkNCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5pdGVtZGF0YV9tb2RlOg0KICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDcmVhdGluZyBwdWxsIGRvd24gYnV0dG9uOiAlcyBpbiAlcycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbV9uYW1lLCBzZWxmKQ0KICAgICAgICAgICAgICAgICAgICBuZXdfcHVzaF9idXR0b24gPSBcDQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuQWRkSXRlbShwZGJ1dHRvbl9kYXRhKQ0KICAgICAgICAgICAgICAgICAgICBweXJ2dF9wZGJ1dHRvbiA9IF9QeVJldml0UmliYm9uR3JvdXBJdGVtKG5ld19wdXNoX2J1dHRvbikNCiAgICAgICAgICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgICAgICAgICAgcHlydnRfcGRidXR0b24uc2V0X2ljb24oaWNvbl9wYXRoKQ0KICAgICAgICAgICAgICAgICAgICBleGNlcHQgUHlSZXZpdFVJRXJyb3IgYXMgaWNvbmVycjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0Vycm9yIGFkZGluZyBpY29uIGZvciAlcyBmcm9tICVzICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wgJXMnLCBpdGVtX25hbWUsIGljb25fcGF0aCwgaWNvbmVycikNCiAgICAgICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDcmVhdGluZyBwdWxsIGRvd24gYnV0dG9uIHVuZGVyIHN0YWNrOiAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyVzIGluICVzJywgaXRlbV9uYW1lLCBzZWxmKQ0KICAgICAgICAgICAgICAgICAgICBweXJ2dF9wZGJ1dHRvbiA9IF9QeVJldml0UmliYm9uR3JvdXBJdGVtKHBkYnV0dG9uX2RhdGEpDQogICAgICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgICAgIHB5cnZ0X3BkYnV0dG9uLnNldF9pY29uKGljb25fcGF0aCkNCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFB5UmV2aXRVSUVycm9yIGFzIGljb25lcnI6DQogICAgICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdFcnJvciBhZGRpbmcgaWNvbiBmb3IgJXMgZnJvbSAlcyAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd8ICVzJywgaXRlbV9uYW1lLCBpY29uX3BhdGgsIGljb25lcnIpDQoNCiAgICAgICAgICAgICAgICBweXJ2dF9wZGJ1dHRvbi5zZXRfZGlydHlfZmxhZygpDQogICAgICAgICAgICAgICAgc2VsZi5fYWRkX2NvbXBvbmVudChweXJ2dF9wZGJ1dHRvbikNCg0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBidXR0b25fZXJyOg0KICAgICAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRVSUVycm9yKCdDYW4gbm90IGNyZWF0ZSBwdWxsIGRvd24gYnV0dG9uOiB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KGJ1dHRvbl9lcnIpKQ0KDQogICAgZGVmIGNyZWF0ZV9wdWxsZG93bl9idXR0b24oc2VsZiwgaXRlbV9uYW1lLCBpY29uX3BhdGgsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2lmX2V4aXN0cz1GYWxzZSk6DQogICAgICAgIHNlbGYuX2NyZWF0ZV9idXR0b25fZ3JvdXAoVUkuUHVsbGRvd25CdXR0b25EYXRhLCBpdGVtX25hbWUsIGljb25fcGF0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfaWZfZXhpc3RzKQ0KDQogICAgZGVmIGNyZWF0ZV9zcGxpdF9idXR0b24oc2VsZiwgaXRlbV9uYW1lLCBpY29uX3BhdGgsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2lmX2V4aXN0cz1GYWxzZSk6DQogICAgICAgIGlmIHNlbGYuaXRlbWRhdGFfbW9kZSBhbmQgSE9TVF9BUFAuaXNfb2xkZXJfdGhhbignMjAxNycpOg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ1Jldml0cyBlYXJsaWVyIHRoYW4gMjAxNyBkbyBub3Qgc3VwcG9ydCAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3BsaXQgYnV0dG9ucyBpbiBhIHN0YWNrLicpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBzZWxmLl9jcmVhdGVfYnV0dG9uX2dyb3VwKFVJLlNwbGl0QnV0dG9uRGF0YSwgaXRlbV9uYW1lLCBpY29uX3BhdGgsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9pZl9leGlzdHMpDQogICAgICAgICAgICBzZWxmLnJpYmJvbl9pdGVtKGl0ZW1fbmFtZSkuc3luY193aXRoX2N1cnJlbnRfaXRlbShUcnVlKQ0KDQogICAgZGVmIGNyZWF0ZV9zcGxpdHB1c2hfYnV0dG9uKHNlbGYsIGl0ZW1fbmFtZSwgaWNvbl9wYXRoLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfaWZfZXhpc3RzPUZhbHNlKToNCiAgICAgICAgaWYgc2VsZi5pdGVtZGF0YV9tb2RlIGFuZCBIT1NUX0FQUC5pc19vbGRlcl90aGFuKCcyMDE3Jyk6DQogICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignUmV2aXRzIGVhcmxpZXIgdGhhbiAyMDE3IGRvIG5vdCBzdXBwb3J0ICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzcGxpdCBidXR0b25zIGluIGEgc3RhY2suJykNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNlbGYuX2NyZWF0ZV9idXR0b25fZ3JvdXAoVUkuU3BsaXRCdXR0b25EYXRhLCBpdGVtX25hbWUsIGljb25fcGF0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2lmX2V4aXN0cykNCiAgICAgICAgICAgIHNlbGYucmliYm9uX2l0ZW0oaXRlbV9uYW1lKS5zeW5jX3dpdGhfY3VycmVudF9pdGVtKEZhbHNlKQ0KDQogICAgZGVmIGNyZWF0ZV9wYW5lbF9wdXNoX2J1dHRvbihzZWxmLCBidXR0b25fbmFtZSwgYXNtX2xvY2F0aW9uLCBjbGFzc19uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9vbHRpcD0nJywgdG9vbHRpcF9leHQ9JycsIHRvb2x0aXBfbWVkaWE9JycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHhoZWxwdXJsPU5vbmUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmFpbF9jbGFzc19uYW1lPU5vbmUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfaWZfZXhpc3RzPUZhbHNlKToNCiAgICAgICAgc2VsZi5jcmVhdGVfcHVzaF9idXR0b24oYnV0dG9uX25hbWU9YnV0dG9uX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzbV9sb2NhdGlvbj1hc21fbG9jYXRpb24sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9Y2xhc3NfbmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbl9wYXRoPU5vbmUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2x0aXA9dG9vbHRpcCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9vbHRpcF9leHQ9dG9vbHRpcF9leHQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2x0aXBfbWVkaWE9dG9vbHRpcF9tZWRpYSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4aGVscHVybD1jdHhoZWxwdXJsLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmFpbF9jbGFzc19uYW1lPWF2YWlsX2NsYXNzX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9pZl9leGlzdHM9dXBkYXRlX2lmX2V4aXN0cywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWlfdGl0bGU9Tm9uZSkNCiAgICAgICAgc2VsZi5zZXRfZGxnbGF1bmNoZXIoc2VsZi5idXR0b24oYnV0dG9uX25hbWUpKQ0KDQoNCmNsYXNzIF9QeVJldml0UmliYm9uVGFiKEdlbmVyaWNQeVJldml0VUlDb250YWluZXIpOg0KICAgIHJpYmJvbl9wYW5lbCA9IEdlbmVyaWNQeVJldml0VUlDb250YWluZXIuX2dldF9jb21wb25lbnQNCg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCByZXZpdF9yaWJib25fdGFiLCBpc19weXJ2dF90YWI9RmFsc2UpOg0KICAgICAgICBHZW5lcmljUHlSZXZpdFVJQ29udGFpbmVyLl9faW5pdF9fKHNlbGYpDQoNCiAgICAgICAgc2VsZi5uYW1lID0gcmV2aXRfcmliYm9uX3RhYi5UaXRsZQ0KICAgICAgICBzZWxmLl9ydnRhcGlfb2JqZWN0ID0gcmV2aXRfcmliYm9uX3RhYg0KDQogICAgICAgICMgaXMgdGhpcyB0YWIgY3JlYXRlZCBieSBweXJldml0LnJldml0dWk/DQogICAgICAgIGlmIGlzX3B5cnZ0X3RhYjoNCiAgICAgICAgICAgIHNlbGYuX3J2dGFwaV9vYmplY3QuVGFnID0gUFlSRVZJVF9UQUJfSURFTlRJRklFUg0KDQogICAgICAgICMgZ2V0dGluZyBhIGxpc3Qgb2YgZXhpc3RpbmcgcGFuZWxzIHVuZGVyIHRoaXMgdGFiDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGZvciByZXZpdF91aV9wYW5lbCBpbiBIT1NUX0FQUC51aWFwcC5HZXRSaWJib25QYW5lbHMoc2VsZi5uYW1lKToNCiAgICAgICAgICAgICAgICAjIGZlZWRpbmcgX3N1Yl9weXJ2dF9yaWJib25fcGFuZWxzIHdpdGggYW4gaW5zdGFuY2Ugb2YNCiAgICAgICAgICAgICAgICAjIF9QeVJldml0UmliYm9uUGFuZWwgZm9yIGV4aXN0aW5nIHBhbmVscyBfUHlSZXZpdFJpYmJvblBhbmVsDQogICAgICAgICAgICAgICAgIyB3aWxsIGZpbmQgaXRzIGV4aXN0aW5nIHJpYmJvbiBpdGVtcyBpbnRlcm5hbGx5DQogICAgICAgICAgICAgICAgbmV3X3B5cnZ0X3BhbmVsID0gX1B5UmV2aXRSaWJib25QYW5lbChyZXZpdF91aV9wYW5lbCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3J2dGFwaV9vYmplY3QpDQogICAgICAgICAgICAgICAgc2VsZi5fYWRkX2NvbXBvbmVudChuZXdfcHlydnRfcGFuZWwpDQogICAgICAgIGV4Y2VwdDoNCiAgICAgICAgICAgICMgaWYgLkdldFJpYmJvblBhbmVscyBmYWlscywgdGhpcyB0YWIgaXMgYW4gZXhpc3RpbmcgbmF0aXZlIHRhYg0KICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ0NhbiBub3QgZ2V0IHBhbmVscyBmb3IgdGhpcyB0YWI6IHt9Jw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChzZWxmLl9ydnRhcGlfb2JqZWN0KSkNCg0KICAgIGRlZiBnZXRfYWR3aW5kb3dzX29iamVjdChzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X3J2dGFwaV9vYmplY3QoKQ0KDQogICAgZGVmIHJlc2V0X2hpZ2hsaWdodHMoc2VsZik6DQogICAgICAgICMgbm8gaGlnaGxpZ2h0aW5nIG9wdGlvbnMgZm9yIHRhYnMNCiAgICAgICAgcGFzcw0KDQogICAgZGVmIGhpZ2hsaWdodF9hc19uZXcoc2VsZik6DQogICAgICAgICMgbm8gaGlnaGxpZ2h0aW5nIG9wdGlvbnMgZm9yIHRhYnMNCiAgICAgICAgcGFzcw0KDQogICAgZGVmIGhpZ2hsaWdodF9hc191cGRhdGVkKHNlbGYpOg0KICAgICAgICAjIG5vIGhpZ2hsaWdodGluZyBvcHRpb25zIGZvciB0YWJzDQogICAgICAgIHBhc3MNCg0KICAgIEBzdGF0aWNtZXRob2QNCiAgICBkZWYgY2hlY2tfcHlyZXZpdF90YWIocmV2aXRfdWlfdGFiKToNCiAgICAgICAgcmV0dXJuIGhhc2F0dHIocmV2aXRfdWlfdGFiLCAnVGFnJykgXA0KICAgICAgICAgICAgICAgYW5kIHJldml0X3VpX3RhYi5UYWcgPT0gUFlSRVZJVF9UQUJfSURFTlRJRklFUg0KDQogICAgZGVmIGlzX3B5cmV2aXRfdGFiKHNlbGYpOg0KICAgICAgICByZXR1cm4gc2VsZi5nZXRfcnZ0YXBpX29iamVjdCgpLlRhZyA9PSBQWVJFVklUX1RBQl9JREVOVElGSUVSDQoNCiAgICBkZWYgdXBkYXRlX25hbWUoc2VsZiwgbmV3X25hbWUpOg0KICAgICAgICBzZWxmLmdldF9ydnRhcGlfb2JqZWN0KCkuVGl0bGUgPSBuZXdfbmFtZQ0KDQogICAgZGVmIGNyZWF0ZV9yaWJib25fcGFuZWwoc2VsZiwgcGFuZWxfbmFtZSwgdXBkYXRlX2lmX2V4aXN0cz1GYWxzZSk6DQogICAgICAgICIiIkNyZWF0ZSByaWJib24gcGFuZWwgKFJldml0VUkuUmliYm9uUGFuZWwpIGZyb20gcGFuZWxfbmFtZS4iIiINCiAgICAgICAgaWYgc2VsZi5jb250YWlucyhwYW5lbF9uYW1lKToNCiAgICAgICAgICAgIGlmIHVwZGF0ZV9pZl9leGlzdHM6DQogICAgICAgICAgICAgICAgZXhpdGluZ19weXJ2dF9wYW5lbCA9IHNlbGYuX2dldF9jb21wb25lbnQocGFuZWxfbmFtZSkNCiAgICAgICAgICAgICAgICBleGl0aW5nX3B5cnZ0X3BhbmVsLmFjdGl2YXRlKCkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ1JpYmJvblBhbmVsIGFscmVhZHkgZXhpdHMgYW5kIHVwZGF0ZSAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2lzIG5vdCBhbGxvd2VkOiB7fScuZm9ybWF0KHBhbmVsX25hbWUpKQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgICMgY3JlYXRpbmcgcGFuZWwgaW4gdGFiDQogICAgICAgICAgICAgICAgcmliYm9uX3BhbmVsID0gXA0KICAgICAgICAgICAgICAgICAgICBIT1NUX0FQUC51aWFwcC5DcmVhdGVSaWJib25QYW5lbChzZWxmLm5hbWUsIHBhbmVsX25hbWUpDQogICAgICAgICAgICAgICAgIyBjcmVhdGluZyBfUHlSZXZpdFJpYmJvblBhbmVsIG9iamVjdCBhbmQNCiAgICAgICAgICAgICAgICAjIGFkZCBuZXcgcGFuZWwgdG8gbGlzdCBvZiBjdXJyZW50IHBhbmVscw0KICAgICAgICAgICAgICAgIHB5cnZ0X3JpYmJvbl9wYW5lbCA9IF9QeVJldml0UmliYm9uUGFuZWwocmliYm9uX3BhbmVsLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcnZ0YXBpX29iamVjdCkNCiAgICAgICAgICAgICAgICBweXJ2dF9yaWJib25fcGFuZWwuc2V0X2RpcnR5X2ZsYWcoKQ0KICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9jb21wb25lbnQocHlydnRfcmliYm9uX3BhbmVsKQ0KDQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHBhbmVsX2VycjoNCiAgICAgICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignQ2FuIG5vdCBjcmVhdGUgcGFuZWw6IHt9Jw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JtYXQocGFuZWxfZXJyKSkNCg0KDQpjbGFzcyBfUHlSZXZpdFVJKEdlbmVyaWNQeVJldml0VUlDb250YWluZXIpOg0KICAgICIiIkNhcHR1cmVzIHRoZSBleGlzdGluZyB1aSBzdGF0ZSBhbmQgZWxlbWVudHMgYXQgY3JlYXRpb24uIiIiDQoNCiAgICByaWJib25fdGFiID0gR2VuZXJpY1B5UmV2aXRVSUNvbnRhaW5lci5fZ2V0X2NvbXBvbmVudA0KDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFsbF9uYXRpdmU9RmFsc2UpOg0KICAgICAgICBHZW5lcmljUHlSZXZpdFVJQ29udGFpbmVyLl9faW5pdF9fKHNlbGYpDQoNCiAgICAgICAgIyBSZXZpdCBkb2VzIG5vdCBoYXZlIGFueSBtZXRob2QgdG8gZ2V0IGEgbGlzdCBvZiBjdXJyZW50IHRhYnMuDQogICAgICAgICMgR2V0dGluZyBhIGxpc3Qgb2YgY3VycmVudCB0YWJzIHVzaW5nIGFkd2luZG93cy5kbGwgbWV0aG9kcw0KICAgICAgICAjIEl0ZXJhdGluZyBvdmVyIHRhYnMsDQogICAgICAgICMgYmVjYXVzZSBDb21wb25lbnRNYW5hZ2VyLlJpYmJvbi5UYWJzLkZpbmRUYWIodGFiLm5hbWUpDQogICAgICAgICMgZG9lcyBub3QgcmV0dXJuIGludmlzaWJsZSB0YWJzDQogICAgICAgIGZvciByZXZpdF91aV90YWIgaW4gQWRXaW5kb3dzLkNvbXBvbmVudE1hbmFnZXIuUmliYm9uLlRhYnM6DQogICAgICAgICAgICAjIGZlZWRpbmcgc2VsZi5fc3ViX3B5cnZ0X3JpYmJvbl90YWJzIHdpdGggYW4gaW5zdGFuY2Ugb2YNCiAgICAgICAgICAgICMgX1B5UmV2aXRSaWJib25UYWIgb3IgUmV2aXROYXRpdmVSaWJib25UYWIgZm9yIGVhY2ggZXhpc3RpbmcNCiAgICAgICAgICAgICMgdGFiLiBfUHlSZXZpdFJpYmJvblRhYiBvciBSZXZpdE5hdGl2ZVJpYmJvblRhYiB3aWxsIGZpbmQNCiAgICAgICAgICAgICMgdGhlaXIgZXhpc3RpbmcgcGFuZWxzIG9ubHkgbGlzdGluZyB2aXNpYmxlIHRhYnMNCiAgICAgICAgICAgICMgKHRoZXJlIG1pZ2h0IGJlIHRhYnMgd2l0aCBpZGVudGljYWwgbmFtZXMNCiAgICAgICAgICAgICMgZS5nLiB0aGVyZSBhcmUgdHdvIEFubm90YXRlIHRhYnMuIFRoZXkgYXJlIGFjdGl2YXRlZCBhcw0KICAgICAgICAgICAgIyBuZWNjZXNzYXJ5IHBlciBjb250ZXh0IGJ1dCBuZWVkIHRvIGFkZCBpbmFjdGl2ZS9pbnZpc2libGUNCiAgICAgICAgICAgICMgcHlyZXZpdCB0YWJzIChQWVJFVklUX1RBQl9JREVOVElGSUVSKSBhbnl3YXkuDQogICAgICAgICAgICAjIGlmIHJldml0X3VpX3RhYi5Jc1Zpc2libGUNCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICBpZiBub3QgYWxsX25hdGl2ZSBcDQogICAgICAgICAgICAgICAgICAgICAgICBhbmQgX1B5UmV2aXRSaWJib25UYWIuY2hlY2tfcHlyZXZpdF90YWIocmV2aXRfdWlfdGFiKToNCiAgICAgICAgICAgICAgICAgICAgbmV3X3B5cnZ0X3RhYiA9IF9QeVJldml0UmliYm9uVGFiKHJldml0X3VpX3RhYikNCiAgICAgICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgICAgICBuZXdfcHlydnRfdGFiID0gUmV2aXROYXRpdmVSaWJib25UYWIocmV2aXRfdWlfdGFiKQ0KICAgICAgICAgICAgICAgIHNlbGYuX2FkZF9jb21wb25lbnQobmV3X3B5cnZ0X3RhYikNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdUYWIgYWRkZWQgdG8gdGhlIGxpc3Qgb2YgdGFiczogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3X3B5cnZ0X3RhYi5uYW1lKQ0KICAgICAgICAgICAgZXhjZXB0IFB5UmV2aXRVSUVycm9yOg0KICAgICAgICAgICAgICAgICMgaWYgX1B5UmV2aXRSaWJib25UYWIocmV2aXRfdWlfdGFiKSBmYWlscywNCiAgICAgICAgICAgICAgICAjIFJldml0IHJlc3RyaWN0cyBhY2Nlc3MgdG8gaXRzIHBhbmVscyBSZXZpdE5hdGl2ZVJpYmJvblRhYg0KICAgICAgICAgICAgICAgICMgdXNlcyBhIGRpZmZlcmVudCBtZXRob2QgdG8gYWNjZXNzIHRoZSBwYW5lbHMNCiAgICAgICAgICAgICAgICAjIHRvIGludGVyYWN0IHdpdGggZXhpc3RpbmcgbmF0aXZlIHVpDQogICAgICAgICAgICAgICAgbmV3X3B5cnZ0X3RhYiA9IFJldml0TmF0aXZlUmliYm9uVGFiKHJldml0X3VpX3RhYikNCiAgICAgICAgICAgICAgICBzZWxmLl9hZGRfY29tcG9uZW50KG5ld19weXJ2dF90YWIpDQogICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnTmF0aXZlIHRhYiBhZGRlZCB0byB0aGUgbGlzdCBvZiB0YWJzOiAlcycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdfcHlydnRfdGFiLm5hbWUpDQoNCiAgICBkZWYgZ2V0X2Fkd2luZG93c19yaWJib25fY29udHJvbChzZWxmKToNCiAgICAgICAgcmV0dXJuIEFkV2luZG93cy5Db21wb25lbnRNYW5hZ2VyLlJpYmJvbg0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiB0b2dnbGVfcmliYm9uX3VwZGF0b3IoDQogICAgICAgICAgICBzdGF0ZSwNCiAgICAgICAgICAgIGZsb3dfZGlyZWN0aW9uPVdpbmRvd3MuRmxvd0RpcmVjdGlvbi5MZWZ0VG9SaWdodCk6DQogICAgICAgICMgY2FuY2VsIG91dCB0aGUgcmliYm9uIHVwZGF0b3IgZnJvbSBwcmV2aW91cyBydW50aW1lIHZlcnNpb24NCiAgICAgICAgY3VycmVudF9yaWJib25fdXBkYXRvciA9IFwNCiAgICAgICAgICAgIGVudnZhcnMuZ2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLlJJQkJPTlVQREFUT1JfRU5WVkFSKQ0KICAgICAgICBpZiBjdXJyZW50X3JpYmJvbl91cGRhdG9yOg0KICAgICAgICAgICAgY3VycmVudF9yaWJib25fdXBkYXRvci5TdG9wVXBkYXRpbmdSaWJib24oKQ0KDQogICAgICAgICMgcmVzZXQgZW52IHZhcg0KICAgICAgICBlbnZ2YXJzLnNldF9weXJldml0X2Vudl92YXIoZW52dmFycy5SSUJCT05VUERBVE9SX0VOVlZBUiwgTm9uZSkNCiAgICAgICAgaWYgc3RhdGU6DQogICAgICAgICAgICAjIHN0YXJ0IG9yIHN0b3AgdGhlIHJpYmJvbiB1cGRhdG9yDQogICAgICAgICAgICBwYW5lbF9zZXQgPSBOb25lDQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgbWFpbl93bmQgPSB1aS5nZXRfbWFpbndpbmRvdygpDQogICAgICAgICAgICAgICAgcmliYm9uX3Jvb3RfdHlwZSA9IHVpLmdldF9yaWJib25fcm9vdHR5cGUoKQ0KICAgICAgICAgICAgICAgIHBhbmVsX3NldCA9IFwNCiAgICAgICAgICAgICAgICAgICAgbWFpbl93bmQuRmluZEZpcnN0Q2hpbGRbcmliYm9uX3Jvb3RfdHlwZV0obWFpbl93bmQpDQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHJhZXg6DQogICAgICAgICAgICAgICAgbWxvZ2dlci5lcnJvcignRXJyb3IgYWN0aXZhdGluZyByaWJib24gdXBkYXRvci4gfCAlcycsIHJhZXgpDQogICAgICAgICAgICAgICAgcmV0dXJuDQoNCiAgICAgICAgICAgIGlmIHBhbmVsX3NldDoNCiAgICAgICAgICAgICAgICB0eXBlcy5SaWJib25FdmVudFV0aWxzLlN0YXJ0VXBkYXRpbmdSaWJib24oDQogICAgICAgICAgICAgICAgICAgIHBhbmVsU2V0PXBhbmVsX3NldCwNCiAgICAgICAgICAgICAgICAgICAgZmxvd0Rpcj1mbG93X2RpcmVjdGlvbiwNCiAgICAgICAgICAgICAgICAgICAgdGFnVGFnPVBZUkVWSVRfVEFCX0lERU5USUZJRVINCiAgICAgICAgICAgICAgICApDQogICAgICAgICAgICAgICAgIyBzZXQgdGhlIG5ldyBjb2xvcml6ZXINCiAgICAgICAgICAgICAgICBlbnZ2YXJzLnNldF9weXJldml0X2Vudl92YXIoDQogICAgICAgICAgICAgICAgICAgIGVudnZhcnMuUklCQk9OVVBEQVRPUl9FTlZWQVIsDQogICAgICAgICAgICAgICAgICAgIHR5cGVzLlJpYmJvbkV2ZW50VXRpbHMNCiAgICAgICAgICAgICAgICAgICAgKQ0KDQogICAgZGVmIHNldF9SVExfZmxvdyhzZWxmKToNCiAgICAgICAgX1B5UmV2aXRVSS50b2dnbGVfcmliYm9uX3VwZGF0b3IoDQogICAgICAgICAgICBzdGF0ZT1UcnVlLA0KICAgICAgICAgICAgZmxvd19kaXJlY3Rpb249V2luZG93cy5GbG93RGlyZWN0aW9uLlJpZ2h0VG9MZWZ0DQogICAgICAgICAgICApDQoNCiAgICBkZWYgc2V0X0xUUl9mbG93KHNlbGYpOg0KICAgICAgICAjIGRlZmF1bHQgaXMgTFRSLCBtYWtlIHN1cmUgYW55IGV4aXN0aW5nIGlzIHN0b3BwZWQNCiAgICAgICAgX1B5UmV2aXRVSS50b2dnbGVfcmliYm9uX3VwZGF0b3Ioc3RhdGU9RmFsc2UpDQoNCiAgICBkZWYgdW5zZXRfUlRMX2Zsb3coc2VsZik6DQogICAgICAgIF9QeVJldml0VUkudG9nZ2xlX3JpYmJvbl91cGRhdG9yKHN0YXRlPUZhbHNlKQ0KDQogICAgZGVmIHVuc2V0X0xUUl9mbG93KHNlbGYpOg0KICAgICAgICAjIGRlZmF1bHQgaXMgTFRSLCBtYWtlIHN1cmUgYW55IGV4aXN0aW5nIGlzIHN0b3BwZWQNCiAgICAgICAgX1B5UmV2aXRVSS50b2dnbGVfcmliYm9uX3VwZGF0b3Ioc3RhdGU9RmFsc2UpDQoNCiAgICBkZWYgZ2V0X3B5cmV2aXRfdGFicyhzZWxmKToNCiAgICAgICAgcmV0dXJuIFt0YWIgZm9yIHRhYiBpbiBzZWxmIGlmIHRhYi5pc19weXJldml0X3RhYigpXQ0KDQogICAgZGVmIGNyZWF0ZV9yaWJib25fdGFiKHNlbGYsIHRhYl9uYW1lLCB1cGRhdGVfaWZfZXhpc3RzPUZhbHNlKToNCiAgICAgICAgaWYgc2VsZi5jb250YWlucyh0YWJfbmFtZSk6DQogICAgICAgICAgICBpZiB1cGRhdGVfaWZfZXhpc3RzOg0KICAgICAgICAgICAgICAgIGV4aXN0aW5nX3B5cnZ0X3RhYiA9IHNlbGYuX2dldF9jb21wb25lbnQodGFiX25hbWUpDQogICAgICAgICAgICAgICAgZXhpc3RpbmdfcHlydnRfdGFiLmFjdGl2YXRlKCkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ1JpYmJvblRhYiBhbHJlYWR5IGV4aXRzIGFuZCB1cGRhdGUgaXMgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdub3QgYWxsb3dlZDoge30nLmZvcm1hdCh0YWJfbmFtZSkpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgIyBjcmVhdGluZyB0YWIgaW4gUmV2aXQgdWkNCiAgICAgICAgICAgICAgICBIT1NUX0FQUC51aWFwcC5DcmVhdGVSaWJib25UYWIodGFiX25hbWUpDQogICAgICAgICAgICAgICAgIyBIT1NUX0FQUC51aWFwcC5DcmVhdGVSaWJib25UYWIoKSBkb2VzDQogICAgICAgICAgICAgICAgIyBub3QgcmV0dXJuIHRoZSBjcmVhdGVkIHRhYiBvYmplY3QuDQogICAgICAgICAgICAgICAgIyBzbyBmaW5kIHRoZSB0YWIgb2JqZWN0IGluIGV4aXRpbmcgdWkNCiAgICAgICAgICAgICAgICByZXZpdF90YWJfY3RybCA9IE5vbmUNCiAgICAgICAgICAgICAgICBmb3IgZXhpdGluZ19ydnRfcmliYm9uX3RhYiBpbiBcDQogICAgICAgICAgICAgICAgICAgICAgICBBZFdpbmRvd3MuQ29tcG9uZW50TWFuYWdlci5SaWJib24uVGFiczoNCiAgICAgICAgICAgICAgICAgICAgaWYgZXhpdGluZ19ydnRfcmliYm9uX3RhYi5UaXRsZSA9PSB0YWJfbmFtZToNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldml0X3RhYl9jdHJsID0gZXhpdGluZ19ydnRfcmliYm9uX3RhYg0KDQogICAgICAgICAgICAgICAgIyBjcmVhdGUgX1B5UmV2aXRSaWJib25UYWIgb2JqZWN0IHdpdGgNCiAgICAgICAgICAgICAgICAjIHRoZSByZWNvdmVyZWQgUmliYm9uVGFiIG9iamVjdA0KICAgICAgICAgICAgICAgICMgYW5kIGFkZCBuZXcgX1B5UmV2aXRSaWJib25UYWIgdG8gbGlzdCBvZiBjdXJyZW50IHRhYnMNCiAgICAgICAgICAgICAgICBpZiByZXZpdF90YWJfY3RybDoNCiAgICAgICAgICAgICAgICAgICAgcHlydnRfcmliYm9uX3RhYiA9IF9QeVJldml0UmliYm9uVGFiKHJldml0X3RhYl9jdHJsLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfcHlydnRfdGFiPVRydWUpDQogICAgICAgICAgICAgICAgICAgIHB5cnZ0X3JpYmJvbl90YWIuc2V0X2RpcnR5X2ZsYWcoKQ0KICAgICAgICAgICAgICAgICAgICBzZWxmLl9hZGRfY29tcG9uZW50KHB5cnZ0X3JpYmJvbl90YWIpDQogICAgICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgUHlSZXZpdFVJRXJyb3IoJ1RhYiBjcmVhdGVkIGJ1dCBjYW4gbm90ICcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2JlIG9idGFpbmVkIGZyb20gdWkuJykNCg0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyB0YWJfY3JlYXRlX2VycjoNCiAgICAgICAgICAgICAgICByYWlzZSBQeVJldml0VUlFcnJvcignQ2FuIG5vdCBjcmVhdGUgdGFiOiB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KHRhYl9jcmVhdGVfZXJyKSkNCg0KDQojIFB1YmxpYyBmdW5jdGlvbiB0byByZXR1cm4gYW4gaW5zdGFuY2Ugb2YgX1B5UmV2aXRVSSB3aGljaCBpcyB1c2VkDQojIHRvIGludGVyYWN0IHdpdGggY3VycmVudCB1aSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KZGVmIGdldF9jdXJyZW50X3VpKGFsbF9uYXRpdmU9RmFsc2UpOg0KICAgICIiIlJldml0IFVJIFdyYXBwZXIgY2xhc3MgZm9yIGludGVyYWN0aW5nIHdpdGggY3VycmVudCBweVJldml0IFVJLg0KDQogICAgUmV0dXJuZWQgY2xhc3MgcHJvdmlkZXMgbWluIHJlcXVpcmVkIGZ1bmN0aW9uYWxpdHkgZm9yIHVzZXIgaW50ZXJhY3Rpb24NCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgY3VycmVudF91aSA9IHB5cmV2aXQuc2Vzc2lvbi5jdXJyZW50X3VpKCkNCiAgICAgICAgdGhpc19zY3JpcHQgPSBweXJldml0LnNlc3Npb24uZ2V0X3RoaXNfY29tbWFuZCgpDQogICAgICAgIGN1cnJlbnRfdWkudXBkYXRlX2J1dHRvbl9pY29uKHRoaXNfc2NyaXB0LCBuZXdfaWNvbikNCiAgICAgICAgYGBgDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoX1B5UmV2aXRVSSk6IHdyYXBwZXIgYXJvdW5kIGFjdGl2ZSByaWJib24gZ3VpDQogICAgIiIiDQogICAgcmV0dXJuIF9QeVJldml0VUkoYWxsX25hdGl2ZT1hbGxfbmF0aXZlKQ0KDQoNCmRlZiBnZXRfdWlidXR0b24oY29tbWFuZF91bmlxdWVfbmFtZSk6DQogICAgIiIiRmluZCBhbmQgcmV0dXJuIHJpYmJvbiB1aSBidXR0b24gd2l0aCBnaXZlbiB1bmlxdWUgaWQuDQoNCiAgICBBcmdzOg0KICAgICAgICBjb21tYW5kX3VuaXF1ZV9uYW1lIChzdHIpOiB1bmlxdWUgaWQgb2YgcHlSZXZpdCBjb21tYW5kDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoX1B5UmV2aXRSaWJib25CdXR0b24pOiB1aSBidXR0b24gd3JhcHBlciBvYmplY3QNCiAgICAiIiINCiAgICAjIEZJWE1FOiB2ZXJpZnkgcmV0dXJuIHR5cGUNCiAgICBweXJ2dF90YWJzID0gZ2V0X2N1cnJlbnRfdWkoKS5nZXRfcHlyZXZpdF90YWJzKCkNCiAgICBmb3IgdGFiIGluIHB5cnZ0X3RhYnM6DQogICAgICAgIGJ1dHRvbiA9IHRhYi5maW5kX2NoaWxkKGNvbW1hbmRfdW5pcXVlX25hbWUpDQogICAgICAgIGlmIGJ1dHRvbjoNCiAgICAgICAgICAgIHJldHVybiBidXR0b24NCiAgICByZXR1cm4gTm9uZQ0KDQoiIiJCYXNlIG1vZHVsZSBmb3IgaGFuZGxpbmcgZXh0ZW5zaW9ucyBwYXJzaW5nLiIiIg0KZnJvbSBweXJldml0IGltcG9ydCBIT1NUX0FQUCwgRVhFQ19QQVJBTVMNCg0KIyBFeHRlbnNpb24gdHlwZXMNCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQpMSUJfRVhURU5TSU9OX1BPU1RGSVggPSAnLmxpYicNClVJX0VYVEVOU0lPTl9QT1NURklYID0gJy5leHRlbnNpb24nDQoNCg0KY2xhc3MgVUlFeHRlbnNpb25UeXBlOg0KICAgICIiIlVJIGV4dGVuc2lvbiB0eXBlLiIiIg0KICAgIElEID0gJ2V4dGVuc2lvbicNCiAgICBQT1NURklYID0gJy5leHRlbnNpb24nDQoNCg0KY2xhc3MgTElCRXh0ZW5zaW9uVHlwZToNCiAgICAiIiJMaWJyYXJ5IGV4dGVuc2lvbiB0eXBlLiIiIg0KICAgIElEID0gJ2xpYicNCiAgICBQT1NURklYID0gJy5saWInDQoNCg0KY2xhc3MgRXh0ZW5zaW9uVHlwZXM6DQogICAgIiIiRXh0ZW5zaW9uIHR5cGVzLiIiIg0KICAgIFVJX0VYVEVOU0lPTiA9IFVJRXh0ZW5zaW9uVHlwZQ0KICAgIExJQl9FWFRFTlNJT04gPSBMSUJFeHRlbnNpb25UeXBlDQoNCiAgICBAY2xhc3NtZXRob2QNCiAgICBkZWYgZ2V0X2V4dF90eXBlcyhjbHMpOg0KICAgICAgICBleHRfdHlwZXMgPSBzZXQoKQ0KICAgICAgICBmb3IgYXR0ciBpbiBkaXIoY2xzKToNCiAgICAgICAgICAgIGlmIGF0dHIuZW5kc3dpdGgoJ19FWFRFTlNJT04nKToNCiAgICAgICAgICAgICAgICBleHRfdHlwZXMuYWRkKGdldGF0dHIoY2xzLCBhdHRyKSkNCiAgICAgICAgcmV0dXJuIGV4dF90eXBlcw0KDQoNCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiMgc3VwcG9ydGVkIHNjcmlwdGluZyBsYW5ndWFnZXMNClBZVEhPTl9MQU5HID0gJ3B5dGhvbicNCkNTSEFSUF9MQU5HID0gJ2NzaGFycCcNClZCX0xBTkcgPSAndmlzdWFsYmFzaWMnDQpSVUJZX0xBTkcgPSAncnVieScNCkRZTkFNT19MQU5HID0gJ2R5bmFtb2JpbScNCkdSQVNTSE9QUEVSX0xBTkcgPSAnZ3Jhc3Nob3BwZXInDQojIGNweXRob24gaGFzaC1iYW5nDQpDUFlUSE9OX0hBU0hCQU5HID0gJyMhIHB5dGhvbjMnDQoNCiMgc3VwcG9ydGVkIHNjcmlwdCBmaWxlcw0KUFlUSE9OX1NDUklQVF9GSUxFX0ZPUk1BVCA9ICcucHknDQpDU0hBUlBfU0NSSVBUX0ZJTEVfRk9STUFUID0gJy5jcycNClZCX1NDUklQVF9GSUxFX0ZPUk1BVCA9ICcudmInDQpSVUJZX1NDUklQVF9GSUxFX0ZPUk1BVCA9ICcucmInDQpEWU5BTU9fU0NSSVBUX0ZJTEVfRk9STUFUID0gJy5keW4nDQpHUkFTU0hPUFBFUl9TQ1JJUFRfRklMRV9GT1JNQVQgPSAnLmdoJw0KR1JBU1NIT1BQRVJYX1NDUklQVF9GSUxFX0ZPUk1BVCA9ICcuZ2h4Jw0KQ09OVEVOVF9GSUxFX0ZPUk1BVCA9ICcucmZhJw0KDQojIGV4dGVuc2lvbiBzdGFydHVwIHNjcmlwdA0KRVhUX1NUQVJUVVBfTkFNRSA9ICdzdGFydHVwJw0KUFlUSE9OX0VYVF9TVEFSVFVQX0ZJTEUgPSBFWFRfU1RBUlRVUF9OQU1FICsgUFlUSE9OX1NDUklQVF9GSUxFX0ZPUk1BVA0KQ1NIQVJQX0VYVF9TVEFSVFVQX0ZJTEUgPSBFWFRfU1RBUlRVUF9OQU1FICsgQ1NIQVJQX1NDUklQVF9GSUxFX0ZPUk1BVA0KVkJfRVhUX1NUQVJUVVBfRklMRSA9IEVYVF9TVEFSVFVQX05BTUUgKyBWQl9TQ1JJUFRfRklMRV9GT1JNQVQNClJVQllfRVhUX1NUQVJUVVBfRklMRSA9IEVYVF9TVEFSVFVQX05BTUUgKyBSVUJZX1NDUklQVF9GSUxFX0ZPUk1BVA0KDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojIHN1cHBvcnRlZCBtZXRhZGF0YSBmb3JtYXRzDQpZQU1MX0ZJTEVfRk9STUFUID0gJy55YW1sJw0KSlNPTl9GSUxFX0ZPUk1BVCA9ICcuanNvbicNCg0KIyBtZXRhZGF0YSBmaWxlbmFtZXMNCkVYVF9NQU5JRkVTVF9OQU1FID0gJ2V4dGVuc2lvbicNCkVYVF9NQU5JRkVTVF9GSUxFID0gRVhUX01BTklGRVNUX05BTUUgKyBKU09OX0ZJTEVfRk9STUFUDQoNCkRFRkFVTFRfQlVORExFTUFUQV9OQU1FID0gJ2J1bmRsZScNCkJVTkRMRU1BVEFfUE9TVEZJWCA9IERFRkFVTFRfQlVORExFTUFUQV9OQU1FICsgWUFNTF9GSUxFX0ZPUk1BVA0KDQojIG1ldGFkYXRhIHNjaGVtYTogRXhlbnNpb25zDQoNCiMgbWV0YWRhdGEgc2NoZW1hOiBCdW5kbGVzDQpNREFUQV9VSV9USVRMRSA9ICd0aXRsZScNCk1EQVRBX1RPT0xUSVAgPSAndG9vbHRpcCcNCk1EQVRBX0FVVEhPUiA9ICdhdXRob3InDQpNREFUQV9BVVRIT1JTID0gJ2F1dGhvcnMnDQpNREFUQV9MQVlPVVQgPSAnbGF5b3V0Jw0KTURBVEFfQ09NTUFORF9IRUxQX1VSTCA9ICdoZWxwX3VybCcNCk1EQVRBX0NPTU1BTkRfQ09OVEVYVCA9ICdjb250ZXh0Jw0KTURBVEFfQ09NTUFORF9DT05URVhUX1RZUEUgPSAidHlwZSINCk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9OT1QgPSAibm90XyINCk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9BTlkgPSAiYW55Ig0KTURBVEFfQ09NTUFORF9DT05URVhUX0FMTCA9ICJhbGwiDQpNREFUQV9DT01NQU5EX0NPTlRFWFRfRVhBQ1QgPSAiZXhhY3QiDQpNREFUQV9DT01NQU5EX0NPTlRFWFRfTk9UQU5ZID0gTURBVEFfQ09NTUFORF9DT05URVhUX05PVCArIE1EQVRBX0NPTU1BTkRfQ09OVEVYVF9BTlkNCk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9OT1RBTEwgPSBNREFUQV9DT01NQU5EX0NPTlRFWFRfTk9UICsgTURBVEFfQ09NTUFORF9DT05URVhUX0FMTA0KTURBVEFfQ09NTUFORF9DT05URVhUX05PVEVYQUNUID0gTURBVEFfQ09NTUFORF9DT05URVhUX05PVCArIE1EQVRBX0NPTU1BTkRfQ09OVEVYVF9FWEFDVA0KTURBVEFfQ09NTUFORF9DT05URVhUX0FOWV9TRVAgPSAifCINCk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9BTExfU0VQID0gIiYiDQpNREFUQV9DT01NQU5EX0NPTlRFWFRfRVhBQ1RfU0VQID0gIjsiDQpNREFUQV9DT01NQU5EX0NPTlRFWFRfUlVMRSA9ICIoe3J1bGV9KSINCk1EQVRBX01JTl9SRVZJVF9WRVJTSU9OID0gJ21pbl9yZXZpdF92ZXJzaW9uJw0KTURBVEFfTUFYX1JFVklUX1ZFUlNJT04gPSAnbWF4X3Jldml0X3ZlcnNpb24nDQpNREFUQV9CRVRBX1NDUklQVCA9ICdpc19iZXRhJw0KTURBVEFfRU5HSU5FID0gJ2VuZ2luZScNCk1EQVRBX0VOR0lORV9DTEVBTiA9ICdjbGVhbicNCk1EQVRBX0VOR0lORV9GVUxMRlJBTUUgPSAnZnVsbF9mcmFtZScNCk1EQVRBX0VOR0lORV9QRVJTSVNURU5UID0gJ3BlcnNpc3RlbnQnDQpNREFUQV9FTkdJTkVfTUFJTlRIUkVBRCA9ICdtYWludGhyZWFkJw0KTURBVEFfTElOS19CVVRUT05fTU9EVUxFUyA9ICdtb2R1bGVzJw0KTURBVEFfTElOS19CVVRUT05fQVNTRU1CTFkgPSAnYXNzZW1ibHknDQpNREFUQV9MSU5LX0JVVFRPTl9DT01NQU5EX0NMQVNTID0gJ2NvbW1hbmRfY2xhc3MnDQpNREFUQV9MSU5LX0JVVFRPTl9BVkFJTF9DT01NQU5EX0NMQVNTID0gJ2F2YWlsYWJpbGl0eV9jbGFzcycNCk1EQVRBX1VSTF9CVVRUT05fSFlQRVJMSU5LID0gJ2h5cGVybGluaycNCk1EQVRBX1RFTVBMQVRFU19LRVkgPSAndGVtcGxhdGVzJw0KTURBVEFfQkFDS0dST1VORF9LRVkgPSAnYmFja2dyb3VuZCcNCk1EQVRBX0JBQ0tHUk9VTkRfUEFORUxfS0VZID0gJ3BhbmVsJw0KTURBVEFfQkFDS0dST1VORF9USVRMRV9LRVkgPSAndGl0bGUnDQpNREFUQV9CQUNLR1JPVU5EX1NMSURFT1VUX0tFWSA9ICdzbGlkZW91dCcNCk1EQVRBX0hJR0hMSUdIVF9LRVkgPSAnaGlnaGxpZ2h0Jw0KTURBVEFfSElHSExJR0hUX1RZUEVfTkVXID0gJ25ldycNCk1EQVRBX0hJR0hMSUdIVF9UWVBFX1VQREFURUQgPSAndXBkYXRlZCcNCk1EQVRBX0NPTExBUFNFRF9LRVkgPSAnY29sbGFwc2VkJw0KIyBtZXRhZGF0YSBzY2hlbWE6IER5bmFtb0JJTSBidW5kbGVzDQpNREFUQV9FTkdJTkVfRFlOQU1PX0FVVE9NQVRFID0gJ2F1dG9tYXRlJw0KTURBVEFfRU5HSU5FX0RZTkFNT19QQVRIID0gJ2R5bmFtb19wYXRoJw0KIyBNREFUQV9FTkdJTkVfRFlOQU1PX1BBVEhfRVhFQyA9ICdkeW5hbW9fcGF0aF9leGVjJw0KTURBVEFfRU5HSU5FX0RZTkFNT19QQVRIX0NIRUNLX0VYSVNUID0gJ2R5bmFtb19wYXRoX2NoZWNrX2V4aXN0aW5nJw0KTURBVEFfRU5HSU5FX0RZTkFNT19GT1JDRV9NQU5VQUxfUlVOID0gJ2R5bmFtb19mb3JjZV9tYW51YWxfcnVuJw0KTURBVEFfRU5HSU5FX0RZTkFNT19NT0RFTF9OT0RFU19JTkZPID0gJ2R5bmFtb19tb2RlbF9ub2Rlc19pbmZvJw0KDQojIG1ldGFkYXRhIHNjaGVtYTogQnVuZGxlcyB8IGxlZ2FjeQ0KVUlfVElUTEVfUEFSQU0gPSAnX190aXRsZV9fJw0KRE9DU1RSSU5HX1BBUkFNID0gJ19fZG9jX18nDQpBVVRIT1JfUEFSQU0gPSAnX19hdXRob3JfXycNCkFVVEhPUlNfUEFSQU0gPSAnX19hdXRob3JzX18nDQpDT01NQU5EX0hFTFBfVVJMX1BBUkFNID0gJ19faGVscHVybF9fJw0KQ09NTUFORF9DT05URVhUX1BBUkFNID0gJ19fY29udGV4dF9fJw0KTUlOX1JFVklUX1ZFUlNJT05fUEFSQU0gPSAnX19taW5fcmV2aXRfdmVyX18nDQpNQVhfUkVWSVRfVkVSU0lPTl9QQVJBTSA9ICdfX21heF9yZXZpdF92ZXJfXycNClNISUZUX0NMSUNLX1BBUkFNID0gJ19fc2hpZnRjbGlja19fJw0KQkVUQV9TQ1JJUFRfUEFSQU0gPSAnX19iZXRhX18nDQpISUdITElHSFRfU0NSSVBUX1BBUkFNID0gJ19faGlnaGxpZ2h0X18nDQpDTEVBTl9FTkdJTkVfU0NSSVBUX1BBUkFNID0gJ19fY2xlYW5lbmdpbmVfXycNCkZVTExGUkFNRV9FTkdJTkVfUEFSQU0gPSAnX19mdWxsZnJhbWVlbmdpbmVfXycNClBFUlNJU1RFTlRfRU5HSU5FX1BBUkFNID0gJ19fcGVyc2lzdGVudGVuZ2luZV9fJw0KDQojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQojIHN1cHBvcnRlZCBidW5kbGVzDQpUQUJfUE9TVEZJWCA9ICcudGFiJw0KUEFORUxfUE9TVEZJWCA9ICcucGFuZWwnDQpMSU5LX0JVVFRPTl9QT1NURklYID0gJy5saW5rYnV0dG9uJw0KSU5WT0tFX0JVVFRPTl9QT1NURklYID0gJy5pbnZva2VidXR0b24nDQpQVVNIX0JVVFRPTl9QT1NURklYID0gJy5wdXNoYnV0dG9uJw0KU01BUlRfQlVUVE9OX1BPU1RGSVggPSAnLnNtYXJ0YnV0dG9uJw0KUFVMTERPV05fQlVUVE9OX1BPU1RGSVggPSAnLnB1bGxkb3duJw0KU1RBQ0tfQlVUVE9OX1BPU1RGSVggPSAnLnN0YWNrJw0KU1BMSVRfQlVUVE9OX1BPU1RGSVggPSAnLnNwbGl0YnV0dG9uJw0KU1BMSVRQVVNIX0JVVFRPTl9QT1NURklYID0gJy5zcGxpdHB1c2hidXR0b24nDQpQQU5FTF9QVVNIX0JVVFRPTl9QT1NURklYID0gJy5wYW5lbGJ1dHRvbicNCk5PR1VJX0NPTU1BTkRfUE9TVEZJWCA9ICcubm9idXR0b24nDQpDT05URU5UX0JVVFRPTl9QT1NURklYID0gJy5jb250ZW50Jw0KVVJMX0JVVFRPTl9QT1NURklYID0gJy51cmxidXR0b24nDQoNCiMga25vd24gYnVuZGxlIHN1Yi1kaXJlY3Rvcmllcw0KQ09NUF9MSUJSQVJZX0RJUl9OQU1FID0gJ2xpYicNCkNPTVBfQklOX0RJUl9OQU1FID0gJ2JpbicNCkNPTVBfSE9PS1NfRElSX05BTUUgPSAnaG9va3MnDQpDT01QX0NIRUNLU19ESVJfTkFNRSA9ICdjaGVja3MnDQoNCiMgdW5pcXVlIGlkcw0KVU5JUVVFX0lEX1NFUEFSQVRPUiA9ICctJw0KDQojIGJ1bmRsZSBsYXlvdXQgZWxlbWVudHMNClNFUEFSQVRPUl9JREVOVElGSUVSID0gJy0tLScNClNMSURFT1VUX0lERU5USUZJRVIgPSAnPj4+Jw0KDQojIGJ1bmRsZSBpY29uDQpJQ09OX0ZJTEVfRk9STUFUID0gJy5wbmcnDQpJQ09OX0RBUktfU1VGRklYID0gJy5kYXJrJw0KREVGQVVMVF9JQ09OX0ZJTEUgPSAnaWNvbicgKyBJQ09OX0ZJTEVfRk9STUFUDQpERUZBVUxUX09OX0lDT05fRklMRSA9ICdvbicgKyBJQ09OX0ZJTEVfRk9STUFUDQpERUZBVUxUX09GRl9JQ09OX0ZJTEUgPSAnb2ZmJyArIElDT05fRklMRV9GT1JNQVQNCg0KIyBidW5kbGUgbWVkaWEgZm9yIHRvb2x0aXBzDQpERUZBVUxUX01FRElBX0ZJTEVOQU1FID0gJ3Rvb2x0aXAnDQoNCiMgYnVuZGxlIHNjcmlwdHMNCkRFRkFVTFRfU0NSSVBUX05BTUUgPSAnc2NyaXB0Jw0KREVGQVVMVF9DT05GSUdfTkFNRSA9ICdjb25maWcnDQoNCiMgc2NyaXB0IGZpbGVzDQpQWVRIT05fU0NSSVBUX1BPU1RGSVggPSBERUZBVUxUX1NDUklQVF9OQU1FICsgUFlUSE9OX1NDUklQVF9GSUxFX0ZPUk1BVA0KUFlUSE9OX0NPTkZJR19TQ1JJUFRfUE9TVEZJWCA9IERFRkFVTFRfQ09ORklHX05BTUUgKyBQWVRIT05fU0NSSVBUX0ZJTEVfRk9STUFUDQoNCkNTSEFSUF9TQ1JJUFRfUE9TVEZJWCA9IERFRkFVTFRfU0NSSVBUX05BTUUgKyBDU0hBUlBfU0NSSVBUX0ZJTEVfRk9STUFUDQpDU0hBUlBfQ09ORklHX1NDUklQVF9QT1NURklYID0gREVGQVVMVF9DT05GSUdfTkFNRSArIENTSEFSUF9TQ1JJUFRfRklMRV9GT1JNQVQNCg0KVkJfU0NSSVBUX1BPU1RGSVggPSBERUZBVUxUX1NDUklQVF9OQU1FICsgVkJfU0NSSVBUX0ZJTEVfRk9STUFUDQpWQl9DT05GSUdfU0NSSVBUX1BPU1RGSVggPSBERUZBVUxUX0NPTkZJR19OQU1FICsgVkJfU0NSSVBUX0ZJTEVfRk9STUFUDQoNClJVQllfU0NSSVBUX1BPU1RGSVggPSBERUZBVUxUX1NDUklQVF9OQU1FICsgUlVCWV9TQ1JJUFRfRklMRV9GT1JNQVQNClJVQllfQ09ORklHX1NDUklQVF9QT1NURklYID0gREVGQVVMVF9DT05GSUdfTkFNRSArIFJVQllfU0NSSVBUX0ZJTEVfRk9STUFUDQoNCkRZTkFNT19TQ1JJUFRfUE9TVEZJWCA9IERFRkFVTFRfU0NSSVBUX05BTUUgKyBEWU5BTU9fU0NSSVBUX0ZJTEVfRk9STUFUDQpEWU5BTU9fQ09ORklHX1NDUklQVF9QT1NURklYID0gREVGQVVMVF9DT05GSUdfTkFNRSArIERZTkFNT19TQ1JJUFRfRklMRV9GT1JNQVQNCg0KR1JBU1NIT1BQRVJfU0NSSVBUX1BPU1RGSVggPSBcDQogICAgREVGQVVMVF9TQ1JJUFRfTkFNRSArIEdSQVNTSE9QUEVSX1NDUklQVF9GSUxFX0ZPUk1BVA0KR1JBU1NIT1BQRVJfQ09ORklHX1NDUklQVF9QT1NURklYID0gXA0KICAgIERFRkFVTFRfQ09ORklHX05BTUUgKyBHUkFTU0hPUFBFUl9TQ1JJUFRfRklMRV9GT1JNQVQNCg0KR1JBU1NIT1BQRVJYX1NDUklQVF9QT1NURklYID0gXA0KICAgIERFRkFVTFRfU0NSSVBUX05BTUUgKyBHUkFTU0hPUFBFUlhfU0NSSVBUX0ZJTEVfRk9STUFUDQpHUkFTU0hPUFBFUlhfQ09ORklHX1NDUklQVF9QT1NURklYID0gXA0KICAgIERFRkFVTFRfQ09ORklHX05BTUUgKyBHUkFTU0hPUFBFUlhfU0NSSVBUX0ZJTEVfRk9STUFUDQoNCiMgYnVuZGxlIGNvbnRlbnQNCkRFRkFVTFRfQ09OVEVOVF9OQU1FID0gJ2NvbnRlbnQnDQpERUZBVUxUX0FMVF9DT05URU5UX05BTUUgPSAnb3RoZXInDQoNCkNPTlRFTlRfUE9TVEZJWCA9IERFRkFVTFRfQ09OVEVOVF9OQU1FICsgQ09OVEVOVF9GSUxFX0ZPUk1BVA0KQ09OVEVOVF9WRVJTSU9OX1BPU1RGSVggPSBcDQogICAgREVGQVVMVF9DT05URU5UX05BTUUgKyAiX3t2ZXJzaW9ufSIgKyBDT05URU5UX0ZJTEVfRk9STUFUDQoNCkFMVF9DT05URU5UX1BPU1RGSVggPSBERUZBVUxUX0FMVF9DT05URU5UX05BTUUgKyBDT05URU5UX0ZJTEVfRk9STUFUDQpBTFRfQ09OVEVOVF9WRVJTSU9OX1BPU1RGSVggPSBcDQogICAgREVGQVVMVF9BTFRfQ09OVEVOVF9OQU1FICsgIl97dmVyc2lvbn0iICsgQ09OVEVOVF9GSUxFX0ZPUk1BVA0KDQojIGJ1bmRsZSBoZWxwDQpIRUxQX0ZJTEVfUEFUVEVSTiA9IHInLipoZWxwXC4uKycNCg0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KIyBDb21tYW5kIGJ1bmRsZSBkZWZhdWx0cw0KQ1RYX1NFTEVUSU9OID0gJ3NlbGVjdGlvbicNCkNUWF9aRVJPRE9DID0gJ3plcm8tZG9jJw0KDQoiIiJGaW5kLCBwYXJzZSBhbmQgY2FjaGUgZXh0ZW5zaW9ucy4NCg0KVGhlcmUgYXJlIHR3byB0eXBlcyBvZiBleHRlbnNpb25zOiBVSSBFeHRlbnNpb25zIChjb21wb25lbnRzLkV4dGVuc2lvbikgYW5kDQpMaWJyYXJ5IEV4dGVuc2lvbnMgKGNvbXBvbmVudHMuTGlicmFyeUV4dGVuc2lvbikuDQoNClRoaXMgbW9kdWxlLCBmaW5kcyB0aGUgdWkgZXh0ZW5zaW9ucyBpbnN0YWxsZWQgYW5kIHBhcnNlcyB0aGVpciBkaXJlY3RvcnkgZm9yDQp0b29scyBvciBsb2FkcyB0aGVtIGZyb20gY2FjaGUuIEl0IGFsc28gZmluZHMgdGhlIGxpYnJhcnkgZXh0ZW5zaW9ucyBhbmQgYWRkcw0KdGhlaXIgZGlyZWN0b3J5IGFkZHJlc3MgdG8gdGhlIHVpIGV4dGVuc2lvbnMgc28gdGhlIHB5dGhvbiB0b29scyBjYW4gdXNlDQp0aGUgc2hhcmVkIGxpYnJhcmllcy4NCg0KVG8gZG8gaXRzIGpvYiBjb3JyZWN0bHksIHRoaXMgbW9kdWxlIG5lZWRzIHRvIGNvbW11bmljYXRlIHdpdGgNCnB5cmV2aXQudXNlcmNvbmZpZyB0byBnZXQgYSBsaXN0IG9mIHVzZXIgZXh0ZW5zaW9uIGZvbGRlciBhbmQgYWxzbw0KcHlyZXZpdC5leHRlbnNpb25zLmV4dHBhY2thZ2VzIHRvIGNoZWNrIHdoZXRoZXIgYW4gZXh0ZW5zaW9uIGlzIGFjdGl2ZSBvciBub3QuDQoiIiINCg0KZnJvbSBweXJldml0IGltcG9ydCBFWEVDX1BBUkFNUw0KZnJvbSBweXJldml0IGltcG9ydCBNQUlOX0xJQl9ESVIsIE1JU0NfTElCX0RJUg0KZnJvbSBweXJldml0LmNvcmV1dGlscy5sb2dnZXIgaW1wb3J0IGdldF9sb2dnZXINCmZyb20gcHlyZXZpdC51c2VyY29uZmlnIGltcG9ydCB1c2VyX2NvbmZpZw0KDQoNCmlmIG5vdCBFWEVDX1BBUkFNUy5kb2NfbW9kZToNCiAgICB0cnk6DQogICAgICAgIGlmIHVzZXJfY29uZmlnLmJpbl9jYWNoZToNCiAgICAgICAgICAgIGZyb20gcHlyZXZpdC5leHRlbnNpb25zLmNhY2hlcl9iaW4gaW1wb3J0IGlzX2NhY2hlX3ZhbGlkLFwNCiAgICAgICAgICAgICAgICBnZXRfY2FjaGVkX2V4dGVuc2lvbiwgdXBkYXRlX2NhY2hlDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBmcm9tIHB5cmV2aXQuZXh0ZW5zaW9ucy5jYWNoZXJfYXNjIGltcG9ydCBpc19jYWNoZV92YWxpZCxcDQogICAgICAgICAgICAgICAgZ2V0X2NhY2hlZF9leHRlbnNpb24sIHVwZGF0ZV9jYWNoZQ0KICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoNCiAgICAgICAgdXNlcl9jb25maWcuYmluX2NhY2hlID0gVHJ1ZQ0KICAgICAgICB1c2VyX2NvbmZpZy5zYXZlX2NoYW5nZXMoKQ0KICAgICAgICBmcm9tIHB5cmV2aXQuZXh0ZW5zaW9ucy5jYWNoZXJfYmluIGltcG9ydCBpc19jYWNoZV92YWxpZCxcDQogICAgICAgICAgICBnZXRfY2FjaGVkX2V4dGVuc2lvbiwgdXBkYXRlX2NhY2hlDQoNCiNweWxpbnQ6IGRpc2FibGU9QzA0MTMNCmZyb20gcHlyZXZpdC5leHRlbnNpb25zLnBhcnNlciBpbXBvcnQgcGFyc2VfZGlyX2Zvcl9leHRfdHlwZSxcDQogICAgZ2V0X3BhcnNlZF9leHRlbnNpb24sIHBhcnNlX2NvbXBfZGlyDQpmcm9tIHB5cmV2aXQuZXh0ZW5zaW9ucy5nZW5lcmljY29tcHMgaW1wb3J0IEdlbmVyaWNVSUNvbW1hbmQNCmZyb20gcHlyZXZpdC5leHRlbnNpb25zLmNvbXBvbmVudHMgaW1wb3J0IEV4dGVuc2lvbiwgTGlicmFyeUV4dGVuc2lvbg0KDQppbXBvcnQgcHlyZXZpdC5leHRlbnNpb25zLmV4dHBhY2thZ2VzIGFzIGV4dHBrZ3MNCg0KDQojcHlsaW50OiBkaXNhYmxlPVcwNzAzLEMwMzAyLEMwMTAzDQptbG9nZ2VyID0gZ2V0X2xvZ2dlcihfX25hbWVfXykNCg0KDQpkZWYgX3VwZGF0ZV9leHRlbnNpb25fc2VhcmNoX3BhdGhzKHVpX2V4dCwgbGliX2V4dF9saXN0LCBweXJ2dF9wYXRocyk6DQogICAgZm9yIGxpYl9leHQgaW4gbGliX2V4dF9saXN0Og0KICAgICAgICB1aV9leHQuYWRkX21vZHVsZV9wYXRoKGxpYl9leHQuZGlyZWN0b3J5KQ0KDQogICAgZm9yIHB5cnZ0X3BhdGggaW4gcHlydnRfcGF0aHM6DQogICAgICAgIHVpX2V4dC5hZGRfbW9kdWxlX3BhdGgocHlydnRfcGF0aCkNCg0KDQpkZWYgX2lzX2V4dGVuc2lvbl9lbmFibGVkKGV4dF9pbmZvKToNCiAgICB0cnk6DQogICAgICAgIGV4dF9wa2cgPSBleHRwa2dzLmdldF9leHRfcGFja2FnZV9ieV9uYW1lKGV4dF9pbmZvLm5hbWUpDQogICAgICAgIGlmIGV4dF9wa2c6DQogICAgICAgICAgICByZXR1cm4gZXh0X3BrZy5pc19lbmFibGVkIGFuZCBleHRfcGtnLnVzZXJfaGFzX2FjY2Vzcw0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRXh0ZW5zaW9uIHBhY2thZ2UgaXMgbm90IGRlZmluZWQ6ICVzJywgZXh0X2luZm8ubmFtZSkNCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4dF9jaGVja19lcnI6DQogICAgICAgIG1sb2dnZXIuZXJyb3IoJ0Vycm9yIGNoZWNraW5nIHN0YXRlIGZvciBleHRlbnNpb246ICVzIHwgJXMnLA0KICAgICAgICAgICAgICAgICAgICAgIGV4dF9pbmZvLm5hbWUsIGV4dF9jaGVja19lcnIpDQoNCiAgICAjIExldHMgYmUgbmljZSBhbmQgbG9hZCB0aGUgcGFja2FnZSBpZiBpdCBpcyBub3QgZGVmaW5lZA0KICAgIHJldHVybiBUcnVlDQoNCg0KZGVmIF9yZW1vdmVfZGlzYWJsZWRfZXh0ZW5zaW9ucyhleHRfbGlzdCk6DQogICAgY2xlYW5lZF9leHRfbGlzdCA9IFtdDQogICAgZm9yIGV4dGVuc2lvbiBpbiBleHRfbGlzdDoNCiAgICAgICAgaWYgX2lzX2V4dGVuc2lvbl9lbmFibGVkKGV4dGVuc2lvbik6DQogICAgICAgICAgICBjbGVhbmVkX2V4dF9saXN0LmFwcGVuZChleHRlbnNpb24pDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdTa2lwcGluZyBkaXNhYmxlZCBleHRlbnNpb246ICVzJywgZXh0ZW5zaW9uLm5hbWUpDQoNCiAgICByZXR1cm4gY2xlYW5lZF9leHRfbGlzdA0KDQoNCmRlZiBfcGFyc2Vfb3JfY2FjaGUoZXh0X2luZm8pOg0KICAgICMgcGFyc2UgdGhlIGV4dGVuc2lvbiBpZiB1aV9leHRlbnNpb24gZG9lcyBub3QgaGF2ZSBhIHZhbGlkIGNhY2hlDQogICAgaWYgbm90IGlzX2NhY2hlX3ZhbGlkKGV4dF9pbmZvKToNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnQ2FjaGUgaXMgbm90IHZhbGlkIGZvcjogJXMnLCBleHRfaW5mbykNCg0KICAgICAgICAjIEVpdGhlciBjYWNoZSBpcyBub3QgYXZhaWxhYmxlLCBub3QgdmFsaWQsIG9yIGNhY2hlIGxvYWQgaGFzIGZhaWxlZC4NCiAgICAgICAgIyBwYXJzZSBkaXJlY3RvcnkgZm9yIGNvbXBvbmVudHMgYW5kIHJldHVybiBmdWxseSBsb2FkZWQgdWlfZXh0ZW5zaW9uDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ1BhcnNpbmcgZm9yIHVpX2V4dGVuc2lvbi4uLicpDQogICAgICAgIHVpX2V4dGVuc2lvbiA9IGdldF9wYXJzZWRfZXh0ZW5zaW9uKGV4dF9pbmZvKQ0KDQogICAgICAgICMgdXBkYXRlIGNhY2hlIHdpdGggbmV3bHkgcGFyc2VkIHVpX2V4dGVuc2lvbg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdVSSBFeHRlbnNpb24gc3VjY2Vzc2Z1bHkgcGFyc2VkOiAlcycsIHVpX2V4dGVuc2lvbi5uYW1lKQ0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdVcGRhdGluZyBjYWNoZSBmb3IgdWlfZXh0ZW5zaW9uOiAlcycsIHVpX2V4dGVuc2lvbi5uYW1lKQ0KICAgICAgICB1cGRhdGVfY2FjaGUodWlfZXh0ZW5zaW9uKQ0KDQogICAgIyBvdGhlcndpc2UgbG9hZCB0aGUgY2FjaGUNCiAgICBlbHNlOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDYWNoZSBpcyB2YWxpZCBmb3I6ICVzJywgZXh0X2luZm8pDQogICAgICAgICMgaWYgY2FjaGUgaXMgdmFsaWQsIGxvYWQgdGhlIGNhY2hlZCB1aV9leHRlbnNpb24NCiAgICAgICAgIyBjYWNoZXIgbW9kdWxlIHRha2VzIHRoZSB1aV9leHRlbnNpb24gb2JqZWN0IGFuZA0KICAgICAgICAjIGluamVjdHMgY2FjaGUgZGF0YSBpbnRvIGl0Lg0KICAgICAgICB1aV9leHRlbnNpb24gPSBnZXRfY2FjaGVkX2V4dGVuc2lvbihleHRfaW5mbykNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnVUkgRXh0ZW5zaW9uIHN1Y2Nlc3NmdWx5IGxvYWRlZCBmcm9tIGNhY2hlOiAlcycsDQogICAgICAgICAgICAgICAgICAgICB1aV9leHRlbnNpb24ubmFtZSkNCg0KICAgIHJldHVybiB1aV9leHRlbnNpb24NCg0KDQpkZWYgZ2V0X2NvbW1hbmRfZnJvbV9wYXRoKGNvbXBfcGF0aCk6DQogICAgIiIiUmV0dXJucyBhIHB5UmV2aXQgY29tbWFuZCBvYmplY3QgZnJvbSB0aGUgZ2l2ZW4gYnVuZGxlIGRpcmVjdG9yeS4NCg0KICAgIEFyZ3M6DQogICAgICAgIGNvbXBfcGF0aCAoc3RyKTogRnVsbCBkaXJlY3RvcnkgYWRkcmVzcyBvZiB0aGUgY29tbWFuZCBidW5kbGUNCg0KICAgIFJldHVybnM6DQogICAgICAgIChnZW5lcmljY29tcHMuR2VuZXJpY1VJQ29tbWFuZCk6IEEgc3ViY2xhc3Mgb2YgcHlSZXZpdCBjb21tYW5kIG9iamVjdC4NCiAgICAiIiINCiAgICBjbWRzID0gcGFyc2VfY29tcF9kaXIoY29tcF9wYXRoLCBHZW5lcmljVUlDb21tYW5kKQ0KICAgIGlmIGNtZHM6DQogICAgICAgIHJldHVybiBjbWRzWzBdDQoNCiAgICByZXR1cm4gTm9uZQ0KDQoNCmRlZiBnZXRfdGhpcmRwYXJ0eV9leHRlbnNpb25fZGF0YSgpOg0KICAgICIiIlJldHVybnMgYWxsIGluc3RhbGxlZCBhbmQgYWN0aXZlIFVJIGFuZCBMaWJyYXJ5IGV4dGVuc2lvbnMgKG5vdCBwYXJzZWQpLg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGxpc3QpOiBsaXN0IG9mIGNvbXBvbmVudHMuRXh0ZW5zaW9uIG9yIGNvbXBvbmVudHMuTGlicmFyeUV4dGVuc2lvbg0KICAgICIiIg0KICAgICMgRklYTUU6IHJlb3JnYW56aWUgdGhpcyBjb2RlIHRvIHVzZSBvbmUgc2luZ2xlIG1ldGhvZCB0byBjb2xsZWN0DQogICAgIyBleHRlbnNpb24gZGF0YSBmb3IgYm90aCBsaWIgYW5kIHVpDQogICAgZXh0X2RhdGFfbGlzdCA9IFtdDQoNCiAgICBmb3Igcm9vdF9kaXIgaW4gdXNlcl9jb25maWcuZ2V0X3RoaXJkcGFydHlfZXh0X3Jvb3RfZGlycygpOg0KICAgICAgICBleHRfZGF0YV9saXN0LmV4dGVuZCgNCiAgICAgICAgICAgIFt1aV9leHQgZm9yIHVpX2V4dCBpbiBwYXJzZV9kaXJfZm9yX2V4dF90eXBlKHJvb3RfZGlyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRXh0ZW5zaW9uKV0pDQogICAgICAgIGV4dF9kYXRhX2xpc3QuZXh0ZW5kKA0KICAgICAgICAgICAgW2xpYl9leHQgZm9yIGxpYl9leHQgaW4gcGFyc2VfZGlyX2Zvcl9leHRfdHlwZShyb290X2RpciwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlicmFyeUV4dGVuc2lvbildKQ0KDQogICAgcmV0dXJuIF9yZW1vdmVfZGlzYWJsZWRfZXh0ZW5zaW9ucyhleHRfZGF0YV9saXN0KQ0KDQoNCmRlZiBnZXRfaW5zdGFsbGVkX2xpYl9leHRlbnNpb25zKHJvb3RfZGlyKToNCiAgICAiIiJSZXR1cm5zIGFsbCB0aGUgaW5zdGFsbGVkIGFuZCBhY3RpdmUgTGlicmFyeSBleHRlbnNpb25zIChub3QgcGFyc2VkKS4NCg0KICAgIEFyZ3M6DQogICAgICAgIHJvb3RfZGlyIChzdHIpOiBFeHRlbnNpb25zIGRpcmVjdG9yeSBhZGRyZXNzDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtMaWJyYXJ5RXh0ZW5zaW9uXSk6IGxpc3Qgb2YgY29tcG9uZW50cy5MaWJyYXJ5RXh0ZW5zaW9uIG9iamVjdHMNCiAgICAiIiINCiAgICBsaWJfZXh0X2xpc3QgPSBcDQogICAgICAgIFtsaWJfZXh0IGZvciBsaWJfZXh0IGluIHBhcnNlX2Rpcl9mb3JfZXh0X3R5cGUocm9vdF9kaXIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlicmFyeUV4dGVuc2lvbildDQogICAgcmV0dXJuIF9yZW1vdmVfZGlzYWJsZWRfZXh0ZW5zaW9ucyhsaWJfZXh0X2xpc3QpDQoNCg0KZGVmIGdldF9pbnN0YWxsZWRfdWlfZXh0ZW5zaW9ucygpOg0KICAgICIiIlJldHVybnMgYWxsIFVJIGV4dGVuc2lvbnMgKGZ1bGx5IHBhcnNlZCkgdW5kZXIgdGhlIGdpdmVuIGRpcmVjdG9yeS4NCg0KICAgIFRoaXMgd2lsbCBhbHNvIHByb2Nlc3MgdGhlIExpYnJhcnkgZXh0ZW5zaW9ucyBhbmQgd2lsbCBhZGQNCiAgICB0aGVpciBwYXRoIHRvIHRoZSBzeXNwYXRoIG9mIHRoZSBVSSBleHRlbnNpb25zLg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGxpc3RbRXh0ZW5zaW9uXSk6IGxpc3Qgb2YgY29tcG9uZW50cy5FeHRlbnNpb24gb2JqZWN0cw0KICAgICIiIg0KICAgIHVpX2V4dF9saXN0ID0gW10NCiAgICBsaWJfZXh0X2xpc3QgPSBbXQ0KDQogICAgIyBnZXQgYSBsaXN0IG9mIGFsbCBkaXJlY3RvcmllcyB0aGF0IGNvdWxkIGluY2x1ZGUgZXh0ZW5zaW9ucw0KICAgIGV4dF9zZWFyY2hfZGlycyA9IHVzZXJfY29uZmlnLmdldF9leHRfcm9vdF9kaXJzKCkNCiAgICBtbG9nZ2VyLmRlYnVnKCdFeHRlbnNpb24gRGlyZWN0b3JpZXM6ICVzJywgZXh0X3NlYXJjaF9kaXJzKQ0KDQogICAgIyBjb2xsZWN0IGFsbCBsaWJyYXJ5IGV4dGVuc2lvbnMuIFRoZWlyIGRpciBwYXRocyBuZWVkIHRvIGJlIGFkZGVkDQogICAgIyB0byBzeXMucGF0aCBmb3IgYWxsIGNvbW1hbmRzDQogICAgZm9yIHJvb3RfZGlyIGluIGV4dF9zZWFyY2hfZGlyczoNCiAgICAgICAgbGliX2V4dF9saXN0LmV4dGVuZChnZXRfaW5zdGFsbGVkX2xpYl9leHRlbnNpb25zKHJvb3RfZGlyKSkNCiAgICAgICAgIyBHZXQgYSBsaXN0IG9mIGFsbCBpbnN0YWxsZWQgZXh0ZW5zaW9ucyBpbiB0aGlzIGRpcmVjdG9yeQ0KICAgICAgICAjIF9wYXJzZXIucGFyc2VfZGlyX2Zvcl9leHRfdHlwZSgpIHJldHVybnMgYSBsaXN0IG9mIGV4dGVuc2lvbnMNCiAgICAgICAgIyBpbiBnaXZlbiBkaXJlY3RvcnkNCg0KICAgIGZvciByb290X2RpciBpbiBleHRfc2VhcmNoX2RpcnM6DQogICAgICAgIGZvciBleHRfaW5mbyBpbiBwYXJzZV9kaXJfZm9yX2V4dF90eXBlKHJvb3RfZGlyLCBFeHRlbnNpb24pOg0KICAgICAgICAgICAgIyB0ZXN0IGlmIGNhY2hlIGlzIHZhbGlkIGZvciB0aGlzIHVpX2V4dGVuc2lvbg0KICAgICAgICAgICAgIyBpdCBtaWdodCBzZWVtIHVudXN1YWwgdG8gY3JlYXRlIGEgdWlfZXh0ZW5zaW9uIGFuZCB0aGVuDQogICAgICAgICAgICAjIHJlLWxvYWQgaXQgZnJvbSBjYWNoZSBidXQgbWluaW11bSBpbmZvcm1hdGlvbiBhYm91dCB0aGUNCiAgICAgICAgICAgICMgdWlfZXh0ZW5zaW9uIG5lZWRzIHRvIGJlIHBhc3NlZCB0byB0aGUgY2FjaGUgbW9kdWxlIGZvciBwcm9wZXINCiAgICAgICAgICAgICMgaGFzaCBjYWxjdWxhdGlvbiBhbmQgdWlfZXh0ZW5zaW9uIHJlY292ZXJ5LiBhdCB0aGlzIHBvaW50DQogICAgICAgICAgICAjIGB1aV9leHRlbnNpb25gIGRvZXMgbm90IGluY2x1ZGUgYW55IHN1Yi1jb21wb25lbnRzDQogICAgICAgICAgICAjIChlLmcsIHRhYnMsIHBhbmVscywgZXRjKSB1aV9leHRlbnNpb24gb2JqZWN0IGlzIHZlcnkgc21hbGwgYW5kDQogICAgICAgICAgICAjIGl0cyBjcmVhdGlvbiBkb2Vzbid0IGFkZCBtdWNoIG92ZXJoZWFkLg0KDQogICAgICAgICAgICBpZiBfaXNfZXh0ZW5zaW9uX2VuYWJsZWQoZXh0X2luZm8pOg0KICAgICAgICAgICAgICAgIHVpX2V4dGVuc2lvbiA9IF9wYXJzZV9vcl9jYWNoZShleHRfaW5mbykNCiAgICAgICAgICAgICAgICB1aV9leHRfbGlzdC5hcHBlbmQodWlfZXh0ZW5zaW9uKQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdTa2lwcGluZyBkaXNhYmxlZCB1aSBleHRlbnNpb246ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0X2luZm8ubmFtZSkNCg0KICAgICMgdXBkYXRlIGV4dGVuc2lvbiBtYXN0ZXIgc3lzcGF0aHMgd2l0aCBzdGFuZGFyZCBweXJldml0IGxpYiBwYXRocyBhbmQNCiAgICAjIGxpYiBhZGRyZXNzIG9mIG90aGVyIGxpYiBleHRlbnNpb25zICh0byBzdXBwb3J0IGV4dGVuc2lvbnMgdGhhdCBwcm92aWRlDQogICAgIyBsaWJyYXJ5IG9ubHkgdG8gYmUgdXNlZCBieSBvdGhlciBleHRlbnNpb25zKQ0KICAgICMgYWxsIG90aGVyIGxpYiBwYXRocyBpbnRlcm5hbCB0byB0aGUgZXh0ZW5zaW9uIGFuZCB0b29sIGJ1bmRsZXMgaGF2ZQ0KICAgICMgYWxyZWFkeSBiZWVuIHNldCBpbnNpZGUgdGhlIGV4dGVuc2lvbiBidW5kbGVzIGFuZCB3aWxsIHRha2UgcHJlY2VkZW5jZQ0KICAgICMgb3ZlciBwYXRocyBhZGRlZCBieSB0aGlzIG1ldGhvZCAodGhleSdyZSB0aGUgZmlyc3QgcGF0aHMgYWRkZWQgdG8gdGhlDQogICAgIyBzZWFyY2ggcGF0aHMgbGlzdCwgYW5kIHRoZXNlIHBhdGhzIHdpbGwgZm9sbG93KQ0KICAgIGZvciB1aV9leHRlbnNpb24gaW4gdWlfZXh0X2xpc3Q6DQogICAgICAgIF91cGRhdGVfZXh0ZW5zaW9uX3NlYXJjaF9wYXRocygNCiAgICAgICAgICAgIHVpX2V4dGVuc2lvbiwNCiAgICAgICAgICAgIGxpYl9leHRfbGlzdCwNCiAgICAgICAgICAgIFtNQUlOX0xJQl9ESVIsIE1JU0NfTElCX0RJUl0NCiAgICAgICAgICAgICkNCg0KICAgIHJldHVybiB1aV9leHRfbGlzdA0KDQoiIiJCYXNlIG1vZHVsZSB0byBoYW5kbGUgcHJvY2Vzc2luZyBleHRlbnNpb25zIGFzIHBhY2thZ2VzLiIiIg0KaW1wb3J0IG9zDQppbXBvcnQgb3MucGF0aCBhcyBvcA0KaW1wb3J0IGNvZGVjcw0KaW1wb3J0IGpzb24NCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IGRlZmF1bHRkaWN0DQoNCmZyb20gcHlyZXZpdCBpbXBvcnQgUHlSZXZpdEV4Y2VwdGlvbiwgSE9TVF9BUFANCmZyb20gcHlyZXZpdCBpbXBvcnQgbGFicw0KZnJvbSBweXJldml0LmNvbXBhdCBpbXBvcnQgc2FmZV9zdHJ0eXBlDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzLmxvZ2dlciBpbXBvcnQgZ2V0X2xvZ2dlcg0KZnJvbSBweXJldml0LmNvcmV1dGlscyBpbXBvcnQgZ2l0LCBmdWxseV9yZW1vdmVfZGlyDQpmcm9tIHB5cmV2aXQudXNlcmNvbmZpZyBpbXBvcnQgdXNlcl9jb25maWcNCg0KZnJvbSBweXJldml0IGltcG9ydCBleHRlbnNpb25zIGFzIGV4dHMNCg0KDQojcHlsaW50OiBkaXNhYmxlPVcwNzAzLEMwMzAyLEMwMTAzDQptbG9nZ2VyID0gZ2V0X2xvZ2dlcihfX25hbWVfXykNCg0KDQpjbGFzcyBQeVJldml0UGx1Z2luQWxyZWFkeUluc3RhbGxlZEV4Y2VwdGlvbihQeVJldml0RXhjZXB0aW9uKToNCiAgICAiIiJFeGNlcHRpb24gcmFpc2VkIHdoZW4gZXh0ZW5zaW9uIGlzIGFscmVhZHkgaW5zdGFsbGVkLiIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBleHRwa2cpOg0KICAgICAgICBzdXBlcihQeVJldml0UGx1Z2luQWxyZWFkeUluc3RhbGxlZEV4Y2VwdGlvbiwgc2VsZikuX19pbml0X18oKQ0KICAgICAgICBzZWxmLmV4dHBrZyA9IGV4dHBrZw0KICAgICAgICBQeVJldml0RXhjZXB0aW9uKHNlbGYpDQoNCg0KY2xhc3MgUHlSZXZpdFBsdWdpbk5vSW5zdGFsbExpbmtFeGNlcHRpb24oUHlSZXZpdEV4Y2VwdGlvbik6DQogICAgIiIiRXhjZXB0aW9uIHJhaXNlZCB3aGVuIGV4dGVuc2lvbiBkb2VzIG5vdCBoYXZlIGFuIGluc3RhbGwgbGluay4iIiINCiAgICBwYXNzDQoNCg0KY2xhc3MgUHlSZXZpdFBsdWdpblJlbW92ZUV4Y2VwdGlvbihQeVJldml0RXhjZXB0aW9uKToNCiAgICAiIiJFeGNlcHRpb24gcmFpc2VkIHdoZW4gcmVtb3ZpbmcgYW4gZXh0ZW5zaW9uLiIiIg0KICAgIHBhc3MNCg0KDQpQTFVHSU5fRVhUX0RFRl9NQU5JRkVTVF9OQU1FID0gJ2V4dGVuc2lvbnMnDQpQTFVHSU5fRVhUX0RFRl9GSUxFID0gUExVR0lOX0VYVF9ERUZfTUFOSUZFU1RfTkFNRSArIGV4dHMuSlNPTl9GSUxFX0ZPUk1BVA0KDQpFWFRFTlNJT05fUE9TVEZJWEVTID0gW3guUE9TVEZJWCBmb3IgeCBpbiBleHRzLkV4dGVuc2lvblR5cGVzLmdldF9leHRfdHlwZXMoKV0NCg0KDQpjbGFzcyBEZXBlbmRlbmN5R3JhcGg6DQogICAgIiIiRXh0ZW5zaW9uIHBhY2thZ2VzIGRlcGVuZGVuY3kgZ3JhcGguIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGV4dHBrZ19saXN0KToNCiAgICAgICAgc2VsZi5kZXBfZGljdCA9IGRlZmF1bHRkaWN0KGxpc3QpDQogICAgICAgIHNlbGYuZXh0cGtncyA9IGV4dHBrZ19saXN0DQogICAgICAgIGZvciBleHRwa2cgaW4gZXh0cGtnX2xpc3Q6DQogICAgICAgICAgICBpZiBleHRwa2cuZGVwZW5kZW5jaWVzOg0KICAgICAgICAgICAgICAgIGZvciBkZXBfcGtnX25hbWUgaW4gZXh0cGtnLmRlcGVuZGVuY2llczoNCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kZXBfZGljdFtkZXBfcGtnX25hbWVdLmFwcGVuZChleHRwa2cpDQoNCiAgICBkZWYgaGFzX2luc3RhbGxlZF9kZXBlbmRlbnRzKHNlbGYsIGV4dHBrZ19uYW1lKToNCiAgICAgICAgaWYgZXh0cGtnX25hbWUgaW4gc2VsZi5kZXBfZGljdDoNCiAgICAgICAgICAgIGZvciBkZXBfcGtnIGluIHNlbGYuZGVwX2RpY3RbZXh0cGtnX25hbWVdOg0KICAgICAgICAgICAgICAgIGlmIGRlcF9wa2cuaXNfaW5zdGFsbGVkOg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIEZhbHNlDQoNCg0KY2xhc3MgRXh0ZW5zaW9uUGFja2FnZToNCiAgICAiIiJFeHRlbnNpb24gcGFja2FnZSBjbGFzcy4NCg0KICAgIFRoaXMgY2xhc3MgY29udGFpbnMgdGhlIGV4dGVuc2lvbiBpbmZvcm1hdGlvbiBhbmQgYWxzbyBtYW5hZ2VzIGluc3RhbGxhdGlvbiwNCiAgICB1c2VyIGNvbmZpZ3VyYXRpb24sIGFuZCByZW1vdmFsIG9mIHRoZSBleHRlbnNpb24uDQogICAgU2VlIHRoZSBgYF9faW5pdF9fYGAgY2xhc3MgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIHJlcXVpcmVkIGFuZA0KICAgIG9wdGlvbmFsIGV4dGVuc2lvbiBpbmZvcm1hdGlvbi4NCg0KICAgIEF0dHJpYnV0ZXM6DQogICAgICAgIHR5cGUgKGV4dGVuc2lvbnMuRXh0ZW5zaW9uVHlwZXMpOiBFeHRlbnNpb24gdHlwZQ0KICAgICAgICBuYW1lIChzdHIpOiBFeHRlbnNpb24gbmFtZQ0KICAgICAgICBkZXNjcmlwdGlvbiAoc3RyKTogRXh0ZW5zaW9uIGRlc2NyaXB0aW9uDQogICAgICAgIHVybCAoc3RyKTogVXJsIG9mIG9ubGluZSBnaXQgcmVwb3NpdG9yeQ0KICAgICAgICB3ZWJzaXRlIChzdHIpOiBVcmwgb2YgZXh0ZW5zaW9uIHdlYnNpdGUNCiAgICAgICAgaW1hZ2UgKHN0cik6IFVybCBvZiBleHRlbnNpb24gaWNvbiBpbWFnZSAoLnBuZyBmaWxlKQ0KICAgICAgICBhdXRob3IgKHN0cik6IE5hbWUgb2YgZXh0ZW5zaW9uIGF1dGhvcg0KICAgICAgICBhdXRob3JfcHJvZmlsZSAoc3RyKTogVXJsIG9mIGF1dGhvciBwcm9maWxlDQogICAgIiIiDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgaW5mb19kaWN0LCBkZWZfZmlsZV9wYXRoPU5vbmUpOg0KICAgICAgICAiIiJJbml0aWFsaXplZCB0aGUgZXh0ZW5zaW9uIGNsYXNzIGJhc2VkIG9uIHByb3ZpZGUgaW5mb3JtYXRpb24uDQoNCiAgICAgICAgUmVxdWlyZWQgaW5mbyAoRGljdGlvbmFyeSBrZXlzKToNCiAgICAgICAgICAgIHR5cGUsIG5hbWUsIGRlc2NyaXB0aW9uLCB1cmwNCg0KICAgICAgICBPcHRpb25hbCBpbmZvOg0KICAgICAgICAgICAgd2Vic2l0ZSwgaW1hZ2UsIGF1dGhvciwgYXV0aG9yLXVybCwgYXV0aHVzZXJzDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIGluZm9fZGljdCAoZGljdCk6IEEgZGljdGlvbmFyeSBjb250YWluaW5nIHRoZSByZXF1aXJlZCBpbmZvcm1hdGlvbg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGluaXRpYWxpemluZyB0aGUgZXh0ZW5zaW9uLg0KICAgICAgICAgICAgZGVmX2ZpbGVfcGF0aCAoc3RyKTogVGhlIGZpbGUgcGF0aCBvZiB0aGUgZXh0ZW5zaW9uIGRlZmluaXRpb24gZmlsZQ0KICAgICAgICAiIiINCiAgICAgICAgc2VsZi50eXBlID0gZXh0cy5FeHRlbnNpb25UeXBlcy5VSV9FWFRFTlNJT04NCiAgICAgICAgc2VsZi5idWlsdGluID0gRmFsc2UNCiAgICAgICAgc2VsZi5kZWZhdWx0X2VuYWJsZWQgPSBUcnVlDQogICAgICAgIHNlbGYubmFtZSA9IE5vbmUNCiAgICAgICAgc2VsZi5kZXNjcmlwdGlvbiA9IE5vbmUNCiAgICAgICAgc2VsZi51cmwgPSBOb25lDQogICAgICAgIHNlbGYuZGVmX2ZpbGVfcGF0aCA9IHNldCgpDQogICAgICAgIHNlbGYuYXV0aHVzZXJzID0gc2V0KCkNCiAgICAgICAgc2VsZi5hdXRoZ3JvdXBzID0gc2V0KCkNCiAgICAgICAgc2VsZi5yb2NrZXRfbW9kZV9jb21wYXRpYmxlID0gRmFsc2UNCiAgICAgICAgc2VsZi53ZWJzaXRlID0gTm9uZQ0KICAgICAgICBzZWxmLmltYWdlID0gTm9uZQ0KICAgICAgICBzZWxmLmF1dGhvciA9IE5vbmUNCiAgICAgICAgc2VsZi5hdXRob3JfcHJvZmlsZSA9IE5vbmUNCiAgICAgICAgc2VsZi5kZXBlbmRlbmNpZXMgPSBzZXQoKQ0KDQogICAgICAgIHNlbGYudXBkYXRlX2luZm8oaW5mb19kaWN0LCBkZWZfZmlsZV9wYXRoPWRlZl9maWxlX3BhdGgpDQoNCiAgICBkZWYgdXBkYXRlX2luZm8oc2VsZiwgaW5mb19kaWN0LCBkZWZfZmlsZV9wYXRoPU5vbmUpOg0KICAgICAgICBleHRfZGVmX3R5cGUgPSBpbmZvX2RpY3QuZ2V0KCd0eXBlJywgTm9uZSkNCiAgICAgICAgZm9yIGV4dF90eXBlIGluIGV4dHMuRXh0ZW5zaW9uVHlwZXMuZ2V0X2V4dF90eXBlcygpOg0KICAgICAgICAgICAgaWYgZXh0X2RlZl90eXBlID09IGV4dF90eXBlLklEOg0KICAgICAgICAgICAgICAgIHNlbGYudHlwZSA9IGV4dF90eXBlDQoNCiAgICAgICAgc2VsZi5idWlsdGluID0gXA0KICAgICAgICAgICAgc2FmZV9zdHJ0eXBlKGluZm9fZGljdC5nZXQoJ2J1aWx0aW4nLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5idWlsdGluKSkubG93ZXIoKSA9PSAndHJ1ZScNCg0KICAgICAgICBzZWxmLmRlZmF1bHRfZW5hYmxlZCA9IHNhZmVfc3RydHlwZSgNCiAgICAgICAgICAgIGluZm9fZGljdC5nZXQoJ2RlZmF1bHRfZW5hYmxlZCcsIHNlbGYuZGVmYXVsdF9lbmFibGVkKQ0KICAgICAgICAgICAgKS5sb3dlcigpID09ICd0cnVlJw0KDQogICAgICAgIHNlbGYubmFtZSA9IGluZm9fZGljdC5nZXQoJ25hbWUnLCBzZWxmLm5hbWUpDQogICAgICAgIHNlbGYuZGVzY3JpcHRpb24gPSBpbmZvX2RpY3QuZ2V0KCdkZXNjcmlwdGlvbicsIHNlbGYuZGVzY3JpcHRpb24pDQogICAgICAgIHNlbGYudXJsID0gaW5mb19kaWN0LmdldCgndXJsJywgc2VsZi51cmwpDQoNCiAgICAgICAgaWYgZGVmX2ZpbGVfcGF0aDoNCiAgICAgICAgICAgIHNlbGYuZGVmX2ZpbGVfcGF0aC5hZGQoZGVmX2ZpbGVfcGF0aCkNCg0KICAgICAgICAjIHVwZGF0ZSBsaXN0IG9mIGF1dGhvcml6ZWQgdXNlcnMNCiAgICAgICAgYXV0aHVzZXJzID0gaW5mb19kaWN0LmdldCgnYXV0aHVzZXJzJywgW10pDQogICAgICAgIGlmIGF1dGh1c2VyczoNCiAgICAgICAgICAgIHNlbGYuYXV0aHVzZXJzLnVwZGF0ZShhdXRodXNlcnMpDQoNCiAgICAgICAgIyB1cGRhdGUgbGlzdCBvZiBhdXRob3JpemVkIHVzZXIgZ3JvdXBzDQogICAgICAgIGF1dGhncm91cHMgPSBpbmZvX2RpY3QuZ2V0KCdhdXRoZ3JvdXBzJywgW10pDQogICAgICAgIGlmIGF1dGhncm91cHM6DQogICAgICAgICAgICBzZWxmLmF1dGhncm91cHMudXBkYXRlKGF1dGhncm91cHMpDQoNCiAgICAgICAgIyByb2NrZXQgbW9kZSBjb21wYXRpYmlsaXR5DQogICAgICAgIHNlbGYucm9ja2V0X21vZGVfY29tcGF0aWJsZSA9IFwNCiAgICAgICAgICAgIHNhZmVfc3RydHlwZSgNCiAgICAgICAgICAgICAgICBpbmZvX2RpY3QuZ2V0KCdyb2NrZXRfbW9kZV9jb21wYXRpYmxlJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucm9ja2V0X21vZGVfY29tcGF0aWJsZSkNCiAgICAgICAgICAgICAgICApLmxvd2VyKCkgPT0gJ3RydWUnDQoNCiAgICAgICAgIyBleHRlbmRlZCBhdHRyaWJ1dGVzDQogICAgICAgIHNlbGYud2Vic2l0ZSA9IGluZm9fZGljdC5nZXQoDQogICAgICAgICAgICAnd2Vic2l0ZScsDQogICAgICAgICAgICBzZWxmLnVybC5yZXBsYWNlKCcuZ2l0JywgJycpIGlmIHNlbGYudXJsIGVsc2Ugc2VsZi53ZWJzaXRlDQogICAgICAgICAgICApDQogICAgICAgIHNlbGYuaW1hZ2UgPSBpbmZvX2RpY3QuZ2V0KCdpbWFnZScsIHNlbGYuaW1hZ2UpDQogICAgICAgIHNlbGYuYXV0aG9yID0gaW5mb19kaWN0LmdldCgnYXV0aG9yJywgc2VsZi5hdXRob3IpDQoNCiAgICAgICAgc2VsZi5hdXRob3JfcHJvZmlsZSA9IGluZm9fZGljdC5nZXQoJ2F1dGhvcl9wcm9maWxlJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hdXRob3JfcHJvZmlsZSkNCiAgICAgICAgIyB1cGRhdGUgbGlzdCBkZXBlbmRlbmNpZXMNCiAgICAgICAgZGVwZW5kcyA9IGluZm9fZGljdC5nZXQoJ2RlcGVuZGVuY2llcycsIFtdKQ0KICAgICAgICBpZiBkZXBlbmRzOg0KICAgICAgICAgICAgc2VsZi5kZXBlbmRlbmNpZXMudXBkYXRlKGRlcGVuZHMpDQoNCiAgICBkZWYgaXNfdmFsaWQoc2VsZik6DQogICAgICAgIHJldHVybiBzZWxmLm5hbWUgaXMgbm90IE5vbmUgYW5kIHNlbGYudXJsIGlzIG5vdCBOb25lDQoNCiAgICBkZWYgX19yZXByX18oc2VsZik6DQogICAgICAgIHJldHVybiAnPEV4dGVuc2lvblBhY2thZ2Ugb2JqZWN0LiBuYW1lOlwne31cJyB1cmw6XCd7fVwnIGF1dGg6e30+J1wNCiAgICAgICAgICAgIC5mb3JtYXQoc2VsZi5uYW1lLCBzZWxmLnVybCwgc2VsZi5hdXRodXNlcnMpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgZXh0X2Rpcm5hbWUoc2VsZik6DQogICAgICAgICIiIkluc3RhbGxhdGlvbiBkaXJlY3RvcnkgbmFtZSB0byB1c2UuDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChzdHIpOiBUaGUgbmFtZSB0aGF0IHNob3VsZCBiZSB1c2VkIGZvciB0aGUgaW5zdGFsbGF0aW9uIGRpcmVjdG9yeQ0KICAgICAgICAgICAgICAgIChiYXNlZCBvbiB0aGUgZXh0ZW5zaW9uIHR5cGUpLg0KICAgICAgICAiIiINCiAgICAgICAgcmV0dXJuIHNlbGYubmFtZSArIHNlbGYudHlwZS5QT1NURklYDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgaXNfaW5zdGFsbGVkKHNlbGYpOg0KICAgICAgICAiIiJJbnN0YWxsYXRpb24gZGlyZWN0b3J5Lg0KDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICAoc3RyKTogSW5zdGFsbGVkIGRpcmVjdG9yeSBwYXRoIG9yIGVtcHR5IHN0cmluZyBpZiBub3QgaW5zdGFsbGVkLg0KICAgICAgICAiIiINCiAgICAgICAgZm9yIGV4dF9kaXIgaW4gdXNlcl9jb25maWcuZ2V0X2V4dF9yb290X2RpcnMoKToNCiAgICAgICAgICAgIGlmIG9wLmV4aXN0cyhleHRfZGlyKToNCiAgICAgICAgICAgICAgICBmb3Igc3ViX2RpciBpbiBvcy5saXN0ZGlyKGV4dF9kaXIpOg0KICAgICAgICAgICAgICAgICAgICBpZiBvcC5pc2RpcihvcC5qb2luKGV4dF9kaXIsIHN1Yl9kaXIpKVwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmQgc3ViX2RpciA9PSBzZWxmLmV4dF9kaXJuYW1lOg0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wLmpvaW4oZXh0X2Rpciwgc3ViX2RpcikNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgbWxvZ2dlci5lcnJvcignY3VzdG9tIEV4dGVuc2lvbiBwYXRoIGRvZXMgbm90IGV4aXN0OiAlcycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHRfZGlyKQ0KDQogICAgICAgIHJldHVybiAnJw0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGluc3RhbGxlZF9kaXIoc2VsZik6DQogICAgICAgICIiIkluc3RhbGxhdGlvbiBkaXJlY3RvcnkuDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChzdHIpOiBJbnN0YWxsZWQgZGlyZWN0b3J5IHBhdGggb3IgZW1wdHkgc3RyaW5nIGlmIG5vdCBpbnN0YWxsZWQuDQogICAgICAgICIiIg0KICAgICAgICByZXR1cm4gc2VsZi5pc19pbnN0YWxsZWQNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBpc19yZW1vdmFibGUoc2VsZik6DQogICAgICAgICIiIldoZXRoZXIgdGhlIGV4dGVuc2lvbiBpcyBzYWZlIHRvIHJlbW92ZS4NCg0KICAgICAgICBDaGVja3Mgd2hldGhlciBpdCBpcyBzYWZlIHRvIHJlbW92ZSB0aGlzIGV4dGVuc2lvbiBieSBjb25maXJtaW5nIGlmDQogICAgICAgIGEgZ2l0IHVybCBpcyBwcm92aWRlZCBmb3IgdGhpcyBleHRlbnNpb24gZm9yIGxhdGVyIHJlLWluc3RhbGwuDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChib29sKTogVHJ1ZSBpZiByZW1vdmFibGUsIEZhbHNlIGlmIG5vdA0KICAgICAgICAiIiINCiAgICAgICAgcmV0dXJuIFRydWUgaWYgc2VsZi51cmwgZWxzZSBGYWxzZQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHZlcnNpb24oc2VsZik6DQogICAgICAgICIiIkV4dGVuc2lvbiB2ZXJzaW9uLg0KDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICAoc3RyKTogTGFzdCBjb21taXQgaGFzaCBvZiB0aGUgZXh0ZW5zaW9uIGdpdCByZXBvLg0KICAgICAgICAiIiINCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgaWYgc2VsZi5pc19pbnN0YWxsZWQ6DQogICAgICAgICAgICAgICAgZXh0cGtnX3JlcG8gPSBnaXQuZ2V0X3JlcG8oc2VsZi5pbnN0YWxsZWRfZGlyKQ0KICAgICAgICAgICAgICAgIHJldHVybiBleHRwa2dfcmVwby5sYXN0X2NvbW1pdF9oYXNoDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGNvbmZpZyhzZWxmKToNCiAgICAgICAgIiIiUmV0dXJucyBhIHZhbGlkIGNvbmZpZyBtYW5hZ2VyIGZvciB0aGlzIGV4dGVuc2lvbi4NCg0KICAgICAgICBBbGwgY29uZmlnIHBhcmFtZXRlcnMgd2lsbCBiZSBzYXZlZCBpbiB1c2VyIGNvbmZpZyBmaWxlLg0KDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICAocHlyZXZpdC5jb3JldXRpbHMuY29uZmlncGFyc2VyLlB5UmV2aXRDb25maWdTZWN0aW9uUGFyc2VyKToNCiAgICAgICAgICAgICAgICBDb25maWcgc2VjdGlvbiBoYW5kbGVyDQogICAgICAgICIiIg0KICAgICAgICB0cnk6DQogICAgICAgICAgICByZXR1cm4gdXNlcl9jb25maWcuZ2V0X3NlY3Rpb24oc2VsZi5leHRfZGlybmFtZSkNCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoNCiAgICAgICAgICAgIGNmZ19zZWN0aW9uID0gdXNlcl9jb25maWcuYWRkX3NlY3Rpb24oc2VsZi5leHRfZGlybmFtZSkNCiAgICAgICAgICAgIHNlbGYuY29uZmlnLmRpc2FibGVkID0gbm90IHNlbGYuZGVmYXVsdF9lbmFibGVkDQogICAgICAgICAgICBzZWxmLmNvbmZpZy5wcml2YXRlX3JlcG8gPSBzZWxmLmJ1aWx0aW4NCiAgICAgICAgICAgIHNlbGYuY29uZmlnLnVzZXJuYW1lID0gc2VsZi5jb25maWcucGFzc3dvcmQgPSAnJw0KICAgICAgICAgICAgdXNlcl9jb25maWcuc2F2ZV9jaGFuZ2VzKCkNCiAgICAgICAgICAgIHJldHVybiBjZmdfc2VjdGlvbg0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGlzX2VuYWJsZWQoc2VsZik6DQogICAgICAgICIiIkNoZWNrcyB0aGUgZGVmYXVsdCBhbmQgdXNlciBjb25maWd1cmVkIGxvYWQgc3RhdGUgb2YgdGhlIGV4dGVuc2lvbi4NCg0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgKGJvb2wpOiBUcnVlIGlmIHBhY2thZ2Ugc2hvdWxkIGJlIGxvYWRlZA0KICAgICAgICAiIiINCiAgICAgICAgcmV0dXJuIG5vdCBzZWxmLmNvbmZpZy5kaXNhYmxlZA0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHVzZXJfaGFzX2FjY2VzcyhzZWxmKToNCiAgICAgICAgIiIiQ2hlY2tzIHdoZXRoZXIgY3VycmVudCB1c2VyIGhhcyBhY2Nlc3MgdG8gdGhpcyBleHRlbnNpb24uDQoNCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIChib29sKTogVHJ1ZSBpcyBjdXJyZW50IHVzZXIgaGFzIGFjY2Vzcw0KICAgICAgICAiIiINCiAgICAgICAgaWYgc2VsZi5hdXRodXNlcnM6DQogICAgICAgICAgICByZXR1cm4gSE9TVF9BUFAudXNlcm5hbWUgaW4gc2VsZi5hdXRodXNlcnMNCiAgICAgICAgZWxpZiBzZWxmLmF1dGhncm91cHM6DQogICAgICAgICAgICBmb3IgYXV0aGdyb3VwIGluIHNlbGYuYXV0aGdyb3VwczoNCiAgICAgICAgICAgICAgICBpZiBsYWJzLkNvbW1vbi5TZWN1cml0eS5Vc2VyQXV0aC5cDQogICAgICAgICAgICAgICAgICAgICAgICBVc2VySXNJblNlY3VyaXR5R3JvdXAoYXV0aGdyb3VwKToNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBUcnVlDQoNCiAgICBkZWYgcmVtb3ZlX3BrZ19jb25maWcoc2VsZik6DQogICAgICAgICIiIlJlbW92ZXMgdGhlIGluc3RhbGxlZCBleHRlbnNpb24gY29uZmlndXJhdGlvbi4iIiINCiAgICAgICAgdXNlcl9jb25maWcucmVtb3ZlX3NlY3Rpb24oc2VsZi5leHRfZGlybmFtZSkNCiAgICAgICAgdXNlcl9jb25maWcuc2F2ZV9jaGFuZ2VzKCkNCg0KICAgIGRlZiBkaXNhYmxlX3BhY2thZ2Uoc2VsZik6DQogICAgICAgICIiIkRpc2FibGVzIHBhY2thZ2UgaW4gcHlSZXZpdCBjb25maWd1cmF0aW9uLg0KDQogICAgICAgIEl0IHdvbid0IGJlIGxvYWRlZCBpbiB0aGUgbmV4dCBzZXNzaW9uLg0KICAgICAgICAiIiINCiAgICAgICAgc2VsZi5jb25maWcuZGlzYWJsZWQgPSBUcnVlDQogICAgICAgIHVzZXJfY29uZmlnLnNhdmVfY2hhbmdlcygpDQoNCiAgICBkZWYgdG9nZ2xlX3BhY2thZ2Uoc2VsZik6DQogICAgICAgICIiIkRpc2FibGVzL0VuYWJsZXMgcGFja2FnZSBpbiBweVJldml0IGNvbmZpZ3VyYXRpb24uDQoNCiAgICAgICAgQSBkaXNhYmxlZCBwYWNrYWdlIHdvbid0IGJlIGxvYWRlZCBpbiB0aGUgbmV4dCBzZXNzaW9uLg0KICAgICAgICAiIiINCiAgICAgICAgc2VsZi5jb25maWcuZGlzYWJsZWQgPSBub3Qgc2VsZi5jb25maWcuZGlzYWJsZWQNCiAgICAgICAgdXNlcl9jb25maWcuc2F2ZV9jaGFuZ2VzKCkNCg0KDQpkZWYgX3VwZGF0ZV9leHRwa2dzKGV4dF9kZWZfZmlsZSwgbG9hZGVkX3BrZ3MpOg0KICAgIHdpdGggY29kZWNzLm9wZW4oZXh0X2RlZl9maWxlLCAncicsICd1dGYtOCcpIGFzIGV4dHBrZ19kZWZfZmlsZToNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgZXh0cGtnX2RpY3QgPSBqc29uLmxvYWQoZXh0cGtnX2RlZl9maWxlKQ0KICAgICAgICAgICAgZGVmaW5lZF9leHRzX3BrZ3MgPSBbZXh0cGtnX2RpY3RdDQogICAgICAgICAgICBpZiBQTFVHSU5fRVhUX0RFRl9NQU5JRkVTVF9OQU1FIGluIGV4dHBrZ19kaWN0LmtleXMoKToNCiAgICAgICAgICAgICAgICBkZWZpbmVkX2V4dHNfcGtncyA9IFwNCiAgICAgICAgICAgICAgICAgICAgZXh0cGtnX2RpY3RbUExVR0lOX0VYVF9ERUZfTUFOSUZFU1RfTkFNRV0NCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBkZWZfZmlsZV9lcnI6DQogICAgICAgICAgICBwcmludCgnQ2FuIG5vdCBwYXJzZSBwbHVnaW4gZXh0IGRlZmluaXRpb24gZmlsZToge30gJw0KICAgICAgICAgICAgICAgICAgJ3wge30nLmZvcm1hdChleHRfZGVmX2ZpbGUsIGRlZl9maWxlX2VycikpDQogICAgICAgICAgICByZXR1cm4NCg0KICAgIGZvciBleHRwa2dfZGVmIGluIGRlZmluZWRfZXh0c19wa2dzOg0KICAgICAgICBleHRwa2cgPSBFeHRlbnNpb25QYWNrYWdlKGV4dHBrZ19kZWYsIGV4dF9kZWZfZmlsZSkNCiAgICAgICAgbWF0Y2hlZF9wa2cgPSBOb25lDQogICAgICAgIGZvciBsb2FkZWRfcGtnIGluIGxvYWRlZF9wa2dzOg0KICAgICAgICAgICAgaWYgbG9hZGVkX3BrZy5uYW1lID09IGV4dHBrZy5uYW1lOg0KICAgICAgICAgICAgICAgIG1hdGNoZWRfcGtnID0gbG9hZGVkX3BrZw0KICAgICAgICAgICAgICAgIGJyZWFrDQogICAgICAgIGlmIG1hdGNoZWRfcGtnOg0KICAgICAgICAgICAgbWF0Y2hlZF9wa2cudXBkYXRlX2luZm8oZXh0cGtnX2RlZikNCiAgICAgICAgZWxpZiBleHRwa2cuaXNfdmFsaWQoKToNCiAgICAgICAgICAgIGxvYWRlZF9wa2dzLmFwcGVuZChleHRwa2cpDQoNCg0KZGVmIF9pbnN0YWxsX2V4dHBrZyhleHRwa2csIGluc3RhbGxfZGlyLCBpbnN0YWxsX2RlcGVuZGVuY2llcz1UcnVlKToNCiAgICBpc19pbnN0YWxsZWRfcGF0aCA9IGV4dHBrZy5pc19pbnN0YWxsZWQNCiAgICBpZiBpc19pbnN0YWxsZWRfcGF0aDoNCiAgICAgICAgcmFpc2UgUHlSZXZpdFBsdWdpbkFscmVhZHlJbnN0YWxsZWRFeGNlcHRpb24oZXh0cGtnKQ0KDQogICAgIyBpZiBwYWNrYWdlIGlzIGluc3RhbGxhYmxlDQogICAgaWYgZXh0cGtnLnVybDoNCiAgICAgICAgY2xvbmVfcGF0aCA9IG9wLmpvaW4oaW5zdGFsbF9kaXIsIGV4dHBrZy5leHRfZGlybmFtZSkNCiAgICAgICAgbWxvZ2dlci5pbmZvKCdJbnN0YWxsaW5nICVzIHRvICVzJywgZXh0cGtnLm5hbWUsIGNsb25lX3BhdGgpDQoNCiAgICAgICAgaWYgZXh0cGtnLmNvbmZpZy51c2VybmFtZSBhbmQgZXh0cGtnLmNvbmZpZy5wYXNzd29yZDoNCiAgICAgICAgICAgIGdpdC5naXRfY2xvbmUoZXh0cGtnLnVybCwgY2xvbmVfcGF0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU9ZXh0cGtnLmNvbmZpZy51c2VybmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ9ZXh0cGtnLmNvbmZpZy5wYXNzd29yZCkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIGdpdC5naXRfY2xvbmUoZXh0cGtnLnVybCwgY2xvbmVfcGF0aCkNCiAgICAgICAgbWxvZ2dlci5pbmZvKCdFeHRlbnNpb24gc3VjY2Vzc2Z1bGx5IGluc3RhbGxlZCA6dGh1bWJzX3VwOicpDQogICAgZWxzZToNCiAgICAgICAgcmFpc2UgUHlSZXZpdFBsdWdpbk5vSW5zdGFsbExpbmtFeGNlcHRpb24oKQ0KDQogICAgaWYgaW5zdGFsbF9kZXBlbmRlbmNpZXM6DQogICAgICAgIGlmIGV4dHBrZy5kZXBlbmRlbmNpZXM6DQogICAgICAgICAgICBtbG9nZ2VyLmluZm8oJ0luc3RhbGxpbmcgZGVwZW5kZW5jaWVzIGZvciAlcycsIGV4dHBrZy5uYW1lKQ0KICAgICAgICAgICAgZm9yIGRlcF9wa2dfbmFtZSBpbiBleHRwa2cuZGVwZW5kZW5jaWVzOg0KICAgICAgICAgICAgICAgIGRlcF9wa2cgPSBnZXRfZXh0X3BhY2thZ2VfYnlfbmFtZShkZXBfcGtnX25hbWUpDQogICAgICAgICAgICAgICAgaWYgZGVwX3BrZzoNCiAgICAgICAgICAgICAgICAgICAgX2luc3RhbGxfZXh0cGtnKGRlcF9wa2csDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFsbF9kaXIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFsbF9kZXBlbmRlbmNpZXM9VHJ1ZSkNCg0KDQpkZWYgX3JlbW92ZV9leHRwa2coZXh0cGtnLCByZW1vdmVfZGVwZW5kZW5jaWVzPVRydWUpOg0KICAgIGlmIGV4dHBrZy5pc19yZW1vdmFibGU6DQogICAgICAgIGRpcl90b19yZW1vdmUgPSBleHRwa2cuaXNfaW5zdGFsbGVkDQogICAgICAgIGlmIGRpcl90b19yZW1vdmU6DQogICAgICAgICAgICBmdWxseV9yZW1vdmVfZGlyKGRpcl90b19yZW1vdmUpDQogICAgICAgICAgICBleHRwa2cucmVtb3ZlX3BrZ19jb25maWcoKQ0KICAgICAgICAgICAgbWxvZ2dlci5pbmZvKCdTdWNjZXNzZnVsbHkgcmVtb3ZlZCBleHRlbnNpb24gZnJvbTogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgIGRpcl90b19yZW1vdmUpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByYWlzZSBQeVJldml0UGx1Z2luUmVtb3ZlRXhjZXB0aW9uKCdDYW4gbm90IGZpbmQgaW5zdGFsbGVkIHBhdGguJykNCiAgICBlbHNlOg0KICAgICAgICByYWlzZSBQeVJldml0UGx1Z2luUmVtb3ZlRXhjZXB0aW9uKCdFeHRlbnNpb24gZG9lcyBub3QgaGF2ZSB1cmwgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhbmQgY2FuIG5vdCBiZSBpbnN0YWxsZWQgbGF0ZXIuJykNCg0KICAgIGlmIHJlbW92ZV9kZXBlbmRlbmNpZXM6DQogICAgICAgIGRnID0gZ2V0X2RlcGVuZGVuY3lfZ3JhcGgoKQ0KICAgICAgICBtbG9nZ2VyLmluZm8oJ1JlbW92aW5nIGRlcGVuZGVuY2llcyBmb3IgJXMnLCBleHRwa2cubmFtZSkNCiAgICAgICAgZm9yIGRlcF9wa2dfbmFtZSBpbiBleHRwa2cuZGVwZW5kZW5jaWVzOg0KICAgICAgICAgICAgZGVwX3BrZyA9IGdldF9leHRfcGFja2FnZV9ieV9uYW1lKGRlcF9wa2dfbmFtZSkNCiAgICAgICAgICAgIGlmIGRlcF9wa2cgYW5kIG5vdCBkZy5oYXNfaW5zdGFsbGVkX2RlcGVuZGVudHMoZGVwX3BrZ19uYW1lKToNCiAgICAgICAgICAgICAgICBfcmVtb3ZlX2V4dHBrZyhkZXBfcGtnLCByZW1vdmVfZGVwZW5kZW5jaWVzPVRydWUpDQoNCg0KZGVmIF9maW5kX2ludGVybmFsX2V4dHBrZ3MoZXh0X2Rpcik6DQogICAgaW50ZXJuYWxfZXh0cGtnX2RlZl9maWxlcyA9IFtdDQogICAgbWxvZ2dlci5kZWJ1ZygnTG9va2luZyBmb3IgaW50ZXJuYWwgcGFja2FnZSBkZWZzIHVuZGVyICVzJywgZXh0X2RpcikNCiAgICBmb3Igc3ViZm9sZGVyIGluIG9zLmxpc3RkaXIoZXh0X2Rpcik6DQogICAgICAgIGlmIGFueShbc3ViZm9sZGVyLmVuZHN3aXRoKHgpIGZvciB4IGluIEVYVEVOU0lPTl9QT1NURklYRVNdKToNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0ZvdW5kIGV4dGVuc2lvbiBmb2xkZXIgJXMnLCBzdWJmb2xkZXIpDQogICAgICAgICAgICBpbnRfZXh0cGtnX2RlZmZpbGUgPSBcDQogICAgICAgICAgICAgICAgb3Auam9pbihleHRfZGlyLCBzdWJmb2xkZXIsIGV4dHMuRVhUX01BTklGRVNUX0ZJTEUpDQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdMb29raW5nIGZvciAlcycsIGludF9leHRwa2dfZGVmZmlsZSkNCiAgICAgICAgICAgIGlmIG9wLmV4aXN0cyhpbnRfZXh0cGtnX2RlZmZpbGUpOg0KICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0ZvdW5kICVzJywgaW50X2V4dHBrZ19kZWZmaWxlKQ0KICAgICAgICAgICAgICAgIGludGVybmFsX2V4dHBrZ19kZWZfZmlsZXMuYXBwZW5kKGludF9leHRwa2dfZGVmZmlsZSkNCiAgICByZXR1cm4gaW50ZXJuYWxfZXh0cGtnX2RlZl9maWxlcw0KDQoNCmRlZiBnZXRfZXh0X3BhY2thZ2VzKGF1dGhvcml6ZWRfb25seT1UcnVlKToNCiAgICAiIiJSZXR1cm5zIHRoZSByZWdpc3RlcmVkIHBsdWdpbiBleHRlbnNpb25zIHBhY2thZ2VzLg0KDQogICAgUmVhZHMgdGhlIGxpc3Qgb2YgcmVnaXN0ZXJlZCBwbHVnLWluIGV4dGVuc2lvbnMgYW5kIHJldHVybnMgYSBsaXN0IG9mDQogICAgRXh0ZW5zaW9uUGFja2FnZSBjbGFzc2VzIHdoaWNoIGNvbnRhaW4gaW5mb3JtYXRpb24gb24gdGhlIHBsdWctaW4gZXh0ZW5zaW9uLg0KDQogICAgQXJnczoNCiAgICAgICAgYXV0aG9yaXplZF9vbmx5IChib29sKTogT25seSByZXR1cm4gYXV0aG9yaXplZCBleHRlbnNpb25zDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtFeHRlbnNpb25QYWNrYWdlXSk6IGxpc3Qgb2YgcmVnaXN0ZXJlZCBwbHVnaW4gZXh0ZW5zaW9ucw0KICAgICIiIg0KICAgIGV4dHBrZ3MgPSBbXQ0KICAgIGZvciBleHRfZGlyIGluIHVzZXJfY29uZmlnLmdldF9leHRfcm9vdF9kaXJzKCk6DQogICAgICAgICMgbWFrZSBhIGxpc3Qgb2YgYWxsIGF2YWlsYWJlIGV4dGVuc2lvbiBkZWZpbml0aW9uIHNvdXJjZXMNCiAgICAgICAgIyBkZWZhdWx0IGlzIHVuZGVyIHRoZSBleHRlbnNpb25zIGRpcmVjdG9yeSB0aGF0IHNoaXBzIHdpdGggcHlyZXZpdA0KICAgICAgICBleHRwa2dfZGVmX2ZpbGVzID0ge29wLmpvaW4oZXh0X2RpciwgUExVR0lOX0VYVF9ERUZfRklMRSl9DQogICAgICAgICMgYWRkIG90aGVyIHNvdXJjZXMgYWRkZWQgYnkgdGhlIHVzZXIgKHVzaW5nIHRoZSBjbGkpDQogICAgICAgIGV4dHBrZ19kZWZfZmlsZXMudXBkYXRlKHVzZXJfY29uZmlnLmdldF9leHRfc291cmNlcygpKQ0KICAgICAgICBmb3IgZXh0cGtnX2RlZl9maWxlIGluIGV4dHBrZ19kZWZfZmlsZXM6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdMb29raW5nIGZvciAlcycsIGV4dHBrZ19kZWZfZmlsZSkNCiAgICAgICAgICAgICMgY2hlY2sgZm9yIGV4dGVybmFsIGV4dCBkZWYgZmlsZQ0KICAgICAgICAgICAgaWYgb3AuZXhpc3RzKGV4dHBrZ19kZWZfZmlsZSk6DQogICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRm91bmQgJXMnLCBleHRwa2dfZGVmX2ZpbGUpDQogICAgICAgICAgICAgICAgX3VwZGF0ZV9leHRwa2dzKGV4dHBrZ19kZWZfZmlsZSwgZXh0cGtncykNCiAgICAgICAgICAgICMgY2hlY2sgaW50ZXJuYWxzIG5vdw0KICAgICAgICAgICAgaW50ZXJuYWxfZXh0cGtnX2RlZnMgPSBfZmluZF9pbnRlcm5hbF9leHRwa2dzKGV4dF9kaXIpDQogICAgICAgICAgICBmb3IgaW50X2RlZl9maWxlIGluIGludGVybmFsX2V4dHBrZ19kZWZzOg0KICAgICAgICAgICAgICAgIF91cGRhdGVfZXh0cGtncyhpbnRfZGVmX2ZpbGUsIGV4dHBrZ3MpDQoNCiAgICBpZiBhdXRob3JpemVkX29ubHk6DQogICAgICAgIHJldHVybiBbeCBmb3IgeCBpbiBleHRwa2dzIGlmIHgudXNlcl9oYXNfYWNjZXNzXQ0KDQogICAgcmV0dXJuIGV4dHBrZ3MNCg0KDQpkZWYgZ2V0X2V4dF9wYWNrYWdlX2J5X25hbWUoZXh0cGtnX25hbWUpOg0KICAgIGZvciBleHRwa2cgaW4gZ2V0X2V4dF9wYWNrYWdlcyhhdXRob3JpemVkX29ubHk9RmFsc2UpOg0KICAgICAgICBpZiBleHRwa2cubmFtZSA9PSBleHRwa2dfbmFtZToNCiAgICAgICAgICAgIHJldHVybiBleHRwa2cNCiAgICByZXR1cm4gTm9uZQ0KDQoNCmRlZiBnZXRfZGVwZW5kZW5jeV9ncmFwaCgpOg0KICAgIHJldHVybiBEZXBlbmRlbmN5R3JhcGgoZ2V0X2V4dF9wYWNrYWdlcyhhdXRob3JpemVkX29ubHk9RmFsc2UpKQ0KDQoNCmRlZiBpbnN0YWxsKGV4dHBrZywgaW5zdGFsbF9kaXIsIGluc3RhbGxfZGVwZW5kZW5jaWVzPVRydWUpOg0KICAgICIiIkluc3RhbGwgdGhlIGV4dGVuc2lvbiBpbiB0aGUgZ2l2ZW4gcGFyZW50IGRpcmVjdG9yeS4NCg0KICAgIFRoaXMgbWV0aG9kIHVzZXMgLmluc3RhbGxlZF9kaXIgcHJvcGVydHkgb2YgZXh0ZW5zaW9uIG9iamVjdCANCiAgICBhcyBpbnN0YWxsYXRpb24gZGlyZWN0b3J5IG5hbWUgZm9yIHRoaXMgZXh0ZW5zaW9uLg0KICAgIFRoaXMgbWV0aG9kIGFsc28gaGFuZGxlcyBpbnN0YWxsYXRpb24gb2YgZXh0ZW5zaW9uIGRlcGVuZGVuY2llcy4NCg0KICAgIEFyZ3M6DQogICAgICAgIGV4dHBrZyAoRXh0ZW5zaW9uUGFja2FnZSk6IEV4dGVuc2lvbiBwYWNrYWdlIHRvIGJlIGluc3RhbGxlZA0KICAgICAgICBpbnN0YWxsX2RpciAoc3RyKTogUGFyZW50IGRpcmVjdG9yeSB0byBpbnN0YWxsIGV4dGVuc2lvbiBpbi4NCiAgICAgICAgaW5zdGFsbF9kZXBlbmRlbmNpZXMgKGJvb2wpOiBJbnN0YWxsIHRoZSBkZXBlbmRlbmNpZXMgYXMgd2VsbA0KDQogICAgUmFpc2VzOg0KICAgICAgICBQeVJldml0RXhjZXB0aW9uOiBvbiBpbnN0YWxsIGVycm9yIHdpdGggZXJyb3IgbWVzc2FnZQ0KICAgICIiIg0KICAgIHRyeToNCiAgICAgICAgX2luc3RhbGxfZXh0cGtnKGV4dHBrZywgaW5zdGFsbF9kaXIsIGluc3RhbGxfZGVwZW5kZW5jaWVzKQ0KICAgIGV4Y2VwdCBQeVJldml0UGx1Z2luQWxyZWFkeUluc3RhbGxlZEV4Y2VwdGlvbiBhcyBhbHJlYWR5X2luc3RhbGxlZF9lcnI6DQogICAgICAgIG1sb2dnZXIud2FybmluZygnJXMgZXh0ZW5zaW9uIGlzIGFscmVhZHkgaW5zdGFsbGVkIHVuZGVyICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgIGFscmVhZHlfaW5zdGFsbGVkX2Vyci5leHRwa2cubmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGFscmVhZHlfaW5zdGFsbGVkX2Vyci5leHRwa2cuaXNfaW5zdGFsbGVkKQ0KICAgIGV4Y2VwdCBQeVJldml0UGx1Z2luTm9JbnN0YWxsTGlua0V4Y2VwdGlvbjoNCiAgICAgICAgbWxvZ2dlci5lcnJvcignRXh0ZW5zaW9uIGRvZXMgbm90IGhhdmUgYW4gaW5zdGFsbCBsaW5rICcNCiAgICAgICAgICAgICAgICAgICAgICAnYW5kIGNhbiBub3QgYmUgaW5zdGFsbGVkLicpDQoNCg0KZGVmIHJlbW92ZShleHRwa2csIHJlbW92ZV9kZXBlbmRlbmNpZXM9VHJ1ZSk6DQogICAgIiIiUmVtb3ZlcyB0aGUgZXh0ZW5zaW9uLg0KDQogICAgUmVtb3ZlcyB0aGUgZXh0ZW5zaW9uIGZyb20gaXRzIGluc3RhbGxlZCBkaXJlY3RvcnkNCiAgICBhbmQgY2xlYXJzIGl0cyBjb25maWd1cmF0aW9uLg0KDQogICAgQXJnczoNCiAgICAgICAgZXh0cGtnIChFeHRlbnNpb25QYWNrYWdlKTogRXh0ZW5zaW9uIHBhY2thZ2UgdG8gYmUgcmVtb3ZlZA0KICAgICAgICByZW1vdmVfZGVwZW5kZW5jaWVzIChib29sKTogUmVtb3ZlIHRoZSBkZXBlbmRlbmNpZXMgYXMgd2VsbA0KDQogICAgUmFpc2VzOg0KICAgICAgICBQeVJldml0RXhjZXB0aW9uOiBvbiByZW1vdmUgZXJyb3Igd2l0aCBlcnJvciBtZXNzYWdlDQogICAgIiIiDQogICAgdHJ5Og0KICAgICAgICBfcmVtb3ZlX2V4dHBrZyhleHRwa2csIHJlbW92ZV9kZXBlbmRlbmNpZXMpDQogICAgZXhjZXB0IFB5UmV2aXRQbHVnaW5SZW1vdmVFeGNlcHRpb24gYXMgcmVtb3ZlX2VycjoNCiAgICAgICAgbWxvZ2dlci5lcnJvcignRXJyb3IgcmVtb3ZpbmcgZXh0ZW5zaW9uOiAlcyB8ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICBleHRwa2cubmFtZSwgcmVtb3ZlX2VycikNCg0KIiIiR2VuZXJpYyBleHRlbnNpb24gY29tcG9uZW50cy4iIiINCmltcG9ydCBvcw0KaW1wb3J0IG9zLnBhdGggYXMgb3ANCmltcG9ydCByZQ0KaW1wb3J0IGNvZGVjcw0KaW1wb3J0IGNvcHkNCg0KZnJvbSBweXJldml0IGltcG9ydCBIT1NUX0FQUCwgUHlSZXZpdEV4Y2VwdGlvbg0KZnJvbSBweXJldml0IGltcG9ydCBjb3JldXRpbHMNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IHlhbWwNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGFwcGxvY2FsZXMNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IHB5dXRpbHMNCmZyb20gcHlyZXZpdC5jb21wYXQgaW1wb3J0IFBZMw0KZnJvbSBweXJldml0LnJldml0IGltcG9ydCB1aQ0KaW1wb3J0IHB5cmV2aXQuZXh0ZW5zaW9ucyBhcyBleHRzDQoNCg0KI3B5bGludDogZGlzYWJsZT1XMDcwMyxDMDMwMixDMDEwMw0KbWxvZ2dlciA9IGNvcmV1dGlscy5sb2dnZXIuZ2V0X2xvZ2dlcihfX25hbWVfXykNCg0KDQpFWFRfRElSX0tFWSA9ICdkaXJlY3RvcnknDQpTVUJfQ01QX0tFWSA9ICdjb21wb25lbnRzJw0KTEFZT1VUX0lURU1fS0VZID0gJ2xheW91dF9pdGVtcycNCkxBWU9VVF9ESVJfS0VZID0gJ2RpcmVjdGl2ZScNClRZUEVfSURfS0VZID0gJ3R5cGVfaWQnDQpOQU1FX0tFWSA9ICduYW1lJw0KDQoNCmNsYXNzIFR5cGVkQ29tcG9uZW50KG9iamVjdCk6DQogICAgIiIiQ29tcG9uZW50IHdpdGggYSB0eXBlIGlkLiIiIg0KICAgIHR5cGVfaWQgPSBOb25lDQoNCg0KY2xhc3MgQ2FjaGFibGVDb21wb25lbnQoVHlwZWRDb21wb25lbnQpOg0KICAgICIiIkNhY2hlYWJsZSBDb21wb25lbnQuIiIiDQogICAgZGVmIGdldF9jYWNoZV9kYXRhKHNlbGYpOg0KICAgICAgICBjYWNoZV9kaWN0ID0gc2VsZi5fX2RpY3RfXy5jb3B5KCkNCiAgICAgICAgaWYgaGFzYXR0cihzZWxmLCBUWVBFX0lEX0tFWSk6DQogICAgICAgICAgICBjYWNoZV9kaWN0W1RZUEVfSURfS0VZXSA9IGdldGF0dHIoc2VsZiwgVFlQRV9JRF9LRVkpDQogICAgICAgIHJldHVybiBjYWNoZV9kaWN0DQoNCiAgICBkZWYgbG9hZF9jYWNoZV9kYXRhKHNlbGYsIGNhY2hlX2RpY3QpOg0KICAgICAgICBmb3IgaywgdiBpbiBjYWNoZV9kaWN0Lml0ZW1zKCk6DQogICAgICAgICAgICBzZWxmLl9fZGljdF9fW2tdID0gdg0KDQoNCmNsYXNzIExheW91dERpcmVjdGl2ZShDYWNoYWJsZUNvbXBvbmVudCk6DQogICAgIiIiTGF5b3V0IGRpcmVjdGl2ZS4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgZGlyZWN0aXZlX3R5cGU9Tm9uZSwgdGFyZ2V0PU5vbmUpOg0KICAgICAgICBzZWxmLmRpcmVjdGl2ZV90eXBlID0gZGlyZWN0aXZlX3R5cGUNCiAgICAgICAgc2VsZi50YXJnZXQgPSB0YXJnZXQNCg0KDQpjbGFzcyBMYXlvdXRJdGVtKENhY2hhYmxlQ29tcG9uZW50KToNCiAgICAiIiJMYXlvdXQgaXRlbS4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZT1Ob25lLCBkaXJlY3RpdmU9Tm9uZSk6DQogICAgICAgIHNlbGYubmFtZSA9IG5hbWUNCiAgICAgICAgc2VsZi5kaXJlY3RpdmUgPSBkaXJlY3RpdmUNCg0KDQpjbGFzcyBHZW5lcmljQ29tcG9uZW50KENhY2hhYmxlQ29tcG9uZW50KToNCiAgICAiIiJHZW5lcmljIGNvbXBvbmVudCBvYmplY3QuIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYpOg0KICAgICAgICBzZWxmLm5hbWUgPSBOb25lDQoNCiAgICBkZWYgX19yZXByX18oc2VsZik6DQogICAgICAgIHJldHVybiAnPEdlbmVyaWNDb21wb25lbnQgb2JqZWN0IHdpdGggbmFtZSBcJ3t9XCc+Jy5mb3JtYXQoc2VsZi5uYW1lKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGlzX2NvbnRhaW5lcihzZWxmKToNCiAgICAgICAgcmV0dXJuIGhhc2F0dHIoc2VsZiwgJ19faXRlcl9fJykNCg0KDQpjbGFzcyBHZW5lcmljVUlDb21wb25lbnQoR2VuZXJpY0NvbXBvbmVudCk6DQogICAgIiIiR2VuZXJpYyBVSSBjb21wb25lbnQuIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNtcF9wYXRoPU5vbmUpOg0KICAgICAgICAjIHVzaW5nIGNsYXNzbmFtZSBvdGhlcndpc2UgZXhjZXB0aW9ucyBpbiBzdXBlcmNsYXNzZXMgd29uJ3Qgc2hvdw0KICAgICAgICBHZW5lcmljQ29tcG9uZW50Ll9faW5pdF9fKHNlbGYpDQogICAgICAgIHNlbGYuZGlyZWN0b3J5ID0gY21wX3BhdGgNCiAgICAgICAgc2VsZi51bmlxdWVfbmFtZSA9IHNlbGYucGFyZW50X2N0cmxfaWQgPSBOb25lDQogICAgICAgIHNlbGYuaWNvbl9maWxlID0gTm9uZQ0KICAgICAgICBzZWxmLl91aV90aXRsZSA9IE5vbmUNCiAgICAgICAgc2VsZi5fdG9vbHRpcCA9IHNlbGYuYXV0aG9yID0gc2VsZi5faGVscF91cmwgPSBOb25lDQogICAgICAgIHNlbGYubWVkaWFfZmlsZSA9IE5vbmUNCiAgICAgICAgc2VsZi5taW5fcmV2aXRfdmVyID0gc2VsZi5tYXhfcmV2aXRfdmVyID0gTm9uZQ0KICAgICAgICBzZWxmLmlzX2JldGEgPSBGYWxzZQ0KICAgICAgICBzZWxmLmhpZ2hsaWdodF90eXBlID0gTm9uZQ0KICAgICAgICBzZWxmLmNvbGxhcHNlZCA9IEZhbHNlDQogICAgICAgIHNlbGYudmVyc2lvbiA9IE5vbmUNCg0KICAgICAgICBzZWxmLm1ldGEgPSB7fQ0KICAgICAgICBzZWxmLm1ldGFfZmlsZSA9IE5vbmUNCg0KICAgICAgICBzZWxmLm1vZHVsZXMgPSBbXQ0KICAgICAgICBzZWxmLm1vZHVsZV9wYXRocyA9IFtdDQoNCiAgICAgICAgc2VsZi5iaW5hcnlfcGF0aCA9IE5vbmUNCiAgICAgICAgc2VsZi5saWJyYXJ5X3BhdGggPSBOb25lDQoNCiAgICAgICAgaWYgc2VsZi5kaXJlY3Rvcnk6DQogICAgICAgICAgICBzZWxmLl91cGRhdGVfZnJvbV9kaXJlY3RvcnkoKQ0KDQogICAgQGNsYXNzbWV0aG9kDQogICAgZGVmIG1hdGNoZXMoY2xzLCBjb21wb25lbnRfcGF0aCk6DQogICAgICAgIHJldHVybiBjb21wb25lbnRfcGF0aC5sb3dlcigpLmVuZHN3aXRoKGNscy50eXBlX2lkKQ0KDQogICAgQGNsYXNzbWV0aG9kDQogICAgZGVmIG1ha2VfdW5pcXVlX25hbWUoY2xzLCBjbXBfcGF0aCk6DQogICAgICAgICIiIkNyZWF0ZXMgYSB1bmlxdWUgbmFtZSBmb3IgdGhlIGNvbW1hbmQuDQoNCiAgICAgICAgVGhpcyBpcyB1c2VkIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgY29tbWFuZA0KICAgICAgICBhbmQgYWxzbyB0byBjcmVhdGUgdGhlIGNsYXNzIGluIHB5UmV2aXQgZGxsIGFzc2VtYmx5Lg0KICAgICAgICBDdXJyZW50IG1ldGhvZCBjcmVhdGUgYSB1bmlxdWUgbmFtZSBiYXNlZCBvbiB0aGUgY29tbWFuZA0KICAgICAgICBmdWxsIGRpcmVjdG9yeSBhZGRyZXNzLg0KDQogICAgICAgIEV4YW1wbGVzOg0KICAgICAgICAgICAgZm9yICdweVJldml0LmV4dGVuc2lvbi9weVJldml0LnRhYi9FZGl0LnBhbmVsL0ZsaXAgZG9vcnMucHVzaGJ1dHRvbicNCiAgICAgICAgICAgIHVuaXF1ZSBuYW1lIHdvdWxkIGJlOiAncHlyZXZpdC1weXJldml0LWVkaXQtZmxpcGRvb3JzJy4NCiAgICAgICAgIiIiDQogICAgICAgIHBpZWNlcyA9IFtdDQogICAgICAgIGluc2lkZV9leHQgPSBGYWxzZQ0KICAgICAgICBmb3IgZG5hbWUgaW4gY21wX3BhdGguc3BsaXQob3Auc2VwKToNCiAgICAgICAgICAgIGlmIGV4dHMuRXh0ZW5zaW9uVHlwZXMuVUlfRVhURU5TSU9OLlBPU1RGSVggaW4gZG5hbWU6DQogICAgICAgICAgICAgICAgaW5zaWRlX2V4dCA9IFRydWUNCg0KICAgICAgICAgICAgbmFtZSwgZXh0ID0gb3Auc3BsaXRleHQoZG5hbWUpDQogICAgICAgICAgICBpZiBleHQgIT0gJycgYW5kIGluc2lkZV9leHQ6DQogICAgICAgICAgICAgICAgcGllY2VzLmFwcGVuZChuYW1lKQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICByZXR1cm4gY29yZXV0aWxzLmNsZWFudXBfc3RyaW5nKA0KICAgICAgICAgICAgZXh0cy5VTklRVUVfSURfU0VQQVJBVE9SLmpvaW4ocGllY2VzKSwNCiAgICAgICAgICAgIHNraXA9W2V4dHMuVU5JUVVFX0lEX1NFUEFSQVRPUl0NCiAgICAgICAgICAgICkubG93ZXIoKQ0KDQogICAgZGVmIF9fcmVwcl9fKHNlbGYpOg0KICAgICAgICByZXR1cm4gJzx0eXBlX2lkIFwne31cJyBuYW1lIFwne31cJyBAIFwne31cJz4nXA0KICAgICAgICAgICAgLmZvcm1hdChzZWxmLnR5cGVfaWQsIHNlbGYubmFtZSwgc2VsZi5kaXJlY3RvcnkpDQoNCiAgICBkZWYgX3VwZGF0ZV9mcm9tX2RpcmVjdG9yeShzZWxmKToNCiAgICAgICAgc2VsZi5uYW1lID0gb3Auc3BsaXRleHQob3AuYmFzZW5hbWUoc2VsZi5kaXJlY3RvcnkpKVswXQ0KICAgICAgICBzZWxmLl91aV90aXRsZSA9IHNlbGYubmFtZQ0KICAgICAgICBzZWxmLnVuaXF1ZV9uYW1lID0gR2VuZXJpY1VJQ29tcG9uZW50Lm1ha2VfdW5pcXVlX25hbWUoc2VsZi5kaXJlY3RvcnkpDQoNCiAgICAgICAgc2VsZi5pY29uX2ZpbGUgPSB1aS5yZXNvbHZlX2ljb25fZmlsZShzZWxmLmRpcmVjdG9yeSwgZXh0cy5ERUZBVUxUX0lDT05fRklMRSkNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnSWNvbiBmaWxlIGlzOiAlczolcycsIHNlbGYubmFtZSwgc2VsZi5pY29uX2ZpbGUpDQoNCiAgICAgICAgc2VsZi5tZWRpYV9maWxlID0gXA0KICAgICAgICAgICAgc2VsZi5maW5kX2J1bmRsZV9maWxlKFtleHRzLkRFRkFVTFRfTUVESUFfRklMRU5BTUVdLCBmaW5kZXI9J25hbWUnKQ0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdNZWRpYSBmaWxlIGlzOiAlczolcycsIHNlbGYubmFtZSwgc2VsZi5tZWRpYV9maWxlKQ0KDQogICAgICAgIHNlbGYuX2hlbHBfdXJsID0gXA0KICAgICAgICAgICAgc2VsZi5maW5kX2J1bmRsZV9maWxlKFtleHRzLkhFTFBfRklMRV9QQVRURVJOXSwgZmluZGVyPSdyZWdleCcpDQoNCiAgICAgICAgIyBlYWNoIGNvbXBvbmVudCBjYW4gc3RvcmUgY3VzdG9tIGxpYnJhcmllcyB1bmRlcg0KICAgICAgICAjIGxpYi8gaW5zaWRlIHRoZSBjb21wb25lbnQgZm9sZGVyDQogICAgICAgIGxpYl9wYXRoID0gb3Auam9pbihzZWxmLmRpcmVjdG9yeSwgZXh0cy5DT01QX0xJQlJBUllfRElSX05BTUUpDQogICAgICAgIHNlbGYubGlicmFyeV9wYXRoID0gbGliX3BhdGggaWYgb3AuZXhpc3RzKGxpYl9wYXRoKSBlbHNlIE5vbmUNCg0KICAgICAgICAjIHNldHRpbmcgdXAgc2VhcmNoIHBhdGhzLiBUaGVzZSBwYXRocyB3aWxsIGJlIGFkZGVkIHRvDQogICAgICAgICMgYWxsIHN1Yi1jb21wb25lbnRzIG9mIHRoaXMgY29tcG9uZW50Lg0KICAgICAgICBpZiBzZWxmLmxpYnJhcnlfcGF0aDoNCiAgICAgICAgICAgIHNlbGYubW9kdWxlX3BhdGhzLmFwcGVuZChzZWxmLmxpYnJhcnlfcGF0aCkNCg0KICAgICAgICAjIGVhY2ggY29tcG9uZW50IGNhbiBzdG9yZSBjdXN0b20gYmluYXJpZXMgdW5kZXINCiAgICAgICAgIyBiaW4vIGluc2lkZSB0aGUgY29tcG9uZW50IGZvbGRlcg0KICAgICAgICBiaW5fcGF0aCA9IG9wLmpvaW4oc2VsZi5kaXJlY3RvcnksIGV4dHMuQ09NUF9CSU5fRElSX05BTUUpDQogICAgICAgIHNlbGYuYmluYXJ5X3BhdGggPSBiaW5fcGF0aCBpZiBvcC5leGlzdHMoYmluX3BhdGgpIGVsc2UgTm9uZQ0KDQogICAgICAgICMgc2V0dGluZyB1cCBzZWFyY2ggcGF0aHMuIFRoZXNlIHBhdGhzIHdpbGwgYmUgYWRkZWQgdG8NCiAgICAgICAgIyBhbGwgc3ViLWNvbXBvbmVudHMgb2YgdGhpcyBjb21wb25lbnQuDQogICAgICAgIGlmIHNlbGYuYmluYXJ5X3BhdGg6DQogICAgICAgICAgICBzZWxmLm1vZHVsZV9wYXRocy5hcHBlbmQoc2VsZi5iaW5hcnlfcGF0aCkNCg0KICAgICAgICAjIGZpbmQgbWV0YSBmaWxlDQogICAgICAgIHNlbGYubWV0YV9maWxlID0gc2VsZi5maW5kX2J1bmRsZV9maWxlKFsNCiAgICAgICAgICAgIGV4dHMuQlVORExFTUFUQV9QT1NURklYDQogICAgICAgICAgICBdKQ0KICAgICAgICBpZiBzZWxmLm1ldGFfZmlsZToNCiAgICAgICAgICAgICMgc2V0cyB1cCBzZWxmLm1ldGENCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICBzZWxmLm1ldGEgPSB5YW1sLmxvYWRfYXNfZGljdChzZWxmLm1ldGFfZmlsZSkNCiAgICAgICAgICAgICAgICBpZiBzZWxmLm1ldGE6DQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3JlYWRfYnVuZGxlX21ldGFkYXRhKCkNCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoDQogICAgICAgICAgICAgICAgICAgICJFcnJvciByZWFkaW5nIG1ldGEgZmlsZSBAICVzIHwgJXMiLCBzZWxmLm1ldGFfZmlsZSwgZXJyDQogICAgICAgICAgICAgICAgICAgICkNCg0KICAgIGRlZiBfcmVzb2x2ZV9sb2NhbGUoc2VsZiwgc291cmNlKToNCiAgICAgICAgaWYgaXNpbnN0YW5jZShzb3VyY2UsIHN0cik6DQogICAgICAgICAgICByZXR1cm4gc291cmNlDQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShzb3VyY2UsIGRpY3QpOg0KICAgICAgICAgICAgcmV0dXJuIGFwcGxvY2FsZXMuZ2V0X2xvY2FsZV9zdHJpbmcoc291cmNlKQ0KDQogICAgZGVmIF9yZXNvbHZlX2xpcXVpZF90YWcoc2VsZiwgcGFyYW1fbmFtZSwga2V5LCB2YWx1ZSk6DQogICAgICAgIGxpcXVpZF90YWcgPSAne3snICsga2V5ICsgJ319Jw0KICAgICAgICBleHN0X3ZhbCA9IGdldGF0dHIoc2VsZiwgcGFyYW1fbmFtZSkNCiAgICAgICAgaWYgZXhzdF92YWwgYW5kIChsaXF1aWRfdGFnIGluIGV4c3RfdmFsKTogICAjcHlsaW50OiBkaXNhYmxlPUUxMTM1DQogICAgICAgICAgICBuZXdfdmFsdWUgPSBleHN0X3ZhbC5yZXBsYWNlKGxpcXVpZF90YWcsIHZhbHVlKQ0KICAgICAgICAgICAgc2V0YXR0cihzZWxmLCBwYXJhbV9uYW1lLCBuZXdfdmFsdWUpDQoNCiAgICBkZWYgX3JlYWRfYnVuZGxlX21ldGFkYXRhKHNlbGYpOg0KICAgICAgICBzZWxmLl91aV90aXRsZSA9IHNlbGYubWV0YS5nZXQoZXh0cy5NREFUQV9VSV9USVRMRSwgc2VsZi5fdWlfdGl0bGUpDQoNCiAgICAgICAgc2VsZi5fdG9vbHRpcCA9IHNlbGYubWV0YS5nZXQoZXh0cy5NREFUQV9UT09MVElQLCBzZWxmLl90b29sdGlwKQ0KDQogICAgICAgICMgYXV0aG9ycyBjb3VsZCBiZSBhIGxpc3Qgb3Igc2luZ2xlIHZhbHVlDQogICAgICAgIHNlbGYuYXV0aG9yID0gc2VsZi5tZXRhLmdldChleHRzLk1EQVRBX0FVVEhPUiwgc2VsZi5hdXRob3IpDQogICAgICAgIHNlbGYuYXV0aG9yID0gc2VsZi5tZXRhLmdldChleHRzLk1EQVRBX0FVVEhPUlMsIHNlbGYuYXV0aG9yKQ0KICAgICAgICBpZiBpc2luc3RhbmNlKHNlbGYuYXV0aG9yLCBsaXN0KToNCiAgICAgICAgICAgIHNlbGYuYXV0aG9yID0gJ1xuJy5qb2luKHNlbGYuYXV0aG9yKQ0KDQogICAgICAgIHNlbGYuX2hlbHBfdXJsID0gXA0KICAgICAgICAgICAgc2VsZi5tZXRhLmdldChleHRzLk1EQVRBX0NPTU1BTkRfSEVMUF9VUkwsIHNlbGYuX2hlbHBfdXJsKQ0KDQogICAgICAgIHNlbGYubWluX3Jldml0X3ZlciA9IFwNCiAgICAgICAgICAgIHNlbGYubWV0YS5nZXQoZXh0cy5NREFUQV9NSU5fUkVWSVRfVkVSU0lPTiwgc2VsZi5taW5fcmV2aXRfdmVyKQ0KICAgICAgICBzZWxmLm1heF9yZXZpdF92ZXIgPSBcDQogICAgICAgICAgICBzZWxmLm1ldGEuZ2V0KGV4dHMuTURBVEFfTUFYX1JFVklUX1ZFUlNJT04sIHNlbGYubWF4X3Jldml0X3ZlcikNCg0KICAgICAgICBzZWxmLmlzX2JldGEgPSBcDQogICAgICAgICAgICBzZWxmLm1ldGEuZ2V0KGV4dHMuTURBVEFfQkVUQV9TQ1JJUFQsICdmYWxzZScpLmxvd2VyKCkgPT0gJ3RydWUnDQoNCiAgICAgICAgaGlnaGxpZ2h0ID0gXA0KICAgICAgICAgICAgc2VsZi5tZXRhLmdldChleHRzLk1EQVRBX0hJR0hMSUdIVF9LRVksIE5vbmUpDQogICAgICAgIGlmIGhpZ2hsaWdodCBhbmQgaXNpbnN0YW5jZShoaWdobGlnaHQsIHN0cik6DQogICAgICAgICAgICBzZWxmLmhpZ2hsaWdodF90eXBlID0gaGlnaGxpZ2h0Lmxvd2VyKCkNCg0KICAgICAgICBzZWxmLmNvbGxhcHNlZCA9IFwNCiAgICAgICAgICAgIHNlbGYubWV0YS5nZXQoZXh0cy5NREFUQV9DT0xMQVBTRURfS0VZLCAnZmFsc2UnKS5sb3dlcigpID09ICd0cnVlJw0KDQogICAgICAgIHNlbGYubW9kdWxlcyA9IFwNCiAgICAgICAgICAgIHNlbGYubWV0YS5nZXQoZXh0cy5NREFUQV9MSU5LX0JVVFRPTl9NT0RVTEVTLCBzZWxmLm1vZHVsZXMpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgY29udHJvbF9pZChzZWxmKToNCiAgICAgICAgaWYgc2VsZi5wYXJlbnRfY3RybF9pZDoNCiAgICAgICAgICAgIHJldHVybiBzZWxmLnBhcmVudF9jdHJsX2lkICsgJyV7fScuZm9ybWF0KHNlbGYubmFtZSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiAiQ3VzdG9tQ3RybF8lQ3VzdG9tQ3RybF8le30iLmZvcm1hdChzZWxmLm5hbWUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgdWlfdGl0bGUoc2VsZik6DQogICAgICAgIHJldHVybiBzZWxmLl9yZXNvbHZlX2xvY2FsZShzZWxmLl91aV90aXRsZSkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB0b29sdGlwKHNlbGYpOg0KICAgICAgICByZXR1cm4gc2VsZi5fcmVzb2x2ZV9sb2NhbGUoc2VsZi5fdG9vbHRpcCkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBoZWxwX3VybChzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuX3Jlc29sdmVfbG9jYWxlKHNlbGYuX2hlbHBfdXJsKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGlzX3N1cHBvcnRlZChzZWxmKToNCiAgICAgICAgaWYgc2VsZi5taW5fcmV2aXRfdmVyOg0KICAgICAgICAgICAgIyBJZiBob3N0IGlzIG9sZGVyIHRoYW4gdGhlIG1pbmltdW0gaG9zdCB2ZXJzaW9uLCByYWlzZSBleGNlcHRpb24NCiAgICAgICAgICAgIGlmIGludChIT1NUX0FQUC52ZXJzaW9uKSA8IGludChzZWxmLm1pbl9yZXZpdF92ZXIpOg0KICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ1JlcXVpcmVzIG1pbiB2ZXJzaW9uOiAlcycsIHNlbGYubWluX3Jldml0X3ZlcikNCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UNCiAgICAgICAgaWYgc2VsZi5tYXhfcmV2aXRfdmVyOg0KICAgICAgICAgICAgIyBJZiBob3N0IGlzIG5ld2VyIHRoYW4gdGhlIG1heCBob3N0IHZlcnNpb24sIHJhaXNlIGV4Y2VwdGlvbg0KICAgICAgICAgICAgaWYgaW50KEhPU1RfQVBQLnZlcnNpb24pID4gaW50KHNlbGYubWF4X3Jldml0X3Zlcik6DQogICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnUmVxdWlyZXMgbWF4IHZlcnNpb246ICVzJywgc2VsZi5tYXhfcmV2aXRfdmVyKQ0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQ0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgZGVmIGdldF9mdWxsX2J1bmRsZV9uYW1lKHNlbGYpOg0KICAgICAgICByZXR1cm4gc2VsZi5uYW1lICsgc2VsZi50eXBlX2lkDQoNCiAgICBkZWYgaGFzX21vZHVsZV9wYXRoKHNlbGYsIHBhdGgpOg0KICAgICAgICByZXR1cm4gcGF0aCBpbiBzZWxmLm1vZHVsZV9wYXRocw0KDQogICAgZGVmIGFkZF9tb2R1bGVfcGF0aChzZWxmLCBwYXRoKToNCiAgICAgICAgaWYgcGF0aCBhbmQgbm90IHNlbGYuaGFzX21vZHVsZV9wYXRoKHBhdGgpOg0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnQXBwZW5kaW5nIHN5c3BhdGg6ICVzIHRvICVzJywgcGF0aCwgc2VsZikNCiAgICAgICAgICAgIHNlbGYubW9kdWxlX3BhdGhzLmFwcGVuZChwYXRoKQ0KDQogICAgZGVmIHJlbW92ZV9tb2R1bGVfcGF0aChzZWxmLCBwYXRoKToNCiAgICAgICAgaWYgcGF0aCBhbmQgc2VsZi5oYXNfbW9kdWxlX3BhdGgocGF0aCk6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdSZW1vdmluZyBzeXNwYXRoOiAlcyBmcm9tICVzJywgcGF0aCwgc2VsZikNCiAgICAgICAgICAgIHJldHVybiBzZWxmLm1vZHVsZV9wYXRocy5yZW1vdmUocGF0aCkNCg0KICAgIGRlZiBnZXRfYnVuZGxlX2ZpbGUoc2VsZiwgZmlsZV9uYW1lKToNCiAgICAgICAgaWYgc2VsZi5kaXJlY3RvcnkgYW5kIGZpbGVfbmFtZToNCiAgICAgICAgICAgIGZpbGVfYWRkciA9IG9wLmpvaW4oc2VsZi5kaXJlY3RvcnksIGZpbGVfbmFtZSkNCiAgICAgICAgICAgIHJldHVybiBmaWxlX2FkZHIgaWYgb3AuZXhpc3RzKGZpbGVfYWRkcikgZWxzZSBOb25lDQoNCiAgICBkZWYgZmluZF9idW5kbGVfZmlsZShzZWxmLCBwYXR0ZXJucywgZmluZGVyPSdwb3N0Zml4Jyk6DQogICAgICAgIGlmIHNlbGYuZGlyZWN0b3J5Og0KICAgICAgICAgICAgZm9yIGJ1bmRsZV9maWxlIGluIG9zLmxpc3RkaXIoc2VsZi5kaXJlY3RvcnkpOg0KICAgICAgICAgICAgICAgIGlmICduYW1lJyA9PSBmaW5kZXI6DQogICAgICAgICAgICAgICAgICAgIGZvciBmaWxlX25hbWUgaW4gcGF0dGVybnM6DQogICAgICAgICAgICAgICAgICAgICAgICBpZiBvcC5zcGxpdGV4dChidW5kbGVfZmlsZSlbMF0gPT0gZmlsZV9uYW1lOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcC5qb2luKHNlbGYuZGlyZWN0b3J5LCBidW5kbGVfZmlsZSkNCiAgICAgICAgICAgICAgICBlbGlmICdwb3N0Zml4JyA9PSBmaW5kZXI6DQogICAgICAgICAgICAgICAgICAgIGZvciBmaWxlX3Bvc3RmaXggaW4gcGF0dGVybnM6DQogICAgICAgICAgICAgICAgICAgICAgICBpZiBidW5kbGVfZmlsZS5lbmRzd2l0aChmaWxlX3Bvc3RmaXgpOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcC5qb2luKHNlbGYuZGlyZWN0b3J5LCBidW5kbGVfZmlsZSkNCiAgICAgICAgICAgICAgICBlbGlmICdyZWdleCcgPT0gZmluZGVyOg0KICAgICAgICAgICAgICAgICAgICBmb3IgcmVnZXhfcGF0dGVybiBpbiBwYXR0ZXJuczoNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlLm1hdGNoKHJlZ2V4X3BhdHRlcm4sIGJ1bmRsZV9maWxlKToNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3Auam9pbihzZWxmLmRpcmVjdG9yeSwgYnVuZGxlX2ZpbGUpDQogICAgICAgIHJldHVybiBOb25lDQoNCiAgICBkZWYgZmluZF9idW5kbGVfbW9kdWxlKHNlbGYsIG1vZHVsZSwgYnlfaG9zdD1GYWxzZSk6DQogICAgICAgICMgdGVzdCBvZiBmaWxlX25hbWUgaXMgYW4gYWN0dWFsbHkgcGF0aCB0byBhIGZpbGUNCiAgICAgICAgaWYgb3AuaXNmaWxlKG1vZHVsZSk6DQogICAgICAgICAgICByZXR1cm4gbW9kdWxlDQoNCiAgICAgICAgZGVmIGJ1aWxkX2Fzc21fZmlsZW5hbWUobW9kdWxlX2ZpbGVuYW1lKToNCiAgICAgICAgICAgICMgYnVpbGQgYXNzZW1ibHkgYnkgaG9zdCB2ZXJzaW9uIChhc3NtX2ZpbGVfMjAyMC5leHQpDQogICAgICAgICAgICBhc3NtX25hbWUsIGFzc21fZXh0ID0gb3Auc3BsaXRleHQobW9kdWxlX2ZpbGVuYW1lKQ0KICAgICAgICAgICAgcmV0dXJuIGFzc21fbmFtZSArICdfJyArIEhPU1RfQVBQLnZlcnNpb24gKyBhc3NtX2V4dA0KDQogICAgICAgIGlmIGJ5X2hvc3Q6DQogICAgICAgICAgICBtb2R1bGUgPSBidWlsZF9hc3NtX2ZpbGVuYW1lKG1vZHVsZSkNCg0KICAgICAgICAjIHRlc3QgaWYgbW9kdWxlIGlzIGluc2lkZSBzZWFyY2ggcGF0aHMNCiAgICAgICAgZm9yIG1vZHVsZV9wYXRoIGluIHNlbGYubW9kdWxlX3BhdGhzOg0KICAgICAgICAgICAgcG9zc2libGVfbW9kdWxlX3BhdGggPSBvcC5qb2luKG1vZHVsZV9wYXRoLCBtb2R1bGUpDQogICAgICAgICAgICBpZiBvcC5pc2ZpbGUocG9zc2libGVfbW9kdWxlX3BhdGgpOg0KICAgICAgICAgICAgICAgIHJldHVybiBwb3NzaWJsZV9tb2R1bGVfcGF0aA0KDQogICAgZGVmIGNvbmZpZ3VyZShzZWxmLCBjb25maWdfZGljdCk6DQogICAgICAgIGNvbmZpZ3VyYWJsZV9wYXJhbXMgPSBcDQogICAgICAgICAgICBbJ191aV90aXRsZScsICdfdG9vbHRpcCcsICdfaGVscF91cmwnLCAnYXV0aG9yJ10NCiAgICAgICAgIyBnZXQgcm9vdCBrZXk6dmFsdWUgcGFpcnMNCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX2RpY3QuaXRlbXMoKToNCiAgICAgICAgICAgIGZvciBwYXJhbV9uYW1lIGluIGNvbmZpZ3VyYWJsZV9wYXJhbXM6DQogICAgICAgICAgICAgICAgc2VsZi5fcmVzb2x2ZV9saXF1aWRfdGFnKHBhcmFtX25hbWUsIGtleSwgdmFsdWUpDQogICAgICAgICMgZ2V0IGtleTp2YWx1ZSBwYWlycyBncm91cGVkIHVuZGVyIHNwZWNpYWwga2V5LCBpZiBleGlzdHMNCiAgICAgICAgdGVtcGxhdGVzID0gY29uZmlnX2RpY3QuZ2V0KGV4dHMuTURBVEFfVEVNUExBVEVTX0tFWSwge30pDQogICAgICAgIGZvciBrZXksIHZhbHVlIGluIHRlbXBsYXRlcy5pdGVtcygpOg0KICAgICAgICAgICAgZm9yIHBhcmFtX25hbWUgaW4gY29uZmlndXJhYmxlX3BhcmFtczoNCiAgICAgICAgICAgICAgICBzZWxmLl9yZXNvbHZlX2xpcXVpZF90YWcocGFyYW1fbmFtZSwga2V5LCB2YWx1ZSkNCg0KDQpjbGFzcyBHZW5lcmljVUlDb250YWluZXIoR2VuZXJpY1VJQ29tcG9uZW50KToNCiAgICAiIiJTdXBlcmNsYXNzIGZvciBhbGwgVUkgZ3JvdXAgaXRlbXMgKHRhYiwgcGFuZWwsIGJ1dHRvbiBncm91cHMsIHN0YWNrcykuIiIiDQogICAgYWxsb3dlZF9zdWJfY21wcyA9IFtdDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgY21wX3BhdGg9Tm9uZSk6DQogICAgICAgIHNlbGYubGF5b3V0X2l0ZW1zID0gW10NCiAgICAgICAgc2VsZi5jb21wb25lbnRzID0gW10NCiAgICAgICAgIyB1c2luZyBjbGFzc25hbWUgb3RoZXJ3aXNlIGV4Y2VwdGlvbnMgaW4gc3VwZXJjbGFzc2VzIHdvbid0IHNob3cNCiAgICAgICAgR2VuZXJpY1VJQ29tcG9uZW50Ll9faW5pdF9fKHNlbGYsIGNtcF9wYXRoPWNtcF9wYXRoKQ0KDQogICAgZGVmIF91cGRhdGVfZnJvbV9kaXJlY3Rvcnkoc2VsZik6DQogICAgICAgICMgdXNpbmcgY2xhc3NuYW1lIG90aGVyd2lzZSBleGNlcHRpb25zIGluIHN1cGVyY2xhc3NlcyB3b24ndCBzaG93DQogICAgICAgIEdlbmVyaWNVSUNvbXBvbmVudC5fdXBkYXRlX2Zyb21fZGlyZWN0b3J5KHNlbGYpDQogICAgICAgICMgcHJvY2VzcyBsYXlvdXQNCiAgICAgICAgIyBkZWZhdWx0IGlzIGxheW91dCBpbiBtZXRhZGF0YSwgdGhlIG9sZGVyIGxheW91dCBmaWxlIGlzIGRlcHJlY2F0ZQ0KICAgICAgICAjIGFuZCBpcyBmb3IgZmFsbGJhY2sgb25seQ0KICAgICAgICBpZiBub3Qgc2VsZi5wYXJzZV9sYXlvdXRfbWV0YWRhdGEoKToNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0NvbnRhaW5lciBkb2VzIG5vdCBoYXZlIGxheW91dCBmaWxlIGRlZmluZWQ6ICVzJywNCiAgICAgICAgICAgICAgICBzZWxmKQ0KDQoNCiAgICBkZWYgX2FwcGx5X2xheW91dF9kaXJlY3RpdmUoc2VsZiwgZGlyZWN0aXZlLCBjb21wb25lbnQpOg0KICAgICAgICAjIGlmIG1hdGNoaW5nIGRpcmVjdGl2ZSBmb3VuZCwgcHJvY2VzcyB0aGUgZGlyZWN0aXZlDQogICAgICAgIGlmIGRpcmVjdGl2ZS5kaXJlY3RpdmVfdHlwZSA9PSAndGl0bGUnOg0KICAgICAgICAgICAgY29tcG9uZW50Ll91aV90aXRsZSA9IGRpcmVjdGl2ZS50YXJnZXQNCg0KICAgIGRlZiBfX2l0ZXJfXyhzZWxmKToNCiAgICAgICAgIyBpZiBpdGVtIGlzIG5vdCBsaXN0ZWQgaW4gbGF5b3V0LCBpdCB3aWxsIG5vdCBiZSBjcmVhdGVkDQogICAgICAgIGlmIHNlbGYubGF5b3V0X2l0ZW1zOg0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnUmVvcmRlcmluZyBjb21wb25lbnRzIHBlciBsYXlvdXQgZmlsZS4uLicpDQogICAgICAgICAgICBsYWlkb3V0X2NtcHMgPSBbXQ0KICAgICAgICAgICAgZm9yIGxpdGVtIGluIHNlbGYubGF5b3V0X2l0ZW1zOg0KICAgICAgICAgICAgICAgIG1hdGNoaW5nX2NtcCA9IFwNCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoKHggZm9yIHggaW4gc2VsZi5jb21wb25lbnRzDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB4Lm5hbWUgPT0gbGl0ZW0ubmFtZSksIE5vbmUpDQogICAgICAgICAgICAgICAgaWYgbWF0Y2hpbmdfY21wOg0KICAgICAgICAgICAgICAgICAgICAjIGFwcGx5IGRpcmVjdGl2ZXMgYmVmb3JlIGFkZGluZyB0byBsaXN0DQogICAgICAgICAgICAgICAgICAgIGlmIGxpdGVtLmRpcmVjdGl2ZToNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2FwcGx5X2xheW91dF9kaXJlY3RpdmUobGl0ZW0uZGlyZWN0aXZlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGluZ19jbXApDQogICAgICAgICAgICAgICAgICAgIGxhaWRvdXRfY21wcy5hcHBlbmQobWF0Y2hpbmdfY21wKQ0KDQogICAgICAgICAgICAjIGluc2VydCBzZXBhcmF0b3JzIGFuZCBzbGlkZW91dHMgcGVyIGxheW91dCBkZWZpbml0aW9uDQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdBZGRpbmcgc2VwYXJhdG9ycyBhbmQgc2xpZGUgb3V0cyBwZXIgbGF5b3V0Li4uJykNCiAgICAgICAgICAgIGxhc3RfaXRlbV9pbmRleCA9IGxlbihzZWxmLmxheW91dF9pdGVtcykgLSAxDQogICAgICAgICAgICBmb3IgaWR4LCBsaXRlbSBpbiBlbnVtZXJhdGUoc2VsZi5sYXlvdXRfaXRlbXMpOg0KICAgICAgICAgICAgICAgIGlmIGV4dHMuU0VQQVJBVE9SX0lERU5USUZJRVIgaW4gbGl0ZW0ubmFtZSBcDQogICAgICAgICAgICAgICAgICAgICAgICBhbmQgaWR4IDwgbGFzdF9pdGVtX2luZGV4Og0KICAgICAgICAgICAgICAgICAgICBzZXBhcmF0b3IgPSBHZW5lcmljVUlDb21wb25lbnQoKQ0KICAgICAgICAgICAgICAgICAgICBzZXBhcmF0b3IudHlwZV9pZCA9IGV4dHMuU0VQQVJBVE9SX0lERU5USUZJRVINCiAgICAgICAgICAgICAgICAgICAgbGFpZG91dF9jbXBzLmluc2VydChpZHgsIHNlcGFyYXRvcikNCiAgICAgICAgICAgICAgICBlbGlmIGV4dHMuU0xJREVPVVRfSURFTlRJRklFUiBpbiBsaXRlbS5uYW1lIFwNCiAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBpZHggPCBsYXN0X2l0ZW1faW5kZXg6DQogICAgICAgICAgICAgICAgICAgIHNsaWRlb3V0ID0gR2VuZXJpY1VJQ29tcG9uZW50KCkNCiAgICAgICAgICAgICAgICAgICAgc2xpZGVvdXQudHlwZV9pZCA9IGV4dHMuU0xJREVPVVRfSURFTlRJRklFUg0KICAgICAgICAgICAgICAgICAgICBsYWlkb3V0X2NtcHMuaW5zZXJ0KGlkeCwgc2xpZGVvdXQpDQoNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ1Jlb3JkZXJlZCBzdWJfY29tcG9uZW50IGxpc3QgaXM6ICVzJywgbGFpZG91dF9jbXBzKQ0KICAgICAgICAgICAgcmV0dXJuIGxhaWRvdXRfY21wcw0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuY29tcG9uZW50cw0KDQogICAgZGVmIHBhcnNlX2xheW91dF9kaXJlY3RpdmUoc2VsZiwgbGF5b3V0X2xpbmUpOg0KICAgICAgICBwYXJ0cyA9IHJlLmZpbmRhbGwocicoLispXFsoLispOiguKilcXScsIGxheW91dF9saW5lKQ0KICAgICAgICBpZiBwYXJ0czoNCiAgICAgICAgICAgIHNvdXJjZV9pdGVtLCBkaXJlY3RpdmUsIHRhcmdldF92YWx1ZSA9IHBhcnRzWzBdDQogICAgICAgICAgICAjIGNsZWFudXAgdmFsdWVzDQogICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmUubG93ZXIoKS5zdHJpcCgpDQogICAgICAgICAgICB0YXJnZXRfdmFsdWUgPSB0YXJnZXRfdmFsdWUuc3RyaXAoKQ0KICAgICAgICAgICAgIyBwcm9jZXNzIGFueSBlc2NhcGUgY2hhcmFjdGVycyBpbiB0YXJnZXQgdmFsdWUNCiAgICAgICAgICAgICMgaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzQwMjA4MjQvMjM1MDI0NA0KICAgICAgICAgICAgdGFyZ2V0X3ZhbHVlID0gdGFyZ2V0X3ZhbHVlLmVuY29kZSgndXRmLTgnKQ0KICAgICAgICAgICAgaWYgUFkzOg0KICAgICAgICAgICAgICAgIHRhcmdldF92YWx1ZSA9IHRhcmdldF92YWx1ZS5kZWNvZGUoJ3VuaWNvZGVfZXNjYXBlJykNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgdGFyZ2V0X3ZhbHVlID0gdGFyZ2V0X3ZhbHVlLmRlY29kZSgnc3RyaW5nX2VzY2FwZScpDQogICAgICAgICAgICAjIGNyZWF0ZSBkaXJlY3RpdmUgb2JqDQogICAgICAgICAgICByZXR1cm4gc291cmNlX2l0ZW0sIExheW91dERpcmVjdGl2ZShkaXJlY3RpdmVfdHlwZT1kaXJlY3RpdmUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ9dGFyZ2V0X3ZhbHVlKQ0KICAgICAgICByZXR1cm4gbGF5b3V0X2xpbmUsIE5vbmUNCg0KICAgIGRlZiBwYXJzZV9sYXlvdXRfaXRlbShzZWxmLCBsYXlvdXRfbGluZSk6DQogICAgICAgIGlmIGxheW91dF9saW5lOg0KICAgICAgICAgICAgbGF5b3V0X2l0ZW1fbmFtZSwgbGF5b3V0X2l0ZW1fZHJjdHYgPSBcDQogICAgICAgICAgICAgICAgc2VsZi5wYXJzZV9sYXlvdXRfZGlyZWN0aXZlKGxheW91dF9saW5lKQ0KICAgICAgICAgICAgcmV0dXJuIExheW91dEl0ZW0obmFtZT1sYXlvdXRfaXRlbV9uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlPWxheW91dF9pdGVtX2RyY3R2KQ0KDQogICAgZGVmIHBhcnNlX2xheW91dF9pdGVtcyhzZWxmLCBsYXlvdXRfbGluZXMpOg0KICAgICAgICBmb3IgbGF5b3V0X2xpbmUgaW4gbGF5b3V0X2xpbmVzOg0KICAgICAgICAgICAgbGF5b3V0X2l0ZW0gPSBzZWxmLnBhcnNlX2xheW91dF9pdGVtKGxheW91dF9saW5lKQ0KICAgICAgICAgICAgaWYgbGF5b3V0X2l0ZW06DQogICAgICAgICAgICAgICAgc2VsZi5sYXlvdXRfaXRlbXMuYXBwZW5kKGxheW91dF9pdGVtKQ0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdMYXlvdXQgaXM6ICVzJywgc2VsZi5sYXlvdXRfaXRlbXMpDQoNCiAgICBkZWYgcGFyc2VfbGF5b3V0X21ldGFkYXRhKHNlbGYpOg0KICAgICAgICBsYXlvdXQgPSBzZWxmLm1ldGEuZ2V0KGV4dHMuTURBVEFfTEFZT1VULCBbXSkNCiAgICAgICAgaWYgbGF5b3V0Og0KICAgICAgICAgICAgc2VsZi5wYXJzZV9sYXlvdXRfaXRlbXMobGF5b3V0KQ0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgIGRlZiBjb250YWlucyhzZWxmLCBpdGVtX25hbWUpOg0KICAgICAgICByZXR1cm4gYW55KFt4Lm5hbWUgPT0gaXRlbV9uYW1lIGZvciB4IGluIHNlbGYuY29tcG9uZW50c10pDQoNCiAgICBkZWYgYWRkX21vZHVsZV9wYXRoKHNlbGYsIHBhdGgpOg0KICAgICAgICBpZiBwYXRoIGFuZCBub3Qgc2VsZi5oYXNfbW9kdWxlX3BhdGgocGF0aCk6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdBcHBlbmRpbmcgc3lzcGF0aDogJXMgdG8gJXMnLCBwYXRoLCBzZWxmKQ0KICAgICAgICAgICAgZm9yIGNvbXBvbmVudCBpbiBzZWxmLmNvbXBvbmVudHM6DQogICAgICAgICAgICAgICAgY29tcG9uZW50LmFkZF9tb2R1bGVfcGF0aChwYXRoKQ0KICAgICAgICAgICAgc2VsZi5tb2R1bGVfcGF0aHMuYXBwZW5kKHBhdGgpDQoNCiAgICBkZWYgcmVtb3ZlX21vZHVsZV9wYXRoKHNlbGYsIHBhdGgpOg0KICAgICAgICBpZiBwYXRoIGFuZCBzZWxmLmhhc19tb2R1bGVfcGF0aChwYXRoKToNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ1JlbW92aW5nIHN5c3BhdGg6ICVzIGZyb20gJXMnLCBwYXRoLCBzZWxmKQ0KICAgICAgICAgICAgZm9yIGNvbXBvbmVudCBpbiBzZWxmLmNvbXBvbmVudHM6DQogICAgICAgICAgICAgICAgY29tcG9uZW50LnJlbW92ZV9tb2R1bGVfcGF0aChwYXRoKQ0KICAgICAgICAgICAgcmV0dXJuIHNlbGYubW9kdWxlX3BhdGhzLnJlbW92ZShwYXRoKQ0KDQogICAgZGVmIGFkZF9jb21wb25lbnQoc2VsZiwgY29tcCk6DQogICAgICAgICMgc2V0IHNlYXJjaCBwYXRocw0KICAgICAgICBmb3IgcGF0aCBpbiBzZWxmLm1vZHVsZV9wYXRoczoNCiAgICAgICAgICAgIGNvbXAuYWRkX21vZHVsZV9wYXRoKHBhdGgpDQogICAgICAgICMgc2V0IGl0cyBvd24gY29udHJvbCBpZCBvbiB0aGUgY2hpbGQgY29tcG9uZW50DQogICAgICAgIGlmIGhhc2F0dHIoY29tcCwgJ3BhcmVudF9jdHJsX2lkJyk6DQogICAgICAgICAgICBjb21wLnBhcmVudF9jdHJsX2lkID0gc2VsZi5jb250cm9sX2lkDQogICAgICAgICMgbm93IGFkZCB0byBsaXN0DQogICAgICAgIHNlbGYuY29tcG9uZW50cy5hcHBlbmQoY29tcCkNCg0KICAgIGRlZiBmaW5kX2NvbXBvbmVudHNfb2ZfdHlwZShzZWxmLCBjbXBfdHlwZSk6DQogICAgICAgIHN1Yl9jb21wX2xpc3QgPSBbXQ0KICAgICAgICBmb3Igc3ViX2NvbXAgaW4gc2VsZi5jb21wb25lbnRzOg0KICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzdWJfY29tcCwgY21wX3R5cGUpOg0KICAgICAgICAgICAgICAgIHN1Yl9jb21wX2xpc3QuYXBwZW5kKHN1Yl9jb21wKQ0KICAgICAgICAgICAgZWxpZiBzdWJfY29tcC5pc19jb250YWluZXI6DQogICAgICAgICAgICAgICAgc3ViX2NvbXBfbGlzdC5leHRlbmQoc3ViX2NvbXAuZmluZF9jb21wb25lbnRzX29mX3R5cGUoY21wX3R5cGUpKQ0KDQogICAgICAgIHJldHVybiBzdWJfY29tcF9saXN0DQoNCiAgICBkZWYgZmluZF9sYXlvdXRfaXRlbXMoc2VsZik6DQogICAgICAgIGxheW91dF9pdGVtcyA9IFtdDQogICAgICAgIGxheW91dF9pdGVtcy5leHRlbmQoc2VsZi5sYXlvdXRfaXRlbXMpDQogICAgICAgIGZvciBzdWJfY29tcCBpbiBzZWxmLmNvbXBvbmVudHM6DQogICAgICAgICAgICBpZiBzdWJfY29tcC5pc19jb250YWluZXI6DQogICAgICAgICAgICAgICAgbGF5b3V0X2l0ZW1zLmV4dGVuZChzdWJfY29tcC5maW5kX2xheW91dF9pdGVtcygpKQ0KICAgICAgICByZXR1cm4gbGF5b3V0X2l0ZW1zDQoNCiAgICBkZWYgY29uZmlndXJlKHNlbGYsIGNvbmZpZ19kaWN0KToNCiAgICAgICAgIyB1cGRhdGUgc2VsZiBtZXRhDQogICAgICAgIEdlbmVyaWNVSUNvbXBvbmVudC5jb25maWd1cmUoc2VsZiwgY29uZmlnX2RpY3Q9Y29uZmlnX2RpY3QpDQogICAgICAgICMgY3JlYXRlIGFuIHVwZGF0ZWQgZGljdCB0byBwYXNzIHRvIGNoaWxkcmVuDQogICAgICAgIHVwZGF0ZWRfZGljdCA9IGNvcHkuZGVlcGNvcHkoY29uZmlnX2RpY3QpDQogICAgICAgIHVwZGF0ZWRfZGljdCA9IHB5dXRpbHMubWVyZ2UodXBkYXRlZF9kaWN0LCBzZWxmLm1ldGEpDQogICAgICAgICMgcmVwbGFjZSB0aGUgbWV0YSB2YWx1ZXMgd2l0aCB0aGUgZXhwYW5kZWQgdmFsdWVzDQogICAgICAgICMgc28gY2hpbGRyZW4gY2FuIHVzZSB0aGUgZXhwYW5kZWQNCiAgICAgICAgdXBkYXRlZF9kaWN0W2V4dHMuTURBVEFfVUlfVElUTEVdID0gc2VsZi51aV90aXRsZQ0KICAgICAgICB1cGRhdGVkX2RpY3RbZXh0cy5NREFUQV9UT09MVElQXSA9IHNlbGYudG9vbHRpcA0KICAgICAgICB1cGRhdGVkX2RpY3RbZXh0cy5NREFUQV9DT01NQU5EX0hFTFBfVVJMXSA9IHNlbGYuaGVscF91cmwNCiAgICAgICAgdXBkYXRlZF9kaWN0W2V4dHMuQVVUSE9SX1BBUkFNXSA9IHNlbGYuYXV0aG9yDQogICAgICAgIGlmIGV4dHMuQVVUSE9SU19QQVJBTSBpbiB1cGRhdGVkX2RpY3Q6DQogICAgICAgICAgICB1cGRhdGVkX2RpY3QucG9wKGV4dHMuQVVUSE9SU19QQVJBTSkNCiAgICAgICAgZm9yIGNvbXBvbmVudCBpbiBzZWxmOg0KICAgICAgICAgICAgY29tcG9uZW50LmNvbmZpZ3VyZSh1cGRhdGVkX2RpY3QpDQoNCiMgc3VwZXJjbGFzcyBmb3IgYWxsIHNpbmdsZSBjb21tYW5kIGNsYXNzZXMgKGxpbmssIHB1c2ggYnV0dG9uLCB0b2dnbGUgYnV0dG9uKQ0KIyBHZW5lcmljVUlDb21tYW5kIGlzIG5vdCBkZXJpdmVkIGZyb20gR2VuZXJpY1VJQ29udGFpbmVyIHNpbmNlIGEgY29tbWFuZA0KIyBjYW4gbm90IGNvbnRhaW4gb3RoZXIgZWxlbWVudHMNCmNsYXNzIEdlbmVyaWNVSUNvbW1hbmQoR2VuZXJpY1VJQ29tcG9uZW50KToNCiAgICAiIiJTdXBlcmNsYXNzIGZvciBhbGwgc2luZ2xlIGNvbW1hbmRzLg0KDQogICAgVGhlIGluZm9ybWF0aW9uIHByb3ZpZGVkIGJ5IHRoZXNlIGNsYXNzZXMgd2lsbCBiZSB1c2VkIHRvIGNyZWF0ZSBhDQogICAgcHVzaCBidXR0b24gdW5kZXIgUmV2aXQgVUkuIEhvd2V2ZXIsIHB5UmV2aXQgZXhwYW5kcyB0aGUgY2FwYWJpbGl0aWVzIG9mDQogICAgcHVzaCBidXR0b24gYmV5b25kIHdoYXQgaXMgcHJvdmlkZWQgYnkgUmV2aXQgVUkuIChlLmcuIFRvZ2dsZSBidXR0b24NCiAgICBjaGFuZ2VzIGl0J3MgaWNvbiBiYXNlZCBvbiBpdHMgb24vb2ZmIHN0YXR1cykNCiAgICBTZWUgTGlua0J1dHRvbiBhbmQgVG9nZ2xlQnV0dG9uIGNsYXNzZXMuDQogICAgIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNtcF9wYXRoPU5vbmUsIG5lZWRzX3NjcmlwdD1UcnVlKToNCiAgICAgICAgc2VsZi5uZWVkc19zY3JpcHQgPSBuZWVkc19zY3JpcHQNCiAgICAgICAgc2VsZi5zY3JpcHRfZmlsZSA9IHNlbGYuY29uZmlnX3NjcmlwdF9maWxlID0gTm9uZQ0KICAgICAgICBzZWxmLmFyZ3VtZW50cyA9IFtdDQogICAgICAgIHNlbGYuY29udGV4dCA9IE5vbmUNCiAgICAgICAgc2VsZi5jbGFzc19uYW1lID0gc2VsZi5hdmFpbF9jbGFzc19uYW1lID0gTm9uZQ0KICAgICAgICBzZWxmLnJlcXVpcmVzX2NsZWFuX2VuZ2luZSA9IEZhbHNlDQogICAgICAgIHNlbGYucmVxdWlyZXNfZnVsbGZyYW1lX2VuZ2luZSA9IEZhbHNlDQogICAgICAgIHNlbGYucmVxdWlyZXNfcGVyc2lzdGVudF9lbmdpbmUgPSBGYWxzZQ0KICAgICAgICBzZWxmLnJlcXVpcmVzX21haW50aHJlYWRfZW5naW5lID0gRmFsc2UNCiAgICAgICAgIyBlbmdpbmUgb3B0aW9ucyBzcGVjaWZpYyB0byBkeW5hbW8NCiAgICAgICAgc2VsZi5keW5hbW9fcGF0aCA9IE5vbmUNCiAgICAgICAgIyBzZWxmLmR5bmFtb19wYXRoX2V4ZWMgPSBGYWxzZQ0KICAgICAgICBzZWxmLmR5bmFtb19wYXRoX2NoZWNrX2V4aXN0aW5nID0gRmFsc2UNCiAgICAgICAgc2VsZi5keW5hbW9fZm9yY2VfbWFudWFsX3J1biA9IEZhbHNlDQogICAgICAgIHNlbGYuZHluYW1vX21vZGVsX25vZGVzX2luZm8gPSBOb25lDQogICAgICAgICMgdXNpbmcgY2xhc3NuYW1lIG90aGVyd2lzZSBleGNlcHRpb25zIGluIHN1cGVyY2xhc3NlcyB3b24ndCBzaG93DQogICAgICAgIEdlbmVyaWNVSUNvbXBvbmVudC5fX2luaXRfXyhzZWxmLCBjbXBfcGF0aD1jbXBfcGF0aCkNCg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdNYXhpbXVtIGhvc3QgdmVyc2lvbjogJXMnLCBzZWxmLm1heF9yZXZpdF92ZXIpDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ01pbmltdW0gaG9zdCB2ZXJzaW9uOiAlcycsIHNlbGYubWluX3Jldml0X3ZlcikNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnY29tbWFuZCB0b29sdGlwOiAlcycsIHNlbGYuX3Rvb2x0aXApDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0NvbW1hbmQgYXV0aG9yOiAlcycsIHNlbGYuYXV0aG9yKQ0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDb21tYW5kIGhlbHAgdXJsOiAlcycsIHNlbGYuX2hlbHBfdXJsKQ0KDQogICAgICAgIGlmIHNlbGYuaXNfYmV0YToNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0NvbW1hbmQgaXMgaW4gYmV0YS4nKQ0KDQogICAgZGVmIF91cGRhdGVfZnJvbV9kaXJlY3Rvcnkoc2VsZik6DQogICAgICAgICMgdXNpbmcgY2xhc3NuYW1lIG90aGVyd2lzZSBleGNlcHRpb25zIGluIHN1cGVyY2xhc3NlcyB3b24ndCBzaG93DQogICAgICAgIEdlbmVyaWNVSUNvbXBvbmVudC5fdXBkYXRlX2Zyb21fZGlyZWN0b3J5KHNlbGYpDQoNCiAgICAgICAgIyBmaW5kIHNjcmlwdCBmaWxlDQogICAgICAgIHNlbGYuc2NyaXB0X2ZpbGUgPSBcDQogICAgICAgICAgICBzZWxmLmZpbmRfYnVuZGxlX2ZpbGUoWw0KICAgICAgICAgICAgICAgIGV4dHMuUFlUSE9OX1NDUklQVF9QT1NURklYLA0KICAgICAgICAgICAgICAgIGV4dHMuQ1NIQVJQX1NDUklQVF9QT1NURklYLA0KICAgICAgICAgICAgICAgIGV4dHMuVkJfU0NSSVBUX1BPU1RGSVgsDQogICAgICAgICAgICAgICAgZXh0cy5SVUJZX1NDUklQVF9QT1NURklYLA0KICAgICAgICAgICAgICAgIGV4dHMuRFlOQU1PX1NDUklQVF9QT1NURklYLA0KICAgICAgICAgICAgICAgIGV4dHMuR1JBU1NIT1BQRVJfU0NSSVBUX1BPU1RGSVgsDQogICAgICAgICAgICAgICAgZXh0cy5HUkFTU0hPUFBFUlhfU0NSSVBUX1BPU1RGSVgsDQogICAgICAgICAgICAgICAgXSkNCg0KICAgICAgICBpZiBzZWxmLm5lZWRzX3NjcmlwdCBhbmQgbm90IHNlbGYuc2NyaXB0X2ZpbGU6DQogICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCdDb21tYW5kICVzOiBEb2VzIG5vdCBoYXZlIHNjcmlwdCBmaWxlLicsIHNlbGYpDQoNCiAgICAgICAgIyBpZiBweXRob24NCiAgICAgICAgaWYgc2VsZi5zY3JpcHRfbGFuZ3VhZ2UgPT0gZXh0cy5QWVRIT05fTEFORzoNCiAgICAgICAgICAgICMgYWxsb3cgcHl0aG9uIHRvb2xzIHRvIGxvYWQgc2lkZSBzY3JpcHRzDQogICAgICAgICAgICBzZWxmLmFkZF9tb2R1bGVfcGF0aChzZWxmLmRpcmVjdG9yeSkNCiAgICAgICAgICAgICMgcmVhZCB0aGUgbWV0YWRhdGEgZnJvbSBweXRob24gc2NyaXB0IGlmIG5vdCBtZXRhZGF0YSBmaWxlDQogICAgICAgICAgICBpZiBub3Qgc2VsZi5tZXRhIGFuZCBub3Qgc2VsZi5pc19jcHl0aG9uOg0KICAgICAgICAgICAgICAgICMgc2V0cyB1cCBzZWxmLm1ldGEgZnJvbSBzY3JpcHQgZ2xvYmFsIHZhcmlhYmxlcw0KICAgICAgICAgICAgICAgIHNlbGYuX3JlYWRfYnVuZGxlX21ldGFkYXRhX2Zyb21fcHl0aG9uX3NjcmlwdCgpDQoNCiAgICAgICAgIyBmaW5kIGNvbmZpZyBzY3JpcHRzDQogICAgICAgIHNlbGYuY29uZmlnX3NjcmlwdF9maWxlID0gXA0KICAgICAgICAgICAgc2VsZi5maW5kX2J1bmRsZV9maWxlKFsNCiAgICAgICAgICAgICAgICBleHRzLlBZVEhPTl9DT05GSUdfU0NSSVBUX1BPU1RGSVgsDQogICAgICAgICAgICAgICAgZXh0cy5DU0hBUlBfQ09ORklHX1NDUklQVF9QT1NURklYLA0KICAgICAgICAgICAgICAgIGV4dHMuVkJfQ09ORklHX1NDUklQVF9QT1NURklYLA0KICAgICAgICAgICAgICAgIGV4dHMuUlVCWV9DT05GSUdfU0NSSVBUX1BPU1RGSVgsDQogICAgICAgICAgICAgICAgZXh0cy5EWU5BTU9fQ09ORklHX1NDUklQVF9QT1NURklYLA0KICAgICAgICAgICAgICAgIGV4dHMuR1JBU1NIT1BQRVJfQ09ORklHX1NDUklQVF9QT1NURklYLA0KICAgICAgICAgICAgICAgIGV4dHMuR1JBU1NIT1BQRVJYX0NPTkZJR19TQ1JJUFRfUE9TVEZJWCwNCiAgICAgICAgICAgICAgICBdKQ0KDQogICAgICAgIGlmIG5vdCBzZWxmLmNvbmZpZ19zY3JpcHRfZmlsZToNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoDQogICAgICAgICAgICAgICAgJ0NvbW1hbmQgJXM6IERvZXMgbm90IGhhdmUgaW5kZXBlbmRlbnQgY29uZmlnIHNjcmlwdC4nLA0KICAgICAgICAgICAgICAgIHNlbGYpDQogICAgICAgICAgICBzZWxmLmNvbmZpZ19zY3JpcHRfZmlsZSA9IHNlbGYuc2NyaXB0X2ZpbGUNCg0KICAgIGRlZiBfcmVhZF9idW5kbGVfbWV0YWRhdGEoc2VsZik6DQogICAgICAgICMgdXNpbmcgY2xhc3NuYW1lIG90aGVyd2lzZSBleGNlcHRpb25zIGluIHN1cGVyY2xhc3NlcyB3b24ndCBzaG93DQogICAgICAgIEdlbmVyaWNVSUNvbXBvbmVudC5fcmVhZF9idW5kbGVfbWV0YWRhdGEoc2VsZikNCiAgICAgICAgIyBkZXRlcm1pbmUgZW5naW5lIGNvbmZpZ3MNCiAgICAgICAgaWYgZXh0cy5NREFUQV9FTkdJTkUgaW4gc2VsZi5tZXRhOg0KICAgICAgICAgICAgc2VsZi5yZXF1aXJlc19jbGVhbl9lbmdpbmUgPSBcDQogICAgICAgICAgICAgICAgc2VsZi5tZXRhW2V4dHMuTURBVEFfRU5HSU5FXS5nZXQoDQogICAgICAgICAgICAgICAgICAgIGV4dHMuTURBVEFfRU5HSU5FX0NMRUFOLCAnZmFsc2UnKS5sb3dlcigpID09ICd0cnVlJw0KICAgICAgICAgICAgc2VsZi5yZXF1aXJlc19mdWxsZnJhbWVfZW5naW5lID0gXA0KICAgICAgICAgICAgICAgIHNlbGYubWV0YVtleHRzLk1EQVRBX0VOR0lORV0uZ2V0KA0KICAgICAgICAgICAgICAgICAgICBleHRzLk1EQVRBX0VOR0lORV9GVUxMRlJBTUUsICdmYWxzZScpLmxvd2VyKCkgPT0gJ3RydWUnDQogICAgICAgICAgICBzZWxmLnJlcXVpcmVzX3BlcnNpc3RlbnRfZW5naW5lID0gXA0KICAgICAgICAgICAgICAgIHNlbGYubWV0YVtleHRzLk1EQVRBX0VOR0lORV0uZ2V0KA0KICAgICAgICAgICAgICAgICAgICBleHRzLk1EQVRBX0VOR0lORV9QRVJTSVNURU5ULCAnZmFsc2UnKS5sb3dlcigpID09ICd0cnVlJw0KDQogICAgICAgICAgICAjIGRldGVybWluZSBpZiBlbmdpbmUgaXMgcmVxdWlyZWQgdG8gcnVuIG9uIG1haW4gdGhyZWFkDQogICAgICAgICAgICAjIE1EQVRBX0VOR0lORV9NQUlOVEhSRUFEIGlzIHRoZSBnZW5lcmljIG9wdGlvbg0KICAgICAgICAgICAgcm1lID0gc2VsZi5tZXRhW2V4dHMuTURBVEFfRU5HSU5FXS5nZXQoDQogICAgICAgICAgICAgICAgZXh0cy5NREFUQV9FTkdJTkVfTUFJTlRIUkVBRCwgJ2ZhbHNlJykgPT0gJ3RydWUnDQogICAgICAgICAgICAjIE1EQVRBX0VOR0lORV9EWU5BTU9fQVVUT01BVEUgaXMgc3BlY2lmaWMgbmFtaW5nIGZvciBkeW5hbW8NCiAgICAgICAgICAgIGF1dG9tYXRlID0gc2VsZi5tZXRhW2V4dHMuTURBVEFfRU5HSU5FXS5nZXQoDQogICAgICAgICAgICAgICAgZXh0cy5NREFUQV9FTkdJTkVfRFlOQU1PX0FVVE9NQVRFLCAnZmFsc2UnKSA9PSAndHJ1ZScNCiAgICAgICAgICAgIHNlbGYucmVxdWlyZXNfbWFpbnRocmVhZF9lbmdpbmUgPSBybWUgb3IgYXV0b21hdGUNCg0KICAgICAgICAgICAgIyBwcm9jZXNzIGVuZ2luZSBvcHRpb25zIHNwZWNpZmljIHRvIGR5bmFtbw0KICAgICAgICAgICAgc2VsZi5keW5hbW9fcGF0aCA9IFwNCiAgICAgICAgICAgICAgICBzZWxmLm1ldGFbZXh0cy5NREFUQV9FTkdJTkVdLmdldCgNCiAgICAgICAgICAgICAgICAgICAgZXh0cy5NREFUQV9FTkdJTkVfRFlOQU1PX1BBVEgsIE5vbmUpDQogICAgICAgICAgICAjIHNlbGYuZHluYW1vX3BhdGhfZXhlYyA9IFwNCiAgICAgICAgICAgICMgICAgIHNlbGYubWV0YVtleHRzLk1EQVRBX0VOR0lORV0uZ2V0KA0KICAgICAgICAgICAgIyAgICAgICAgIGV4dHMuTURBVEFfRU5HSU5FX0RZTkFNT19QQVRIX0VYRUMsICd0cnVlJykgPT0gJ3RydWUnDQogICAgICAgICAgICBzZWxmLmR5bmFtb19wYXRoX2NoZWNrX2V4aXN0aW5nID0gXA0KICAgICAgICAgICAgICAgIHNlbGYubWV0YVtleHRzLk1EQVRBX0VOR0lORV0uZ2V0KA0KICAgICAgICAgICAgICAgICAgICBleHRzLk1EQVRBX0VOR0lORV9EWU5BTU9fUEFUSF9DSEVDS19FWElTVCwNCiAgICAgICAgICAgICAgICAgICAgJ2ZhbHNlJykgPT0gJ3RydWUnDQogICAgICAgICAgICBzZWxmLmR5bmFtb19mb3JjZV9tYW51YWxfcnVuID0gXA0KICAgICAgICAgICAgICAgIHNlbGYubWV0YVtleHRzLk1EQVRBX0VOR0lORV0uZ2V0KA0KICAgICAgICAgICAgICAgICAgICBleHRzLk1EQVRBX0VOR0lORV9EWU5BTU9fRk9SQ0VfTUFOVUFMX1JVTiwNCiAgICAgICAgICAgICAgICAgICAgJ2ZhbHNlJykgPT0gJ3RydWUnDQogICAgICAgICAgICBzZWxmLmR5bmFtb19tb2RlbF9ub2Rlc19pbmZvID0gXA0KICAgICAgICAgICAgICAgIHNlbGYubWV0YVtleHRzLk1EQVRBX0VOR0lORV0uZ2V0KA0KICAgICAgICAgICAgICAgICAgICBleHRzLk1EQVRBX0VOR0lORV9EWU5BTU9fTU9ERUxfTk9ERVNfSU5GTywgTm9uZSkNCg0KICAgICAgICAjIHBhbmVsIGJ1dHRvbnMgc2hvdWxkIGJlIGFjdGl2ZSBhbHdheXMNCiAgICAgICAgaWYgc2VsZi50eXBlX2lkID09IGV4dHMuUEFORUxfUFVTSF9CVVRUT05fUE9TVEZJWDoNCiAgICAgICAgICAgIHNlbGYuY29udGV4dCA9IHNlbGYuX3BhcnNlX2NvbnRleHRfZGlyZWN0aXZlcyhleHRzLkNUWF9aRVJPRE9DKQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gXA0KICAgICAgICAgICAgICAgIHNlbGYubWV0YS5nZXQoZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFQsIE5vbmUpDQogICAgICAgICAgICBpZiBzZWxmLmNvbnRleHQ6DQogICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gc2VsZi5fcGFyc2VfY29udGV4dF9kaXJlY3RpdmVzKHNlbGYuY29udGV4dCkNCg0KICAgIGRlZiBfcGFyc2VfY29udGV4dF9saXN0KHNlbGYsIGNvbnRleHQpOg0KICAgICAgICBjb250ZXh0X3J1bGVzID0gW10NCg0KICAgICAgICBzdHJfaXRlbXMgPSBbeCBmb3IgeCBpbiBjb250ZXh0IGlmIGlzaW5zdGFuY2UoeCwgc3RyKV0NCiAgICAgICAgY29udGV4dF9ydWxlcy5hcHBlbmQoDQogICAgICAgICAgICBleHRzLk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9SVUxFLmZvcm1hdCgNCiAgICAgICAgICAgICAgICBydWxlPWV4dHMuTURBVEFfQ09NTUFORF9DT05URVhUX0FMTF9TRVAuam9pbihzdHJfaXRlbXMpDQogICAgICAgICAgICAgICAgKQ0KICAgICAgICApDQoNCiAgICAgICAgZGljdF9pdGVtcyA9IFt4IGZvciB4IGluIGNvbnRleHQgaWYgaXNpbnN0YW5jZSh4LCBkaWN0KV0NCiAgICAgICAgZm9yIGRpdGVtIGluIGRpY3RfaXRlbXM6DQogICAgICAgICAgICBjb250ZXh0X3J1bGVzLmV4dGVuZChzZWxmLl9wYXJzZV9jb250ZXh0X2RpY3QoZGl0ZW0pKQ0KDQogICAgICAgIHJldHVybiBjb250ZXh0X3J1bGVzDQoNCiAgICBkZWYgX3BhcnNlX2NvbnRleHRfZGljdChzZWxmLCBjb250ZXh0KToNCiAgICAgICAgY29udGV4dF9ydWxlcyA9IFtdDQogICAgICAgIGZvciBjdHhfa2V5LCBjdHhfdmFsdWUgaW4gY29udGV4dC5pdGVtcygpOg0KICAgICAgICAgICAgaWYgY3R4X2tleSA9PSBleHRzLk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9UWVBFOg0KICAgICAgICAgICAgICAgIGNvbnRleHRfdHlwZSA9ICgNCiAgICAgICAgICAgICAgICAgICAgZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFRfQU5ZX1NFUA0KICAgICAgICAgICAgICAgICAgICBpZiBjdHhfdmFsdWUgPT0gZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFRfQU5ZDQogICAgICAgICAgICAgICAgICAgIGVsc2UgZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFRfQUxMX1NFUA0KICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgICBjb250aW51ZQ0KDQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGN0eF92YWx1ZSwgc3RyKToNCiAgICAgICAgICAgICAgICBjdHhfdmFsdWUgPSBbY3R4X3ZhbHVlXQ0KDQogICAgICAgICAgICBrZXkgPSBjdHhfa2V5Lmxvd2VyKCkNCiAgICAgICAgICAgIGNvbmRpdGlvbiA9ICIiDQogICAgICAgICAgICAjIGFsbA0KICAgICAgICAgICAgaWYga2V5ID09IGV4dHMuTURBVEFfQ09NTUFORF9DT05URVhUX0FMTCBcDQogICAgICAgICAgICAgICAgICAgIG9yIGtleSA9PSBleHRzLk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9OT1RBTEw6DQogICAgICAgICAgICAgICAgY29uZGl0aW9uID0gZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFRfQUxMX1NFUA0KDQogICAgICAgICAgICAjIGFueQ0KICAgICAgICAgICAgZWxpZiBrZXkgPT0gZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFRfQU5ZIFwNCiAgICAgICAgICAgICAgICAgICAgb3Iga2V5ID09IGV4dHMuTURBVEFfQ09NTUFORF9DT05URVhUX05PVEFOWToNCiAgICAgICAgICAgICAgICBjb25kaXRpb24gPSBleHRzLk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9BTllfU0VQDQoNCiAgICAgICAgICAgICMgZXhjZXB0DQogICAgICAgICAgICBlbGlmIGtleSA9PSBleHRzLk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9FWEFDVCBcDQogICAgICAgICAgICAgICAgICAgIG9yIGtleSA9PSBleHRzLk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9OT1RFWEFDVDoNCiAgICAgICAgICAgICAgICBjb25kaXRpb24gPSBleHRzLk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9FWEFDVF9TRVANCg0KICAgICAgICAgICAgY29udGV4dCA9IGNvbmRpdGlvbi5qb2luKA0KICAgICAgICAgICAgICAgIFt4IGZvciB4IGluIGN0eF92YWx1ZSBpZiBpc2luc3RhbmNlKHgsIHN0cildDQogICAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgZm9ybWF0dGVkX3J1bGUgPSBcDQogICAgICAgICAgICAgICAgZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFRfUlVMRS5mb3JtYXQocnVsZT1jb250ZXh0KQ0KICAgICAgICAgICAgaWYga2V5LnN0YXJ0c3dpdGgoZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFRfTk9UKToNCiAgICAgICAgICAgICAgICBmb3JtYXR0ZWRfcnVsZSA9ICIhIiArIGZvcm1hdHRlZF9ydWxlDQogICAgICAgICAgICBjb250ZXh0X3J1bGVzLmFwcGVuZChmb3JtYXR0ZWRfcnVsZSkNCiAgICAgICAgcmV0dXJuIGNvbnRleHRfcnVsZXMNCg0KICAgIGRlZiBfcGFyc2VfY29udGV4dF9kaXJlY3RpdmVzKHNlbGYsIGNvbnRleHQpOg0KICAgICAgICBjb250ZXh0X3J1bGVzID0gW10NCg0KICAgICAgICBpZiBpc2luc3RhbmNlKGNvbnRleHQsIHN0cik6DQogICAgICAgICAgICBjb250ZXh0X3J1bGVzLmFwcGVuZCgNCiAgICAgICAgICAgICAgICBleHRzLk1EQVRBX0NPTU1BTkRfQ09OVEVYVF9SVUxFLmZvcm1hdChydWxlPWNvbnRleHQpDQogICAgICAgICAgICApDQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShjb250ZXh0LCBsaXN0KToNCiAgICAgICAgICAgIGNvbnRleHRfcnVsZXMuZXh0ZW5kKHNlbGYuX3BhcnNlX2NvbnRleHRfbGlzdChjb250ZXh0KSkNCg0KICAgICAgICBlbGlmIGlzaW5zdGFuY2UoY29udGV4dCwgZGljdCk6DQogICAgICAgICAgICBpZiAicnVsZSIgaW4gY29udGV4dDoNCiAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dFsicnVsZSJdDQogICAgICAgICAgICBjb250ZXh0X3J1bGVzLmV4dGVuZChzZWxmLl9wYXJzZV9jb250ZXh0X2RpY3QoY29udGV4dCkpDQoNCiAgICAgICAgY29udGV4dF90eXBlID0gZXh0cy5NREFUQV9DT01NQU5EX0NPTlRFWFRfQUxMX1NFUA0KICAgICAgICByZXR1cm4gY29udGV4dF90eXBlLmpvaW4oY29udGV4dF9ydWxlcykNCg0KICAgIGRlZiBfcmVhZF9idW5kbGVfbWV0YWRhdGFfZnJvbV9weXRob25fc2NyaXB0KHNlbGYpOg0KICAgICAgICB0cnk6DQogICAgICAgICAgICAjIHJlYWRpbmcgc2NyaXB0IGZpbGUgY29udGVudCB0byBleHRyYWN0IHBhcmFtZXRlcnMNCiAgICAgICAgICAgIHNjcmlwdF9jb250ZW50ID0gXA0KICAgICAgICAgICAgICAgIGNvcmV1dGlscy5TY3JpcHRGaWxlUGFyc2VyKHNlbGYuc2NyaXB0X2ZpbGUpDQoNCiAgICAgICAgICAgIHNlbGYuX3VpX3RpdGxlID0gXA0KICAgICAgICAgICAgICAgIHNjcmlwdF9jb250ZW50LmV4dHJhY3RfcGFyYW0oZXh0cy5VSV9USVRMRV9QQVJBTSkgXA0KICAgICAgICAgICAgICAgICAgICBvciBzZWxmLl91aV90aXRsZQ0KDQogICAgICAgICAgICBzY3JpcHRfZG9jc3RyaW5nID0gc2NyaXB0X2NvbnRlbnQuZ2V0X2RvY3N0cmluZygpDQogICAgICAgICAgICBjdXN0b21fZG9jc3RyaW5nID0gXA0KICAgICAgICAgICAgICAgIHNjcmlwdF9jb250ZW50LmV4dHJhY3RfcGFyYW0oZXh0cy5ET0NTVFJJTkdfUEFSQU0pDQogICAgICAgICAgICBzZWxmLl90b29sdGlwID0gXA0KICAgICAgICAgICAgICAgIGN1c3RvbV9kb2NzdHJpbmcgb3Igc2NyaXB0X2RvY3N0cmluZyBvciBzZWxmLl90b29sdGlwDQoNCiAgICAgICAgICAgIHNjcmlwdF9hdXRob3IgPSBzY3JpcHRfY29udGVudC5leHRyYWN0X3BhcmFtKGV4dHMuQVVUSE9SX1BBUkFNKQ0KICAgICAgICAgICAgc2NyaXB0X2F1dGhvciA9IHNjcmlwdF9jb250ZW50LmV4dHJhY3RfcGFyYW0oZXh0cy5BVVRIT1JTX1BBUkFNKQ0KICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzY3JpcHRfYXV0aG9yLCBsaXN0KToNCiAgICAgICAgICAgICAgICBzY3JpcHRfYXV0aG9yID0gJ1xuJy5qb2luKHNjcmlwdF9hdXRob3IpDQogICAgICAgICAgICBzZWxmLmF1dGhvciA9IHNjcmlwdF9hdXRob3Igb3Igc2VsZi5hdXRob3INCg0KICAgICAgICAgICAgIyBleHRyYWN0aW5nIG1pbiByZXF1cmllZCBSZXZpdCBhbmQgcHlSZXZpdCB2ZXJzaW9ucw0KICAgICAgICAgICAgc2VsZi5tYXhfcmV2aXRfdmVyID0gXA0KICAgICAgICAgICAgICAgIHNjcmlwdF9jb250ZW50LmV4dHJhY3RfcGFyYW0oZXh0cy5NQVhfUkVWSVRfVkVSU0lPTl9QQVJBTSkgXA0KICAgICAgICAgICAgICAgICAgICBvciBzZWxmLm1heF9yZXZpdF92ZXINCiAgICAgICAgICAgIHNlbGYubWluX3Jldml0X3ZlciA9IFwNCiAgICAgICAgICAgICAgICBzY3JpcHRfY29udGVudC5leHRyYWN0X3BhcmFtKGV4dHMuTUlOX1JFVklUX1ZFUlNJT05fUEFSQU0pIFwNCiAgICAgICAgICAgICAgICAgICAgb3Igc2VsZi5taW5fcmV2aXRfdmVyDQogICAgICAgICAgICBzZWxmLl9oZWxwX3VybCA9IFwNCiAgICAgICAgICAgICAgICBzY3JpcHRfY29udGVudC5leHRyYWN0X3BhcmFtKGV4dHMuQ09NTUFORF9IRUxQX1VSTF9QQVJBTSkgXA0KICAgICAgICAgICAgICAgICAgICBvciBzZWxmLl9oZWxwX3VybA0KDQogICAgICAgICAgICBzZWxmLmlzX2JldGEgPSBcDQogICAgICAgICAgICAgICAgc2NyaXB0X2NvbnRlbnQuZXh0cmFjdF9wYXJhbShleHRzLkJFVEFfU0NSSVBUX1BBUkFNKSBcDQogICAgICAgICAgICAgICAgICAgIG9yIHNlbGYuaXNfYmV0YQ0KDQogICAgICAgICAgICBzZWxmLmhpZ2hsaWdodF90eXBlID0gXA0KICAgICAgICAgICAgICAgIHNjcmlwdF9jb250ZW50LmV4dHJhY3RfcGFyYW0oZXh0cy5ISUdITElHSFRfU0NSSVBUX1BBUkFNKSBcDQogICAgICAgICAgICAgICAgICAgIG9yIHNlbGYuaGlnaGxpZ2h0X3R5cGUNCg0KICAgICAgICAgICAgIyBvbmx5IFRydWUgd2hlbiBjb21tYW5kIGlzIHNwZWNpZmljYWxseSBhc2tpbmcgZm9yDQogICAgICAgICAgICAjIGEgY2xlYW4gZW5naW5lIG9yIGEgZnVsbGZyYW1lIGVuZ2luZS4gRmFsc2UgaWYgbm90IHNldC4NCiAgICAgICAgICAgIHNlbGYucmVxdWlyZXNfY2xlYW5fZW5naW5lID0gXA0KICAgICAgICAgICAgICAgIHNjcmlwdF9jb250ZW50LmV4dHJhY3RfcGFyYW0oZXh0cy5DTEVBTl9FTkdJTkVfU0NSSVBUX1BBUkFNKSBcDQogICAgICAgICAgICAgICAgICAgIG9yIEZhbHNlDQogICAgICAgICAgICBzZWxmLnJlcXVpcmVzX2Z1bGxmcmFtZV9lbmdpbmUgPSBcDQogICAgICAgICAgICAgICAgc2NyaXB0X2NvbnRlbnQuZXh0cmFjdF9wYXJhbShleHRzLkZVTExGUkFNRV9FTkdJTkVfUEFSQU0pIFwNCiAgICAgICAgICAgICAgICAgICAgb3IgRmFsc2UNCiAgICAgICAgICAgIHNlbGYucmVxdWlyZXNfcGVyc2lzdGVudF9lbmdpbmUgPSBcDQogICAgICAgICAgICAgICAgc2NyaXB0X2NvbnRlbnQuZXh0cmFjdF9wYXJhbShleHRzLlBFUlNJU1RFTlRfRU5HSU5FX1BBUkFNKSBcDQogICAgICAgICAgICAgICAgICAgIG9yIEZhbHNlDQoNCiAgICAgICAgICAgICMgcGFuZWwgYnV0dG9ucyBzaG91bGQgYmUgYWN0aXZlIGFsd2F5cw0KICAgICAgICAgICAgaWYgc2VsZi50eXBlX2lkID09IGV4dHMuUEFORUxfUFVTSF9CVVRUT05fUE9TVEZJWDoNCiAgICAgICAgICAgICAgICBzZWxmLmNvbnRleHQgPSBzZWxmLl9wYXJzZV9jb250ZXh0X2RpcmVjdGl2ZXMoZXh0cy5DVFhfWkVST0RPQykNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gXA0KICAgICAgICAgICAgICAgICAgICBzY3JpcHRfY29udGVudC5leHRyYWN0X3BhcmFtKGV4dHMuQ09NTUFORF9DT05URVhUX1BBUkFNKQ0KICAgICAgICAgICAgICAgIGlmIHNlbGYuY29udGV4dDoNCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jb250ZXh0ID0gc2VsZi5fcGFyc2VfY29udGV4dF9kaXJlY3RpdmVzKHNlbGYuY29udGV4dCkNCg0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHBhcnNlX2VycjoNCiAgICAgICAgICAgIG1sb2dnZXIubG9nX3BhcnNlX2V4Y2VwdChzZWxmLnNjcmlwdF9maWxlLCBwYXJzZV9lcnIpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgc2NyaXB0X2xhbmd1YWdlKHNlbGYpOg0KICAgICAgICBpZiBzZWxmLnNjcmlwdF9maWxlIGlzIG5vdCBOb25lOg0KICAgICAgICAgICAgaWYgc2VsZi5zY3JpcHRfZmlsZS5lbmRzd2l0aChleHRzLlBZVEhPTl9TQ1JJUFRfRklMRV9GT1JNQVQpOg0KICAgICAgICAgICAgICAgIHJldHVybiBleHRzLlBZVEhPTl9MQU5HDQogICAgICAgICAgICBlbGlmIHNlbGYuc2NyaXB0X2ZpbGUuZW5kc3dpdGgoZXh0cy5DU0hBUlBfU0NSSVBUX0ZJTEVfRk9STUFUKToNCiAgICAgICAgICAgICAgICByZXR1cm4gZXh0cy5DU0hBUlBfTEFORw0KICAgICAgICAgICAgZWxpZiBzZWxmLnNjcmlwdF9maWxlLmVuZHN3aXRoKGV4dHMuVkJfU0NSSVBUX0ZJTEVfRk9STUFUKToNCiAgICAgICAgICAgICAgICByZXR1cm4gZXh0cy5WQl9MQU5HDQogICAgICAgICAgICBlbGlmIHNlbGYuc2NyaXB0X2ZpbGUuZW5kc3dpdGgoZXh0cy5SVUJZX1NDUklQVF9GSUxFX0ZPUk1BVCk6DQogICAgICAgICAgICAgICAgcmV0dXJuIGV4dHMuUlVCWV9MQU5HDQogICAgICAgICAgICBlbGlmIHNlbGYuc2NyaXB0X2ZpbGUuZW5kc3dpdGgoZXh0cy5EWU5BTU9fU0NSSVBUX0ZJTEVfRk9STUFUKToNCiAgICAgICAgICAgICAgICByZXR1cm4gZXh0cy5EWU5BTU9fTEFORw0KICAgICAgICAgICAgZWxpZiBzZWxmLnNjcmlwdF9maWxlLmVuZHN3aXRoKA0KICAgICAgICAgICAgICAgICAgICBleHRzLkdSQVNTSE9QUEVSX1NDUklQVF9GSUxFX0ZPUk1BVCkgXA0KICAgICAgICAgICAgICAgICAgICBvciBzZWxmLnNjcmlwdF9maWxlLmVuZHN3aXRoKA0KICAgICAgICAgICAgICAgICAgICAgICAgZXh0cy5HUkFTU0hPUFBFUlhfU0NSSVBUX0ZJTEVfRk9STUFUDQogICAgICAgICAgICAgICAgICAgICk6DQogICAgICAgICAgICAgICAgcmV0dXJuIGV4dHMuR1JBU1NIT1BQRVJfTEFORw0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIE5vbmUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBjb250cm9sX2lkKHNlbGYpOg0KICAgICAgICBpZiBzZWxmLnBhcmVudF9jdHJsX2lkOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYucGFyZW50X2N0cmxfaWQgKyAnJXt9Jy5mb3JtYXQoc2VsZi5uYW1lKQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuICcle30nLmZvcm1hdChzZWxmLm5hbWUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgaXNfY3B5dGhvbihzZWxmKToNCiAgICAgICAgd2l0aCBvcGVuKHNlbGYuc2NyaXB0X2ZpbGUsICdyJykgYXMgc2NyaXB0X2Y6DQogICAgICAgICAgICByZXR1cm4gZXh0cy5DUFlUSE9OX0hBU0hCQU5HIGluIHNjcmlwdF9mLnJlYWRsaW5lKCkNCg0KICAgIGRlZiBoYXNfY29uZmlnX3NjcmlwdChzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuY29uZmlnX3NjcmlwdF9maWxlICE9IHNlbGYuc2NyaXB0X2ZpbGUNCg0KIiIiQmFzZSBtb2R1bGUgb2ZyIHBhcnNpbmcgZXh0ZW5zaW9ucy4iIiINCmltcG9ydCBvcw0KaW1wb3J0IG9zLnBhdGggYXMgb3ANCg0KZnJvbSBweXJldml0LmNvcmV1dGlscyBpbXBvcnQgZ2V0X2FsbF9zdWJjbGFzc2VzDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzLmxvZ2dlciBpbXBvcnQgZ2V0X2xvZ2dlcg0KDQoNCiNweWxpbnQ6IGRpc2FibGU9VzA3MDMsQzAzMDIsQzAxMDMNCm1sb2dnZXIgPSBnZXRfbG9nZ2VyKF9fbmFtZV9fKQ0KDQoNCmRlZiBfZ2V0X2Rpc2NvdmVyZWRfY29tcHMoY29tcF9wYXRoLCBjbXBfdHlwZXNfbGlzdCk6DQogICAgZGlzY292ZXJlZF9jbXBzID0gW10NCiAgICBtbG9nZ2VyLmRlYnVnKCdUZXN0aW5nIF9nZXRfY29tcG9uZW50KHMpIG9uOiAlcyAnLCBjb21wX3BhdGgpDQogICAgIyBjb21wX3BhdGggbWlnaHQgYmUgYSBmaWxlIG9yIGEgZGlyLA0KICAgICMgYnV0IGl0cyBuYW1lIHNob3VsZCBub3Qgc3RhcnQgd2l0aCAuIG9yIF86DQogICAgZm9yIGNtcF90eXBlIGluIGNtcF90eXBlc19saXN0Og0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdUZXN0aW5nIHN1Yl9kaXJlY3RvcnkgJXMgZm9yICVzJywgY29tcF9wYXRoLCBjbXBfdHlwZSkNCiAgICAgICAgIyBpZiBjbXBfY2xhc3MgY2FuIGJlIGNyZWF0ZWQgZm9yIHRoaXMgc3ViLWRpciwgdGhlIGFkZCB0byBsaXN0DQogICAgICAgIGlmIGNtcF90eXBlLm1hdGNoZXMoY29tcF9wYXRoKToNCiAgICAgICAgICAgIGNvbXBvbmVudCA9IGNtcF90eXBlKGNtcF9wYXRoPWNvbXBfcGF0aCkNCiAgICAgICAgICAgIGRpc2NvdmVyZWRfY21wcy5hcHBlbmQoY29tcG9uZW50KQ0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnU3VjY2Vzc2Z1bHkgY3JlYXRlZCBjb21wb25lbnQ6ICVzIGZyb206ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50LCBjb21wX3BhdGgpDQoNCiAgICByZXR1cm4gZGlzY292ZXJlZF9jbXBzDQoNCg0KZGVmIF9jcmVhdGVfc3ViY29tcG9uZW50cyhzZWFyY2hfZGlyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICBjbXBfdHlwZXNfbGlzdCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlX2Zyb21fc2VhcmNoX2Rpcj1GYWxzZSk6DQogICAgIiIiUmV0dXJucyB0aGUgb2JqZWN0cyBpbiBzZWFyY2hfZGlyIG9mIHRoZSB0eXBlcyBpbiBjbXBfdHlwZXNfbGlzdC4NCg0KICAgIEFyZ3VtZW50czoNCiAgICAgICAgc2VhcmNoX2RpciAoc3RyKTogZGlyZWN0b3J5IHRvIHBhcnNlDQogICAgICAgIGNtcF90eXBlc19saXN0OiBUaGlzIG1ldGhvZHMgY2hlY2tzIHRoZSBzdWJmb2xkZXJzIGluIHNlYXJjaF9kaXINCiAgICAgICAgICAgIGFnYWluc3QgdGhlIF9nZXRfY29tcG9uZW50IHR5cGVzIHByb3ZpZGVkIGluIHRoaXMgbGlzdC4NCiAgICAgICAgY3JlYXRlX2Zyb21fc2VhcmNoX2RpciAoYm9vbCwgb3B0aW9uYWwpOiB3aGV0aGVyIHRvIGNyZWF0ZSB0aGUgX2dldF9jb21wb25lbnQgb2JqZWN0cywgZGVmYXVsdCB0byBGYWxzZQ0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBfY3JlYXRlX3N1YmNvbXBvbmVudHMoc2VhcmNoX2RpciwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtMaW5rQnV0dG9uLCBQdXNoQnV0dG9uLCBvciBUb2dnbGVCdXR0b25dKQ0KICAgICAgICBgYGANCiAgICAgICAgdGhpcyBtZXRob2QgY3JlYXRlcyBMaW5rQnV0dG9uLCBQdXNoQnV0dG9uLCBvciBUb2dnbGVCdXR0b24gZm9yDQogICAgICAgIHRoZSBwYXJzZWQgc3ViLWRpcmVjdG9yaWVzIHVuZGVyIHNlYXJjaF9kaXIgd2l0aCBtYXRjaGluZyAudHlwZV9pZA0KICAgICAgICBpZGVudGlmaWVycyBpbiB0aGVpciBuYW1lcy4gKGUuZy4gImZvbGRlci5MSU5LX0JVVFRPTl9QT1NURklYIikNCg0KICAgIFJldHVybnM6DQogICAgICAgIGxpc3Qgb2YgY3JlYXRlZCBjbGFzc2VzIG9mIHR5cGVzIHByb3ZpZGVkIGluIGNtcF90eXBlc19saXN0DQogICAgIiIiDQogICAgc3ViX2NtcF9saXN0ID0gW10NCg0KICAgIGlmIG5vdCBjcmVhdGVfZnJvbV9zZWFyY2hfZGlyOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdTZWFyY2hpbmcgZGlyZWN0b3J5OiAlcyBmb3IgY29tcG9uZW50cyBvZiB0eXBlOiAlcycsDQogICAgICAgICAgICAgICAgICAgICAgc2VhcmNoX2RpciwgY21wX3R5cGVzX2xpc3QpDQogICAgICAgIGZvciBmaWxlX29yX2RpciBpbiBvcy5saXN0ZGlyKHNlYXJjaF9kaXIpOg0KICAgICAgICAgICAgZnVsbF9wYXRoID0gb3Auam9pbihzZWFyY2hfZGlyLCBmaWxlX29yX2RpcikNCiAgICAgICAgICAgIGlmIG5vdCBmaWxlX29yX2Rpci5zdGFydHN3aXRoKCgnLicsICdfJykpOg0KICAgICAgICAgICAgICAgIHN1Yl9jbXBfbGlzdC5leHRlbmQoX2dldF9kaXNjb3ZlcmVkX2NvbXBzKGZ1bGxfcGF0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbXBfdHlwZXNfbGlzdCkpDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ1NraXBwaW5nIF9nZXRfY29tcG9uZW50LiAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnTmFtZSBjYW4gbm90IHN0YXJ0IHdpdGggLiBvciBfOiAlcycsIGZ1bGxfcGF0aCkNCiAgICBlbHNlOg0KICAgICAgICBzdWJfY21wX2xpc3QuZXh0ZW5kKF9nZXRfZGlzY292ZXJlZF9jb21wcyhzZWFyY2hfZGlyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbXBfdHlwZXNfbGlzdCkpDQoNCiAgICByZXR1cm4gc3ViX2NtcF9saXN0DQoNCg0KZGVmIF9nZXRfc3ViY29tcG9uZW50c19jbGFzc2VzKHBhcmVudF9jbGFzc2VzKToNCiAgICAiIiJGaW5kIGF2YWlsYWJsZSBzdWJjb21wb25lbnRzIGZvciBnaXZlbiBwYXJlbnQgdHlwZXMuIiIiDQogICAgcmV0dXJuIFt4IGZvciB4IGluIGdldF9hbGxfc3ViY2xhc3NlcyhwYXJlbnRfY2xhc3NlcykgaWYgeC50eXBlX2lkXQ0KDQoNCmRlZiBfcGFyc2VfZm9yX2NvbXBvbmVudHMoY29tcG9uZW50KToNCiAgICAiIiJSZWN1cnNpdmVseSBwYXJzZXMgdGhlIGNvbXBvbmVudCBkaXJlY3RvcnkgZm9yIGFsbG93ZWQgY29tcG9uZW50cyB0eXBlLg0KDQogICAgVGhpcyBtZXRob2QgdXNlcyBnZXRfYWxsX3N1YmNsYXNzZXMoKSB0byBnZXQgYSBsaXN0IG9mIGFsbCBzdWJjbGFzc2VzDQogICAgb2YgX2dldF9jb21wb25lbnQuYWxsb3dlZF9zdWJfY21wcyB0eXBlLg0KICAgIFRoaXMgZW5zdXJlcyB0aGF0IGlmIGFueSBuZXcgdHlwZSBvZiBjb21wb25lbnRfY2xhc3MgaXMgYWRkZWQgbGF0ZXIsDQogICAgdGhpcyBtZXRob2QgZG9lcyBub3QgbmVlZCB0byBiZSB1cGRhdGVkIGFzIHRoZSBuZXcgc3ViLWNsYXNzIHdpbGwgYmUNCiAgICBsaXN0ZWQgYnkgLl9fc3ViY2xhc3Nlc19fKCkgbWV0aG9kIG9mIHRoZSBwYXJlbnQgY2xhc3MgYW5kIHRoaXMgbWV0aG9kDQogICAgd2lsbCBjaGVjayB0aGUgZGlyZWN0b3J5IGZvciBpdHMgLnR5cGVfaWQuDQogICAgIiIiDQogICAgZm9yIG5ld19jbXAgaW4gX2NyZWF0ZV9zdWJjb21wb25lbnRzKA0KICAgICAgICAgICAgY29tcG9uZW50LmRpcmVjdG9yeSwNCiAgICAgICAgICAgIF9nZXRfc3ViY29tcG9uZW50c19jbGFzc2VzKGNvbXBvbmVudC5hbGxvd2VkX3N1Yl9jbXBzKSk6DQogICAgICAgICMgYWRkIHRoZSBzdWNjZXNzZnVseWwgY3JlYXRlZCBfZ2V0X2NvbXBvbmVudCB0byB0aGUNCiAgICAgICAgIyBwYXJlbnQgX2dldF9jb21wb25lbnQNCiAgICAgICAgY29tcG9uZW50LmFkZF9jb21wb25lbnQobmV3X2NtcCkNCiAgICAgICAgaWYgbmV3X2NtcC5pc19jb250YWluZXI6DQogICAgICAgICAgICAjIFJlY3Vyc2l2ZSBwYXJ0OiBwYXJzZSBlYWNoIHN1Yi1fZ2V0X2NvbXBvbmVudA0KICAgICAgICAgICAgIyBmb3IgaXRzIGFsbG93ZWQgc3ViLXN1Yi1jb21wb25lbnRzLg0KICAgICAgICAgICAgX3BhcnNlX2Zvcl9jb21wb25lbnRzKG5ld19jbXApDQoNCg0KZGVmIHBhcnNlX2NvbXBfZGlyKGNvbXBfcGF0aCwgY29tcF9jbGFzcyk6DQogICAgcmV0dXJuIF9jcmVhdGVfc3ViY29tcG9uZW50cygNCiAgICAgICAgY29tcF9wYXRoLA0KICAgICAgICBfZ2V0X3N1YmNvbXBvbmVudHNfY2xhc3NlcyhbY29tcF9jbGFzc10pLA0KICAgICAgICBjcmVhdGVfZnJvbV9zZWFyY2hfZGlyPVRydWUNCiAgICAgICAgKQ0KDQoNCmRlZiBnZXRfcGFyc2VkX2V4dGVuc2lvbihleHRlbnNpb24pOg0KICAgICIiIkNyZWF0ZXMgYW5kIGFkZHMgdGhlIGV4dGVuc2lvbnMgY29tcG9uZW50cyB0byB0aGUgcGFja2FnZS4NCg0KICAgIEVhY2ggcGFja2FnZSBvYmplY3QgaXMgdGhlIHJvb3QgdG8gYSB0cmVlIG9mIGNvbXBvbmVudHMgdGhhdCBleGlzdHMNCiAgICB1bmRlciB0aGF0IHBhY2thZ2UuIChlLmcuIHRhYnMsIGJ1dHRvbnMsIC4uLikgc3ViIGNvbXBvbmVudHMgb2YgcGFja2FnZQ0KICAgIGNhbiBiZSBhY2Nlc3NlZCBieSBpdGVyYXRpbmcgdGhlIF9nZXRfY29tcG9uZW50Lg0KICAgIFNlZSBfYmFzZWNvbXBvbmVudHMgZm9yIHR5cGVzLg0KICAgICIiIg0KICAgIF9wYXJzZV9mb3JfY29tcG9uZW50cyhleHRlbnNpb24pDQogICAgcmV0dXJuIGV4dGVuc2lvbg0KDQoNCmRlZiBwYXJzZV9kaXJfZm9yX2V4dF90eXBlKHJvb3RfZGlyLCBwYXJlbnRfY21wX3R5cGUpOg0KICAgICIiIlJldHVybiB0aGUgb2JqZWN0cyBvZiB0eXBlIHBhcmVudF9jbXBfdHlwZSBvZiB0aGUgZXh0ZW5zaW9ucyBpbiByb290X2Rpci4NCg0KICAgIFRoZSBwYWNrYWdlIG9iamVjdHMgd29uJ3QgYmUgcGFyc2VkIGF0IHRoaXMgbGV2ZWwuDQogICAgVGhpcyBpcyB1c2VmdWwgZm9yIGNvbGxlY3RpbmcgYmFzaWMgaW5mbyBvbiBhbiBleHRlbnNpb24gdHlwZQ0KICAgIGZvciBjYWNoZSBjaGVjaGluZyBvciB1cGRhdGluZyBleHRlbnNpb25zIHVzaW5nIHRoZWlyIGRpcmVjdG9yeSBwYXRocy4NCg0KICAgIEFyZ3M6DQogICAgICAgIHJvb3RfZGlyIChzdHIpOiBkaXJlY3RvcnkgdG8gcGFyc2UNCiAgICAgICAgcGFyZW50X2NtcF90eXBlICh0eXBlKTogdHlwZSBvZiBvYmplY3RzIHRvIHJldHVybg0KICAgICIiIg0KICAgICMgbWFraW5nIHN1cmUgdGhlIHByb3ZpZGVkIGRpcmVjdG9yeSBleGlzdHMuDQogICAgIyBUaGlzIGlzIG1haW5seSBmb3IgdGhlIHVzZXIgZGVmaW5lZCBwYWNrYWdlIGRpcmVjdG9yaWVzDQogICAgaWYgbm90IG9wLmV4aXN0cyhyb290X2Rpcik6DQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0V4dGVuc2lvbiBzZWFyY2ggZGlyZWN0b3J5IGRvZXMgbm90IGV4aXN0OiAlcycsIHJvb3RfZGlyKQ0KICAgICAgICByZXR1cm4gW10NCg0KICAgICMgdHJ5IGNyZWF0aW5nIGV4dGVuc2lvbnMgaW4gZ2l2ZW4gZGlyZWN0b3J5DQogICAgZXh0X2RhdGFfbGlzdCA9IFtdDQoNCiAgICBtbG9nZ2VyLmRlYnVnKCdQYXJzaW5nIGRpcmVjdG9yeSBmb3IgZXh0ZW5zaW9ucyBvZiB0eXBlOiAlcycsDQogICAgICAgICAgICAgICAgICBwYXJlbnRfY21wX3R5cGUpDQogICAgZm9yIGV4dF9kYXRhIGluIF9jcmVhdGVfc3ViY29tcG9uZW50cyhyb290X2RpciwgW3BhcmVudF9jbXBfdHlwZV0pOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdFeHRlbnNpb24gZGlyZWN0b3J5IGZvdW5kOiAlcycsIGV4dF9kYXRhKQ0KICAgICAgICBleHRfZGF0YV9saXN0LmFwcGVuZChleHRfZGF0YSkNCg0KICAgIHJldHVybiBleHRfZGF0YV9saXN0DQoNCiIiIkJhc2UgY2xhc3NlcyBmb3IgcHlSZXZpdCBleHRlbnNpb24gY29tcG9uZW50cy4iIiINCmltcG9ydCBvcw0KaW1wb3J0IG9zLnBhdGggYXMgb3ANCmltcG9ydCBqc29uDQppbXBvcnQgY29kZWNzDQoNCmZyb20gcHlyZXZpdCBpbXBvcnQgUHlSZXZpdEV4Y2VwdGlvbiwgSE9TVF9BUFANCmZyb20gcHlyZXZpdC5jb21wYXQgaW1wb3J0IHNhZmVfc3RydHlwZQ0KZnJvbSBweXJldml0IGltcG9ydCBmcmFtZXdvcmsNCmZyb20gcHlyZXZpdCBpbXBvcnQgY29yZXV0aWxzDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzLmxvZ2dlciBpbXBvcnQgZ2V0X2xvZ2dlcg0KaW1wb3J0IHB5cmV2aXQuZXh0ZW5zaW9ucyBhcyBleHRzDQpmcm9tIHB5cmV2aXQuZXh0ZW5zaW9ucy5nZW5lcmljY29tcHMgaW1wb3J0IEdlbmVyaWNDb21wb25lbnQNCmZyb20gcHlyZXZpdC5leHRlbnNpb25zLmdlbmVyaWNjb21wcyBpbXBvcnQgR2VuZXJpY1VJQ29udGFpbmVyDQpmcm9tIHB5cmV2aXQuZXh0ZW5zaW9ucy5nZW5lcmljY29tcHMgaW1wb3J0IEdlbmVyaWNVSUNvbW1hbmQNCmZyb20gcHlyZXZpdCBpbXBvcnQgdmVyc2lvbm1ncg0KDQoNCiNweWxpbnQ6IGRpc2FibGU9VzA3MDMsQzAzMDIsQzAxMDMNCm1sb2dnZXIgPSBnZXRfbG9nZ2VyKF9fbmFtZV9fKQ0KDQoNCkVYVF9IQVNIX1ZBTFVFX0tFWSA9ICdkaXJfaGFzaF92YWx1ZScNCkVYVF9IQVNIX1ZFUlNJT05fS0VZID0gJ3B5cnZ0X3ZlcnNpb24nDQoNCg0KIyBEZXJpdmVkIGNsYXNzZXMgaGVyZSBjb3JyZXNwb25kIHRvIHNpbWlsYXIgZWxlbWVudHMgaW4gUmV2aXQgdWkuDQojIFVuZGVyIFJldml0IFVJOg0KIyBQYWNrYWdlcyBjb250YWluIFRhYnMsIFRhYnMgY29udGFpbiwgUGFuZWxzLCBQYW5lbHMgY29udGFpbiBTdGFja3MsDQojIENvbW1hbmRzLCBvciBDb21tYW5kIGdyb3Vwcw0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCmNsYXNzIE5vQnV0dG9uKEdlbmVyaWNVSUNvbW1hbmQpOg0KICAgICIiIlRoaXMgaXMgbm90IGEgYnV0dG9uLiIiIg0KICAgIHR5cGVfaWQgPSBleHRzLk5PR1VJX0NPTU1BTkRfUE9TVEZJWA0KDQoNCmNsYXNzIE5vU2NyaXB0QnV0dG9uKEdlbmVyaWNVSUNvbW1hbmQpOg0KICAgICIiIkJhc2UgZm9yIGJ1dHRvbnMgdGhhdCBkb2Vzbid0IHJ1biBhIHNjcmlwdC4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgY21wX3BhdGg9Tm9uZSwgbmVlZHNfY29tbWFuZGNsYXNzPUZhbHNlKToNCiAgICAgICAgIyB1c2luZyBjbGFzc25hbWUgb3RoZXJ3aXNlIGV4Y2VwdGlvbnMgaW4gc3VwZXJjbGFzc2VzIHdvbid0IHNob3cNCiAgICAgICAgR2VuZXJpY1VJQ29tbWFuZC5fX2luaXRfXyhzZWxmLCBjbXBfcGF0aD1jbXBfcGF0aCwgbmVlZHNfc2NyaXB0PUZhbHNlKQ0KICAgICAgICBzZWxmLmFzc2VtYmx5ID0gc2VsZi5jb21tYW5kX2NsYXNzID0gc2VsZi5hdmFpbF9jb21tYW5kX2NsYXNzID0gTm9uZQ0KICAgICAgICAjIHJlYWQgbWV0YWRhdGEgZnJvbSBtZXRhZGF0YSBmaWxlDQogICAgICAgIGlmIHNlbGYubWV0YToNCiAgICAgICAgICAgICMgZ2V0IHRoZSB0YXJnZXQgYXNzZW1ibHkgZnJvbSBtZXRhZGF0YQ0KICAgICAgICAgICAgc2VsZi5hc3NlbWJseSA9IFwNCiAgICAgICAgICAgICAgICBzZWxmLm1ldGEuZ2V0KGV4dHMuTURBVEFfTElOS19CVVRUT05fQVNTRU1CTFksIE5vbmUpDQoNCiAgICAgICAgICAgICMgZ2V0IHRoZSB0YXJnZXQgY29tbWFuZCBjbGFzcyBmcm9tIG1ldGFkYXRhDQogICAgICAgICAgICBzZWxmLmNvbW1hbmRfY2xhc3MgPSBcDQogICAgICAgICAgICAgICAgc2VsZi5tZXRhLmdldChleHRzLk1EQVRBX0xJTktfQlVUVE9OX0NPTU1BTkRfQ0xBU1MsIE5vbmUpDQoNCiAgICAgICAgICAgICMgZ2V0IHRoZSB0YXJnZXQgY29tbWFuZCBjbGFzcyBmcm9tIG1ldGFkYXRhDQogICAgICAgICAgICBzZWxmLmF2YWlsX2NvbW1hbmRfY2xhc3MgPSBcDQogICAgICAgICAgICAgICAgc2VsZi5tZXRhLmdldChleHRzLk1EQVRBX0xJTktfQlVUVE9OX0FWQUlMX0NPTU1BTkRfQ0xBU1MsIE5vbmUpDQoNCiAgICAgICAgICAgICMgZm9yIGludm9rZSBidXR0b25zIHRoZXJlIGlzIG5vIHNjcmlwdCBzb3VyY2Ugc28NCiAgICAgICAgICAgICMgYXNzaWduIHRoZSBtZXRhZGF0YSBmaWxlIHRvIHRoZSBzY3JpcHQNCiAgICAgICAgICAgIHNlbGYuc2NyaXB0X2ZpbGUgPSBzZWxmLmNvbmZpZ19zY3JpcHRfZmlsZSA9IHNlbGYubWV0YV9maWxlDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCIlcyBkb2VzIG5vdCBzcGVjaWZ5IHRhcmdldCBhc3NlbWJseTo6Y2xhc3MuIiwgc2VsZikNCg0KICAgICAgICBpZiBzZWxmLmRpcmVjdG9yeSBhbmQgbm90IHNlbGYuYXNzZW1ibHk6DQogICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCIlcyBkb2VzIG5vdCBzcGVjaWZ5IHRhcmdldCBhc3NlbWJseS4iLCBzZWxmKQ0KDQogICAgICAgIGlmIHNlbGYuZGlyZWN0b3J5IGFuZCBuZWVkc19jb21tYW5kY2xhc3MgYW5kIG5vdCBzZWxmLmNvbW1hbmRfY2xhc3M6DQogICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCIlcyBkb2VzIG5vdCBzcGVjaWZ5IHRhcmdldCBjb21tYW5kIGNsYXNzLiIsIHNlbGYpDQoNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnJXMgYXNzZW1ibHkuY2xhc3M6ICVzLiVzJywNCiAgICAgICAgICAgICAgICAgICAgICBzZWxmLCBzZWxmLmFzc2VtYmx5LCBzZWxmLmNvbW1hbmRfY2xhc3MpDQoNCiAgICBkZWYgZ2V0X3RhcmdldF9hc3NlbWJseShzZWxmLCByZXF1aXJlZD1GYWxzZSk6DQogICAgICAgIGFzc21fZmlsZSA9IHNlbGYuYXNzZW1ibHkubG93ZXIoKQ0KICAgICAgICBpZiBub3QgYXNzbV9maWxlLmVuZHN3aXRoKGZyYW1ld29yay5BU1NFTUJMWV9GSUxFX1RZUEUpOg0KICAgICAgICAgICAgYXNzbV9maWxlICs9ICcuJyArIGZyYW1ld29yay5BU1NFTUJMWV9GSUxFX1RZUEUNCg0KICAgICAgICAjIHRyeSBmaW5kaW5nIGFzc2VtYmx5IGZvciB0aGlzIHNwZWNpZmljIGhvc3QgdmVyc2lvbg0KICAgICAgICB0YXJnZXRfYXNtX2J5X2hvc3QgPSBzZWxmLmZpbmRfYnVuZGxlX21vZHVsZShhc3NtX2ZpbGUsIGJ5X2hvc3Q9VHJ1ZSkNCiAgICAgICAgaWYgdGFyZ2V0X2FzbV9ieV9ob3N0Og0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldF9hc21fYnlfaG9zdA0KICAgICAgICAjIHRyeSBmaW5kIGFzc2VtYmx5IGJ5IGl0cyBuYW1lDQogICAgICAgIHRhcmdldF9hc20gPSBzZWxmLmZpbmRfYnVuZGxlX21vZHVsZShhc3NtX2ZpbGUpDQogICAgICAgIGlmIHRhcmdldF9hc206DQogICAgICAgICAgICByZXR1cm4gdGFyZ2V0X2FzbQ0KDQogICAgICAgIGlmIHJlcXVpcmVkOg0KICAgICAgICAgICAgbWxvZ2dlci5lcnJvcigiJXMgY2FuIG5vdCBmaW5kIHRhcmdldCBhc3NlbWJseS4iLCBzZWxmKQ0KDQogICAgICAgIHJldHVybiAnJw0KDQoNCmNsYXNzIExpbmtCdXR0b24oTm9TY3JpcHRCdXR0b24pOg0KICAgICIiIkxpbmsgYnV0dG9uLiIiIg0KICAgIHR5cGVfaWQgPSBleHRzLkxJTktfQlVUVE9OX1BPU1RGSVgNCg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjbXBfcGF0aD1Ob25lKToNCiAgICAgICAgIyB1c2luZyBjbGFzc25hbWUgb3RoZXJ3aXNlIGV4Y2VwdGlvbnMgaW4gc3VwZXJjbGFzc2VzIHdvbid0IHNob3cNCiAgICAgICAgTm9TY3JpcHRCdXR0b24uX19pbml0X18oDQogICAgICAgICAgICBzZWxmLA0KICAgICAgICAgICAgY21wX3BhdGg9Y21wX3BhdGgsDQogICAgICAgICAgICBuZWVkc19jb21tYW5kY2xhc3M9VHJ1ZQ0KICAgICAgICAgICAgKQ0KDQogICAgICAgIGlmIHNlbGYuY29udGV4dDoNCiAgICAgICAgICAgIG1sb2dnZXIud2FybigNCiAgICAgICAgICAgICAgICAiTGlua2J1dHRvbiBidW5kbGVzIGRvIG5vdCBzdXBwb3J0IFwiY29udGV4dDpcIi4gIg0KICAgICAgICAgICAgICAgICJVc2UgXCJhdmFpbGFiaWxpdHlfY2xhc3M6XCIgaW5zdGVhZCBhbmQgc3BlY2lmeSBuYW1lIG9mICINCiAgICAgICAgICAgICAgICAiYXZhaWxhYmlsaXR5IGNsYXNzIGluIHRhcmdldCBhc3NlbWJseSB8ICVzIiwgc2VsZg0KICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgIHNlbGYuY29udGV4dCA9IE5vbmUNCg0KDQpjbGFzcyBJbnZva2VCdXR0b24oTm9TY3JpcHRCdXR0b24pOg0KICAgICIiIkludm9rZSBidXR0b24uIiIiDQogICAgdHlwZV9pZCA9IGV4dHMuSU5WT0tFX0JVVFRPTl9QT1NURklYDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgY21wX3BhdGg9Tm9uZSk6DQogICAgICAgICMgdXNpbmcgY2xhc3NuYW1lIG90aGVyd2lzZSBleGNlcHRpb25zIGluIHN1cGVyY2xhc3NlcyB3b24ndCBzaG93DQogICAgICAgIE5vU2NyaXB0QnV0dG9uLl9faW5pdF9fKHNlbGYsIGNtcF9wYXRoPWNtcF9wYXRoKQ0KDQoNCmNsYXNzIFB1c2hCdXR0b24oR2VuZXJpY1VJQ29tbWFuZCk6DQogICAgIiIiUHVzaCBidXR0b24uIiIiDQogICAgdHlwZV9pZCA9IGV4dHMuUFVTSF9CVVRUT05fUE9TVEZJWA0KDQoNCmNsYXNzIFBhbmVsUHVzaEJ1dHRvbihHZW5lcmljVUlDb21tYW5kKToNCiAgICAiIiJQYW5lbCBwdXNoIGJ1dHRvbi4iIiINCiAgICB0eXBlX2lkID0gZXh0cy5QQU5FTF9QVVNIX0JVVFRPTl9QT1NURklYDQoNCg0KY2xhc3MgU21hcnRCdXR0b24oR2VuZXJpY1VJQ29tbWFuZCk6DQogICAgIiIiU21hcnQgYnV0dG9uLiIiIg0KICAgIHR5cGVfaWQgPSBleHRzLlNNQVJUX0JVVFRPTl9QT1NURklYDQoNCg0KY2xhc3MgQ29udGVudEJ1dHRvbihHZW5lcmljVUlDb21tYW5kKToNCiAgICAiIiJDb250ZW50IEJ1dHRvbi4iIiINCiAgICB0eXBlX2lkID0gZXh0cy5DT05URU5UX0JVVFRPTl9QT1NURklYDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgY21wX3BhdGg9Tm9uZSk6DQogICAgICAgICMgdXNpbmcgY2xhc3NuYW1lIG90aGVyd2lzZSBleGNlcHRpb25zIGluIHN1cGVyY2xhc3NlcyB3b24ndCBzaG93DQogICAgICAgIEdlbmVyaWNVSUNvbW1hbmQuX19pbml0X18oDQogICAgICAgICAgICBzZWxmLA0KICAgICAgICAgICAgY21wX3BhdGg9Y21wX3BhdGgsDQogICAgICAgICAgICBuZWVkc19zY3JpcHQ9RmFsc2UNCiAgICAgICAgICAgICkNCiAgICAgICAgIyBmaW5kIGNvbnRlbnQgZmlsZQ0KICAgICAgICBzZWxmLnNjcmlwdF9maWxlID0gXA0KICAgICAgICAgICAgc2VsZi5maW5kX2J1bmRsZV9maWxlKFsNCiAgICAgICAgICAgICAgICBleHRzLkNPTlRFTlRfVkVSU0lPTl9QT1NURklYLmZvcm1hdCgNCiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbj1IT1NUX0FQUC52ZXJzaW9uDQogICAgICAgICAgICAgICAgICAgICksDQogICAgICAgICAgICAgICAgXSkNCiAgICAgICAgaWYgbm90IHNlbGYuc2NyaXB0X2ZpbGU6DQogICAgICAgICAgICBzZWxmLnNjcmlwdF9maWxlID0gXA0KICAgICAgICAgICAgICAgIHNlbGYuZmluZF9idW5kbGVfZmlsZShbDQogICAgICAgICAgICAgICAgICAgIGV4dHMuQ09OVEVOVF9QT1NURklYLA0KICAgICAgICAgICAgICAgICAgICBdKQ0KICAgICAgICAjIHJlcXVpcmVzIGF0IGxlYXN0IG9uZSBidW5kbGVzDQogICAgICAgIGlmIHNlbGYuZGlyZWN0b3J5IGFuZCBub3Qgc2VsZi5zY3JpcHRfZmlsZToNCiAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoJ0NvbW1hbmQgJXM6IERvZXMgbm90IGhhdmUgY29udGVudCBmaWxlLicsIHNlbGYpDQogICAgICAgICAgICBzZWxmLnNjcmlwdF9maWxlID0gJycNCg0KICAgICAgICAjIGZpbmQgYWx0ZXJuYXRpdmUgY29udGVudCBmaWxlDQogICAgICAgIHNlbGYuY29uZmlnX3NjcmlwdF9maWxlID0gXA0KICAgICAgICAgICAgc2VsZi5maW5kX2J1bmRsZV9maWxlKFsNCiAgICAgICAgICAgICAgICBleHRzLkFMVF9DT05URU5UX1ZFUlNJT05fUE9TVEZJWC5mb3JtYXQoDQogICAgICAgICAgICAgICAgICAgIHZlcnNpb249SE9TVF9BUFAudmVyc2lvbg0KICAgICAgICAgICAgICAgICAgICApLA0KICAgICAgICAgICAgICAgIF0pDQogICAgICAgIGlmIG5vdCBzZWxmLmNvbmZpZ19zY3JpcHRfZmlsZToNCiAgICAgICAgICAgIHNlbGYuY29uZmlnX3NjcmlwdF9maWxlID0gXA0KICAgICAgICAgICAgICAgIHNlbGYuZmluZF9idW5kbGVfZmlsZShbDQogICAgICAgICAgICAgICAgICAgIGV4dHMuQUxUX0NPTlRFTlRfUE9TVEZJWCwNCiAgICAgICAgICAgICAgICAgICAgXSkNCiAgICAgICAgaWYgbm90IHNlbGYuY29uZmlnX3NjcmlwdF9maWxlOg0KICAgICAgICAgICAgc2VsZi5jb25maWdfc2NyaXB0X2ZpbGUgPSBzZWxmLnNjcmlwdF9maWxlDQoNCg0KY2xhc3MgVVJMQnV0dG9uKEdlbmVyaWNVSUNvbW1hbmQpOg0KICAgICIiIlVSTCBidXR0b24uIiIiDQogICAgdHlwZV9pZCA9IGV4dHMuVVJMX0JVVFRPTl9QT1NURklYDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgY21wX3BhdGg9Tm9uZSk6DQogICAgICAgICMgdXNpbmcgY2xhc3NuYW1lIG90aGVyd2lzZSBleGNlcHRpb25zIGluIHN1cGVyY2xhc3NlcyB3b24ndCBzaG93DQogICAgICAgIEdlbmVyaWNVSUNvbW1hbmQuX19pbml0X18oc2VsZiwgY21wX3BhdGg9Y21wX3BhdGgsIG5lZWRzX3NjcmlwdD1GYWxzZSkNCiAgICAgICAgc2VsZi50YXJnZXRfdXJsID0gTm9uZQ0KICAgICAgICAjIHJlYWQgbWV0YWRhdGEgZnJvbSBtZXRhZGF0YSBmaWxlDQogICAgICAgIGlmIHNlbGYubWV0YToNCiAgICAgICAgICAgICMgZ2V0IHRoZSB0YXJnZXQgdXJsIGZyb20gbWV0YWRhdGENCiAgICAgICAgICAgIHNlbGYudGFyZ2V0X3VybCA9IFwNCiAgICAgICAgICAgICAgICBzZWxmLm1ldGEuZ2V0KGV4dHMuTURBVEFfVVJMX0JVVFRPTl9IWVBFUkxJTkssIE5vbmUpDQogICAgICAgICAgICAjIGZvciB1cmwgYnV0dG9ucyB0aGVyZSBpcyBubyBzY3JpcHQgc291cmNlIHNvDQogICAgICAgICAgICAjIGFzc2lnbiB0aGUgbWV0YWRhdGEgZmlsZSB0byB0aGUgc2NyaXB0DQogICAgICAgICAgICBzZWxmLnNjcmlwdF9maWxlID0gc2VsZi5jb25maWdfc2NyaXB0X2ZpbGUgPSBzZWxmLm1ldGFfZmlsZQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygiJXMgZG9lcyBub3Qgc3BlY2lmeSB0YXJnZXQgYXNzZW1ibHk6OmNsYXNzLiIsIHNlbGYpDQoNCiAgICAgICAgaWYgc2VsZi5kaXJlY3RvcnkgYW5kIG5vdCBzZWxmLnRhcmdldF91cmw6DQogICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCIlcyBkb2VzIG5vdCBzcGVjaWZ5IHRhcmdldCB1cmwuIiwgc2VsZikNCg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCclcyB0YXJnZXQgdXJsOiAlcycsIHNlbGYsIHNlbGYudGFyZ2V0X3VybCkNCg0KICAgIGRlZiBnZXRfdGFyZ2V0X3VybChzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYudGFyZ2V0X3VybCBvciAiIg0KDQoNCmNsYXNzIEdlbmVyaWNVSUNvbW1hbmRHcm91cChHZW5lcmljVUlDb250YWluZXIpOg0KICAgICIiIkdlbmVyaWMgVUkgY29tbWFuZCBncm91cC4NCg0KICAgIENvbW1hbmQgZ3JvdXBzIG9ubHkgaW5jbHVkZSBjb21tYW5kcy4NCiAgICBUaGVzZSBjbGFzc2VzIGNhbiBpbmNsdWRlIEdlbmVyaWNVSUNvbW1hbmQgYXMgc3ViIGNvbXBvbmVudHMuDQogICAgIiIiDQogICAgYWxsb3dlZF9zdWJfY21wcyA9IFtHZW5lcmljVUlDb21tYW5kLCBOb1NjcmlwdEJ1dHRvbl0NCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBjb250cm9sX2lkKHNlbGYpOg0KICAgICAgICAjIHN0YWNrcyBkb24ndCBoYXZlIGNvbnRyb2wgaWQNCiAgICAgICAgaWYgc2VsZi5wYXJlbnRfY3RybF9pZDoNCiAgICAgICAgICAgIGRlZXBlbmRfcGFyZW50X2lkID0gc2VsZi5wYXJlbnRfY3RybF9pZC5yZXBsYWNlKA0KICAgICAgICAgICAgICAgICdfJUN1c3RvbUN0cmwnLA0KICAgICAgICAgICAgICAgICdfJUN1c3RvbUN0cmxfJUN1c3RvbUN0cmwnDQogICAgICAgICAgICApDQogICAgICAgICAgICByZXR1cm4gZGVlcGVuZF9wYXJlbnRfaWQgKyAnJXt9Jy5mb3JtYXQoc2VsZi5uYW1lKQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuICcle30lJy5mb3JtYXQoc2VsZi5uYW1lKQ0KDQogICAgZGVmIGhhc19jb21tYW5kcyhzZWxmKToNCiAgICAgICAgZm9yIGNvbXBvbmVudCBpbiBzZWxmOg0KICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShjb21wb25lbnQsIEdlbmVyaWNVSUNvbW1hbmQpOg0KICAgICAgICAgICAgICAgIHJldHVybiBUcnVlDQoNCg0KY2xhc3MgUHVsbERvd25CdXR0b25Hcm91cChHZW5lcmljVUlDb21tYW5kR3JvdXApOg0KICAgICIiIlB1bGxkb3duIGJ1dHRvbiBncm91cC4iIiINCiAgICB0eXBlX2lkID0gZXh0cy5QVUxMRE9XTl9CVVRUT05fUE9TVEZJWA0KDQoNCmNsYXNzIFNwbGl0UHVzaEJ1dHRvbkdyb3VwKEdlbmVyaWNVSUNvbW1hbmRHcm91cCk6DQogICAgIiIiU3BsaXQgcHVzaCBidXR0b24gZ3JvdXAuIiIiDQogICAgdHlwZV9pZCA9IGV4dHMuU1BMSVRQVVNIX0JVVFRPTl9QT1NURklYDQoNCg0KY2xhc3MgU3BsaXRCdXR0b25Hcm91cChHZW5lcmljVUlDb21tYW5kR3JvdXApOg0KICAgICIiIlNwbGl0IGJ1dHRvbiBncm91cC4iIiINCiAgICB0eXBlX2lkID0gZXh0cy5TUExJVF9CVVRUT05fUE9TVEZJWA0KDQoNCmNsYXNzIEdlbmVyaWNTdGFjayhHZW5lcmljVUlDb250YWluZXIpOg0KICAgICIiIkdlbmVyaWMgVUkgc3RhY2suDQoNCiAgICBTdGFja3MgaW5jbHVkZSBHZW5lcmljVUlDb21tYW5kLCBvciBHZW5lcmljVUlDb21tYW5kR3JvdXAuDQogICAgIiIiDQogICAgdHlwZV9pZCA9IGV4dHMuU1RBQ0tfQlVUVE9OX1BPU1RGSVgNCg0KICAgIGFsbG93ZWRfc3ViX2NtcHMgPSBcDQogICAgICAgIFtHZW5lcmljVUlDb21tYW5kR3JvdXAsIEdlbmVyaWNVSUNvbW1hbmQsIE5vU2NyaXB0QnV0dG9uXQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGNvbnRyb2xfaWQoc2VsZik6DQogICAgICAgICMgc3RhY2tzIGRvbid0IGhhdmUgY29udHJvbCBpZA0KICAgICAgICByZXR1cm4gc2VsZi5wYXJlbnRfY3RybF9pZCBpZiBzZWxmLnBhcmVudF9jdHJsX2lkIGVsc2UgJycNCg0KICAgIGRlZiBoYXNfY29tbWFuZHMoc2VsZik6DQogICAgICAgIGZvciBjb21wb25lbnQgaW4gc2VsZjoNCiAgICAgICAgICAgIGlmIG5vdCBjb21wb25lbnQuaXNfY29udGFpbmVyOg0KICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY29tcG9uZW50LCBHZW5lcmljVUlDb21tYW5kKToNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgaWYgY29tcG9uZW50Lmhhc19jb21tYW5kcygpOg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KDQoNCmNsYXNzIFN0YWNrQnV0dG9uR3JvdXAoR2VuZXJpY1N0YWNrKToNCiAgICAiIiJTdGFjayBidXR0b25zIGdyb3VwLiIiIg0KICAgIHR5cGVfaWQgPSBleHRzLlNUQUNLX0JVVFRPTl9QT1NURklYDQoNCg0KY2xhc3MgUGFuZWwoR2VuZXJpY1VJQ29udGFpbmVyKToNCiAgICAiIiJQYW5lbCBjb250YWluZXIuDQoNCiAgICBQYW5lbHMgaW5jbHVkZSBHZW5lcmljU3RhY2ssIEdlbmVyaWNVSUNvbW1hbmQsIG9yIEdlbmVyaWNVSUNvbW1hbmRHcm91cA0KICAgICIiIg0KICAgIHR5cGVfaWQgPSBleHRzLlBBTkVMX1BPU1RGSVgNCiAgICBhbGxvd2VkX3N1Yl9jbXBzID0gXA0KICAgICAgICBbR2VuZXJpY1N0YWNrLCBHZW5lcmljVUlDb21tYW5kR3JvdXAsIEdlbmVyaWNVSUNvbW1hbmQsIE5vU2NyaXB0QnV0dG9uXQ0KDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNtcF9wYXRoPU5vbmUpOg0KICAgICAgICAjIHVzaW5nIGNsYXNzbmFtZSBvdGhlcndpc2UgZXhjZXB0aW9ucyBpbiBzdXBlcmNsYXNzZXMgd29uJ3Qgc2hvdw0KICAgICAgICBHZW5lcmljVUlDb250YWluZXIuX19pbml0X18oc2VsZiwgY21wX3BhdGg9Y21wX3BhdGgpDQogICAgICAgIHNlbGYucGFuZWxfYmFja2dyb3VuZCA9IFwNCiAgICAgICAgICAgIHNlbGYudGl0bGVfYmFja2dyb3VuZCA9IFwNCiAgICAgICAgICAgICAgICBzZWxmLnNsaWRlb3V0X2JhY2tncm91bmQgPSBOb25lDQogICAgICAgICMgcmVhZCBtZXRhZGF0YSBmcm9tIG1ldGFkYXRhIGZpbGUNCiAgICAgICAgaWYgc2VsZi5tZXRhOg0KICAgICAgICAgICAgIyBjaGVjayBmb3IgYmFja2dyb3VuZCBjb2xvciBjb25maWdzDQogICAgICAgICAgICBzZWxmLnBhbmVsX2JhY2tncm91bmQgPSBcDQogICAgICAgICAgICAgICAgc2VsZi5tZXRhLmdldChleHRzLk1EQVRBX0JBQ0tHUk9VTkRfS0VZLCBOb25lKQ0KICAgICAgICAgICAgaWYgc2VsZi5wYW5lbF9iYWNrZ3JvdW5kOg0KICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc2VsZi5wYW5lbF9iYWNrZ3JvdW5kLCBkaWN0KToNCiAgICAgICAgICAgICAgICAgICAgc2VsZi50aXRsZV9iYWNrZ3JvdW5kID0gc2VsZi5wYW5lbF9iYWNrZ3JvdW5kLmdldCgNCiAgICAgICAgICAgICAgICAgICAgICAgIGV4dHMuTURBVEFfQkFDS0dST1VORF9USVRMRV9LRVksIE5vbmUpDQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2xpZGVvdXRfYmFja2dyb3VuZCA9IHNlbGYucGFuZWxfYmFja2dyb3VuZC5nZXQoDQogICAgICAgICAgICAgICAgICAgICAgICBleHRzLk1EQVRBX0JBQ0tHUk9VTkRfU0xJREVPVVRfS0VZLCBOb25lKQ0KICAgICAgICAgICAgICAgICAgICBzZWxmLnBhbmVsX2JhY2tncm91bmQgPSBzZWxmLnBhbmVsX2JhY2tncm91bmQuZ2V0KA0KICAgICAgICAgICAgICAgICAgICAgICAgZXh0cy5NREFUQV9CQUNLR1JPVU5EX1BBTkVMX0tFWSwgTm9uZSkNCiAgICAgICAgICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKHNlbGYucGFuZWxfYmFja2dyb3VuZCwgc3RyKToNCiAgICAgICAgICAgICAgICAgICAgbWxvZ2dlci5lcnJvcigNCiAgICAgICAgICAgICAgICAgICAgICAgICIlcyBiYWQgYmFja2dyb3VuZCBkZWZpbml0aW9uIGluIG1ldGFkYXRhLiIsIHNlbGYpDQoNCiAgICBkZWYgaGFzX2NvbW1hbmRzKHNlbGYpOg0KICAgICAgICBmb3IgY29tcG9uZW50IGluIHNlbGY6DQogICAgICAgICAgICBpZiBub3QgY29tcG9uZW50LmlzX2NvbnRhaW5lcjoNCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNvbXBvbmVudCwgR2VuZXJpY1VJQ29tbWFuZCk6DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIGlmIGNvbXBvbmVudC5oYXNfY29tbWFuZHMoKToNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgIGRlZiBjb250YWlucyhzZWxmLCBpdGVtX25hbWUpOg0KICAgICAgICAjIFBhbmVscyBjb250YWluIHN0YWNrcy4gQnV0IHN0YWNrcyBpdHNlbGYgZG9lcyBub3QgaGF2ZSBhbnkgdWkgYW5kIGl0cw0KICAgICAgICAjIHN1Yml0ZW1zIGFyZSBkaXNwbGF5ZWQgd2l0aGluIHRoZSB1aSBvZiB0aGUgcGFyZW50IHBhbmVsLg0KICAgICAgICAjIFRoaXMgaXMgZGlmZmVyZW50IGZyb20gcHVsbGRvd25zIGFuZCBvdGhlciBidXR0b24gZ3JvdXBzLg0KICAgICAgICAjIEJ1dHRvbiBncm91cHMsIGNvbnRhaW4gYW5kIGRpc3BsYXkgdGhlaXIgc3ViIGNvbXBvbmVudHMgaW4gdGhlaXINCiAgICAgICAgIyBvd24gZHJvcCBkb3duIG1lbnUuIFNvIHdoZW4gY2hlY2tpbmcgaWYgcGFuZWwgaGFzIGEgYnV0dG9uLA0KICAgICAgICAjIHBhbmVsIHNob3VsZCBjaGVjayBhbGwgdGhlIGl0ZW1zIHZpc2libGUgdG8gdGhlIHVzZXIgYW5kIHJlc3BvbmQuDQogICAgICAgIGl0ZW1fZXhpc3RzID0gR2VuZXJpY1VJQ29udGFpbmVyLmNvbnRhaW5zKHNlbGYsIGl0ZW1fbmFtZSkNCiAgICAgICAgaWYgaXRlbV9leGlzdHM6DQogICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgIyBpZiBjaGlsZCBpcyBhIHN0YWNrIGl0ZW0sIGNoZWNrIGl0cyBjaGlsZHJlbiB0b28NCiAgICAgICAgICAgIGZvciBjb21wb25lbnQgaW4gc2VsZjoNCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGNvbXBvbmVudCwgR2VuZXJpY1N0YWNrKSBcDQogICAgICAgICAgICAgICAgICAgICAgICBhbmQgY29tcG9uZW50LmNvbnRhaW5zKGl0ZW1fbmFtZSk6DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlDQoNCg0KY2xhc3MgVGFiKEdlbmVyaWNVSUNvbnRhaW5lcik6DQogICAgIiIiVGFiIGNvbnRhaW5lciBmb3IgUGFuZWxzLiIiIg0KICAgIHR5cGVfaWQgPSBleHRzLlRBQl9QT1NURklYDQogICAgYWxsb3dlZF9zdWJfY21wcyA9IFtQYW5lbF0NCg0KICAgIGRlZiBoYXNfY29tbWFuZHMoc2VsZik6DQogICAgICAgIGZvciBwYW5lbCBpbiBzZWxmOg0KICAgICAgICAgICAgaWYgcGFuZWwuaGFzX2NvbW1hbmRzKCk6DQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCg0KY2xhc3MgRXh0ZW5zaW9uKEdlbmVyaWNVSUNvbnRhaW5lcik6DQogICAgIiIiVUkgVG9vbHMgZXh0ZW5zaW9uLiIiIg0KICAgIHR5cGVfaWQgPSBleHRzLkV4dGVuc2lvblR5cGVzLlVJX0VYVEVOU0lPTi5QT1NURklYDQogICAgYWxsb3dlZF9zdWJfY21wcyA9IFtUYWJdDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgY21wX3BhdGg9Tm9uZSk6DQogICAgICAgIHNlbGYucHlydnRfdmVyc2lvbiA9IE5vbmUNCiAgICAgICAgc2VsZi5kaXJfaGFzaF92YWx1ZSA9IE5vbmUNCiAgICAgICAgIyB1c2luZyBjbGFzc25hbWUgb3RoZXJ3aXNlIGV4Y2VwdGlvbnMgaW4gc3VwZXJjbGFzc2VzIHdvbid0IHNob3cNCiAgICAgICAgR2VuZXJpY1VJQ29udGFpbmVyLl9faW5pdF9fKHNlbGYsIGNtcF9wYXRoPWNtcF9wYXRoKQ0KDQogICAgZGVmIF9jYWxjdWxhdGVfZXh0ZW5zaW9uX2Rpcl9oYXNoKHNlbGYpOg0KICAgICAgICAiIiJDcmVhdGVzIGEgdW5pcXVlIGhhc2ggIyB0byByZXByZXNlbnQgc3RhdGUgb2YgZGlyZWN0b3J5LiIiIg0KICAgICAgICAjIHNlYXJjaCBkb2VzIG5vdCBpbmNsdWRlIHBuZyBmaWxlczoNCiAgICAgICAgIyAgIGlmIHBuZyBmaWxlcyBhcmUgYWRkZWQgdGhlIHBhcmVudCBmb2xkZXIgbXRpbWUgZ2V0cyBhZmZlY3RlZA0KICAgICAgICAjICAgY2FjaGUgb25seSBzYXZlcyB0aGUgcG5nIGFkZHJlc3MgYW5kIG5vdCB0aGUgY29udGVudHMgc28gdGhleSdsbA0KICAgICAgICAjICAgZ2V0IGxvYWRlZCBldmVyeXRpbWUNCiAgICAgICAgIyAgICAgICBzZWUgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvNTE0MTcxMC8yMzUwMjQ0DQogICAgICAgIHBhdCA9ICcoXFwnICsgZXh0cy5UQUJfUE9TVEZJWCArICcpfChcXCcgKyBleHRzLlBBTkVMX1BPU1RGSVggKyAnKScNCiAgICAgICAgcGF0ICs9ICd8KFxcJyArIGV4dHMuUFVMTERPV05fQlVUVE9OX1BPU1RGSVggKyAnKScNCiAgICAgICAgcGF0ICs9ICd8KFxcJyArIGV4dHMuU1BMSVRfQlVUVE9OX1BPU1RGSVggKyAnKScNCiAgICAgICAgcGF0ICs9ICd8KFxcJyArIGV4dHMuU1BMSVRQVVNIX0JVVFRPTl9QT1NURklYICsgJyknDQogICAgICAgIHBhdCArPSAnfChcXCcgKyBleHRzLlNUQUNLX0JVVFRPTl9QT1NURklYICsgJyknDQogICAgICAgIHBhdCArPSAnfChcXCcgKyBleHRzLlBVU0hfQlVUVE9OX1BPU1RGSVggKyAnKScNCiAgICAgICAgcGF0ICs9ICd8KFxcJyArIGV4dHMuU01BUlRfQlVUVE9OX1BPU1RGSVggKyAnKScNCiAgICAgICAgcGF0ICs9ICd8KFxcJyArIGV4dHMuTElOS19CVVRUT05fUE9TVEZJWCArICcpJw0KICAgICAgICBwYXQgKz0gJ3woXFwnICsgZXh0cy5QQU5FTF9QVVNIX0JVVFRPTl9QT1NURklYICsgJyknDQogICAgICAgIHBhdCArPSAnfChcXCcgKyBleHRzLlBBTkVMX1BVU0hfQlVUVE9OX1BPU1RGSVggKyAnKScNCiAgICAgICAgcGF0ICs9ICd8KFxcJyArIGV4dHMuQ09OVEVOVF9CVVRUT05fUE9TVEZJWCArICcpJw0KICAgICAgICAjIHRudGVyZXN0aW5nIGRpcmVjdG9yaWVzDQogICAgICAgIHBhdCArPSAnfChcXCcgKyBleHRzLkNPTVBfTElCUkFSWV9ESVJfTkFNRSArICcpJw0KICAgICAgICBwYXQgKz0gJ3woXFwnICsgZXh0cy5DT01QX0hPT0tTX0RJUl9OQU1FICsgJyknDQogICAgICAgICMgc2VhcmNoIGZvciBzY3JpcHRzLCBzZXR0aW5nIGZpbGVzIChmdXR1cmUgc3VwcG9ydCksIGFuZCBsYXlvdXQgZmlsZXMNCiAgICAgICAgcGF0ZmlsZSA9ICcoXFwnICsgZXh0cy5QWVRIT05fU0NSSVBUX0ZJTEVfRk9STUFUICsgJyknDQogICAgICAgIHBhdGZpbGUgKz0gJ3woXFwnICsgZXh0cy5DU0hBUlBfU0NSSVBUX0ZJTEVfRk9STUFUICsgJyknDQogICAgICAgIHBhdGZpbGUgKz0gJ3woXFwnICsgZXh0cy5WQl9TQ1JJUFRfRklMRV9GT1JNQVQgKyAnKScNCiAgICAgICAgcGF0ZmlsZSArPSAnfChcXCcgKyBleHRzLlJVQllfU0NSSVBUX0ZJTEVfRk9STUFUICsgJyknDQogICAgICAgIHBhdGZpbGUgKz0gJ3woXFwnICsgZXh0cy5EWU5BTU9fU0NSSVBUX0ZJTEVfRk9STUFUICsgJyknDQogICAgICAgIHBhdGZpbGUgKz0gJ3woXFwnICsgZXh0cy5HUkFTU0hPUFBFUl9TQ1JJUFRfRklMRV9GT1JNQVQgKyAnKScNCiAgICAgICAgcGF0ZmlsZSArPSAnfChcXCcgKyBleHRzLkdSQVNTSE9QUEVSWF9TQ1JJUFRfRklMRV9GT1JNQVQgKyAnKScNCiAgICAgICAgcGF0ZmlsZSArPSAnfChcXCcgKyBleHRzLkNPTlRFTlRfRklMRV9GT1JNQVQgKyAnKScNCiAgICAgICAgcGF0ZmlsZSArPSAnfChcXCcgKyBleHRzLllBTUxfRklMRV9GT1JNQVQgKyAnKScNCiAgICAgICAgcGF0ZmlsZSArPSAnfChcXCcgKyBleHRzLkpTT05fRklMRV9GT1JNQVQgKyAnKScNCiAgICAgICAgZnJvbSBweXJldml0LnJldml0IGltcG9ydCB1aQ0KICAgICAgICByZXR1cm4gY29yZXV0aWxzLmNhbGN1bGF0ZV9kaXJfaGFzaChzZWxmLmRpcmVjdG9yeSwgcGF0LCBwYXRmaWxlKSArIHN0cih1aS5nZXRfY3VycmVudF90aGVtZSgpKQ0KDQogICAgZGVmIF91cGRhdGVfZnJvbV9kaXJlY3Rvcnkoc2VsZik6ICAgI3B5bGludDogZGlzYWJsZT1XMDIyMQ0KICAgICAgICAjIHVzaW5nIGNsYXNzbmFtZSBvdGhlcndpc2UgZXhjZXB0aW9ucyBpbiBzdXBlcmNsYXNzZXMgd29uJ3Qgc2hvdw0KICAgICAgICBHZW5lcmljVUlDb250YWluZXIuX3VwZGF0ZV9mcm9tX2RpcmVjdG9yeShzZWxmKQ0KICAgICAgICBzZWxmLnB5cnZ0X3ZlcnNpb24gPSB2ZXJzaW9ubWdyLmdldF9weXJldml0X3ZlcnNpb24oKS5nZXRfZm9ybWF0dGVkKCkNCg0KICAgICAgICAjIGV4dGVuc2lvbnMgY2FuIHN0b3JlIGV2ZW50IGhvb2tzIHVuZGVyDQogICAgICAgICMgaG9va3MvIGluc2lkZSB0aGUgY29tcG9uZW50IGZvbGRlcg0KICAgICAgICBob29rc19wYXRoID0gb3Auam9pbihzZWxmLmRpcmVjdG9yeSwgZXh0cy5DT01QX0hPT0tTX0RJUl9OQU1FKQ0KICAgICAgICBzZWxmLmhvb2tzX3BhdGggPSBob29rc19wYXRoIGlmIG9wLmV4aXN0cyhob29rc19wYXRoKSBlbHNlIE5vbmUNCg0KICAgICAgICAjIGV4dGVuc2lvbnMgY2FuIHN0b3JlIHByZWZsaWdodCBjaGVja3MgdW5kZXINCiAgICAgICAgIyBjaGVja3MvIGluc2lkZSB0aGUgY29tcG9uZW50IGZvbGRlcg0KICAgICAgICBjaGVja3NfcGF0aCA9IG9wLmpvaW4oc2VsZi5kaXJlY3RvcnksIGV4dHMuQ09NUF9DSEVDS1NfRElSX05BTUUpDQogICAgICAgIHNlbGYuY2hlY2tzX3BhdGggPSBjaGVja3NfcGF0aCBpZiBvcC5leGlzdHMoY2hlY2tzX3BhdGgpIGVsc2UgTm9uZQ0KDQogICAgICAgIHNlbGYuZGlyX2hhc2hfdmFsdWUgPSBzZWxmLl9jYWxjdWxhdGVfZXh0ZW5zaW9uX2Rpcl9oYXNoKCkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBjb250cm9sX2lkKHNlbGYpOg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHN0YXJ0dXBfc2NyaXB0KHNlbGYpOg0KICAgICAgICByZXR1cm4gc2VsZi5maW5kX2J1bmRsZV9maWxlKFsNCiAgICAgICAgICAgIGV4dHMuUFlUSE9OX0VYVF9TVEFSVFVQX0ZJTEUsDQogICAgICAgICAgICBleHRzLkNTSEFSUF9FWFRfU1RBUlRVUF9GSUxFLA0KICAgICAgICAgICAgZXh0cy5WQl9FWFRfU1RBUlRVUF9GSUxFLA0KICAgICAgICAgICAgZXh0cy5SVUJZX0VYVF9TVEFSVFVQX0ZJTEUsDQogICAgICAgIF0pDQoNCiAgICBkZWYgZ2V0X2hhc2goc2VsZik6DQogICAgICAgIHJldHVybiBjb3JldXRpbHMuZ2V0X3N0cl9oYXNoKHNhZmVfc3RydHlwZShzZWxmLmdldF9jYWNoZV9kYXRhKCkpKQ0KDQogICAgZGVmIGdldF9hbGxfY29tbWFuZHMoc2VsZik6DQogICAgICAgIHJldHVybiBzZWxmLmZpbmRfY29tcG9uZW50c19vZl90eXBlKEdlbmVyaWNVSUNvbW1hbmQpDQoNCiAgICBkZWYgZ2V0X21hbmlmZXN0X2ZpbGUoc2VsZik6DQogICAgICAgIHJldHVybiBzZWxmLmdldF9idW5kbGVfZmlsZShleHRzLkVYVF9NQU5JRkVTVF9GSUxFKQ0KDQogICAgZGVmIGdldF9tYW5pZmVzdChzZWxmKToNCiAgICAgICAgbWFuaWZlc3RfZmlsZSA9IHNlbGYuZ2V0X21hbmlmZXN0X2ZpbGUoKQ0KICAgICAgICBpZiBtYW5pZmVzdF9maWxlOg0KICAgICAgICAgICAgd2l0aCBjb2RlY3Mub3BlbihtYW5pZmVzdF9maWxlLCAncicsICd1dGYtOCcpIGFzIG1maWxlOg0KICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgbWFuaWZlc3RfY2ZnID0ganNvbi5sb2FkKG1maWxlKQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWFuaWZlc3RfY2ZnDQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBtYW5mbG9hZF9lcnI6DQogICAgICAgICAgICAgICAgICAgIHByaW50KCdDYW4gbm90IHBhcnNlIGV4dCBtYW5pZmVzdCBmaWxlOiB7fSAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICd8IHt9Jy5mb3JtYXQobWFuaWZlc3RfZmlsZSwgbWFuZmxvYWRfZXJyKSkNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuDQoNCiAgICBkZWYgY29uZmlndXJlKHNlbGYpOg0KICAgICAgICBjZmdfZGljdCA9IHNlbGYuZ2V0X21hbmlmZXN0KCkNCiAgICAgICAgaWYgY2ZnX2RpY3Q6DQogICAgICAgICAgICBmb3IgY29tcG9uZW50IGluIHNlbGY6DQogICAgICAgICAgICAgICAgY29tcG9uZW50LmNvbmZpZ3VyZShjZmdfZGljdCkNCg0KICAgIGRlZiBnZXRfZXh0ZW5zaW9uX21vZHVsZXMoc2VsZik6DQogICAgICAgIG1vZHVsZXMgPSBbXQ0KICAgICAgICBpZiBzZWxmLmJpbmFyeV9wYXRoIGFuZCBvcC5leGlzdHMoc2VsZi5iaW5hcnlfcGF0aCk6DQogICAgICAgICAgICBmb3IgaXRlbSBpbiBvcy5saXN0ZGlyKHNlbGYuYmluYXJ5X3BhdGgpOg0KICAgICAgICAgICAgICAgIGl0ZW1fcGF0aCA9IG9wLmpvaW4oc2VsZi5iaW5hcnlfcGF0aCwgaXRlbSkNCiAgICAgICAgICAgICAgICBpdGVtX25hbWUgPSBpdGVtLmxvd2VyKCkNCiAgICAgICAgICAgICAgICBpZiBvcC5pc2ZpbGUoaXRlbV9wYXRoKSBcDQogICAgICAgICAgICAgICAgICAgICAgICBhbmQgaXRlbV9uYW1lLmVuZHN3aXRoKGZyYW1ld29yay5BU1NFTUJMWV9GSUxFX1RZUEUpOg0KICAgICAgICAgICAgICAgICAgICBtb2R1bGVzLmFwcGVuZChpdGVtX3BhdGgpDQogICAgICAgIHJldHVybiBtb2R1bGVzDQoNCiAgICBkZWYgZ2V0X2NvbW1hbmRfbW9kdWxlcyhzZWxmKToNCiAgICAgICAgcmVmZXJlbmNlZF9tb2R1bGVzID0gc2V0KCkNCiAgICAgICAgZm9yIGNtZCBpbiBzZWxmLmdldF9hbGxfY29tbWFuZHMoKToNCiAgICAgICAgICAgIGZvciBtb2R1bGUgaW4gY21kLm1vZHVsZXM6DQogICAgICAgICAgICAgICAgY21kX21vZHVsZSA9IGNtZC5maW5kX2J1bmRsZV9tb2R1bGUobW9kdWxlKQ0KICAgICAgICAgICAgICAgIGlmIGNtZF9tb2R1bGU6DQogICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZWRfbW9kdWxlcy5hZGQoY21kX21vZHVsZSkNCiAgICAgICAgcmV0dXJuIHJlZmVyZW5jZWRfbW9kdWxlcw0KDQogICAgZGVmIGdldF9ob29rcyhzZWxmKToNCiAgICAgICAgaG9va19zY3JpcHRzID0gb3MubGlzdGRpcihzZWxmLmhvb2tzX3BhdGgpIGlmIHNlbGYuaG9va3NfcGF0aCBlbHNlIFtdDQogICAgICAgIHJldHVybiBbb3Auam9pbihzZWxmLmhvb2tzX3BhdGgsIHgpIGZvciB4IGluIGhvb2tfc2NyaXB0c10NCg0KICAgIGRlZiBnZXRfY2hlY2tzKHNlbGYpOg0KICAgICAgICBjaGVja19zY3JpcHRzID0gb3MubGlzdGRpcihzZWxmLmNoZWNrc19wYXRoKSBpZiBzZWxmLmNoZWNrc19wYXRoIGVsc2UgW10NCiAgICAgICAgcmV0dXJuIFtvcC5qb2luKHNlbGYuY2hlY2tzX3BhdGgsIHgpIGZvciB4IGluIGNoZWNrX3NjcmlwdHNdDQoNCg0KY2xhc3MgTGlicmFyeUV4dGVuc2lvbihHZW5lcmljQ29tcG9uZW50KToNCiAgICAiIiJMaWJyYXJ5IGV4dGVuc2lvbi4iIiINCiAgICB0eXBlX2lkID0gZXh0cy5FeHRlbnNpb25UeXBlcy5MSUJfRVhURU5TSU9OLlBPU1RGSVgNCg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjbXBfcGF0aD1Ob25lKToNCiAgICAgICAgIyB1c2luZyBjbGFzc25hbWUgb3RoZXJ3aXNlIGV4Y2VwdGlvbnMgaW4gc3VwZXJjbGFzc2VzIHdvbid0IHNob3cNCiAgICAgICAgR2VuZXJpY0NvbXBvbmVudC5fX2luaXRfXyhzZWxmKQ0KICAgICAgICBzZWxmLmRpcmVjdG9yeSA9IGNtcF9wYXRoDQoNCiAgICAgICAgaWYgc2VsZi5kaXJlY3Rvcnk6DQogICAgICAgICAgICBzZWxmLm5hbWUgPSBvcC5zcGxpdGV4dChvcC5iYXNlbmFtZShzZWxmLmRpcmVjdG9yeSkpWzBdDQoNCiAgICBkZWYgX19yZXByX18oc2VsZik6DQogICAgICAgIHJldHVybiAnPHR5cGVfaWQgXCd7fVwnIG5hbWUgXCd7fVwnIEAgXCd7fVwnPidcDQogICAgICAgICAgICAuZm9ybWF0KHNlbGYudHlwZV9pZCwgc2VsZi5uYW1lLCBzZWxmLmRpcmVjdG9yeSkNCg0KICAgIEBjbGFzc21ldGhvZA0KICAgIGRlZiBtYXRjaGVzKGNscywgY29tcG9uZW50X3BhdGgpOg0KICAgICAgICByZXR1cm4gY29tcG9uZW50X3BhdGgubG93ZXIoKS5lbmRzd2l0aChjbHMudHlwZV9pZCkNCg0KIiIiQmFzZSBtb2R1bGUgdG8gaGFuZGxlIGV4dGVuc2lvbiBiaW5hcnkgY2FjaGluZy4iIiINCmltcG9ydCBwaWNrbGUNCg0KZnJvbSBweXJldml0IGltcG9ydCBQeVJldml0RXhjZXB0aW9uDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzIGltcG9ydCBhcHBkYXRhDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzLmxvZ2dlciBpbXBvcnQgZ2V0X2xvZ2dlcg0KDQojcHlsaW50OiBkaXNhYmxlPVcwNzAzLEMwMzAyLEMwMTAzDQptbG9nZ2VyID0gZ2V0X2xvZ2dlcihfX25hbWVfXykNCg0KDQpsb2FkZWRfZXh0ZW5zaW9ucyA9IFtdDQoNCg0KZGVmIF9nZXRfY2FjaGVfZmlsZShjYWNoZWRfZXh0KToNCiAgICByZXR1cm4gYXBwZGF0YS5nZXRfZGF0YV9maWxlKGZpbGVfaWQ9J2NhY2hlX3t9Jy5mb3JtYXQoY2FjaGVkX2V4dC5uYW1lKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfZXh0PSdwaWNrbGUnKQ0KDQoNCmRlZiB1cGRhdGVfY2FjaGUocGFyc2VkX2V4dCk6DQogICAgdHJ5Og0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdXcml0aW5nIGNhY2hlIGZvcjogJXMnLCBwYXJzZWRfZXh0KQ0KICAgICAgICBjYWNoZV9maWxlID0gX2dldF9jYWNoZV9maWxlKHBhcnNlZF9leHQpDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0NhY2hlIGZpbGUgaXM6ICVzJywgY2FjaGVfZmlsZSkNCiAgICAgICAgd2l0aCBvcGVuKGNhY2hlX2ZpbGUsICd3YicpIGFzIGJpbl9jYWNoZV9maWxlOg0KICAgICAgICAgICAgcGlja2xlLmR1bXAocGFyc2VkX2V4dCwgYmluX2NhY2hlX2ZpbGUsIHBpY2tsZS5ISUdIRVNUX1BST1RPQ09MKQ0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKCdFcnJvciB3cml0aW5nIGNhY2hlIGZvcjoge30gfCB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KHBhcnNlZF9leHQsIGVycikpDQoNCg0KZGVmIGdldF9jYWNoZWRfZXh0ZW5zaW9uKGluc3RhbGxlZF9leHQpOg0KICAgIGZvciBsb2FkZWRfZXh0IGluIGxvYWRlZF9leHRlbnNpb25zOg0KICAgICAgICBpZiBsb2FkZWRfZXh0Lm5hbWUgPT0gaW5zdGFsbGVkX2V4dC5uYW1lOg0KICAgICAgICAgICAgcmV0dXJuIGxvYWRlZF9leHQNCg0KICAgIHRyeToNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnUmVhZGluZyBjYWNoZSBmb3I6ICVzJywgaW5zdGFsbGVkX2V4dCkNCiAgICAgICAgY2FjaGVfZmlsZSA9IF9nZXRfY2FjaGVfZmlsZShpbnN0YWxsZWRfZXh0KQ0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDYWNoZSBmaWxlIGlzOiAlcycsIGNhY2hlX2ZpbGUpDQogICAgICAgIHdpdGggb3BlbihjYWNoZV9maWxlLCAncmInKSBhcyBiaW5fY2FjaGVfZmlsZToNCiAgICAgICAgICAgIHVucGlja2xlZF9wa2cgPSBwaWNrbGUubG9hZChiaW5fY2FjaGVfZmlsZSkNCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGVycjoNCiAgICAgICAgcmFpc2UgUHlSZXZpdEV4Y2VwdGlvbignRXJyb3IgcmVhZGluZyBjYWNoZSBmb3I6IHt9IHwge30nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChpbnN0YWxsZWRfZXh0LCBlcnIpKQ0KDQogICAgcmV0dXJuIHVucGlja2xlZF9wa2cNCg0KDQpkZWYgaXNfY2FjaGVfdmFsaWQoZXh0ZW5zaW9uKToNCiAgICB0cnk6DQogICAgICAgIGNhY2hlZF9leHQgPSBnZXRfY2FjaGVkX2V4dGVuc2lvbihleHRlbnNpb24pDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0V4dGVuc2lvbiBjYWNoZSBkaXJlY3RvcnkgaXM6ICVzIGZvcjogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbi5kaXJlY3RvcnksIGV4dGVuc2lvbikNCiAgICAgICAgY2FjaGVfZGlyX3ZhbGlkID0gXA0KICAgICAgICAgICAgY2FjaGVkX2V4dC5kaXJlY3RvcnkgPT0gZXh0ZW5zaW9uLmRpcmVjdG9yeQ0KDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0V4dGVuc2lvbiBjYWNoZSB2ZXJzaW9uIGlzOiAlcyBmb3I6ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24ucHlydnRfdmVyc2lvbiwgZXh0ZW5zaW9uKQ0KICAgICAgICBjYWNoZV92ZXJzaW9uX3ZhbGlkID0gXA0KICAgICAgICAgICAgY2FjaGVkX2V4dC5weXJ2dF92ZXJzaW9uID09IGV4dGVuc2lvbi5weXJ2dF92ZXJzaW9uDQoNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRXh0ZW5zaW9uIGhhc2ggdmFsdWUgaXM6ICVzIGZvcjogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbi5kaXJfaGFzaF92YWx1ZSwgZXh0ZW5zaW9uKQ0KICAgICAgICBjYWNoZV9oYXNoX3ZhbGlkID0gXA0KICAgICAgICAgICAgY2FjaGVkX2V4dC5kaXJfaGFzaF92YWx1ZSA9PSBleHRlbnNpb24uZGlyX2hhc2hfdmFsdWUNCg0KICAgICAgICBjYWNoZV92YWxpZCA9IFwNCiAgICAgICAgICAgIGNhY2hlX2Rpcl92YWxpZCBhbmQgY2FjaGVfdmVyc2lvbl92YWxpZCBhbmQgY2FjaGVfaGFzaF92YWxpZA0KDQogICAgICAgICMgYWRkIGxvYWRlZCBwYWNrYWdlIHRvIGxpc3Qgc28gaXQgY2FuIGJlIHJlY292ZXJlZCBsYXRlcg0KICAgICAgICBpZiBjYWNoZV92YWxpZDoNCiAgICAgICAgICAgIGxvYWRlZF9leHRlbnNpb25zLmFwcGVuZChjYWNoZWRfZXh0KQ0KDQogICAgICAgICMgY2FjaGUgaXMgdmFsaWQgaWYgYm90aCB2ZXJzaW9uIGFuZCBoYXNoIHZhbHVlIG1hdGNoDQogICAgICAgIHJldHVybiBjYWNoZV92YWxpZA0KDQogICAgZXhjZXB0IFB5UmV2aXRFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdFcnJvciByZWFkaW5nIGNhY2hlIGZpbGUgb3IgZmlsZSBpcyBub3QgYXZhaWxhYmxlOiAlcycsDQogICAgICAgICAgICAgICAgICAgICAgZXJyKQ0KICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdFcnJvciBkZXRlcm1pbmluZyBjYWNoZSB2YWxpZGl0eTogJXMgfCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uLCBlcnIpDQogICAgICAgIHJldHVybiBGYWxzZQ0KDQoiIiJCYXNlIG1vZHVsZSB0byBoYW5kbGUgZXh0ZW5zaW9uIEFTQ0lJIGNhY2hpbmcuIiIiDQppbXBvcnQganNvbg0KaW1wb3J0IGNvZGVjcw0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IFB5UmV2aXRFeGNlcHRpb24NCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGFwcGRhdGENCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGdldF9hbGxfc3ViY2xhc3Nlcw0KZnJvbSBweXJldml0LmNvcmV1dGlscy5sb2dnZXIgaW1wb3J0IGdldF9sb2dnZXINCmZyb20gcHlyZXZpdC5leHRlbnNpb25zIGltcG9ydCBjb21wb25lbnRzIGFzIGNvbXBzDQpmcm9tIHB5cmV2aXQuZXh0ZW5zaW9ucyBpbXBvcnQgZ2VuZXJpY2NvbXBzIGFzIGdlbmNvbXBzDQoNCiNweWxpbnQ6IGRpc2FibGU9VzA3MDMsQzAzMDIsQzAxMDMNCm1sb2dnZXIgPSBnZXRfbG9nZ2VyKF9fbmFtZV9fKQ0KDQoNCmRlZiBfZ2V0X2NhY2hlX2ZpbGUoY2FjaGVkX2V4dCk6DQogICAgcmV0dXJuIGFwcGRhdGEuZ2V0X2RhdGFfZmlsZShmaWxlX2lkPSdjYWNoZV97fScuZm9ybWF0KGNhY2hlZF9leHQubmFtZSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2V4dD0nanNvbicpDQoNCg0KZGVmIF9tYWtlX2NhY2hlX2Zyb21fY21wKG9iaik6DQogICAgcmV0dXJuIGpzb24uZHVtcHMob2JqLA0KICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ9bGFtYmRhIG86IG8uZ2V0X2NhY2hlX2RhdGEoKSwNCiAgICAgICAgICAgICAgICAgICAgICBzb3J0X2tleXM9VHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICBpbmRlbnQ9NCwNCiAgICAgICAgICAgICAgICAgICAgICBlbnN1cmVfYXNjaWk9RmFsc2UpDQoNCg0KZGVmIF9tYWtlX2xheW91dGl0ZW1zX2Zyb21fY2FjaGUocGFyZW50X2NtcCwgY2FjaGVkX2xheW91dGl0ZW1zKToNCiAgICBpZiBoYXNhdHRyKHBhcmVudF9jbXAsIGdlbmNvbXBzLkxBWU9VVF9JVEVNX0tFWSk6DQogICAgICAgIGxpdGVtcyA9IFtdDQogICAgICAgIGZvciBsaXRlbV9jYWNoZSBpbiBjYWNoZWRfbGF5b3V0aXRlbXM6DQogICAgICAgICAgICAjIGdyYWIgdGhlIGxheW91dCBkaXJlY3RpdmUgY2FjaGUgYW5kIGNyZWF0ZSBjb21wb25lbnQNCiAgICAgICAgICAgIGxkaXIgPSBOb25lDQogICAgICAgICAgICBsZGlyX2NhY2hlID0gbGl0ZW1fY2FjaGUuZ2V0KGdlbmNvbXBzLkxBWU9VVF9ESVJfS0VZLCB7fSkNCiAgICAgICAgICAgIGlmIGxkaXJfY2FjaGU6DQogICAgICAgICAgICAgICAgbGRpciA9IGdlbmNvbXBzLkxheW91dERpcmVjdGl2ZSgpDQogICAgICAgICAgICAgICAgbGRpci5sb2FkX2NhY2hlX2RhdGEobGRpcl9jYWNoZSkNCg0KICAgICAgICAgICAgbGl0ZW0gPSBnZW5jb21wcy5MYXlvdXRJdGVtKCkNCiAgICAgICAgICAgIGxpdGVtLmxvYWRfY2FjaGVfZGF0YShsaXRlbV9jYWNoZSkNCiAgICAgICAgICAgICMgc2V0IHRoZSBsYXlvdXQgZGlyZWN0aXZlDQogICAgICAgICAgICBzZXRhdHRyKGxpdGVtLCBnZW5jb21wcy5MQVlPVVRfRElSX0tFWSwgbGRpcikNCiAgICAgICAgICAgIGxpdGVtcy5hcHBlbmQobGl0ZW0pDQogICAgICAgIHNldGF0dHIocGFyZW50X2NtcCwgZ2VuY29tcHMuTEFZT1VUX0lURU1fS0VZLCBsaXRlbXMpDQoNCg0KZGVmIF9tYWtlX3N1Yl9jbXBfZnJvbV9jYWNoZShwYXJlbnRfY21wLCBjYWNoZWRfc3ViX2NtcHMpOg0KICAgIG1sb2dnZXIuZGVidWcoJ1Byb2Nlc3NpbmcgY2FjaGUgZm9yOiAlcycsIHBhcmVudF9jbXApDQogICAgIyBnZXQgYWxsb3dlZCBjbGFzc2VzIHVuZGVyIHRoaXMgY29tcG9uZW50DQogICAgYWxsb3dlZF9zdWJfY21wcyA9IGdldF9hbGxfc3ViY2xhc3NlcyhwYXJlbnRfY21wLmFsbG93ZWRfc3ViX2NtcHMpDQogICAgbWxvZ2dlci5kZWJ1ZygnQWxsb3dlZCBzdWIgY29tcG9uZW50cyBhcmU6ICVzJywgYWxsb3dlZF9zdWJfY21wcykNCiAgICAjIGl0ZXJhdGUgdGhyb3VnaCBsaXN0IG9mIGNhY2hlZCBzdWIgY29tcG9uZW50cw0KICAgIGZvciBjYWNoZWRfY21wIGluIGNhY2hlZF9zdWJfY21wczogICMgdHlwZTogZGljdA0KICAgICAgICBmb3Igc3ViX2NsYXNzIGluIGFsbG93ZWRfc3ViX2NtcHM6DQogICAgICAgICAgICBpZiBzdWJfY2xhc3MudHlwZV9pZCA9PSBjYWNoZWRfY21wW2dlbmNvbXBzLlRZUEVfSURfS0VZXToNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDcmVhdGluZyBzdWIgY29tcG9uZW50IGZyb20gY2FjaGU6ICVzLCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZWRfY21wW2dlbmNvbXBzLk5BTUVfS0VZXSwgc3ViX2NsYXNzKQ0KDQogICAgICAgICAgICAgICAgIyBjYWNoZWRfY21wIG1pZ2h0IGNvbnRhaW4gZ2VuY29tcHMuU1VCX0NNUF9LRVkuIFRoaXMgbmVlZHMgdG8gYmUNCiAgICAgICAgICAgICAgICAjIHJlbW92ZWQgc2luY2UgdGhpcyBmdW5jdGlvbiB3aWxsIG1ha2UgYWxsIHRoZSBjaGlsZHJlbg0KICAgICAgICAgICAgICAgICMgcmVjdXJzaXZlbHkuIFNvIGlmIHRoaXMgY29tcG9uZW50IGhhcyBnZW5jb21wcy5TVUJfQ01QX0tFWSBtZWFucw0KICAgICAgICAgICAgICAgICMgaXQgaGFzIHN1YiBjb21wb25lbnRzOg0KICAgICAgICAgICAgICAgIHN1Yl9jbXBfY2FjaGUgPSBOb25lDQogICAgICAgICAgICAgICAgaWYgZ2VuY29tcHMuU1VCX0NNUF9LRVkgaW4gY2FjaGVkX2NtcC5rZXlzKCk6DQogICAgICAgICAgICAgICAgICAgICMgZHJvcCBzdWJjb21wb25lbnRzIGRpY3QgZnJvbSBjYWNoZWRfY21wIHNpbmNlIHdlDQogICAgICAgICAgICAgICAgICAgICMgZG9uJ3Qgd2FudCB0aGUgbG9hZGVkX2NtcCB0byBpbmNsdWRlIHRoaXMNCiAgICAgICAgICAgICAgICAgICAgc3ViX2NtcF9jYWNoZSA9IGNhY2hlZF9jbXAucG9wKGdlbmNvbXBzLlNVQl9DTVBfS0VZKQ0KDQogICAgICAgICAgICAgICAgIyBncmFiIHRoZSBsYXlvdXQgaXRlbXMNCiAgICAgICAgICAgICAgICAjIGxheW91dGl0ZW1zX2NhY2hlIGlzIGxpc3RbZGljdF0NCiAgICAgICAgICAgICAgICBsYXlvdXRpdGVtc19jYWNoZSA9IE5vbmUNCiAgICAgICAgICAgICAgICBpZiBnZW5jb21wcy5MQVlPVVRfSVRFTV9LRVkgaW4gY2FjaGVkX2NtcC5rZXlzKCk6DQogICAgICAgICAgICAgICAgICAgICMgZHJvcCBsYXlvdXRpdGVtcyBkaWN0IGZyb20gY2FjaGVkX2NtcCBzaW5jZSB3ZQ0KICAgICAgICAgICAgICAgICAgICAjIGRvbid0IHdhbnQgdGhlIGxvYWRlZF9jbXAgdG8gaW5jbHVkZSB0aGlzDQogICAgICAgICAgICAgICAgICAgIGxheW91dGl0ZW1zX2NhY2hlID0gY2FjaGVkX2NtcC5wb3AoZ2VuY29tcHMuTEFZT1VUX0lURU1fS0VZKQ0KDQogICAgICAgICAgICAgICAgIyBjcmVhdGUgc3ViIGNvbXBvbmVudCBmcm9tIGNsZWFuZWQgY2FjaGVkX2NtcA0KICAgICAgICAgICAgICAgIGxvYWRlZF9jbXAgPSBzdWJfY2xhc3MoKQ0KICAgICAgICAgICAgICAgIGxvYWRlZF9jbXAubG9hZF9jYWNoZV9kYXRhKGNhY2hlZF9jbXApDQoNCiAgICAgICAgICAgICAgICAjIG5vdyBwcm9jZXNzIHN1YiBjb21wb25lbnRzIGZvciBsb2FkZWRfY21wIGlmIGFueQ0KICAgICAgICAgICAgICAgIGlmIHN1Yl9jbXBfY2FjaGU6DQogICAgICAgICAgICAgICAgICAgIF9tYWtlX3N1Yl9jbXBfZnJvbV9jYWNoZShsb2FkZWRfY21wLCBzdWJfY21wX2NhY2hlKQ0KDQogICAgICAgICAgICAgICAgIyBhcHBseSBsYXlvdXQgaXRlbXMNCiAgICAgICAgICAgICAgICBpZiBsYXlvdXRpdGVtc19jYWNoZToNCiAgICAgICAgICAgICAgICAgICAgX21ha2VfbGF5b3V0aXRlbXNfZnJvbV9jYWNoZShsb2FkZWRfY21wLCBsYXlvdXRpdGVtc19jYWNoZSkNCg0KICAgICAgICAgICAgICAgIHBhcmVudF9jbXAuYWRkX2NvbXBvbmVudChsb2FkZWRfY21wKQ0KDQoNCmRlZiBfcmVhZF9jYWNoZV9mb3IoY2FjaGVkX2V4dCk6DQogICAgdHJ5Og0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdSZWFkaW5nIGNhY2hlIGZvcjogJXMnLCBjYWNoZWRfZXh0KQ0KICAgICAgICBjYWNoZV9maWxlID0gX2dldF9jYWNoZV9maWxlKGNhY2hlZF9leHQpDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0NhY2hlIGZpbGUgaXM6ICVzJywgY2FjaGVfZmlsZSkNCiAgICAgICAgd2l0aCBjb2RlY3Mub3BlbihfZ2V0X2NhY2hlX2ZpbGUoY2FjaGVkX2V4dCksICdyJywgJ3V0Zi04JykgXA0KICAgICAgICAgICAgICAgIGFzIGNhY2hlX2ZpbGU6DQogICAgICAgICAgICBjYWNoZWRfdGFiX2RpY3QgPSBqc29uLmxvYWQoY2FjaGVfZmlsZSkNCiAgICAgICAgcmV0dXJuIGNhY2hlZF90YWJfZGljdA0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKCdFcnJvciByZWFkaW5nIGNhY2hlIGZvcjoge30gfCB7fScNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KGNhY2hlZF9leHQsIGVycikpDQoNCg0KZGVmIF93cml0ZV9jYWNoZV9mb3IocGFyc2VkX2V4dCk6DQogICAgdHJ5Og0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdXcml0aW5nIGNhY2hlIGZvcjogJXMnLCBwYXJzZWRfZXh0KQ0KICAgICAgICBjYWNoZV9maWxlID0gX2dldF9jYWNoZV9maWxlKHBhcnNlZF9leHQpDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0NhY2hlIGZpbGUgaXM6ICVzJywgY2FjaGVfZmlsZSkNCiAgICAgICAgd2l0aCBjb2RlY3Mub3BlbihjYWNoZV9maWxlLCAndycsICd1dGYtOCcpIGFzIGNhY2hlX2ZpbGU6DQogICAgICAgICAgICBjYWNoZV9maWxlLndyaXRlKF9tYWtlX2NhY2hlX2Zyb21fY21wKHBhcnNlZF9leHQpKQ0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdFcnJvciB3cml0aW5nIGNhY2hlLi4uJykNCiAgICAgICAgcmFpc2UgUHlSZXZpdEV4Y2VwdGlvbignRXJyb3Igd3JpdGluZyBjYWNoZSBmb3I6IHt9IHwge30nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChwYXJzZWRfZXh0LCBlcnIpKQ0KDQoNCmRlZiB1cGRhdGVfY2FjaGUocGFyc2VkX2V4dCk6DQogICAgbWxvZ2dlci5kZWJ1ZygnVXBkYXRpbmcgY2FjaGUgZm9yIHRhYjogJXMgLi4uJywgcGFyc2VkX2V4dC5uYW1lKQ0KICAgIF93cml0ZV9jYWNoZV9mb3IocGFyc2VkX2V4dCkNCiAgICBtbG9nZ2VyLmRlYnVnKCdDYWNoZSB1cGRhdGVkIGZvciB0YWI6ICVzJywgcGFyc2VkX2V4dC5uYW1lKQ0KDQoNCmRlZiBnZXRfY2FjaGVkX2V4dGVuc2lvbihpbnN0YWxsZWRfZXh0KToNCiAgICBjYWNoZWRfZXh0X2RpY3QgPSBfcmVhZF9jYWNoZV9mb3IoaW5zdGFsbGVkX2V4dCkNCiAgICAjIHRyeToNCiAgICBtbG9nZ2VyLmRlYnVnKCdDb25zdHJ1Y3RpbmcgY29tcG9uZW50cyBmcm9tIGNhY2hlIGZvcjogJXMnLA0KICAgICAgICAgICAgICAgICAgICBpbnN0YWxsZWRfZXh0KQ0KICAgICMgZ2V0IGNhY2hlZCBzdWIgY29tcG9uZW50IGRpY3Rpb25hcnkgYW5kIGNhbGwgcmVjdXJzaXZlIG1ha2VyIGZ1bmN0aW9uDQogICAgX21ha2Vfc3ViX2NtcF9mcm9tX2NhY2hlKGluc3RhbGxlZF9leHQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlZF9leHRfZGljdC5wb3AoZ2VuY29tcHMuU1VCX0NNUF9LRVkpKQ0KICAgIG1sb2dnZXIuZGVidWcoJ0xvYWQgc3VjY2Vzc2Z1bC4uLicpDQogICAgIyBleGNlcHQgRXhjZXB0aW9uIGFzIGVycjoNCiAgICAjICAgICBtbG9nZ2VyLmRlYnVnKCdFcnJvciByZWFkaW5nIGNhY2hlLi4uJykNCiAgICAjICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKCdFcnJvciBjcmVhdGluZyBleHQgZnJvbSBjYWNoZSBmb3I6IHt9IHwge30nDQogICAgIyAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KGluc3RhbGxlZF9leHQubmFtZSwgZXJyKSkNCg0KICAgIHJldHVybiBpbnN0YWxsZWRfZXh0DQoNCg0KZGVmIGlzX2NhY2hlX3ZhbGlkKGV4dGVuc2lvbik6DQogICAgdHJ5Og0KICAgICAgICBjYWNoZWRfZXh0X2RpY3QgPSBfcmVhZF9jYWNoZV9mb3IoZXh0ZW5zaW9uKSAgIyB0eXBlOiBkaWN0DQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0V4dGVuc2lvbiBjYWNoZSBkaXJlY3RvcnkgaXM6ICVzIGZvcjogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbi5kaXJlY3RvcnksIGV4dGVuc2lvbikNCiAgICAgICAgY2FjaGVfZGlyX3ZhbGlkID0gY2FjaGVkX2V4dF9kaWN0W2dlbmNvbXBzLkVYVF9ESVJfS0VZXSA9PSBleHRlbnNpb24uZGlyZWN0b3J5DQoNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRXh0ZW5zaW9uIGNhY2hlIHZlcnNpb24gaXM6ICVzIGZvcjogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbi5weXJ2dF92ZXJzaW9uLCBleHRlbnNpb24pDQogICAgICAgIGNhY2hlX3ZlcnNpb25fdmFsaWQgPSBcDQogICAgICAgICAgICBjYWNoZWRfZXh0X2RpY3RbY29tcHMuRVhUX0hBU0hfVkVSU0lPTl9LRVldID09IGV4dGVuc2lvbi5weXJ2dF92ZXJzaW9uDQoNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRXh0ZW5zaW9uIGhhc2ggdmFsdWUgaXM6ICVzIGZvcjolcycsDQogICAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uLmRpcl9oYXNoX3ZhbHVlLCBleHRlbnNpb24pDQogICAgICAgIGNhY2hlX2hhc2hfdmFsaWQgPSBcDQogICAgICAgICAgICBjYWNoZWRfZXh0X2RpY3RbY29tcHMuRVhUX0hBU0hfVkFMVUVfS0VZXSA9PSBleHRlbnNpb24uZGlyX2hhc2hfdmFsdWUNCg0KICAgICAgICBjYWNoZV92YWxpZCA9IFwNCiAgICAgICAgICAgIGNhY2hlX2Rpcl92YWxpZCBhbmQgY2FjaGVfdmVyc2lvbl92YWxpZCBhbmQgY2FjaGVfaGFzaF92YWxpZA0KDQogICAgICAgICMgY2FjaGUgaXMgdmFsaWQgaWYgYm90aCB2ZXJzaW9uIGFuZCBoYXNoIHZhbHVlIG1hdGNoDQogICAgICAgIHJldHVybiBjYWNoZV92YWxpZA0KDQogICAgZXhjZXB0IFB5UmV2aXRFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKGVycikNCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGVycjoNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRXJyb3IgZGV0ZXJtaW5pbmcgY2FjaGUgdmFsaWRpdHk6ICVzIHwgJXMnLA0KICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbiwgZXJyKQ0KDQoiIiJSZXVzYWJsZSBXUEYgZm9ybXMgZm9yIHB5UmV2aXQuDQoNCkV4YW1wbGVzOg0KICAgIGBgYHB5dGhvbg0KICAgIGZyb20gcHlyZXZpdC5mb3JtcyBpbXBvcnQgV1BGV2luZG93DQogICAgYGBgDQoiIiINCiNweWxpbnQ6IGRpc2FibGU9Y29uc2lkZXItdXNpbmctZi1zdHJpbmcsd3JvbmctaW1wb3J0LXBvc2l0aW9uDQoNCmltcG9ydCByZQ0KaW1wb3J0IHN5cw0KaW1wb3J0IG9zDQppbXBvcnQgb3MucGF0aCBhcyBvcA0KaW1wb3J0IHN0cmluZw0KZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgT3JkZXJlZERpY3QsIG5hbWVkdHVwbGUNCmltcG9ydCB0aHJlYWRpbmcNCmZyb20gZnVuY3Rvb2xzIGltcG9ydCB3cmFwcw0KaW1wb3J0IGRhdGV0aW1lDQppbXBvcnQgd2ViYnJvd3Nlcg0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IEhPU1RfQVBQLCBFWEVDX1BBUkFNUywgRE9DUywgQklOX0RJUg0KZnJvbSBweXJldml0IGltcG9ydCBQeVJldml0Q1B5dGhvbk5vdFN1cHBvcnRlZCwgUHlSZXZpdEV4Y2VwdGlvbg0KZnJvbSBweXJldml0LmNvbXBhdCBpbXBvcnQgUFkzLCBJUk9OUFkzNDANCmZyb20gcHlyZXZpdC5jb21wYXQgaW1wb3J0IHNhZmVfc3RydHlwZQ0KDQppZiBQWTMgYW5kIG5vdCBJUk9OUFkzNDA6DQogICAgcmFpc2UgUHlSZXZpdENQeXRob25Ob3RTdXBwb3J0ZWQoJ3B5cmV2aXQuZm9ybXMnKQ0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IGNvcmV1dGlscw0KZnJvbSBweXJldml0LmNvcmV1dGlscy5sb2dnZXIgaW1wb3J0IGdldF9sb2dnZXINCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGNvbG9ycw0KZnJvbSBweXJldml0IGltcG9ydCBmcmFtZXdvcmsNCmZyb20gcHlyZXZpdC5mcmFtZXdvcmsgaW1wb3J0IFN5c3RlbQ0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgVGhyZWFkaW5nDQpmcm9tIHB5cmV2aXQuZnJhbWV3b3JrIGltcG9ydCBJbnRlcm9wDQpmcm9tIHB5cmV2aXQuZnJhbWV3b3JrIGltcG9ydCBJbnB1dA0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgd3BmLCBGb3JtcywgQ29udHJvbHMsIE1lZGlhDQpmcm9tIHB5cmV2aXQuZnJhbWV3b3JrIGltcG9ydCBDUERpYWxvZ3MNCmZyb20gcHlyZXZpdC5mcmFtZXdvcmsgaW1wb3J0IENvbXBvbmVudE1vZGVsDQpmcm9tIHB5cmV2aXQuZnJhbWV3b3JrIGltcG9ydCBPYnNlcnZhYmxlQ29sbGVjdGlvbg0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgVXJpLCBVcmlLaW5kLCBSZXNvdXJjZURpY3Rpb25hcnkNCmZyb20gcHlyZXZpdC5hcGkgaW1wb3J0IEFkV2luZG93cw0KZnJvbSBweXJldml0IGltcG9ydCByZXZpdCwgVUksIERCDQpmcm9tIHB5cmV2aXQuZm9ybXMgaW1wb3J0IHV0aWxzDQpmcm9tIHB5cmV2aXQuZm9ybXMgaW1wb3J0IHRvYXN0ZXINCmZyb20gcHlyZXZpdCBpbXBvcnQgdmVyc2lvbm1ncg0KZnJvbSBweXJldml0LnVzZXJjb25maWcgaW1wb3J0IHVzZXJfY29uZmlnDQoNCmltcG9ydCBweWV2ZW50ICNweWxpbnQ6IGRpc2FibGU9aW1wb3J0LWVycm9yDQoNCmltcG9ydCBBdXRvZGVzay5XaW5kb3dzLkNvbXBvbmVudE1hbmFnZXIgI3B5bGludDogZGlzYWJsZT1pbXBvcnQtZXJyb3INCmltcG9ydCBBdXRvZGVzay5JbnRlcm5hbC5JbmZvQ2VudGVyICNweWxpbnQ6IGRpc2FibGU9aW1wb3J0LWVycm9yDQoNCiNweWxpbnQ6IGRpc2FibGU9VzA3MDMsQzAzMDIsQzAxMDMNCm1sb2dnZXIgPSBnZXRfbG9nZ2VyKF9fbmFtZV9fKQ0KDQoNCkRFRkFVTFRfQ01EU1dJVENIV05EX1dJRFRIID0gNjAwDQpERUZBVUxUX1NFQVJDSFdORF9XSURUSCA9IDYwMA0KREVGQVVMVF9TRUFSQ0hXTkRfSEVJR0hUID0gMTAwDQpERUZBVUxUX0lOUFVUV0lORE9XX1dJRFRIID0gNTAwDQpERUZBVUxUX0lOUFVUV0lORE9XX0hFSUdIVCA9IDYwMA0KREVGQVVMVF9SRUNPR05JWkVfQUNDRVNTX0tFWSA9IEZhbHNlDQoNCldQRl9ISURERU4gPSBmcmFtZXdvcmsuV2luZG93cy5WaXNpYmlsaXR5LkhpZGRlbg0KV1BGX0NPTExBUFNFRCA9IGZyYW1ld29yay5XaW5kb3dzLlZpc2liaWxpdHkuQ29sbGFwc2VkDQpXUEZfVklTSUJMRSA9IGZyYW1ld29yay5XaW5kb3dzLlZpc2liaWxpdHkuVmlzaWJsZQ0KDQoNClhBTUxfRklMRVNfRElSID0gb3AuZGlybmFtZShfX2ZpbGVfXykNCg0KDQpQYXJhbURlZiA9IG5hbWVkdHVwbGUoJ1BhcmFtRGVmJywgWyduYW1lJywgJ2lzdHlwZScsICdkZWZpbml0aW9uJywgJ2lzcmVhZG9ubHknXSkNCiIiIlBhcmFtZXRlciBkZWZpbml0aW9uIHR1cGxlLg0KDQpBdHRyaWJ1dGVzOg0KICAgIG5hbWUgKHN0cik6IHBhcmFtZXRlciBuYW1lDQogICAgaXN0eXBlIChib29sKTogdHJ1ZSBpZiB0eXBlIHBhcmFtZXRlciwgb3RoZXJ3aXNlIGZhbHNlDQogICAgZGVmaW5pdGlvbiAoQXV0b2Rlc2suUmV2aXQuREIuRGVmaW5pdGlvbik6IHBhcmFtZXRlciBkZWZpbml0aW9uIG9iamVjdA0KICAgIGlzcmVhZG9ubHkgKGJvb2wpOiB0cnVlIGlmIHRoZSBwYXJhbWV0ZXIgdmFsdWUgY2FuJ3QgYmUgZWRpdGVkDQoiIiINCg0KDQojIGh0dHBzOi8vZ3VpLWF0LmJsb2dzcG90LmNvbS8yMDA5LzExL2lub3RpZnlwcm9wZXJ0eWNoYW5nZWQtaW4taXJvbnB5dGhvbi5odG1sDQpjbGFzcyByZWFjdGl2ZShwcm9wZXJ0eSk6DQogICAgIiIiRGVjb3JhdG9yIGZvciBXUEYgYm91bmQgcHJvcGVydGllcy4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgZ2V0dGVyKToNCiAgICAgICAgZGVmIG5ld2dldHRlcih1aV9jb250cm9sKToNCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyKHVpX2NvbnRyb2wpDQogICAgICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6DQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUNCiAgICAgICAgc3VwZXIocmVhY3RpdmUsIHNlbGYpLl9faW5pdF9fKG5ld2dldHRlcikNCg0KICAgIGRlZiBzZXR0ZXIoc2VsZiwgc2V0dGVyKToNCiAgICAgICAgIiIiUHJvcGVydHkgc2V0dGVyLiIiIg0KICAgICAgICBkZWYgbmV3c2V0dGVyKHVpX2NvbnRyb2wsIG5ld3ZhbHVlKToNCiAgICAgICAgICAgIG9sZHZhbHVlID0gc2VsZi5mZ2V0KHVpX2NvbnRyb2wpDQogICAgICAgICAgICBpZiBvbGR2YWx1ZSAhPSBuZXd2YWx1ZToNCiAgICAgICAgICAgICAgICBzZXR0ZXIodWlfY29udHJvbCwgbmV3dmFsdWUpDQogICAgICAgICAgICAgICAgdWlfY29udHJvbC5PblByb3BlcnR5Q2hhbmdlZChzZXR0ZXIuX19uYW1lX18pDQogICAgICAgIHJldHVybiBwcm9wZXJ0eSgNCiAgICAgICAgICAgIGZnZXQ9c2VsZi5mZ2V0LA0KICAgICAgICAgICAgZnNldD1uZXdzZXR0ZXIsDQogICAgICAgICAgICBmZGVsPXNlbGYuZmRlbCwNCiAgICAgICAgICAgIGRvYz1zZWxmLl9fZG9jX18pDQoNCg0KY2xhc3MgUmVhY3RpdmUoQ29tcG9uZW50TW9kZWwuSU5vdGlmeVByb3BlcnR5Q2hhbmdlZCk6DQogICAgIiIiV1BGIHByb3BlcnR5IHVwZGF0b3IgYmFzZSBtaXhpbi4iIiINCiAgICBQcm9wZXJ0eUNoYW5nZWQsIF9wcm9wZXJ0eUNoYW5nZWRDYWxsZXIgPSBweWV2ZW50Lm1ha2VfZXZlbnQoKQ0KDQogICAgZGVmIGFkZF9Qcm9wZXJ0eUNoYW5nZWQoc2VsZiwgdmFsdWUpOg0KICAgICAgICAiIiJDYWxsZWQgd2hlbiBhIHByb3BlcnR5IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QuIiIiDQogICAgICAgIHNlbGYuUHJvcGVydHlDaGFuZ2VkICs9IHZhbHVlDQoNCiAgICBkZWYgcmVtb3ZlX1Byb3BlcnR5Q2hhbmdlZChzZWxmLCB2YWx1ZSk6DQogICAgICAgICIiIkNhbGxlZCB3aGVuIGEgcHJvcGVydHkgaXMgcmVtb3ZlZCBmcm9tIHRoZSBvYmplY3QuIiIiDQogICAgICAgIHNlbGYuUHJvcGVydHlDaGFuZ2VkIC09IHZhbHVlDQoNCiAgICBkZWYgT25Qcm9wZXJ0eUNoYW5nZWQoc2VsZiwgcHJvcF9uYW1lKToNCiAgICAgICAgIiIiQ2FsbGVkIHdoZW4gYSBwcm9wZXJ0eSBpcyBjaGFuZ2VkLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBwcm9wX25hbWUgKHN0cik6IHByb3BlcnR5IG5hbWUNCiAgICAgICAgIiIiDQogICAgICAgIGlmIHNlbGYuX3Byb3BlcnR5Q2hhbmdlZENhbGxlcjoNCiAgICAgICAgICAgIGFyZ3MgPSBDb21wb25lbnRNb2RlbC5Qcm9wZXJ0eUNoYW5nZWRFdmVudEFyZ3MocHJvcF9uYW1lKQ0KICAgICAgICAgICAgc2VsZi5fcHJvcGVydHlDaGFuZ2VkQ2FsbGVyKHNlbGYsIGFyZ3MpDQoNCg0KY2xhc3MgV2luZG93VG9nZ2xlcihvYmplY3QpOg0KICAgICIiIkNvbnRleHQgbWFuYWdlciB0byB0b2dnbGUgd2luZG93IHZpc2liaWxpdHkuIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIHdpbmRvdyk6DQogICAgICAgIHNlbGYuX3dpbmRvdyA9IHdpbmRvdw0KDQogICAgZGVmIF9fZW50ZXJfXyhzZWxmKToNCiAgICAgICAgc2VsZi5fd2luZG93LmhpZGUoKQ0KDQogICAgZGVmIF9fZXhpdF9fKHNlbGYsIGV4Y2VwdGlvbiwgZXhjZXB0aW9uX3ZhbHVlLCB0cmFjZWJhY2spOg0KICAgICAgICBzZWxmLl93aW5kb3cuc2hvd19kaWFsb2coKQ0KDQoNCmNsYXNzIFdQRldpbmRvdyhmcmFtZXdvcmsuV2luZG93cy5XaW5kb3cpOg0KICAgIHIiIiJXUEYgV2luZG93IGJhc2UgY2xhc3MgZm9yIGFsbCBweVJldml0IGZvcm1zLg0KDQogICAgQXJnczoNCiAgICAgICAgeGFtbF9zb3VyY2UgKHN0cik6IHhhbWwgc291cmNlIGZpbGVwYXRoIG9yIHhhbWwgY29udGVudA0KICAgICAgICBsaXRlcmFsX3N0cmluZyAoYm9vbCk6IHhhbWxfc291cmNlIGNvbnRhaW5zIHhhbWwgY29udGVudCwgbm90IGZpbGVwYXRoDQogICAgICAgIGhhbmRsZV9lc2MgKGJvb2wpOiBoYW5kbGUgRXNjYXBlIGJ1dHRvbiBhbmQgY2xvc2UgdGhlIHdpbmRvdw0KICAgICAgICBzZXRfb3duZXIgKGJvb2wpOiBzZXQgdGhlIG93bmVyIG9mIHdpbmRvdyB0byBob3N0IGFwcCB3aW5kb3cNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBsYXlvdXQgPSAnPFdpbmRvdyAnIFwNCiAgICAgICAgICAgICAgICAgJ3htbG5zPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbC9wcmVzZW50YXRpb24iICcgXA0KICAgICAgICAgICAgICAgICAneG1sbnM6eD0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwiICcgXA0KICAgICAgICAgICAgICAgICAnU2hvd0luVGFza2Jhcj0iRmFsc2UiIFJlc2l6ZU1vZGU9Ik5vUmVzaXplIiAnIFwNCiAgICAgICAgICAgICAgICAgJ1dpbmRvd1N0YXJ0dXBMb2NhdGlvbj0iQ2VudGVyU2NyZWVuIiAnIFwNCiAgICAgICAgICAgICAgICAgJ0hvcml6b250YWxDb250ZW50QWxpZ25tZW50PSJDZW50ZXIiPicgXA0KICAgICAgICAgICAgICAgICAnPC9XaW5kb3c+Jw0KICAgICAgICB3ID0gZm9ybXMuV1BGV2luZG93KGxheW91dCwgbGl0ZXJhbF9zdHJpbmc9VHJ1ZSkNCiAgICAgICAgdy5zaG93KCkNCiAgICAgICAgYGBgDQogICAgIiIiDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgeGFtbF9zb3VyY2UsIGxpdGVyYWxfc3RyaW5nPUZhbHNlLCBoYW5kbGVfZXNjPVRydWUsIHNldF9vd25lcj1UcnVlKToNCiAgICAgICAgIiIiSW5pdGlhbGl6ZSBXUEYgd2luZG93IGFuZCByZXNvdXJjZXMuIiIiDQogICAgICAgICMgbG9hZCB4YW1sDQogICAgICAgIHNlbGYubG9hZF94YW1sKA0KICAgICAgICAgICAgeGFtbF9zb3VyY2UsDQogICAgICAgICAgICBsaXRlcmFsX3N0cmluZz1saXRlcmFsX3N0cmluZywNCiAgICAgICAgICAgIGhhbmRsZV9lc2M9aGFuZGxlX2VzYywNCiAgICAgICAgICAgIHNldF9vd25lcj1zZXRfb3duZXINCiAgICAgICAgICAgICkNCg0KICAgIGRlZiBsb2FkX3hhbWwoc2VsZiwgeGFtbF9zb3VyY2UsIGxpdGVyYWxfc3RyaW5nPUZhbHNlLCBoYW5kbGVfZXNjPVRydWUsIHNldF9vd25lcj1UcnVlKToNCiAgICAgICAgIiIiTG9hZCB0aGUgd2luZG93IFhBTUwgZmlsZS4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgeGFtbF9zb3VyY2UgKHN0cik6IFRoZSBYQU1MIGNvbnRlbnQgb3IgZmlsZSBwYXRoIHRvIGxvYWQuDQogICAgICAgICAgICBsaXRlcmFsX3N0cmluZyAoYm9vbCwgb3B0aW9uYWwpOiBUcnVlIGlmIGB4YW1sX3NvdXJjZWAgaXMgY29udGVudCwNCiAgICAgICAgICAgICAgICBGYWxzZSBpZiBpdCBpcyBhIHBhdGguIERlZmF1bHRzIHRvIEZhbHNlLg0KICAgICAgICAgICAgaGFuZGxlX2VzYyAoYm9vbCwgb3B0aW9uYWwpOiBXaGV0aGVyIHRoZSBFU0Mga2V5IHNob3VsZCBiZSBoYW5kbGVkLg0KICAgICAgICAgICAgICAgIERlZmF1bHRzIHRvIFRydWUuDQogICAgICAgICAgICBzZXRfb3duZXIgKGJvb2wsIG9wdGlvbmFsKTogV2hldGhlciB0byBzZSB0aGUgd2luZG93IG93bmVyLg0KICAgICAgICAgICAgICAgIERlZmF1bHRzIHRvIFRydWUuDQogICAgICAgICIiIg0KICAgICAgICAjIGNyZWF0ZSBuZXcgaWQgZm9yIHRoaXMgd2luZG93DQogICAgICAgIHNlbGYud2luZG93X2lkID0gY29yZXV0aWxzLm5ld191dWlkKCkNCg0KICAgICAgICBpZiBub3QgbGl0ZXJhbF9zdHJpbmc6DQogICAgICAgICAgICB3cGYuTG9hZENvbXBvbmVudChzZWxmLCBzZWxmLl9kZXRlcm1pbmVfeGFtbCh4YW1sX3NvdXJjZSkpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICB3cGYuTG9hZENvbXBvbmVudChzZWxmLCBmcmFtZXdvcmsuU3RyaW5nUmVhZGVyKHhhbWxfc291cmNlKSkNCg0KICAgICAgICAjIHNldCBwcm9wZXJ0aWVzDQogICAgICAgIHNlbGYudGhyZWFkX2lkID0gZnJhbWV3b3JrLmdldF9jdXJyZW50X3RocmVhZF9pZCgpDQogICAgICAgIGlmIHNldF9vd25lcjoNCiAgICAgICAgICAgIHNlbGYuc2V0dXBfb3duZXIoKQ0KICAgICAgICBzZWxmLnNldHVwX2ljb24oKQ0KICAgICAgICBXUEZXaW5kb3cuc2V0dXBfcmVzb3VyY2VzKHNlbGYpDQogICAgICAgIGlmIGhhbmRsZV9lc2M6DQogICAgICAgICAgICBzZWxmLnNldHVwX2RlZmF1bHRfaGFuZGxlcnMoKQ0KDQoNCiAgICBkZWYgX2RldGVybWluZV94YW1sKHNlbGYsIHhhbWxfc291cmNlKToNCiAgICAgICAgeGFtbF9maWxlID0geGFtbF9zb3VyY2UNCiAgICAgICAgaWYgbm90IG9wLmV4aXN0cyh4YW1sX2ZpbGUpOg0KICAgICAgICAgICAgeGFtbF9maWxlID0gb3MucGF0aC5qb2luKEVYRUNfUEFSQU1TLmNvbW1hbmRfcGF0aCwgeGFtbF9zb3VyY2UpDQoNCiAgICAgICAgZW5nbGlzaF94YW1sX2ZpbGUgPSB4YW1sX2ZpbGUucmVwbGFjZSgnLnhhbWwnLCAnLmVuX3VzLnhhbWwnKQ0KICAgICAgICBsb2NhbGl6ZWRfeGFtbF9maWxlID0geGFtbF9maWxlLnJlcGxhY2UoDQogICAgICAgICAgICAnLnhhbWwnLA0KICAgICAgICAgICAgJy57fS54YW1sJy5mb3JtYXQodXNlcl9jb25maWcudXNlcl9sb2NhbGUpDQogICAgICAgICkNCg0KICAgICAgICBlbmdsaXNoX3hhbWxfcmVzZmlsZSA9IFwNCiAgICAgICAgICAgIHhhbWxfZmlsZS5yZXBsYWNlKCcueGFtbCcsICcuUmVzb3VyY2VEaWN0aW9uYXJ5LmVuX3VzLnhhbWwnKQ0KICAgICAgICBsb2NhbGl6ZWRfeGFtbF9yZXNmaWxlID0geGFtbF9maWxlLnJlcGxhY2UoDQogICAgICAgICAgICAnLnhhbWwnLA0KICAgICAgICAgICAgJy5SZXNvdXJjZURpY3Rpb25hcnkue30ueGFtbCcuZm9ybWF0KHVzZXJfY29uZmlnLnVzZXJfbG9jYWxlKQ0KICAgICAgICApDQoNCiAgICAgICAgIyBpZiBsb2NhbGl6ZWQgdmVyc2lvbiBvZiB4YW1sIGZpbGUgaXMgcHJvdmlkZWQsIHVzZSB0aGF0DQogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGxvY2FsaXplZF94YW1sX2ZpbGUpOg0KICAgICAgICAgICAgcmV0dXJuIGxvY2FsaXplZF94YW1sX2ZpbGUNCg0KICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShlbmdsaXNoX3hhbWxfZmlsZSk6DQogICAgICAgICAgICByZXR1cm4gZW5nbGlzaF94YW1sX2ZpbGUNCg0KICAgICAgICAjIG90aGVyd2lzZSBsb29rIGZvciAuUmVzb3VyY2VEaWN0aW9uYXJ5IGZpbGVzIGFuZCBsb2FkIHRob3NlLA0KICAgICAgICAjIHJldHVybmluZyB0aGUgb3JpZ2luYWwgeGFtbF9maWxlDQogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGxvY2FsaXplZF94YW1sX3Jlc2ZpbGUpOg0KICAgICAgICAgICAgc2VsZi5tZXJnZV9yZXNvdXJjZV9kaWN0KGxvY2FsaXplZF94YW1sX3Jlc2ZpbGUpDQoNCiAgICAgICAgZWxpZiBvcy5wYXRoLmlzZmlsZShlbmdsaXNoX3hhbWxfcmVzZmlsZSk6DQogICAgICAgICAgICBzZWxmLm1lcmdlX3Jlc291cmNlX2RpY3QoZW5nbGlzaF94YW1sX3Jlc2ZpbGUpDQoNCiAgICAgICAgcmV0dXJuIHhhbWxfZmlsZQ0KDQogICAgZGVmIG1lcmdlX3Jlc291cmNlX2RpY3Qoc2VsZiwgeGFtbF9zb3VyY2UpOg0KICAgICAgICAiIiJNZXJnZSBhIFJlc291cmNlRGljdGlvbmFyeSB4YW1sIGZpbGUgd2l0aCB0aGlzIHdpbmRvdy4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgeGFtbF9zb3VyY2UgKHN0cik6IHhhbWwgZmlsZSB3aXRoIHRoZSByZXNvdXJjZSBkaWN0aW9uYXJ5DQogICAgICAgICIiIg0KICAgICAgICBsYW5nX2RpY3Rpb25hcnkgPSBSZXNvdXJjZURpY3Rpb25hcnkoKQ0KICAgICAgICBsYW5nX2RpY3Rpb25hcnkuU291cmNlID0gVXJpKHhhbWxfc291cmNlLCBVcmlLaW5kLkFic29sdXRlKQ0KICAgICAgICBzZWxmLlJlc291cmNlcy5NZXJnZWREaWN0aW9uYXJpZXMuQWRkKGxhbmdfZGljdGlvbmFyeSkNCg0KICAgIGRlZiBnZXRfbG9jYWxlX3N0cmluZyhzZWxmLCBzdHJpbmdfbmFtZSk6DQogICAgICAgICIiIkdldCBsb2NhbGl6ZWQgc3RyaW5nLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBzdHJpbmdfbmFtZSAoc3RyKTogc3RyaW5nIG5hbWUNCg0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgKHN0cik6IGxvY2FsaXplZCBzdHJpbmcNCiAgICAgICAgIiIiDQogICAgICAgIHJldHVybiBzZWxmLkZpbmRSZXNvdXJjZShzdHJpbmdfbmFtZSkNCg0KICAgIGRlZiBzZXR1cF9vd25lcihzZWxmKToNCiAgICAgICAgIiIiU2V0IHRoZSB3aW5kb3cgb3duZXIuIiIiDQogICAgICAgIHdpaCA9IEludGVyb3AuV2luZG93SW50ZXJvcEhlbHBlcihzZWxmKQ0KICAgICAgICB3aWguT3duZXIgPSBBZFdpbmRvd3MuQ29tcG9uZW50TWFuYWdlci5BcHBsaWNhdGlvbldpbmRvdw0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiBzZXR1cF9yZXNvdXJjZXMod3BmX2N0cmwpOg0KICAgICAgICAiIiJTZXRzIHRoZSBXUEYgcmVzb3VyY2VzLiIiIg0KICAgICAgICAjMmMzZTUwDQogICAgICAgIHdwZl9jdHJsLlJlc291cmNlc1sncHlSZXZpdERhcmtDb2xvciddID0gXA0KICAgICAgICAgICAgTWVkaWEuQ29sb3IuRnJvbUFyZ2IoMHhGRiwgMHgyYywgMHgzZSwgMHg1MCkNCg0KICAgICAgICAjMjMzMDNkDQogICAgICAgIHdwZl9jdHJsLlJlc291cmNlc1sncHlSZXZpdERhcmtlckRhcmtDb2xvciddID0gXA0KICAgICAgICAgICAgTWVkaWEuQ29sb3IuRnJvbUFyZ2IoMHhGRiwgMHgyMywgMHgzMCwgMHgzZCkNCg0KICAgICAgICAjZmZmZmZmDQogICAgICAgIHdwZl9jdHJsLlJlc291cmNlc1sncHlSZXZpdEJ1dHRvbkNvbG9yJ10gPSBcDQogICAgICAgICAgICBNZWRpYS5Db2xvci5Gcm9tQXJnYigweEZGLCAweGZmLCAweGZmLCAweGZmKQ0KDQogICAgICAgICNmMzljMTINCiAgICAgICAgd3BmX2N0cmwuUmVzb3VyY2VzWydweVJldml0QWNjZW50Q29sb3InXSA9IFwNCiAgICAgICAgICAgIE1lZGlhLkNvbG9yLkZyb21BcmdiKDB4RkYsIDB4ZjMsIDB4OWMsIDB4MTIpDQoNCiAgICAgICAgd3BmX2N0cmwuUmVzb3VyY2VzWydweVJldml0RGFya0JydXNoJ10gPSBcDQogICAgICAgICAgICBNZWRpYS5Tb2xpZENvbG9yQnJ1c2god3BmX2N0cmwuUmVzb3VyY2VzWydweVJldml0RGFya0NvbG9yJ10pDQogICAgICAgIHdwZl9jdHJsLlJlc291cmNlc1sncHlSZXZpdEFjY2VudEJydXNoJ10gPSBcDQogICAgICAgICAgICBNZWRpYS5Tb2xpZENvbG9yQnJ1c2god3BmX2N0cmwuUmVzb3VyY2VzWydweVJldml0QWNjZW50Q29sb3InXSkNCg0KICAgICAgICB3cGZfY3RybC5SZXNvdXJjZXNbJ3B5UmV2aXREYXJrZXJEYXJrQnJ1c2gnXSA9IFwNCiAgICAgICAgICAgIE1lZGlhLlNvbGlkQ29sb3JCcnVzaCh3cGZfY3RybC5SZXNvdXJjZXNbJ3B5UmV2aXREYXJrZXJEYXJrQ29sb3InXSkNCg0KICAgICAgICB3cGZfY3RybC5SZXNvdXJjZXNbJ3B5UmV2aXRCdXR0b25Gb3Jncm91bmRCcnVzaCddID0gXA0KICAgICAgICAgICAgTWVkaWEuU29saWRDb2xvckJydXNoKHdwZl9jdHJsLlJlc291cmNlc1sncHlSZXZpdEJ1dHRvbkNvbG9yJ10pDQoNCiAgICAgICAgd3BmX2N0cmwuUmVzb3VyY2VzWydweVJldml0UmVjb2duaXplc0FjY2Vzc0tleSddID0gXA0KICAgICAgICAgICAgREVGQVVMVF9SRUNPR05JWkVfQUNDRVNTX0tFWQ0KDQogICAgZGVmIHNldHVwX2RlZmF1bHRfaGFuZGxlcnMoc2VsZik6DQogICAgICAgICIiIlNldCB0aGUgZGVmYXVsdCBoYW5kbGVycy4iIiINCiAgICAgICAgc2VsZi5QcmV2aWV3S2V5RG93biArPSBzZWxmLmhhbmRsZV9pbnB1dF9rZXkgICAgI3B5bGludDogZGlzYWJsZT1FMTEwMQ0KDQogICAgZGVmIGhhbmRsZV9pbnB1dF9rZXkoc2VsZiwgc2VuZGVyLCBhcmdzKTogICAgI3B5bGludDogZGlzYWJsZT1XMDYxMw0KICAgICAgICAiIiJIYW5kbGUga2V5Ym9hcmQgaW5wdXQgYW5kIGNsb3NlIHRoZSB3aW5kb3cgb24gRXNjYXBlLiIiIg0KICAgICAgICBpZiBhcmdzLktleSA9PSBJbnB1dC5LZXkuRXNjYXBlOg0KICAgICAgICAgICAgc2VsZi5DbG9zZSgpDQoNCiAgICBkZWYgc2V0X2ljb24oc2VsZiwgaWNvbl9wYXRoKToNCiAgICAgICAgIiIiU2V0IHdpbmRvdyBpY29uIHRvIGdpdmVuIGljb24gcGF0aC4iIiINCiAgICAgICAgc2VsZi5JY29uID0gdXRpbHMuYml0bWFwX2Zyb21fZmlsZShpY29uX3BhdGgpDQoNCiAgICBkZWYgc2V0dXBfaWNvbihzZWxmKToNCiAgICAgICAgIiIiU2V0dXAgZGVmYXVsdCB3aW5kb3cgaWNvbi4iIiINCiAgICAgICAgc2VsZi5zZXRfaWNvbihvcC5qb2luKEJJTl9ESVIsICdweXJldml0X3NldHRpbmdzLnBuZycpKQ0KDQogICAgZGVmIGhpZGUoc2VsZik6DQogICAgICAgICIiIkhpZGUgd2luZG93LiIiIg0KICAgICAgICBzZWxmLkhpZGUoKQ0KDQogICAgZGVmIHNob3coc2VsZiwgbW9kYWw9RmFsc2UpOg0KICAgICAgICAiIiJTaG93IHdpbmRvdy4iIiINCiAgICAgICAgaWYgbW9kYWw6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5TaG93RGlhbG9nKCkNCiAgICAgICAgIyBlbHNlIG9wZW4gbm9uLW1vZGFsDQogICAgICAgIHNlbGYuU2hvdygpDQoNCiAgICBkZWYgc2hvd19kaWFsb2coc2VsZik6DQogICAgICAgICIiIlNob3cgbW9kYWwgd2luZG93LiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5TaG93RGlhbG9nKCkNCg0KICAgIEBzdGF0aWNtZXRob2QNCiAgICBkZWYgc2V0X2ltYWdlX3NvdXJjZV9maWxlKHdwZl9lbGVtZW50LCBpbWFnZV9maWxlKToNCiAgICAgICAgIiIiU2V0IHNvdXJjZSBmaWxlIGZvciBpbWFnZSBlbGVtZW50Lg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICB3cGZfZWxlbWVudCAoU3lzdGVtLldpbmRvd3MuQ29udHJvbHMuSW1hZ2UpOiB4YW1sIGltYWdlIGVsZW1lbnQNCiAgICAgICAgICAgIGltYWdlX2ZpbGUgKHN0cik6IGltYWdlIGZpbGUgcGF0aA0KICAgICAgICAiIiINCiAgICAgICAgaWYgbm90IG9wLmV4aXN0cyhpbWFnZV9maWxlKToNCiAgICAgICAgICAgIHdwZl9lbGVtZW50LlNvdXJjZSA9IFwNCiAgICAgICAgICAgICAgICB1dGlscy5iaXRtYXBfZnJvbV9maWxlKA0KICAgICAgICAgICAgICAgICAgICBvcy5wYXRoLmpvaW4oRVhFQ19QQVJBTVMuY29tbWFuZF9wYXRoLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VfZmlsZSkNCiAgICAgICAgICAgICAgICAgICAgKQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgd3BmX2VsZW1lbnQuU291cmNlID0gdXRpbHMuYml0bWFwX2Zyb21fZmlsZShpbWFnZV9maWxlKQ0KDQogICAgZGVmIHNldF9pbWFnZV9zb3VyY2Uoc2VsZiwgd3BmX2VsZW1lbnQsIGltYWdlX2ZpbGUpOg0KICAgICAgICAiIiJTZXQgc291cmNlIGZpbGUgZm9yIGltYWdlIGVsZW1lbnQuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIHdwZl9lbGVtZW50IChTeXN0ZW0uV2luZG93cy5Db250cm9scy5JbWFnZSk6IHhhbWwgaW1hZ2UgZWxlbWVudA0KICAgICAgICAgICAgaW1hZ2VfZmlsZSAoc3RyKTogaW1hZ2UgZmlsZSBwYXRoDQogICAgICAgICIiIg0KICAgICAgICBXUEZXaW5kb3cuc2V0X2ltYWdlX3NvdXJjZV9maWxlKHdwZl9lbGVtZW50LCBpbWFnZV9maWxlKQ0KDQogICAgZGVmIGRpc3BhdGNoKHNlbGYsIGZ1bmMsICphcmdzLCAqKmt3YXJncyk6DQogICAgICAgICIiIlJ1bnMgdGhlIGZ1bmN0aW9uIGluIGEgbmV3IHRocmVhZC4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgZnVuYyAoQ2FsbGFibGUpOiBmdW5jdGlvbiB0byBydW4NCiAgICAgICAgICAgICphcmdzIChBbnkpOiBwb3NpdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIGZ1bmMNCiAgICAgICAgICAgICoqa3dhcmdzIChBbnkpOiBrZXl3b3JkIGFyZ3VtZW50cyB0byBwYXNzIHRvIGZ1bmMNCiAgICAgICAgIiIiDQogICAgICAgIGlmIGZyYW1ld29yay5nZXRfY3VycmVudF90aHJlYWRfaWQoKSA9PSBzZWxmLnRocmVhZF9pZDoNCiAgICAgICAgICAgIHQgPSB0aHJlYWRpbmcuVGhyZWFkKA0KICAgICAgICAgICAgICAgIHRhcmdldD1mdW5jLA0KICAgICAgICAgICAgICAgIGFyZ3M9YXJncywNCiAgICAgICAgICAgICAgICBrd2FyZ3M9a3dhcmdzDQogICAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgdC5zdGFydCgpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICAjIGFzayB1aSB0aHJlYWQgdG8gY2FsbCB0aGUgZnVuYyB3aXRoIGFyZ3MgYW5kIGt3YXJncw0KICAgICAgICAgICAgc2VsZi5EaXNwYXRjaGVyLkludm9rZSgNCiAgICAgICAgICAgICAgICBTeXN0ZW0uQWN0aW9uKA0KICAgICAgICAgICAgICAgICAgICBsYW1iZGE6IGZ1bmMoKmFyZ3MsICoqa3dhcmdzKQ0KICAgICAgICAgICAgICAgICAgICApLA0KICAgICAgICAgICAgICAgIFRocmVhZGluZy5EaXNwYXRjaGVyUHJpb3JpdHkuQmFja2dyb3VuZA0KICAgICAgICAgICAgICAgICkNCg0KICAgIGRlZiBjb25jZWFsKHNlbGYpOg0KICAgICAgICAiIiJDb25jZWFsIHdpbmRvdy4iIiINCiAgICAgICAgcmV0dXJuIFdpbmRvd1RvZ2dsZXIoc2VsZikNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBweXJldml0X3ZlcnNpb24oc2VsZik6DQogICAgICAgICIiIkFjdGl2ZSBweVJldml0IGZvcm1hdHRlZCB2ZXJzaW9uIGUuZy4gJzQuOS1iZXRhJy4iIiINCiAgICAgICAgcmV0dXJuICdweVJldml0IHt9Jy5mb3JtYXQoDQogICAgICAgICAgICB2ZXJzaW9ubWdyLmdldF9weXJldml0X3ZlcnNpb24oKS5nZXRfZm9ybWF0dGVkKCkNCiAgICAgICAgICAgICkNCg0KICAgIEBzdGF0aWNtZXRob2QNCiAgICBkZWYgaGlkZV9lbGVtZW50KCp3cGZfZWxlbWVudHMpOg0KICAgICAgICAiIiJDb2xsYXBzZSBlbGVtZW50cy4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgKndwZl9lbGVtZW50cyAobGlzdFtVSUVsZW1lbnRdKTogV1BGIGZyYW1ld29yayBlbGVtZW50cyB0byBiZSBjb2xsYXBlZA0KICAgICAgICAiIiINCiAgICAgICAgZm9yIHdwZmVsIGluIHdwZl9lbGVtZW50czoNCiAgICAgICAgICAgIHdwZmVsLlZpc2liaWxpdHkgPSBXUEZfQ09MTEFQU0VEDQoNCiAgICBAc3RhdGljbWV0aG9kDQogICAgZGVmIHNob3dfZWxlbWVudCgqd3BmX2VsZW1lbnRzKToNCiAgICAgICAgIiIiU2hvdyBjb2xsYXBzZWQgZWxlbWVudHMuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgICp3cGZfZWxlbWVudHMgKGxpc3RbVUlFbGVtZW50XSk6IFdQRiBmcmFtZXdvcmsgZWxlbWVudHMgdG8gYmUgc2V0IHRvIHZpc2libGUuDQogICAgICAgICIiIg0KICAgICAgICBmb3Igd3BmZWwgaW4gd3BmX2VsZW1lbnRzOg0KICAgICAgICAgICAgd3BmZWwuVmlzaWJpbGl0eSA9IFdQRl9WSVNJQkxFDQoNCiAgICBAc3RhdGljbWV0aG9kDQogICAgZGVmIHRvZ2dsZV9lbGVtZW50KCp3cGZfZWxlbWVudHMpOg0KICAgICAgICAiIiJUb2dnbGUgdmlzaWJpbGl0eSBvZiBlbGVtZW50cy4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgKndwZl9lbGVtZW50cyAobGlzdFtVSUVsZW1lbnRdKTogV1BGIGZyYW1ld29yayBlbGVtZW50cyB0byBiZSB0b2dnbGVkLg0KICAgICAgICAiIiINCiAgICAgICAgZm9yIHdwZmVsIGluIHdwZl9lbGVtZW50czoNCiAgICAgICAgICAgIGlmIHdwZmVsLlZpc2liaWxpdHkgPT0gV1BGX1ZJU0lCTEU6DQogICAgICAgICAgICAgICAgV1BGV2luZG93LmhpZGVfZWxlbWVudCh3cGZlbCkNCiAgICAgICAgICAgIGVsaWYgd3BmZWwuVmlzaWJpbGl0eSA9PSBXUEZfQ09MTEFQU0VEOg0KICAgICAgICAgICAgICAgIFdQRldpbmRvdy5zaG93X2VsZW1lbnQod3BmZWwpDQoNCiAgICBAc3RhdGljbWV0aG9kDQogICAgZGVmIGRpc2FibGVfZWxlbWVudCgqd3BmX2VsZW1lbnRzKToNCiAgICAgICAgIiIiRW5hYmxlIGVsZW1lbnRzLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICAqd3BmX2VsZW1lbnRzIChsaXN0W1VJRWxlbWVudF0pOiBXUEYgZnJhbWV3b3JrIGVsZW1lbnRzIHRvIGJlIGVuYWJsZWQNCiAgICAgICAgIiIiDQogICAgICAgIGZvciB3cGZlbCBpbiB3cGZfZWxlbWVudHM6DQogICAgICAgICAgICB3cGZlbC5Jc0VuYWJsZWQgPSBGYWxzZQ0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiBlbmFibGVfZWxlbWVudCgqd3BmX2VsZW1lbnRzKToNCiAgICAgICAgIiIiRW5hYmxlIGVsZW1lbnRzLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICAqd3BmX2VsZW1lbnRzIChsaXN0W1VJRWxlbWVudF0pOiBXUEYgZnJhbWV3b3JrIGVsZW1lbnRzIHRvIGJlIGVuYWJsZWQNCiAgICAgICAgIiIiDQogICAgICAgIGZvciB3cGZlbCBpbiB3cGZfZWxlbWVudHM6DQogICAgICAgICAgICB3cGZlbC5Jc0VuYWJsZWQgPSBUcnVlDQoNCiAgICBkZWYgaGFuZGxlX3VybF9jbGljayhzZWxmLCBzZW5kZXIsIGFyZ3MpOiAjcHlsaW50OiBkaXNhYmxlPXVudXNlZC1hcmd1bWVudA0KICAgICAgICAiIiJDYWxsYmFjayBmb3IgaGFuZGxpbmcgY2xpY2sgb24gcGFja2FnZSB3ZWJzaXRlIHVybC4iIiINCiAgICAgICAgcmV0dXJuIHdlYmJyb3dzZXIub3Blbl9uZXdfdGFiKHNlbmRlci5OYXZpZ2F0ZVVyaS5BYnNvbHV0ZVVyaSkNCg0KDQpjbGFzcyBXUEZQYW5lbChmcmFtZXdvcmsuV2luZG93cy5Db250cm9scy5QYWdlKToNCiAgICByIiIiV1BGIHBhbmVsIGJhc2UgY2xhc3MgZm9yIGFsbCBweVJldml0IGRvY2thYmxlIHBhbmVscy4NCg0KICAgIHBhbmVsX2lkIChzdHIpIG11c3QgYmUgc2V0IG9uIHRoZSB0eXBlIHRvIGRvY2thYmxlIHBhbmVsIHV1aWQNCiAgICBwYW5lbF9zb3VyY2UgKHN0cik6IHhhbWwgc291cmNlIGZpbGVwYXRoDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZyb20gcHlyZXZpdCBpbXBvcnQgZm9ybXMNCiAgICAgICAgY2xhc3MgTXlQYW5lbChmb3Jtcy5XUEZQYW5lbCk6DQogICAgICAgICAgICBwYW5lbF9pZCA9ICIxODFlMDVhNC0yOGY2LTQzMTEtOGE5Zi1kMmFhNTI4Yzg3NTUiDQogICAgICAgICAgICBwYW5lbF9zb3VyY2UgPSAiTXlQYW5lbC54YW1sIg0KDQogICAgICAgIGZvcm1zLnJlZ2lzdGVyX2RvY2thYmxlX3BhbmVsKE15UGFuZWwpDQogICAgICAgICMgdGhlbiBmcm9tIHRoZSBidXR0b24gdGhhdCBuZWVkcyB0byBvcGVuIHRoZSBwYW5lbA0KICAgICAgICBmb3Jtcy5vcGVuX2RvY2thYmxlX3BhbmVsKCIxODFlMDVhNC0yOGY2LTQzMTEtOGE5Zi1kMmFhNTI4Yzg3NTUiKQ0KICAgICAgICBgYGANCiAgICAiIiINCg0KICAgIHBhbmVsX2lkID0gTm9uZQ0KICAgIHBhbmVsX3NvdXJjZSA9IE5vbmUNCg0KICAgIGRlZiBfX2luaXRfXyhzZWxmKToNCiAgICAgICAgIiIiSW5pdGlhbGl6ZSBXUEYgcGFuZWwgYW5kIHJlc291cmNlcy4iIiINCiAgICAgICAgaWYgbm90IHNlbGYucGFuZWxfaWQ6DQogICAgICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKCJcInBhbmVsX2lkXCIgcHJvcGVydHkgaXMgbm90IHNldCIpDQogICAgICAgIGlmIG5vdCBzZWxmLnBhbmVsX3NvdXJjZToNCiAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRFeGNlcHRpb24oIlwicGFuZWxfc291cmNlXCIgcHJvcGVydHkgaXMgbm90IHNldCIpDQoNCiAgICAgICAgaWYgbm90IG9wLmV4aXN0cyhzZWxmLnBhbmVsX3NvdXJjZSk6DQogICAgICAgICAgICB3cGYuTG9hZENvbXBvbmVudChzZWxmLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MucGF0aC5qb2luKEVYRUNfUEFSQU1TLmNvbW1hbmRfcGF0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGFuZWxfc291cmNlKSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHdwZi5Mb2FkQ29tcG9uZW50KHNlbGYsIHNlbGYucGFuZWxfc291cmNlKQ0KDQogICAgICAgICMgc2V0IHByb3BlcnRpZXMNCiAgICAgICAgc2VsZi50aHJlYWRfaWQgPSBmcmFtZXdvcmsuZ2V0X2N1cnJlbnRfdGhyZWFkX2lkKCkNCiAgICAgICAgV1BGV2luZG93LnNldHVwX3Jlc291cmNlcyhzZWxmKQ0KDQogICAgZGVmIHNldF9pbWFnZV9zb3VyY2Uoc2VsZiwgd3BmX2VsZW1lbnQsIGltYWdlX2ZpbGUpOg0KICAgICAgICAiIiJTZXQgc291cmNlIGZpbGUgZm9yIGltYWdlIGVsZW1lbnQuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIHdwZl9lbGVtZW50IChTeXN0ZW0uV2luZG93cy5Db250cm9scy5JbWFnZSk6IHhhbWwgaW1hZ2UgZWxlbWVudA0KICAgICAgICAgICAgaW1hZ2VfZmlsZSAoc3RyKTogaW1hZ2UgZmlsZSBwYXRoDQogICAgICAgICIiIg0KICAgICAgICBXUEZXaW5kb3cuc2V0X2ltYWdlX3NvdXJjZV9maWxlKHdwZl9lbGVtZW50LCBpbWFnZV9maWxlKQ0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiBoaWRlX2VsZW1lbnQoKndwZl9lbGVtZW50cyk6DQogICAgICAgICIiIkNvbGxhcHNlIGVsZW1lbnRzLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICAqd3BmX2VsZW1lbnRzIChsaXN0W1VJRWxlbWVudF0pOiBXUEYgZnJhbWV3b3JrIGVsZW1lbnRzIHRvIGJlIGNvbGxhcGVkDQogICAgICAgICIiIg0KICAgICAgICBXUEZQYW5lbC5oaWRlX2VsZW1lbnQoKndwZl9lbGVtZW50cykNCg0KICAgIEBzdGF0aWNtZXRob2QNCiAgICBkZWYgc2hvd19lbGVtZW50KCp3cGZfZWxlbWVudHMpOg0KICAgICAgICAiIiJTaG93IGNvbGxhcHNlZCBlbGVtZW50cy4NCg0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgKndwZl9lbGVtZW50cyAobGlzdFtVSUVsZW1lbnRdKTogV1BGIGZyYW1ld29yayBlbGVtZW50cyB0byBiZSBzZXQgdG8gdmlzaWJsZS4NCiAgICAgICAgIiIiDQogICAgICAgIFdQRlBhbmVsLnNob3dfZWxlbWVudCgqd3BmX2VsZW1lbnRzKQ0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiB0b2dnbGVfZWxlbWVudCgqd3BmX2VsZW1lbnRzKToNCiAgICAgICAgIiIiVG9nZ2xlIHZpc2liaWxpdHkgb2YgZWxlbWVudHMuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgICp3cGZfZWxlbWVudHMgKGxpc3RbVUlFbGVtZW50XSk6IFdQRiBmcmFtZXdvcmsgZWxlbWVudHMgdG8gYmUgdG9nZ2xlZC4NCiAgICAgICAgIiIiDQogICAgICAgIFdQRlBhbmVsLnRvZ2dsZV9lbGVtZW50KCp3cGZfZWxlbWVudHMpDQoNCiAgICBAc3RhdGljbWV0aG9kDQogICAgZGVmIGRpc2FibGVfZWxlbWVudCgqd3BmX2VsZW1lbnRzKToNCiAgICAgICAgIiIiRW5hYmxlIGVsZW1lbnRzLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICAqd3BmX2VsZW1lbnRzIChsaXN0W1VJRWxlbWVudF0pOiBXUEYgZnJhbWV3b3JrIGVsZW1lbnRzIHRvIGJlIGVuYWJsZWQNCiAgICAgICAgIiIiDQogICAgICAgIFdQRlBhbmVsLmRpc2FibGVfZWxlbWVudCgqd3BmX2VsZW1lbnRzKQ0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiBlbmFibGVfZWxlbWVudCgqd3BmX2VsZW1lbnRzKToNCiAgICAgICAgIiIiRW5hYmxlIGVsZW1lbnRzLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICAqd3BmX2VsZW1lbnRzIChsaXN0KTogV1BGIGZyYW1ld29yayBlbGVtZW50cyB0byBiZSBlbmFibGVkDQogICAgICAgICIiIg0KICAgICAgICBXUEZQYW5lbC5lbmFibGVfZWxlbWVudCgqd3BmX2VsZW1lbnRzKQ0KDQogICAgZGVmIGhhbmRsZV91cmxfY2xpY2soc2VsZiwgc2VuZGVyLCBhcmdzKTogI3B5bGludDogZGlzYWJsZT11bnVzZWQtYXJndW1lbnQNCiAgICAgICAgIiIiQ2FsbGJhY2sgZm9yIGhhbmRsaW5nIGNsaWNrIG9uIHBhY2thZ2Ugd2Vic2l0ZSB1cmwuIiIiDQogICAgICAgIHJldHVybiB3ZWJicm93c2VyLm9wZW5fbmV3X3RhYihzZW5kZXIuTmF2aWdhdGVVcmkuQWJzb2x1dGVVcmkpDQoNCg0KY2xhc3MgX1dQRlBhbmVsUHJvdmlkZXIoVUkuSURvY2thYmxlUGFuZVByb3ZpZGVyKToNCiAgICAiIiJJbnRlcm5hbCBQYW5lbCBwcm92aWRlciBmb3IgcGFuZWxzLiIiIg0KDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIHBhbmVsX3R5cGUsIGRlZmF1bHRfdmlzaWJsZT1UcnVlKToNCiAgICAgICAgc2VsZi5fcGFuZWxfdHlwZSA9IHBhbmVsX3R5cGUNCiAgICAgICAgc2VsZi5fZGVmYXVsdF92aXNpYmxlID0gZGVmYXVsdF92aXNpYmxlDQogICAgICAgIHNlbGYucGFuZWwgPSBzZWxmLl9wYW5lbF90eXBlKCkNCg0KICAgIGRlZiBTZXR1cERvY2thYmxlUGFuZShzZWxmLCBkYXRhKToNCiAgICAgICAgIiIiU2V0dXAgZm9ybXMuV1BGUGFuZWwgc2V0IG9uIHRoaXMgaW5zdGFuY2UuIiIiDQogICAgICAgICMgVE9ETzogbmVlZCB0byBpbXBsZW1lbnQgcGFuZWwgZGF0YQ0KICAgICAgICAjIGh0dHBzOi8vYXBpZG9jcy5jby9hcHBzL3Jldml0LzIwMjEuMS85ODE1N2VjMi1hYjI2LTZhYjctMjkzMy1kMWI0MTYwYmEyYjguaHRtDQogICAgICAgIGRhdGEuRnJhbWV3b3JrRWxlbWVudCA9IHNlbGYucGFuZWwNCiAgICAgICAgZGF0YS5WaXNpYmxlQnlEZWZhdWx0ID0gc2VsZi5fZGVmYXVsdF92aXNpYmxlDQoNCg0KZGVmIGlzX3JlZ2lzdGVyZWRfZG9ja2FibGVfcGFuZWwocGFuZWxfdHlwZSk6DQogICAgIiIiQ2hlY2sgaWYgZG9ja2FibGUgcGFuZWwgaXMgYWxyZWFkeSByZWdpc3RlcmVkLg0KDQogICAgQXJnczoNCiAgICAgICAgcGFuZWxfdHlwZSAoZm9ybXMuV1BGUGFuZWwpOiBkb2NrYWJsZSBwYW5lbCB0eXBlDQogICAgIiIiDQogICAgcGFuZWxfdXVpZCA9IGNvcmV1dGlscy5HdWlkLlBhcnNlKHBhbmVsX3R5cGUucGFuZWxfaWQpDQogICAgZG9ja2FibGVfcGFuZWxfaWQgPSBVSS5Eb2NrYWJsZVBhbmVJZChwYW5lbF91dWlkKQ0KICAgIHJldHVybiBVSS5Eb2NrYWJsZVBhbmUuUGFuZUV4aXN0cyhkb2NrYWJsZV9wYW5lbF9pZCkNCg0KDQpkZWYgcmVnaXN0ZXJfZG9ja2FibGVfcGFuZWwocGFuZWxfdHlwZSwgZGVmYXVsdF92aXNpYmxlPVRydWUpOg0KICAgICIiIlJlZ2lzdGVyIGRvY2thYmxlIHBhbmVsLg0KDQogICAgQXJnczoNCiAgICAgICAgcGFuZWxfdHlwZSAoZm9ybXMuV1BGUGFuZWwpOiBkb2NrYWJsZSBwYW5lbCB0eXBlDQogICAgICAgIGRlZmF1bHRfdmlzaWJsZSAoYm9vbCwgb3B0aW9uYWwpOg0KICAgICAgICAgICAgd2hldGhlciBwYW5lbCBzaG91bGQgYmUgdmlzaWJsZSBieSBkZWZhdWx0DQogICAgIiIiDQogICAgaWYgbm90IGlzc3ViY2xhc3MocGFuZWxfdHlwZSwgV1BGUGFuZWwpOg0KICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKA0KICAgICAgICAgICAgIkRvY2thYmxlIHBhbmUgbXVzdCBiZSBhIHN1YmNsYXNzIG9mIGZvcm1zLldQRlBhbmVsIg0KICAgICAgICAgICAgKQ0KDQogICAgcGFuZWxfdXVpZCA9IGNvcmV1dGlscy5HdWlkLlBhcnNlKHBhbmVsX3R5cGUucGFuZWxfaWQpDQogICAgZG9ja2FibGVfcGFuZWxfaWQgPSBVSS5Eb2NrYWJsZVBhbmVJZChwYW5lbF91dWlkKQ0KICAgIHBhbmVsX3Byb3ZpZGVyID0gX1dQRlBhbmVsUHJvdmlkZXIocGFuZWxfdHlwZSwgZGVmYXVsdF92aXNpYmxlKQ0KICAgIEhPU1RfQVBQLnVpYXBwLlJlZ2lzdGVyRG9ja2FibGVQYW5lKA0KICAgICAgICBkb2NrYWJsZV9wYW5lbF9pZCwNCiAgICAgICAgcGFuZWxfdHlwZS5wYW5lbF90aXRsZSwNCiAgICAgICAgcGFuZWxfcHJvdmlkZXINCiAgICApDQoNCiAgICByZXR1cm4gcGFuZWxfcHJvdmlkZXIucGFuZWwNCg0KDQpkZWYgb3Blbl9kb2NrYWJsZV9wYW5lbChwYW5lbF90eXBlX29yX2lkKToNCiAgICAiIiJPcGVuIHByZXZpb3VzbHkgcmVnaXN0ZXJlZCBkb2NrYWJsZSBwYW5lbC4NCg0KICAgIEFyZ3M6DQogICAgICAgIHBhbmVsX3R5cGVfb3JfaWQgKGZvcm1zLldQRlBhbmVsLCBzdHIpOiBwYW5lbCB0eXBlIG9yIGlkDQogICAgIiIiDQogICAgdG9nZ2xlX2RvY2thYmxlX3BhbmVsKHBhbmVsX3R5cGVfb3JfaWQsIFRydWUpDQoNCg0KZGVmIGNsb3NlX2RvY2thYmxlX3BhbmVsKHBhbmVsX3R5cGVfb3JfaWQpOg0KICAgICIiIkNsb3NlIHByZXZpb3VzbHkgcmVnaXN0ZXJlZCBkb2NrYWJsZSBwYW5lbC4NCg0KICAgIEFyZ3M6DQogICAgICAgIHBhbmVsX3R5cGVfb3JfaWQgKGZvcm1zLldQRlBhbmVsLCBzdHIpOiBwYW5lbCB0eXBlIG9yIGlkDQogICAgIiIiDQogICAgdG9nZ2xlX2RvY2thYmxlX3BhbmVsKHBhbmVsX3R5cGVfb3JfaWQsIEZhbHNlKQ0KDQoNCmRlZiB0b2dnbGVfZG9ja2FibGVfcGFuZWwocGFuZWxfdHlwZV9vcl9pZCwgc3RhdGUpOg0KICAgICIiIlRvZ2dsZSBwcmV2aW91c2x5IHJlZ2lzdGVyZWQgZG9ja2FibGUgcGFuZWwuDQoNCiAgICBBcmdzOg0KICAgICAgICBwYW5lbF90eXBlX29yX2lkIChmb3Jtcy5XUEZQYW5lbCB8IHN0cik6IHBhbmVsIHR5cGUgb3IgaWQNCiAgICAgICAgc3RhdGUgKGJvb2wpOiBUcnVlIHRvIHNob3cgdGhlIHBhbmVsLCBGYWxzZSB0byBoaWRlIGl0Lg0KICAgICIiIg0KICAgIGRwYW5lbF9pZCA9IE5vbmUNCiAgICBpZiBpc2luc3RhbmNlKHBhbmVsX3R5cGVfb3JfaWQsIHN0cik6DQogICAgICAgIHBhbmVsX2lkID0gY29yZXV0aWxzLkd1aWQuUGFyc2UocGFuZWxfdHlwZV9vcl9pZCkNCiAgICAgICAgZHBhbmVsX2lkID0gVUkuRG9ja2FibGVQYW5lSWQocGFuZWxfaWQpDQogICAgZWxpZiBpc3N1YmNsYXNzKHBhbmVsX3R5cGVfb3JfaWQsIFdQRlBhbmVsKToNCiAgICAgICAgcGFuZWxfaWQgPSBjb3JldXRpbHMuR3VpZC5QYXJzZShwYW5lbF90eXBlX29yX2lkLnBhbmVsX2lkKQ0KICAgICAgICBkcGFuZWxfaWQgPSBVSS5Eb2NrYWJsZVBhbmVJZChwYW5lbF9pZCkNCiAgICBlbHNlOg0KICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKCJHaXZlbiB0eXBlIGlzIG5vdCBhIGZvcm1zLldQRlBhbmVsIikNCg0KICAgIGlmIGRwYW5lbF9pZDoNCiAgICAgICAgaWYgVUkuRG9ja2FibGVQYW5lLlBhbmVJc1JlZ2lzdGVyZWQoZHBhbmVsX2lkKToNCiAgICAgICAgICAgIGRvY2thYmxlX3BhbmVsID0gSE9TVF9BUFAudWlhcHAuR2V0RG9ja2FibGVQYW5lKGRwYW5lbF9pZCkNCiAgICAgICAgICAgIGlmIHN0YXRlOg0KICAgICAgICAgICAgICAgIGRvY2thYmxlX3BhbmVsLlNob3coKQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBkb2NrYWJsZV9wYW5lbC5IaWRlKCkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRFeGNlcHRpb24oDQogICAgICAgICAgICAgICAgIlBhbmVsIHdpdGggaWQgXCIlc1wiIGlzIG5vdCByZWdpc3RlcmVkIiAlIHBhbmVsX3R5cGVfb3JfaWQNCiAgICAgICAgICAgICAgICApDQoNCg0KY2xhc3MgVGVtcGxhdGVVc2VySW5wdXRXaW5kb3coV1BGV2luZG93KToNCiAgICAiIiJCYXNlIGNsYXNzIGZvciBweVJldml0IHVzZXIgaW5wdXQgc3RhbmRhcmQgZm9ybXMuDQoNCiAgICBBcmdzOg0KICAgICAgICBjb250ZXh0IChhbnkpOiB3aW5kb3cgY29udGV4dCBlbGVtZW50KHMpDQogICAgICAgIHRpdGxlIChzdHIpOiB3aW5kb3cgdGl0bGUNCiAgICAgICAgd2lkdGggKGludCk6IHdpbmRvdyB3aWR0aA0KICAgICAgICBoZWlnaHQgKGludCk6IHdpbmRvdyBoZWlnaHQNCiAgICAgICAgKiprd2FyZ3MgKEFueSk6IG90aGVyIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gOmZ1bmM6YF9zZXR1cGANCiAgICAiIiINCg0KICAgIHhhbWxfc291cmNlID0gJ0Jhc2VXaW5kb3cueGFtbCcNCg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb250ZXh0LCB0aXRsZSwgd2lkdGgsIGhlaWdodCwgKiprd2FyZ3MpOg0KICAgICAgICAiIiJJbml0aWFsaXplIHVzZXIgaW5wdXQgd2luZG93LiIiIg0KICAgICAgICBXUEZXaW5kb3cuX19pbml0X18oc2VsZiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wLmpvaW4oWEFNTF9GSUxFU19ESVIsIHNlbGYueGFtbF9zb3VyY2UpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlX2VzYz1UcnVlKQ0KICAgICAgICBzZWxmLlRpdGxlID0gdGl0bGUgb3IgJ3B5UmV2aXQnDQogICAgICAgIHNlbGYuV2lkdGggPSB3aWR0aA0KICAgICAgICBzZWxmLkhlaWdodCA9IGhlaWdodA0KDQogICAgICAgIHNlbGYuX2NvbnRleHQgPSBjb250ZXh0DQogICAgICAgIHNlbGYucmVzcG9uc2UgPSBOb25lDQoNCiAgICAgICAgIyBwYXJlbnQgd2luZG93Pw0KICAgICAgICBvd25lciA9IGt3YXJncy5nZXQoJ293bmVyJywgTm9uZSkNCiAgICAgICAgaWYgb3duZXI6DQogICAgICAgICAgICAjIHNldCB3cGYgd2luZG93cyBkaXJlY3RseQ0KICAgICAgICAgICAgc2VsZi5Pd25lciA9IG93bmVyDQogICAgICAgICAgICBzZWxmLldpbmRvd1N0YXJ0dXBMb2NhdGlvbiA9IFwNCiAgICAgICAgICAgICAgICBmcmFtZXdvcmsuV2luZG93cy5XaW5kb3dTdGFydHVwTG9jYXRpb24uQ2VudGVyT3duZXINCg0KICAgICAgICBzZWxmLl9zZXR1cCgqKmt3YXJncykNCg0KICAgIGRlZiBfc2V0dXAoc2VsZiwgKiprd2FyZ3MpOg0KICAgICAgICAiIiJQcml2YXRlIG1ldGhvZCB0byBiZSBvdmVycmlkZW4gYnkgc3ViY2xhc3NlcyBmb3Igd2luZG93IHNldHVwLiIiIg0KICAgICAgICBwYXNzDQoNCiAgICBAY2xhc3NtZXRob2QNCiAgICBkZWYgc2hvdyhjbHMsIGNvbnRleHQsICAjcHlsaW50OiBkaXNhYmxlPVcwMjIxDQogICAgICAgICAgICAgdGl0bGU9J1VzZXIgSW5wdXQnLA0KICAgICAgICAgICAgIHdpZHRoPURFRkFVTFRfSU5QVVRXSU5ET1dfV0lEVEgsDQogICAgICAgICAgICAgaGVpZ2h0PURFRkFVTFRfSU5QVVRXSU5ET1dfSEVJR0hULCAqKmt3YXJncyk6DQogICAgICAgICIiIlNob3cgdXNlciBpbnB1dCB3aW5kb3cuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIGNvbnRleHQgKGFueSk6IHdpbmRvdyBjb250ZXh0IGVsZW1lbnQocykNCiAgICAgICAgICAgIHRpdGxlIChzdHIpOiB3aW5kb3cgdGl0bGUNCiAgICAgICAgICAgIHdpZHRoIChpbnQpOiB3aW5kb3cgd2lkdGgNCiAgICAgICAgICAgIGhlaWdodCAoaW50KTogd2luZG93IGhlaWdodA0KICAgICAgICAgICAgKiprd2FyZ3MgKGFueSk6IG90aGVyIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gd2luZG93DQogICAgICAgICIiIg0KICAgICAgICBkbGcgPSBjbHMoY29udGV4dCwgdGl0bGUsIHdpZHRoLCBoZWlnaHQsICoqa3dhcmdzKQ0KICAgICAgICBkbGcuU2hvd0RpYWxvZygpDQogICAgICAgIHJldHVybiBkbGcucmVzcG9uc2UNCg0KDQpjbGFzcyBUZW1wbGF0ZUxpc3RJdGVtKFJlYWN0aXZlKToNCiAgICAiIiJCYXNlIGNsYXNzIGZvciBjaGVja2JveCBvcHRpb24gd3JhcHBpbmcgYW5vdGhlciBvYmplY3QuIiIiDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgb3JpZ19pdGVtLA0KICAgICAgICAgICAgICAgICBjaGVja2VkPUZhbHNlLCBjaGVja2FibGU9VHJ1ZSwgbmFtZV9hdHRyPU5vbmUpOg0KICAgICAgICAiIiJJbml0aWFsaXplIHRoZSBjaGVja2JveCBvcHRpb24gYW5kIHdyYXAgZ2l2ZW4gb2JqLg0KDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBvcmlnX2l0ZW0gKGFueSk6IE9iamVjdCB0byB3cmFwIChtdXN0IGhhdmUgbmFtZSBwcm9wZXJ0eQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBiZSBjb252ZXJ0YWJsZSB0byBzdHJpbmcgd2l0aCBzdHIoKQ0KICAgICAgICAgICAgY2hlY2tlZCAoYm9vbCk6IEluaXRpYWwgc3RhdGUuIERlZmF1bHRzIHRvIEZhbHNlDQogICAgICAgICAgICBjaGVja2FibGUgKGJvb2wpOiBVc2UgY2hlY2tib3ggZm9yIGl0ZW1zDQogICAgICAgICAgICBuYW1lX2F0dHIgKHN0cik6IEdldCB0aGlzIGF0dHJpYnV0ZSBvZiB3cmFwcGVkIG9iamVjdCBhcyBuYW1lDQogICAgICAgICIiIg0KICAgICAgICBzdXBlcihUZW1wbGF0ZUxpc3RJdGVtLCBzZWxmKS5fX2luaXRfXygpDQogICAgICAgIHNlbGYuaXRlbSA9IG9yaWdfaXRlbQ0KICAgICAgICBzZWxmLnN0YXRlID0gY2hlY2tlZA0KICAgICAgICBzZWxmLl9uYW1lYXR0ciA9IG5hbWVfYXR0cg0KICAgICAgICBzZWxmLl9jaGVja2FibGUgPSBjaGVja2FibGUNCg0KICAgIGRlZiBfX25vbnplcm9fXyhzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuc3RhdGUNCg0KICAgIGRlZiBfX3N0cl9fKHNlbGYpOg0KICAgICAgICByZXR1cm4gc2VsZi5uYW1lIG9yIHN0cihzZWxmLml0ZW0pDQoNCiAgICBkZWYgX19jb250YWluc19fKHNlbGYsIHZhbHVlKToNCiAgICAgICAgcmV0dXJuIHZhbHVlIGluIHNlbGYubmFtZQ0KDQogICAgZGVmIF9fZ2V0YXR0cl9fKHNlbGYsIHBhcmFtX25hbWUpOg0KICAgICAgICByZXR1cm4gZ2V0YXR0cihzZWxmLml0ZW0sIHBhcmFtX25hbWUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgbmFtZShzZWxmKToNCiAgICAgICAgIiIiTmFtZSBwcm9wZXJ0eS4iIiINCiAgICAgICAgIyBnZXQgY3VzdG9tIGF0dHIsIG9yIG5hbWUgb3IganVzdCBzdHIgcmVwcg0KICAgICAgICBpZiBzZWxmLl9uYW1lYXR0cjoNCiAgICAgICAgICAgIHJldHVybiBzYWZlX3N0cnR5cGUoZ2V0YXR0cihzZWxmLml0ZW0sIHNlbGYuX25hbWVhdHRyKSkNCiAgICAgICAgZWxpZiBoYXNhdHRyKHNlbGYuaXRlbSwgJ25hbWUnKToNCiAgICAgICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYuaXRlbSwgJ25hbWUnLCAnJykNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBzYWZlX3N0cnR5cGUoc2VsZi5pdGVtKQ0KDQogICAgZGVmIHVud3JhcChzZWxmKToNCiAgICAgICAgIiIiVW53cmFwIGFuZCByZXR1cm4gd3JhcHBlZCBvYmplY3QuIiIiDQogICAgICAgIHJldHVybiBzZWxmLml0ZW0NCg0KICAgIEByZWFjdGl2ZQ0KICAgIGRlZiBjaGVja2VkKHNlbGYpOg0KICAgICAgICAiIiJJZCBjaGVja2VkLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5zdGF0ZQ0KDQogICAgQGNoZWNrZWQuc2V0dGVyDQogICAgZGVmIGNoZWNrZWQoc2VsZiwgdmFsdWUpOg0KICAgICAgICBzZWxmLnN0YXRlID0gdmFsdWUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBjaGVja2FibGUoc2VsZik6DQogICAgICAgICIiIkxpc3QgSXRlbSBDaGVja0JveCBWaXNpYmlsaXR5LiIiIg0KICAgICAgICByZXR1cm4gV1BGX1ZJU0lCTEUgaWYgc2VsZi5fY2hlY2thYmxlIFwNCiAgICAgICAgICAgIGVsc2UgV1BGX0NPTExBUFNFRA0KDQogICAgQGNoZWNrYWJsZS5zZXR0ZXINCiAgICBkZWYgY2hlY2thYmxlKHNlbGYsIHZhbHVlKToNCiAgICAgICAgc2VsZi5fY2hlY2thYmxlID0gdmFsdWUNCg0KDQpjbGFzcyBTZWxlY3RGcm9tTGlzdChUZW1wbGF0ZVVzZXJJbnB1dFdpbmRvdyk6DQogICAgIiIiU3RhbmRhcmQgZm9ybSB0byBzZWxlY3QgZnJvbSBhIGxpc3Qgb2YgaXRlbXMuDQoNCiAgICBBbnkgb2JqZWN0IGNhbiBiZSBwYXNzZWQgaW4gYSBsaXN0IHRvIHRoZSBgYGNvbnRleHRgYCBhcmd1bWVudC4gVGhpcyBjbGFzcw0KICAgIHdyYXBzIHRoZSBvYmplY3RzIHBhc3NlZCB0byBjb250ZXh0LCBpbiBgVGVtcGxhdGVMaXN0SXRlbWAuDQogICAgVGhpcyBjbGFzcyBwcm92aWRlcyB0aGUgbmVjZXNzYXJ5IG1lY2hhbmlzbSB0byBtYWtlIHRoaXMgZm9ybSB3b3JrIGJvdGgNCiAgICBmb3Igc2VsZWN0aW5nIGl0ZW1zIGZyb20gYSBsaXN0LCBhbmQgZnJvbSBhIGxpc3Qgb2YgY2hlY2tib3hlcy4gU2VlIHRoZQ0KICAgIGxpc3Qgb2YgYXJndW1lbnRzIGJlbG93IGZvciBhZGRpdGlvbmFsIG9wdGlvbnMgYW5kIGZlYXR1cmVzLg0KDQogICAgQXJnczoNCiAgICAgICAgY29udGV4dCAobGlzdFtzdHJdIG9yIGRpY3RbbGlzdFtzdHJdXSk6DQogICAgICAgICAgICBsaXN0IG9mIGl0ZW1zIHRvIGJlIHNlbGVjdGVkIGZyb20NCiAgICAgICAgICAgIE9SDQogICAgICAgICAgICBkaWN0IG9mIGxpc3Qgb2YgaXRlbXMgdG8gYmUgc2VsZWN0ZWQgZnJvbS4NCiAgICAgICAgICAgIHVzZSBkaWN0IHdoZW4gaW5wdXQgaXRlbXMgbmVlZCB0byBiZSBncm91cGVkDQogICAgICAgICAgICBlLmcuIExpc3Qgb2Ygc2hlZXRzIGdyb3VwZWQgYnkgc2hlZXQgc2V0Lg0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IHdpbmRvdyB0aXRsZS4gc2VlIHN1cGVyIGNsYXNzIGZvciBkZWZhdWx0cy4NCiAgICAgICAgd2lkdGggKGludCwgb3B0aW9uYWwpOiB3aW5kb3cgd2lkdGguIHNlZSBzdXBlciBjbGFzcyBmb3IgZGVmYXVsdHMuDQogICAgICAgIGhlaWdodCAoaW50LCBvcHRpb25hbCk6IHdpbmRvdyBoZWlnaHQuIHNlZSBzdXBlciBjbGFzcyBmb3IgZGVmYXVsdHMuDQoNCiAgICBLZXl3b3JkIEFyZ3M6DQogICAgICAgIGJ1dHRvbl9uYW1lIChzdHIsIG9wdGlvbmFsKToNCiAgICAgICAgICAgIG5hbWUgb2Ygc2VsZWN0IGJ1dHRvbi4gZGVmYXVsdHMgdG8gJ1NlbGVjdCcNCiAgICAgICAgbmFtZV9hdHRyIChzdHIsIG9wdGlvbmFsKToNCiAgICAgICAgICAgIG9iamVjdCBhdHRyaWJ1dGUgdGhhdCBzaG91bGQgYmUgcmVhZCBhcyBpdGVtIG5hbWUuDQogICAgICAgIG11bHRpc2VsZWN0IChib29sLCBvcHRpb25hbCk6DQogICAgICAgICAgICBhbGxvdyBtdWx0aS1zZWxlY3Rpb24gKHVzZXMgY2hlY2sgYm94ZXMpLiBkZWZhdWx0cyB0byBGYWxzZQ0KICAgICAgICBpbmZvX3BhbmVsIChib29sLCBvcHRpb25hbCk6DQogICAgICAgICAgICBzaG93IGluZm9ybWF0aW9uIHBhbmVsIGFuZCBmaWxsIHdpdGggLmRlc2NyaXB0aW9uIHByb3BlcnR5IG9mIGl0ZW0NCiAgICAgICAgcmV0dXJuX2FsbCAoYm9vbCwgb3B0aW9uYWwpOg0KICAgICAgICAgICAgcmV0dXJuIGFsbCBpdGVtcy4gVGhpcyBpcyBoYW5kbHkgd2hlbiBzb21lIGlucHV0IGl0ZW1zIGhhdmUgc3RhdGVzDQogICAgICAgICAgICBhbmQgdGhlIHNjcmlwdCBuZWVkcyB0byBjaGVjayB0aGUgc3RhdGUgY2hhbmdlcyBvbiBhbGwgaXRlbXMuDQogICAgICAgICAgICBUaGlzIG9wdGlvbnMgd29ya3MgaW4gbXVsdGlzZWxlY3QgbW9kZSBvbmx5LiBkZWZhdWx0cyB0byBGYWxzZQ0KICAgICAgICBmaWx0ZXJmdW5jIChmdW5jdGlvbik6DQogICAgICAgICAgICBmaWx0ZXIgZnVuY3Rpb24gdG8gYmUgYXBwbGllZCB0byBjb250ZXh0IGl0ZW1zLg0KICAgICAgICByZXNldGZ1bmMgKGZ1bmN0aW9uKToNCiAgICAgICAgICAgIHJlc2V0IGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHVzZXIgY2xpY2tzIG9uIFJlc2V0IGJ1dHRvbg0KICAgICAgICBncm91cF9zZWxlY3Rvcl90aXRsZSAoc3RyKToNCiAgICAgICAgICAgIHRpdGxlIGZvciBsaXN0IGdyb3VwIHNlbGVjdG9yLiBkZWZhdWx0cyB0byAnTGlzdCBHcm91cCcNCiAgICAgICAgZGVmYXVsdF9ncm91cCAoc3RyKTogbmFtZSBvZiBkZWZhdXRsIGdyb3VwIHRvIGJlIHNlbGVjdGVkDQogICAgICAgIHNvcnRfZ3JvdXBzIChzdHIsIG9wdGlvbmFsKTogDQogICAgICAgICAgICBEZXRlcm1pbmVzIHRoZSBzb3J0aW5nIHR5cGUgYXBwbGllZCB0byB0aGUgbGlzdCBncm91cHMuIFRoaXMgYXR0cmlidXRlIGNhbiB0YWtlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHZhbHVlczoNCiAgICAgICAgICAgICAgICAnc29ydGVkJzogVGhpcyB3aWxsIHNvcnQgdGhlIGdyb3VwcyBpbiBzdGFuZGFyZCBhbHBoYWJldGljYWwgb3JkZXINCiAgICAgICAgICAgICAgICAnbmF0dXJhbCc6IFRoaXMgd2lsbCBzb3J0IHRoZSBncm91cHMgaW4gYSBtYW5uZXIgdGhhdCBpcyBtb3JlIGludHVpdGl2ZSBmb3IgaHVtYW4gcGVyY2VwdGlvbiwgZXNwZWNpYWxseSB3aGVuIHRoZXJlIGFyZSBudW1iZXJzIGludm9sdmVkLg0KICAgICAgICAgICAgICAgICd1bnNvcnRlZCc6IFRoZSBncm91cHMgd2lsbCBtYWludGFpbiB0aGUgb3JpZ2luYWwgb3JkZXIgaW4gd2hpY2ggdGhleSB3ZXJlIHByb3ZpZGVkLCB3aXRob3V0IGFueSByZW9yZGVyaW5nLg0KICAgICAgICAgICAgICAgIERlZmF1bHRzIHRvICdzb3J0ZWQnLg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGl0ZW1zID0gWydpdGVtMScsICdpdGVtMicsICdpdGVtMyddDQogICAgICAgIGZvcm1zLlNlbGVjdEZyb21MaXN0LnNob3coaXRlbXMsIGJ1dHRvbl9uYW1lPSdTZWxlY3QgSXRlbScpDQogICAgICAgIFsnaXRlbTEnXQ0KICAgICAgICBgYGANCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZyb20gcHlyZXZpdCBpbXBvcnQgZm9ybXMNCiAgICAgICAgb3BzID0gW3ZpZXdzaGVldDEsIHZpZXdzaGVldDIsIHZpZXdzaGVldDNdDQogICAgICAgIHJlcyA9IGZvcm1zLlNlbGVjdEZyb21MaXN0LnNob3cob3BzLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpc2VsZWN0PUZhbHNlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVfYXR0cj0nTmFtZScsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX25hbWU9J1NlbGVjdCBTaGVldCcpDQogICAgICAgIGBgYA0KICAgICAgICANCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZyb20gcHlyZXZpdCBpbXBvcnQgZm9ybXMNCiAgICAgICAgb3BzID0geydTaGVldCBTZXQgQSc6IFt2aWV3c2hlZXQxLCB2aWV3c2hlZXQyLCB2aWV3c2hlZXQzXSwNCiAgICAgICAgICAgICAgICdTaGVldCBTZXQgQic6IFt2aWV3c2hlZXQ0LCB2aWV3c2hlZXQ1LCB2aWV3c2hlZXQ2XX0NCiAgICAgICAgcmVzID0gZm9ybXMuU2VsZWN0RnJvbUxpc3Quc2hvdyhvcHMsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlzZWxlY3Q9VHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lX2F0dHI9J05hbWUnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwX3NlbGVjdG9yX3RpdGxlPSdTaGVldCBTZXRzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fbmFtZT0nU2VsZWN0IFNoZWV0cycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ydF9ncm91cHM9J3NvcnRlZCcpDQogICAgICAgIGBgYA0KICAgICAgICANCiAgICAgICAgVGhpcyBtb2R1bGUgYWxzbyBwcm92aWRlcyBhIHdyYXBwZXIgYmFzZSBjbGFzcyA6b2JqOmBUZW1wbGF0ZUxpc3RJdGVtYA0KICAgICAgICBmb3Igd2hlbiB0aGUgY2hlY2tib3ggb3B0aW9uIGlzIHdyYXBwaW5nIGFub3RoZXIgZWxlbWVudCwNCiAgICAgICAgZS5nLiBhIFJldml0IFZpZXdTaGVldC4gRGVyaXZlIGZyb20gdGhpcyBiYXNlIGNsYXNzIGFuZCBkZWZpbmUgdGhlDQogICAgICAgIG5hbWUgcHJvcGVydHkgdG8gY3VzdG9taXplIGhvdyB0aGUgY2hlY2tib3ggaXMgbmFtZWQgb24gdGhlIGRpYWxvZy4NCg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBjbGFzcyBNeU9wdGlvbihmb3Jtcy5UZW1wbGF0ZUxpc3RJdGVtKToNCiAgICAgICAgICAgQHByb3BlcnR5DQogICAgICAgICAgIGRlZiBuYW1lKHNlbGYpOg0KICAgICAgICAgICAgICAgcmV0dXJuICd7fSAtIHt9e30nLmZvcm1hdChzZWxmLml0ZW0uU2hlZXROdW1iZXIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaXRlbS5TaGVldE51bWJlcikNCiAgICAgICAgb3BzID0gW015T3B0aW9uKCdvcDEnKSwgTXlPcHRpb24oJ29wMicsIFRydWUpLCBNeU9wdGlvbignb3AzJyldDQogICAgICAgIHJlcyA9IGZvcm1zLlNlbGVjdEZyb21MaXN0LnNob3cob3BzLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpc2VsZWN0PVRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX25hbWU9J1NlbGVjdCBJdGVtJykNCiAgICAgICAgW2Jvb2woeCkgZm9yIHggaW4gcmVzXSAgIyBvciBbeC5zdGF0ZSBmb3IgeCBpbiByZXNdDQogICAgICAgIFtUcnVlLCBGYWxzZSwgVHJ1ZV0NCiAgICAgICAgYGBgDQoNCiAgICAiIiINCg0KICAgIGluX2NoZWNrID0gRmFsc2UNCiAgICBpbl91bmNoZWNrID0gRmFsc2UNCiAgICB4YW1sX3NvdXJjZSA9ICdTZWxlY3RGcm9tTGlzdC54YW1sJw0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHVzZV9yZWdleChzZWxmKToNCiAgICAgICAgIiIiSXMgdXNpbmcgcmVnZXg/IiIiDQogICAgICAgIHJldHVybiBzZWxmLnJlZ2V4VG9nZ2xlX2IuSXNDaGVja2VkDQoNCiAgICBkZWYgX3NldHVwKHNlbGYsICoqa3dhcmdzKToNCiAgICAgICAgIyBjdXN0b20gYnV0dG9uIG5hbWU/DQogICAgICAgIGJ1dHRvbl9uYW1lID0ga3dhcmdzLmdldCgnYnV0dG9uX25hbWUnLCAnU2VsZWN0JykNCiAgICAgICAgaWYgYnV0dG9uX25hbWU6DQogICAgICAgICAgICBzZWxmLnNlbGVjdF9iLkNvbnRlbnQgPSBidXR0b25fbmFtZQ0KDQogICAgICAgICMgYXR0cmlidXRlIHRvIHVzZSBhcyBuYW1lPw0KICAgICAgICBzZWxmLl9uYW1lYXR0ciA9IGt3YXJncy5nZXQoJ25hbWVfYXR0cicsIE5vbmUpDQoNCiAgICAgICAgIyBtdWx0aXNlbGVjdD8NCiAgICAgICAgaWYga3dhcmdzLmdldCgnbXVsdGlzZWxlY3QnLCBGYWxzZSk6DQogICAgICAgICAgICBzZWxmLm11bHRpc2VsZWN0ID0gVHJ1ZQ0KICAgICAgICAgICAgc2VsZi5saXN0X2xiLlNlbGVjdGlvbk1vZGUgPSBDb250cm9scy5TZWxlY3Rpb25Nb2RlLkV4dGVuZGVkDQogICAgICAgICAgICBzZWxmLnNob3dfZWxlbWVudChzZWxmLmNoZWNrYm94YnV0dG9uc19nKQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgc2VsZi5tdWx0aXNlbGVjdCA9IEZhbHNlDQogICAgICAgICAgICBzZWxmLmxpc3RfbGIuU2VsZWN0aW9uTW9kZSA9IENvbnRyb2xzLlNlbGVjdGlvbk1vZGUuU2luZ2xlDQogICAgICAgICAgICBzZWxmLmhpZGVfZWxlbWVudChzZWxmLmNoZWNrYm94YnV0dG9uc19nKQ0KDQogICAgICAgICMgaW5mbyBwYW5lbD8NCiAgICAgICAgc2VsZi5pbmZvX3BhbmVsID0ga3dhcmdzLmdldCgnaW5mb19wYW5lbCcsIEZhbHNlKQ0KDQogICAgICAgICMgcmV0dXJuIGNoZWNrZWQgaXRlbXMgb25seT8NCiAgICAgICAgc2VsZi5yZXR1cm5fYWxsID0ga3dhcmdzLmdldCgncmV0dXJuX2FsbCcsIEZhbHNlKQ0KDQogICAgICAgICMgZmlsdGVyIGZ1bmN0aW9uPw0KICAgICAgICBzZWxmLmZpbHRlcl9mdW5jID0ga3dhcmdzLmdldCgnZmlsdGVyZnVuYycsIE5vbmUpDQoNCiAgICAgICAgIyByZXNldCBmdW5jdGlvbj8NCiAgICAgICAgc2VsZi5yZXNldF9mdW5jID0ga3dhcmdzLmdldCgncmVzZXRmdW5jJywgTm9uZSkNCiAgICAgICAgaWYgc2VsZi5yZXNldF9mdW5jOg0KICAgICAgICAgICAgc2VsZi5zaG93X2VsZW1lbnQoc2VsZi5yZXNldF9iKQ0KDQogICAgICAgICMgY29udGV4dCBncm91cCB0aXRsZT8NCiAgICAgICAgc2VsZi5jdHhfZ3JvdXBzX3RpdGxlID0gXA0KICAgICAgICAgICAga3dhcmdzLmdldCgnZ3JvdXBfc2VsZWN0b3JfdGl0bGUnLCAnTGlzdCBHcm91cCcpDQogICAgICAgIHNlbGYuY3R4X2dyb3Vwc190aXRsZV90Yi5UZXh0ID0gc2VsZi5jdHhfZ3JvdXBzX3RpdGxlDQoNCiAgICAgICAgc2VsZi5jdHhfZ3JvdXBzX2FjdGl2ZSA9IGt3YXJncy5nZXQoJ2RlZmF1bHRfZ3JvdXAnLCBOb25lKQ0KDQogICAgICAgICMgZ3JvdXAgc29ydGluZz8NCiAgICAgICAgc2VsZi5zb3J0X2dyb3VwcyA9IGt3YXJncy5nZXQoJ3NvcnRfZ3JvdXBzJywgJ3NvcnRlZCcpDQogICAgICAgIGlmIHNlbGYuc29ydF9ncm91cHMgbm90IGluIFsnc29ydGVkJywgJ3Vuc29ydGVkJywgJ25hdHVyYWwnXToNCiAgICAgICAgICAgIHJhaXNlIFB5UmV2aXRFeGNlcHRpb24oIkludmFsaWQgdmFsdWUgZm9yICdzb3J0X2dyb3VwcycuIEFsbG93ZWQgdmFsdWVzIGFyZTogJ3NvcnRlZCcsICd1bnNvcnRlZCcsICduYXR1cmFsJy4iKQ0KDQogICAgICAgICMgY2hlY2sgZm9yIGN1c3RvbSB0ZW1wbGF0ZXMNCiAgICAgICAgaXRlbXNfcGFuZWxfdGVtcGxhdGUgPSBrd2FyZ3MuZ2V0KCdpdGVtc19wYW5lbF90ZW1wbGF0ZScsIE5vbmUpDQogICAgICAgIGlmIGl0ZW1zX3BhbmVsX3RlbXBsYXRlOg0KICAgICAgICAgICAgc2VsZi5SZXNvdXJjZXNbIkl0ZW1zUGFuZWxUZW1wbGF0ZSJdID0gaXRlbXNfcGFuZWxfdGVtcGxhdGUNCg0KICAgICAgICBpdGVtX2NvbnRhaW5lcl90ZW1wbGF0ZSA9IGt3YXJncy5nZXQoJ2l0ZW1fY29udGFpbmVyX3RlbXBsYXRlJywgTm9uZSkNCiAgICAgICAgaWYgaXRlbV9jb250YWluZXJfdGVtcGxhdGU6DQogICAgICAgICAgICBzZWxmLlJlc291cmNlc1siSXRlbUNvbnRhaW5lclRlbXBsYXRlIl0gPSBpdGVtX2NvbnRhaW5lcl90ZW1wbGF0ZQ0KDQogICAgICAgIGl0ZW1fdGVtcGxhdGUgPSBrd2FyZ3MuZ2V0KCdpdGVtX3RlbXBsYXRlJywgTm9uZSkNCiAgICAgICAgaWYgaXRlbV90ZW1wbGF0ZToNCiAgICAgICAgICAgIHNlbGYuUmVzb3VyY2VzWyJJdGVtVGVtcGxhdGUiXSA9IFwNCiAgICAgICAgICAgICAgICBpdGVtX3RlbXBsYXRlDQoNCiAgICAgICAgIyBuaWNlbHkgd3JhcCBhbmQgcHJlcGFyZSBjb250ZXh0IGZvciBwcmVzZW50YXRpb24sIHRoZW4gcHJlc2VudA0KICAgICAgICBzZWxmLl9wcmVwYXJlX2NvbnRleHQoKQ0KDQogICAgICAgICMgc2V0dXAgc2VhcmNoIGFuZCBmaWx0ZXIgZmllbGRzDQogICAgICAgIHNlbGYuaGlkZV9lbGVtZW50KHNlbGYuY2xyc2VhcmNoX2IpDQoNCiAgICAgICAgIyBhY3RpdmUgZXZlbnQgbGlzdGVuZXJzDQogICAgICAgIHNlbGYuc2VhcmNoX3RiLlRleHRDaGFuZ2VkICs9IHNlbGYuc2VhcmNoX3R4dF9jaGFuZ2VkDQogICAgICAgIHNlbGYuY3R4X2dyb3Vwc19zZWxlY3Rvcl9jYi5TZWxlY3Rpb25DaGFuZ2VkICs9IHNlbGYuc2VsZWN0aW9uX2NoYW5nZWQNCg0KICAgICAgICBzZWxmLmNsZWFyX3NlYXJjaChOb25lLCBOb25lKQ0KDQogICAgZGVmIF9wcmVwYXJlX2NvbnRleHRfaXRlbXMoc2VsZiwgY3R4X2l0ZW1zKToNCiAgICAgICAgbmV3X2N0eCA9IFtdDQogICAgICAgICMgZmlsdGVyIGNvbnRleHQgaWYgbmVjZXNzYXJ5DQogICAgICAgIGlmIHNlbGYuZmlsdGVyX2Z1bmM6DQogICAgICAgICAgICBjdHhfaXRlbXMgPSBmaWx0ZXIoc2VsZi5maWx0ZXJfZnVuYywgY3R4X2l0ZW1zKQ0KDQogICAgICAgIGZvciBpdGVtIGluIGN0eF9pdGVtczoNCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoaXRlbSwgVGVtcGxhdGVMaXN0SXRlbSk6DQogICAgICAgICAgICAgICAgaXRlbS5jaGVja2FibGUgPSBzZWxmLm11bHRpc2VsZWN0DQogICAgICAgICAgICAgICAgbmV3X2N0eC5hcHBlbmQoaXRlbSkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgbmV3X2N0eC5hcHBlbmQoDQogICAgICAgICAgICAgICAgICAgIFRlbXBsYXRlTGlzdEl0ZW0oaXRlbSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja2FibGU9c2VsZi5tdWx0aXNlbGVjdCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lX2F0dHI9c2VsZi5fbmFtZWF0dHIpDQogICAgICAgICAgICAgICAgICAgICkNCg0KICAgICAgICByZXR1cm4gbmV3X2N0eA0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiBfbmF0dXJhbF9zb3J0X2tleShrZXkpOg0KICAgICAgICByZXR1cm4gW2ludChjKSBpZiBjLmlzZGlnaXQoKSBlbHNlIGMubG93ZXIoKSBmb3IgYyBpbiByZS5zcGxpdChyJyhcZCspJywga2V5KV0NCg0KICAgIGRlZiBfcHJlcGFyZV9jb250ZXh0KHNlbGYpOg0KICAgICAgICBpZiBpc2luc3RhbmNlKHNlbGYuX2NvbnRleHQsIGRpY3QpIGFuZCBzZWxmLl9jb250ZXh0LmtleXMoKToNCiAgICAgICAgICAgICMgU29ydCB0aGUgZ3JvdXBzIGlmIG5lY2Vzc2FyeQ0KICAgICAgICAgICAgaWYgc2VsZi5zb3J0X2dyb3VwcyA9PSAic29ydGVkIjoNCiAgICAgICAgICAgICAgICBzb3J0ZWRfZ3JvdXBzID0gc29ydGVkKHNlbGYuX2NvbnRleHQua2V5cygpKQ0KICAgICAgICAgICAgZWxpZiBzZWxmLnNvcnRfZ3JvdXBzID09ICJuYXR1cmFsIjoNCiAgICAgICAgICAgICAgICBzb3J0ZWRfZ3JvdXBzID0gc29ydGVkKHNlbGYuX2NvbnRleHQua2V5cygpLCBrZXk9c2VsZi5fbmF0dXJhbF9zb3J0X2tleSkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgc29ydGVkX2dyb3VwcyA9IHNlbGYuX2NvbnRleHQua2V5cygpICAjIE5vIHNvcnRpbmcNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2N0eF9ncm91cHMoc29ydGVkX2dyb3VwcykNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgbmV3X2N0eCA9IE9yZGVyZWREaWN0KCkNCiAgICAgICAgICAgIGZvciBjdHhfZ3JwIGluIHNvcnRlZF9ncm91cHM6DQogICAgICAgICAgICAgICAgaXRlbXMgPSBzZWxmLl9wcmVwYXJlX2NvbnRleHRfaXRlbXMoc2VsZi5fY29udGV4dFtjdHhfZ3JwXSkNCiAgICAgICAgICAgICAgICBuZXdfY3R4W2N0eF9ncnBdID0gaXRlbXMgICMgRG8gbm90IHNvcnQgdGhlIGl0ZW1zIHdpdGhpbiB0aGUgZ3JvdXBzDQoNCiAgICAgICAgICAgIHNlbGYuX2NvbnRleHQgPSBuZXdfY3R4DQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBzZWxmLl9jb250ZXh0ID0gc2VsZi5fcHJlcGFyZV9jb250ZXh0X2l0ZW1zKHNlbGYuX2NvbnRleHQpDQoNCiAgICBkZWYgX3VwZGF0ZV9jdHhfZ3JvdXBzKHNlbGYsIGN0eF9ncm91cF9uYW1lcyk6DQogICAgICAgIHNlbGYuc2hvd19lbGVtZW50KHNlbGYuY3R4X2dyb3Vwc19kb2NrKQ0KICAgICAgICBzZWxmLmN0eF9ncm91cHNfc2VsZWN0b3JfY2IuSXRlbXNTb3VyY2UgPSBjdHhfZ3JvdXBfbmFtZXMNCiAgICAgICAgaWYgc2VsZi5jdHhfZ3JvdXBzX2FjdGl2ZSBpbiBjdHhfZ3JvdXBfbmFtZXM6DQogICAgICAgICAgICBzZWxmLmN0eF9ncm91cHNfc2VsZWN0b3JfY2IuU2VsZWN0ZWRJbmRleCA9IFwNCiAgICAgICAgICAgICAgICBjdHhfZ3JvdXBfbmFtZXMuaW5kZXgoc2VsZi5jdHhfZ3JvdXBzX2FjdGl2ZSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNlbGYuY3R4X2dyb3Vwc19zZWxlY3Rvcl9jYi5TZWxlY3RlZEluZGV4ID0gMA0KDQogICAgZGVmIF9nZXRfYWN0aXZlX2N0eF9ncm91cChzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuY3R4X2dyb3Vwc19zZWxlY3Rvcl9jYi5TZWxlY3RlZEl0ZW0NCg0KICAgIGRlZiBfZ2V0X2FjdGl2ZV9jdHgoc2VsZik6DQogICAgICAgIGlmIGlzaW5zdGFuY2Uoc2VsZi5fY29udGV4dCwgZGljdCk6DQogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29udGV4dFtzZWxmLl9nZXRfYWN0aXZlX2N0eF9ncm91cCgpXQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NvbnRleHQNCg0KICAgIGRlZiBfbGlzdF9vcHRpb25zKHNlbGYsIG9wdGlvbl9maWx0ZXI9Tm9uZSk6DQogICAgICAgIGlmIG9wdGlvbl9maWx0ZXI6DQogICAgICAgICAgICBzZWxmLmNoZWNrYWxsX2IuQ29udGVudCA9ICdDaGVjaycNCiAgICAgICAgICAgIHNlbGYudW5jaGVja2FsbF9iLkNvbnRlbnQgPSAnVW5jaGVjaycNCiAgICAgICAgICAgIHNlbGYudG9nZ2xlYWxsX2IuQ29udGVudCA9ICdUb2dnbGUnDQogICAgICAgICAgICAjIGdldCBhIG1hdGNoIHNjb3JlIGZvciBldmVyeSBpdGVtIGFuZCBzb3J0IGhpZ2ggdG8gbG93DQogICAgICAgICAgICBmdXp6eV9tYXRjaGVzID0gc29ydGVkKA0KICAgICAgICAgICAgICAgIFsoeCwNCiAgICAgICAgICAgICAgICAgIGNvcmV1dGlscy5mdXp6eV9zZWFyY2hfcmF0aW8oDQogICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0X3N0cmluZz14Lm5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgc2ZpbHRlcj1vcHRpb25fZmlsdGVyLA0KICAgICAgICAgICAgICAgICAgICAgIHJlZ2V4PXNlbGYudXNlX3JlZ2V4KSkNCiAgICAgICAgICAgICAgICAgZm9yIHggaW4gc2VsZi5fZ2V0X2FjdGl2ZV9jdHgoKV0sDQogICAgICAgICAgICAgICAga2V5PWxhbWJkYSB4OiB4WzFdLA0KICAgICAgICAgICAgICAgIHJldmVyc2U9VHJ1ZQ0KICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICMgZmlsdGVyIG91dCBhbnkgbWF0Y2ggd2l0aCBzY29yZSBsZXNzIHRoYW4gODANCiAgICAgICAgICAgIHNlbGYubGlzdF9sYi5JdGVtc1NvdXJjZSA9IFwNCiAgICAgICAgICAgICAgICBPYnNlcnZhYmxlQ29sbGVjdGlvbltUZW1wbGF0ZUxpc3RJdGVtXSgNCiAgICAgICAgICAgICAgICAgICAgW3hbMF0gZm9yIHggaW4gZnV6enlfbWF0Y2hlcyBpZiB4WzFdID49IDgwXQ0KICAgICAgICAgICAgICAgICAgICApDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBzZWxmLmNoZWNrYWxsX2IuQ29udGVudCA9ICdDaGVjayBBbGwnDQogICAgICAgICAgICBzZWxmLnVuY2hlY2thbGxfYi5Db250ZW50ID0gJ1VuY2hlY2sgQWxsJw0KICAgICAgICAgICAgc2VsZi50b2dnbGVhbGxfYi5Db250ZW50ID0gJ1RvZ2dsZSBBbGwnDQogICAgICAgICAgICBzZWxmLmxpc3RfbGIuSXRlbXNTb3VyY2UgPSBcDQogICAgICAgICAgICAgICAgT2JzZXJ2YWJsZUNvbGxlY3Rpb25bVGVtcGxhdGVMaXN0SXRlbV0oc2VsZi5fZ2V0X2FjdGl2ZV9jdHgoKSkNCg0KICAgIEBzdGF0aWNtZXRob2QNCiAgICBkZWYgX3Vud3JhcF9vcHRpb25zKG9wdGlvbnMpOg0KICAgICAgICB1bndyYXBwZWQgPSBbXQ0KICAgICAgICBmb3Igb3B0biBpbiBvcHRpb25zOg0KICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShvcHRuLCBUZW1wbGF0ZUxpc3RJdGVtKToNCiAgICAgICAgICAgICAgICB1bndyYXBwZWQuYXBwZW5kKG9wdG4udW53cmFwKCkpDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHVud3JhcHBlZC5hcHBlbmQob3B0bikNCiAgICAgICAgcmV0dXJuIHVud3JhcHBlZA0KDQogICAgZGVmIF9nZXRfb3B0aW9ucyhzZWxmKToNCiAgICAgICAgaWYgc2VsZi5tdWx0aXNlbGVjdDoNCiAgICAgICAgICAgIGlmIHNlbGYucmV0dXJuX2FsbDoNCiAgICAgICAgICAgICAgICByZXR1cm4gW3ggZm9yIHggaW4gc2VsZi5fZ2V0X2FjdGl2ZV9jdHgoKV0NCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3Vud3JhcF9vcHRpb25zKA0KICAgICAgICAgICAgICAgICAgICBbeCBmb3IgeCBpbiBzZWxmLl9nZXRfYWN0aXZlX2N0eCgpDQogICAgICAgICAgICAgICAgICAgICBpZiB4LnN0YXRlIG9yIHggaW4gc2VsZi5saXN0X2xiLlNlbGVjdGVkSXRlbXNdDQogICAgICAgICAgICAgICAgICAgICkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLl91bndyYXBfb3B0aW9ucyhbc2VsZi5saXN0X2xiLlNlbGVjdGVkSXRlbV0pWzBdDQoNCiAgICBkZWYgX3NldF9zdGF0ZXMoc2VsZiwgc3RhdGU9VHJ1ZSwgZmxpcD1GYWxzZSwgc2VsZWN0ZWQ9RmFsc2UpOg0KICAgICAgICBpZiBzZWxlY3RlZDoNCiAgICAgICAgICAgIGN1cnJlbnRfbGlzdCA9IHNlbGYubGlzdF9sYi5TZWxlY3RlZEl0ZW1zDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBjdXJyZW50X2xpc3QgPSBzZWxmLmxpc3RfbGIuSXRlbXNTb3VyY2UNCiAgICAgICAgZm9yIGNoZWNrYm94IGluIGN1cnJlbnRfbGlzdDoNCiAgICAgICAgICAgICMgdXNpbmcgLmNoZWNrZWQgdG8gcHVzaCB1aSB1cGRhdGUNCiAgICAgICAgICAgIGlmIGZsaXA6DQogICAgICAgICAgICAgICAgY2hlY2tib3guY2hlY2tlZCA9IG5vdCBjaGVja2JveC5jaGVja2VkDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIGNoZWNrYm94LmNoZWNrZWQgPSBzdGF0ZQ0KDQogICAgZGVmIF90b2dnbGVfaW5mb19wYW5lbChzZWxmLCBzdGF0ZT1UcnVlKToNCiAgICAgICAgaWYgc3RhdGU6DQogICAgICAgICAgICAjIGVuYWJsZSB0aGUgaW5mbyBwYW5lbA0KICAgICAgICAgICAgc2VsZi5zcGxpdHRlckNvbC5XaWR0aCA9IFN5c3RlbS5XaW5kb3dzLkdyaWRMZW5ndGgoOCkNCiAgICAgICAgICAgIHNlbGYuaW5mb0NvbC5XaWR0aCA9IFN5c3RlbS5XaW5kb3dzLkdyaWRMZW5ndGgoc2VsZi5XaWR0aC8yKQ0KICAgICAgICAgICAgc2VsZi5zaG93X2VsZW1lbnQoc2VsZi5pbmZvU3BsaXR0ZXIpDQogICAgICAgICAgICBzZWxmLnNob3dfZWxlbWVudChzZWxmLmluZm9QYW5lbCkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNlbGYuc3BsaXR0ZXJDb2wuV2lkdGggPSBzZWxmLmluZm9Db2wuV2lkdGggPSBcDQogICAgICAgICAgICAgICAgU3lzdGVtLldpbmRvd3MuR3JpZExlbmd0aC5BdXRvDQogICAgICAgICAgICBzZWxmLmhpZGVfZWxlbWVudChzZWxmLmluZm9TcGxpdHRlcikNCiAgICAgICAgICAgIHNlbGYuaGlkZV9lbGVtZW50KHNlbGYuaW5mb1BhbmVsKQ0KDQogICAgZGVmIHRvZ2dsZV9hbGwoc2VsZiwgc2VuZGVyLCBhcmdzKTogICAgI3B5bGludDogZGlzYWJsZT1XMDYxMw0KICAgICAgICAiIiJIYW5kbGUgdG9nZ2xlIGFsbCBidXR0b24gdG8gdG9nZ2xlIHN0YXRlIG9mIGFsbCBjaGVjayBib3hlcy4iIiINCiAgICAgICAgc2VsZi5fc2V0X3N0YXRlcyhmbGlwPVRydWUpDQoNCiAgICBkZWYgY2hlY2tfYWxsKHNlbGYsIHNlbmRlciwgYXJncyk6ICAgICNweWxpbnQ6IGRpc2FibGU9VzA2MTMNCiAgICAgICAgIiIiSGFuZGxlIGNoZWNrIGFsbCBidXR0b24gdG8gbWFyayBhbGwgY2hlY2sgYm94ZXMgYXMgY2hlY2tlZC4iIiINCiAgICAgICAgc2VsZi5fc2V0X3N0YXRlcyhzdGF0ZT1UcnVlKQ0KDQogICAgZGVmIHVuY2hlY2tfYWxsKHNlbGYsIHNlbmRlciwgYXJncyk6ICAgICNweWxpbnQ6IGRpc2FibGU9VzA2MTMNCiAgICAgICAgIiIiSGFuZGxlIHVuY2hlY2sgYWxsIGJ1dHRvbiB0byBtYXJrIGFsbCBjaGVjayBib3hlcyBhcyB1bi1jaGVja2VkLiIiIg0KICAgICAgICBzZWxmLl9zZXRfc3RhdGVzKHN0YXRlPUZhbHNlKQ0KDQogICAgZGVmIGNoZWNrX3NlbGVjdGVkKHNlbGYsIHNlbmRlciwgYXJncyk6ICAgICNweWxpbnQ6IGRpc2FibGU9VzA2MTMNCiAgICAgICAgIiIiTWFyayBzZWxlY3RlZCBjaGVja2JveGVzIGFzIGNoZWNrZWQuIiIiDQogICAgICAgIGlmIG5vdCBzZWxmLmluX2NoZWNrOg0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgIHNlbGYuaW5fY2hlY2sgPSBUcnVlDQogICAgICAgICAgICAgICAgc2VsZi5fc2V0X3N0YXRlcyhzdGF0ZT1UcnVlLCBzZWxlY3RlZD1UcnVlKQ0KICAgICAgICAgICAgZmluYWxseToNCiAgICAgICAgICAgICAgICBzZWxmLmluX2NoZWNrID0gRmFsc2UNCg0KICAgIGRlZiB1bmNoZWNrX3NlbGVjdGVkKHNlbGYsIHNlbmRlciwgYXJncyk6ICAgICNweWxpbnQ6IGRpc2FibGU9VzA2MTMNCiAgICAgICAgIiIiTWFyayBzZWxlY3RlZCBjaGVja2JveGVzIGFzIHVuY2hlY2tlZC4iIiINCiAgICAgICAgaWYgbm90IHNlbGYuaW5fdW5jaGVjazoNCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICBzZWxmLmluX3VuY2hlY2sgPSBUcnVlDQogICAgICAgICAgICAgICAgc2VsZi5fc2V0X3N0YXRlcyhzdGF0ZT1GYWxzZSwgc2VsZWN0ZWQ9VHJ1ZSkNCiAgICAgICAgICAgIGZpbmFsbHk6DQogICAgICAgICAgICAgICAgc2VsZi5pbl91bmNoZWNrID0gRmFsc2UNCg0KICAgIGRlZiBidXR0b25fcmVzZXQoc2VsZiwgc2VuZGVyLCBhcmdzKTojcHlsaW50OiBkaXNhYmxlPVcwNjEzDQogICAgICAgICIiIkhhbmRsZSByZXNldCBidXR0b24gY2xpY2suIiIiDQogICAgICAgIGlmIHNlbGYucmVzZXRfZnVuYzoNCiAgICAgICAgICAgIGFsbF9pdGVtcyA9IHNlbGYubGlzdF9sYi5JdGVtc1NvdXJjZQ0KICAgICAgICAgICAgc2VsZi5yZXNldF9mdW5jKGFsbF9pdGVtcykNCg0KICAgIGRlZiBidXR0b25fc2VsZWN0KHNlbGYsIHNlbmRlciwgYXJncyk6ICAgICNweWxpbnQ6IGRpc2FibGU9VzA2MTMNCiAgICAgICAgIiIiSGFuZGxlIHNlbGVjdCBidXR0b24gY2xpY2suIiIiDQogICAgICAgIHNlbGYucmVzcG9uc2UgPSBzZWxmLl9nZXRfb3B0aW9ucygpDQogICAgICAgIHNlbGYuQ2xvc2UoKQ0KDQogICAgZGVmIHNlYXJjaF90eHRfY2hhbmdlZChzZWxmLCBzZW5kZXIsIGFyZ3MpOiAgICAjcHlsaW50OiBkaXNhYmxlPVcwNjEzDQogICAgICAgICIiIkhhbmRsZSB0ZXh0IGNoYW5nZSBpbiBzZWFyY2ggYm94LiIiIg0KICAgICAgICBpZiBzZWxmLmluZm9fcGFuZWw6DQogICAgICAgICAgICBzZWxmLl90b2dnbGVfaW5mb19wYW5lbChzdGF0ZT1GYWxzZSkNCg0KICAgICAgICBpZiBzZWxmLnNlYXJjaF90Yi5UZXh0ID09ICcnOg0KICAgICAgICAgICAgc2VsZi5oaWRlX2VsZW1lbnQoc2VsZi5jbHJzZWFyY2hfYikNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNlbGYuc2hvd19lbGVtZW50KHNlbGYuY2xyc2VhcmNoX2IpDQoNCiAgICAgICAgc2VsZi5fbGlzdF9vcHRpb25zKG9wdGlvbl9maWx0ZXI9c2VsZi5zZWFyY2hfdGIuVGV4dCkNCg0KICAgIGRlZiBzZWxlY3Rpb25fY2hhbmdlZChzZWxmLCBzZW5kZXIsIGFyZ3MpOg0KICAgICAgICAiIiJIYW5kbGUgc2VsZWN0aW9uIGNoYW5nZS4iIiINCiAgICAgICAgaWYgc2VsZi5pbmZvX3BhbmVsOg0KICAgICAgICAgICAgc2VsZi5fdG9nZ2xlX2luZm9fcGFuZWwoc3RhdGU9RmFsc2UpDQoNCiAgICAgICAgc2VsZi5fbGlzdF9vcHRpb25zKG9wdGlvbl9maWx0ZXI9c2VsZi5zZWFyY2hfdGIuVGV4dCkNCg0KICAgIGRlZiBzZWxlY3RlZF9pdGVtX2NoYW5nZWQoc2VsZiwgc2VuZGVyLCBhcmdzKToNCiAgICAgICAgIiIiSGFuZGxlIHNlbGVjdGVkIGl0ZW0gY2hhbmdlLiIiIg0KICAgICAgICBpZiBzZWxmLmluZm9fcGFuZWwgYW5kIHNlbGYubGlzdF9sYi5TZWxlY3RlZEl0ZW0gaXMgbm90IE5vbmU6DQogICAgICAgICAgICBzZWxmLl90b2dnbGVfaW5mb19wYW5lbChzdGF0ZT1UcnVlKQ0KICAgICAgICAgICAgc2VsZi5pbmZvRGF0YS5UZXh0ID0gXA0KICAgICAgICAgICAgICAgIGdldGF0dHIoc2VsZi5saXN0X2xiLlNlbGVjdGVkSXRlbSwgJ2Rlc2NyaXB0aW9uJywgJycpDQoNCiAgICBkZWYgdG9nZ2xlX3JlZ2V4KHNlbGYsIHNlbmRlciwgYXJncyk6DQogICAgICAgICIiIkFjdGl2YXRlIHJlZ2V4IGluIHNlYXJjaC4iIiINCiAgICAgICAgc2VsZi5yZWdleFRvZ2dsZV9iLkNvbnRlbnQgPSBcDQogICAgICAgICAgICBzZWxmLlJlc291cmNlc1sncmVnZXhJY29uJ10gaWYgc2VsZi51c2VfcmVnZXggXA0KICAgICAgICAgICAgICAgIGVsc2Ugc2VsZi5SZXNvdXJjZXNbJ2ZpbHRlckljb24nXQ0KICAgICAgICBzZWxmLnNlYXJjaF90eHRfY2hhbmdlZChzZW5kZXIsIGFyZ3MpDQogICAgICAgIHNlbGYuc2VhcmNoX3RiLkZvY3VzKCkNCg0KICAgIGRlZiBjbGVhcl9zZWFyY2goc2VsZiwgc2VuZGVyLCBhcmdzKTogICAgI3B5bGludDogZGlzYWJsZT1XMDYxMw0KICAgICAgICAiIiJDbGVhciBzZWFyY2ggYm94LiIiIg0KICAgICAgICBzZWxmLnNlYXJjaF90Yi5UZXh0ID0gJyAnDQogICAgICAgIHNlbGYuc2VhcmNoX3RiLkNsZWFyKCkNCiAgICAgICAgc2VsZi5zZWFyY2hfdGIuRm9jdXMoKQ0KDQoNCmNsYXNzIENvbW1hbmRTd2l0Y2hXaW5kb3coVGVtcGxhdGVVc2VySW5wdXRXaW5kb3cpOg0KICAgICIiIlN0YW5kYXJkIGZvcm0gdG8gc2VsZWN0IGZyb20gYSBsaXN0IG9mIGNvbW1hbmQgb3B0aW9ucy4NCg0KICAgIEtleXdvcmQgQXJnczoNCiAgICAgICAgY29udGV4dCAobGlzdFtzdHJdKTogbGlzdCBvZiBjb21tYW5kIG9wdGlvbnMgdG8gY2hvb3NlIGZyb20NCiAgICAgICAgc3dpdGNoZXMgKGxpc3Rbc3RyXSk6IGxpc3Qgb2Ygb24vb2ZmIHN3aXRjaGVzDQogICAgICAgIG1lc3NhZ2UgKHN0cik6IHdpbmRvdyB0aXRsZSBtZXNzYWdlDQogICAgICAgIGNvbmZpZyAoZGljdCk6IGRpY3Rpb25hcnkgb2YgY29uZmlnIGRpY3RzIGZvciBvcHRpb25zIG9yIHN3aXRjaGVzDQogICAgICAgIHJlY29nbml6ZV9hY2Nlc3Nfa2V5IChib29sKTogcmVjb2duaXplICdfJyBhcyBtYXJrIG9mIGFjY2VzcyBrZXkNCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIgfCB0dXBsZVtzdHIsIGRpY3RdKTogbmFtZSBvZiBzZWxlY3RlZCBvcHRpb24uDQogICAgICAgICAgICBpZiBgYHN3aXRjaGVzYGAgb3B0aW9uIGlzIHVzZWQsIHJldHVybnMgYSB0dXBsZQ0KICAgICAgICAgICAgb2Ygc2VsZWN0aW9uIG9wdGlvbiBuYW1lIGFuZCBkaWN0IG9mIHN3aXRjaGVzDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgVGhpcyBpcyBhbiBleGFtcGxlIHdpdGggc2VyaWVzIG9mIGNvbW1hbmQgb3B0aW9uczoNCg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBvcHMgPSBbJ29wdGlvbjEnLCAnb3B0aW9uMicsICdvcHRpb24zJywgJ29wdGlvbjQnXQ0KICAgICAgICBmb3Jtcy5Db21tYW5kU3dpdGNoV2luZG93LnNob3cob3BzLCBtZXNzYWdlPSdTZWxlY3QgT3B0aW9uJykNCiAgICAgICAgJ29wdGlvbjInDQogICAgICAgIGBgYA0KDQogICAgICAgIEEgbW9yZSBhZHZhbmNlZCBleGFtcGxlIG9mIGNvbWJpbmluZyBjb21tYW5kIG9wdGlvbnMsIG9uL29mZiBzd2l0Y2hlcywNCiAgICAgICAgYW5kIG9wdGlvbiBvciBzd2l0Y2ggY29uZmlndXJhdGlvbiBvcHRpb25zOg0KDQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIG9wcyA9IFsnb3B0aW9uMScsICdvcHRpb24yJywgJ29wdGlvbjMnLCAnb3B0aW9uNCddDQogICAgICAgIHN3aXRjaGVzID0gWydzd2l0Y2gxJywgJ3N3aXRjaDInXQ0KICAgICAgICBjZmdzID0geydvcHRpb24xJzogeyAnYmFja2dyb3VuZCc6ICcweEZGNTVGRid9fQ0KICAgICAgICByb3BzLCByc3dpdGNoZXMgPSBmb3Jtcy5Db21tYW5kU3dpdGNoV2luZG93LnNob3coDQogICAgICAgICAgICBvcHMsDQogICAgICAgICAgICBzd2l0Y2hlcz1zd2l0Y2hlcw0KICAgICAgICAgICAgbWVzc2FnZT0nU2VsZWN0IE9wdGlvbicsDQogICAgICAgICAgICBjb25maWc9Y2ZncywNCiAgICAgICAgICAgIHJlY29nbml6ZV9hY2Nlc3Nfa2V5PUZhbHNlDQogICAgICAgICAgICApDQogICAgICAgIHJvcHMNCiAgICAgICAgJ29wdGlvbjInDQogICAgICAgIHJzd2l0Y2hlcw0KICAgICAgICB7J3N3aXRjaDEnOiBGYWxzZSwgJ3N3aXRjaDInOiBUcnVlfQ0KICAgICAgICBgYGANCiAgICAiIiINCg0KICAgIHhhbWxfc291cmNlID0gJ0NvbW1hbmRTd2l0Y2hXaW5kb3cueGFtbCcNCg0KICAgIGRlZiBfc2V0dXAoc2VsZiwgKiprd2FyZ3MpOg0KICAgICAgICBzZWxmLnNlbGVjdGVkX3N3aXRjaCA9ICcnDQogICAgICAgIHNlbGYuV2lkdGggPSBERUZBVUxUX0NNRFNXSVRDSFdORF9XSURUSA0KICAgICAgICBzZWxmLlRpdGxlID0gJ0NvbW1hbmQgT3B0aW9ucycNCg0KICAgICAgICBtZXNzYWdlID0ga3dhcmdzLmdldCgnbWVzc2FnZScsIE5vbmUpDQogICAgICAgIHNlbGYuX3N3aXRjaGVzID0ga3dhcmdzLmdldCgnc3dpdGNoZXMnLCBbXSkNCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uoc2VsZi5fc3dpdGNoZXMsIGRpY3QpOg0KICAgICAgICAgICAgc2VsZi5fc3dpdGNoZXMgPSBkaWN0LmZyb21rZXlzKHNlbGYuX3N3aXRjaGVzKQ0KDQogICAgICAgIGNvbmZpZ3MgPSBrd2FyZ3MuZ2V0KCdjb25maWcnLCBOb25lKQ0KDQogICAgICAgIHNlbGYubWVzc2FnZV9sYWJlbC5Db250ZW50ID0gXA0KICAgICAgICAgICAgbWVzc2FnZSBpZiBtZXNzYWdlIGVsc2UgJ1BpY2sgYSBjb21tYW5kIG9wdGlvbjonDQoNCiAgICAgICAgc2VsZi5SZXNvdXJjZXNbJ3B5UmV2aXRSZWNvZ25pemVzQWNjZXNzS2V5J10gPSBcDQogICAgICAgICAgICBrd2FyZ3MuZ2V0KCdyZWNvZ25pemVfYWNjZXNzX2tleScsIERFRkFVTFRfUkVDT0dOSVpFX0FDQ0VTU19LRVkpDQoNCiAgICAgICAgIyBjcmVhdGVzIHRoZSBzd2l0Y2hlcyBmaXJzdA0KICAgICAgICBmb3Igc3dpdGNoLCBzdGF0ZSBpbiBzZWxmLl9zd2l0Y2hlcy5pdGVtcygpOg0KICAgICAgICAgICAgbXlfdG9nZ2xlYnV0dG9uID0gZnJhbWV3b3JrLkNvbnRyb2xzLlByaW1pdGl2ZXMuVG9nZ2xlQnV0dG9uKCkNCiAgICAgICAgICAgIG15X3RvZ2dsZWJ1dHRvbi5Db250ZW50ID0gc3dpdGNoDQogICAgICAgICAgICBteV90b2dnbGVidXR0b24uSXNDaGVja2VkID0gc3RhdGUgaWYgc3RhdGUgZWxzZSBGYWxzZQ0KICAgICAgICAgICAgaWYgY29uZmlncyBhbmQgc3dpdGNoIGluIGNvbmZpZ3M6DQogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2NvbmZpZyhteV90b2dnbGVidXR0b24sIGNvbmZpZ3Nbc3dpdGNoXSkNCiAgICAgICAgICAgIHNlbGYuYnV0dG9uX2xpc3QuQ2hpbGRyZW4uQWRkKG15X3RvZ2dsZWJ1dHRvbikNCg0KICAgICAgICBmb3Igb3B0aW9uIGluIHNlbGYuX2NvbnRleHQ6DQogICAgICAgICAgICBteV9idXR0b24gPSBmcmFtZXdvcmsuQ29udHJvbHMuQnV0dG9uKCkNCiAgICAgICAgICAgIG15X2J1dHRvbi5Db250ZW50ID0gb3B0aW9uDQogICAgICAgICAgICBteV9idXR0b24uQ2xpY2sgKz0gc2VsZi5wcm9jZXNzX29wdGlvbg0KICAgICAgICAgICAgaWYgY29uZmlncyBhbmQgb3B0aW9uIGluIGNvbmZpZ3M6DQogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2NvbmZpZyhteV9idXR0b24sIGNvbmZpZ3Nbb3B0aW9uXSkNCiAgICAgICAgICAgIHNlbGYuYnV0dG9uX2xpc3QuQ2hpbGRyZW4uQWRkKG15X2J1dHRvbikNCg0KICAgICAgICBzZWxmLl9zZXR1cF9yZXNwb25zZSgpDQogICAgICAgIHNlbGYuc2VhcmNoX3RiLkZvY3VzKCkNCiAgICAgICAgc2VsZi5fZmlsdGVyX29wdGlvbnMoKQ0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiBfc2V0X2NvbmZpZyhpdGVtLCBjb25maWdfZGljdCk6DQogICAgICAgIGJnID0gY29uZmlnX2RpY3QuZ2V0KCdiYWNrZ3JvdW5kJywgTm9uZSkNCiAgICAgICAgaWYgYmc6DQogICAgICAgICAgICBiZyA9IGJnLnJlcGxhY2UoJzB4JywgJyMnKQ0KICAgICAgICAgICAgaXRlbS5CYWNrZ3JvdW5kID0gTWVkaWEuQnJ1c2hDb252ZXJ0ZXIoKS5Db252ZXJ0RnJvbShiZykNCg0KICAgIGRlZiBfc2V0dXBfcmVzcG9uc2Uoc2VsZiwgcmVzcG9uc2U9Tm9uZSk6DQogICAgICAgIGlmIHNlbGYuX3N3aXRjaGVzOg0KICAgICAgICAgICAgc3dpdGNoZXMgPSBbeCBmb3IgeCBpbiBzZWxmLmJ1dHRvbl9saXN0LkNoaWxkcmVuDQogICAgICAgICAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHgsICdJc0NoZWNrZWQnKV0NCiAgICAgICAgICAgIHNlbGYucmVzcG9uc2UgPSByZXNwb25zZSwge3guQ29udGVudDogeC5Jc0NoZWNrZWQNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciB4IGluIHN3aXRjaGVzfQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgc2VsZi5yZXNwb25zZSA9IHJlc3BvbnNlDQoNCiAgICBkZWYgX2ZpbHRlcl9vcHRpb25zKHNlbGYsIG9wdGlvbl9maWx0ZXI9Tm9uZSk6DQogICAgICAgIGlmIG9wdGlvbl9maWx0ZXI6DQogICAgICAgICAgICBzZWxmLnNlYXJjaF90Yi5UYWcgPSAnJw0KICAgICAgICAgICAgb3B0aW9uX2ZpbHRlciA9IG9wdGlvbl9maWx0ZXIubG93ZXIoKQ0KICAgICAgICAgICAgZm9yIGJ1dHRvbiBpbiBzZWxmLmJ1dHRvbl9saXN0LkNoaWxkcmVuOg0KICAgICAgICAgICAgICAgIGlmIG9wdGlvbl9maWx0ZXIgbm90IGluIGJ1dHRvbi5Db250ZW50Lmxvd2VyKCk6DQogICAgICAgICAgICAgICAgICAgIGJ1dHRvbi5WaXNpYmlsaXR5ID0gV1BGX0NPTExBUFNFRA0KICAgICAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgICAgIGJ1dHRvbi5WaXNpYmlsaXR5ID0gV1BGX1ZJU0lCTEUNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHNlbGYuc2VhcmNoX3RiLlRhZyA9IFwNCiAgICAgICAgICAgICAgICAnVHlwZSB0byBGaWx0ZXIgLyBUYWIgdG8gU2VsZWN0IC8gRW50ZXIgb3IgQ2xpY2sgdG8gUnVuJw0KICAgICAgICAgICAgZm9yIGJ1dHRvbiBpbiBzZWxmLmJ1dHRvbl9saXN0LkNoaWxkcmVuOg0KICAgICAgICAgICAgICAgIGJ1dHRvbi5WaXNpYmlsaXR5ID0gV1BGX1ZJU0lCTEUNCg0KICAgIGRlZiBfZ2V0X2FjdGl2ZV9idXR0b24oc2VsZik6DQogICAgICAgIGJ1dHRvbnMgPSBbXQ0KICAgICAgICBmb3IgYnV0dG9uIGluIHNlbGYuYnV0dG9uX2xpc3QuQ2hpbGRyZW46DQogICAgICAgICAgICBpZiBidXR0b24uVmlzaWJpbGl0eSA9PSBXUEZfVklTSUJMRToNCiAgICAgICAgICAgICAgICBidXR0b25zLmFwcGVuZChidXR0b24pDQogICAgICAgIGlmIGxlbihidXR0b25zKSA9PSAxOg0KICAgICAgICAgICAgcmV0dXJuIGJ1dHRvbnNbMF0NCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIGZvciB4IGluIGJ1dHRvbnM6DQogICAgICAgICAgICAgICAgaWYgeC5Jc0ZvY3VzZWQ6DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB4DQoNCiAgICBkZWYgaGFuZGxlX2NsaWNrKHNlbGYsIHNlbmRlciwgYXJncyk6ICAgICNweWxpbnQ6IGRpc2FibGU9VzA2MTMNCiAgICAgICAgIiIiSGFuZGxlIG1vdXNlIGNsaWNrLiIiIg0KICAgICAgICBzZWxmLkNsb3NlKCkNCg0KICAgIGRlZiBoYW5kbGVfaW5wdXRfa2V5KHNlbGYsIHNlbmRlciwgYXJncyk6DQogICAgICAgICIiIkhhbmRsZSBrZXlib2FyZCBpbnB1dHMuIiIiDQogICAgICAgIGlmIGFyZ3MuS2V5ID09IElucHV0LktleS5Fc2NhcGU6DQogICAgICAgICAgICBpZiBzZWxmLnNlYXJjaF90Yi5UZXh0Og0KICAgICAgICAgICAgICAgIHNlbGYuc2VhcmNoX3RiLlRleHQgPSAnJw0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBzZWxmLkNsb3NlKCkNCiAgICAgICAgZWxpZiBhcmdzLktleSA9PSBJbnB1dC5LZXkuRW50ZXI6DQogICAgICAgICAgICBhY3RpdmVfYnV0dG9uID0gc2VsZi5fZ2V0X2FjdGl2ZV9idXR0b24oKQ0KICAgICAgICAgICAgaWYgYWN0aXZlX2J1dHRvbjoNCiAgICAgICAgICAgICAgICBzZWxmLnByb2Nlc3Nfb3B0aW9uKGFjdGl2ZV9idXR0b24sIE5vbmUpDQogICAgICAgICAgICAgICAgYXJncy5IYW5kbGVkID0gVHJ1ZQ0KICAgICAgICBlbGlmIGFyZ3MuS2V5ICE9IElucHV0LktleS5UYWIgXA0KICAgICAgICAgICAgICAgIGFuZCBhcmdzLktleSAhPSBJbnB1dC5LZXkuU3BhY2VcDQogICAgICAgICAgICAgICAgYW5kIGFyZ3MuS2V5ICE9IElucHV0LktleS5MZWZ0U2hpZnRcDQogICAgICAgICAgICAgICAgYW5kIGFyZ3MuS2V5ICE9IElucHV0LktleS5SaWdodFNoaWZ0Og0KICAgICAgICAgICAgc2VsZi5zZWFyY2hfdGIuRm9jdXMoKQ0KDQogICAgZGVmIHNlYXJjaF90eHRfY2hhbmdlZChzZWxmLCBzZW5kZXIsIGFyZ3MpOiAgICAjcHlsaW50OiBkaXNhYmxlPVcwNjEzDQogICAgICAgICIiIkhhbmRsZSB0ZXh0IGNoYW5nZSBpbiBzZWFyY2ggYm94LiIiIg0KICAgICAgICBzZWxmLl9maWx0ZXJfb3B0aW9ucyhvcHRpb25fZmlsdGVyPXNlbGYuc2VhcmNoX3RiLlRleHQpDQoNCiAgICBkZWYgcHJvY2Vzc19vcHRpb24oc2VsZiwgc2VuZGVyLCBhcmdzKTogICAgI3B5bGludDogZGlzYWJsZT1XMDYxMw0KICAgICAgICAiIiJIYW5kbGUgY2xpY2sgb24gY29tbWFuZCBvcHRpb24gYnV0dG9uLiIiIg0KICAgICAgICBzZWxmLkNsb3NlKCkNCiAgICAgICAgaWYgc2VuZGVyOg0KICAgICAgICAgICAgc2VsZi5fc2V0dXBfcmVzcG9uc2UocmVzcG9uc2U9c2VuZGVyLkNvbnRlbnQpDQoNCg0KY2xhc3MgR2V0VmFsdWVXaW5kb3coVGVtcGxhdGVVc2VySW5wdXRXaW5kb3cpOg0KICAgICIiIlN0YW5kYXJkIGZvcm0gdG8gZ2V0IHNpbXBsZSB2YWx1ZXMgZnJvbSB1c2VyLg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGl0ZW1zID0gWydpdGVtMScsICdpdGVtMicsICdpdGVtMyddDQogICAgICAgIGZvcm1zLlNlbGVjdEZyb21MaXN0LnNob3coaXRlbXMsIGJ1dHRvbl9uYW1lPSdTZWxlY3QgSXRlbScpDQogICAgICAgIFsnaXRlbTEnXQ0KICAgICAgICBgYGANCiAgICAiIiINCg0KICAgIHhhbWxfc291cmNlID0gJ0dldFZhbHVlV2luZG93LnhhbWwnDQoNCiAgICBkZWYgX3NldHVwKHNlbGYsICoqa3dhcmdzKToNCiAgICAgICAgc2VsZi5XaWR0aCA9IDQwMA0KICAgICAgICAjIGRldGVybWluZSB2YWx1ZSB0eXBlDQogICAgICAgIHNlbGYudmFsdWVfdHlwZSA9IGt3YXJncy5nZXQoJ3ZhbHVlX3R5cGUnLCAnc3RyaW5nJykNCiAgICAgICAgdmFsdWVfcHJvbXB0ID0ga3dhcmdzLmdldCgncHJvbXB0JywgTm9uZSkNCiAgICAgICAgdmFsdWVfZGVmYXVsdCA9IGt3YXJncy5nZXQoJ2RlZmF1bHQnLCBOb25lKQ0KICAgICAgICBzZWxmLnJlc2VydmVkX3ZhbHVlcyA9IGt3YXJncy5nZXQoJ3Jlc2VydmVkX3ZhbHVlcycsIFtdKQ0KDQogICAgICAgICMgY3VzdG9taXplIHdpbmRvdyBiYXNlZCBvbiB0eXBlDQogICAgICAgIGlmIHNlbGYudmFsdWVfdHlwZSA9PSAnc3RyaW5nJzoNCiAgICAgICAgICAgIHNlbGYuc2hvd19lbGVtZW50KHNlbGYuc3RyaW5nUGFuZWxfZHApDQogICAgICAgICAgICBzZWxmLnN0cmluZ1ZhbHVlX3RiLlRleHQgPSB2YWx1ZV9kZWZhdWx0IGlmIHZhbHVlX2RlZmF1bHQgZWxzZSAnJw0KICAgICAgICAgICAgc2VsZi5zdHJpbmdWYWx1ZV90Yi5Gb2N1cygpDQogICAgICAgICAgICBzZWxmLnN0cmluZ1ZhbHVlX3RiLlNlbGVjdEFsbCgpDQogICAgICAgICAgICBzZWxmLnN0cmluZ1Byb21wdC5UZXh0ID0gXA0KICAgICAgICAgICAgICAgIHZhbHVlX3Byb21wdCBpZiB2YWx1ZV9wcm9tcHQgZWxzZSAnRW50ZXIgc3RyaW5nOicNCiAgICAgICAgICAgIGlmIHNlbGYucmVzZXJ2ZWRfdmFsdWVzOg0KICAgICAgICAgICAgICAgIHNlbGYuc3RyaW5nX3ZhbHVlX2NoYW5nZWQoTm9uZSwgTm9uZSkNCiAgICAgICAgZWxpZiBzZWxmLnZhbHVlX3R5cGUgPT0gJ2Ryb3Bkb3duJzoNCiAgICAgICAgICAgIHNlbGYuc2hvd19lbGVtZW50KHNlbGYuZHJvcGRvd25QYW5lbF9kYikNCiAgICAgICAgICAgIHNlbGYuZHJvcGRvd25Qcm9tcHQuVGV4dCA9IFwNCiAgICAgICAgICAgICAgICB2YWx1ZV9wcm9tcHQgaWYgdmFsdWVfcHJvbXB0IGVsc2UgJ1BpY2sgb25lIHZhbHVlOicNCiAgICAgICAgICAgIHNlbGYuZHJvcGRvd25fY2IuSXRlbXNTb3VyY2UgPSBzZWxmLl9jb250ZXh0DQogICAgICAgICAgICBpZiB2YWx1ZV9kZWZhdWx0Og0KICAgICAgICAgICAgICAgIHNlbGYuZHJvcGRvd25fY2IuU2VsZWN0ZWRJdGVtID0gdmFsdWVfZGVmYXVsdA0KICAgICAgICBlbGlmIHNlbGYudmFsdWVfdHlwZSA9PSAnZGF0ZSc6DQogICAgICAgICAgICBzZWxmLnNob3dfZWxlbWVudChzZWxmLmRhdGVQYW5lbF9kcCkNCiAgICAgICAgICAgIHNlbGYuZGF0ZVByb21wdC5UZXh0ID0gXA0KICAgICAgICAgICAgICAgIHZhbHVlX3Byb21wdCBpZiB2YWx1ZV9wcm9tcHQgZWxzZSAnUGljayBkYXRlOicNCiAgICAgICAgZWxpZiBzZWxmLnZhbHVlX3R5cGUgPT0gJ3NsaWRlcic6DQogICAgICAgICAgICBzZWxmLnNob3dfZWxlbWVudChzZWxmLnNsaWRlclBhbmVsX3NwKQ0KICAgICAgICAgICAgc2VsZi5zbGlkZXJQcm9tcHQuVGV4dCA9IHZhbHVlX3Byb21wdA0KICAgICAgICAgICAgc2VsZi5udW1iZXJQaWNrZXIuTWluaW11bSA9IGt3YXJncy5nZXQoJ21pbicsIDApDQogICAgICAgICAgICBzZWxmLm51bWJlclBpY2tlci5NYXhpbXVtID0ga3dhcmdzLmdldCgnbWF4JywgMTAwKQ0KICAgICAgICAgICAgc2VsZi5udW1iZXJQaWNrZXIuVGlja0ZyZXF1ZW5jeSA9IGt3YXJncy5nZXQoJ2ludGVydmFsJywgMSkNCiAgICAgICAgICAgIHNlbGYubnVtYmVyUGlja2VyLlZhbHVlID0gXA0KICAgICAgICAgICAgICAgIHZhbHVlX2RlZmF1bHQgaWYgaXNpbnN0YW5jZSh2YWx1ZV9kZWZhdWx0LCAoZmxvYXQsIGludCkpIFwNCiAgICAgICAgICAgICAgICAgICAgZWxzZSBzZWxmLm51bWJlclBpY2tlci5NaW5pbXVtDQoNCiAgICBkZWYgc3RyaW5nX3ZhbHVlX2NoYW5nZWQoc2VsZiwgc2VuZGVyLCBhcmdzKTogI3B5bGludDogZGlzYWJsZT11bnVzZWQtYXJndW1lbnQNCiAgICAgICAgIiIiSGFuZGxlIHN0cmluZyB2bGF1ZSB1cGRhdGUgZXZlbnQuIiIiDQogICAgICAgIGZpbHRlcmVkX3J2YWx1ZXMgPSBcDQogICAgICAgICAgICBzb3J0ZWQoW3ggZm9yIHggaW4gc2VsZi5yZXNlcnZlZF92YWx1ZXMNCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5zdHJpbmdWYWx1ZV90Yi5UZXh0ID09IHN0cih4KV0pDQogICAgICAgIHNpbWlsYXJfcnZhbHVlcyA9IFwNCiAgICAgICAgICAgIHNvcnRlZChbeCBmb3IgeCBpbiBzZWxmLnJlc2VydmVkX3ZhbHVlcw0KICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnN0cmluZ1ZhbHVlX3RiLlRleHQgaW4gc3RyKHgpXSwNCiAgICAgICAgICAgICAgICAgICByZXZlcnNlPVRydWUpDQogICAgICAgIGZpbHRlcmVkX3J2YWx1ZXMuZXh0ZW5kKHNpbWlsYXJfcnZhbHVlcykNCiAgICAgICAgaWYgZmlsdGVyZWRfcnZhbHVlczoNCiAgICAgICAgICAgIHNlbGYucmVzZXJ2ZWRWYWx1ZXNMaXN0Lkl0ZW1zU291cmNlID0gZmlsdGVyZWRfcnZhbHVlcw0KICAgICAgICAgICAgc2VsZi5zaG93X2VsZW1lbnQoc2VsZi5yZXNlcnZlZFZhbHVlc0xpc3RQYW5lbCkNCiAgICAgICAgICAgIHNlbGYub2theUJ1dHRvbi5Jc0VuYWJsZWQgPSBcDQogICAgICAgICAgICAgICAgc2VsZi5zdHJpbmdWYWx1ZV90Yi5UZXh0IG5vdCBpbiBmaWx0ZXJlZF9ydmFsdWVzDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBzZWxmLnJlc2VydmVkVmFsdWVzTGlzdC5JdGVtc1NvdXJjZSA9IFtdDQogICAgICAgICAgICBzZWxmLmhpZGVfZWxlbWVudChzZWxmLnJlc2VydmVkVmFsdWVzTGlzdFBhbmVsKQ0KICAgICAgICAgICAgc2VsZi5va2F5QnV0dG9uLklzRW5hYmxlZCA9IFRydWUNCg0KICAgIGRlZiBzZWxlY3Qoc2VsZiwgc2VuZGVyLCBhcmdzKTogICAgI3B5bGludDogZGlzYWJsZT1XMDYxMw0KICAgICAgICAiIiJQcm9jZXNzIGlucHV0IGRhdGEgYW5kIHNldCB0aGUgcmVzcG9uc2UuIiIiDQogICAgICAgIHNlbGYuQ2xvc2UoKQ0KICAgICAgICBpZiBzZWxmLnZhbHVlX3R5cGUgPT0gJ3N0cmluZyc6DQogICAgICAgICAgICBzZWxmLnJlc3BvbnNlID0gc2VsZi5zdHJpbmdWYWx1ZV90Yi5UZXh0DQogICAgICAgIGVsaWYgc2VsZi52YWx1ZV90eXBlID09ICdkcm9wZG93bic6DQogICAgICAgICAgICBzZWxmLnJlc3BvbnNlID0gc2VsZi5kcm9wZG93bl9jYi5TZWxlY3RlZEl0ZW0NCiAgICAgICAgZWxpZiBzZWxmLnZhbHVlX3R5cGUgPT0gJ2RhdGUnOg0KICAgICAgICAgICAgaWYgc2VsZi5kYXRlUGlja2VyLlNlbGVjdGVkRGF0ZToNCiAgICAgICAgICAgICAgICBkYXRlc3RyID0gc2VsZi5kYXRlUGlja2VyLlNlbGVjdGVkRGF0ZS5Ub1N0cmluZygiTU0vZGQveXl5eSIpDQogICAgICAgICAgICAgICAgc2VsZi5yZXNwb25zZSA9IGRhdGV0aW1lLmRhdGV0aW1lLnN0cnB0aW1lKGRhdGVzdHIsIHInJW0vJWQvJVknKQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBzZWxmLnJlc3BvbnNlID0gTm9uZQ0KICAgICAgICBlbGlmIHNlbGYudmFsdWVfdHlwZSA9PSAnc2xpZGVyJzoNCiAgICAgICAgICAgIHNlbGYucmVzcG9uc2UgPSBzZWxmLm51bWJlclBpY2tlci5WYWx1ZQ0KDQoNCmNsYXNzIFRlbXBsYXRlUHJvbXB0QmFyKFdQRldpbmRvdyk6DQogICAgIiIiVGVtcGxhdGUgY29udGV4dC1tYW5hZ2VyIGNsYXNzIGZvciBjcmVhdGluZyBwcm9tcHQgYmFycy4NCg0KICAgIFByb21wdCBiYXJzIGFyZSBzaG93IGF0IHRoZSB0b3Agb2YgdGhlIGFjdGl2ZSBSZXZpdCB3aW5kb3cgYW5kIGFyZQ0KICAgIGRlc2lnbmVkIGZvciBiZXR0ZXIgcHJvbXB0IHZpc2liaWxpdHkuDQoNCiAgICBBcmdzOg0KICAgICAgICBoZWlnaHQgKGludCk6IHdpbmRvdyBoZWlnaHQNCiAgICAgICAgKiprd2FyZ3MgKEFueSk6IG90aGVyIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gOmZ1bmM6YF9zZXR1cGANCiAgICAiIiINCg0KICAgIHhhbWxfc291cmNlID0gJ1RlbXBsYXRlUHJvbXB0QmFyLnhhbWwnDQoNCiAgICBkZWYgX19pbml0X18oc2VsZiwgaGVpZ2h0PTMyLCAqKmt3YXJncyk6DQogICAgICAgICIiIkluaXRpYWxpemUgdXNlciBwcm9tcHQgd2luZG93LiIiIg0KICAgICAgICBXUEZXaW5kb3cuX19pbml0X18oc2VsZiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wLmpvaW4oWEFNTF9GSUxFU19ESVIsIHNlbGYueGFtbF9zb3VyY2UpKQ0KDQogICAgICAgIHNlbGYudXNlcl9oZWlnaHQgPSBoZWlnaHQNCiAgICAgICAgc2VsZi51cGRhdGVfd2luZG93KCkNCiAgICAgICAgc2VsZi5fc2V0dXAoKiprd2FyZ3MpDQoNCiAgICBkZWYgdXBkYXRlX3dpbmRvdyhzZWxmKToNCiAgICAgICAgIiIiVXBkYXRlIHRoZSBwcm9tcHQgYmFyIHRvIG1hdGNoIFJldml0IHdpbmRvdy4iIiINCiAgICAgICAgc2NyZWVuX2FyZWEgPSBIT1NUX0FQUC5wcm9jX3NjcmVlbl93b3JrYXJlYQ0KICAgICAgICBzY2FsZV9mYWN0b3IgPSAxLjAgLyBIT1NUX0FQUC5wcm9jX3NjcmVlbl9zY2FsZWZhY3Rvcg0KICAgICAgICB0b3AgPSBsZWZ0ID0gd2lkdGggPSBoZWlnaHQgPSAwDQoNCiAgICAgICAgd2luZG93X3JlY3QgPSByZXZpdC51aS5nZXRfd2luZG93X3JlY3RhbmdsZSgpDQoNCiAgICAgICAgIyBzZXQgd2lkdGggYW5kIGhlaWdodA0KICAgICAgICB3aWR0aCA9IHdpbmRvd19yZWN0LlJpZ2h0IC0gd2luZG93X3JlY3QuTGVmdA0KICAgICAgICBoZWlnaHQgPSBzZWxmLnVzZXJfaGVpZ2h0DQoNCiAgICAgICAgdG9wID0gd2luZG93X3JlY3QuVG9wDQogICAgICAgICMgaW4gbWF4aW1pemVkIHdpbmRvdywgdGhlIHRvcCBtaWdodCBiZSBvZmYgdGhlIGFjdGl2ZSBzY3JlZW4NCiAgICAgICAgIyBkdWUgdG8gd2luZG93cyB0aGlja2VyIHdpbmRvdyBmcmFtZXMNCiAgICAgICAgIyBsZXRzIGN1dCB0aGUgaGVpZ2h0IGFuZCByZS1hZGp1c3QgdGhlIHRvcA0KICAgICAgICB0b3BfZGlmZiA9IGFicyhzY3JlZW5fYXJlYS5Ub3AgLSB0b3ApDQogICAgICAgIGlmIDEwID4gdG9wX2RpZmYgPiAwIGFuZCB0b3BfZGlmZiA8IGhlaWdodDoNCiAgICAgICAgICAgIGhlaWdodCAtPSB0b3BfZGlmZg0KICAgICAgICAgICAgdG9wID0gc2NyZWVuX2FyZWEuVG9wDQoNCiAgICAgICAgbGVmdCA9IHdpbmRvd19yZWN0LkxlZnQNCiAgICAgICAgIyBpbiBtYXhpbWl6ZWQgd2luZG93LCBMZWZ0IGFsc28gbWlnaHQgYmUgb2ZmIHRoZSBhY3RpdmUgc2NyZWVuDQogICAgICAgICMgZHVlIHRvIHdpbmRvd3MgdGhpY2tlciB3aW5kb3cgZnJhbWVzDQogICAgICAgICMgbGV0J3MgZml4IHRoZSB3aWR0aCB0byBhY2NvbW9kYXRlIHRoZSBleHRyYSBwaXhlbHMgYXMgd2VsbA0KICAgICAgICBsZWZ0X2RpZmYgPSBhYnMoc2NyZWVuX2FyZWEuTGVmdCAtIGxlZnQpDQogICAgICAgIGlmIDEwID4gbGVmdF9kaWZmID4gMCBhbmQgbGVmdF9kaWZmIDwgd2lkdGg6DQogICAgICAgICAgICAjIGRlZHVjdCB0d28gdGltZXMgdGhlIGxlZnQgbmVnYXRpdmUgb2Zmc2V0IHNpbmNlIHRoaXMgZXh0cmENCiAgICAgICAgICAgICMgb2Zmc2V0IGhhcHBlbnMgb24gYm90aCBsZWZ0IGFuZCByaWdodCBzaWRlDQogICAgICAgICAgICB3aWR0aCAtPSBsZWZ0X2RpZmYgKiAyDQogICAgICAgICAgICBsZWZ0ID0gc2NyZWVuX2FyZWEuTGVmdA0KDQogICAgICAgIHNlbGYuVG9wID0gdG9wICogc2NhbGVfZmFjdG9yDQogICAgICAgIHNlbGYuTGVmdCA9IGxlZnQgKiBzY2FsZV9mYWN0b3INCiAgICAgICAgc2VsZi5XaWR0aCA9IHdpZHRoICogc2NhbGVfZmFjdG9yDQogICAgICAgIHNlbGYuSGVpZ2h0ID0gaGVpZ2h0DQoNCiAgICBkZWYgX3NldHVwKHNlbGYsICoqa3dhcmdzKToNCiAgICAgICAgIiIiUHJpdmF0ZSBtZXRob2QgdG8gYmUgb3ZlcnJpZGVuIGJ5IHN1YmNsYXNzZXMgZm9yIHByb21wdCBzZXR1cC4iIiINCiAgICAgICAgcGFzcw0KDQogICAgZGVmIF9wcmVwYXJlKHNlbGYpOg0KICAgICAgICBwYXNzDQoNCiAgICBkZWYgX2NsZWFudXAoc2VsZik6DQogICAgICAgIHBhc3MNCg0KICAgIGRlZiBfX2VudGVyX18oc2VsZik6DQogICAgICAgIHNlbGYuX3ByZXBhcmUoKQ0KICAgICAgICBzZWxmLlNob3coKQ0KICAgICAgICByZXR1cm4gc2VsZg0KDQogICAgZGVmIF9fZXhpdF9fKHNlbGYsIGV4Y2VwdGlvbiwgZXhjZXB0aW9uX3ZhbHVlLCB0cmFjZWJhY2spOg0KICAgICAgICBzZWxmLl9jbGVhbnVwKCkNCiAgICAgICAgc2VsZi5DbG9zZSgpDQoNCg0KY2xhc3MgV2FybmluZ0JhcihUZW1wbGF0ZVByb21wdEJhcik6DQogICAgIiIiU2hvdyB3YXJuaW5nIGJhciBhdCB0aGUgdG9wIG9mIFJldml0IHdpbmRvdy4NCg0KICAgIEtleXdvcmQgQXJnczoNCiAgICAgICAgdGl0bGUgKHN0cmluZyk6IHdhcm5pbmcgYmFyIHRleHQNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgd2l0aCBXYXJuaW5nQmFyKHRpdGxlPSdteSB3YXJuaW5nJyk6DQogICAgICAgICAgICMgZG8gc3R1ZmYNCiAgICAgICAgYGBgDQogICAgIiIiDQoNCiAgICB4YW1sX3NvdXJjZSA9ICdXYXJuaW5nQmFyLnhhbWwnDQoNCiAgICBkZWYgX3NldHVwKHNlbGYsICoqa3dhcmdzKToNCiAgICAgICAgc2VsZi5tZXNzYWdlX3RiLlRleHQgPSBrd2FyZ3MuZ2V0KCd0aXRsZScsICcnKQ0KDQoNCmNsYXNzIFByb2dyZXNzQmFyKFRlbXBsYXRlUHJvbXB0QmFyKToNCiAgICAiIiJTaG93IHByb2dyZXNzIGJhciBhdCB0aGUgdG9wIG9mIFJldml0IHdpbmRvdy4NCg0KICAgIEtleXdvcmQgQXJnczoNCiAgICAgICAgdGl0bGUgKHN0cmluZyk6IHByb2dyZXNzIGJhciB0ZXh0LCBkZWZhdWx0cyB0byAwLzEwMCBwcm9ncmVzcyBmb3JtYXQgDQogICAgICAgIGluZGV0ZXJtaW5hdGUgKGJvb2wpOiBjcmVhdGUgaW5kZXRlcm1pbmF0ZSBwcm9ncmVzcyBiYXINCiAgICAgICAgY2FuY2VsbGFibGUgKGJvb2wpOiBhZGQgY2FuY2VsIGJ1dHRvbiB0byBwcm9ncmVzcyBiYXINCiAgICAgICAgc3RlcCAoaW50KTogdXBkYXRlIHByb2dyZXNzIGludGVydmFscw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGNvdW50ID0gMQ0KICAgICAgICB3aXRoIGZvcm1zLlByb2dyZXNzQmFyKHRpdGxlPSdteSBjb21tYW5kIHByb2dyZXNzIG1lc3NhZ2UnKSBhcyBwYjoNCiAgICAgICAgICAgIyBkbyBzdHVmZg0KICAgICAgICAgICBwYi51cGRhdGVfcHJvZ3Jlc3MoY291bnQsIDEwMCkNCiAgICAgICAgICAgY291bnQgKz0gMQ0KICAgICAgICBgYGANCg0KICAgICAgICBQcm9ncmVzcyBiYXIgdGl0bGUgY291bGQgYWxzbyBiZSBjdXN0b21pemVkIHRvIHNob3cgdGhlIGN1cnJlbnQgYW5kDQogICAgICAgIHRvdGFsIHByb2dyZXNzIHZhbHVlcy4gSW4gZXhhbXBsZSBiZWxvdywgdGhlIHByb2dyZXNzIGJhciBtZXNzYWdlDQogICAgICAgIHdpbGwgYmUgaW4gZm9ybWF0ICIwIG9mIDEwMCINCg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgd2l0aCBmb3Jtcy5Qcm9ncmVzc0Jhcih0aXRsZT0ne3ZhbHVlfSBvZiB7bWF4X3ZhbHVlfScpIGFzIHBiOg0KICAgICAgICBgYGANCg0KICAgICAgICBCeSBkZWZhdWx0IHByb2dyZXNzIGJhciB1cGRhdGVzIHRoZSBwcm9ncmVzcyBldmVyeSB0aW1lIHRoZQ0KICAgICAgICAudXBkYXRlX3Byb2dyZXNzIG1ldGhvZCBpcyBjYWxsZWQuIEZvciBvcGVyYXRpb25zIHdpdGggYSBsYXJnZSBudW1iZXINCiAgICAgICAgb2YgbWF4IHN0ZXBzLCB0aGUgZ3VpIHVwZGF0ZSBwcm9jZXNzIHRpbWUgd2lsbCBoYXZlIGEgc2lnbmlmaWNhdGUNCiAgICAgICAgZWZmZWN0IG9uIHRoZSBvdmVyYWxsIGV4ZWN1dGlvbiB0aW1lIG9mIHRoZSBjb21tYW5kLiBJbiB0aGVzZSBjYXNlcywNCiAgICAgICAgc2V0IHRoZSB2YWx1ZSBvZiBzdGVwIGFyZ3VtZW50IHRvIHNvbWV0aGluZyBsYXJnZXIgdGhhbiAxLiBJbiBleGFtcGxlDQogICAgICAgIGJlbG93LCB0aGUgcHJvZ3Jlc3MgYmFyIHVwZGF0ZXMgb25jZSBwZXIgZXZlcnkgMTAgdW5pdHMgb2YgcHJvZ3Jlc3MuDQoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIHdpdGggZm9ybXMuUHJvZ3Jlc3NCYXIodGl0bGU9J21lc3NhZ2UnLCBzdGVwcz0xMCk6DQogICAgICAgIGBgYA0KDQogICAgICAgIFByb2dyZXNzIGJhciBjb3VsZCBhbHNvIGJlIHNldCB0byBpbmRldGVybWluYXRlIGZvciBvcGVyYXRpb25zIG9mDQogICAgICAgIHVua25vd24gbGVuZ3RoLiBJbiB0aGlzIGNhc2UsIHRoZSBwcm9ncmVzcyBiYXIgd2lsbCBzaG93IGFuIGluZmluaXRlbHkNCiAgICAgICAgcnVubmluZyByaWJib246DQoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIHdpdGggZm9ybXMuUHJvZ3Jlc3NCYXIodGl0bGU9J21lc3NhZ2UnLCBpbmRldGVybWluYXRlPVRydWUpOg0KICAgICAgICBgYGANCg0KICAgICAgICBpZiBjYW5jZWxsYWJsZSBpcyBzZXQgb24gdGhlIG9iamVjdCwgYSBjYW5jZWwgYnV0dG9uIHdpbGwgc2hvdyBvbiB0aGUNCiAgICAgICAgcHJvZ3Jlc3MgYmFyIGFuZCAuY2FuY2VsbGVkIGF0dHJpYnV0ZSB3aWxsIGJlIHNldCBvbiB0aGUgUHJvZ3Jlc3NCYXINCiAgICAgICAgaW5zdGFuY2UgaWYgdXNlcnMgY2xpY2tzIG9uIGNhbmNlbCBidXR0b246DQoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIHdpdGggZm9ybXMuUHJvZ3Jlc3NCYXIodGl0bGU9J21lc3NhZ2UnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbmNlbGxhYmxlPVRydWUpIGFzIHBiOg0KICAgICAgICAgICAjIGRvIHN0dWZmDQogICAgICAgICAgIGlmIHBiLmNhbmNlbGxlZDoNCiAgICAgICAgICAgICAgICMgd3JhcCB1cCBhbmQgY2FuY2VsIG9wZXJhdGlvbg0KICAgICAgICBgYGANCiAgICAiIiINCg0KICAgIHhhbWxfc291cmNlID0gJ1Byb2dyZXNzQmFyLnhhbWwnDQoNCiAgICBkZWYgX3NldHVwKHNlbGYsICoqa3dhcmdzKToNCiAgICAgICAgc2VsZi5tYXhfdmFsdWUgPSAxDQogICAgICAgIHNlbGYubmV3X3ZhbHVlID0gMA0KICAgICAgICBzZWxmLnN0ZXAgPSBrd2FyZ3MuZ2V0KCdzdGVwJywgMCkNCg0KICAgICAgICBzZWxmLmNhbmNlbGxlZCA9IEZhbHNlDQogICAgICAgIGhhc19jYW5jZWwgPSBrd2FyZ3MuZ2V0KCdjYW5jZWxsYWJsZScsIEZhbHNlKQ0KICAgICAgICBpZiBoYXNfY2FuY2VsOg0KICAgICAgICAgICAgc2VsZi5zaG93X2VsZW1lbnQoc2VsZi5jYW5jZWxfYikNCg0KICAgICAgICBzZWxmLnBiYXIuSXNJbmRldGVybWluYXRlID0ga3dhcmdzLmdldCgnaW5kZXRlcm1pbmF0ZScsIEZhbHNlKQ0KICAgICAgICBzZWxmLl90aXRsZSA9IGt3YXJncy5nZXQoJ3RpdGxlJywgJ3t2YWx1ZX0ve21heF92YWx1ZX0nKQ0KICAgICAgICBzZWxmLl9ob3N0d25kID0gTm9uZQ0KICAgICAgICBzZWxmLl9ob3N0X3Rhc2tfcGJhciA9IE5vbmUNCg0KICAgIGRlZiBfcHJlcGFyZShzZWxmKToNCiAgICAgICAgc2VsZi5faG9zdHduZCA9IHJldml0LnVpLmdldF9tYWlud2luZG93KCkNCiAgICAgICAgaWYgc2VsZi5faG9zdHduZDoNCiAgICAgICAgICAgIHNlbGYuX2hvc3RfdGFza19wYmFyID0gU3lzdGVtLldpbmRvd3MuU2hlbGwuVGFza2Jhckl0ZW1JbmZvKCkNCiAgICAgICAgICAgIHNlbGYuX2hvc3R3bmQuVGFza2Jhckl0ZW1JbmZvID0gc2VsZi5faG9zdF90YXNrX3BiYXINCg0KICAgIGRlZiBfY2xlYW51cChzZWxmKToNCiAgICAgICAgaWYgc2VsZi5faG9zdHduZDoNCiAgICAgICAgICAgIHNlbGYuX2hvc3R3bmQuVGFza2Jhckl0ZW1JbmZvID0gTm9uZQ0KDQogICAgZGVmIF91cGRhdGVfdGFza19wYmFyKHNlbGYpOg0KICAgICAgICBpZiBzZWxmLl9ob3N0X3Rhc2tfcGJhciBpcyBub3QgTm9uZToNCiAgICAgICAgICAgIGlmIHNlbGYuaW5kZXRlcm1pbmF0ZToNCiAgICAgICAgICAgICAgICBzZWxmLl9ob3N0X3Rhc2tfcGJhci5Qcm9ncmVzc1N0YXRlID0gXA0KICAgICAgICAgICAgICAgICAgICBTeXN0ZW0uV2luZG93cy5TaGVsbC5UYXNrYmFySXRlbVByb2dyZXNzU3RhdGUuSW5kZXRlcm1pbmF0ZQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBzZWxmLl9ob3N0X3Rhc2tfcGJhci5Qcm9ncmVzc1N0YXRlID0gXA0KICAgICAgICAgICAgICAgICAgICBTeXN0ZW0uV2luZG93cy5TaGVsbC5UYXNrYmFySXRlbVByb2dyZXNzU3RhdGUuTm9ybWFsDQogICAgICAgICAgICAgICAgc2VsZi5faG9zdF90YXNrX3BiYXIuUHJvZ3Jlc3NWYWx1ZSA9IFwNCiAgICAgICAgICAgICAgICAgICAgKHNlbGYubmV3X3ZhbHVlIC8gZmxvYXQoc2VsZi5tYXhfdmFsdWUpKQ0KDQogICAgZGVmIF91cGRhdGVfcGJhcihzZWxmKToNCiAgICAgICAgc2VsZi51cGRhdGVfd2luZG93KCkNCiAgICAgICAgc2VsZi5wYmFyLk1heGltdW0gPSBzZWxmLm1heF92YWx1ZQ0KICAgICAgICBzZWxmLnBiYXIuVmFsdWUgPSBzZWxmLm5ld192YWx1ZQ0KDQogICAgICAgICMgdXBkYXRpbmcgdGl0bGUNCiAgICAgICAgdGl0bGVfdGV4dCA9IFwNCiAgICAgICAgICAgIHN0cmluZy5Gb3JtYXR0ZXIoKS52Zm9ybWF0KHNlbGYuX3RpdGxlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3JldXRpbHMuU2FmZURpY3QoDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd2YWx1ZSc6IHNlbGYubmV3X3ZhbHVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWF4X3ZhbHVlJzogc2VsZi5tYXhfdmFsdWV9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSkNCg0KICAgICAgICBzZWxmLnBiYXJfdGV4dC5UZXh0ID0gdGl0bGVfdGV4dA0KDQogICAgZGVmIF9kb25vdGhpbmcoc2VsZik6DQogICAgICAgIHBhc3MNCg0KICAgIGRlZiBfZGlzcGF0Y2hfdXBkYXRlcihzZWxmKToNCiAgICAgICAgIyBhc2sgV1BGIGRpc3BhdGNoZXIgZm9yIGd1aSB1cGRhdGUNCiAgICAgICAgc2VsZi5wYmFyLkRpc3BhdGNoZXIuSW52b2tlKFN5c3RlbS5BY3Rpb24oc2VsZi5fdXBkYXRlX3BiYXIpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhyZWFkaW5nLkRpc3BhdGNoZXJQcmlvcml0eS5CYWNrZ3JvdW5kKQ0KICAgICAgICAjIGFzayBXUEYgZGlzcGF0Y2hlciBmb3IgZ3VpIHVwZGF0ZQ0KICAgICAgICBzZWxmLnBiYXIuRGlzcGF0Y2hlci5JbnZva2UoU3lzdGVtLkFjdGlvbihzZWxmLl91cGRhdGVfdGFza19wYmFyKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRocmVhZGluZy5EaXNwYXRjaGVyUHJpb3JpdHkuQmFja2dyb3VuZCkNCiAgICAgICAgIyBnaXZlIGl0IGEgbGl0dGxlIGZyZWUgdGltZSB0byB1cGRhdGUgdWkNCiAgICAgICAgc2VsZi5wYmFyLkRpc3BhdGNoZXIuSW52b2tlKFN5c3RlbS5BY3Rpb24oc2VsZi5fZG9ub3RoaW5nKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRocmVhZGluZy5EaXNwYXRjaGVyUHJpb3JpdHkuQmFja2dyb3VuZCkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB0aXRsZShzZWxmKToNCiAgICAgICAgIiIiUHJvZ3Jlc3MgYmFyIHRpdGxlLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5fdGl0bGUNCg0KICAgIEB0aXRsZS5zZXR0ZXINCiAgICBkZWYgdGl0bGUoc2VsZiwgdmFsdWUpOg0KICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHIpOg0KICAgICAgICAgICAgc2VsZi5fdGl0bGUgPSB2YWx1ZSAgICAjcHlsaW50OiBkaXNhYmxlPVcwMjAxDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgaW5kZXRlcm1pbmF0ZShzZWxmKToNCiAgICAgICAgIiIiUHJvZ3Jlc3MgYmFyIGluZGV0ZXJtaW5hdGUgc3RhdGUuIiIiDQogICAgICAgIHJldHVybiBzZWxmLnBiYXIuSXNJbmRldGVybWluYXRlDQoNCiAgICBAaW5kZXRlcm1pbmF0ZS5zZXR0ZXINCiAgICBkZWYgaW5kZXRlcm1pbmF0ZShzZWxmLCB2YWx1ZSk6DQogICAgICAgIHNlbGYucGJhci5Jc0luZGV0ZXJtaW5hdGUgPSB2YWx1ZQ0KDQogICAgZGVmIGNsaWNrZWRfY2FuY2VsKHNlbGYsIHNlbmRlciwgYXJncyk6ICAgICNweWxpbnQ6IGRpc2FibGU9VzA2MTMNCiAgICAgICAgIiIiSGFuZGxlciBmb3IgY2FuY2VsIGJ1dHRvbiBjbGlja2VkIGV2ZW50LiIiIg0KICAgICAgICBzZWxmLmNhbmNlbF9iLkNvbnRlbnQgPSAnQ2FuY2VsbGluZy4uLicNCiAgICAgICAgc2VsZi5jYW5jZWxsZWQgPSBUcnVlICAgICNweWxpbnQ6IGRpc2FibGU9VzAyMDENCg0KICAgIGRlZiByZXNldChzZWxmKToNCiAgICAgICAgIiIiUmVzZXQgcHJvZ3Jlc3MgdmFsdWUgdG8gMC4iIiINCiAgICAgICAgc2VsZi51cGRhdGVfcHJvZ3Jlc3MoMCwgMSkNCg0KICAgIGRlZiB1cGRhdGVfcHJvZ3Jlc3Moc2VsZiwgbmV3X3ZhbHVlLCBtYXhfdmFsdWU9MSk6DQogICAgICAgICIiIlVwZGF0ZSBwcm9ncmVzcyBiYXIgc3RhdGUgd2l0aCBnaXZlbiBtaW4sIG1heCB2YWx1ZXMuDQoNCiAgICAgICAgQXJnczoNCiAgICAgICAgICAgIG5ld192YWx1ZSAoZmxvYXQpOiBjdXJyZW50IHByb2dyZXNzIHZhbHVlDQogICAgICAgICAgICBtYXhfdmFsdWUgKGZsb2F0KTogdG90YWwgcHJvZ3Jlc3MgdmFsdWUNCiAgICAgICAgIiIiDQogICAgICAgIHNlbGYubWF4X3ZhbHVlID0gbWF4X3ZhbHVlICAgICNweWxpbnQ6IGRpc2FibGU9VzAyMDENCiAgICAgICAgc2VsZi5uZXdfdmFsdWUgPSBuZXdfdmFsdWUgICAgI3B5bGludDogZGlzYWJsZT1XMDIwMQ0KICAgICAgICBpZiBzZWxmLm5ld192YWx1ZSA9PSAwOg0KICAgICAgICAgICAgc2VsZi5fZGlzcGF0Y2hfdXBkYXRlcigpDQogICAgICAgIGVsaWYgc2VsZi5zdGVwID4gMDoNCiAgICAgICAgICAgIGlmIHNlbGYubmV3X3ZhbHVlICUgc2VsZi5zdGVwID09IDA6DQogICAgICAgICAgICAgICAgc2VsZi5fZGlzcGF0Y2hfdXBkYXRlcigpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBzZWxmLl9kaXNwYXRjaF91cGRhdGVyKCkNCg0KDQpjbGFzcyBTZWFyY2hQcm9tcHQoV1BGV2luZG93KToNCiAgICAiIiJTdGFuZGFyZCBwcm9tcHQgZm9yIHB5UmV2aXQgc2VhcmNoLg0KDQogICAgQXJnczoNCiAgICAgICAgc2VhcmNoX2RiIChsaXN0KTogbGlzdCBvZiBwb3NzaWJsZSBzZWFyY2ggdGFyZ2V0cw0KICAgICAgICB3aWR0aCAoaW50KTogd2lkdGggb2Ygc2VhcmNoIHByb21wdCB3aW5kb3cNCiAgICAgICAgaGVpZ2h0IChpbnQpOiBoZWlnaHQgb2Ygc2VhcmNoIHByb21wdCB3aW5kb3cNCg0KICAgIEtleXdvcmQgQXJnczoNCiAgICAgICAgc2VhcmNoX3RpcCAoc3RyKTogdGV4dCB0byBzaG93IGluIGdyYXlzY2FsZSB3aGVuIHNlYXJjaCBib3ggaXMgZW1wdHkNCiAgICAgICAgc3dpdGNoZXMgKHN0cik6IGxpc3Qgb2Ygc3dpdGNoZXMNCg0KICAgIFJldHVybnM6DQogICAgICAgICh0dXBsZVtzdHIsIGRpY3RdIHwgc3RyKTogbWF0Y2hlZCBzdHJpbmcgaWYgc3dpdGNoZXMgYXJlIG5vdCBwcm92aWRlZCwNCiAgICAgICAgICAgIG1hdGNoZWQgc3RyaW5ncywgYW5kIGRpY3Qgb2Ygc3dpdGNoZXMgb3RoZXJ3aXNlLg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgICMgYXNzdW1lIHNlYXJjaCBpbnB1dCBvZiAnL3N3aXRjaDEgdGFyZ2V0MScNCiAgICAgICAgbWF0Y2hlZF9zdHIsIGFyZ3MsIHN3aXRjaGVzID0gZm9ybXMuU2VhcmNoUHJvbXB0LnNob3coDQogICAgICAgICAgICBzZWFyY2hfZGI9Wyd0YXJnZXQxJywgJ3RhcmdldDInLCAndGFyZ2V0MycsICd0YXJnZXQ0J10sDQogICAgICAgICAgICBzd2l0Y2hlcz1bJy9zd2l0Y2gxJywgJy9zd2l0Y2gyJ10sDQogICAgICAgICAgICBzZWFyY2hfdGlwPSdweVJldml0IFNlYXJjaCcNCiAgICAgICAgICAgICkNCiAgICAgICAgbWF0Y2hlZF9zdHINCiAgICAgICAgJ3RhcmdldDEnDQogICAgICAgIGFyZ3MNCiAgICAgICAgWyctLWhlbHAnLCAnLS1icmFuY2gnLCAnYnJhbmNobmFtZSddDQogICAgICAgIHN3aXRjaGVzDQogICAgICAgIHsnL3N3aXRjaDEnOiBUcnVlLCAnL3N3aXRjaDInOiBGYWxzZX0NCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNlYXJjaF9kYiwgd2lkdGgsIGhlaWdodCwgKiprd2FyZ3MpOg0KICAgICAgICAiIiJJbml0aWFsaXplIHNlYXJjaCBwcm9tcHQgd2luZG93LiIiIg0KICAgICAgICBXUEZXaW5kb3cuX19pbml0X18oc2VsZiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wLmpvaW4oWEFNTF9GSUxFU19ESVIsICdTZWFyY2hQcm9tcHQueGFtbCcpKQ0KICAgICAgICBzZWxmLldpZHRoID0gd2lkdGgNCiAgICAgICAgc2VsZi5NaW5XaWR0aCA9IHNlbGYuV2lkdGgNCiAgICAgICAgc2VsZi5IZWlnaHQgPSBoZWlnaHQNCg0KICAgICAgICBzZWxmLnNlYXJjaF90aXAgPSBrd2FyZ3MuZ2V0KCdzZWFyY2hfdGlwJywgJycpDQoNCiAgICAgICAgaWYgaXNpbnN0YW5jZShzZWFyY2hfZGIsIGxpc3QpOg0KICAgICAgICAgICAgc2VsZi5fc2VhcmNoX2RiID0gTm9uZQ0KICAgICAgICAgICAgc2VsZi5fc2VhcmNoX2RiX2tleXMgPSBzZWFyY2hfZGINCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKHNlYXJjaF9kYiwgZGljdCk6DQogICAgICAgICAgICBzZWxmLl9zZWFyY2hfZGIgPSBzZWFyY2hfZGINCiAgICAgICAgICAgIHNlbGYuX3NlYXJjaF9kYl9rZXlzID0gc29ydGVkKHNlbGYuX3NlYXJjaF9kYi5rZXlzKCkpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByYWlzZSBQeVJldml0RXhjZXB0aW9uKCJVbmtub3duIHNlYXJjaCBkYXRhYmFzZSB0eXBlIikNCg0KICAgICAgICBzZWxmLl9zZWFyY2hfcmVzID0gTm9uZQ0KICAgICAgICBzZWxmLl9zd2l0Y2hlcyA9IGt3YXJncy5nZXQoJ3N3aXRjaGVzJywgW10pDQogICAgICAgIHNlbGYuX3NldHVwX3Jlc3BvbnNlKCkNCg0KICAgICAgICBzZWxmLnNlYXJjaF90Yi5Gb2N1cygpDQogICAgICAgIHNlbGYuaGlkZV9lbGVtZW50KHNlbGYudGFiX2ljb24pDQogICAgICAgIHNlbGYuaGlkZV9lbGVtZW50KHNlbGYucmV0dXJuX2ljb24pDQogICAgICAgIHNlbGYuc2VhcmNoX3RiLlRleHQgPSAnJw0KICAgICAgICBzZWxmLnNldF9zZWFyY2hfcmVzdWx0cygpDQoNCiAgICBkZWYgX3NldHVwX3Jlc3BvbnNlKHNlbGYsIHJlc3BvbnNlPU5vbmUpOg0KICAgICAgICBzd2l0Y2hfZGljdCA9IGRpY3QuZnJvbWtleXMoc2VsZi5fc3dpdGNoZXMpDQogICAgICAgIGZvciBzd2l0Y2ggaW4gc2VsZi5zZWFyY2hfdGVybV9zd2l0Y2hlczoNCiAgICAgICAgICAgIHN3aXRjaF9kaWN0W3N3aXRjaF0gPSBUcnVlDQogICAgICAgIGFyZ3VtZW50cyA9IHNlbGYuc2VhcmNoX3Rlcm1fYXJncw0KICAgICAgICAjIHJlbW92ZSBmaXJzdCBhcmcgd2hpY2ggaXMgY29tbWFuZCBuYW1lDQogICAgICAgIGlmIGxlbihhcmd1bWVudHMpID49IDE6DQogICAgICAgICAgICBhcmd1bWVudHMgPSBhcmd1bWVudHNbMTpdDQoNCiAgICAgICAgc2VsZi5yZXNwb25zZSA9IHJlc3BvbnNlLCBhcmd1bWVudHMsIHN3aXRjaF9kaWN0DQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgc2VhcmNoX2lucHV0KHNlbGYpOg0KICAgICAgICAiIiJDdXJyZW50IHNlYXJjaCBpbnB1dC4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuc2VhcmNoX3RiLlRleHQNCg0KICAgIEBzZWFyY2hfaW5wdXQuc2V0dGVyDQogICAgZGVmIHNlYXJjaF9pbnB1dChzZWxmLCB2YWx1ZSk6DQogICAgICAgIHNlbGYuc2VhcmNoX3RiLlRleHQgPSB2YWx1ZQ0KICAgICAgICBzZWxmLnNlYXJjaF90Yi5DYXJldEluZGV4ID0gbGVuKHZhbHVlKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHNlYXJjaF9pbnB1dF9wYXJ0cyhzZWxmKToNCiAgICAgICAgIiIiQ3VycmVudCBjbGVhbmVkIHVwIHNlYXJjaCB0ZXJtLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5zZWFyY2hfaW5wdXQuc3RyaXAoKS5zcGxpdCgpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgc2VhcmNoX3Rlcm0oc2VsZik6DQogICAgICAgICIiIkN1cnJlbnQgY2xlYW5lZCB1cCBzZWFyY2ggdGVybS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuc2VhcmNoX2lucHV0Lmxvd2VyKCkuc3RyaXAoKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHNlYXJjaF90ZXJtX3N3aXRjaGVzKHNlbGYpOg0KICAgICAgICAiIiJGaW5kIG1hdGNoaW5nIHN3aXRjaGVzIGluIHNlYXJjaCB0ZXJtLiIiIg0KICAgICAgICBzd2l0Y2hlcyA9IHNldCgpDQogICAgICAgIGZvciBzdHBhcnQgaW4gc2VsZi5zZWFyY2hfaW5wdXRfcGFydHM6DQogICAgICAgICAgICBpZiBzdHBhcnQubG93ZXIoKSBpbiBzZWxmLl9zd2l0Y2hlczoNCiAgICAgICAgICAgICAgICBzd2l0Y2hlcy5hZGQoc3RwYXJ0KQ0KICAgICAgICByZXR1cm4gc3dpdGNoZXMNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBzZWFyY2hfdGVybV9hcmdzKHNlbGYpOg0KICAgICAgICAiIiJGaW5kIGFyZ3VtZW50cyBpbiBzZWFyY2ggdGVybS4iIiINCiAgICAgICAgYXJncyA9IFtdDQogICAgICAgIHN3aXRjaGVzID0gc2VsZi5zZWFyY2hfdGVybV9zd2l0Y2hlcw0KICAgICAgICBmb3Igc3BhcnQgaW4gc2VsZi5zZWFyY2hfaW5wdXRfcGFydHM6DQogICAgICAgICAgICBpZiBzcGFydC5sb3dlcigpIG5vdCBpbiBzd2l0Y2hlczoNCiAgICAgICAgICAgICAgICBhcmdzLmFwcGVuZChzcGFydCkNCiAgICAgICAgcmV0dXJuIGFyZ3MNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBzZWFyY2hfdGVybV9tYWluKHNlbGYpOg0KICAgICAgICAiIiJDdXJyZW50IGNsZWFuZWQgdXAgc2VhcmNoIHRlcm0gd2l0aG91dCB0aGUgbGlzdGVkIHN3aXRjaGVzLiIiIg0KICAgICAgICBpZiBsZW4oc2VsZi5zZWFyY2hfdGVybV9hcmdzKSA+PSAxOg0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2VhcmNoX3Rlcm1fYXJnc1swXQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuICcnDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgc2VhcmNoX21hdGNoZXMoc2VsZik6DQogICAgICAgICIiIkxpc3Qgb2YgbWF0Y2hlcyBmb3IgdGhlIGdpdmVuIHNlYXJjaCB0ZXJtLiIiIg0KICAgICAgICAjIHJlbW92ZSBkdXBsaWNhdGVzIHdoaWxlIGtlZXBpbmcgb3JkZXINCiAgICAgICAgIyByZXN1bHRzID0gbGlzdChzZXQoc2VsZi5fc2VhcmNoX3Jlc3VsdHMpKQ0KICAgICAgICByZXR1cm4gT3JkZXJlZERpY3QuZnJvbWtleXMoc2VsZi5fc2VhcmNoX3Jlc3VsdHMpLmtleXMoKQ0KDQogICAgZGVmIHVwZGF0ZV9yZXN1bHRzX2Rpc3BsYXkoc2VsZiwgZmlsbF9tYXRjaD1GYWxzZSk6DQogICAgICAgICIiIlVwZGF0ZSBzZWFyY2ggcHJvbXB0IHJlc3VsdHMgYmFzZWQgb24gY3VycmVudCBpbnB1dCB0ZXh0LiIiIg0KICAgICAgICBzZWxmLmRpcmVjdG1hdGNoX3RiLlRleHQgPSAnJw0KICAgICAgICBzZWxmLndvcmRzbWF0Y2hfdGIuVGV4dCA9ICcnDQoNCiAgICAgICAgcmVzdWx0cyA9IHNlbGYuc2VhcmNoX21hdGNoZXMNCiAgICAgICAgcmVzX2NvdXQgPSBsZW4ocmVzdWx0cykNCg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCd1bmlxdWUgcmVzdWx0cyBjb3VudDogJXMnLCByZXNfY291dCkNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygndW5pcXVlIHJlc3VsdHM6ICVzJywgcmVzdWx0cykNCg0KICAgICAgICBpZiByZXNfY291dCA+IDE6DQogICAgICAgICAgICBzZWxmLnNob3dfZWxlbWVudChzZWxmLnRhYl9pY29uKQ0KICAgICAgICAgICAgc2VsZi5oaWRlX2VsZW1lbnQoc2VsZi5yZXR1cm5faWNvbikNCiAgICAgICAgZWxpZiByZXNfY291dCA9PSAxOg0KICAgICAgICAgICAgc2VsZi5oaWRlX2VsZW1lbnQoc2VsZi50YWJfaWNvbikNCiAgICAgICAgICAgIHNlbGYuc2hvd19lbGVtZW50KHNlbGYucmV0dXJuX2ljb24pDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBzZWxmLmhpZGVfZWxlbWVudChzZWxmLnRhYl9pY29uKQ0KICAgICAgICAgICAgc2VsZi5oaWRlX2VsZW1lbnQoc2VsZi5yZXR1cm5faWNvbikNCg0KICAgICAgICBpZiBzZWxmLl9yZXN1bHRfaW5kZXggPj0gcmVzX2NvdXQ6DQogICAgICAgICAgICBzZWxmLl9yZXN1bHRfaW5kZXggPSAwICAgI3B5bGludDogZGlzYWJsZT1XMDIwMQ0KDQogICAgICAgIGlmIHNlbGYuX3Jlc3VsdF9pbmRleCA8IDA6DQogICAgICAgICAgICBzZWxmLl9yZXN1bHRfaW5kZXggPSByZXNfY291dCAtIDEgICAjcHlsaW50OiBkaXNhYmxlPVcwMjAxDQoNCiAgICAgICAgaWYgbm90IHNlbGYuc2VhcmNoX2lucHV0Og0KICAgICAgICAgICAgc2VsZi5kaXJlY3RtYXRjaF90Yi5UZXh0ID0gc2VsZi5zZWFyY2hfdGlwDQogICAgICAgICAgICByZXR1cm4NCg0KICAgICAgICBpZiByZXN1bHRzOg0KICAgICAgICAgICAgaW5wdXRfdGVybSA9IHNlbGYuc2VhcmNoX3Rlcm0NCiAgICAgICAgICAgIGN1cl9yZXMgPSByZXN1bHRzW3NlbGYuX3Jlc3VsdF9pbmRleF0NCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ2N1cnJlbnQgcmVzdWx0OiAlcycsIGN1cl9yZXMpDQogICAgICAgICAgICBpZiBmaWxsX21hdGNoOg0KICAgICAgICAgICAgICAgIHNlbGYuc2VhcmNoX2lucHV0ID0gY3VyX3Jlcw0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBpZiBjdXJfcmVzLmxvd2VyKCkuc3RhcnRzd2l0aChpbnB1dF90ZXJtKToNCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXJlY3RtYXRjaF90Yi5UZXh0ID0gXA0KICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZWFyY2hfaW5wdXQgKyBjdXJfcmVzW2xlbihpbnB1dF90ZXJtKTpdDQogICAgICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ2RpcmVjdG1hdGNoX3RiLlRleHQ6ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRpcmVjdG1hdGNoX3RiLlRleHQpDQogICAgICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAgICAgc2VsZi53b3Jkc21hdGNoX3RiLlRleHQgPSAnLSB7fScuZm9ybWF0KGN1cl9yZXMpDQogICAgICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ3dvcmRzbWF0Y2hfdGIuVGV4dDogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud29yZHNtYXRjaF90Yi5UZXh0KQ0KICAgICAgICAgICAgdG9vbHRpcCA9IHNlbGYuX3NlYXJjaF9kYi5nZXQoY3VyX3JlcywgTm9uZSkNCiAgICAgICAgICAgIGlmIHRvb2x0aXA6DQogICAgICAgICAgICAgICAgc2VsZi50b29sdGlwX3RiLlRleHQgPSB0b29sdGlwDQogICAgICAgICAgICAgICAgc2VsZi5zaG93X2VsZW1lbnQoc2VsZi50b29sdGlwX3RiKQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBzZWxmLmhpZGVfZWxlbWVudChzZWxmLnRvb2x0aXBfdGIpDQogICAgICAgICAgICBzZWxmLl9zZWFyY2hfcmVzID0gY3VyX3Jlcw0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCiAgICBkZWYgc2V0X3NlYXJjaF9yZXN1bHRzKHNlbGYsICphcmdzKToNCiAgICAgICAgIiIiU2V0IHNlYXJjaCByZXN1bHRzIGZvciByZXR1cm5pbmcuIiIiDQogICAgICAgIHNlbGYuX3Jlc3VsdF9pbmRleCA9IDANCiAgICAgICAgc2VsZi5fc2VhcmNoX3Jlc3VsdHMgPSBbXQ0KDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ3NlYXJjaCBpbnB1dDogJXMnLCBzZWxmLnNlYXJjaF9pbnB1dCkNCiAgICAgICAgbWxvZ2dlci5kZWJ1Zygnc2VhcmNoIHRlcm06ICVzJywgc2VsZi5zZWFyY2hfdGVybSkNCiAgICAgICAgbWxvZ2dlci5kZWJ1Zygnc2VhcmNoIHRlcm0gKG1haW4pOiAlcycsIHNlbGYuc2VhcmNoX3Rlcm1fbWFpbikNCiAgICAgICAgbWxvZ2dlci5kZWJ1Zygnc2VhcmNoIHRlcm0gKHBhcnRzKTogJXMnLCBzZWxmLnNlYXJjaF9pbnB1dF9wYXJ0cykNCiAgICAgICAgbWxvZ2dlci5kZWJ1Zygnc2VhcmNoIHRlcm0gKGFyZ3MpOiAlcycsIHNlbGYuc2VhcmNoX3Rlcm1fYXJncykNCiAgICAgICAgbWxvZ2dlci5kZWJ1Zygnc2VhcmNoIHRlcm0gKHN3aXRjaGVzKTogJXMnLCBzZWxmLnNlYXJjaF90ZXJtX3N3aXRjaGVzKQ0KDQogICAgICAgIGZvciByZXN1bHRzZXQgaW4gYXJnczoNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ3Jlc3VsdCBzZXQ6ICVzfScsIHJlc3VsdHNldCkNCiAgICAgICAgICAgIHNlbGYuX3NlYXJjaF9yZXN1bHRzLmV4dGVuZChzb3J0ZWQocmVzdWx0c2V0KSkNCg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdyZXN1bHRzOiAlcycsIHNlbGYuX3NlYXJjaF9yZXN1bHRzKQ0KDQogICAgZGVmIGZpbmRfZGlyZWN0X21hdGNoKHNlbGYsIGlucHV0X3RleHQpOg0KICAgICAgICAiIiJGaW5kIGRpcmVjdCB0ZXh0IG1hdGNoZXMgaW4gc2VhcmNoIHRlcm0uIiIiDQogICAgICAgIHJlc3VsdHMgPSBbXQ0KICAgICAgICBpZiBpbnB1dF90ZXh0Og0KICAgICAgICAgICAgZm9yIGNtZF9uYW1lIGluIHNlbGYuX3NlYXJjaF9kYl9rZXlzOg0KICAgICAgICAgICAgICAgIGlmIGNtZF9uYW1lLmxvd2VyKCkuc3RhcnRzd2l0aChpbnB1dF90ZXh0KToNCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5hcHBlbmQoY21kX25hbWUpDQoNCiAgICAgICAgcmV0dXJuIHJlc3VsdHMNCg0KICAgIGRlZiBmaW5kX3dvcmRfbWF0Y2goc2VsZiwgaW5wdXRfdGV4dCk6DQogICAgICAgICIiIkZpbmQgZGlyZWN0IHdvcmQgbWF0Y2hlcyBpbiBzZWFyY2ggdGVybS4iIiINCiAgICAgICAgcmVzdWx0cyA9IFtdDQogICAgICAgIGlmIGlucHV0X3RleHQ6DQogICAgICAgICAgICBjdXJfd29yZHMgPSBpbnB1dF90ZXh0LnNwbGl0KCcgJykNCiAgICAgICAgICAgIGZvciBjbWRfbmFtZSBpbiBzZWxmLl9zZWFyY2hfZGJfa2V5czoNCiAgICAgICAgICAgICAgICBpZiBhbGwoW3ggaW4gY21kX25hbWUubG93ZXIoKSBmb3IgeCBpbiBjdXJfd29yZHNdKToNCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5hcHBlbmQoY21kX25hbWUpDQoNCiAgICAgICAgcmV0dXJuIHJlc3VsdHMNCg0KICAgIGRlZiBzZWFyY2hfdHh0X2NoYW5nZWQoc2VsZiwgc2VuZGVyLCBhcmdzKTogICAgI3B5bGludDogZGlzYWJsZT1XMDYxMw0KICAgICAgICAiIiJIYW5kbGUgdGV4dCBjaGFuZ2VkIGV2ZW50LiIiIg0KICAgICAgICBpbnB1dF90ZXJtID0gc2VsZi5zZWFyY2hfdGVybV9tYWluDQogICAgICAgIGRtcmVzdWx0cyA9IHNlbGYuZmluZF9kaXJlY3RfbWF0Y2goaW5wdXRfdGVybSkNCiAgICAgICAgd29yZHJlc3VsdHMgPSBzZWxmLmZpbmRfd29yZF9tYXRjaChpbnB1dF90ZXJtKQ0KICAgICAgICBzZWxmLnNldF9zZWFyY2hfcmVzdWx0cyhkbXJlc3VsdHMsIHdvcmRyZXN1bHRzKQ0KICAgICAgICBzZWxmLnVwZGF0ZV9yZXN1bHRzX2Rpc3BsYXkoKQ0KDQogICAgZGVmIGhhbmRsZV9rYl9rZXkoc2VsZiwgc2VuZGVyLCBhcmdzKTogICAgI3B5bGludDogZGlzYWJsZT1XMDYxMw0KICAgICAgICAiIiJIYW5kbGUga2V5Ym9hcmQgaW5wdXQgZXZlbnQuIiIiDQogICAgICAgIHNoaWZ0ZG93biA9IElucHV0LktleWJvYXJkLklzS2V5RG93bihJbnB1dC5LZXkuTGVmdFNoaWZ0KSBcDQogICAgICAgICAgICBvciBJbnB1dC5LZXlib2FyZC5Jc0tleURvd24oSW5wdXQuS2V5LlJpZ2h0U2hpZnQpDQogICAgICAgICMgRXNjYXBlOiBzZXQgcmVzcG9uc2UgdG8gbm9uZSBhbmQgY2xvc2UNCiAgICAgICAgaWYgYXJncy5LZXkgPT0gSW5wdXQuS2V5LkVzY2FwZToNCiAgICAgICAgICAgIHNlbGYuX3NldHVwX3Jlc3BvbnNlKCkNCiAgICAgICAgICAgIHNlbGYuQ2xvc2UoKQ0KICAgICAgICAjIEVudGVyOiBjbG9zZSwgcmV0dXJucyBtYXRjaGVkIHJlc3BvbnNlIGF1dG9tYXRpY2FsbHkNCiAgICAgICAgZWxpZiBhcmdzLktleSA9PSBJbnB1dC5LZXkuRW50ZXI6DQogICAgICAgICAgICBpZiBzZWxmLnNlYXJjaF90Yi5UZXh0ICE9ICcnOg0KICAgICAgICAgICAgICAgIHNlbGYuX3NldHVwX3Jlc3BvbnNlKHJlc3BvbnNlPXNlbGYuX3NlYXJjaF9yZXMpDQogICAgICAgICAgICAgICAgYXJncy5IYW5kbGVkID0gVHJ1ZQ0KICAgICAgICAgICAgICAgIHNlbGYuQ2xvc2UoKQ0KICAgICAgICAjIFNoaWZ0K1RhYiwgVGFiOiBDeWNsZSB0aHJvdWdoIG1hdGNoZXMNCiAgICAgICAgZWxpZiBhcmdzLktleSA9PSBJbnB1dC5LZXkuVGFiIGFuZCBzaGlmdGRvd246DQogICAgICAgICAgICBzZWxmLl9yZXN1bHRfaW5kZXggLT0gMQ0KICAgICAgICAgICAgc2VsZi51cGRhdGVfcmVzdWx0c19kaXNwbGF5KCkNCiAgICAgICAgZWxpZiBhcmdzLktleSA9PSBJbnB1dC5LZXkuVGFiOg0KICAgICAgICAgICAgc2VsZi5fcmVzdWx0X2luZGV4ICs9IDENCiAgICAgICAgICAgIHNlbGYudXBkYXRlX3Jlc3VsdHNfZGlzcGxheSgpDQogICAgICAgICMgVXAsIERvd246IEN5Y2xlIHRocm91Z2ggbWF0Y2hlcw0KICAgICAgICBlbGlmIGFyZ3MuS2V5ID09IElucHV0LktleS5VcDoNCiAgICAgICAgICAgIHNlbGYuX3Jlc3VsdF9pbmRleCAtPSAxDQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9yZXN1bHRzX2Rpc3BsYXkoKQ0KICAgICAgICBlbGlmIGFyZ3MuS2V5ID09IElucHV0LktleS5Eb3duOg0KICAgICAgICAgICAgc2VsZi5fcmVzdWx0X2luZGV4ICs9IDENCiAgICAgICAgICAgIHNlbGYudXBkYXRlX3Jlc3VsdHNfZGlzcGxheSgpDQogICAgICAgICMgUmlnaHQsIEVuZDogQXV0b2NvbXBsZXRlIHdpdGggZGlzcGxheWVkIG1hdGNoDQogICAgICAgIGVsaWYgYXJncy5LZXkgaW4gW0lucHV0LktleS5SaWdodCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgSW5wdXQuS2V5LkVuZF06DQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9yZXN1bHRzX2Rpc3BsYXkoZmlsbF9tYXRjaD1UcnVlKQ0KDQogICAgQGNsYXNzbWV0aG9kDQogICAgZGVmIHNob3coY2xzLCBzZWFyY2hfZGIsICAgICNweWxpbnQ6IGRpc2FibGU9VzAyMjENCiAgICAgICAgICAgICB3aWR0aD1ERUZBVUxUX1NFQVJDSFdORF9XSURUSCwNCiAgICAgICAgICAgICBoZWlnaHQ9REVGQVVMVF9TRUFSQ0hXTkRfSEVJR0hULCAqKmt3YXJncyk6DQogICAgICAgICIiIlNob3cgc2VhcmNoIHByb21wdC4iIiINCiAgICAgICAgZGxnID0gY2xzKHNlYXJjaF9kYiwgd2lkdGgsIGhlaWdodCwgKiprd2FyZ3MpDQogICAgICAgIGRsZy5TaG93RGlhbG9nKCkNCiAgICAgICAgcmV0dXJuIGRsZy5yZXNwb25zZQ0KDQoNCmNsYXNzIFJldmlzaW9uT3B0aW9uKFRlbXBsYXRlTGlzdEl0ZW0pOg0KICAgICIiIlJldmlzaW9uIHdyYXBwZXIgZm9yIDpmdW5jOmBzZWxlY3RfcmV2aXNpb25zYC4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgcmV2aXNpb25fZWxlbWVudCk6DQogICAgICAgIHN1cGVyKFJldmlzaW9uT3B0aW9uLCBzZWxmKS5fX2luaXRfXyhyZXZpc2lvbl9lbGVtZW50KQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIG5hbWUoc2VsZik6DQogICAgICAgICIiIlJldmlzaW9uIG5hbWUgKGRlc2NyaXB0aW9uKS4iIiINCiAgICAgICAgcmV2bnVtID0gc2VsZi5pdGVtLlNlcXVlbmNlTnVtYmVyDQogICAgICAgIHJldl9zZXR0aW5ncyA9IFwNCiAgICAgICAgICAgIERCLlJldmlzaW9uU2V0dGluZ3MuR2V0UmV2aXNpb25TZXR0aW5ncyhzZWxmLml0ZW0uRG9jdW1lbnQpDQoNCiAgICAgICAgaWYgcmV2X3NldHRpbmdzLlJldmlzaW9uTnVtYmVyaW5nID09IERCLlJldmlzaW9uTnVtYmVyaW5nLlBlclByb2plY3Q6DQogICAgICAgICAgICByZXZudW0gPSBzZWxmLml0ZW0uUmV2aXNpb25OdW1iZXINCiAgICAgICAgcmV0dXJuICd7fS17fS17fScuZm9ybWF0KHJldm51bSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaXRlbS5EZXNjcmlwdGlvbiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaXRlbS5SZXZpc2lvbkRhdGUpDQoNCg0KY2xhc3MgU2hlZXRPcHRpb24oVGVtcGxhdGVMaXN0SXRlbSk6DQogICAgIiIiU2hlZXQgd3JhcHBlciBmb3IgOmZ1bmM6YHNlbGVjdF9zaGVldHNgLiIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzaGVldF9lbGVtZW50KToNCiAgICAgICAgc3VwZXIoU2hlZXRPcHRpb24sIHNlbGYpLl9faW5pdF9fKHNoZWV0X2VsZW1lbnQpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgbmFtZShzZWxmKToNCiAgICAgICAgIiIiU2hlZXQgbmFtZS4iIiINCiAgICAgICAgcmV0dXJuICd7fSAtIHt9e30nIFwNCiAgICAgICAgICAgIC5mb3JtYXQoc2VsZi5pdGVtLlNoZWV0TnVtYmVyLA0KICAgICAgICAgICAgICAgICAgICBzZWxmLml0ZW0uTmFtZSwNCiAgICAgICAgICAgICAgICAgICAgJyAocGxhY2Vob2xkZXIpJyBpZiBzZWxmLml0ZW0uSXNQbGFjZWhvbGRlciBlbHNlICcnKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIG51bWJlcihzZWxmKToNCiAgICAgICAgIiIiU2hlZXQgbnVtYmVyLiIiIg0KICAgICAgICByZXR1cm4gc2VsZi5pdGVtLlNoZWV0TnVtYmVyDQoNCg0KY2xhc3MgVmlld09wdGlvbihUZW1wbGF0ZUxpc3RJdGVtKToNCiAgICAiIiJWaWV3IHdyYXBwZXIgZm9yIDpmdW5jOmBzZWxlY3Rfdmlld3NgLiIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCB2aWV3X2VsZW1lbnQpOg0KICAgICAgICBzdXBlcihWaWV3T3B0aW9uLCBzZWxmKS5fX2luaXRfXyh2aWV3X2VsZW1lbnQpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgbmFtZShzZWxmKToNCiAgICAgICAgIiIiVmlldyBuYW1lLiIiIg0KICAgICAgICByZXR1cm4gJ3t9ICh7fSknLmZvcm1hdChyZXZpdC5xdWVyeS5nZXRfbmFtZShzZWxmLml0ZW0pLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLml0ZW0uVmlld1R5cGUpDQoNCg0KY2xhc3MgTGV2ZWxPcHRpb24oVGVtcGxhdGVMaXN0SXRlbSk6DQogICAgIiIiTGV2ZWwgd3JhcHBlciBmb3IgOmZ1bmM6YHNlbGVjdF9sZXZlbHNgLiIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBsZXZlbF9lbGVtZW50KToNCiAgICAgICAgc3VwZXIoTGV2ZWxPcHRpb24sIHNlbGYpLl9faW5pdF9fKGxldmVsX2VsZW1lbnQpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgbmFtZShzZWxmKToNCiAgICAgICAgIiIiTGV2ZWwgbmFtZS4iIiINCiAgICAgICAgcmV0dXJuIHJldml0LnF1ZXJ5LmdldF9uYW1lKHNlbGYuaXRlbSkNCg0KDQpjbGFzcyBGYW1pbHlQYXJhbU9wdGlvbihUZW1wbGF0ZUxpc3RJdGVtKToNCiAgICAiIiJMZXZlbCB3cmFwcGVyIGZvciA6ZnVuYzpgc2VsZWN0X2ZhbWlseV9wYXJhbWV0ZXJzYC4iIiINCiAgICBkZWYgX19pbml0X18oc2VsZiwgZnBhcmFtLCBidWlsdGluPUZhbHNlLCBsYWJlbGVkPUZhbHNlKToNCiAgICAgICAgc3VwZXIoRmFtaWx5UGFyYW1PcHRpb24sIHNlbGYpLl9faW5pdF9fKGZwYXJhbSkNCiAgICAgICAgc2VsZi5pc2J1aWx0aW4gPSBidWlsdGluDQogICAgICAgIHNlbGYuaXNsYWJlbGVkID0gbGFiZWxlZA0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIG5hbWUoc2VsZik6DQogICAgICAgICIiIkZhbWlseSBQYXJhbWV0ZXIgbmFtZS4iIiINCiAgICAgICAgcmV0dXJuIHNlbGYuaXRlbS5EZWZpbml0aW9uLk5hbWUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBpc3R5cGUoc2VsZik6DQogICAgICAgICIiIklzIHR5cGUgcGFyYW1ldGVyLiIiIg0KICAgICAgICByZXR1cm4gbm90IHNlbGYuaXRlbS5Jc0luc3RhbmNlDQoNCg0KZGVmIHNlbGVjdF9yZXZpc2lvbnModGl0bGU9J1NlbGVjdCBSZXZpc2lvbicsDQogICAgICAgICAgICAgICAgICAgICBidXR0b25fbmFtZT0nU2VsZWN0JywNCiAgICAgICAgICAgICAgICAgICAgIHdpZHRoPURFRkFVTFRfSU5QVVRXSU5ET1dfV0lEVEgsDQogICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZT1UcnVlLA0KICAgICAgICAgICAgICAgICAgICAgZmlsdGVyZnVuYz1Ob25lLA0KICAgICAgICAgICAgICAgICAgICAgZG9jPU5vbmUpOg0KICAgICIiIlN0YW5kYXJkIGZvcm0gZm9yIHNlbGVjdGluZyByZXZpc2lvbnMuDQoNCiAgICBBcmdzOg0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IGxpc3Qgd2luZG93IHRpdGxlDQogICAgICAgIGJ1dHRvbl9uYW1lIChzdHIsIG9wdGlvbmFsKTogbGlzdCB3aW5kb3cgYnV0dG9uIGNhcHRpb24NCiAgICAgICAgd2lkdGggKGludCwgb3B0aW9uYWwpOiB3aWR0aCBvZiBsaXN0IHdpbmRvdw0KICAgICAgICBtdWx0aXBsZSAoYm9vbCwgb3B0aW9uYWwpOg0KICAgICAgICAgICAgYWxsb3cgbXVsdGktc2VsZWN0aW9uICh1c2VzIGNoZWNrIGJveGVzKS4gZGVmYXVsdHMgdG8gVHJ1ZQ0KICAgICAgICBmaWx0ZXJmdW5jIChmdW5jdGlvbik6DQogICAgICAgICAgICBmaWx0ZXIgZnVuY3Rpb24gdG8gYmUgYXBwbGllZCB0byBjb250ZXh0IGl0ZW1zLg0KICAgICAgICBkb2MgKERCLkRvY3VtZW50LCBvcHRpb25hbCk6DQogICAgICAgICAgICBzb3VyY2UgZG9jdW1lbnQgZm9yIHJldmlzaW9uczsgZGVmYXVsdHMgdG8gYWN0aXZlIGRvY3VtZW50DQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtEQi5SZXZpc2lvbl0pOiBsaXN0IG9mIHNlbGVjdGVkIHJldmlzaW9ucw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLnNlbGVjdF9yZXZpc2lvbnMoKQ0KICAgICAgICBbPEF1dG9kZXNrLlJldml0LkRCLlJldmlzaW9uIG9iamVjdD4sDQogICAgICAgICA8QXV0b2Rlc2suUmV2aXQuREIuUmV2aXNpb24gb2JqZWN0Pl0NCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgZG9jID0gZG9jIG9yIERPQ1MuZG9jDQogICAgcmV2aXNpb25zID0gc29ydGVkKHJldml0LnF1ZXJ5LmdldF9yZXZpc2lvbnMoZG9jPWRvYyksDQogICAgICAgICAgICAgICAgICAgICAgIGtleT1sYW1iZGEgeDogeC5TZXF1ZW5jZU51bWJlcikNCg0KICAgIGlmIGZpbHRlcmZ1bmM6DQogICAgICAgIHJldmlzaW9ucyA9IGZpbHRlcihmaWx0ZXJmdW5jLCByZXZpc2lvbnMpDQoNCiAgICAjIGFzayB1c2VyIGZvciByZXZpc2lvbnMNCiAgICBzZWxlY3RlZF9yZXZzID0gU2VsZWN0RnJvbUxpc3Quc2hvdygNCiAgICAgICAgW1JldmlzaW9uT3B0aW9uKHgpIGZvciB4IGluIHJldmlzaW9uc10sDQogICAgICAgIHRpdGxlPXRpdGxlLA0KICAgICAgICBidXR0b25fbmFtZT1idXR0b25fbmFtZSwNCiAgICAgICAgd2lkdGg9d2lkdGgsDQogICAgICAgIG11bHRpc2VsZWN0PW11bHRpcGxlLA0KICAgICAgICBjaGVja2VkX29ubHk9VHJ1ZQ0KICAgICAgICApDQoNCiAgICByZXR1cm4gc2VsZWN0ZWRfcmV2cw0KDQoNCmRlZiBzZWxlY3Rfc2hlZXRzKHRpdGxlPSdTZWxlY3QgU2hlZXRzJywNCiAgICAgICAgICAgICAgICAgIGJ1dHRvbl9uYW1lPSdTZWxlY3QnLA0KICAgICAgICAgICAgICAgICAgd2lkdGg9REVGQVVMVF9JTlBVVFdJTkRPV19XSURUSCwNCiAgICAgICAgICAgICAgICAgIG11bHRpcGxlPVRydWUsDQogICAgICAgICAgICAgICAgICBmaWx0ZXJmdW5jPU5vbmUsDQogICAgICAgICAgICAgICAgICBkb2M9Tm9uZSwNCiAgICAgICAgICAgICAgICAgIGluY2x1ZGVfcGxhY2Vob2xkZXI9VHJ1ZSwNCiAgICAgICAgICAgICAgICAgIHVzZV9zZWxlY3Rpb249RmFsc2UpOg0KICAgICIiIlN0YW5kYXJkIGZvcm0gZm9yIHNlbGVjdGluZyBzaGVldHMuDQoNCiAgICBTaGVldHMgYXJlIGdyb3VwZWQgaW50byBzaGVldCBzZXRzIGFuZCBzaGVldCBzZXQgY2FuIGJlIHNlbGVjdGVkIGZyb20NCiAgICBhIGRyb3AgZG93biBib3ggYXQgdGhlIHRvcCBvZiB3aW5kb3cuDQoNCiAgICBBcmdzOg0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IGxpc3Qgd2luZG93IHRpdGxlDQogICAgICAgIGJ1dHRvbl9uYW1lIChzdHIsIG9wdGlvbmFsKTogbGlzdCB3aW5kb3cgYnV0dG9uIGNhcHRpb24NCiAgICAgICAgd2lkdGggKGludCwgb3B0aW9uYWwpOiB3aWR0aCBvZiBsaXN0IHdpbmRvdw0KICAgICAgICBtdWx0aXBsZSAoYm9vbCwgb3B0aW9uYWwpOg0KICAgICAgICAgICAgYWxsb3cgbXVsdGktc2VsZWN0aW9uICh1c2VzIGNoZWNrIGJveGVzKS4gZGVmYXVsdHMgdG8gVHJ1ZQ0KICAgICAgICBmaWx0ZXJmdW5jIChmdW5jdGlvbik6DQogICAgICAgICAgICBmaWx0ZXIgZnVuY3Rpb24gdG8gYmUgYXBwbGllZCB0byBjb250ZXh0IGl0ZW1zLg0KICAgICAgICBkb2MgKERCLkRvY3VtZW50LCBvcHRpb25hbCk6DQogICAgICAgICAgICBzb3VyY2UgZG9jdW1lbnQgZm9yIHNoZWV0czsgZGVmYXVsdHMgdG8gYWN0aXZlIGRvY3VtZW50DQogICAgICAgIGluY2x1ZGVfcGxhY2Vob2xkZXIgKGJvb2wsIG9wdGlvbmFsKTogaW5jbHVkZSBhIHBsYWNlaG9sZGVyLg0KICAgICAgICAgICAgRGVmYXVsdHMgdG8gVHJ1ZQ0KICAgICAgICB1c2Vfc2VsZWN0aW9uIChib29sLCBvcHRpb25hbCk6DQogICAgICAgICAgICBhc2sgaWYgdXNlciB3YW50cyB0byB1c2UgY3VycmVudGx5IHNlbGVjdGVkIHNoZWV0cy4NCg0KICAgIFJldHVybnM6DQogICAgICAgIChsaXN0W0RCLlZpZXdTaGVldF0pOiBsaXN0IG9mIHNlbGVjdGVkIHNoZWV0cw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLnNlbGVjdF9zaGVldHMoKQ0KICAgICAgICBbPEF1dG9kZXNrLlJldml0LkRCLlZpZXdTaGVldCBvYmplY3Q+LA0KICAgICAgICAgPEF1dG9kZXNrLlJldml0LkRCLlZpZXdTaGVldCBvYmplY3Q+XQ0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBkb2MgPSBkb2Mgb3IgRE9DUy5kb2MNCg0KICAgICMgY2hlY2sgZm9yIHByZXZpb3VzbHkgc2VsZWN0ZWQgc2hlZXRzDQogICAgaWYgdXNlX3NlbGVjdGlvbjoNCiAgICAgICAgY3VycmVudF9zZWxlY3RlZF9zaGVldHMgPSByZXZpdC5nZXRfc2VsZWN0aW9uKCkgXA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmluY2x1ZGUoREIuVmlld1NoZWV0KSBcDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZWxlbWVudHMNCiAgICAgICAgaWYgZmlsdGVyZnVuYzoNCiAgICAgICAgICAgIGN1cnJlbnRfc2VsZWN0ZWRfc2hlZXRzID0gXA0KICAgICAgICAgICAgICAgIGZpbHRlcihmaWx0ZXJmdW5jLCBjdXJyZW50X3NlbGVjdGVkX3NoZWV0cykNCg0KICAgICAgICBpZiBub3QgaW5jbHVkZV9wbGFjZWhvbGRlcjoNCiAgICAgICAgICAgIGN1cnJlbnRfc2VsZWN0ZWRfc2hlZXRzID0gXA0KICAgICAgICAgICAgICAgIFt4IGZvciB4IGluIGN1cnJlbnRfc2VsZWN0ZWRfc2hlZXRzIGlmIG5vdCB4LklzUGxhY2Vob2xkZXJdDQoNCiAgICAgICAgaWYgY3VycmVudF9zZWxlY3RlZF9zaGVldHMgXA0KICAgICAgICAgICAgICAgIGFuZCBhc2tfdG9fdXNlX3NlbGVjdGVkKCJzaGVldHMiLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50PWxlbihjdXJyZW50X3NlbGVjdGVkX3NoZWV0cyksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGU9bXVsdGlwbGUpOg0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRfc2VsZWN0ZWRfc2hlZXRzIFwNCiAgICAgICAgICAgICAgICBpZiBtdWx0aXBsZSBlbHNlIGN1cnJlbnRfc2VsZWN0ZWRfc2hlZXRzWzBdDQoNCiAgICAjIG90aGVyd2lzZSBnZXQgYWxsIHNoZWV0cyBhbmQgcHJvbXB0IGZvciBzZWxlY3Rpb24NCiAgICBhbGxfb3BzID0ge30NCiAgICBhbGxfc2hlZXRzID0gREIuRmlsdGVyZWRFbGVtZW50Q29sbGVjdG9yKGRvYykgXA0KICAgICAgICAgICAgICAgICAgIC5PZkNsYXNzKERCLlZpZXdTaGVldCkgXA0KICAgICAgICAgICAgICAgICAgIC5XaGVyZUVsZW1lbnRJc05vdEVsZW1lbnRUeXBlKCkgXA0KICAgICAgICAgICAgICAgICAgIC5Ub0VsZW1lbnRzKCkNCg0KICAgIGlmIGZpbHRlcmZ1bmM6DQogICAgICAgIGFsbF9zaGVldHMgPSBmaWx0ZXIoZmlsdGVyZnVuYywgYWxsX3NoZWV0cykNCg0KICAgIGlmIG5vdCBpbmNsdWRlX3BsYWNlaG9sZGVyOg0KICAgICAgICBhbGxfc2hlZXRzID0gW3ggZm9yIHggaW4gYWxsX3NoZWV0cyBpZiBub3QgeC5Jc1BsYWNlaG9sZGVyXQ0KDQogICAgYWxsX3NoZWV0c19vcHMgPSBzb3J0ZWQoW1NoZWV0T3B0aW9uKHgpIGZvciB4IGluIGFsbF9zaGVldHNdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT1sYW1iZGEgeDogeC5udW1iZXIpDQogICAgYWxsX29wc1snQWxsIFNoZWV0cyddID0gYWxsX3NoZWV0c19vcHMNCg0KICAgIHNoZWV0c2V0cyA9IHJldml0LnF1ZXJ5LmdldF9zaGVldF9zZXRzKGRvYykNCiAgICBmb3Igc2hlZXRzZXQgaW4gc2hlZXRzZXRzOg0KICAgICAgICBzaGVldHNldF9zaGVldHMgPSBcDQogICAgICAgICAgICBbeCBmb3IgeCBpbiBzaGVldHNldC5WaWV3cyBpZiBpc2luc3RhbmNlKHgsIERCLlZpZXdTaGVldCldDQogICAgICAgIGlmIGZpbHRlcmZ1bmM6DQogICAgICAgICAgICBzaGVldHNldF9zaGVldHMgPSBmaWx0ZXIoZmlsdGVyZnVuYywgc2hlZXRzZXRfc2hlZXRzKQ0KICAgICAgICBzaGVldHNldF9vcHMgPSBzb3J0ZWQoW1NoZWV0T3B0aW9uKHgpIGZvciB4IGluIHNoZWV0c2V0X3NoZWV0c10sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9bGFtYmRhIHg6IHgubnVtYmVyKQ0KICAgICAgICBhbGxfb3BzW3NoZWV0c2V0Lk5hbWVdID0gc2hlZXRzZXRfb3BzDQoNCiAgICAjIGFzayB1c2VyIGZvciBtdWx0aXBsZSBzaGVldHMNCiAgICBzZWxlY3RlZF9zaGVldHMgPSBTZWxlY3RGcm9tTGlzdC5zaG93KA0KICAgICAgICBhbGxfb3BzLA0KICAgICAgICB0aXRsZT10aXRsZSwNCiAgICAgICAgZ3JvdXBfc2VsZWN0b3JfdGl0bGU9J1NoZWV0IFNldHM6JywNCiAgICAgICAgYnV0dG9uX25hbWU9YnV0dG9uX25hbWUsDQogICAgICAgIHdpZHRoPXdpZHRoLA0KICAgICAgICBtdWx0aXNlbGVjdD1tdWx0aXBsZSwNCiAgICAgICAgY2hlY2tlZF9vbmx5PVRydWUsDQogICAgICAgIGRlZmF1bHRfZ3JvdXA9J0FsbCBTaGVldHMnDQogICAgICAgICkNCg0KICAgIHJldHVybiBzZWxlY3RlZF9zaGVldHMNCg0KDQpkZWYgc2VsZWN0X3ZpZXdzKHRpdGxlPSdTZWxlY3QgVmlld3MnLA0KICAgICAgICAgICAgICAgICBidXR0b25fbmFtZT0nU2VsZWN0JywNCiAgICAgICAgICAgICAgICAgd2lkdGg9REVGQVVMVF9JTlBVVFdJTkRPV19XSURUSCwNCiAgICAgICAgICAgICAgICAgbXVsdGlwbGU9VHJ1ZSwNCiAgICAgICAgICAgICAgICAgZmlsdGVyZnVuYz1Ob25lLA0KICAgICAgICAgICAgICAgICBkb2M9Tm9uZSwNCiAgICAgICAgICAgICAgICAgdXNlX3NlbGVjdGlvbj1GYWxzZSk6DQogICAgIiIiU3RhbmRhcmQgZm9ybSBmb3Igc2VsZWN0aW5nIHZpZXdzLg0KDQogICAgQXJnczoNCiAgICAgICAgdGl0bGUgKHN0ciwgb3B0aW9uYWwpOiBsaXN0IHdpbmRvdyB0aXRsZQ0KICAgICAgICBidXR0b25fbmFtZSAoc3RyLCBvcHRpb25hbCk6IGxpc3Qgd2luZG93IGJ1dHRvbiBjYXB0aW9uDQogICAgICAgIHdpZHRoIChpbnQsIG9wdGlvbmFsKTogd2lkdGggb2YgbGlzdCB3aW5kb3cNCiAgICAgICAgbXVsdGlwbGUgKGJvb2wsIG9wdGlvbmFsKToNCiAgICAgICAgICAgIGFsbG93IG11bHRpLXNlbGVjdGlvbiAodXNlcyBjaGVjayBib3hlcykuIGRlZmF1bHRzIHRvIFRydWUNCiAgICAgICAgZmlsdGVyZnVuYyAoZnVuY3Rpb24pOg0KICAgICAgICAgICAgZmlsdGVyIGZ1bmN0aW9uIHRvIGJlIGFwcGxpZWQgdG8gY29udGV4dCBpdGVtcy4NCiAgICAgICAgZG9jIChEQi5Eb2N1bWVudCwgb3B0aW9uYWwpOg0KICAgICAgICAgICAgc291cmNlIGRvY3VtZW50IGZvciB2aWV3czsgZGVmYXVsdHMgdG8gYWN0aXZlIGRvY3VtZW50DQogICAgICAgIHVzZV9zZWxlY3Rpb24gKGJvb2wsIG9wdGlvbmFsKToNCiAgICAgICAgICAgIGFzayBpZiB1c2VyIHdhbnRzIHRvIHVzZSBjdXJyZW50bHkgc2VsZWN0ZWQgdmlld3MuDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtEQi5WaWV3XSk6IGxpc3Qgb2Ygc2VsZWN0ZWQgdmlld3MNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBmb3Jtcy5zZWxlY3Rfdmlld3MoKQ0KICAgICAgICBbPEF1dG9kZXNrLlJldml0LkRCLlZpZXcgb2JqZWN0PiwNCiAgICAgICAgIDxBdXRvZGVzay5SZXZpdC5EQi5WaWV3IG9iamVjdD5dDQogICAgICAgIGBgYA0KICAgICIiIg0KICAgIGRvYyA9IGRvYyBvciBET0NTLmRvYw0KDQogICAgIyBjaGVjayBmb3IgcHJldmlvdXNseSBzZWxlY3RlZCBzaGVldHMNCiAgICBpZiB1c2Vfc2VsZWN0aW9uOg0KICAgICAgICBjdXJyZW50X3NlbGVjdGVkX3ZpZXdzID0gcmV2aXQuZ2V0X3NlbGVjdGlvbigpIFwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmluY2x1ZGUoREIuVmlldykgXA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZWxlbWVudHMNCiAgICAgICAgaWYgZmlsdGVyZnVuYzoNCiAgICAgICAgICAgIGN1cnJlbnRfc2VsZWN0ZWRfdmlld3MgPSBcDQogICAgICAgICAgICAgICAgZmlsdGVyKGZpbHRlcmZ1bmMsIGN1cnJlbnRfc2VsZWN0ZWRfdmlld3MpDQoNCiAgICAgICAgaWYgY3VycmVudF9zZWxlY3RlZF92aWV3cyBcDQogICAgICAgICAgICAgICAgYW5kIGFza190b191c2Vfc2VsZWN0ZWQoInZpZXdzIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudD1sZW4oY3VycmVudF9zZWxlY3RlZF92aWV3cyksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGU9bXVsdGlwbGUpOg0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRfc2VsZWN0ZWRfdmlld3MgXA0KICAgICAgICAgICAgICAgIGlmIG11bHRpcGxlIGVsc2UgY3VycmVudF9zZWxlY3RlZF92aWV3c1swXQ0KDQogICAgIyBvdGhlcndpc2UgZ2V0IGFsbCBzaGVldHMgYW5kIHByb21wdCBmb3Igc2VsZWN0aW9uDQogICAgYWxsX2dyYXBodmlld3MgPSByZXZpdC5xdWVyeS5nZXRfYWxsX3ZpZXdzKGRvYz1kb2MpDQoNCiAgICBpZiBmaWx0ZXJmdW5jOg0KICAgICAgICBhbGxfZ3JhcGh2aWV3cyA9IGZpbHRlcihmaWx0ZXJmdW5jLCBhbGxfZ3JhcGh2aWV3cykNCg0KICAgIHNlbGVjdGVkX3ZpZXdzID0gU2VsZWN0RnJvbUxpc3Quc2hvdygNCiAgICAgICAgc29ydGVkKFtWaWV3T3B0aW9uKHgpIGZvciB4IGluIGFsbF9ncmFwaHZpZXdzXSwNCiAgICAgICAgICAgICAgIGtleT1sYW1iZGEgeDogeC5uYW1lKSwNCiAgICAgICAgdGl0bGU9dGl0bGUsDQogICAgICAgIGJ1dHRvbl9uYW1lPWJ1dHRvbl9uYW1lLA0KICAgICAgICB3aWR0aD13aWR0aCwNCiAgICAgICAgbXVsdGlzZWxlY3Q9bXVsdGlwbGUsDQogICAgICAgIGNoZWNrZWRfb25seT1UcnVlDQogICAgICAgICkNCg0KICAgIHJldHVybiBzZWxlY3RlZF92aWV3cw0KDQoNCmRlZiBzZWxlY3RfbGV2ZWxzKHRpdGxlPSdTZWxlY3QgTGV2ZWxzJywNCiAgICAgICAgICAgICAgICAgIGJ1dHRvbl9uYW1lPSdTZWxlY3QnLA0KICAgICAgICAgICAgICAgICAgd2lkdGg9REVGQVVMVF9JTlBVVFdJTkRPV19XSURUSCwNCiAgICAgICAgICAgICAgICAgIG11bHRpcGxlPVRydWUsDQogICAgICAgICAgICAgICAgICBmaWx0ZXJmdW5jPU5vbmUsDQogICAgICAgICAgICAgICAgICBkb2M9Tm9uZSwNCiAgICAgICAgICAgICAgICAgIHVzZV9zZWxlY3Rpb249RmFsc2UpOg0KICAgICIiIlN0YW5kYXJkIGZvcm0gZm9yIHNlbGVjdGluZyBsZXZlbHMuDQoNCiAgICBBcmdzOg0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IGxpc3Qgd2luZG93IHRpdGxlDQogICAgICAgIGJ1dHRvbl9uYW1lIChzdHIsIG9wdGlvbmFsKTogbGlzdCB3aW5kb3cgYnV0dG9uIGNhcHRpb24NCiAgICAgICAgd2lkdGggKGludCwgb3B0aW9uYWwpOiB3aWR0aCBvZiBsaXN0IHdpbmRvdw0KICAgICAgICBtdWx0aXBsZSAoYm9vbCwgb3B0aW9uYWwpOg0KICAgICAgICAgICAgYWxsb3cgbXVsdGktc2VsZWN0aW9uICh1c2VzIGNoZWNrIGJveGVzKS4gZGVmYXVsdHMgdG8gVHJ1ZQ0KICAgICAgICBmaWx0ZXJmdW5jIChmdW5jdGlvbik6DQogICAgICAgICAgICBmaWx0ZXIgZnVuY3Rpb24gdG8gYmUgYXBwbGllZCB0byBjb250ZXh0IGl0ZW1zLg0KICAgICAgICBkb2MgKERCLkRvY3VtZW50LCBvcHRpb25hbCk6DQogICAgICAgICAgICBzb3VyY2UgZG9jdW1lbnQgZm9yIGxldmVsczsgZGVmYXVsdHMgdG8gYWN0aXZlIGRvY3VtZW50DQogICAgICAgIHVzZV9zZWxlY3Rpb24gKGJvb2wsIG9wdGlvbmFsKToNCiAgICAgICAgICAgIGFzayBpZiB1c2VyIHdhbnRzIHRvIHVzZSBjdXJyZW50bHkgc2VsZWN0ZWQgbGV2ZWxzLg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGxpc3RbREIuTGV2ZWxdKTogbGlzdCBvZiBzZWxlY3RlZCBsZXZlbHMNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBmb3Jtcy5zZWxlY3RfbGV2ZWxzKCkNCiAgICAgICAgWzxBdXRvZGVzay5SZXZpdC5EQi5MZXZlbCBvYmplY3Q+LA0KICAgICAgICAgPEF1dG9kZXNrLlJldml0LkRCLkxldmVsIG9iamVjdD5dDQogICAgICAgIGBgYA0KICAgICIiIg0KICAgIGRvYyA9IGRvYyBvciBET0NTLmRvYw0KDQogICAgIyBjaGVjayBmb3IgcHJldmlvdXNseSBzZWxlY3RlZCBzaGVldHMNCiAgICBpZiB1c2Vfc2VsZWN0aW9uOg0KICAgICAgICBjdXJyZW50X3NlbGVjdGVkX2xldmVscyA9IHJldml0LmdldF9zZWxlY3Rpb24oKSBcDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuaW5jbHVkZShEQi5MZXZlbCkgXA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmVsZW1lbnRzDQoNCiAgICAgICAgaWYgZmlsdGVyZnVuYzoNCiAgICAgICAgICAgIGN1cnJlbnRfc2VsZWN0ZWRfbGV2ZWxzID0gXA0KICAgICAgICAgICAgICAgIGZpbHRlcihmaWx0ZXJmdW5jLCBjdXJyZW50X3NlbGVjdGVkX2xldmVscykNCg0KICAgICAgICBpZiBjdXJyZW50X3NlbGVjdGVkX2xldmVscyBcDQogICAgICAgICAgICAgICAgYW5kIGFza190b191c2Vfc2VsZWN0ZWQoImxldmVscyIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ9bGVuKGN1cnJlbnRfc2VsZWN0ZWRfbGV2ZWxzKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZT1tdWx0aXBsZSk6DQogICAgICAgICAgICByZXR1cm4gY3VycmVudF9zZWxlY3RlZF9sZXZlbHMgXA0KICAgICAgICAgICAgICAgIGlmIG11bHRpcGxlIGVsc2UgY3VycmVudF9zZWxlY3RlZF9sZXZlbHNbMF0NCg0KICAgIGFsbF9sZXZlbHMgPSBcDQogICAgICAgIHJldml0LnF1ZXJ5LmdldF9lbGVtZW50c19ieV9jYXRlZ29yaWVzKA0KICAgICAgICAgICAgW0RCLkJ1aWx0SW5DYXRlZ29yeS5PU1RfTGV2ZWxzXSwNCiAgICAgICAgICAgIGRvYz1kb2MNCiAgICAgICAgICAgICkNCg0KICAgIGlmIGZpbHRlcmZ1bmM6DQogICAgICAgIGFsbF9sZXZlbHMgPSBmaWx0ZXIoZmlsdGVyZnVuYywgYWxsX2xldmVscykNCg0KICAgIHNlbGVjdGVkX2xldmVscyA9IFNlbGVjdEZyb21MaXN0LnNob3coDQogICAgICAgIHNvcnRlZChbTGV2ZWxPcHRpb24oeCkgZm9yIHggaW4gYWxsX2xldmVsc10sDQogICAgICAgICAgICAgICBrZXk9bGFtYmRhIHg6IHguRWxldmF0aW9uKSwNCiAgICAgICAgdGl0bGU9dGl0bGUsDQogICAgICAgIGJ1dHRvbl9uYW1lPWJ1dHRvbl9uYW1lLA0KICAgICAgICB3aWR0aD13aWR0aCwNCiAgICAgICAgbXVsdGlzZWxlY3Q9bXVsdGlwbGUsDQogICAgICAgIGNoZWNrZWRfb25seT1UcnVlLA0KICAgICAgICApDQogICAgcmV0dXJuIHNlbGVjdGVkX2xldmVscw0KDQoNCmRlZiBzZWxlY3Rfdmlld3RlbXBsYXRlcyh0aXRsZT0nU2VsZWN0IFZpZXcgVGVtcGxhdGVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fbmFtZT0nU2VsZWN0JywNCiAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aD1ERUZBVUxUX0lOUFVUV0lORE9XX1dJRFRILA0KICAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpcGxlPVRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyZnVuYz1Ob25lLA0KICAgICAgICAgICAgICAgICAgICAgICAgIGRvYz1Ob25lKToNCiAgICAiIiJTdGFuZGFyZCBmb3JtIGZvciBzZWxlY3RpbmcgdmlldyB0ZW1wbGF0ZXMuDQoNCiAgICBBcmdzOg0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IGxpc3Qgd2luZG93IHRpdGxlDQogICAgICAgIGJ1dHRvbl9uYW1lIChzdHIsIG9wdGlvbmFsKTogbGlzdCB3aW5kb3cgYnV0dG9uIGNhcHRpb24NCiAgICAgICAgd2lkdGggKGludCwgb3B0aW9uYWwpOiB3aWR0aCBvZiBsaXN0IHdpbmRvdw0KICAgICAgICBtdWx0aXBsZSAoYm9vbCwgb3B0aW9uYWwpOg0KICAgICAgICAgICAgYWxsb3cgbXVsdGktc2VsZWN0aW9uICh1c2VzIGNoZWNrIGJveGVzKS4gZGVmYXVsdHMgdG8gVHJ1ZQ0KICAgICAgICBmaWx0ZXJmdW5jIChmdW5jdGlvbik6DQogICAgICAgICAgICBmaWx0ZXIgZnVuY3Rpb24gdG8gYmUgYXBwbGllZCB0byBjb250ZXh0IGl0ZW1zLg0KICAgICAgICBkb2MgKERCLkRvY3VtZW50LCBvcHRpb25hbCk6DQogICAgICAgICAgICBzb3VyY2UgZG9jdW1lbnQgZm9yIHZpZXdzOyBkZWZhdWx0cyB0byBhY3RpdmUgZG9jdW1lbnQNCg0KICAgIFJldHVybnM6DQogICAgICAgIChsaXN0W0RCLlZpZXddKTogbGlzdCBvZiBzZWxlY3RlZCB2aWV3IHRlbXBsYXRlcw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLnNlbGVjdF92aWV3dGVtcGxhdGVzKCkNCiAgICAgICAgWzxBdXRvZGVzay5SZXZpdC5EQi5WaWV3IG9iamVjdD4sDQogICAgICAgICA8QXV0b2Rlc2suUmV2aXQuREIuVmlldyBvYmplY3Q+XQ0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBkb2MgPSBkb2Mgb3IgRE9DUy5kb2MNCiAgICBhbGxfdmlld3RlbXBsYXRlcyA9IHJldml0LnF1ZXJ5LmdldF9hbGxfdmlld190ZW1wbGF0ZXMoZG9jPWRvYykNCg0KICAgIGlmIGZpbHRlcmZ1bmM6DQogICAgICAgIGFsbF92aWV3dGVtcGxhdGVzID0gZmlsdGVyKGZpbHRlcmZ1bmMsIGFsbF92aWV3dGVtcGxhdGVzKQ0KDQogICAgc2VsZWN0ZWRfdmlld3RlbXBsYXRlcyA9IFNlbGVjdEZyb21MaXN0LnNob3coDQogICAgICAgIHNvcnRlZChbVmlld09wdGlvbih4KSBmb3IgeCBpbiBhbGxfdmlld3RlbXBsYXRlc10sDQogICAgICAgICAgICAgICBrZXk9bGFtYmRhIHg6IHgubmFtZSksDQogICAgICAgIHRpdGxlPXRpdGxlLA0KICAgICAgICBidXR0b25fbmFtZT1idXR0b25fbmFtZSwNCiAgICAgICAgd2lkdGg9d2lkdGgsDQogICAgICAgIG11bHRpc2VsZWN0PW11bHRpcGxlLA0KICAgICAgICBjaGVja2VkX29ubHk9VHJ1ZQ0KICAgICAgICApDQoNCiAgICByZXR1cm4gc2VsZWN0ZWRfdmlld3RlbXBsYXRlcw0KDQoNCmRlZiBzZWxlY3Rfc2NoZWR1bGVzKHRpdGxlPSdTZWxlY3QgU2NoZWR1bGVzJywNCiAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl9uYW1lPSdTZWxlY3QnLA0KICAgICAgICAgICAgICAgICAgICAgd2lkdGg9REVGQVVMVF9JTlBVVFdJTkRPV19XSURUSCwNCiAgICAgICAgICAgICAgICAgICAgIG11bHRpcGxlPVRydWUsDQogICAgICAgICAgICAgICAgICAgICBmaWx0ZXJmdW5jPU5vbmUsDQogICAgICAgICAgICAgICAgICAgICBkb2M9Tm9uZSk6DQogICAgIiIiU3RhbmRhcmQgZm9ybSBmb3Igc2VsZWN0aW5nIHNjaGVkdWxlcy4NCg0KICAgIEFyZ3M6DQogICAgICAgIHRpdGxlIChzdHIsIG9wdGlvbmFsKTogbGlzdCB3aW5kb3cgdGl0bGUNCiAgICAgICAgYnV0dG9uX25hbWUgKHN0ciwgb3B0aW9uYWwpOiBsaXN0IHdpbmRvdyBidXR0b24gY2FwdGlvbg0KICAgICAgICB3aWR0aCAoaW50LCBvcHRpb25hbCk6IHdpZHRoIG9mIGxpc3Qgd2luZG93DQogICAgICAgIG11bHRpcGxlIChib29sLCBvcHRpb25hbCk6DQogICAgICAgICAgICBhbGxvdyBtdWx0aS1zZWxlY3Rpb24gKHVzZXMgY2hlY2sgYm94ZXMpLiBkZWZhdWx0cyB0byBUcnVlDQogICAgICAgIGZpbHRlcmZ1bmMgKGZ1bmN0aW9uKToNCiAgICAgICAgICAgIGZpbHRlciBmdW5jdGlvbiB0byBiZSBhcHBsaWVkIHRvIGNvbnRleHQgaXRlbXMuDQogICAgICAgIGRvYyAoREIuRG9jdW1lbnQsIG9wdGlvbmFsKToNCiAgICAgICAgICAgIHNvdXJjZSBkb2N1bWVudCBmb3Igdmlld3M7IGRlZmF1bHRzIHRvIGFjdGl2ZSBkb2N1bWVudA0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGxpc3RbREIuVmlld1NjaGVkdWxlXSk6IGxpc3Qgb2Ygc2VsZWN0ZWQgc2NoZWR1bGVzDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZyb20gcHlyZXZpdCBpbXBvcnQgZm9ybXMNCiAgICAgICAgZm9ybXMuc2VsZWN0X3NjaGVkdWxlcygpDQogICAgICAgIFs8QXV0b2Rlc2suUmV2aXQuREIuVmlld1NjaGVkdWxlIG9iamVjdD4sDQogICAgICAgICA8QXV0b2Rlc2suUmV2aXQuREIuVmlld1NjaGVkdWxlIG9iamVjdD5dDQogICAgICAgIGBgYA0KICAgICIiIg0KICAgIGRvYyA9IGRvYyBvciBET0NTLmRvYw0KICAgIGFsbF9zY2hlZHVsZXMgPSByZXZpdC5xdWVyeS5nZXRfYWxsX3NjaGVkdWxlcyhkb2M9ZG9jKQ0KDQogICAgaWYgZmlsdGVyZnVuYzoNCiAgICAgICAgYWxsX3NjaGVkdWxlcyA9IGZpbHRlcihmaWx0ZXJmdW5jLCBhbGxfc2NoZWR1bGVzKQ0KDQogICAgc2VsZWN0ZWRfc2NoZWR1bGVzID0gXA0KICAgICAgICBTZWxlY3RGcm9tTGlzdC5zaG93KA0KICAgICAgICAgICAgc29ydGVkKFtWaWV3T3B0aW9uKHgpIGZvciB4IGluIGFsbF9zY2hlZHVsZXNdLA0KICAgICAgICAgICAgICAgICAgIGtleT1sYW1iZGEgeDogeC5uYW1lKSwNCiAgICAgICAgICAgIHRpdGxlPXRpdGxlLA0KICAgICAgICAgICAgYnV0dG9uX25hbWU9YnV0dG9uX25hbWUsDQogICAgICAgICAgICB3aWR0aD13aWR0aCwNCiAgICAgICAgICAgIG11bHRpc2VsZWN0PW11bHRpcGxlLA0KICAgICAgICAgICAgY2hlY2tlZF9vbmx5PVRydWUNCiAgICAgICAgKQ0KDQogICAgcmV0dXJuIHNlbGVjdGVkX3NjaGVkdWxlcw0KDQoNCmRlZiBzZWxlY3Rfb3Blbl9kb2NzKHRpdGxlPSdTZWxlY3QgT3BlbiBEb2N1bWVudHMnLA0KICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX25hbWU9J09LJywNCiAgICAgICAgICAgICAgICAgICAgIHdpZHRoPURFRkFVTFRfSU5QVVRXSU5ET1dfV0lEVEgsICAgICNweWxpbnQ6IGRpc2FibGU9VzA2MTMNCiAgICAgICAgICAgICAgICAgICAgIG11bHRpcGxlPVRydWUsDQogICAgICAgICAgICAgICAgICAgICBjaGVja19tb3JlX3RoYW5fb25lPVRydWUsDQogICAgICAgICAgICAgICAgICAgICBmaWx0ZXJmdW5jPU5vbmUpOg0KICAgICIiIlN0YW5kYXJkIGZvcm0gZm9yIHNlbGVjdGluZyBvcGVuIGRvY3VtZW50cy4NCg0KICAgIEFyZ3M6DQogICAgICAgIHRpdGxlIChzdHIsIG9wdGlvbmFsKTogbGlzdCB3aW5kb3cgdGl0bGUNCiAgICAgICAgYnV0dG9uX25hbWUgKHN0ciwgb3B0aW9uYWwpOiBsaXN0IHdpbmRvdyBidXR0b24gY2FwdGlvbg0KICAgICAgICB3aWR0aCAoaW50LCBvcHRpb25hbCk6IHdpZHRoIG9mIGxpc3Qgd2luZG93DQogICAgICAgIG11bHRpcGxlIChib29sLCBvcHRpb25hbCk6DQogICAgICAgICAgICBhbGxvdyBtdWx0aS1zZWxlY3Rpb24gKHVzZXMgY2hlY2sgYm94ZXMpLiBkZWZhdWx0cyB0byBUcnVlDQogICAgICAgIGNoZWNrX21vcmVfdGhhbl9vbmUgKGJvb2wsIG9wdGlvbmFsKTogDQogICAgICAgIGZpbHRlcmZ1bmMgKGZ1bmN0aW9uKToNCiAgICAgICAgICAgIGZpbHRlciBmdW5jdGlvbiB0byBiZSBhcHBsaWVkIHRvIGNvbnRleHQgaXRlbXMuDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtEQi5Eb2N1bWVudF0pOiBsaXN0IG9mIHNlbGVjdGVkIGRvY3VtZW50cw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLnNlbGVjdF9vcGVuX2RvY3MoKQ0KICAgICAgICBbPEF1dG9kZXNrLlJldml0LkRCLkRvY3VtZW50IG9iamVjdD4sDQogICAgICAgICA8QXV0b2Rlc2suUmV2aXQuREIuRG9jdW1lbnQgb2JqZWN0Pl0NCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgIyBmaW5kIG9wZW4gZG9jdW1lbnRzIG90aGVyIHRoYW4gdGhlIGFjdGl2ZSBkb2MNCiAgICBvcGVuX2RvY3MgPSBbZCBmb3IgZCBpbiByZXZpdC5kb2NzIGlmIG5vdCBkLklzTGlua2VkXSAgICAjcHlsaW50OiBkaXNhYmxlPUUxMTAxDQogICAgaWYgY2hlY2tfbW9yZV90aGFuX29uZToNCiAgICAgICAgb3Blbl9kb2NzLnJlbW92ZShyZXZpdC5kb2MpICAgICNweWxpbnQ6IGRpc2FibGU9RTExMDENCg0KICAgIGlmIG5vdCBvcGVuX2RvY3M6DQogICAgICAgIGFsZXJ0KCdPbmx5IG9uZSBhY3RpdmUgZG9jdW1lbnQgaXMgZm91bmQuICcNCiAgICAgICAgICAgICAgJ0F0IGxlYXN0IHR3byBkb2N1bWVudHMgbXVzdCBiZSBvcGVuLiAnDQogICAgICAgICAgICAgICdPcGVyYXRpb24gY2FuY2VsbGVkLicpDQogICAgICAgIHJldHVybg0KDQogICAgcmV0dXJuIFNlbGVjdEZyb21MaXN0LnNob3coDQogICAgICAgIG9wZW5fZG9jcywNCiAgICAgICAgbmFtZV9hdHRyPSdUaXRsZScsDQogICAgICAgIG11bHRpc2VsZWN0PW11bHRpcGxlLA0KICAgICAgICB0aXRsZT10aXRsZSwNCiAgICAgICAgYnV0dG9uX25hbWU9YnV0dG9uX25hbWUsDQogICAgICAgIGZpbHRlcmZ1bmM9ZmlsdGVyZnVuYw0KICAgICAgICApDQoNCg0KZGVmIHNlbGVjdF90aXRsZWJsb2Nrcyh0aXRsZT0nU2VsZWN0IFRpdGxlYmxvY2snLA0KICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fbmFtZT0nU2VsZWN0JywNCiAgICAgICAgICAgICAgICAgICAgICAgbm9fdGJfb3B0aW9uPSdObyBUaXRsZSBCbG9jaycsDQogICAgICAgICAgICAgICAgICAgICAgIHdpZHRoPURFRkFVTFRfSU5QVVRXSU5ET1dfV0lEVEgsDQogICAgICAgICAgICAgICAgICAgICAgIG11bHRpcGxlPUZhbHNlLA0KICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJmdW5jPU5vbmUsDQogICAgICAgICAgICAgICAgICAgICAgIGRvYz1Ob25lKToNCiAgICAiIiJTdGFuZGFyZCBmb3JtIGZvciBzZWxlY3RpbmcgYSB0aXRsZWJsb2NrLg0KDQogICAgQXJnczoNCiAgICAgICAgdGl0bGUgKHN0ciwgb3B0aW9uYWwpOiBsaXN0IHdpbmRvdyB0aXRsZQ0KICAgICAgICBidXR0b25fbmFtZSAoc3RyLCBvcHRpb25hbCk6IGxpc3Qgd2luZG93IGJ1dHRvbiBjYXB0aW9uDQogICAgICAgIG5vX3RiX29wdGlvbiAoc3RyLCBvcHRpb25hbCk6IG5hbWUgb2Ygb3B0aW9uIGZvciBubyB0aXRsZSBibG9jaw0KICAgICAgICB3aWR0aCAoaW50LCBvcHRpb25hbCk6IHdpZHRoIG9mIGxpc3Qgd2luZG93DQogICAgICAgIG11bHRpcGxlIChib29sLCBvcHRpb25hbCk6DQogICAgICAgICAgICBhbGxvdyBtdWx0aS1zZWxlY3Rpb24gKHVzZXMgY2hlY2sgYm94ZXMpLiBkZWZhdWx0cyB0byBGYWxzZQ0KICAgICAgICBmaWx0ZXJmdW5jIChmdW5jdGlvbik6DQogICAgICAgICAgICBmaWx0ZXIgZnVuY3Rpb24gdG8gYmUgYXBwbGllZCB0byBjb250ZXh0IGl0ZW1zLg0KICAgICAgICBkb2MgKERCLkRvY3VtZW50LCBvcHRpb25hbCk6DQogICAgICAgICAgICBzb3VyY2UgZG9jdW1lbnQgZm9yIHRpdGxlYmxvY2tzOyBkZWZhdWx0cyB0byBhY3RpdmUgZG9jdW1lbnQNCg0KICAgIFJldHVybnM6DQogICAgICAgIChEQi5FbGVtZW50SWQpOiBzZWxlY3RlZCB0aXRsZWJsb2NrIGlkLg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLnNlbGVjdF90aXRsZWJsb2NrcygpDQogICAgICAgIDxBdXRvZGVzay5SZXZpdC5EQi5FbGVtZW50SWQgb2JqZWN0Pg0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBkb2MgPSBkb2Mgb3IgRE9DUy5kb2MNCiAgICB0aXRsZWJsb2NrcyA9IERCLkZpbHRlcmVkRWxlbWVudENvbGxlY3Rvcihkb2MpXA0KICAgICAgICAgICAgICAgICAgICAuT2ZDYXRlZ29yeShEQi5CdWlsdEluQ2F0ZWdvcnkuT1NUX1RpdGxlQmxvY2tzKVwNCiAgICAgICAgICAgICAgICAgICAgLldoZXJlRWxlbWVudElzRWxlbWVudFR5cGUoKVwNCiAgICAgICAgICAgICAgICAgICAgLlRvRWxlbWVudHMoKQ0KDQogICAgdGJsb2NrX2RpY3QgPSB7J3t9OiB7fScuZm9ybWF0KHRiLkZhbWlseU5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldml0LnF1ZXJ5LmdldF9uYW1lKHRiKSk6IHRiLklkDQogICAgICAgICAgICAgICAgICAgZm9yIHRiIGluIHRpdGxlYmxvY2tzfQ0KICAgIHRibG9ja19kaWN0W25vX3RiX29wdGlvbl0gPSBEQi5FbGVtZW50SWQuSW52YWxpZEVsZW1lbnRJZA0KICAgIHNlbGVjdGVkX3RpdGxlYmxvY2tzID0gU2VsZWN0RnJvbUxpc3Quc2hvdyhzb3J0ZWQodGJsb2NrX2RpY3Qua2V5cygpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU9dGl0bGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl9uYW1lPWJ1dHRvbl9uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aD13aWR0aCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlzZWxlY3Q9bXVsdGlwbGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcmZ1bmM9ZmlsdGVyZnVuYykNCiAgICBpZiBzZWxlY3RlZF90aXRsZWJsb2NrczoNCiAgICAgICAgaWYgbXVsdGlwbGU6DQogICAgICAgICAgICByZXR1cm4gW3RibG9ja19kaWN0W3hdIGZvciB4IGluIHNlbGVjdGVkX3RpdGxlYmxvY2tzXQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgcmV0dXJuIHRibG9ja19kaWN0W3NlbGVjdGVkX3RpdGxlYmxvY2tzXQ0KDQoNCmRlZiBzZWxlY3Rfc3dhdGNoKHRpdGxlPSdTZWxlY3QgQ29sb3IgU3dhdGNoJywgYnV0dG9uX25hbWU9J1NlbGVjdCcpOg0KICAgICIiIlN0YW5kYXJkIGZvcm0gZm9yIHNlbGVjdGluZyBhIGNvbG9yIHN3YXRjaC4NCg0KICAgIEFyZ3M6DQogICAgICAgIHRpdGxlIChzdHIsIG9wdGlvbmFsKTogc3dhdGNoIGxpc3Qgd2luZG93IHRpdGxlDQogICAgICAgIGJ1dHRvbl9uYW1lIChzdHIsIG9wdGlvbmFsKTogc3dhdGNoIGxpc3Qgd2luZG93IGJ1dHRvbiBjYXB0aW9uDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAocHlyZXZpdC5jb3JldXRpbHMuY29sb3JzLlJHQik6IHJnYiBjb2xvcg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLnNlbGVjdF9zd2F0Y2godGl0bGU9IlNlbGVjdCBUZXh0IENvbG9yIikNCiAgICAgICAgPFJHQiAjQ0Q4ODAwPg0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBpdGVtcGxhdGUgPSB1dGlscy5sb2FkX2N0cmxfdGVtcGxhdGUoDQogICAgICAgIG9zLnBhdGguam9pbihYQU1MX0ZJTEVTX0RJUiwgIlN3YXRjaENvbnRhaW5lclN0eWxlLnhhbWwiKQ0KICAgICAgICApDQogICAgc3dhdGNoID0gU2VsZWN0RnJvbUxpc3Quc2hvdygNCiAgICAgICAgY29sb3JzLkNPTE9SUy52YWx1ZXMoKSwNCiAgICAgICAgdGl0bGU9dGl0bGUsDQogICAgICAgIGJ1dHRvbl9uYW1lPWJ1dHRvbl9uYW1lLA0KICAgICAgICB3aWR0aD0zMDAsDQogICAgICAgIG11bHRpc2VsZWN0PUZhbHNlLA0KICAgICAgICBpdGVtX3RlbXBsYXRlPWl0ZW1wbGF0ZQ0KICAgICAgICApDQoNCiAgICByZXR1cm4gc3dhdGNoDQoNCg0KZGVmIHNlbGVjdF9pbWFnZShpbWFnZXMsIHRpdGxlPSdTZWxlY3QgSW1hZ2UnLCBidXR0b25fbmFtZT0nU2VsZWN0Jyk6DQogICAgIiIiU3RhbmRhcmQgZm9ybSBmb3Igc2VsZWN0aW5nIGFuIGltYWdlLg0KDQogICAgQXJnczoNCiAgICAgICAgaW1hZ2VzIChsaXN0W3N0cl0gfCBsaXN0W2ZyYW1ld29yay5JbWFnaW5nLkJpdG1hcEltYWdlXSk6DQogICAgICAgICAgICBsaXN0IG9mIGltYWdlIGZpbGUgcGF0aHMgb3IgYml0bWFwcw0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IHN3YXRjaCBsaXN0IHdpbmRvdyB0aXRsZQ0KICAgICAgICBidXR0b25fbmFtZSAoc3RyLCBvcHRpb25hbCk6IHN3YXRjaCBsaXN0IHdpbmRvdyBidXR0b24gY2FwdGlvbg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IHBhdGggb2YgdGhlIHNlbGVjdGVkIGltYWdlDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZyb20gcHlyZXZpdCBpbXBvcnQgZm9ybXMNCiAgICAgICAgZm9ybXMuc2VsZWN0X2ltYWdlKFsnQzovcGF0aC90by9pbWFnZTEucG5nJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQzovcGF0aC90by9pbWFnZTIucG5nJ10sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU9IlNlbGVjdCBWYXJpYXRpb24iKQ0KICAgICAgICAnQzovcGF0aC90by9pbWFnZTEucG5nJw0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBwdGVtcGxhdGUgPSB1dGlscy5sb2FkX2l0ZW1zcGFuZWxfdGVtcGxhdGUoDQogICAgICAgIG9zLnBhdGguam9pbihYQU1MX0ZJTEVTX0RJUiwgIkltYWdlTGlzdFBhbmVsU3R5bGUueGFtbCIpDQogICAgICAgICkNCg0KICAgIGl0ZW1wbGF0ZSA9IHV0aWxzLmxvYWRfY3RybF90ZW1wbGF0ZSgNCiAgICAgICAgb3MucGF0aC5qb2luKFhBTUxfRklMRVNfRElSLCAiSW1hZ2VMaXN0Q29udGFpbmVyU3R5bGUueGFtbCIpDQogICAgICAgICkNCg0KICAgIGJpdG1hcF9pbWFnZXMgPSB7fQ0KICAgIGZvciBpbWFnZW9iaiBpbiBpbWFnZXM6DQogICAgICAgIGlmIGlzaW5zdGFuY2UoaW1hZ2VvYmosIHN0cik6DQogICAgICAgICAgICBpbWcgPSB1dGlscy5iaXRtYXBfZnJvbV9maWxlKGltYWdlb2JqKQ0KICAgICAgICAgICAgaWYgaW1nOg0KICAgICAgICAgICAgICAgIGJpdG1hcF9pbWFnZXNbaW1nXSA9IGltYWdlb2JqDQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShpbWFnZW9iaiwgZnJhbWV3b3JrLkltYWdpbmcuQml0bWFwSW1hZ2UpOg0KICAgICAgICAgICAgYml0bWFwX2ltYWdlc1tpbWFnZW9ial0gPSBpbWFnZW9iag0KDQogICAgc2VsZWN0ZWRfaW1hZ2UgPSBTZWxlY3RGcm9tTGlzdC5zaG93KA0KICAgICAgICBzb3J0ZWQoYml0bWFwX2ltYWdlcy5rZXlzKCksIGtleT1sYW1iZGEgeDogeC5VcmlTb3VyY2UuQWJzb2x1dGVQYXRoKSwNCiAgICAgICAgdGl0bGU9dGl0bGUsDQogICAgICAgIGJ1dHRvbl9uYW1lPWJ1dHRvbl9uYW1lLA0KICAgICAgICB3aWR0aD01MDAsDQogICAgICAgIG11bHRpc2VsZWN0PUZhbHNlLA0KICAgICAgICBpdGVtX3RlbXBsYXRlPWl0ZW1wbGF0ZSwNCiAgICAgICAgaXRlbXNfcGFuZWxfdGVtcGxhdGU9cHRlbXBsYXRlDQogICAgICAgICkNCg0KICAgIHJldHVybiBiaXRtYXBfaW1hZ2VzLmdldChzZWxlY3RlZF9pbWFnZSwgTm9uZSkNCg0KDQpkZWYgc2VsZWN0X3BhcmFtZXRlcnMoc3JjX2VsZW1lbnQsDQogICAgICAgICAgICAgICAgICAgICAgdGl0bGU9J1NlbGVjdCBQYXJhbWV0ZXJzJywNCiAgICAgICAgICAgICAgICAgICAgICBidXR0b25fbmFtZT0nU2VsZWN0JywNCiAgICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZT1UcnVlLA0KICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcmZ1bmM9Tm9uZSwNCiAgICAgICAgICAgICAgICAgICAgICBpbmNsdWRlX2luc3RhbmNlPVRydWUsDQogICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZV90eXBlPVRydWUsDQogICAgICAgICAgICAgICAgICAgICAgZXhjbHVkZV9yZWFkb25seT1UcnVlKToNCiAgICAiIiJTdGFuZGFyZCBmb3JtIGZvciBzZWxlY3RpbmcgcGFyYW1ldGVycyBmcm9tIGdpdmVuIGVsZW1lbnQuDQoNCiAgICBBcmdzOg0KICAgICAgICBzcmNfZWxlbWVudCAoREIuRWxlbWVudCk6IHNvdXJjZSBlbGVtZW50DQogICAgICAgIHRpdGxlIChzdHIsIG9wdGlvbmFsKTogbGlzdCB3aW5kb3cgdGl0bGUNCiAgICAgICAgYnV0dG9uX25hbWUgKHN0ciwgb3B0aW9uYWwpOiBsaXN0IHdpbmRvdyBidXR0b24gY2FwdGlvbg0KICAgICAgICBtdWx0aXBsZSAoYm9vbCwgb3B0aW9uYWwpOg0KICAgICAgICAgICAgYWxsb3cgbXVsdGktc2VsZWN0aW9uICh1c2VzIGNoZWNrIGJveGVzKS4gZGVmYXVsdHMgdG8gVHJ1ZQ0KICAgICAgICBmaWx0ZXJmdW5jIChmdW5jdGlvbik6DQogICAgICAgICAgICBmaWx0ZXIgZnVuY3Rpb24gdG8gYmUgYXBwbGllZCB0byBjb250ZXh0IGl0ZW1zLg0KICAgICAgICBpbmNsdWRlX2luc3RhbmNlIChib29sLCBvcHRpb25hbCk6IGxpc3QgaW5zdGFuY2UgcGFyYW1ldGVycw0KICAgICAgICBpbmNsdWRlX3R5cGUgKGJvb2wsIG9wdGlvbmFsKTogbGlzdCB0eXBlIHBhcmFtZXRlcnMNCiAgICAgICAgZXhjbHVkZV9yZWFkb25seSAoYm9vbCwgb3B0aW9uYWwpOiBvbmx5IHNob3dzIHBhcmFtZXRlcnMgdGhhdCBhcmUgZWRpdGFibGUNCg0KICAgIFJldHVybnM6DQogICAgICAgIChsaXN0W1BhcmFtRGVmXSk6IGxpc3Qgb2YgcGFyYW1kZWYgb2JqZWN0cw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmb3Jtcy5zZWxlY3RfcGFyYW1ldGVyKA0KICAgICAgICAgICAgc3JjX2VsZW1lbnQsDQogICAgICAgICAgICB0aXRsZT0nU2VsZWN0IFBhcmFtZXRlcnMnLA0KICAgICAgICAgICAgbXVsdGlwbGU9VHJ1ZSwNCiAgICAgICAgICAgIGluY2x1ZGVfaW5zdGFuY2U9VHJ1ZSwNCiAgICAgICAgICAgIGluY2x1ZGVfdHlwZT1UcnVlDQogICAgICAgICkNCiAgICAgICAgWzxQYXJhbURlZiA+LCA8UGFyYW1EZWYgPl0NCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgcGFyYW1fZGVmcyA9IFtdDQogICAgbm9uX3N0b3JhZ2VfdHlwZSA9IGNvcmV1dGlscy5nZXRfZW51bV9ub25lKERCLlN0b3JhZ2VUeXBlKQ0KICAgIGlmIGluY2x1ZGVfaW5zdGFuY2U6DQogICAgICAgICMgY29sbGVjdCBpbnN0YW5jZSBwYXJhbWV0ZXJzDQogICAgICAgIHBhcmFtX2RlZnMuZXh0ZW5kKA0KICAgICAgICAgICAgW1BhcmFtRGVmKG5hbWU9eC5EZWZpbml0aW9uLk5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgaXN0eXBlPUZhbHNlLA0KICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb249eC5EZWZpbml0aW9uLA0KICAgICAgICAgICAgICAgICAgICAgIGlzcmVhZG9ubHk9eC5Jc1JlYWRPbmx5KQ0KICAgICAgICAgICAgIGZvciB4IGluIHNyY19lbGVtZW50LlBhcmFtZXRlcnMNCiAgICAgICAgICAgICBpZiB4LlN0b3JhZ2VUeXBlICE9IG5vbl9zdG9yYWdlX3R5cGVdDQogICAgICAgICkNCg0KICAgIGlmIGluY2x1ZGVfdHlwZToNCiAgICAgICAgIyBjb2xsZWN0IHR5cGUgcGFyYW1ldGVycw0KICAgICAgICBzcmNfdHlwZSA9IHJldml0LnF1ZXJ5LmdldF90eXBlKHNyY19lbGVtZW50KQ0KICAgICAgICBwYXJhbV9kZWZzLmV4dGVuZCgNCiAgICAgICAgICAgIFtQYXJhbURlZihuYW1lPXguRGVmaW5pdGlvbi5OYW1lLA0KICAgICAgICAgICAgICAgICAgICAgIGlzdHlwZT1UcnVlLA0KICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb249eC5EZWZpbml0aW9uLA0KICAgICAgICAgICAgICAgICAgICAgIGlzcmVhZG9ubHk9eC5Jc1JlYWRPbmx5KQ0KICAgICAgICAgICAgIGZvciB4IGluIHNyY190eXBlLlBhcmFtZXRlcnMNCiAgICAgICAgICAgICBpZiB4LlN0b3JhZ2VUeXBlICE9IG5vbl9zdG9yYWdlX3R5cGVdDQogICAgICAgICkNCg0KICAgIGlmIGV4Y2x1ZGVfcmVhZG9ubHk6DQogICAgICAgIHBhcmFtX2RlZnMgPSBmaWx0ZXIobGFtYmRhIHg6IG5vdCB4LmlzcmVhZG9ubHksIHBhcmFtX2RlZnMpDQoNCiAgICBpZiBmaWx0ZXJmdW5jOg0KICAgICAgICBwYXJhbV9kZWZzID0gZmlsdGVyKGZpbHRlcmZ1bmMsIHBhcmFtX2RlZnMpDQoNCiAgICBwYXJhbV9kZWZzLnNvcnQoa2V5PWxhbWJkYSB4OiB4Lm5hbWUpDQoNCiAgICBpdGVtcGxhdGUgPSB1dGlscy5sb2FkX2N0cmxfdGVtcGxhdGUoDQogICAgICAgIG9zLnBhdGguam9pbihYQU1MX0ZJTEVTX0RJUiwgIlBhcmFtZXRlckl0ZW1TdHlsZS54YW1sIikNCiAgICAgICAgKQ0KICAgIHNlbGVjdGVkX3BhcmFtcyA9IFNlbGVjdEZyb21MaXN0LnNob3coDQogICAgICAgIHBhcmFtX2RlZnMsDQogICAgICAgIHRpdGxlPXRpdGxlLA0KICAgICAgICBidXR0b25fbmFtZT1idXR0b25fbmFtZSwNCiAgICAgICAgd2lkdGg9NDUwLA0KICAgICAgICBtdWx0aXNlbGVjdD1tdWx0aXBsZSwNCiAgICAgICAgaXRlbV90ZW1wbGF0ZT1pdGVtcGxhdGUNCiAgICAgICAgKQ0KDQogICAgcmV0dXJuIHNlbGVjdGVkX3BhcmFtcw0KDQoNCmRlZiBzZWxlY3RfZmFtaWx5X3BhcmFtZXRlcnMoZmFtaWx5X2RvYywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU9J1NlbGVjdCBQYXJhbWV0ZXJzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX25hbWU9J1NlbGVjdCcsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpcGxlPVRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcmZ1bmM9Tm9uZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZV9pbnN0YW5jZT1UcnVlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNsdWRlX3R5cGU9VHJ1ZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZV9idWlsdGluPVRydWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGVfbGFiZWxlZD1UcnVlKToNCiAgICAiIiJTdGFuZGFyZCBmb3JtIGZvciBzZWxlY3RpbmcgcGFyYW1ldGVycyBmcm9tIGdpdmVuIGZhbWlseSBkb2N1bWVudC4NCg0KICAgIEFyZ3M6DQogICAgICAgIGZhbWlseV9kb2MgKERCLkRvY3VtZW50KTogc291cmNlIGZhbWlseSBkb2N1bWVudA0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IGxpc3Qgd2luZG93IHRpdGxlDQogICAgICAgIGJ1dHRvbl9uYW1lIChzdHIsIG9wdGlvbmFsKTogbGlzdCB3aW5kb3cgYnV0dG9uIGNhcHRpb24NCiAgICAgICAgbXVsdGlwbGUgKGJvb2wsIG9wdGlvbmFsKToNCiAgICAgICAgICAgIGFsbG93IG11bHRpLXNlbGVjdGlvbiAodXNlcyBjaGVjayBib3hlcykuIGRlZmF1bHRzIHRvIFRydWUNCiAgICAgICAgZmlsdGVyZnVuYyAoZnVuY3Rpb24pOg0KICAgICAgICAgICAgZmlsdGVyIGZ1bmN0aW9uIHRvIGJlIGFwcGxpZWQgdG8gY29udGV4dCBpdGVtcy4NCiAgICAgICAgaW5jbHVkZV9pbnN0YW5jZSAoYm9vbCwgb3B0aW9uYWwpOiBsaXN0IGluc3RhbmNlIHBhcmFtZXRlcnMNCiAgICAgICAgaW5jbHVkZV90eXBlIChib29sLCBvcHRpb25hbCk6IGxpc3QgdHlwZSBwYXJhbWV0ZXJzDQogICAgICAgIGluY2x1ZGVfYnVpbHRpbiAoYm9vbCwgb3B0aW9uYWwpOiBsaXN0IGJ1aWx0aW4gcGFyYW1ldGVycw0KICAgICAgICBpbmNsdWRlX2xhYmVsZWQgKGJvb2wsIG9wdGlvbmFsKTogbGlzdCBwYXJhbWV0ZXJzIHVzZWQgYXMgbGFiZWxzDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAobGlzdFtEQi5GYW1pbHlQYXJhbWV0ZXJdKTogbGlzdCBvZiBmYW1pbHkgcGFyYW1ldGVyIG9iamVjdHMNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZm9ybXMuc2VsZWN0X2ZhbWlseV9wYXJhbWV0ZXJzKA0KICAgICAgICAgICAgZmFtaWx5X2RvYywNCiAgICAgICAgICAgIHRpdGxlPSdTZWxlY3QgUGFyYW1ldGVycycsDQogICAgICAgICAgICBtdWx0aXBsZT1UcnVlLA0KICAgICAgICAgICAgaW5jbHVkZV9pbnN0YW5jZT1UcnVlLA0KICAgICAgICAgICAgaW5jbHVkZV90eXBlPVRydWUNCiAgICAgICAgKQ0KICAgICAgICBbPERCLkZhbWlseVBhcmFtZXRlciA+LCA8REIuRmFtaWx5UGFyYW1ldGVyID5dDQogICAgICAgIGBgYA0KICAgICIiIg0KICAgIGZhbWlseV9kb2MgPSBmYW1pbHlfZG9jIG9yIERPQ1MuZG9jDQogICAgZmFtaWx5X3BhcmFtcyA9IHJldml0LnF1ZXJ5LmdldF9mYW1pbHlfcGFyYW1ldGVycyhmYW1pbHlfZG9jKQ0KICAgICMgZ2V0IGFsbCBwYXJhbXMgdXNlZCBpbiBsYWJlbGVzDQogICAgbGFiZWxfcGFyYW1faWRzID0gXA0KICAgICAgICBbeC5JZCBmb3IgeCBpbiByZXZpdC5xdWVyeS5nZXRfZmFtaWx5X2xhYmVsX3BhcmFtZXRlcnMoZmFtaWx5X2RvYyldDQoNCiAgICBpZiBmaWx0ZXJmdW5jOg0KICAgICAgICBmYW1pbHlfcGFyYW1zID0gZmlsdGVyKGZpbHRlcmZ1bmMsIGZhbWlseV9wYXJhbXMpDQoNCiAgICBwYXJhbV9kZWZzID0gW10NCiAgICBmb3IgZmFtaWx5X3BhcmFtIGluIGZhbWlseV9wYXJhbXM6DQogICAgICAgIGlmIG5vdCBpbmNsdWRlX2luc3RhbmNlIGFuZCBmYW1pbHlfcGFyYW0uSXNJbnN0YW5jZToNCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIGlmIG5vdCBpbmNsdWRlX3R5cGUgYW5kIG5vdCBmYW1pbHlfcGFyYW0uSXNJbnN0YW5jZToNCiAgICAgICAgICAgIGNvbnRpbnVlDQogICAgICAgIGlmIG5vdCBpbmNsdWRlX2J1aWx0aW4gYW5kIGZhbWlseV9wYXJhbS5JZC5JbnRlZ2VyVmFsdWUgPCAwOg0KICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgaWYgbm90IGluY2x1ZGVfbGFiZWxlZCBhbmQgZmFtaWx5X3BhcmFtLklkIGluIGxhYmVsX3BhcmFtX2lkczoNCiAgICAgICAgICAgIGNvbnRpbnVlDQoNCiAgICAgICAgcGFyYW1fZGVmcy5hcHBlbmQoDQogICAgICAgICAgICBGYW1pbHlQYXJhbU9wdGlvbihmYW1pbHlfcGFyYW0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWlsdGluPWZhbWlseV9wYXJhbS5JZC5JbnRlZ2VyVmFsdWUgPCAwLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxlZD1mYW1pbHlfcGFyYW0uSWQgaW4gbGFiZWxfcGFyYW1faWRzKQ0KICAgICAgICAgICAgKQ0KDQogICAgcGFyYW1fZGVmcy5zb3J0KGtleT1sYW1iZGEgeDogeC5uYW1lKQ0KDQogICAgaXRlbXBsYXRlID0gdXRpbHMubG9hZF9jdHJsX3RlbXBsYXRlKA0KICAgICAgICBvcy5wYXRoLmpvaW4oWEFNTF9GSUxFU19ESVIsICJGYW1pbHlQYXJhbWV0ZXJJdGVtU3R5bGUueGFtbCIpDQogICAgICAgICkNCiAgICBzZWxlY3RlZF9wYXJhbXMgPSBTZWxlY3RGcm9tTGlzdC5zaG93KA0KICAgICAgICB7DQogICAgICAgICAgICAnQWxsIFBhcmFtZXRlcnMnOiBwYXJhbV9kZWZzLA0KICAgICAgICAgICAgJ1R5cGUgUGFyYW1ldGVycyc6IFt4IGZvciB4IGluIHBhcmFtX2RlZnMgaWYgeC5pc3R5cGVdLA0KICAgICAgICAgICAgJ0J1aWx0LWluIFBhcmFtZXRlcnMnOiBbeCBmb3IgeCBpbiBwYXJhbV9kZWZzIGlmIHguaXNidWlsdGluXSwNCiAgICAgICAgICAgICdVc2VkIGFzIExhYmVsJzogW3ggZm9yIHggaW4gcGFyYW1fZGVmcyBpZiB4LmlzbGFiZWxlZF0sDQogICAgICAgIH0sDQogICAgICAgIHRpdGxlPXRpdGxlLA0KICAgICAgICBidXR0b25fbmFtZT1idXR0b25fbmFtZSwNCiAgICAgICAgZ3JvdXBfc2VsZWN0b3JfdGl0bGU9J1BhcmFtZXRlciBGaWx0ZXJzOicsDQogICAgICAgIHdpZHRoPTQ1MCwNCiAgICAgICAgbXVsdGlzZWxlY3Q9bXVsdGlwbGUsDQogICAgICAgIGl0ZW1fdGVtcGxhdGU9aXRlbXBsYXRlDQogICAgICAgICkNCg0KICAgIHJldHVybiBzZWxlY3RlZF9wYXJhbXMNCg0KDQpkZWYgYWxlcnQobXNnLCB0aXRsZT1Ob25lLCBzdWJfbXNnPU5vbmUsIGV4cGFuZGVkPU5vbmUsIGZvb3Rlcj0nJywNCiAgICAgICAgICBvaz1UcnVlLCBjYW5jZWw9RmFsc2UsIHllcz1GYWxzZSwgbm89RmFsc2UsIHJldHJ5PUZhbHNlLA0KICAgICAgICAgIHdhcm5faWNvbj1UcnVlLCBvcHRpb25zPU5vbmUsIGV4aXRzY3JpcHQ9RmFsc2UpOg0KICAgIHIiIiJTaG93IGEgdGFzayBkaWFsb2cgd2l0aCBnaXZlbiBtZXNzYWdlLg0KDQogICAgQXJnczoNCiAgICAgICAgbXNnIChzdHIpOiBtZXNzYWdlIHRvIGJlIGRpc3BsYXllZA0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IHRhc2sgZGlhbG9nIHRpdGxlDQogICAgICAgIHN1Yl9tc2cgKHN0ciwgb3B0aW9uYWwpOiBzdWIgbWVzc2FnZSwgdXNlIGh0bWwgdG8gY3JlYXRlIGNsaWNrYWJsZSBsaW5rcw0KICAgICAgICBleHBhbmRlZCAoc3RyLCBvcHRpb25hbCk6IGV4cGFuZGVkIGFyZWEgbWVzc2FnZQ0KICAgICAgICBmb290ZXIgKHN0ciwgb3B0aW9uYWwpOiBmb290ZXIgdGV4dA0KICAgICAgICBvayAoYm9vbCwgb3B0aW9uYWwpOiBzaG93IE9LIGJ1dHRvbiwgZGVmYXVsdHMgdG8gVHJ1ZQ0KICAgICAgICBjYW5jZWwgKGJvb2wsIG9wdGlvbmFsKTogc2hvdyBDYW5jZWwgYnV0dG9uLCBkZWZhdWx0cyB0byBGYWxzZQ0KICAgICAgICB5ZXMgKGJvb2wsIG9wdGlvbmFsKTogc2hvdyBZZXMgYnV0dG9uLCBkZWZhdWx0cyB0byBGYWxzZQ0KICAgICAgICBubyAoYm9vbCwgb3B0aW9uYWwpOiBzaG93IE5PIGJ1dHRvbiwgZGVmYXVsdHMgdG8gRmFsc2UNCiAgICAgICAgcmV0cnkgKGJvb2wsIG9wdGlvbmFsKTogc2hvdyBSZXRyeSBidXR0b24sIGRlZmF1bHRzIHRvIEZhbHNlDQogICAgICAgIHdhcm5faWNvbiAoYm9vbCwgb3B0aW9uYWwpOiBzaG93IHdhcm5pbmcgaWNvbg0KICAgICAgICBvcHRpb25zIChsaXN0W3N0cl0sIG9wdGlvbmFsKTogbGlzdCBvZiBjb21tYW5kIGxpbmsgdGl0bGVzIGluIG9yZGVyDQogICAgICAgIGV4aXRzY3JpcHQgKGJvb2wsIG9wdGlvbmFsKTogZXhpdCBpZiBjYW5jZWwgb3Igbm8sIGRlZmF1bHRzIHRvIEZhbHNlDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoYm9vbCk6IFRydWUgaWYgb2theSwgeWVzLCBvciByZXRyeSwgb3RoZXJ3aXNlIEZhbHNlDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZyb20gcHlyZXZpdCBpbXBvcnQgZm9ybXMNCiAgICAgICAgZm9ybXMuYWxlcnQoJ0FyZSB5b3Ugc3VyZT8nLA0KICAgICAgICAgICAgICAgICAgICBzdWJfbXNnPSc8YSBocmVmPVwiaHR0cHM6Ly9kaXNjb3Vyc2UucHlyZXZpdGxhYnMuaW8vIFwiPkNsaWNrIGhlcmUgaWYgeW91IGFyZSBub3Qgc3VyZSBhbmQgd2FudCB0byBnbyB0byB0aGUgcHlSZXZpdCBGb3J1bTwvYT4nLA0KICAgICAgICAgICAgICAgICAgICBvaz1GYWxzZSwgeWVzPVRydWUsIG5vPVRydWUsIGV4aXRzY3JpcHQ9VHJ1ZSkNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgIyBCVUlMRCBESUFMT0cNCiAgICBjbWRfbmFtZSA9IEVYRUNfUEFSQU1TLmNvbW1hbmRfbmFtZQ0KICAgIGlmIG5vdCB0aXRsZToNCiAgICAgICAgdGl0bGUgPSBjbWRfbmFtZSBpZiBjbWRfbmFtZSBlbHNlICdweVJldml0Jw0KICAgIHRkbGcgPSBVSS5UYXNrRGlhbG9nKHRpdGxlKQ0KDQogICAgIyBwcm9jZXNzIGlucHV0IHR5cGVzDQogICAganVzdF9vayA9IG9rIGFuZCBub3QgYW55KFtjYW5jZWwsIHllcywgbm8sIHJldHJ5XSkNCg0KICAgIG9wdGlvbnMgPSBvcHRpb25zIG9yIFtdDQogICAgIyBhZGQgY29tbWFuZCBsaW5rcyBpZiBhbnkNCiAgICBpZiBvcHRpb25zOg0KICAgICAgICBjbGlua3MgPSBjb3JldXRpbHMuZ2V0X2VudW1fdmFsdWVzKFVJLlRhc2tEaWFsb2dDb21tYW5kTGlua0lkKQ0KICAgICAgICBtYXhfY2xpbmtzID0gbGVuKGNsaW5rcykNCiAgICAgICAgZm9yIGlkeCwgY21kIGluIGVudW1lcmF0ZShvcHRpb25zKToNCiAgICAgICAgICAgIGlmIGlkeCA8IG1heF9jbGlua3M6DQogICAgICAgICAgICAgICAgdGRsZy5BZGRDb21tYW5kTGluayhjbGlua3NbaWR4XSwgY21kKQ0KICAgICMgb3RoZXJ3aXNlIGFkZCBidXR0b25zDQogICAgZWxzZToNCiAgICAgICAgYnV0dG9ucyA9IGNvcmV1dGlscy5nZXRfZW51bV9ub25lKFVJLlRhc2tEaWFsb2dDb21tb25CdXR0b25zKQ0KICAgICAgICBpZiB5ZXM6DQogICAgICAgICAgICBidXR0b25zIHw9IFVJLlRhc2tEaWFsb2dDb21tb25CdXR0b25zLlllcw0KICAgICAgICBlbGlmIG9rOg0KICAgICAgICAgICAgYnV0dG9ucyB8PSBVSS5UYXNrRGlhbG9nQ29tbW9uQnV0dG9ucy5Paw0KDQogICAgICAgIGlmIGNhbmNlbDoNCiAgICAgICAgICAgIGJ1dHRvbnMgfD0gVUkuVGFza0RpYWxvZ0NvbW1vbkJ1dHRvbnMuQ2FuY2VsDQogICAgICAgIGlmIG5vOg0KICAgICAgICAgICAgYnV0dG9ucyB8PSBVSS5UYXNrRGlhbG9nQ29tbW9uQnV0dG9ucy5Obw0KICAgICAgICBpZiByZXRyeToNCiAgICAgICAgICAgIGJ1dHRvbnMgfD0gVUkuVGFza0RpYWxvZ0NvbW1vbkJ1dHRvbnMuUmV0cnkNCiAgICAgICAgdGRsZy5Db21tb25CdXR0b25zID0gYnV0dG9ucw0KDQogICAgIyBzZXQgdGV4dHMNCiAgICB0ZGxnLk1haW5JbnN0cnVjdGlvbiA9IG1zZw0KICAgIHRkbGcuTWFpbkNvbnRlbnQgPSBzdWJfbXNnDQogICAgdGRsZy5FeHBhbmRlZENvbnRlbnQgPSBleHBhbmRlZA0KICAgIGlmIGZvb3RlcjoNCiAgICAgICAgZm9vdGVyID0gZm9vdGVyLnN0cmlwKCkgKyAnXG4nDQogICAgdGRsZy5Gb290ZXJUZXh0ID0gZm9vdGVyICsgJ3B5UmV2aXQge30nLmZvcm1hdCgNCiAgICAgICAgdmVyc2lvbm1nci5nZXRfcHlyZXZpdF92ZXJzaW9uKCkuZ2V0X2Zvcm1hdHRlZCgpDQogICAgICAgICkNCiAgICB0ZGxnLlRpdGxlQXV0b1ByZWZpeCA9IEZhbHNlDQoNCiAgICAjIHNldCBpY29uDQogICAgdGRsZy5NYWluSWNvbiA9IFwNCiAgICAgICAgVUkuVGFza0RpYWxvZ0ljb24uVGFza0RpYWxvZ0ljb25XYXJuaW5nIFwNCiAgICAgICAgaWYgd2Fybl9pY29uIGVsc2UgVUkuVGFza0RpYWxvZ0ljb24uVGFza0RpYWxvZ0ljb25Ob25lDQoNCiAgICAjIHRkbGcuVmVyaWZpY2F0aW9uVGV4dCA9ICd2ZXJpZicNCg0KICAgICMgU0hPVyBESUFMT0cNCiAgICByZXMgPSB0ZGxnLlNob3coKQ0KDQogICAgIyBQUk9DRVNTIFJFUE9OU0VTDQogICAgIyBwb3NpdGl2ZSByZXNwb25zZQ0KICAgIG1sb2dnZXIuZGVidWcoJ2FsZXJ0IHJlc3VsdDogJXMnLCByZXMpDQogICAgaWYgcmVzID09IFVJLlRhc2tEaWFsb2dSZXN1bHQuT2sgXA0KICAgICAgICAgICAgb3IgcmVzID09IFVJLlRhc2tEaWFsb2dSZXN1bHQuWWVzIFwNCiAgICAgICAgICAgIG9yIHJlcyA9PSBVSS5UYXNrRGlhbG9nUmVzdWx0LlJldHJ5Og0KICAgICAgICBpZiBqdXN0X29rIGFuZCBleGl0c2NyaXB0Og0KICAgICAgICAgICAgc3lzLmV4aXQoKQ0KICAgICAgICByZXR1cm4gVHJ1ZQ0KICAgICMgbmVnYXRpdmUgcmVzcG9uc2UNCiAgICBlbGlmIHJlcyA9PSBjb3JldXRpbHMuZ2V0X2VudW1fbm9uZShVSS5UYXNrRGlhbG9nUmVzdWx0KSBcDQogICAgICAgICAgICBvciByZXMgPT0gVUkuVGFza0RpYWxvZ1Jlc3VsdC5DYW5jZWwgXA0KICAgICAgICAgICAgb3IgcmVzID09IFVJLlRhc2tEaWFsb2dSZXN1bHQuTm86DQogICAgICAgIGlmIGV4aXRzY3JpcHQ6DQogICAgICAgICAgICBzeXMuZXhpdCgpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCg0KICAgICMgY29tbWFuZCBsaW5rIHJlc3BvbnNlDQogICAgZWxpZiAnQ29tbWFuZExpbmsnIGluIHN0cihyZXMpOg0KICAgICAgICB0ZHJlc3VsdHMgPSBzb3J0ZWQoDQogICAgICAgICAgICBbeCBmb3IgeCBpbiBjb3JldXRpbHMuZ2V0X2VudW1fdmFsdWVzKFVJLlRhc2tEaWFsb2dSZXN1bHQpDQogICAgICAgICAgICAgaWYgJ0NvbW1hbmRMaW5rJyBpbiBzdHIoeCldDQogICAgICAgICAgICApDQogICAgICAgIHJlc2lkeCA9IHRkcmVzdWx0cy5pbmRleChyZXMpDQogICAgICAgIHJldHVybiBvcHRpb25zW3Jlc2lkeF0NCiAgICBlbGlmIGV4aXRzY3JpcHQ6DQogICAgICAgIHN5cy5leGl0KCkNCiAgICBlbHNlOg0KICAgICAgICByZXR1cm4gRmFsc2UNCg0KDQpkZWYgYWxlcnRfaWZub3QoY29uZGl0aW9uLCBtc2csICphcmdzLCAqKmt3YXJncyk6DQogICAgIiIiU2hvdyBhIHRhc2sgZGlhbG9nIHdpdGggZ2l2ZW4gbWVzc2FnZSBpZiBjb25kaXRpb24gaXMgTk9UIG1ldC4NCg0KICAgIEFyZ3M6DQogICAgICAgIGNvbmRpdGlvbiAoYm9vbCk6IGNvbmRpdGlvbiB0byB0ZXN0DQogICAgICAgIG1zZyAoc3RyKTogbWVzc2FnZSB0byBiZSBkaXNwbGF5ZWQNCiAgICAgICAgKmFyZ3MgKEFueSk6IGFkZGl0aW9uYWwgYXJndW1lbnRzDQogICAgICAgICoqa3dhcmdzIChBbnkpOiBhZGRpdGlvbmFsIGtleXdvcmQgYXJndW1lbnRzDQoNCiAgICBLZXl3b3JkIEFyZ3M6DQogICAgICAgIHRpdGxlIChzdHIsIG9wdGlvbmFsKTogdGFzayBkaWFsb2cgdGl0bGUNCiAgICAgICAgb2sgKGJvb2wsIG9wdGlvbmFsKTogc2hvdyBPSyBidXR0b24sIGRlZmF1bHRzIHRvIFRydWUNCiAgICAgICAgY2FuY2VsIChib29sLCBvcHRpb25hbCk6IHNob3cgQ2FuY2VsIGJ1dHRvbiwgZGVmYXVsdHMgdG8gRmFsc2UNCiAgICAgICAgeWVzIChib29sLCBvcHRpb25hbCk6IHNob3cgWWVzIGJ1dHRvbiwgZGVmYXVsdHMgdG8gRmFsc2UNCiAgICAgICAgbm8gKGJvb2wsIG9wdGlvbmFsKTogc2hvdyBOTyBidXR0b24sIGRlZmF1bHRzIHRvIEZhbHNlDQogICAgICAgIHJldHJ5IChib29sLCBvcHRpb25hbCk6IHNob3cgUmV0cnkgYnV0dG9uLCBkZWZhdWx0cyB0byBGYWxzZQ0KICAgICAgICBleGl0c2NyaXB0IChib29sLCBvcHRpb25hbCk6IGV4aXQgaWYgY2FuY2VsIG9yIG5vLCBkZWZhdWx0cyB0byBGYWxzZQ0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGJvb2wpOiBUcnVlIGlmIG9rYXksIHllcywgb3IgcmV0cnksIG90aGVyd2lzZSBGYWxzZQ0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLmFsZXJ0X2lmbm90KHZhbHVlID4gMTIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICdBcmUgeW91IHN1cmU/JywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIG9rPUZhbHNlLCB5ZXM9VHJ1ZSwgbm89VHJ1ZSwgZXhpdHNjcmlwdD1UcnVlKQ0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBpZiBub3QgY29uZGl0aW9uOg0KICAgICAgICByZXR1cm4gYWxlcnQobXNnLCAqYXJncywgKiprd2FyZ3MpDQoNCg0KZGVmIHBpY2tfZm9sZGVyKHRpdGxlPU5vbmUsIG93bmVyPU5vbmUpOg0KICAgICIiIlNob3cgc3RhbmRhcmQgd2luZG93cyBwaWNrIGZvbGRlciBkaWFsb2cuDQoNCiAgICBBcmdzOg0KICAgICAgICB0aXRsZSAoc3RyLCBvcHRpb25hbCk6IHRpdGxlIGZvciB0aGUgd2luZG93DQogICAgICAgIG93bmVyIChvYmplY3QsIG9wdGlvbmFsKTogb3duZXIgb2YgdGhlIGRpYWxvZw0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IGZvbGRlciBwYXRoDQogICAgIiIiDQogICAgaWYgQ1BEaWFsb2dzOg0KICAgICAgICBmYl9kbGcgPSBDUERpYWxvZ3MuQ29tbW9uT3BlbkZpbGVEaWFsb2coKQ0KICAgICAgICBmYl9kbGcuSXNGb2xkZXJQaWNrZXIgPSBUcnVlDQogICAgICAgIGlmIHRpdGxlOg0KICAgICAgICAgICAgZmJfZGxnLlRpdGxlID0gdGl0bGUNCg0KICAgICAgICByZXMgPSBDUERpYWxvZ3MuQ29tbW9uRmlsZURpYWxvZ1Jlc3VsdC5DYW5jZWwNCiAgICAgICAgaWYgb3duZXI6DQogICAgICAgICAgICByZXMgPSBmYl9kbGcuU2hvd0RpYWxvZyhvd25lcikNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgIHJlcyA9IGZiX2RsZy5TaG93RGlhbG9nKCkNCg0KICAgICAgICBpZiByZXMgPT0gQ1BEaWFsb2dzLkNvbW1vbkZpbGVEaWFsb2dSZXN1bHQuT2s6DQogICAgICAgICAgICByZXR1cm4gZmJfZGxnLkZpbGVOYW1lDQogICAgZWxzZToNCiAgICAgICAgZmJfZGxnID0gRm9ybXMuRm9sZGVyQnJvd3NlckRpYWxvZygpDQogICAgICAgIGlmIHRpdGxlOg0KICAgICAgICAgICAgZmJfZGxnLkRlc2NyaXB0aW9uID0gdGl0bGUNCiAgICAgICAgaWYgZmJfZGxnLlNob3dEaWFsb2coKSA9PSBGb3Jtcy5EaWFsb2dSZXN1bHQuT0s6DQogICAgICAgICAgICByZXR1cm4gZmJfZGxnLlNlbGVjdGVkUGF0aA0KDQoNCmRlZiByZXN1bHRfaXRlbV9yZXN1bHRfY2xpY2tlZChzZW5kZXIsIGUsIGRlYnVnPUZhbHNlKToNCiAgICAiIiJDYWxsYmFjayBmb3IgYSByZXN1bHQgaXRlbSBjbGljayBldmVudC4iIiINCiAgICBpZiBkZWJ1ZzoNCiAgICAgICAgcHJpbnQoIlJlc3VsdCBjbGlja2VkIikgICMgdXNpbmcgcHJpbnRfbWQgaGVyZSB3aWxsIGJyZWFrIHRoZSBzY3JpcHQNCiAgICBwYXNzDQoNCg0KZGVmIHNob3dfYmFsbG9vbihoZWFkZXIsIHRleHQsIHRvb2x0aXA9JycsIGdyb3VwPScnLCBpc19mYXZvdXJpdGU9RmFsc2UsIGlzX25ldz1GYWxzZSwgdGltZXN0YW1wPU5vbmUsIGNsaWNrX3Jlc3VsdD1yZXN1bHRfaXRlbV9yZXN1bHRfY2xpY2tlZCk6DQogICAgciIiIlNob3cgYmFsbG9uIGluIHRoZSBpbmZvIGNlbnRlciBzZWN0aW9uLg0KDQogICAgQXJnczoNCiAgICAgICAgaGVhZGVyIChzdHIpOiBDYXRlZ29yeSBzZWN0aW9uIChCb2xkKQ0KICAgICAgICB0ZXh0IChzdHIpOiBUaXRsZSBzZWN0aW9uIChSZWd1bGFyKQ0KICAgICAgICB0b29sdGlwIChzdHIpOiBUb29sdGlwDQogICAgICAgIGdyb3VwIChzdHIpOiBHcm91cA0KICAgICAgICBpc19mYXZvdXJpdGUgKGJvb2wpOiBBZGQgYSBibHVlIHN0YXIgYmVmb3JlIGhlYWRlcg0KICAgICAgICBpc19uZXcgKGJvb2wpOiBGbGFnIHRvIG5ldw0KICAgICAgICB0aW1lc3RhbXAgKHN0cik6IFNldCB0aW1lc3RhbXANCiAgICAgICAgY2xpY2tfcmVzdWx0IChkZWYpOiBFeGVjdXRlZCBhZnRlciBhIGNsaWNrIGV2ZW50DQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZyb20gcHlyZXZpdCBpbXBvcnQgZm9ybXMNCiAgICAgICAgZGF0ZSA9ICcyMDE5LTAxLTAxIDAwOjAwOjAwJw0KICAgICAgICBkYXRlID0gZGF0ZXRpbWUuZGF0ZXRpbWUuc3RycHRpbWUoZGF0ZSwgJyVZLSVtLSVkICVIOiVNOiVTJykNCiAgICAgICAgZm9ybXMuc2hvd19iYWxsb29uKCJteSBoZWFkZXIiLCAiTG9yZW0gaXBzdW0iLCB0b29sdGlwPSd0b29sdGlwJywgICBncm91cD0nZ3JvdXAnLCBpc19mYXZvdXJpdGU9VHJ1ZSwgaXNfbmV3PVRydWUsIHRpbWVzdGFtcCA9IGRhdGUsIGNsaWNrX3Jlc3VsdCA9IGZvcm1zLnJlc3VsdF9pdGVtX3Jlc3VsdF9jbGlja2VkKQ0KICAgICAgICBgYGANCiAgICAiIiINCiAgICByZXN1bHRfaXRlbSA9IEF1dG9kZXNrLkludGVybmFsLkluZm9DZW50ZXIuUmVzdWx0SXRlbSgpDQogICAgcmVzdWx0X2l0ZW0uQ2F0ZWdvcnkgPSBoZWFkZXINCiAgICByZXN1bHRfaXRlbS5UaXRsZSA9IHRleHQNCiAgICByZXN1bHRfaXRlbS5Ub29sdGlwVGV4dCA9IHRvb2x0aXANCiAgICByZXN1bHRfaXRlbS5Hcm91cCA9IGdyb3VwDQogICAgcmVzdWx0X2l0ZW0uSXNGYXZvcml0ZSA9IGlzX2Zhdm91cml0ZQ0KICAgIHJlc3VsdF9pdGVtLklzTmV3ID0gaXNfbmV3DQogICAgaWYgdGltZXN0YW1wOg0KICAgICAgICByZXN1bHRfaXRlbS5UaW1lc3RhbXAgPSB0aW1lc3RhbXANCiAgICByZXN1bHRfaXRlbS5SZXN1bHRDbGlja2VkICs9IGNsaWNrX3Jlc3VsdA0KICAgIGJhbGxvb24gPSBBdXRvZGVzay5XaW5kb3dzLkNvbXBvbmVudE1hbmFnZXIuSW5mb0NlbnRlclBhbGV0dGVNYW5hZ2VyLlNob3dCYWxsb29uKA0KICAgICAgICByZXN1bHRfaXRlbSkNCiAgICByZXR1cm4gYmFsbG9vbg0KDQoNCmRlZiBwaWNrX2ZpbGUoZmlsZV9leHQ9JyonLCBmaWxlc19maWx0ZXI9JycsIGluaXRfZGlyPScnLA0KICAgICAgICAgICAgICByZXN0b3JlX2Rpcj1UcnVlLCBtdWx0aV9maWxlPUZhbHNlLCB1bmNfcGF0aHM9RmFsc2UsIHRpdGxlPU5vbmUpOg0KICAgIHIiIiJQaWNrIGZpbGUgZGlhbG9nIHRvIHNlbGVjdCBhIGRlc3RpbmF0aW9uIGZpbGUuDQoNCiAgICBBcmdzOg0KICAgICAgICBmaWxlX2V4dCAoc3RyKTogZmlsZSBleHRlbnNpb24NCiAgICAgICAgZmlsZXNfZmlsdGVyIChzdHIpOiBmaWxlIGZpbHRlcg0KICAgICAgICBpbml0X2RpciAoc3RyKTogaW5pdGlhbCBkaXJlY3RvcnkNCiAgICAgICAgcmVzdG9yZV9kaXIgKGJvb2wpOiByZXN0b3JlIGxhc3QgZGlyZWN0b3J5DQogICAgICAgIG11bHRpX2ZpbGUgKGJvb2wpOiBhbGxvdyBzZWxlY3QgbXVsdGlwbGUgZmlsZXMNCiAgICAgICAgdW5jX3BhdGhzIChib29sKTogcmV0dXJuIHVuYyBwYXRocw0KICAgICAgICB0aXRsZSAoc3RyKTogdGV4dCB0byBzaG93IGluIHRoZSB0aXRsZSBiYXINCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIgfCBsaXN0W3N0cl0pOiBmaWxlIHBhdGggb3IgbGlzdCBvZiBmaWxlIHBhdGhzIGlmIG11bHRpX2ZpbGU9VHJ1ZQ0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLnBpY2tfZmlsZShmaWxlX2V4dD0nY3N2JykNCiAgICAgICAgcidDOlxvdXRwdXRcc29tZWZpbGUuY3N2Jw0KICAgICAgICBgYGANCg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZm9ybXMucGlja19maWxlKGZpbGVfZXh0PSdjc3YnLCBtdWx0aV9maWxlPVRydWUpDQogICAgICAgIFtyJ0M6XG91dHB1dFxzb21lZmlsZTEuY3N2JywgcidDOlxvdXRwdXRcc29tZWZpbGUyLmNzdiddDQogICAgICAgIGBgYA0KDQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmb3Jtcy5waWNrX2ZpbGUoZmlsZXNfZmlsdGVyPSdBbGwgRmlsZXMgKCouKil8Ki4qfCcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0V4Y2VsIFdvcmtib29rICgqLnhsc3gpfCoueGxzeHwnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFeGNlbCA5Ny0yMDAzIFdvcmtib29rfCoueGxzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdWx0aV9maWxlPVRydWUpDQogICAgICAgIFtyJ0M6XG91dHB1dFxzb21lZmlsZTEueGxzeCcsIHInQzpcb3V0cHV0XHNvbWVmaWxlMi54bHMnXQ0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBvZl9kbGcgPSBGb3Jtcy5PcGVuRmlsZURpYWxvZygpDQogICAgaWYgZmlsZXNfZmlsdGVyOg0KICAgICAgICBvZl9kbGcuRmlsdGVyID0gZmlsZXNfZmlsdGVyDQogICAgZWxzZToNCiAgICAgICAgb2ZfZGxnLkZpbHRlciA9ICd8Ki57fScuZm9ybWF0KGZpbGVfZXh0KQ0KICAgIG9mX2RsZy5SZXN0b3JlRGlyZWN0b3J5ID0gcmVzdG9yZV9kaXINCiAgICBvZl9kbGcuTXVsdGlzZWxlY3QgPSBtdWx0aV9maWxlDQogICAgaWYgaW5pdF9kaXI6DQogICAgICAgIG9mX2RsZy5Jbml0aWFsRGlyZWN0b3J5ID0gaW5pdF9kaXINCiAgICBpZiB0aXRsZToNCiAgICAgICAgb2ZfZGxnLlRpdGxlID0gdGl0bGUNCiAgICBpZiBvZl9kbGcuU2hvd0RpYWxvZygpID09IEZvcm1zLkRpYWxvZ1Jlc3VsdC5PSzoNCiAgICAgICAgaWYgbXVsdGlfZmlsZToNCiAgICAgICAgICAgIGlmIHVuY19wYXRoczoNCiAgICAgICAgICAgICAgICByZXR1cm4gW2NvcmV1dGlscy5kbGV0dGVyX3RvX3VuYyh4KQ0KICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHggaW4gb2ZfZGxnLkZpbGVOYW1lc10NCiAgICAgICAgICAgIHJldHVybiBvZl9kbGcuRmlsZU5hbWVzDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBpZiB1bmNfcGF0aHM6DQogICAgICAgICAgICAgICAgcmV0dXJuIGNvcmV1dGlscy5kbGV0dGVyX3RvX3VuYyhvZl9kbGcuRmlsZU5hbWUpDQogICAgICAgICAgICByZXR1cm4gb2ZfZGxnLkZpbGVOYW1lDQoNCg0KZGVmIHNhdmVfZmlsZShmaWxlX2V4dD0nJywgZmlsZXNfZmlsdGVyPScnLCBpbml0X2Rpcj0nJywgZGVmYXVsdF9uYW1lPScnLA0KICAgICAgICAgICAgICByZXN0b3JlX2Rpcj1UcnVlLCB1bmNfcGF0aHM9RmFsc2UsIHRpdGxlPU5vbmUpOg0KICAgIHIiIiJTYXZlIGZpbGUgZGlhbG9nIHRvIHNlbGVjdCBhIGRlc3RpbmF0aW9uIGZpbGUgZm9yIGRhdGEuDQoNCiAgICBBcmdzOg0KICAgICAgICBmaWxlX2V4dCAoc3RyKTogZmlsZSBleHRlbnNpb24NCiAgICAgICAgZmlsZXNfZmlsdGVyIChzdHIpOiBmaWxlIGZpbHRlcg0KICAgICAgICBpbml0X2RpciAoc3RyKTogaW5pdGlhbCBkaXJlY3RvcnkNCiAgICAgICAgZGVmYXVsdF9uYW1lIChzdHIpOiBkZWZhdWx0IGZpbGUgbmFtZQ0KICAgICAgICByZXN0b3JlX2RpciAoYm9vbCk6IHJlc3RvcmUgbGFzdCBkaXJlY3RvcnkNCiAgICAgICAgdW5jX3BhdGhzIChib29sKTogcmV0dXJuIHVuYyBwYXRocw0KICAgICAgICB0aXRsZSAoc3RyKTogdGV4dCB0byBzaG93IGluIHRoZSB0aXRsZSBiYXINCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIpOiBmaWxlIHBhdGgNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBmb3Jtcy5zYXZlX2ZpbGUoZmlsZV9leHQ9J2NzdicpDQogICAgICAgIHInQzpcb3V0cHV0XHNvbWVmaWxlLmNzdicNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgc2ZfZGxnID0gRm9ybXMuU2F2ZUZpbGVEaWFsb2coKQ0KICAgIGlmIGZpbGVzX2ZpbHRlcjoNCiAgICAgICAgc2ZfZGxnLkZpbHRlciA9IGZpbGVzX2ZpbHRlcg0KICAgIGVsc2U6DQogICAgICAgIHNmX2RsZy5GaWx0ZXIgPSAnfCoue30nLmZvcm1hdChmaWxlX2V4dCkNCiAgICBzZl9kbGcuUmVzdG9yZURpcmVjdG9yeSA9IHJlc3RvcmVfZGlyDQogICAgaWYgaW5pdF9kaXI6DQogICAgICAgIHNmX2RsZy5Jbml0aWFsRGlyZWN0b3J5ID0gaW5pdF9kaXINCiAgICBpZiB0aXRsZToNCiAgICAgICAgc2ZfZGxnLlRpdGxlID0gdGl0bGUNCg0KICAgICMgc2V0dGluZyBkZWZhdWx0IGZpbGVuYW1lDQogICAgc2ZfZGxnLkZpbGVOYW1lID0gZGVmYXVsdF9uYW1lDQoNCiAgICBpZiBzZl9kbGcuU2hvd0RpYWxvZygpID09IEZvcm1zLkRpYWxvZ1Jlc3VsdC5PSzoNCiAgICAgICAgaWYgdW5jX3BhdGhzOg0KICAgICAgICAgICAgcmV0dXJuIGNvcmV1dGlscy5kbGV0dGVyX3RvX3VuYyhzZl9kbGcuRmlsZU5hbWUpDQogICAgICAgIHJldHVybiBzZl9kbGcuRmlsZU5hbWUNCg0KDQpkZWYgcGlja19leGNlbF9maWxlKHNhdmU9RmFsc2UsIHRpdGxlPU5vbmUpOg0KICAgICIiIkZpbGUgcGljay9zYXZlIGRpYWxvZyBmb3IgYW4gZXhjZWwgZmlsZS4NCg0KICAgIEFyZ3M6DQogICAgICAgIHNhdmUgKGJvb2wpOiBzaG93IGZpbGUgc2F2ZSBkaWFsb2csIGluc3RlYWQgb2YgZmlsZSBwaWNrIGRpYWxvZw0KICAgICAgICB0aXRsZSAoc3RyKTogdGV4dCB0byBzaG93IGluIHRoZSB0aXRsZSBiYXINCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIpOiBmaWxlIHBhdGgNCiAgICAiIiINCiAgICBpZiBzYXZlOg0KICAgICAgICByZXR1cm4gc2F2ZV9maWxlKGZpbGVfZXh0PSd4bHN4JykNCiAgICByZXR1cm4gcGlja19maWxlKGZpbGVzX2ZpbHRlcj0nRXhjZWwgV29ya2Jvb2sgKCoueGxzeCl8Ki54bHN4fCcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnRXhjZWwgOTctMjAwMyBXb3JrYm9va3wqLnhscycsDQogICAgICAgICAgICAgICAgICAgICB0aXRsZT10aXRsZSkNCg0KDQpkZWYgc2F2ZV9leGNlbF9maWxlKHRpdGxlPU5vbmUpOg0KICAgICIiIkZpbGUgc2F2ZSBkaWFsb2cgZm9yIGFuIGV4Y2VsIGZpbGUuDQoNCiAgICBBcmdzOg0KICAgICAgICB0aXRsZSAoc3RyKTogdGV4dCB0byBzaG93IGluIHRoZSB0aXRsZSBiYXINCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIpOiBmaWxlIHBhdGgNCiAgICAiIiINCiAgICByZXR1cm4gcGlja19leGNlbF9maWxlKHNhdmU9VHJ1ZSwgdGl0bGU9dGl0bGUpDQoNCg0KZGVmIGNoZWNrX3dvcmtzaGFyZWQoZG9jPU5vbmUsIG1lc3NhZ2U9J01vZGVsIGlzIG5vdCB3b3Jrc2hhcmVkLicpOg0KICAgICIiIlZlcmlmeSBpZiBtb2RlbCBpcyB3b3Jrc2hhcmVkIGFuZCBub3RpZnkgdXNlciBpZiBub3QuDQoNCiAgICBBcmdzOg0KICAgICAgICBkb2MgKERCLkRvY3VtZW50KTogdGFyZ2V0IGRvY3VtZW50LCBjdXJyZW50IG9mIG5vdCBwcm92aWRlZA0KICAgICAgICBtZXNzYWdlIChzdHIpOiBwcm9tcHQgbWVzc2FnZSBpZiByZXR1cm5pbmcgRmFsc2UNCg0KICAgIFJldHVybnM6DQogICAgICAgIChib29sKTogVHJ1ZSBpZiBkb2MgaXMgd29ya3NoYXJlZA0KICAgICIiIg0KICAgIGRvYyA9IGRvYyBvciBET0NTLmRvYw0KICAgIGlmIG5vdCBkb2MuSXNXb3Jrc2hhcmVkOg0KICAgICAgICBhbGVydChtZXNzYWdlLCB3YXJuX2ljb249VHJ1ZSkNCiAgICAgICAgcmV0dXJuIEZhbHNlDQogICAgcmV0dXJuIFRydWUNCg0KDQpkZWYgY2hlY2tfc2VsZWN0aW9uKGV4aXRzY3JpcHQ9RmFsc2UsDQogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U9J0F0IGxlYXN0IG9uZSBlbGVtZW50IG11c3QgYmUgc2VsZWN0ZWQuJyk6DQogICAgIiIiVmVyaWZ5IGlmIHNlbGVjdGlvbiBpcyBub3QgZW1wdHkgbm90aWZ5IHVzZXIgaWYgaXQgaXMuDQoNCiAgICBBcmdzOg0KICAgICAgICBleGl0c2NyaXB0IChib29sKTogZXhpdCBzY3JpcHQgaWYgcmV0dXJuaW5nIEZhbHNlDQogICAgICAgIG1lc3NhZ2UgKHN0cik6IHByb21wdCBtZXNzYWdlIGlmIHJldHVybmluZyBGYWxzZQ0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGJvb2wpOiBUcnVlIGlmIHNlbGVjdGlvbiBoYXMgYXQgbGVhc3Qgb25lIGl0ZW0NCiAgICAiIiINCiAgICBpZiByZXZpdC5nZXRfc2VsZWN0aW9uKCkuaXNfZW1wdHk6DQogICAgICAgIGFsZXJ0KG1lc3NhZ2UsIGV4aXRzY3JpcHQ9ZXhpdHNjcmlwdCkNCiAgICAgICAgcmV0dXJuIEZhbHNlDQogICAgcmV0dXJuIFRydWUNCg0KDQpkZWYgY2hlY2tfZmFtaWx5ZG9jKGRvYz1Ob25lLCBmYW1pbHlfY2F0PU5vbmUsIGV4aXRzY3JpcHQ9RmFsc2UpOg0KICAgICIiIlZlcmlmeSBkb2N1bWVudCBpcyBhIEZhbWlseSBhbmQgbm90aWZ5IHVzZXIgaWYgbm90Lg0KDQogICAgQXJnczoNCiAgICAgICAgZG9jIChEQi5Eb2N1bWVudCk6IHRhcmdldCBkb2N1bWVudCwgY3VycmVudCBvZiBub3QgcHJvdmlkZWQNCiAgICAgICAgZmFtaWx5X2NhdCAoc3RyKTogZmFtaWx5IGNhdGVnb3J5IG5hbWUNCiAgICAgICAgZXhpdHNjcmlwdCAoYm9vbCk6IGV4aXQgc2NyaXB0IGlmIHJldHVybmluZyBGYWxzZQ0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGJvb2wpOiBUcnVlIGlmIGRvYyBpcyBhIEZhbWlseSBhbmQgb2YgcHJvdmlkZWQgY2F0ZWdvcnkNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBmb3Jtcy5jaGVja19mYW1pbHlkb2MoZG9jPXJldml0LmRvYywgZmFtaWx5X2NhdD0nRGF0YSBEZXZpY2VzJykNCiAgICAgICAgVHJ1ZQ0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBkb2MgPSBkb2Mgb3IgRE9DUy5kb2MNCiAgICBmYW1pbHlfY2F0ID0gcmV2aXQucXVlcnkuZ2V0X2NhdGVnb3J5KGZhbWlseV9jYXQpDQogICAgaWYgZG9jLklzRmFtaWx5RG9jdW1lbnQgYW5kIGZhbWlseV9jYXQ6DQogICAgICAgIGlmIGRvYy5Pd25lckZhbWlseS5GYW1pbHlDYXRlZ29yeS5JZCA9PSBmYW1pbHlfY2F0LklkOg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICBlbGlmIGRvYy5Jc0ZhbWlseURvY3VtZW50IGFuZCBub3QgZmFtaWx5X2NhdDoNCiAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgIGZhbWlseV90eXBlX21zZyA9ICcgb2YgdHlwZSB7fSdcDQogICAgICAgICAgICAgICAgICAgICAgLmZvcm1hdChmYW1pbHlfY2F0Lk5hbWUpIGlmIGZhbWlseV9jYXQgZWxzZScnDQogICAgYWxlcnQoJ0FjdGl2ZSBkb2N1bWVudCBtdXN0IGJlIGEgRmFtaWx5IGRvY3VtZW50e30uJw0KICAgICAgICAgIC5mb3JtYXQoZmFtaWx5X3R5cGVfbXNnKSwgZXhpdHNjcmlwdD1leGl0c2NyaXB0KQ0KICAgIHJldHVybiBGYWxzZQ0KDQoNCmRlZiBjaGVja19tb2RlbGRvYyhkb2M9Tm9uZSwgZXhpdHNjcmlwdD1GYWxzZSk6DQogICAgIiIiVmVyaWZ5IGRvY3VtZW50IGlzIGEgbm90IGEgTW9kZWwgYW5kIG5vdGlmeSB1c2VyIGlmIG5vdC4NCg0KICAgIEFyZ3M6DQogICAgICAgIGRvYyAoREIuRG9jdW1lbnQpOiB0YXJnZXQgZG9jdW1lbnQsIGN1cnJlbnQgb2Ygbm90IHByb3ZpZGVkDQogICAgICAgIGV4aXRzY3JpcHQgKGJvb2wpOiBleGl0IHNjcmlwdCBpZiByZXR1cm5pbmcgRmFsc2UNCg0KICAgIFJldHVybnM6DQogICAgICAgIChib29sKTogVHJ1ZSBpZiBkb2MgaXMgYSBNb2RlbA0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLmNoZWNrX21vZGVsZG9jKGRvYz1yZXZpdC5kb2MpDQogICAgICAgIFRydWUNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgZG9jID0gZG9jIG9yIERPQ1MuZG9jDQogICAgaWYgbm90IGRvYy5Jc0ZhbWlseURvY3VtZW50Og0KICAgICAgICByZXR1cm4gVHJ1ZQ0KDQogICAgYWxlcnQoJ0FjdGl2ZSBkb2N1bWVudCBtdXN0IGJlIGEgUmV2aXQgbW9kZWwgKG5vdCBhIEZhbWlseSkuJywNCiAgICAgICAgICBleGl0c2NyaXB0PWV4aXRzY3JpcHQpDQogICAgcmV0dXJuIEZhbHNlDQoNCg0KZGVmIGNoZWNrX21vZGVsdmlldyh2aWV3LCBleGl0c2NyaXB0PUZhbHNlKToNCiAgICAiIiJWZXJpZnkgdGFyZ2V0IHZpZXcgaXMgYSBtb2RlbCB2aWV3Lg0KDQogICAgQXJnczoNCiAgICAgICAgdmlldyAoREIuVmlldyk6IHRhcmdldCB2aWV3DQogICAgICAgIGV4aXRzY3JpcHQgKGJvb2wpOiBleGl0IHNjcmlwdCBpZiByZXR1cm5pbmcgRmFsc2UNCg0KICAgIFJldHVybnM6DQogICAgICAgIChib29sKTogVHJ1ZSBpZiB2aWV3IGlzIG1vZGVsIHZpZXcNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBmb3Jtcy5jaGVja19tb2RlbHZpZXcodmlldz1yZXZpdC5hY3RpdmVfdmlldykNCiAgICAgICAgVHJ1ZQ0KICAgICAgICBgYGANCiAgICAiIiINCiAgICBpZiBub3QgaXNpbnN0YW5jZSh2aWV3LCAoREIuVmlldzNELCBEQi5WaWV3UGxhbiwgREIuVmlld1NlY3Rpb24pKToNCiAgICAgICAgYWxlcnQoIkFjdGl2ZSB2aWV3IG11c3QgYmUgYSBtb2RlbCB2aWV3LiIsIGV4aXRzY3JpcHQ9ZXhpdHNjcmlwdCkNCiAgICAgICAgcmV0dXJuIEZhbHNlDQogICAgcmV0dXJuIFRydWUNCg0KDQpkZWYgY2hlY2tfdmlld3R5cGUodmlldywgdmlld190eXBlLCBleGl0c2NyaXB0PUZhbHNlKToNCiAgICAiIiJWZXJpZnkgdGFyZ2V0IHZpZXcgaXMgb2YgZ2l2ZW4gdHlwZS4NCg0KICAgIEFyZ3M6DQogICAgICAgIHZpZXcgKERCLlZpZXcpOiB0YXJnZXQgdmlldw0KICAgICAgICB2aWV3X3R5cGUgKERCLlZpZXdUeXBlKTogdHlwZSBvZiB2aWV3DQogICAgICAgIGV4aXRzY3JpcHQgKGJvb2wpOiBleGl0IHNjcmlwdCBpZiByZXR1cm5pbmcgRmFsc2UNCg0KICAgIFJldHVybnM6DQogICAgICAgIChib29sKTogVHJ1ZSBpZiB2aWV3IGlzIG9mIGdpdmVuIHR5cGUNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0IGltcG9ydCBmb3Jtcw0KICAgICAgICBmb3Jtcy5jaGVja192aWV3dHlwZShyZXZpdC5hY3RpdmVfdmlldywgREIuVmlld1R5cGUuRHJhd2luZ1NoZWV0KQ0KICAgICAgICBUcnVlDQogICAgICAgIGBgYA0KICAgICIiIg0KICAgIGlmIHZpZXcuVmlld1R5cGUgIT0gdmlld190eXBlOg0KICAgICAgICBhbGVydCgNCiAgICAgICAgICAgICJBY3RpdmUgdmlldyBtdXN0IGJlIGEge30uIi5mb3JtYXQoDQogICAgICAgICAgICAgICAgJyAnLmpvaW4oY29yZXV0aWxzLnNwbGl0X3dvcmRzKHN0cih2aWV3X3R5cGUpKSkpLA0KICAgICAgICAgICAgZXhpdHNjcmlwdD1leGl0c2NyaXB0DQogICAgICAgICAgICApDQogICAgICAgIHJldHVybiBGYWxzZQ0KICAgIHJldHVybiBUcnVlDQoNCg0KZGVmIGNoZWNrX2dyYXBoaWNhbHZpZXcodmlldywgZXhpdHNjcmlwdD1GYWxzZSk6DQogICAgIiIiVmVyaWZ5IHRhcmdldCB2aWV3IGlzIGEgZ3JhcGhpY2FsIHZpZXcuDQoNCiAgICBBcmdzOg0KICAgICAgICB2aWV3IChEQi5WaWV3KTogdGFyZ2V0IHZpZXcNCiAgICAgICAgZXhpdHNjcmlwdCAoYm9vbCk6IGV4aXQgc2NyaXB0IGlmIHJldHVybmluZyBGYWxzZQ0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKGJvb2wpOiBUcnVlIGlmIHZpZXcgaXMgYSBncmFwaGljYWwgdmlldw0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IGZvcm1zDQogICAgICAgIGZvcm1zLmNoZWNrX2dyYXBoaWNhbHZpZXcocmV2aXQuYWN0aXZlX3ZpZXcpDQogICAgICAgIFRydWUNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgaWYgbm90IHZpZXcuQ2F0ZWdvcnk6DQogICAgICAgIGFsZXJ0KA0KICAgICAgICAgICAgIkFjdGl2ZSB2aWV3IG11c3QgYmUgYSBncmFoaWNhbCB2aWV3LiIsDQogICAgICAgICAgICBleGl0c2NyaXB0PWV4aXRzY3JpcHQNCiAgICAgICAgICAgICkNCiAgICAgICAgcmV0dXJuIEZhbHNlDQogICAgcmV0dXJuIFRydWUNCg0KDQpkZWYgdG9hc3QobWVzc2FnZSwgdGl0bGU9J3B5UmV2aXQnLCBhcHBpZD0ncHlSZXZpdCcsDQogICAgICAgICAgaWNvbj1Ob25lLCBjbGljaz1Ob25lLCBhY3Rpb25zPU5vbmUpOg0KICAgICIiIlNob3cgYSBXaW5kb3dzIDEwIG5vdGlmaWNhdGlvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIG1lc3NhZ2UgKHN0cik6IG5vdGlmaWNhdGlvbiBtZXNzYWdlDQogICAgICAgIHRpdGxlIChzdHIpOiBub3RpZmljYXRpb24gdGl0bGUNCiAgICAgICAgYXBwaWQgKHN0cik6IGFwcCBuYW1lICh3aWxsIHNob3cgdW5kZXIgbWVzc2FnZSkNCiAgICAgICAgaWNvbiAoc3RyKTogZmlsZSBwYXRoIHRvIGljb24gLmljbyBmaWxlIChkZWZhdWx0cyB0byBweVJldml0IGljb24pDQogICAgICAgIGNsaWNrIChzdHIpOiBjbGljayBhY3Rpb24gY29tbWFuZHMgc3RyaW5nDQogICAgICAgIGFjdGlvbnMgKGRpY3QpOiBkaWN0aW9uYXJ5IG9mIGJ1dHRvbiBuYW1lcyBhbmQgYWN0aW9uIHN0cmluZ3MNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgc2NyaXB0LnRvYXN0KCJIZWxsbyBXb3JsZCEiLA0KICAgICAgICAgICAgICAgICAgICAgdGl0bGU9Ik15IFNjcmlwdCIsDQogICAgICAgICAgICAgICAgICAgICBhcHBpZD0iTXlBUFAiLA0KICAgICAgICAgICAgICAgICAgICAgY2xpY2s9Imh0dHBzOi8vZWlyYW5uZWphZC5naXRodWIuaW8vcHlSZXZpdC8iLA0KICAgICAgICAgICAgICAgICAgICAgYWN0aW9ucz17DQogICAgICAgICAgICAgICAgICAgICAgICAgIk9wZW4gR29vZ2xlIjoiaHR0cHM6Ly9nb29nbGUuY29tIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAiT3BlbiBUb2FzdDY0IjoiaHR0cHM6Ly9naXRodWIuY29tL2dvLXRvYXN0L3RvYXN0Ig0KICAgICAgICAgICAgICAgICAgICAgICAgIH0pDQogICAgICAgIGBgYA0KICAgICIiIg0KICAgIHRvYXN0ZXIuc2VuZF90b2FzdCgNCiAgICAgICAgbWVzc2FnZSwNCiAgICAgICAgdGl0bGU9dGl0bGUsDQogICAgICAgIGFwcGlkPWFwcGlkLA0KICAgICAgICBpY29uPWljb24sDQogICAgICAgIGNsaWNrPWNsaWNrLA0KICAgICAgICBhY3Rpb25zPWFjdGlvbnMpDQoNCg0KZGVmIGFza19mb3Jfc3RyaW5nKGRlZmF1bHQ9Tm9uZSwgcHJvbXB0PU5vbmUsIHRpdGxlPU5vbmUsICoqa3dhcmdzKToNCiAgICAiIiJBc2sgdXNlciB0byBzZWxlY3QgYSBzdHJpbmcgdmFsdWUuDQoNCiAgICBUaGlzIGlzIGEgc2hvcnRjdXQgZnVuY3Rpb24gdGhhdCBjb25maWd1cmVzIDpvYmo6YEdldFZhbHVlV2luZG93YCBmb3INCiAgICBzdHJpbmcgZGF0YSB0eXBlcy4ga3dhcmdzIGNhbiBiZSB1c2VkIHRvIHBhc3Mgb24gb3RoZXIgYXJndW1lbnRzLg0KDQogICAgQXJnczoNCiAgICAgICAgZGVmYXVsdCAoc3RyKTogZGVmYXVsdCB1bmlxdWUgc3RyaW5nLiBtdXN0IG5vdCBiZSBpbiByZXNlcnZlZF92YWx1ZXMNCiAgICAgICAgcHJvbXB0IChzdHIpOiBwcm9tcHQgbWVzc2FnZQ0KICAgICAgICB0aXRsZSAoc3RyKTogdGl0bGUgbWVzc2FnZQ0KICAgICAgICBrd2FyZ3MgKHR5cGUpOiBvdGhlciBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIDpvYmo6YEdldFZhbHVlV2luZG93YA0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IHNlbGVjdGVkIHN0cmluZyB2YWx1ZQ0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmb3Jtcy5hc2tfZm9yX3N0cmluZygNCiAgICAgICAgICAgIGRlZmF1bHQ9J3NvbWUtdGFnJywNCiAgICAgICAgICAgIHByb21wdD0nRW50ZXIgbmV3IHRhZyBuYW1lOicsDQogICAgICAgICAgICB0aXRsZT0nVGFnIE1hbmFnZXInKQ0KICAgICAgICAnbmV3LXRhZycNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgcmV0dXJuIEdldFZhbHVlV2luZG93LnNob3coDQogICAgICAgIE5vbmUsDQogICAgICAgIHZhbHVlX3R5cGU9J3N0cmluZycsDQogICAgICAgIGRlZmF1bHQ9ZGVmYXVsdCwNCiAgICAgICAgcHJvbXB0PXByb21wdCwNCiAgICAgICAgdGl0bGU9dGl0bGUsDQogICAgICAgICoqa3dhcmdzDQogICAgICAgICkNCg0KDQpkZWYgYXNrX2Zvcl91bmlxdWVfc3RyaW5nKHJlc2VydmVkX3ZhbHVlcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdD1Ob25lLCBwcm9tcHQ9Tm9uZSwgdGl0bGU9Tm9uZSwgKiprd2FyZ3MpOg0KICAgICIiIkFzayB1c2VyIHRvIHNlbGVjdCBhIHVuaXF1ZSBzdHJpbmcgdmFsdWUuDQoNCiAgICBUaGlzIGlzIGEgc2hvcnRjdXQgZnVuY3Rpb24gdGhhdCBjb25maWd1cmVzIDpvYmo6YEdldFZhbHVlV2luZG93YCBmb3INCiAgICB1bmlxdWUgc3RyaW5nIGRhdGEgdHlwZXMuIGt3YXJncyBjYW4gYmUgdXNlZCB0byBwYXNzIG9uIG90aGVyIGFyZ3VtZW50cy4NCg0KICAgIEFyZ3M6DQogICAgICAgIHJlc2VydmVkX3ZhbHVlcyAobGlzdFtzdHJdKTogbGlzdCBvZiByZXNlcnZlZCAoZm9yYmlkZGVuKSB2YWx1ZXMNCiAgICAgICAgZGVmYXVsdCAoc3RyKTogZGVmYXVsdCB1bmlxdWUgc3RyaW5nLiBtdXN0IG5vdCBiZSBpbiByZXNlcnZlZF92YWx1ZXMNCiAgICAgICAgcHJvbXB0IChzdHIpOiBwcm9tcHQgbWVzc2FnZQ0KICAgICAgICB0aXRsZSAoc3RyKTogdGl0bGUgbWVzc2FnZQ0KICAgICAgICBrd2FyZ3MgKHR5cGUpOiBvdGhlciBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIDpvYmo6YEdldFZhbHVlV2luZG93YA0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IHNlbGVjdGVkIHVuaXF1ZSBzdHJpbmcNCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZm9ybXMuYXNrX2Zvcl91bmlxdWVfc3RyaW5nKA0KICAgICAgICAgICAgcHJvbXB0PSdFbnRlciBhIFVuaXF1ZSBOYW1lJywNCiAgICAgICAgICAgIHRpdGxlPXNlbGYuVGl0bGUsDQogICAgICAgICAgICByZXNlcnZlZF92YWx1ZXM9WydFaHNhbicsICdHdWknLCAnR3VpZG8nXSwNCiAgICAgICAgICAgIG93bmVyPXNlbGYpDQogICAgICAgICd1bmlxdWUgc3RyaW5nJw0KICAgICAgICBgYGANCg0KICAgICAgICBJbiBleGFtcGxlIGFib3ZlLCBvd25lciBhcmd1bWVudCBpcyBwcm92aWRlZCB0byBiZSBwYXNzZWQgdG8gdW5kZXJseWluZw0KICAgICAgICA6b2JqOmBHZXRWYWx1ZVdpbmRvd2AuDQoNCiAgICAiIiINCiAgICByZXR1cm4gR2V0VmFsdWVXaW5kb3cuc2hvdygNCiAgICAgICAgTm9uZSwNCiAgICAgICAgdmFsdWVfdHlwZT0nc3RyaW5nJywNCiAgICAgICAgZGVmYXVsdD1kZWZhdWx0LA0KICAgICAgICBwcm9tcHQ9cHJvbXB0LA0KICAgICAgICB0aXRsZT10aXRsZSwNCiAgICAgICAgcmVzZXJ2ZWRfdmFsdWVzPXJlc2VydmVkX3ZhbHVlcywNCiAgICAgICAgKiprd2FyZ3MNCiAgICAgICAgKQ0KDQoNCmRlZiBhc2tfZm9yX29uZV9pdGVtKGl0ZW1zLCBkZWZhdWx0PU5vbmUsIHByb21wdD1Ob25lLCB0aXRsZT1Ob25lLCAqKmt3YXJncyk6DQogICAgIiIiQXNrIHVzZXIgdG8gc2VsZWN0IGFuIGl0ZW0gZnJvbSBhIGxpc3Qgb2YgaXRlbXMuDQoNCiAgICBUaGlzIGlzIGEgc2hvcnRjdXQgZnVuY3Rpb24gdGhhdCBjb25maWd1cmVzIDpvYmo6YEdldFZhbHVlV2luZG93YCBmb3INCiAgICAnc2luZ2xlLXNlbGVjdCcgZGF0YSB0eXBlcy4ga3dhcmdzIGNhbiBiZSB1c2VkIHRvIHBhc3Mgb24gb3RoZXIgYXJndW1lbnRzLg0KDQogICAgQXJnczoNCiAgICAgICAgaXRlbXMgKGxpc3Rbc3RyXSk6IGxpc3Qgb2YgaXRlbXMgdG8gY2hvb3NlIGZyb20NCiAgICAgICAgZGVmYXVsdCAoc3RyKTogZGVmYXVsdCBzZWxlY3RlZCBpdGVtDQogICAgICAgIHByb21wdCAoc3RyKTogcHJvbXB0IG1lc3NhZ2UNCiAgICAgICAgdGl0bGUgKHN0cik6IHRpdGxlIG1lc3NhZ2UNCiAgICAgICAga3dhcmdzICh0eXBlKTogb3RoZXIgYXJndW1lbnRzIHRvIGJlIHBhc3NlZCB0byA6b2JqOmBHZXRWYWx1ZVdpbmRvd2ANCg0KICAgIFJldHVybnM6DQogICAgICAgIChzdHIpOiBzZWxlY3RlZCBpdGVtDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZvcm1zLmFza19mb3Jfb25lX2l0ZW0oDQogICAgICAgICAgICBbJ3Rlc3QgaXRlbSAxJywgJ3Rlc3QgaXRlbSAyJywgJ3Rlc3QgaXRlbSAzJ10sDQogICAgICAgICAgICBkZWZhdWx0PSd0ZXN0IGl0ZW0gMicsDQogICAgICAgICAgICBwcm9tcHQ9J3Rlc3QgcHJvbXB0JywNCiAgICAgICAgICAgIHRpdGxlPSd0ZXN0IHRpdGxlJw0KICAgICAgICApDQogICAgICAgICd0ZXN0IGl0ZW0gMScNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgcmV0dXJuIEdldFZhbHVlV2luZG93LnNob3coDQogICAgICAgIGl0ZW1zLA0KICAgICAgICB2YWx1ZV90eXBlPSdkcm9wZG93bicsDQogICAgICAgIGRlZmF1bHQ9ZGVmYXVsdCwNCiAgICAgICAgcHJvbXB0PXByb21wdCwNCiAgICAgICAgdGl0bGU9dGl0bGUsDQogICAgICAgICoqa3dhcmdzDQogICAgICAgICkNCg0KDQpkZWYgYXNrX2Zvcl9kYXRlKGRlZmF1bHQ9Tm9uZSwgcHJvbXB0PU5vbmUsIHRpdGxlPU5vbmUsICoqa3dhcmdzKToNCiAgICAiIiJBc2sgdXNlciB0byBzZWxlY3QgYSBkYXRlIHZhbHVlLg0KDQogICAgVGhpcyBpcyBhIHNob3J0Y3V0IGZ1bmN0aW9uIHRoYXQgY29uZmlndXJlcyA6b2JqOmBHZXRWYWx1ZVdpbmRvd2AgZm9yDQogICAgZGF0ZSBkYXRhIHR5cGVzLiBrd2FyZ3MgY2FuIGJlIHVzZWQgdG8gcGFzcyBvbiBvdGhlciBhcmd1bWVudHMuDQoNCiAgICBBcmdzOg0KICAgICAgICBkZWZhdWx0IChkYXRldGltZS5kYXRldGltZSk6IGRlZmF1bHQgc2VsZWN0ZWQgZGF0ZSB2YWx1ZQ0KICAgICAgICBwcm9tcHQgKHN0cik6IHByb21wdCBtZXNzYWdlDQogICAgICAgIHRpdGxlIChzdHIpOiB0aXRsZSBtZXNzYWdlDQogICAgICAgIGt3YXJncyAodHlwZSk6IG90aGVyIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gOm9iajpgR2V0VmFsdWVXaW5kb3dgDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoZGF0ZXRpbWUuZGF0ZXRpbWUpOiBzZWxlY3RlZCBkYXRlDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZvcm1zLmFza19mb3JfZGF0ZShkZWZhdWx0PSIiLCB0aXRsZT0iRW50ZXIgZGVhZGxpbmU6IikNCiAgICAgICAgZGF0ZXRpbWUuZGF0ZXRpbWUoMjAxOSwgNSwgMTcsIDAsIDApDQogICAgICAgIGBgYA0KICAgICIiIg0KICAgICMgRklYTUU6IHdpbmRvdyBkb2VzIG5vdCBzZXQgZGVmYXVsdCB2YWx1ZQ0KICAgIHJldHVybiBHZXRWYWx1ZVdpbmRvdy5zaG93KA0KICAgICAgICBOb25lLA0KICAgICAgICB2YWx1ZV90eXBlPSdkYXRlJywNCiAgICAgICAgZGVmYXVsdD1kZWZhdWx0LA0KICAgICAgICBwcm9tcHQ9cHJvbXB0LA0KICAgICAgICB0aXRsZT10aXRsZSwNCiAgICAgICAgKiprd2FyZ3MNCiAgICAgICAgKQ0KDQoNCmRlZiBhc2tfZm9yX251bWJlcl9zbGlkZXIoZGVmYXVsdD1Ob25lLCBtaW49MCwgbWF4PTEwMCwgaW50ZXJ2YWw9MSwgcHJvbXB0PU5vbmUsIHRpdGxlPU5vbmUsICoqa3dhcmdzKToNCiAgICAiIiJBc2sgdXNlciB0byBzZWxlY3QgYSBudW1iZXIgdmFsdWUuDQoNCiAgICBUaGlzIGlzIGEgc2hvcnRjdXQgZnVuY3Rpb24gdGhhdCBjb25maWd1cmVzIDpvYmo6YEdldFZhbHVlV2luZG93YCBmb3INCiAgICBudW1iZXJzLiBrd2FyZ3MgY2FuIGJlIHVzZWQgdG8gcGFzcyBvbiBvdGhlciBhcmd1bWVudHMuDQoNCiAgICBBcmdzOg0KICAgICAgICBkZWZhdWx0IChzdHIpOiBkZWZhdWx0IHVuaXF1ZSBzdHJpbmcuIG11c3Qgbm90IGJlIGluIHJlc2VydmVkX3ZhbHVlcw0KICAgICAgICBtaW4gKGludCk6IG1pbmltdW0gdmFsdWUgb24gc2xpZGVyDQogICAgICAgIG1heCAoaW50KTogbWF4aW11bSB2YWx1ZSBvbiBzbGlkZXINCiAgICAgICAgaW50ZXJ2YWwgKGludCk6IG51bWJlciBpbnRlcnZhbCBiZXR3ZWVuIHZhbHVlcw0KICAgICAgICBwcm9tcHQgKHN0cik6IHByb21wdCBtZXNzYWdlDQogICAgICAgIHRpdGxlIChzdHIpOiB0aXRsZSBtZXNzYWdlDQogICAgICAgIGt3YXJncyAodHlwZSk6IG90aGVyIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gOm9iajpgR2V0VmFsdWVXaW5kb3dgDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogc2VsZWN0ZWQgc3RyaW5nIHZhbHVlDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZvcm1zLmFza19mb3JfbnVtYmVyX3NsaWRlcigNCiAgICAgICAgICAgIGRlZmF1bHQ9NTAsDQogICAgICAgICAgICBtaW4gPSAwLA0KICAgICAgICAgICAgbWF4ID0gMTAwLA0KICAgICAgICAgICAgaW50ZXJ2YWwgPSA1LA0KICAgICAgICAgICAgcHJvbXB0PSdTZWxlY3QgYSBudW1iZXI6JywNCiAgICAgICAgICAgIHRpdGxlPSd0ZXN0IHRpdGxlJykNCiAgICAgICAgJzUwJw0KICAgICAgICBgYGANCiAgICANCiAgICBJbiB0aGlzIGV4YW1wbGUsIHRoZSBzbGlkZXIgd2lsbCBhbGxvdyB2YWx1ZXMgc3VjaCBhcyAnNDAsIDQ1LCA1MCwgNTUsIDYwJyBldGMNCiAgICAiIiINCiAgICByZXR1cm4gR2V0VmFsdWVXaW5kb3cuc2hvdygNCiAgICAgICAgTm9uZSwNCiAgICAgICAgdmFsdWVfdHlwZT0nc2xpZGVyJywNCiAgICAgICAgZGVmYXVsdD1kZWZhdWx0LA0KICAgICAgICBwcm9tcHQ9cHJvbXB0LA0KICAgICAgICB0aXRsZT10aXRsZSwNCiAgICAgICAgbWF4PW1heCwNCiAgICAgICAgbWluPW1pbiwNCiAgICAgICAgaW50ZXJ2YWw9aW50ZXJ2YWwsDQogICAgICAgICoqa3dhcmdzDQogICAgICAgICkNCg0KDQpkZWYgYXNrX3RvX3VzZV9zZWxlY3RlZCh0eXBlX25hbWUsIGNvdW50PU5vbmUsIG11bHRpcGxlPVRydWUpOg0KICAgICIiIkFzayB1c2VyIGlmIHdhbnRzIHRvIHVzZSBjdXJyZW50bHkgc2VsZWN0ZWQgZWxlbWVudHMuDQoNCiAgICBBcmdzOg0KICAgICAgICB0eXBlX25hbWUgKHN0cik6IEVsZW1lbnQgdHlwZSBvZiBleHBlY3RlZCBzZWxlY3RlZCBlbGVtZW50cw0KICAgICAgICBjb3VudCAoaW50KTogTnVtYmVyIG9mIHNlbGVjdGVkIGl0ZW1zDQogICAgICAgIG11bHRpcGxlIChib29sKTogV2hldGhlciBtdWx0aXBsZSBzZWxlY3RlZCBpdGVtcyBhcmUgYWxsb3dlZA0KICAgICIiIg0KICAgIHJlcG9ydCA9IHR5cGVfbmFtZS5sb3dlcigpDQogICAgIyBtdWx0aXBsZSA9IFRydWUNCiAgICBtZXNzYWdlID0gXA0KICAgICAgICAiWW91IGN1cnJlbnRseSBoYXZlICVzIHNlbGVjdGVkLiBEbyB5b3Ugd2FudCB0byBwcm9jZWVkIHdpdGggIlwNCiAgICAgICAgImN1cnJlbnRseSBzZWxlY3RlZCBpdGVtKHMpPyINCiAgICAjIGNoZWNrIGlzIHNlbGVjdGluZyBtdWx0aXBsZSBpcyBhbGxvd2QNCiAgICBpZiBub3QgbXVsdGlwbGU6DQogICAgICAgICMgbXVsdGlwbGUgPSBGYWxzZQ0KICAgICAgICBtZXNzYWdlID0gXA0KICAgICAgICAgICAgIllvdSBjdXJyZW50bHkgaGF2ZSAlcyBzZWxlY3RlZCBhbmQgb25seSBvbmUgaXMgcmVxdWlyZWQuICJcDQogICAgICAgICAgICAiRG8geW91IHdhbnQgdG8gdXNlIHRoZSBmaXJzdCBzZWxlY3RlZCBpdGVtPyINCg0KICAgICMgY2hlY2sgaWYgY291bnQgaXMgcHJvdmlkZWQNCiAgICBpZiBjb3VudCBpcyBub3QgTm9uZToNCiAgICAgICAgcmVwb3J0ID0gJ3t9IHt9Jy5mb3JtYXQoY291bnQsIHJlcG9ydCkNCiAgICByZXR1cm4gYWxlcnQobWVzc2FnZSAlIHJlcG9ydCwgeWVzPVRydWUsIG5vPVRydWUpDQoNCg0KZGVmIGFza19mb3JfY29sb3IoZGVmYXVsdD1Ob25lKToNCiAgICAiIiJTaG93IHN5c3RlbSBjb2xvciBwaWNrZXIgYW5kIGFzayBmb3IgY29sb3IuDQoNCiAgICBBcmdzOg0KICAgICAgICBkZWZhdWx0IChzdHIpOiBkZWZhdWx0IGNvbG9yIGluIEhFWCBBUkdCIGUuZy4gI2ZmODA4MDgwDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogc2VsZWN0ZWQgY29sb3IgaW4gSEVYIEFSR0IgZS5nLiAjZmY4MDgwODAsIG9yIE5vbmUgaWYgY2FuY2VsbGVkDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGZvcm1zLmFza19mb3JfY29sb3IoKQ0KICAgICAgICAnI2ZmODA4MDgwJw0KICAgICAgICBgYGANCiAgICAiIiINCiAgICAjIGNvbG9yRGxnLkNvbG9yDQogICAgY29sb3JfcGlja2VyID0gRm9ybXMuQ29sb3JEaWFsb2coKQ0KICAgIGlmIGRlZmF1bHQ6DQogICAgICAgIGRlZmF1bHQgPSBkZWZhdWx0LnJlcGxhY2UoJyMnLCAnJykNCiAgICAgICAgY29sb3JfcGlja2VyLkNvbG9yID0gU3lzdGVtLkRyYXdpbmcuQ29sb3IuRnJvbUFyZ2IoDQogICAgICAgICAgICBpbnQoZGVmYXVsdFs6Ml0sIDE2KSwNCiAgICAgICAgICAgIGludChkZWZhdWx0WzI6NF0sIDE2KSwNCiAgICAgICAgICAgIGludChkZWZhdWx0WzQ6Nl0sIDE2KSwNCiAgICAgICAgICAgIGludChkZWZhdWx0WzY6OF0sIDE2KQ0KICAgICAgICApDQogICAgY29sb3JfcGlja2VyLkZ1bGxPcGVuID0gVHJ1ZQ0KICAgIGlmIGNvbG9yX3BpY2tlci5TaG93RGlhbG9nKCkgPT0gRm9ybXMuRGlhbG9nUmVzdWx0Lk9LOg0KICAgICAgICBjID0gY29sb3JfcGlja2VyLkNvbG9yDQogICAgICAgIGNfaGV4ID0gJycuam9pbignezowMlh9Jy5mb3JtYXQoaW50KHgpKSBmb3IgeCBpbiBbYy5BLCBjLlIsIGMuRywgYy5CXSkNCiAgICAgICAgcmV0dXJuICcjJyArIGNfaGV4DQoNCg0KZGVmIGluZm9ybV93aXAoKToNCiAgICAiIiJTaG93IHdvcmstaW4tcHJvZ3Jlc3MgcHJvbXB0IHRvIHVzZXIgYW5kIGV4aXQgc2NyaXB0Lg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBmb3Jtcy5pbmZvcm1fd2lwKCkNCiAgICAgICAgYGBgDQogICAgIiIiDQogICAgYWxlcnQoIldvcmsgaW4gcHJvZ3Jlc3MuIiwgZXhpdHNjcmlwdD1UcnVlKQ0KDQoiIiJCYXNlIG1vZHVsZSBmb3IgcHVzaGluZyB0b2FzdCBtZXNzYWdlcyBvbiBXaW4gMTAuDQoNClRoaXMgbW9kdWxlIGlzIGEgd3JhcHBlciBmb3IgYSBjbGkgdXRpbGl0eSB0aGF0IHByb3ZpZGVzIHRvYXN0IG1lc3NhZ2UNCmZ1bmN0aW9uYWxpdHkuIFNlZSBgaHR0cHM6Ly9naXRodWIuY29tL2dvLXRvYXN0L3RvYXN0YA0KIiIiDQoNCmltcG9ydCBvcy5wYXRoIGFzIG9wDQppbXBvcnQgc3VicHJvY2Vzcw0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IEJJTl9ESVINCmZyb20gcHlyZXZpdC5jb3JldXRpbHMubG9nZ2VyIGltcG9ydCBnZXRfbG9nZ2VyDQoNCg0KI3B5bGludDogZGlzYWJsZT1XMDcwMyxDMDMwMg0KbWxvZ2dlciA9IGdldF9sb2dnZXIoX19uYW1lX18pICAjcHlsaW50OiBkaXNhYmxlPUMwMTAzDQoNCg0KZGVmIGdldF90b2FzdGVyKCk6DQogICAgIiIiUmV0dXJuIGZ1bGwgZmlsZSBwYXRoIG9mIHRoZSB0b2FzdCBiaW5hcnkgdXRpbGl0eS4iIiINCiAgICByZXR1cm4gb3Auam9pbihCSU5fRElSLCAncHlyZXZpdC10b2FzdC5leGUnKQ0KDQoNCmRlZiBzZW5kX3RvYXN0KG1lc3NhZ2UsDQogICAgICAgICAgICAgICB0aXRsZT1Ob25lLCBhcHBpZD1Ob25lLCBpY29uPU5vbmUsIGNsaWNrPU5vbmUsIGFjdGlvbnM9Tm9uZSk6DQogICAgIiIiU2VuZCB0b2FzdCBub3RpZmljYXRvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIG1lc3NhZ2UgKHN0cik6IG5vdGlmaWNhdGlvbiBtZXNzYWdlDQogICAgICAgIHRpdGxlIChzdHIpOiBub3RpZmljYXRpb24gdGl0bGUNCiAgICAgICAgYXBwaWQgKHN0cik6IGFwcGxpY2F0aW9uIHVuaXF1ZSBpZCAoc2VlIGAtLWFwcC1pZGAgY2xpIG9wdGlvbikNCiAgICAgICAgaWNvbiAoc3RyKTogbm90aWZpY2F0aW9uIGljb24gKHNlZSBgLS1pY29uYCBjbGkgb3B0aW9uKQ0KICAgICAgICBjbGljayAoc3RyKTogY2xpY2sgYWN0aW9uIChzZWUgYC0tYWN0aXZhdGlvbi1hcmdgIGNsaSBvcHRpb24pDQogICAgICAgIGFjdGlvbnMgKGRpY3Rbc3RyOnN0cl0pOg0KICAgICAgICAgICAgbGlzdCBvZiBhY3Rpb25zIChzZWUgYC0tYWN0aW9uYCBhbmQgYC0tYWN0aW9uLWFyZ2AgY2xpIG9wdGlvbnMpDQogICAgIiIiDQogICAgIyBzZXQgZGVmYXVsdHMNCiAgICBpZiBub3QgdGl0bGU6DQogICAgICAgIHRpdGxlID0gJ3B5UmV2aXQnDQogICAgaWYgbm90IGFwcGlkOg0KICAgICAgICBhcHBpZCA9IHRpdGxlDQogICAgaWYgbm90IGljb246DQogICAgICAgIGljb24gPSBvcC5qb2luKEJJTl9ESVIsICdweVJldml0LmljbycpDQogICAgaWYgbm90IGFjdGlvbnM6DQogICAgICAgIGFjdGlvbnMgPSB7fQ0KDQogICAgIyBidWlsZCB0aGUgdG9hc3QNCiAgICB0b2FzdF9hcmdzID0gcicie30iJy5mb3JtYXQoZ2V0X3RvYXN0ZXIoKSkNCiAgICB0b2FzdF9hcmdzICs9IHInIC0tYXBwLWlkICJ7fSInLmZvcm1hdChhcHBpZCkNCiAgICB0b2FzdF9hcmdzICs9IHInIC0tdGl0bGUgInt9IicuZm9ybWF0KHRpdGxlKQ0KICAgIHRvYXN0X2FyZ3MgKz0gcicgLS1tZXNzYWdlICJ7fSInLmZvcm1hdChtZXNzYWdlKQ0KICAgIHRvYXN0X2FyZ3MgKz0gcicgLS1pY29uICJ7fSInLmZvcm1hdChpY29uKQ0KICAgIHRvYXN0X2FyZ3MgKz0gcicgLS1hdWRpbyAiZGVmYXVsdCInDQogICAgIyB0b2FzdF9hcmdzICs9IHInIC0tZHVyYXRpb24gImxvbmciJw0KICAgIGlmIGNsaWNrOg0KICAgICAgICB0b2FzdF9hcmdzICs9IHInIC0tYWN0aXZhdGlvbi1hcmcgInt9IicuZm9ybWF0KGNsaWNrKQ0KICAgIGZvciBhY3Rpb24sIGFyZ3MgaW4gYWN0aW9ucy5pdGVtcygpOg0KICAgICAgICB0b2FzdF9hcmdzICs9IHInIC0tYWN0aW9uICJ7fSIgLS1hY3Rpb24tYXJnICJ7fSInLmZvcm1hdChhY3Rpb24sIGFyZ3MpDQoNCiAgICAjIHNlbmQgdGhlIHRvYXN0IG5vdw0KICAgIG1sb2dnZXIuZGVidWcoJ3RvYXN0aW5nOiAlcycsIHRvYXN0X2FyZ3MpDQogICAgc3VicHJvY2Vzcy5Qb3Blbih0b2FzdF9hcmdzLCBzaGVsbD1UcnVlKQ0KDQoiIiJVdGlsaXR5IGZ1bmN0aW9ucyB0byBzdXBwb3J0IGZvcm1zIG1vZHVsZS4iIiINCg0KZnJvbSBweXJldml0IGltcG9ydCBmcmFtZXdvcmsNCmZyb20gcHlyZXZpdC5mcmFtZXdvcmsgaW1wb3J0IHdwZiwgQ29udHJvbHMsIEltYWdpbmcNCg0KDQpkZWYgYml0bWFwX2Zyb21fZmlsZShiaXRtYXBfZmlsZSk6DQogICAgIiIiQ3JlYXRlIEJpdG1hcEltYWdlIGZyb20gYSBiaXRtYXAgZmlsZS4NCg0KICAgIEFyZ3M6DQogICAgICAgIGJpdG1hcF9maWxlIChzdHIpOiBwYXRoIHRvIGJpdG1hcCBmaWxlDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoQml0bWFwSW1hZ2UpOiBiaXRtYXAgaW1hZ2Ugb2JqZWN0DQogICAgIiIiDQogICAgYml0bWFwID0gSW1hZ2luZy5CaXRtYXBJbWFnZSgpDQogICAgYml0bWFwLkJlZ2luSW5pdCgpDQogICAgYml0bWFwLlVyaVNvdXJjZSA9IGZyYW1ld29yay5VcmkoYml0bWFwX2ZpbGUpDQogICAgYml0bWFwLkNhY2hlT3B0aW9uID0gSW1hZ2luZy5CaXRtYXBDYWNoZU9wdGlvbi5PbkxvYWQNCiAgICBiaXRtYXAuQ3JlYXRlT3B0aW9ucyA9IEltYWdpbmcuQml0bWFwQ3JlYXRlT3B0aW9ucy5JZ25vcmVJbWFnZUNhY2hlDQogICAgYml0bWFwLkVuZEluaXQoKQ0KICAgIGJpdG1hcC5GcmVlemUoKQ0KICAgIHJldHVybiBiaXRtYXANCg0KDQpkZWYgbG9hZF9jb21wb25lbnQoeGFtbF9maWxlLCBjb21wX3R5cGUpOg0KICAgICIiIkxvYWQgV1BGIGNvbXBvbmVudCBmcm9tIHhhbWwgZmlsZS4NCg0KICAgIEFyZ3M6DQogICAgICAgIHhhbWxfZmlsZSAoc3RyKTogeGFtbCBmaWxlIHBhdGgNCiAgICAgICAgY29tcF90eXBlIChTeXN0ZW0uV2luZG93cy5Db250cm9scyk6IFdQRiBjb250cm9sIHR5cGUNCg0KICAgIFJldHVybnM6DQogICAgICAgIChTeXN0ZW0uV2luZG93cy5Db250cm9scyk6IGxvYWRlZCBXUEYgY29udHJvbA0KICAgICIiIg0KICAgIHJldHVybiB3cGYuTG9hZENvbXBvbmVudChjb21wX3R5cGUsIHhhbWxfZmlsZSkNCg0KDQpkZWYgbG9hZF9jdHJsX3RlbXBsYXRlKHhhbWxfZmlsZSk6DQogICAgIiIiTG9hZCBTeXN0ZW0uV2luZG93cy5Db250cm9scy5Db250cm9sVGVtcGxhdGUgZnJvbSB4YW1sIGZpbGUuDQoNCiAgICBBcmdzOg0KICAgICAgICB4YW1sX2ZpbGUgKHN0cik6IHhhbWwgZmlsZSBwYXRoDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoU3lzdGVtLldpbmRvd3MuQ29udHJvbHMuQ29udHJvbFRlbXBsYXRlKTogbG9hZGVkIGNvbnRyb2wgdGVtcGxhdGUNCiAgICAiIiINCiAgICByZXR1cm4gbG9hZF9jb21wb25lbnQoeGFtbF9maWxlLCBDb250cm9scy5Db250cm9sVGVtcGxhdGUoKSkNCg0KDQpkZWYgbG9hZF9pdGVtc3BhbmVsX3RlbXBsYXRlKHhhbWxfZmlsZSk6DQogICAgIiIiTG9hZCBTeXN0ZW0uV2luZG93cy5Db250cm9scy5JdGVtc1BhbmVsVGVtcGxhdGUgZnJvbSB4YW1sIGZpbGUuDQoNCiAgICBBcmdzOg0KICAgICAgICB4YW1sX2ZpbGUgKHN0cik6IHhhbWwgZmlsZSBwYXRoDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoU3lzdGVtLldpbmRvd3MuQ29udHJvbHMuQ29udHJvbFRlbXBsYXRlKTogbG9hZGVkIGl0ZW1zLXBhbmVsIHRlbXBsYXRlDQogICAgIiIiDQogICAgcmV0dXJuIGxvYWRfY29tcG9uZW50KHhhbWxfZmlsZSwgQ29udHJvbHMuSXRlbXNQYW5lbFRlbXBsYXRlKCkpDQoNCiIiIkxvYWRlciBiYXNlIG1vZHVsZS4iIiINCmZyb20gcHlyZXZpdCBpbXBvcnQgRVhFQ19QQVJBTVMNCg0KDQpMT0FERVJfQURET05fTkFNRVNQQUNFID0gJ1B5UmV2aXRMb2FkZXInDQoNCg0KSEFTSF9DVVRPRkZfTEVOR1RIID0gMTYNCg0KIiIiQXNzZW1ibHkgbWFrZXIgbW9kdWxlLiIiIg0KaW1wb3J0IG9zLnBhdGggYXMgb3ANCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IG5hbWVkdHVwbGUNCg0KZnJvbSBweXJldml0IGltcG9ydCBQWVJFVklUX0FERE9OX05BTUUsIEVYRUNfUEFSQU1TDQpmcm9tIHB5cmV2aXQgaW1wb3J0IGZyYW1ld29yaw0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgQXBwRG9tYWluLCBWZXJzaW9uDQpmcm9tIHB5cmV2aXQuZnJhbWV3b3JrIGltcG9ydCBBc3NlbWJseU5hbWUsIEFzc2VtYmx5QnVpbGRlckFjY2Vzcw0KZnJvbSBweXJldml0IGltcG9ydCBjb3JldXRpbHMNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGFzc211dGlscw0KZnJvbSBweXJldml0LmNvcmV1dGlscyBpbXBvcnQgYXBwZGF0YQ0KZnJvbSBweXJldml0LmNvcmV1dGlscyBpbXBvcnQgbG9nZ2VyDQpmcm9tIHB5cmV2aXQudmVyc2lvbm1nciBpbXBvcnQgZ2V0X3B5cmV2aXRfdmVyc2lvbg0KDQpmcm9tIHB5cmV2aXQubG9hZGVyIGltcG9ydCBIQVNIX0NVVE9GRl9MRU5HVEgNCmZyb20gcHlyZXZpdC5ydW50aW1lIGltcG9ydCBCQVNFX1RZUEVTX0RJUl9IQVNIDQpmcm9tIHB5cmV2aXQucnVudGltZSBpbXBvcnQgdHlwZW1ha2VyDQpmcm9tIHB5cmV2aXQudXNlcmNvbmZpZyBpbXBvcnQgdXNlcl9jb25maWcNCg0KZnJvbSBTeXN0ZW0uUmVmbGVjdGlvbi5FbWl0IGltcG9ydCBBc3NlbWJseUJ1aWxkZXINCg0KIyBHZW5lcmljIG5hbWVkIHR1cGxlIGZvciBwYXNzaW5nIGFzc2VtYmx5IGluZm9ybWF0aW9uIHRvIG90aGVyIG1vZHVsZXMNCkV4dGVuc2lvbkFzc2VtYmx5SW5mbyA9IG5hbWVkdHVwbGUoJ0V4dGVuc2lvbkFzc2VtYmx5SW5mbycsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsnbmFtZScsICdsb2NhdGlvbicsICdyZWxvYWRpbmcnXSkNCg0KDQojcHlsaW50OiBkaXNhYmxlPVcwNzAzLEMwMzAyLEMwMTAzDQptbG9nZ2VyID0gbG9nZ2VyLmdldF9sb2dnZXIoX19uYW1lX18pDQoNCg0KZGVmIF9tYWtlX2V4dGVuc2lvbl9oYXNoKGV4dGVuc2lvbik6DQogICAgIyBjcmVhdGVzIGEgaGFzaCBiYXNlZCBvbiBoYXNoIG9mIGJhc2VjbGFzc2VzIG1vZHVsZSB0aGF0DQogICAgIyB0aGUgZXh0ZW5zaW9uIGlzIGJhc2VkIHVwb24gYW5kIGFsc28gdGhlIHVzZXIgY29uZmlndXJhdGlvbiB2ZXJzaW9uDQogICAgcmV0dXJuIGNvcmV1dGlscy5nZXRfc3RyX2hhc2goDQogICAgICAgIEJBU0VfVFlQRVNfRElSX0hBU0gNCiAgICAgICAgKyBFWEVDX1BBUkFNUy5lbmdpbmVfdmVyDQogICAgICAgICsgZXh0ZW5zaW9uLmdldF9oYXNoKCkpWzpIQVNIX0NVVE9GRl9MRU5HVEhdDQoNCg0KZGVmIF9tYWtlX2V4dF9hc21fZmlsZWlkKGV4dGVuc2lvbik6DQogICAgcmV0dXJuICd7fV97fScuZm9ybWF0KF9tYWtlX2V4dGVuc2lvbl9oYXNoKGV4dGVuc2lvbiksIGV4dGVuc2lvbi5uYW1lKQ0KDQoNCmRlZiBfaXNfcHlyZXZpdF9leHRfYXNtKGFzbV9uYW1lLCBleHRlbnNpb24pOg0KICAgICMgaWYgdGhpcyBpcyBhIHB5UmV2aXQgcGFja2FnZSBhc3NlbWJseQ0KICAgIHJldHVybiBhc21fbmFtZS5zdGFydHN3aXRoKFBZUkVWSVRfQURET05fTkFNRSkgXA0KICAgICAgICAgICBhbmQgYXNtX25hbWUuZW5kc3dpdGgoZXh0ZW5zaW9uLm5hbWUpDQoNCg0KZGVmIF9pc19weXJldml0X2V4dF9hbHJlYWR5X2xvYWRlZChleHRfYXNtX25hbWUpOg0KICAgIG1sb2dnZXIuZGVidWcoJ0Fza2luZyBSZXZpdCBmb3IgcHJldmlvdXNseSBsb2FkZWQgcGFja2FnZSBhc3NlbWJsaWVzOiAlcycsDQogICAgICAgICAgICAgICAgICBleHRfYXNtX25hbWUpDQogICAgcmV0dXJuIGxlbihhc3NtdXRpbHMuZmluZF9sb2FkZWRfYXNtKGV4dF9hc21fbmFtZSkpDQoNCg0KZGVmIF9pc19hbnlfZXh0X2FzbV9sb2FkZWQoZXh0ZW5zaW9uKToNCiAgICBmb3IgbG9hZGVkX2FzbSBpbiBBcHBEb21haW4uQ3VycmVudERvbWFpbi5HZXRBc3NlbWJsaWVzKCk6DQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0NoZWNraW5nIGZvciBsb2FkZWQgZXh0ZW5zaW9uIGFzbTogJXMgPyAlcyA6ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICBleHRlbnNpb24ubmFtZSwgbG9hZGVkX2FzbS5HZXROYW1lKCkuTmFtZSwgbG9hZGVkX2FzbSkNCiAgICAgICAgaWYgX2lzX3B5cmV2aXRfZXh0X2FzbShsb2FkZWRfYXNtLkdldE5hbWUoKS5OYW1lLCBleHRlbnNpb24pOg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCiAgICByZXR1cm4gRmFsc2UNCg0KDQpkZWYgX3VwZGF0ZV9jb21wb25lbnRfY21kX3R5cGVzKGV4dGVuc2lvbik6DQogICAgZm9yIGNtZF9jb21wb25lbnQgaW4gZXh0ZW5zaW9uLmdldF9hbGxfY29tbWFuZHMoKToNCiAgICAgICAgdHlwZW1ha2VyLm1ha2VfYnVuZGxlX3R5cGVzKA0KICAgICAgICAgICAgZXh0ZW5zaW9uLA0KICAgICAgICAgICAgY21kX2NvbXBvbmVudCwNCiAgICAgICAgICAgIG1vZHVsZV9idWlsZGVyPU5vbmUNCiAgICAgICAgICAgICkNCg0KDQpkZWYgX2NyZWF0ZV9hc21fZmlsZShleHRlbnNpb24sIGV4dF9hc21fZmlsZV9uYW1lLCBleHRfYXNtX2ZpbGVfcGF0aCk6DQogICAgIyBjaGVjayB0byBzZWUgaWYgYW55IG9sZGVyIGFzc2VtYmxpZXMgaGF2ZSBiZWVuIGxvYWRlZCBmb3IgdGhpcyBwYWNrYWdlDQogICAgZXh0X2FzbV9mdWxsX2ZpbGVfbmFtZSA9IFwNCiAgICAgICAgY29yZXV0aWxzLm1ha2VfY2Fub25pY2FsX25hbWUoZXh0X2FzbV9maWxlX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1ld29yay5BU1NFTUJMWV9GSUxFX1RZUEUpDQoNCiAgICAjIHRoaXMgbWVhbnMgdGhhdCB3ZSBjdXJyZW50bHkgaGF2ZSB0aGlzIHBhY2thZ2UgbG9hZGVkIGFuZA0KICAgICMgd2UncmUgcmVsb2FkaW5nIGEgbmV3IHZlcnNpb24NCiAgICBpc19yZWxvYWRpbmdfcGtnID0gX2lzX2FueV9leHRfYXNtX2xvYWRlZChleHRlbnNpb24pDQoNCiAgICAjIGNyZWF0ZSBhc3NlbWJseQ0KICAgIG1sb2dnZXIuZGVidWcoJ0J1aWxkaW5nIGFzc2VtYmx5IGZvciBwYWNrYWdlOiAlcycsIGV4dGVuc2lvbikNCiAgICBweXJ2dF92ZXJfaW50X3R1cGxlID0gZ2V0X3B5cmV2aXRfdmVyc2lvbigpLmFzX2ludF90dXBsZSgpDQogICAgd2luX2FzbV9uYW1lID0gQXNzZW1ibHlOYW1lKE5hbWU9ZXh0X2FzbV9maWxlX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFZlcnNpb249VmVyc2lvbihweXJ2dF92ZXJfaW50X3R1cGxlWzBdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHlydnRfdmVyX2ludF90dXBsZVsxXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB5cnZ0X3Zlcl9pbnRfdHVwbGVbMl0pKQ0KICAgIG1sb2dnZXIuZGVidWcoJ0dlbmVyYXRlZCBhc3NlbWJseSBuYW1lIGZvciB0aGlzIHBhY2thZ2U6ICVzJywNCiAgICAgICAgICAgICAgICAgIGV4dF9hc21fZmlsZV9uYW1lKQ0KICAgIG1sb2dnZXIuZGVidWcoJ0dlbmVyYXRlZCB3aW5kb3dzIGFzc2VtYmx5IG5hbWUgZm9yIHRoaXMgcGFja2FnZTogJXMnLA0KICAgICAgICAgICAgICAgICAgd2luX2FzbV9uYW1lKQ0KICAgIG1sb2dnZXIuZGVidWcoJ0dlbmVyYXRlZCBhc3NlbWJseSBmaWxlIG5hbWUgZm9yIHRoaXMgcGFja2FnZTogJXMnLA0KICAgICAgICAgICAgICAgICAgZXh0X2FzbV9mdWxsX2ZpbGVfbmFtZSkNCg0KICAgIGlmIGludChfX3Jldml0X18uQXBwbGljYXRpb24uVmVyc2lvbk51bWJlcikgPj0gMjAyNToNCiAgICAgICAgYXNtX2J1aWxkZXIgPSBBc3NlbWJseUJ1aWxkZXIuRGVmaW5lRHluYW1pY0Fzc2VtYmx5KA0KICAgICAgICAgICAgd2luX2FzbV9uYW1lLA0KICAgICAgICAgICAgQXNzZW1ibHlCdWlsZGVyQWNjZXNzLlJ1bikNCg0KICAgICAgICAjIGdldCBtb2R1bGUgYnVpbGRlcg0KICAgICAgICBtb2R1bGVfYnVpbGRlciA9IGFzbV9idWlsZGVyLkRlZmluZUR5bmFtaWNNb2R1bGUoZXh0X2FzbV9maWxlX25hbWUpDQogICAgZWxzZToNCiAgICAgICAgIyBnZXQgYXNzZW1ibHkgYnVpbGRlcg0KICAgICAgICBhc21fYnVpbGRlciA9IEFwcERvbWFpbi5DdXJyZW50RG9tYWluLkRlZmluZUR5bmFtaWNBc3NlbWJseSgNCiAgICAgICAgICAgIHdpbl9hc21fbmFtZSwNCiAgICAgICAgICAgIEFzc2VtYmx5QnVpbGRlckFjY2Vzcy5SdW5BbmRTYXZlLA0KICAgICAgICAgICAgb3AuZGlybmFtZShleHRfYXNtX2ZpbGVfcGF0aCkpDQoNCiAgICAgICAgIyBnZXQgbW9kdWxlIGJ1aWxkZXINCiAgICAgICAgbW9kdWxlX2J1aWxkZXIgPSBhc21fYnVpbGRlci5EZWZpbmVEeW5hbWljTW9kdWxlKGV4dF9hc21fZmlsZV9uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0X2FzbV9mdWxsX2ZpbGVfbmFtZSkNCg0KICAgICMgY3JlYXRlIGNvbW1hbmQgY2xhc3Nlcw0KICAgIGZvciBjbWRfY29tcG9uZW50IGluIGV4dGVuc2lvbi5nZXRfYWxsX2NvbW1hbmRzKCk6DQogICAgICAgICMgY3JlYXRlIGNvbW1hbmQgZXhlY3V0b3IgY2xhc3MgZm9yIHRoaXMgY29tbWFuZA0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDcmVhdGluZyB0eXBlcyBmb3IgY29tbWFuZDogJXMnLCBjbWRfY29tcG9uZW50KQ0KICAgICAgICB0eXBlbWFrZXIubWFrZV9idW5kbGVfdHlwZXMoZXh0ZW5zaW9uLCBjbWRfY29tcG9uZW50LCBtb2R1bGVfYnVpbGRlcikNCg0KICAgIGlmIGludChfX3Jldml0X18uQXBwbGljYXRpb24uVmVyc2lvbk51bWJlcikgPj0gMjAyNToNCiAgICAgICAgZnJvbSBMb2thZC5JTFBhY2sgaW1wb3J0IEFzc2VtYmx5R2VuZXJhdG9yDQogICAgICAgIGdlbmVyYXRvciA9IEFzc2VtYmx5R2VuZXJhdG9yKCkNCiAgICAgICAgZ2VuZXJhdG9yLkdlbmVyYXRlQXNzZW1ibHkoYXNtX2J1aWxkZXIsIGV4dF9hc21fZmlsZV9wYXRoKQ0KICAgIGVsc2U6DQogICAgICAgICMgc2F2ZSBmaW5hbCBhc3NlbWJseQ0KICAgICAgICBhc21fYnVpbGRlci5TYXZlKGV4dF9hc21fZnVsbF9maWxlX25hbWUpDQoNCiAgICBhc3NtdXRpbHMubG9hZF9hc21fZmlsZShleHRfYXNtX2ZpbGVfcGF0aCkNCg0KICAgIG1sb2dnZXIuZGVidWcoJ0V4ZWN1dGVyIGFzc2VtYmx5IHNhdmVkLicpDQogICAgcmV0dXJuIEV4dGVuc2lvbkFzc2VtYmx5SW5mbyhleHRfYXNtX2ZpbGVfbmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4dF9hc21fZmlsZV9wYXRoLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfcmVsb2FkaW5nX3BrZykNCg0KDQpkZWYgX3Byb2R1Y2VfYXNtX2ZpbGUoZXh0ZW5zaW9uKToNCiAgICAjIHVuaXF1ZSBhc3NlbWJseSBmaWxlbmFtZSBmb3IgdGhpcyBwYWNrYWdlDQogICAgZXh0X2FzbV9maWxlaWQgPSBfbWFrZV9leHRfYXNtX2ZpbGVpZChleHRlbnNpb24pDQogICAgZXh0X2FzbV9maWxlX3BhdGggPSBcDQogICAgICAgIGFwcGRhdGEuZ2V0X2RhdGFfZmlsZShmaWxlX2lkPWV4dF9hc21fZmlsZWlkLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9leHQ9ZnJhbWV3b3JrLkFTU0VNQkxZX0ZJTEVfVFlQRSkNCiAgICAjIG1ha2UgdW5pcXVlIGFzc2VtYmx5IG5hbWUgZm9yIHRoaXMgcGFja2FnZQ0KICAgIGV4dF9hc21fZmlsZV9uYW1lID0gY29yZXV0aWxzLmdldF9maWxlX25hbWUoZXh0X2FzbV9maWxlX3BhdGgpDQoNCiAgICBpZiBfaXNfcHlyZXZpdF9leHRfYWxyZWFkeV9sb2FkZWQoZXh0X2FzbV9maWxlX25hbWUpOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdFeHRlbnNpb24gYXNzZW1ibHkgaXMgYWxyZWFkeSBsb2FkZWQ6ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICBleHRfYXNtX2ZpbGVfbmFtZSkNCiAgICAgICAgX3VwZGF0ZV9jb21wb25lbnRfY21kX3R5cGVzKGV4dGVuc2lvbikNCiAgICAgICAgcmV0dXJuIEV4dGVuc2lvbkFzc2VtYmx5SW5mbyhleHRfYXNtX2ZpbGVfbmFtZSwgZXh0X2FzbV9maWxlX3BhdGgsIFRydWUpDQogICAgZWxpZiBhcHBkYXRhLmlzX2RhdGFfZmlsZV9hdmFpbGFibGUoDQogICAgICAgICAgICBmaWxlX2lkPWV4dF9hc21fZmlsZWlkLA0KICAgICAgICAgICAgZmlsZV9leHQ9ZnJhbWV3b3JrLkFTU0VNQkxZX0ZJTEVfVFlQRSk6DQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0V4dGVuc2lvbiBhc3NlbWJseSBmaWxlIGFscmVhZHkgZXhpc3RzOiAlcycsDQogICAgICAgICAgICAgICAgICAgICAgZXh0X2FzbV9maWxlX3BhdGgpDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIGxvYWRlZF9hc3NtID0gYXNzbXV0aWxzLmxvYWRfYXNtX2ZpbGUoZXh0X2FzbV9maWxlX3BhdGgpDQogICAgICAgICAgICBmb3IgYXNtX25hbWUgaW4gbG9hZGVkX2Fzc20uR2V0UmVmZXJlbmNlZEFzc2VtYmxpZXMoKToNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDaGVja2luZyByZWZlcmVuY2VkIGFzc2VtYmx5OiAlcycsIGFzbV9uYW1lKQ0KICAgICAgICAgICAgICAgIHJlZl9hc21fZmlsZV9wYXRoID0gXA0KICAgICAgICAgICAgICAgICAgICBhcHBkYXRhLmlzX2ZpbGVfYXZhaWxhYmxlKA0KICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9uYW1lPWFzbV9uYW1lLk5hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2V4dD1mcmFtZXdvcmsuQVNTRU1CTFlfRklMRV9UWVBFDQogICAgICAgICAgICAgICAgICAgICAgICApDQogICAgICAgICAgICAgICAgaWYgcmVmX2FzbV9maWxlX3BhdGg6DQogICAgICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0xvYWRpbmcgcmVmZXJlbmNlZCBhc3NlbWJseTogJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZl9hc21fZmlsZV9wYXRoKQ0KICAgICAgICAgICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgICAgICAgICBhc3NtdXRpbHMubG9hZF9hc21fZmlsZShyZWZfYXNtX2ZpbGVfcGF0aCkNCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBsb2FkX2VycjoNCiAgICAgICAgICAgICAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoJ0Vycm9yIGxvYWRpbmcgcmVmZXJlbmNlZCBhc3NlbWJseTogJXMgJw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnfCAlcycsIHJlZl9hc21fZmlsZV9wYXRoLCBsb2FkX2VycikNCg0KICAgICAgICAgICAgX3VwZGF0ZV9jb21wb25lbnRfY21kX3R5cGVzKGV4dGVuc2lvbikNCiAgICAgICAgICAgIHJldHVybiBFeHRlbnNpb25Bc3NlbWJseUluZm8oZXh0X2FzbV9maWxlX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4dF9hc21fZmlsZV9wYXRoLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGYWxzZSkNCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleHRfYXNtX2xvYWRfZXJyOg0KICAgICAgICAgICAgbWxvZ2dlci5lcnJvcignRXJyb3IgbG9hZGluZyBleHRlbnNpb24gYXNzZW1ibHk6ICVzIHwgJXMnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICBleHRfYXNtX2ZpbGVfcGF0aCwgZXh0X2FzbV9sb2FkX2VycikNCiAgICBlbHNlOg0KICAgICAgICByZXR1cm4gX2NyZWF0ZV9hc21fZmlsZShleHRlbnNpb24sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4dF9hc21fZmlsZV9uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHRfYXNtX2ZpbGVfcGF0aCkNCg0KDQpkZWYgY3JlYXRlX2Fzc2VtYmx5KGV4dGVuc2lvbik6DQogICAgIiIiQ3JlYXRlIGFuIGV4dGVuc2lvbiBhc3NlbWJseS4NCg0KICAgIEFyZ3M6DQogICAgICAgIGV4dGVuc2lvbiAocHlyZXZpdC5leHRlbnNpb25zLmNvbXBvbmVudHMuRXh0ZW5zaW9uKTogcHlSZXZpdCBleHRlbnNpb24uDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoRXh0ZW5zaW9uQXNzZW1ibHlJbmZvKTogYXNzZW1ibHkgaW5mbw0KICAgICIiIg0KICAgIG1sb2dnZXIuZGVidWcoJ0NyZWF0aW5nIGFzc2VtYmx5IGZvciBleHRlbnNpb246ICVzJywgZXh0ZW5zaW9uLm5hbWUpDQogICAgIyBjcmVhdGUgYXNzZW1ibHkgZmlsZSBhbmQgcmV0dXJuIGFzc2VtYmx5IHBhdGggdG8gYmUgdXNlZCBpbiBVSSBjcmVhdGlvbg0KICAgICMgdHJ5Og0KICAgIGV4dF9hc21faW5mbyA9IF9wcm9kdWNlX2FzbV9maWxlKGV4dGVuc2lvbikNCiAgICBtbG9nZ2VyLmRlYnVnKCdBc3NlbWJseSBjcmVhdGVkOiAlcycsIGV4dF9hc21faW5mbykNCiAgICByZXR1cm4gZXh0X2FzbV9pbmZvDQogICAgIyBleGNlcHQgRXhjZXB0aW9uIGFzIGFzbV9lcnI6DQogICAgIyAgICAgbWxvZ2dlci5jcml0aWNhbCgnQ2FuIG5vdCBjcmVhdGUgYXNzZW1ibHkgZm9yOiB7fScgXA0KICAgICMgICAgICAgICAgICAgICAgICAgICAnfCB7fScuZm9ybWF0KGV4dGVuc2lvbiwgYXNtX2VycikpDQoNCg0KZGVmIGNsZWFudXBfYXNzZW1ibHlfZmlsZXMoKToNCiAgICBpZiBjb3JldXRpbHMuZ2V0X3Jldml0X2luc3RhbmNlX2NvdW50KCkgPT0gMToNCiAgICAgICAgZm9yIGFzbV9maWxlX3BhdGggaW4gYXBwZGF0YS5saXN0X2RhdGFfZmlsZXMoZmlsZV9leHQ9J2RsbCcpOg0KICAgICAgICAgICAgaWYgbm90IGFzc211dGlscy5maW5kX2xvYWRlZF9hc20oYXNtX2ZpbGVfcGF0aCwgYnlfbG9jYXRpb249VHJ1ZSk6DQogICAgICAgICAgICAgICAgYXBwZGF0YS5nYXJiYWdlX2RhdGFfZmlsZShhc21fZmlsZV9wYXRoKQ0KICAgICAgICAgICAgICAgIGFzbV9sb2dfZmlsZSA9IGFzbV9maWxlX3BhdGgucmVwbGFjZSgnLmRsbCcsICcubG9nJykNCiAgICAgICAgICAgICAgICBpZiBvcC5leGlzdHMoYXNtX2xvZ19maWxlKToNCiAgICAgICAgICAgICAgICAgICAgYXBwZGF0YS5nYXJiYWdlX2RhdGFfZmlsZShhc21fbG9nX2ZpbGUpDQoNCiIiIkhvb2tzIG1hbmFnZW1lbnQuIiIiDQppbXBvcnQgb3MucGF0aCBhcyBvcA0KaW1wb3J0IHJlDQpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBuYW1lZHR1cGxlDQoNCmZyb20gcHlyZXZpdCBpbXBvcnQgSE9TVF9BUFANCmZyb20gcHlyZXZpdCBpbXBvcnQgZnJhbWV3b3JrDQpmcm9tIHB5cmV2aXQgaW1wb3J0IGNvcmV1dGlscw0KZnJvbSBweXJldml0LmNvcmV1dGlscy5sb2dnZXIgaW1wb3J0IGdldF9sb2dnZXINCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGVudnZhcnMNCmZyb20gcHlyZXZpdC5ydW50aW1lLnR5cGVzIGltcG9ydCBFdmVudEhvb2tzDQppbXBvcnQgcHlyZXZpdC5leHRlbnNpb25zIGFzIGV4dHMNCg0KZnJvbSBweXJldml0LmxvYWRlciBpbXBvcnQgc2Vzc2lvbmluZm8NCg0KDQpTVVBQT1JURURfTEFOR1VBR0VTID0gWw0KICAgIGV4dHMuUFlUSE9OX1NDUklQVF9GSUxFX0ZPUk1BVCwNCiAgICBleHRzLkNTSEFSUF9TQ1JJUFRfRklMRV9GT1JNQVQsDQogICAgZXh0cy5WQl9TQ1JJUFRfRklMRV9GT1JNQVQsDQogICAgXQ0KDQojcHlsaW50OiBkaXNhYmxlPVcwNzAzLEMwMzAyLEMwMTAzDQptbG9nZ2VyID0gZ2V0X2xvZ2dlcihfX25hbWVfXykNCg0KDQpFeHRlbnNpb25FdmVudEhvb2sgPSBuYW1lZHR1cGxlKCdFeHRlbnNpb25FdmVudEhvb2snLCBbDQogICAgJ2lkJywNCiAgICAnbmFtZScsDQogICAgJ3RhcmdldCcsDQogICAgJ3NjcmlwdCcsDQogICAgJ3N5c3BhdGhzJywNCiAgICAnZXh0ZW5zaW9uX25hbWUnLA0KICAgIF0pDQoNCg0KZGVmIGdldF9ob29rc19oYW5kbGVyKCk6DQogICAgIiIiR2V0IHRoZSBob29rIGhhbmRsZXIgZW52aXJvbm1lbnQgdmFyaWFibGUuDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoRXZlbnRIb29rcyk6IGhvb2sgaGFuZGxlcg0KICAgICIiIg0KICAgIHJldHVybiBlbnZ2YXJzLmdldF9weXJldml0X2Vudl92YXIoZW52dmFycy5IT09LU0hBTkRMRVJfRU5WVkFSKQ0KDQoNCmRlZiBzZXRfaG9va3NfaGFuZGxlcihoYW5kbGVyKToNCiAgICAiIiJTZXQgdGhlIGhvb2sgaGFuZGxlciBlbnZpcm9ubWVudCB2YXJpYWJsZS4NCg0KICAgIEFyZ3M6DQogICAgICAgIGhhbmRsZXIgKEV2ZW50SG9va3MpOiBob29rIGhhbmRsZXINCiAgICAiIiINCiAgICBlbnZ2YXJzLnNldF9weXJldml0X2Vudl92YXIoZW52dmFycy5IT09LU0hBTkRMRVJfRU5WVkFSLCBoYW5kbGVyKQ0KDQoNCmRlZiBpc192YWxpZF9ob29rX3NjcmlwdChob29rX3NjcmlwdCk6DQogICAgIiIiQ2hlY2sgaWYgdGhlIGdpdmVuIGhvb2sgc2NyaXB0IGlzIHZhbGlkLg0KDQogICAgQXJnczoNCiAgICAgICAgaG9va19zY3JpcHQgKHN0cik6IGhvb2sgc2NyaXB0IHBhdGgNCg0KICAgIFJldHVybnM6DQogICAgICAgIChib29sKTogVHJ1ZSBpZiB0aGUgc2NyaXB0IGlzIHZhbGlkLCBGYWxzZSBvdGhlcndpc2UNCiAgICAiIiINCiAgICByZXR1cm4gb3Auc3BsaXRleHQob3AuYmFzZW5hbWUoaG9va19zY3JpcHQpKVsxXSBpbiBTVVBQT1JURURfTEFOR1VBR0VTDQoNCg0KZGVmIF9nZXRfaG9va19wYXJ0cyhleHRlbnNpb24sIGhvb2tfc2NyaXB0KToNCiAgICAjIGZpbmRzIHRoZSB0d28gcGFydHMgb2YgdGhlIGhvb2sgc2NyaXB0IG5hbWUNCiAgICAjIGUuZyBjb21tYW5kLWJlZm9yZS1leGVjW0lEX0lOUExBQ0VfQ09NUE9ORU5UXS5weQ0KICAgICMgKCdjb21tYW5kLWJlZm9yZS1leGVjJywgJ0lEX0lOUExBQ0VfQ09NUE9ORU5UJykNCiAgICBwYXJ0cyA9IHJlLmZpbmRhbGwoDQogICAgICAgIHInKFthLXogLV0rKVxbPyhbQS1aIF9dKyk/XF0/XC4uKycsDQogICAgICAgIG9wLmJhc2VuYW1lKGhvb2tfc2NyaXB0KQ0KICAgICAgICApDQogICAgaWYgcGFydHM6DQogICAgICAgIHJldHVybiBwYXJ0c1swXQ0KICAgIGVsc2U6DQogICAgICAgIHJldHVybiAnJywgJycNCg0KDQpkZWYgX2NyZWF0ZV9ob29rX2lkKGV4dGVuc2lvbiwgaG9va19zY3JpcHQpOg0KICAgIGhvb2tfc2NyaXB0X2lkID0gb3AuYmFzZW5hbWUoaG9va19zY3JpcHQpDQogICAgcGllY2VzID0gW2V4dGVuc2lvbi51bmlxdWVfbmFtZSwgaG9va19zY3JpcHRfaWRdDQogICAgcmV0dXJuIGNvcmV1dGlscy5jbGVhbnVwX3N0cmluZygNCiAgICAgICAgZXh0cy5VTklRVUVfSURfU0VQQVJBVE9SLmpvaW4ocGllY2VzKSwNCiAgICAgICAgc2tpcD1bZXh0cy5VTklRVUVfSURfU0VQQVJBVE9SXQ0KICAgICAgICApLmxvd2VyKCkNCg0KDQpkZWYgZ2V0X2V4dGVuc2lvbl9ob29rcyhleHRlbnNpb24pOg0KICAgICIiIkdldCB0aGUgaG9va3Mgb2YgdGhlIGdpdmVuIGV4dGVuc2lvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIGV4dGVuc2lvbiAocHlyZXZpdC5leHRlbnNpb25zLmNvbXBvbmVudHMuRXh0ZW5zaW9uKTogcHlSZXZpdCBleHRlbnNpb24NCg0KICAgIFJldHVybnM6DQogICAgICAgIChsaXN0W0V4dGVuc2lvbkV2ZW50SG9va10pOiBsaXN0IG9mIGhvb2tzDQogICAgIiIiDQogICAgZXZlbnRfaG9va3MgPSBbXQ0KICAgIGZvciBob29rX3NjcmlwdCBpbiBleHRlbnNpb24uZ2V0X2hvb2tzKCk6DQogICAgICAgIGlmIGlzX3ZhbGlkX2hvb2tfc2NyaXB0KGhvb2tfc2NyaXB0KToNCiAgICAgICAgICAgIG5hbWUsIHRhcmdldCA9IF9nZXRfaG9va19wYXJ0cyhleHRlbnNpb24sIGhvb2tfc2NyaXB0KQ0KICAgICAgICAgICAgaWYgbmFtZToNCiAgICAgICAgICAgICAgICBldmVudF9ob29rcy5hcHBlbmQoDQogICAgICAgICAgICAgICAgICAgIEV4dGVuc2lvbkV2ZW50SG9vaygNCiAgICAgICAgICAgICAgICAgICAgICAgIGlkPV9jcmVhdGVfaG9va19pZChleHRlbnNpb24sIGhvb2tfc2NyaXB0KSwNCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU9bmFtZSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldD10YXJnZXQsDQogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQ9aG9va19zY3JpcHQsDQogICAgICAgICAgICAgICAgICAgICAgICBzeXNwYXRocz1leHRlbnNpb24ubW9kdWxlX3BhdGhzLA0KICAgICAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uX25hbWU9ZXh0ZW5zaW9uLm5hbWUsDQogICAgICAgICAgICAgICAgICAgICkNCiAgICAgICAgICAgICAgICApDQogICAgcmV0dXJuIGV2ZW50X2hvb2tzDQoNCg0KZGVmIGdldF9ldmVudF9ob29rcygpOg0KICAgICIiIkdldCBhbGwgdGhlIGV2ZW50IGhvb2tzLiIiIg0KICAgIGhvb2tzX2hhbmRsZXIgPSBnZXRfaG9va3NfaGFuZGxlcigpDQogICAgcmV0dXJuIGhvb2tzX2hhbmRsZXIuR2V0QWxsRXZlbnRIb29rcygpDQoNCg0KZGVmIHJlZ2lzdGVyX2hvb2tzKGV4dGVuc2lvbik6DQogICAgIiIiUmVnaXN0ZXIgdGhlIGhvb2tzIGZvciB0aGUgZ2l2ZW4gZXh0ZW5zaW9uLg0KDQogICAgQXJnczoNCiAgICAgICAgZXh0ZW5zaW9uIChweXJldml0LmV4dGVuc2lvbnMuY29tcG9uZW50cy5FeHRlbnNpb24pOiBweVJldml0IGV4dGVuc2lvbg0KICAgICIiIg0KICAgIGhvb2tzX2hhbmRsZXIgPSBnZXRfaG9va3NfaGFuZGxlcigpDQogICAgZm9yIGV4dF9ob29rIGluIGdldF9leHRlbnNpb25faG9va3MoZXh0ZW5zaW9uKToNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgaG9va3NfaGFuZGxlci5SZWdpc3Rlckhvb2soDQogICAgICAgICAgICAgICAgdW5pcXVlSWQ9ZXh0X2hvb2suaWQsDQogICAgICAgICAgICAgICAgZXZlbnROYW1lPWV4dF9ob29rLm5hbWUsDQogICAgICAgICAgICAgICAgZXZlbnRUYXJnZXQ9ZXh0X2hvb2sudGFyZ2V0LA0KICAgICAgICAgICAgICAgIHNjcmlwdFBhdGg9ZXh0X2hvb2suc2NyaXB0LA0KICAgICAgICAgICAgICAgIHNlYXJjaFBhdGhzPWZyYW1ld29yay5BcnJheVtzdHJdKGV4dF9ob29rLnN5c3BhdGhzKSwNCiAgICAgICAgICAgICAgICBleHRlbnNpb25OYW1lPWV4dF9ob29rLmV4dGVuc2lvbl9uYW1lLA0KICAgICAgICAgICAgKQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGhvb2tFeDoNCiAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoIkZhaWxlZCByZWdpc3RlcmluZyBob29rIHNjcmlwdCAlcyB8ICVzIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0X2hvb2suc2NyaXB0LCBob29rRXgpDQoNCg0KZGVmIHVucmVnaXN0ZXJfaG9va3MoZXh0ZW5zaW9uKToNCiAgICAiIiJVbnJlZ2lzdGVyIGFsbCBob29rcyBmb3IgdGhlIGdpdmVuIGV4dGVuc2lvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIGV4dGVuc2lvbiAocHlyZXZpdC5leHRlbnNpb25zLmNvbXBvbmVudHMuRXh0ZW5zaW9uKTogcHlSZXZpdCBleHRlbnNpb24NCiAgICAiIiINCiAgICBob29rc19oYW5kbGVyID0gZ2V0X2hvb2tzX2hhbmRsZXIoKQ0KICAgIGZvciBleHRfaG9vayBpbiBnZXRfZXh0ZW5zaW9uX2hvb2tzKGV4dGVuc2lvbik6DQogICAgICAgIGhvb2tzX2hhbmRsZXIuVW5SZWdpc3Rlckhvb2sodW5pcXVlSWQ9ZXh0X2hvb2suaWQpDQoNCg0KZGVmIHVucmVnaXN0ZXJfYWxsX2hvb2tzKCk6DQogICAgIiIiVW5yZWdpc3RlciBhbGwgaG9va3MuIiIiDQogICAgaG9va3NfaGFuZGxlciA9IGdldF9ob29rc19oYW5kbGVyKCkNCiAgICBob29rc19oYW5kbGVyLlVuUmVnaXN0ZXJBbGxIb29rcyh1aUFwcD1IT1NUX0FQUC51aWFwcCkNCg0KDQpkZWYgYWN0aXZhdGUoKToNCiAgICAiIiJBY3RpdmF0ZSBhbGwgZXZlbnQgaG9va3MuIiIiDQogICAgaG9va3NfaGFuZGxlciA9IGdldF9ob29rc19oYW5kbGVyKCkNCiAgICBob29rc19oYW5kbGVyLkFjdGl2YXRlRXZlbnRIb29rcyh1aUFwcD1IT1NUX0FQUC51aWFwcCkNCg0KDQpkZWYgZGVhY3RpdmF0ZSgpOg0KICAgICIiIkRlYWN0aXZhdGUgYWxsIGV2ZW50IGhvb2tzLiIiIg0KICAgIGhvb2tzX2hhbmRsZXIgPSBnZXRfaG9va3NfaGFuZGxlcigpDQogICAgaG9va3NfaGFuZGxlci5EZWFjdGl2YXRlRXZlbnRIb29rcyh1aUFwcD1IT1NUX0FQUC51aWFwcCkNCg0KDQpkZWYgc2V0dXBfaG9va3Moc2Vzc2lvbl9pZD1Ob25lKToNCiAgICAiIiJTZXR1cCB0aGUgaG9va3MgZm9yIHRoZSBnaXZlbiBzZXNzaW9uLg0KICAgIA0KICAgIElmIG5vIHNlc3Npb24gaXMgc3BlY2lmaWVkLCB1c2UgdGhlIGN1cnJlbnQgb25lLg0KDQogICAgQXJnczoNCiAgICAgICAgc2Vzc2lvbl9pZCAoc3RyLCBvcHRpb25hbCk6IFNlc3Npb24uIERlZmF1bHRzIHRvIE5vbmUuDQogICAgIiIiDQogICAgIyBtYWtlIHN1cmUgc2Vzc2lvbiBpZCBpcyBhdmFpbGFiZQ0KICAgIGlmIG5vdCBzZXNzaW9uX2lkOg0KICAgICAgICBzZXNzaW9uX2lkID0gc2Vzc2lvbmluZm8uZ2V0X3Nlc3Npb25fdXVpZCgpDQoNCiAgICBob29rc19oYW5kbGVyID0gZ2V0X2hvb2tzX2hhbmRsZXIoKQ0KICAgIGlmIGhvb2tzX2hhbmRsZXI6DQogICAgICAgICMgZGVhY3RpdmF0ZSBvbGQNCiAgICAgICAgaG9va3NfaGFuZGxlci5EZWFjdGl2YXRlRXZlbnRIb29rcyh1aUFwcD1IT1NUX0FQUC51aWFwcCkNCiAgICAjIHNldHVwIG5ldw0KICAgIGhvb2tzX2hhbmRsZXIgPSBFdmVudEhvb2tzKHNlc3Npb25faWQpDQogICAgc2V0X2hvb2tzX2hhbmRsZXIoaG9va3NfaGFuZGxlcikNCiAgICB1bnJlZ2lzdGVyX2FsbF9ob29rcygpDQoNCiIiIk1hbmFnZSBpbmZvcm1hdGlvbiBhYm91dCBweVJldml0IHNlc3Npb25zLiIiIg0KaW1wb3J0IHN5cw0KZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgbmFtZWR0dXBsZQ0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IEhPU1RfQVBQLCBIT01FX0RJUg0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IHZlcnNpb25tZ3INCmZyb20gcHlyZXZpdC5jb21wYXQgaW1wb3J0IHNhZmVfc3RydHlwZQ0KZnJvbSBweXJldml0LnZlcnNpb25tZ3IgaW1wb3J0IGFib3V0DQpmcm9tIHB5cmV2aXQgaW1wb3J0IGNvcmV1dGlscw0KZnJvbSBweXJldml0LmNvcmV1dGlscy5sb2dnZXIgaW1wb3J0IGdldF9sb2dnZXINCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGVudnZhcnMNCmZyb20gcHlyZXZpdC51c2VyY29uZmlnIGltcG9ydCB1c2VyX2NvbmZpZw0KZnJvbSBweXJldml0IGltcG9ydCBydW50aW1lDQpmcm9tIHB5cmV2aXQubG9hZGVyLnN5c3RlbWRpYWcgaW1wb3J0IHN5c3RlbV9kaWFnDQoNCg0KI3B5bGludDogZGlzYWJsZT1XMDcwMyxDMDMwMixDMDEwMw0KbWxvZ2dlciA9IGdldF9sb2dnZXIoX19uYW1lX18pDQoNCg0KUnVudGltZUluZm8gPSBuYW1lZHR1cGxlKCdSdW50aW1lSW5mbycsIFsncHlyZXZpdF92ZXJzaW9uJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2VuZ2luZV92ZXJzaW9uJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2hvc3RfdmVyc2lvbiddKQ0KIiIiU2Vzc2lvbiBydW50aW1lIGluZm9ybWF0aW9uIHR1cGxlLg0KDQpBcmdzOg0KICAgIHB5cmV2aXRfdmVyc2lvbiAoc3RyKTogZm9ybWF0dGVkIHB5UmV2aXQgdmVyc2lvbg0KICAgIGVuZ2luZV92ZXJzaW9uIChpbnQpOiBhY3RpdmUgSXJvblB5dGhvbiBlbmdpbmUgdmVyc2lvbg0KICAgIGhvc3RfdmVyc2lvbiAoc3RyKTogQ3VycmVudCBSZXZpdCB2ZXJzaW9uDQoiIiINCg0KDQpkZWYgc2V0dXBfcnVudGltZV92YXJzKCk6DQogICAgIiIiU2V0dXAgcnVudGltZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgd2l0aCBzZXNzaW9uIGluZm9ybWF0aW9uLiIiIg0KICAgICMgc2V0IHB5cmV2aXQgdmVyc2lvbg0KICAgIHB5cnZ0X3ZlciA9IHZlcnNpb25tZ3IuZ2V0X3B5cmV2aXRfdmVyc2lvbigpLmdldF9mb3JtYXR0ZWQoKQ0KICAgIGVudnZhcnMuc2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLlZFUlNJT05fRU5WVkFSLCBweXJ2dF92ZXIpDQoNCiAgICAjIHNldCBhcHAgdmVyc2lvbiBlbnYgdmFyDQogICAgaWYgSE9TVF9BUFAuaXNfbmV3ZXJfdGhhbigyMDE3KToNCiAgICAgICAgZW52dmFycy5zZXRfcHlyZXZpdF9lbnZfdmFyKGVudnZhcnMuQVBQVkVSU0lPTl9FTlZWQVIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBIT1NUX0FQUC5zdWJ2ZXJzaW9uKQ0KICAgIGVsc2U6DQogICAgICAgIGVudnZhcnMuc2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLkFQUFZFUlNJT05fRU5WVkFSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSE9TVF9BUFAudmVyc2lvbikNCg0KICAgICMgc2V0IGlyb25weXRob24gZW5naW5lIHZlcnNpb24gZW52IHZhcg0KICAgIGF0dGFjaG1lbnQgPSB1c2VyX2NvbmZpZy5nZXRfY3VycmVudF9hdHRhY2htZW50KCkNCiAgICBpZiBhdHRhY2htZW50IGFuZCBhdHRhY2htZW50LkNsb25lOg0KICAgICAgICBlbnZ2YXJzLnNldF9weXJldml0X2Vudl92YXIoZW52dmFycy5DTE9ORU5BTUVfRU5WVkFSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0YWNobWVudC5DbG9uZS5OYW1lKQ0KICAgICAgICBlbnZ2YXJzLnNldF9weXJldml0X2Vudl92YXIoZW52dmFycy5JUFlWRVJTSU9OX0VOVlZBUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cihhdHRhY2htZW50LkVuZ2luZS5WZXJzaW9uKSkNCiAgICBlbHNlOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDYW4gbm90IGRldGVybWluZSBhdHRhY2htZW50LicpDQogICAgICAgIGVudnZhcnMuc2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLkNMT05FTkFNRV9FTlZWQVIsICJVbmtub3duIikNCiAgICAgICAgZW52dmFycy5zZXRfcHlyZXZpdF9lbnZfdmFyKGVudnZhcnMuSVBZVkVSU0lPTl9FTlZWQVIsICIwIikNCg0KICAgICMgc2V0IGNweXRob24gZW5naW5lIHZlcnNpb24gZW52IHZhcg0KICAgIGNweWVuZ2luZSA9IHVzZXJfY29uZmlnLmdldF9hY3RpdmVfY3B5dGhvbl9lbmdpbmUoKQ0KICAgIGlmIGNweWVuZ2luZToNCiAgICAgICAgZW52dmFycy5zZXRfcHlyZXZpdF9lbnZfdmFyKGVudnZhcnMuQ1BZVkVSU0lPTl9FTlZWQVIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIoY3B5ZW5naW5lLlZlcnNpb24pKQ0KICAgIGVsc2U6DQogICAgICAgIGVudnZhcnMuc2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLkNQWVZFUlNJT05fRU5WVkFSLCAiMCIpDQoNCiAgICAjIHNldCBhIGxpc3Qgb2YgaW1wb3J0YW50IGFzc2VtYmxpZXMNCiAgICAjIHRoaXMgaXMgcmVxdWlyZWQgZm9yIGRvdG5ldCBzY3JpcHQgZXhlY3V0aW9uDQogICAgc2V0X2xvYWRlZF9weXJldml0X3JlZmVyZW5jZWRfbW9kdWxlcygNCiAgICAgICAgcnVudGltZS5nZXRfcmVmZXJlbmNlcygpDQogICAgICAgICkNCg0KDQpkZWYgZ2V0X3J1bnRpbWVfaW5mbygpOg0KICAgICIiIlJldHVybiBydW50aW1lIGluZm9ybWF0aW9uIHR1cGxlLg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKFJ1bnRpbWVJbmZvKTogcnVudGltZSBpbmZvIHR1cGxlDQoNCiAgICBFeGFtcGxlczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIHNlc3Npb25pbmZvLmdldF9ydW50aW1lX2luZm8oKQ0KICAgICAgICBgYGANCiAgICAiIiINCiAgICAjIEZJWE1FOiBhZGQgZXhhbXBsZSBvdXRwdXQNCiAgICByZXR1cm4gUnVudGltZUluZm8oDQogICAgICAgIHB5cmV2aXRfdmVyc2lvbj1lbnZ2YXJzLmdldF9weXJldml0X2Vudl92YXIoZW52dmFycy5WRVJTSU9OX0VOVlZBUiksDQogICAgICAgIGVuZ2luZV92ZXJzaW9uPWVudnZhcnMuZ2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLklQWVZFUlNJT05fRU5WVkFSKSwNCiAgICAgICAgaG9zdF92ZXJzaW9uPWVudnZhcnMuZ2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLkFQUFZFUlNJT05fRU5WVkFSKQ0KICAgICAgICApDQoNCg0KZGVmIHNldF9zZXNzaW9uX3V1aWQodXVpZF9zdHIpOg0KICAgICIiIlNldCBzZXNzaW9uIHV1aWQgb24gZW52aXJvbm1lbnQgdmFyaWFibGUuDQoNCiAgICBBcmdzOg0KICAgICAgICB1dWlkX3N0ciAoc3RyKTogc2Vzc2lvbiB1dWlkIHN0cmluZw0KICAgICIiIg0KICAgIGVudnZhcnMuc2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLlNFU1NJT05VVUlEX0VOVlZBUiwgdXVpZF9zdHIpDQoNCg0KZGVmIGdldF9zZXNzaW9uX3V1aWQoKToNCiAgICAiIiJSZWFkIHNlc3Npb24gdXVpZCBmcm9tIGVudmlyb25tZW50IHZhcmlhYmxlLg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IHNlc3Npb24gdXVpZCBzdHJpbmcNCiAgICAiIiINCiAgICByZXR1cm4gZW52dmFycy5nZXRfcHlyZXZpdF9lbnZfdmFyKGVudnZhcnMuU0VTU0lPTlVVSURfRU5WVkFSKQ0KDQoNCmRlZiBuZXdfc2Vzc2lvbl91dWlkKCk6DQogICAgIiIiQ3JlYXRlIGEgbmV3IHV1aWQgZm9yIGEgcHlSZXZpdCBzZXNzaW9uLg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IHNlc3Npb24gdXVpZCBzdHJpbmcNCiAgICAiIiINCiAgICB1dWlkX3N0ciA9IHNhZmVfc3RydHlwZShjb3JldXRpbHMubmV3X3V1aWQoKSkNCiAgICBzZXRfc2Vzc2lvbl91dWlkKHV1aWRfc3RyKQ0KICAgIHJldHVybiB1dWlkX3N0cg0KDQoNCmRlZiBnZXRfbG9hZGVkX3B5cmV2aXRfYXNzZW1ibGllcygpOg0KICAgICIiIlJldHVybiBsaXN0IG9mIGxvYWRlZCBweVJldml0IGFzc2VtYmxpZXMgZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZS4NCg0KICAgIFJldHVybnM6DQogICAgICAgIChsaXN0W3N0cl0pOiBsaXN0IG9mIGxvYWRlZCBhc3NlbWJsaWVzDQogICAgIiIiDQogICAgIyBGSVhNRTogdmVyaWZ5IGFuZCBkb2N1bWVudCByZXR1cm4gdHlwZQ0KICAgIGxvYWRlZF9hc3Ntc19zdHIgPSBlbnZ2YXJzLmdldF9weXJldml0X2Vudl92YXIoZW52dmFycy5MT0FERURBU1NNU19FTlZWQVIpDQogICAgaWYgbG9hZGVkX2Fzc21zX3N0cjoNCiAgICAgICAgcmV0dXJuIGxvYWRlZF9hc3Ntc19zdHIuc3BsaXQoY29yZXV0aWxzLkRFRkFVTFRfU0VQQVJBVE9SKQ0KICAgIGVsc2U6DQogICAgICAgIHJldHVybiBbXQ0KDQoNCmRlZiBzZXRfbG9hZGVkX3B5cmV2aXRfYXNzZW1ibGllcyhsb2FkZWRfYXNzbV9uYW1lX2xpc3QpOg0KICAgICIiIlNldCB0aGUgZW52aXJvbm1lbnQgdmFyaWFibGUgd2l0aCBsaXN0IG9mIGxvYWRlZCBhc3NlbWJsaWVzLg0KDQogICAgQXJnczoNCiAgICAgICAgbG9hZGVkX2Fzc21fbmFtZV9saXN0IChsaXN0W3N0cl0pOiBsaXN0IG9mIGFzc2VtYmx5IG5hbWVzDQogICAgIiIiDQogICAgZW52dmFycy5zZXRfcHlyZXZpdF9lbnZfdmFyKA0KICAgICAgICBlbnZ2YXJzLkxPQURFREFTU01TX0VOVlZBUiwNCiAgICAgICAgY29yZXV0aWxzLkRFRkFVTFRfU0VQQVJBVE9SLmpvaW4obG9hZGVkX2Fzc21fbmFtZV9saXN0KQ0KICAgICAgICApDQoNCg0KZGVmIGdldF9sb2FkZWRfcHlyZXZpdF9yZWZlcmVuY2VkX21vZHVsZXMoKToNCiAgICBsb2FkZWRfYXNzbXNfc3RyID0gZW52dmFycy5nZXRfcHlyZXZpdF9lbnZfdmFyKGVudnZhcnMuUkVGRURBU1NNU19FTlZWQVIpDQogICAgaWYgbG9hZGVkX2Fzc21zX3N0cjoNCiAgICAgICAgcmV0dXJuIHNldChsb2FkZWRfYXNzbXNfc3RyLnNwbGl0KGNvcmV1dGlscy5ERUZBVUxUX1NFUEFSQVRPUikpDQogICAgZWxzZToNCiAgICAgICAgcmV0dXJuIHNldCgpDQoNCg0KZGVmIHNldF9sb2FkZWRfcHlyZXZpdF9yZWZlcmVuY2VkX21vZHVsZXMobG9hZGVkX2Fzc21fbmFtZV9saXN0KToNCiAgICBlbnZ2YXJzLnNldF9weXJldml0X2Vudl92YXIoDQogICAgICAgIGVudnZhcnMuUkVGRURBU1NNU19FTlZWQVIsDQogICAgICAgIGNvcmV1dGlscy5ERUZBVUxUX1NFUEFSQVRPUi5qb2luKGxvYWRlZF9hc3NtX25hbWVfbGlzdCkNCiAgICAgICAgKQ0KDQoNCmRlZiB1cGRhdGVfbG9hZGVkX3B5cmV2aXRfcmVmZXJlbmNlZF9tb2R1bGVzKGxvYWRlZF9hc3NtX25hbWVfbGlzdCk6DQogICAgbG9hZGVkX21vZHVsZXMgPSBnZXRfbG9hZGVkX3B5cmV2aXRfcmVmZXJlbmNlZF9tb2R1bGVzKCkNCiAgICBsb2FkZWRfbW9kdWxlcy51cGRhdGUobG9hZGVkX2Fzc21fbmFtZV9saXN0KQ0KICAgIHNldF9sb2FkZWRfcHlyZXZpdF9yZWZlcmVuY2VkX21vZHVsZXMobG9hZGVkX21vZHVsZXMpDQoNCg0KZGVmIHJlcG9ydF9lbnYoKToNCiAgICAiIiJSZXBvcnQgcHl0aG9uIHZlcnNpb24sIGhvbWUgZGlyZWN0b3J5LCBjb25maWcgZmlsZSwgZXRjLiIiIg0KICAgICMgcnVuIGRpYWdub3N0aWNzDQogICAgc3lzdGVtX2RpYWcoKQ0KDQogICAgIyBnZXQgcHl0aG9uIHZlcnNpb24gdGhhdCBpbmNsdWRlcyBsYXN0IGNvbW1pdCBoYXNoDQogICAgbWxvZ2dlci5pbmZvKCdweVJldml0IHZlcnNpb246ICVzIC0gPC8+IHdpdGggOmdyb3dpbmdfaGVhcnQ6IGluICVzJywNCiAgICAgICAgICAgICAgICAgZW52dmFycy5nZXRfcHlyZXZpdF9lbnZfdmFyKGVudnZhcnMuVkVSU0lPTl9FTlZWQVIpLA0KICAgICAgICAgICAgICAgICBhYm91dC5nZXRfcHlyZXZpdF9hYm91dCgpLm1hZGVpbikNCg0KICAgIGlmIHVzZXJfY29uZmlnLnJvY2tldF9tb2RlOg0KICAgICAgICBtbG9nZ2VyLmluZm8oJ3B5UmV2aXQgUm9ja2V0IE1vZGUgZW5hYmxlZC4gOnJvY2tldDonKQ0KDQogICAgbWxvZ2dlci5pbmZvKCdIb3N0IGlzICVzIHBpZDogJXMnLCBIT1NUX0FQUC5wcmV0dHlfbmFtZSwgSE9TVF9BUFAucHJvY19pZCkNCiAgICAjIGlweSAyLjcuMTAgaGFzIGEgbmV3IGxpbmUgaW4gaXRzIHN5cy52ZXJzaW9uIDpyb2xsaW5nLWV5ZXMtZW1vamk6DQogICAgbWxvZ2dlci5pbmZvKCdSdW5uaW5nIG9uOiAlcycsIHN5cy52ZXJzaW9uLnJlcGxhY2UoJ1xuJywgJyAnKSkNCiAgICBtbG9nZ2VyLmluZm8oJ1VzZXIgaXM6ICVzJywgSE9TVF9BUFAudXNlcm5hbWUpDQogICAgbWxvZ2dlci5pbmZvKCdIb21lIERpcmVjdG9yeSBpczogJXMnLCBIT01FX0RJUikNCiAgICBtbG9nZ2VyLmluZm8oJ1Nlc3Npb24gdXVpZCBpczogJXMnLCBnZXRfc2Vzc2lvbl91dWlkKCkpDQogICAgbWxvZ2dlci5pbmZvKCdSdW50aW1lIGFzc2VtYmx5IGlzOiAlcycsIHJ1bnRpbWUuUlVOVElNRV9BU1NNX05BTUUpDQogICAgbWxvZ2dlci5pbmZvKCdDb25maWcgZmlsZSBpcyAoJXMpOiAlcycsDQogICAgICAgICAgICAgICAgIHVzZXJfY29uZmlnLmNvbmZpZ190eXBlLCB1c2VyX2NvbmZpZy5jb25maWdfZmlsZSkNCg0KIiIiVGhlIGxvYWRlciBtb2R1bGUgbWFuYWdlcyB0aGUgd29ya2Zsb3cgb2YgbG9hZGluZyBhIG5ldyBweVJldml0IHNlc3Npb24uDQoNCkl0cyBtYWluIHB1cnBvc2UgaXMgdG8gb3JjaGVzdHJhdGUgdGhlIHByb2Nlc3Mgb2YgZmluZGluZyBweVJldml0IGV4dGVuc2lvbnMsDQpjcmVhdGluZyBkbGwgYXNzZW1ibGllcyBmb3IgdGhlbSwgYW5kIGNyZWF0aW5nIGEgdXNlciBpbnRlcmZhY2UNCmluIHRoZSBob3N0IGFwcGxpY2F0aW9uLg0KDQpFdmVyeXRoaW5nIHN0YXJ0cyBmcm9tIGBzZXNzaW9ubWdyLmxvYWRfc2Vzc2lvbigpYCBmdW5jdGlvbi4uLg0KDQpUaGUgb25seSBwdWJsaWMgZnVuY3Rpb24gaXMgYGxvYWRfc2Vzc2lvbigpYCB0aGF0IGxvYWRzIGEgbmV3IHNlc3Npb24uDQpFdmVyeXRoaW5nIGVsc2UgaXMgcHJpdmF0ZS4NCiIiIg0KaW1wb3J0IHN5cw0KZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgbmFtZWR0dXBsZQ0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IEVYRUNfUEFSQU1TLCBIT1NUX0FQUA0KZnJvbSBweXJldml0IGltcG9ydCBNQUlOX0xJQl9ESVIsIE1JU0NfTElCX0RJUg0KZnJvbSBweXJldml0IGltcG9ydCBmcmFtZXdvcmsNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IFRpbWVyDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzIGltcG9ydCBhc3NtdXRpbHMNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGVudnZhcnMNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGFwcGRhdGENCmZyb20gcHlyZXZpdC5jb3JldXRpbHMgaW1wb3J0IGxvZ2dlcg0KZnJvbSBweXJldml0LmNvcmV1dGlscyBpbXBvcnQgYXBwbG9jYWxlcw0KZnJvbSBweXJldml0LmxvYWRlciBpbXBvcnQgc2Vzc2lvbmluZm8NCmZyb20gcHlyZXZpdC5sb2FkZXIgaW1wb3J0IGFzbW1ha2VyDQpmcm9tIHB5cmV2aXQubG9hZGVyIGltcG9ydCB1aW1ha2VyDQpmcm9tIHB5cmV2aXQubG9hZGVyIGltcG9ydCBob29rcw0KZnJvbSBweXJldml0LnVzZXJjb25maWcgaW1wb3J0IHVzZXJfY29uZmlnDQpmcm9tIHB5cmV2aXQuZXh0ZW5zaW9ucyBpbXBvcnQgZXh0ZW5zaW9ubWdyDQpmcm9tIHB5cmV2aXQudmVyc2lvbm1nciBpbXBvcnQgdXBkYXRlcg0KZnJvbSBweXJldml0LnZlcnNpb25tZ3IgaW1wb3J0IHVwZ3JhZGUNCmZyb20gcHlyZXZpdCBpbXBvcnQgdGVsZW1ldHJ5DQpmcm9tIHB5cmV2aXQgaW1wb3J0IHJvdXRlcw0KIyBpbXBvcnQgdGhlIHJ1bnRpbWUgZmlyc3QgdG8gZ2V0IGFsbCB0aGUgYy1zaGFycCBjb2RlIHRvIGNvbXBpbGUNCmZyb20gcHlyZXZpdCBpbXBvcnQgcnVudGltZQ0KZnJvbSBweXJldml0LnJ1bnRpbWUgaW1wb3J0IHR5cGVzIGFzIHJ1bnRpbWVfdHlwZXMNCiMgbm93IGxvYWQgdGhlIHJlc3Qgb2YgbW9kdWxlIHRoYXQgY291bGQgZGVwZW5kIG9uIHRoZSBjb21waWxlZCBydW50aW1lDQpmcm9tIHB5cmV2aXQgaW1wb3J0IG91dHB1dA0KDQpmcm9tIHB5cmV2aXQgaW1wb3J0IERCLCBVSSwgcmV2aXQNCg0KDQojcHlsaW50OiBkaXNhYmxlPVcwNzAzLEMwMzAyLEMwMTAzLG5vLW1lbWJlcg0KbWxvZ2dlciA9IGxvZ2dlci5nZXRfbG9nZ2VyKF9fbmFtZV9fKQ0KDQoNCkFzc2VtYmxlZEV4dGVuc2lvbiA9IG5hbWVkdHVwbGUoJ0Fzc2VtYmxlZEV4dGVuc2lvbicsIFsnZXh0JywgJ2Fzc20nXSkNCg0KDQpkZWYgX2NsZWFyX3J1bm5pbmdfZW5naW5lcygpOg0KICAgICMgY2xlYXIgdGhlIGNhY2hlZCBlbmdpbmVzDQogICAgdHJ5Og0KICAgICAgICBteV9vdXRwdXQgPSBvdXRwdXQuZ2V0X291dHB1dCgpDQogICAgICAgIGlmIG15X291dHB1dDoNCiAgICAgICAgICAgIG15X291dHB1dC5jbG9zZV9vdGhlcnMoYWxsX29wZW5fb3V0cHV0cz1UcnVlKQ0KDQogICAgICAgIHJ1bnRpbWVfdHlwZXMuU2NyaXB0RW5naW5lTWFuYWdlci5DbGVhckVuZ2luZXMoDQogICAgICAgICAgICBleGNsdWRlRW5naW5lPUVYRUNfUEFSQU1TLmVuZ2luZV9pZA0KICAgICAgICAgICAgKQ0KICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoNCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCg0KZGVmIF9zZXR1cF9vdXRwdXQoKToNCiAgICAjIGNyZWF0ZSBvdXRwdXQgd2luZG93IGFuZCBhc3NpZ24gaGFuZGxlDQogICAgb3V0X3dpbmRvdyA9IHJ1bnRpbWUudHlwZXMuU2NyaXB0Q29uc29sZSgpDQogICAgcnVudGltZV9pbmZvID0gc2Vzc2lvbmluZm8uZ2V0X3J1bnRpbWVfaW5mbygpDQogICAgb3V0X3dpbmRvdy5BcHBWZXJzaW9uID0gJ3t9Ont9Ont9Jy5mb3JtYXQoDQogICAgICAgIHJ1bnRpbWVfaW5mby5weXJldml0X3ZlcnNpb24sDQogICAgICAgIGludChydW50aW1lX2luZm8uZW5naW5lX3ZlcnNpb24pLA0KICAgICAgICBydW50aW1lX2luZm8uaG9zdF92ZXJzaW9uDQogICAgICAgICkNCg0KICAgICMgY3JlYXRlIG91dHB1dCBzdHJlYW0gYW5kIHNldCBzdGRvdXQgdG8gaXQNCiAgICAjIHdlJ3JlIG5vdCBvcGVuaW5nIHRoZSBvdXRwdXQgd2luZG93IGhlcmUuDQogICAgIyBUaGUgb3V0cHV0IHN0cmVhbSB3aWxsIG9wZW4gdGhlIHdpbmRvdyBpZiBhbnl0aGluZyBpcyBiZWluZyBwcmludGVkLg0KICAgIG91dHN0ciA9IHJ1bnRpbWUudHlwZXMuU2NyaXB0SU8ob3V0X3dpbmRvdykNCiAgICBzeXMuc3Rkb3V0ID0gb3V0c3RyDQogICAgIyBzeXMuc3RkZXJyID0gb3V0c3RyDQogICAgc3Rkb3V0X2huZGxyID0gbG9nZ2VyLmdldF9zdGRvdXRfaG5kbHIoKQ0KICAgIHN0ZG91dF9obmRsci5zdHJlYW0gPSBvdXRzdHINCg0KICAgIHJldHVybiBvdXRfd2luZG93DQoNCg0KZGVmIF9jbGVhbnVwX291dHB1dCgpOg0KICAgIHN5cy5zdGRvdXQgPSBOb25lDQogICAgc3Rkb3V0X2huZGxyID0gbG9nZ2VyLmdldF9zdGRvdXRfaG5kbHIoKQ0KICAgIHN0ZG91dF9obmRsci5zdHJlYW0gPSBOb25lDQoNCg0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KIyBGdW5jdGlvbnMgcmVsYXRlZCB0byBjcmVhdGluZy9sb2FkaW5nIGEgbmV3IHB5UmV2aXQgc2Vzc2lvbg0KIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KZGVmIF9jaGVja19hdXRvdXBkYXRlX2lucHJvZ3Jlc3MoKToNCiAgICByZXR1cm4gZW52dmFycy5nZXRfcHlyZXZpdF9lbnZfdmFyKGVudnZhcnMuQVVUT1VQREFUSU5HX0VOVlZBUikNCg0KDQpkZWYgX3NldF9hdXRvdXBkYXRlX2lucHJvZ3Jlc3Moc3RhdGUpOg0KICAgIGVudnZhcnMuc2V0X3B5cmV2aXRfZW52X3ZhcihlbnZ2YXJzLkFVVE9VUERBVElOR19FTlZWQVIsIHN0YXRlKQ0KDQoNCmRlZiBfcGVyZm9ybV9vbnNlc3Npb25sb2Fkc3RhcnRfb3BzKCk6DQogICAgIyBjbGVhciB0aGUgY2FjaGVkIGVuZ2luZXMNCiAgICBpZiBub3QgX2NsZWFyX3J1bm5pbmdfZW5naW5lcygpOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdObyBFbmdpbmUgTWFuYWdlciBleGlzdHMuLi4nKQ0KDQogICAgIyBjaGVjayBmb3IgdXBkYXRlcw0KICAgIGlmIHVzZXJfY29uZmlnLmF1dG9fdXBkYXRlIFwNCiAgICAgICAgICAgIGFuZCBub3QgX2NoZWNrX2F1dG91cGRhdGVfaW5wcm9ncmVzcygpOg0KICAgICAgICBtbG9nZ2VyLmluZm8oJ0F1dG8tdXBkYXRlIGlzIGFjdGl2ZS4gQXR0ZW1wdGluZyB1cGRhdGUuLi4nKQ0KICAgICAgICBfc2V0X2F1dG91cGRhdGVfaW5wcm9ncmVzcyhUcnVlKQ0KICAgICAgICB1cGRhdGVyLnVwZGF0ZV9weXJldml0KCkNCiAgICAgICAgX3NldF9hdXRvdXBkYXRlX2lucHJvZ3Jlc3MoRmFsc2UpDQoNCiAgICAjIG9uY2UgcHJlLWxvYWQgaXMgY29tcGxldGUsIHJlcG9ydCBlbnZpcm9ubWVudCBjb25kaXRpb25zDQogICAgdXVpZF9zdHIgPSBzZXNzaW9uaW5mby5uZXdfc2Vzc2lvbl91dWlkKCkNCiAgICBzZXNzaW9uaW5mby5yZXBvcnRfZW52KCkNCg0KICAgICMgcmVzZXQgdGhlIGxpc3Qgb2YgYXNzZW1ibGllcyBsb2FkZWQgdW5kZXIgcHlSZXZpdCBzZXNzaW9uDQogICAgc2Vzc2lvbmluZm8uc2V0X2xvYWRlZF9weXJldml0X2Fzc2VtYmxpZXMoW10pDQoNCiAgICAjIGluaXQgZXhlY3V0b3INCiAgICBydW50aW1lX3R5cGVzLlNjcmlwdEV4ZWN1dG9yLkluaXRpYWxpemUoKQ0KDQogICAgIyBpbml0IHJvdXRlcw0KICAgIHJvdXRlcy5pbml0KCkNCg0KICAgICMgYXNraW5nIHRlbGVtZXRyeSBtb2R1bGUgdG8gc2V0dXAgdGhlIHRlbGVtZXRyeSBzeXN0ZW0NCiAgICAjIChhY3RpdmUgb3Igbm90IGFjdGl2ZSkNCiAgICB0ZWxlbWV0cnkuc2V0dXBfdGVsZW1ldHJ5KHV1aWRfc3RyKQ0KDQogICAgIyBhcHBseSBVcGdyYWRlcw0KICAgIHVwZ3JhZGUudXBncmFkZV9leGlzdGluZ19weXJldml0KCkNCg0KICAgICMgc2V0dXAgaG9va3MNCiAgICBob29rcy5zZXR1cF9ob29rcygpDQoNCg0KZGVmIF9wZXJmb3JtX29uc2Vzc2lvbmxvYWRjb21wbGV0ZV9vcHMoKToNCiAgICAjIGNsZWFudXAgb2xkIGFzc2VtYmx5IGZpbGVzLg0KICAgIGFzbW1ha2VyLmNsZWFudXBfYXNzZW1ibHlfZmlsZXMoKQ0KDQogICAgIyBjbGVhbiB1cCB0ZW1wIGFwcCBmaWxlcyBiZXR3ZWVuIHNlc3Npb25zLg0KICAgIGFwcGRhdGEuY2xlYW51cF9hcHBkYXRhX2ZvbGRlcigpDQoNCiAgICAjIGFjdGl2YXRlIGhvb2tzIG5vdw0KICAgIGhvb2tzLmFjdGl2YXRlKCkNCg0KICAgICMgYWN0aXZhdGUgaW50ZXJuYWwgaGFuZGxlcnMNCiAgICAjIHRvZ2dsZSBkb2MgY29sb3JpemVyDQogICAgcmV2aXQudGFicy5pbml0X2RvY19jb2xvcml6ZXIodXNlcl9jb25maWcpDQoNCiAgICAjIGFjdGl2YXRlIHJ1bnRpbWUgcm91dGVzIHNlcnZlcg0KICAgIGlmIHVzZXJfY29uZmlnLnJvdXRlc19zZXJ2ZXI6DQogICAgICAgIHJvdXRlcy5hY3RpdmVfcm91dGVzX2FwaSgpDQogICAgICAgIGFjdGl2ZV9zZXJ2ZXIgPSByb3V0ZXMuYWN0aXZhdGVfc2VydmVyKCkNCiAgICAgICAgaWYgYWN0aXZlX3NlcnZlcjoNCiAgICAgICAgICAgIG1sb2dnZXIuaW5mbyhzdHIoYWN0aXZlX3NlcnZlcikpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBtbG9nZ2VyLmVycm9yKCdSb3V0ZXMgc2VydmVycyBmYWlsZWQgYWN0aXZhdGlvbicpDQoNCg0KZGVmIF9uZXdfc2Vzc2lvbigpOg0KICAgICIiIkNyZWF0ZSBhbiBhc3NlbWJseSBhbmQgVUkgZm9yIGVhY2ggaW5zdGFsbGVkIFVJIGV4dGVuc2lvbnMuIiIiDQogICAgYXNzZW1ibGVkX2V4dHMgPSBbXQ0KICAgICMgZ2V0IGFsbCBpbnN0YWxsZWQgdWkgZXh0ZW5zaW9ucw0KICAgIGZvciB1aV9leHQgaW4gZXh0ZW5zaW9ubWdyLmdldF9pbnN0YWxsZWRfdWlfZXh0ZW5zaW9ucygpOg0KICAgICAgICAjIGNvbmZpZ3VyZSBleHRlbnNpb24gY29tcG9uZW50cyBmb3IgbWV0YWRhdGENCiAgICAgICAgIyBlLmcuIGxpcXVpZCB0ZW1wbGF0ZXMgbGlrZSB7e2F1dGhvcn19DQogICAgICAgIHVpX2V4dC5jb25maWd1cmUoKQ0KDQogICAgICAgICMgY29sbGVjdCBhbGwgbW9kdWxlIHJlZmVyZW5jZXMgZnJvbSBleHRlbnNpb25zDQogICAgICAgIHVpX2V4dF9tb2R1bGVzID0gW10NCiAgICAgICAgIyBGSVhNRTogY3VycmVudGx5IGRsbHMgaW5zaWRlIGJpbi8gYXJlIG5vdCBwcmUtbG9hZGVkIHNpbmNlDQogICAgICAgICMgdGhpcyB3aWxsIGxvY2sgdGhlbSBieSBSZXZpdC4gTWF5YmUgYWxsIGRsbHMgc2hvdWxkIGJlIGxvYWRlZA0KICAgICAgICAjIGZyb20gbWVtb3J5IChyZWFkIGJpbmFyeSBhbmQgbG9hZCBhc3NlbWJseSk/DQogICAgICAgICMgdWlfZXh0X21vZHVsZXMuZXh0ZW5kKHVpX2V4dC5nZXRfZXh0ZW5zaW9uX21vZHVsZXMoKSkNCiAgICAgICAgdWlfZXh0X21vZHVsZXMuZXh0ZW5kKHVpX2V4dC5nZXRfY29tbWFuZF9tb2R1bGVzKCkpDQogICAgICAgICMgbWFrZSBzdXJlIHRoZXkgYXJlIGFsbCBsb2FkZWQNCiAgICAgICAgYXNzbXV0aWxzLmxvYWRfYXNtX2ZpbGVzKHVpX2V4dF9tb2R1bGVzKQ0KICAgICAgICAjIGFuZCB1cGRhdGUgZW52IGluZm9ybWF0aW9uDQogICAgICAgIHNlc3Npb25pbmZvLnVwZGF0ZV9sb2FkZWRfcHlyZXZpdF9yZWZlcmVuY2VkX21vZHVsZXModWlfZXh0X21vZHVsZXMpDQoNCiAgICAgICAgIyBjcmVhdGUgYSBkbGwgYXNzZW1ibHkgYW5kIGdldCBhc3NlbWJseSBpbmZvDQogICAgICAgIGV4dF9hc21faW5mbyA9IGFzbW1ha2VyLmNyZWF0ZV9hc3NlbWJseSh1aV9leHQpDQogICAgICAgIGlmIG5vdCBleHRfYXNtX2luZm86DQogICAgICAgICAgICBtbG9nZ2VyLmNyaXRpY2FsKCdGYWlsZWQgdG8gY3JlYXRlIGFzc2VtYmx5IGZvcjogJXMnLCB1aV9leHQpDQogICAgICAgICAgICBjb250aW51ZQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgbWxvZ2dlci5pbmZvKCdFeHRlbnNpb24gYXNzZW1ibHkgY3JlYXRlZDogJXMnLCB1aV9leHQubmFtZSkNCg0KICAgICAgICBhc3NlbWJsZWRfZXh0cy5hcHBlbmQoDQogICAgICAgICAgICBBc3NlbWJsZWRFeHRlbnNpb24oZXh0PXVpX2V4dCwgYXNzbT1leHRfYXNtX2luZm8pDQogICAgICAgICkNCg0KICAgICMgYWRkIG5hbWVzIG9mIHRoZSBjcmVhdGVkIGFzc2VtYmxpZXMgdG8gdGhlIHNlc3Npb24gaW5mbw0KICAgIHNlc3Npb25pbmZvLnNldF9sb2FkZWRfcHlyZXZpdF9hc3NlbWJsaWVzKA0KICAgICAgICBbeC5hc3NtLm5hbWUgZm9yIHggaW4gYXNzZW1ibGVkX2V4dHNdDQogICAgKQ0KDQogICAgIyBydW4gc3RhcnR1cCBzY3JpcHRzIGZvciB0aGlzIHVpIGV4dGVuc2lvbiwgaWYgYW55DQogICAgZm9yIGFzc21fZXh0IGluIGFzc2VtYmxlZF9leHRzOg0KICAgICAgICBpZiBhc3NtX2V4dC5leHQuc3RhcnR1cF9zY3JpcHQ6DQogICAgICAgICAgICAjIGJ1aWxkIHN5c3BhdGhzIGZvciB0aGUgc3RhcnR1cCBzY3JpcHQNCiAgICAgICAgICAgIHN5c19wYXRocyA9IFthc3NtX2V4dC5leHQuZGlyZWN0b3J5XQ0KICAgICAgICAgICAgaWYgYXNzbV9leHQuZXh0LmxpYnJhcnlfcGF0aDoNCiAgICAgICAgICAgICAgICBzeXNfcGF0aHMuaW5zZXJ0KDAsIGFzc21fZXh0LmV4dC5saWJyYXJ5X3BhdGgpDQoNCiAgICAgICAgICAgIG1sb2dnZXIuaW5mbygnUnVubmluZyBzdGFydHVwIHRhc2tzIGZvciAlcycsIGFzc21fZXh0LmV4dC5uYW1lKQ0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRXhlY3V0aW5nIHN0YXJ0dXAgc2NyaXB0IGZvciBleHRlbnNpb246ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzbV9leHQuZXh0Lm5hbWUpDQoNCiAgICAgICAgICAgICMgbm93IHJ1bg0KICAgICAgICAgICAgZXhlY3V0ZV9leHRlbnNpb25fc3RhcnR1cF9zY3JpcHQoDQogICAgICAgICAgICAgICAgYXNzbV9leHQuZXh0LnN0YXJ0dXBfc2NyaXB0LA0KICAgICAgICAgICAgICAgIGFzc21fZXh0LmV4dC5uYW1lLA0KICAgICAgICAgICAgICAgIHN5c19wYXRocz1zeXNfcGF0aHMNCiAgICAgICAgICAgICAgICApDQoNCiAgICAjIHJlZ2lzdGVyIGV4dGVuc2lvbiBob29rcw0KICAgIGZvciBhc3NtX2V4dCBpbiBhc3NlbWJsZWRfZXh0czoNCiAgICAgICAgaG9va3MucmVnaXN0ZXJfaG9va3MoYXNzbV9leHQuZXh0KQ0KDQogICAgIyB1cGRhdGUvY3JlYXRlIHVpIChuZWVkcyB0aGUgYXNzZW1ibHkgdG8gbGluayBidXR0b24gYWN0aW9ucw0KICAgICMgdG8gY29tbWFuZHMgc2F2ZWQgaW4gdGhlIGRsbCkNCiAgICBmb3IgYXNzbV9leHQgaW4gYXNzZW1ibGVkX2V4dHM6DQogICAgICAgIHVpbWFrZXIudXBkYXRlX3B5cmV2aXRfdWkoDQogICAgICAgICAgICBhc3NtX2V4dC5leHQsDQogICAgICAgICAgICBhc3NtX2V4dC5hc3NtLA0KICAgICAgICAgICAgdXNlcl9jb25maWcubG9hZF9iZXRhDQogICAgICAgICkNCiAgICAgICAgbWxvZ2dlci5pbmZvKCdVSSBjcmVhdGVkIGZvciBleHRlbnNpb246ICVzJywgYXNzbV9leHQuZXh0Lm5hbWUpDQoNCiAgICAjIHJlLXNvcnQgdGhlIHVpIGVsZW1lbnRzDQogICAgZm9yIGFzc21fZXh0IGluIGFzc2VtYmxlZF9leHRzOg0KICAgICAgICB1aW1ha2VyLnNvcnRfcHlyZXZpdF91aShhc3NtX2V4dC5leHQpDQoNCiAgICAjIGNsZWFudXAgZXhpc3RpbmcgVUkuIFRoaXMgaXMgcHJpbWFyaWx5IGZvciBjbGVhbnVwcyBhZnRlciByZWxvYWRpbmcNCiAgICB1aW1ha2VyLmNsZWFudXBfcHlyZXZpdF91aSgpDQoNCiAgICAjIHJlZmxvdyB0aGUgdWkgaWYgcmVxdWVzdGVkLCBkZXBlbmRpbmcgb24gdGhlIGxhbmd1YWdlIGRpcmVjdGlvbg0KICAgIGlmIHVzZXJfY29uZmlnLnJlc3BlY3RfbGFuZ3VhZ2VfZGlyZWN0aW9uOg0KICAgICAgICBjdXJyZW50X2FwcGxvY2FsZSA9IGFwcGxvY2FsZXMuZ2V0X2N1cnJlbnRfYXBwbG9jYWxlKCkNCiAgICAgICAgdWltYWtlci5yZWZsb3dfcHlyZXZpdF91aShkaXJlY3Rpb249Y3VycmVudF9hcHBsb2NhbGUubGFuZ19kaXIpDQogICAgZWxzZToNCiAgICAgICAgdWltYWtlci5yZWZsb3dfcHlyZXZpdF91aSgpDQoNCg0KZGVmIGxvYWRfc2Vzc2lvbigpOg0KICAgICIiIkhhbmRsZXMgbG9hZGluZy9yZWxvYWRpbmcgb2YgdGhlIHB5UmV2aXQgYWRkaW4gYW5kIGV4dGVuc2lvbnMuDQoNCiAgICBUbyBjcmVhdGUgYSBwcm9wZXIgdWksIHB5UmV2aXQgZXh0ZW5zaW9ucyBuZWVkcyB0byBiZSBwcm9wZXJseSBwYXJzZWQgYW5kDQogICAgYSBkbGwgYXNzZW1ibHkgbmVlZHMgdG8gYmUgY3JlYXRlZC4gVGhpcyBmdW5jdGlvbiBoYW5kbGVzIHRoZXNlIHRhc2tzDQogICAgdGhyb3VnaCBpbnRlcmFjdGlvbnMgd2l0aCAuZXh0ZW5zaW9ucywgLmxvYWRlci5hc21tYWtlciwgYW5kIC5sb2FkZXIudWltYWtlci4NCg0KICAgIEV4YW1wbGVzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZnJvbSBweXJldml0LmxvYWRlci5zZXNzaW9ubWdyIGltcG9ydCBsb2FkX3Nlc3Npb24NCiAgICAgICAgbG9hZF9zZXNzaW9uKCkgICAgICMgc3RhcnQgbG9hZGluZyBhIG5ldyBweVJldml0IHNlc3Npb24NCiAgICAgICAgYGBgDQoNCiAgICBSZXR1cm5zOg0KICAgICAgICAoc3RyKTogc2VzaW9uIHV1aWQNCiAgICAiIiINCiAgICAjIHNldHVwIHJ1bnRpbWUgZW52aXJvbm1lbnQgdmFyaWFibGVzDQogICAgc2Vzc2lvbmluZm8uc2V0dXBfcnVudGltZV92YXJzKCkNCg0KICAgICMgdGhlIGxvYWRlciBkbGwgYWRkb24sIGRvZXMgbm90IGNyZWF0ZSBhbiBvdXRwdXQgd2luZG93DQogICAgIyBpZiBhbiBvdXRwdXQgd2luZG93IGlzIG5vdCBwcm92aWRlZCwgY3JlYXRlIG9uZQ0KICAgIGlmIEVYRUNfUEFSQU1TLmZpcnN0X2xvYWQ6DQogICAgICAgIG91dHB1dF93aW5kb3cgPSBfc2V0dXBfb3V0cHV0KCkNCiAgICBlbHNlOg0KICAgICAgICBmcm9tIHB5cmV2aXQgaW1wb3J0IHNjcmlwdA0KICAgICAgICBvdXRwdXRfd2luZG93ID0gc2NyaXB0LmdldF9vdXRwdXQoKQ0KDQogICAgIyBpbml0aWFsaXplIHRpbWVyIHRvIG1lYXN1cmUgbG9hZCB0aW1lDQogICAgdGltZXIgPSBUaW1lcigpDQoNCiAgICAjIHBlcmZvcm0gcHJlLWxvYWQgdGFza3MNCiAgICBfcGVyZm9ybV9vbnNlc3Npb25sb2Fkc3RhcnRfb3BzKCkNCg0KICAgICMgY3JlYXRlIGEgbmV3IHNlc3Npb24NCiAgICBfbmV3X3Nlc3Npb24oKQ0KDQogICAgIyBwZXJmb3JtIHBvc3QtbG9hZCB0YXNrcw0KICAgIF9wZXJmb3JtX29uc2Vzc2lvbmxvYWRjb21wbGV0ZV9vcHMoKQ0KDQogICAgIyBsb2cgbG9hZCB0aW1lIGFuZCB0aHVtYnMtdXAgOikNCiAgICBlbmR0aW1lID0gdGltZXIuZ2V0X3RpbWUoKQ0KICAgIHN1Y2Nlc3NfZW1vamkgPSAnOk9LX2hhbmQ6JyBpZiBlbmR0aW1lIDwgMy4wMCBlbHNlICc6dGh1bWJzX3VwOicNCiAgICBtbG9nZ2VyLmluZm8oJ0xvYWQgdGltZTogJXMgc2Vjb25kcyAlcycsIGVuZHRpbWUsIHN1Y2Nlc3NfZW1vamkpDQoNCiAgICAjIGlmIGV2ZXJ5dGhpbmcgd2VudCB3ZWxsLCBzZWxmIGRlc3RydWN0DQogICAgdHJ5Og0KICAgICAgICB0aW1lb3V0ID0gdXNlcl9jb25maWcuc3RhcnR1cGxvZ190aW1lb3V0DQogICAgICAgIGlmIHRpbWVvdXQgPiAwIGFuZCBub3QgbG9nZ2VyLmxvZ2dlcnNfaGF2ZV9lcnJvcnMoKToNCiAgICAgICAgICAgIGlmIEVYRUNfUEFSQU1TLmZpcnN0X2xvYWQ6DQogICAgICAgICAgICAgICAgIyBvdXRwdXRfd2luZG93IGlzIG9mIHR5cGUgU2NyaXB0Q29uc29sZQ0KICAgICAgICAgICAgICAgIG91dHB1dF93aW5kb3cuU2VsZkRlc3RydWN0VGltZXIodGltZW91dCkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgIyBvdXRwdXRfd2luZG93IGlzIG9mIHR5cGUgUHlSZXZpdE91dHB1dFdpbmRvdw0KICAgICAgICAgICAgICAgIG91dHB1dF93aW5kb3cuc2VsZl9kZXN0cnVjdCh0aW1lb3V0KQ0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgaW1wX2VycjoNCiAgICAgICAgbWxvZ2dlci5lcnJvcignRXJyb3Igc2V0dGluZyB1cCBzZWxmX2Rlc3RydWN0IG9uIG91dHB1dCB3aW5kb3cgfCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgaW1wX2VycikNCg0KICAgIF9jbGVhbnVwX291dHB1dCgpDQogICAgcmV0dXJuIHNlc3Npb25pbmZvLmdldF9zZXNzaW9uX3V1aWQoKQ0KDQoNCmRlZiBfcGVyZm9ybV9vbnNlc3Npb25yZWxvYWRfb3BzKCk6DQogICAgcGFzcw0KDQoNCmRlZiBfcGVyZm9ybV9vbnNlc3Npb25yZWxvYWRjb21wbGV0ZV9vcHMoKToNCiAgICBwYXNzDQoNCg0KZGVmIHJlbG9hZF9weXJldml0KCk6DQogICAgX3BlcmZvcm1fb25zZXNzaW9ucmVsb2FkX29wcygpDQogICAgbWxvZ2dlci5pbmZvKCdSZWxvYWRpbmcuLi4uJykNCiAgICBzZXNzaW9uX0lkID0gbG9hZF9zZXNzaW9uKCkNCiAgICBfcGVyZm9ybV9vbnNlc3Npb25yZWxvYWRjb21wbGV0ZV9vcHMoKQ0KICAgIHJldHVybiBzZXNzaW9uX0lkDQoNCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiMgRnVuY3Rpb25zIHJlbGF0ZWQgdG8gZmluZGluZy9leGVjdXRpbmcNCiMgcHlyZXZpdCBjb21tYW5kIG9yIHNjcmlwdCBpbiBjdXJyZW50IHNlc3Npb24NCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCmNsYXNzIFB5UmV2aXRFeHRlcm5hbENvbW1hbmRUeXBlKG9iamVjdCk6DQogICAgIiIiUHlSZXZpdCBleHRlcm5hbCBjb21tYW5kIHR5cGUuIiIiDQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGV4dGNtZF90eXBlLCBleHRjbWRfYXZhaWx0eXBlKToNCiAgICAgICAgc2VsZi5fZXh0Y21kX3R5cGUgPSBleHRjbWRfdHlwZQ0KICAgICAgICBzZWxmLl9leHRjbWQgPSBleHRjbWRfdHlwZSgpDQogICAgICAgIGlmIGV4dGNtZF9hdmFpbHR5cGU6DQogICAgICAgICAgICBzZWxmLl9leHRjbWRfYXZhaWx0eXBlID0gZXh0Y21kX2F2YWlsdHlwZQ0KICAgICAgICAgICAgc2VsZi5fZXh0Y21kX2F2YWlsID0gZXh0Y21kX2F2YWlsdHlwZSgpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBzZWxmLl9leHRjbWRfYXZhaWx0eXBlID0gTm9uZQ0KICAgICAgICAgICAgc2VsZi5fZXh0Y21kX2F2YWlsID0gTm9uZQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGV4dGNtZF90eXBlKHNlbGYpOg0KICAgICAgICByZXR1cm4gc2VsZi5fZXh0Y21kX3R5cGUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB0eXBlbmFtZShzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuX2V4dGNtZF90eXBlLkZ1bGxOYW1lDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgZXh0Y21kX2F2YWlsdHlwZShzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuX2V4dGNtZF9hdmFpbHR5cGUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBhdmFpbF90eXBlbmFtZShzZWxmKToNCiAgICAgICAgcmV0dXJuIHNlbGYuX2V4dGNtZF9hdmFpbHR5cGUuRnVsbE5hbWUNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBzY3JpcHQoc2VsZik6DQogICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYuX2V4dGNtZC5TY3JpcHREYXRhLCAnU2NyaXB0UGF0aCcsIE5vbmUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgY29uZmlnX3NjcmlwdChzZWxmKToNCiAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZi5fZXh0Y21kLlNjcmlwdERhdGEsICdDb25maWdTY3JpcHRQYXRoJywgTm9uZSkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBzZWFyY2hfcGF0aHMoc2VsZik6DQogICAgICAgIHZhbHVlID0gZ2V0YXR0cihzZWxmLl9leHRjbWQuU2NyaXB0UnVudGltZUNvbmZpZ3MsICdTZWFyY2hQYXRocycsIFtdKQ0KICAgICAgICByZXR1cm4gbGlzdCh2YWx1ZSkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBhcmd1bWVudHMoc2VsZik6DQogICAgICAgIHZhbHVlID0gZ2V0YXR0cihzZWxmLl9leHRjbWQuU2NyaXB0UnVudGltZUNvbmZpZ3MsICdBcmd1bWVudHMnLCBbXSkNCiAgICAgICAgcmV0dXJuIGxpc3QodmFsdWUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgZW5naW5lX2NmZ3Moc2VsZik6DQogICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYuX2V4dGNtZC5TY3JpcHRSdW50aW1lQ29uZmlncywgJ0VuZ2luZUNvbmZpZ3MnLCAnJykNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiBoZWxwc291cmNlKHNlbGYpOg0KICAgICAgICByZXR1cm4gZ2V0YXR0cihzZWxmLl9leHRjbWQuU2NyaXB0RGF0YSwgJ0hlbHBTb3VyY2UnLCBOb25lKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIHRvb2x0aXAoc2VsZik6DQogICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYuX2V4dGNtZC5TY3JpcHREYXRhLCAnVG9vbHRpcCcsIE5vbmUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgbmFtZShzZWxmKToNCiAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZi5fZXh0Y21kLlNjcmlwdERhdGEsICdDb21tYW5kTmFtZScsIE5vbmUpDQoNCiAgICBAcHJvcGVydHkNCiAgICBkZWYgYnVuZGxlKHNlbGYpOg0KICAgICAgICByZXR1cm4gZ2V0YXR0cihzZWxmLl9leHRjbWQuU2NyaXB0RGF0YSwgJ0NvbW1hbmRCdW5kbGUnLCBOb25lKQ0KDQogICAgQHByb3BlcnR5DQogICAgZGVmIGV4dGVuc2lvbihzZWxmKToNCiAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZi5fZXh0Y21kLlNjcmlwdERhdGEsICdDb21tYW5kRXh0ZW5zaW9uJywgTm9uZSkNCg0KICAgIEBwcm9wZXJ0eQ0KICAgIGRlZiB1bmlxdWVfaWQoc2VsZik6DQogICAgICAgIHJldHVybiBnZXRhdHRyKHNlbGYuX2V4dGNtZC5TY3JpcHREYXRhLCAnQ29tbWFuZFVuaXF1ZUlkJywgTm9uZSkNCg0KICAgIGRlZiBpc19hdmFpbGFibGUoc2VsZiwgY2F0ZWdvcnlfc2V0LCB6ZXJvZG9jPUZhbHNlKToNCiAgICAgICAgaWYgc2VsZi5fZXh0Y21kX2F2YWlsdHlwZToNCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9leHRjbWRfYXZhaWwuSXNDb21tYW5kQXZhaWxhYmxlKEhPU1RfQVBQLnVpYXBwLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlfc2V0KQ0KICAgICAgICBlbGlmIG5vdCB6ZXJvZG9jOg0KICAgICAgICAgICAgcmV0dXJuIFRydWUNCg0KICAgICAgICByZXR1cm4gRmFsc2UNCg0KDQpweXJldml0X2V4dGNtZHR5cGVfY2FjaGUgPSBbXQ0KDQoNCmRlZiBmaW5kX2FsbF9jb21tYW5kcyhjYXRlZ29yeV9zZXQ9Tm9uZSwgY2FjaGU9VHJ1ZSk6DQogICAgZ2xvYmFsIHB5cmV2aXRfZXh0Y21kdHlwZV9jYWNoZSAgICAjcHlsaW50OiBkaXNhYmxlPVcwNjAzDQogICAgaWYgY2FjaGUgYW5kIHB5cmV2aXRfZXh0Y21kdHlwZV9jYWNoZTogICAgI3B5bGludDogZGlzYWJsZT1FMDYwMQ0KICAgICAgICBweXJldml0X2V4dGNtZHMgPSBweXJldml0X2V4dGNtZHR5cGVfY2FjaGUNCiAgICBlbHNlOg0KICAgICAgICBweXJldml0X2V4dGNtZHMgPSBbXQ0KICAgICAgICBmb3IgbG9hZGVkX2Fzc21fbmFtZSBpbiBzZXNzaW9uaW5mby5nZXRfbG9hZGVkX3B5cmV2aXRfYXNzZW1ibGllcygpOg0KICAgICAgICAgICAgbG9hZGVkX2Fzc20gPSBhc3NtdXRpbHMuZmluZF9sb2FkZWRfYXNtKGxvYWRlZF9hc3NtX25hbWUpDQogICAgICAgICAgICBpZiBsb2FkZWRfYXNzbToNCiAgICAgICAgICAgICAgICBhbGxfZXhwb3J0ZWRfdHlwZXMgPSBsb2FkZWRfYXNzbVswXS5HZXRUeXBlcygpDQoNCiAgICAgICAgICAgICAgICBmb3IgcHlydnRfdHlwZSBpbiBhbGxfZXhwb3J0ZWRfdHlwZXM6DQogICAgICAgICAgICAgICAgICAgIHRuYW1lID0gcHlydnRfdHlwZS5GdWxsTmFtZQ0KICAgICAgICAgICAgICAgICAgICBhdmFpbHRuYW1lID0gcHlydnRfdHlwZS5OYW1lIFwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgcnVudGltZS5DTURfQVZBSUxfTkFNRV9QT1NURklYDQogICAgICAgICAgICAgICAgICAgIHB5cnZ0X2F2YWlsdHlwZSA9IE5vbmUNCg0KICAgICAgICAgICAgICAgICAgICBpZiBub3QgdG5hbWUuZW5kc3dpdGgocnVudGltZS5DTURfQVZBSUxfTkFNRV9QT1NURklYKVwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmQgcnVudGltZS5SVU5USU1FX05BTUVTUEFDRSBub3QgaW4gdG5hbWU6DQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgZXhwb3J0ZWRfdHlwZSBpbiBhbGxfZXhwb3J0ZWRfdHlwZXM6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZXhwb3J0ZWRfdHlwZS5OYW1lID09IGF2YWlsdG5hbWU6DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB5cnZ0X2F2YWlsdHlwZSA9IGV4cG9ydGVkX3R5cGUNCg0KICAgICAgICAgICAgICAgICAgICAgICAgcHlyZXZpdF9leHRjbWRzLmFwcGVuZCgNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQeVJldml0RXh0ZXJuYWxDb21tYW5kVHlwZShweXJ2dF90eXBlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB5cnZ0X2F2YWlsdHlwZSkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApDQogICAgICAgIGlmIGNhY2hlOg0KICAgICAgICAgICAgcHlyZXZpdF9leHRjbWR0eXBlX2NhY2hlID0gcHlyZXZpdF9leHRjbWRzDQoNCiAgICAjIG5vdyBjaGVjayBjb21tYW5kcyBpbiBjdXJyZW50IGNvbnRleHQgaWYgcmVxdWVzdGVkDQogICAgaWYgY2F0ZWdvcnlfc2V0Og0KICAgICAgICByZXR1cm4gW3ggZm9yIHggaW4gcHlyZXZpdF9leHRjbWRzDQogICAgICAgICAgICAgICAgaWYgeC5pc19hdmFpbGFibGUoY2F0ZWdvcnlfc2V0PWNhdGVnb3J5X3NldCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB6ZXJvZG9jPUhPU1RfQVBQLnVpZG9jIGlzIE5vbmUpXQ0KICAgIGVsc2U6DQogICAgICAgIHJldHVybiBweXJldml0X2V4dGNtZHMNCg0KDQpkZWYgZmluZF9hbGxfYXZhaWxhYmxlX2NvbW1hbmRzKHVzZV9jdXJyZW50X2NvbnRleHQ9VHJ1ZSwgY2FjaGU9VHJ1ZSk6DQogICAgaWYgdXNlX2N1cnJlbnRfY29udGV4dDoNCiAgICAgICAgY3NldCA9IHJldml0LmdldF9zZWxlY3Rpb25fY2F0ZWdvcnlfc2V0KCkNCiAgICBlbHNlOg0KICAgICAgICBjc2V0ID0gTm9uZQ0KDQogICAgcmV0dXJuIGZpbmRfYWxsX2NvbW1hbmRzKGNhdGVnb3J5X3NldD1jc2V0LCBjYWNoZT1jYWNoZSkNCg0KDQpkZWYgZmluZF9weXJldml0Y21kKHB5cmV2aXRjbWRfdW5pcXVlX2lkKToNCiAgICAiIiJGaW5kIGEgcHlSZXZpdCBjb21tYW5kLg0KDQogICAgU2VhcmNoZXMgdGhlIHB5UmV2aXQtZ2VuZXJhdGVkIGFzc2VtYmxpZXMgdW5kZXIgY3VycmVudCBzZXNzaW9uIGZvcg0KICAgIHRoZSBjb21tYW5kIHdpdGggdGhlIG1hdGNoaW5nIHVuaXF1ZSBuYW1lIChjbGFzcyBuYW1lKSBhbmQgcmV0dXJucyB0aGUNCiAgICBjb21tYW5kIHR5cGUuIE5vdGljZSB0aGF0IHRoaXMgcmV0dXJuZWQgdmFsdWUgaXMgYSAndHlwZScgYW5kIHNob3VsZCBiZQ0KICAgIGluc3RhbnRpYXRlZCBiZWZvcmUgdXNlLg0KDQogICAgRXhhbXBsZXM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBjbWQgPSBmaW5kX3B5cmV2aXRjbWQoJ3B5UmV2aXRDb3JlcHlSZXZpdHB5UmV2aXR0b29sc1JlbG9hZCcpDQogICAgICAgIGNvbW1hbmRfaW5zdGFuY2UgPSBjbWQoKQ0KICAgICAgICBjb21tYW5kX2luc3RhbmNlLkV4ZWN1dGUoKSAjIFByb3ZpZGUgY29tbWFuZERhdGEsIG1lc3NhZ2UsIGVsZW1lbnRzDQogICAgICAgIGBgYA0KDQogICAgQXJnczoNCiAgICAgICAgcHlyZXZpdGNtZF91bmlxdWVfaWQgKHN0cik6IFVuaXF1ZSBuYW1lIGZvciB0aGUgY29tbWFuZA0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHR5cGUpOlR5cGUgZm9yIHRoZSBjb21tYW5kIHdpdGggbWF0Y2hpbmcgdW5pcXVlIG5hbWUNCiAgICAiIiINCiAgICAjIGdvIHRocm91Z2ggYXNzbWVibGVzIGxvYWRlZCB1bmRlciBjdXJyZW50IHB5UmV2aXQgc2Vzc2lvbg0KICAgICMgYW5kIHRyeSB0byBmaW5kIHRoZSBjb21tYW5kDQogICAgbWxvZ2dlci5kZWJ1ZygnU2VhcmNoaW5nIGZvciBweXJldml0IGNvbW1hbmQ6ICVzJywgcHlyZXZpdGNtZF91bmlxdWVfaWQpDQogICAgZm9yIGxvYWRlZF9hc3NtX25hbWUgaW4gc2Vzc2lvbmluZm8uZ2V0X2xvYWRlZF9weXJldml0X2Fzc2VtYmxpZXMoKToNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRXhwZWN0aW5nIGFzc206ICVzJywgbG9hZGVkX2Fzc21fbmFtZSkNCiAgICAgICAgbG9hZGVkX2Fzc20gPSBhc3NtdXRpbHMuZmluZF9sb2FkZWRfYXNtKGxvYWRlZF9hc3NtX25hbWUpDQogICAgICAgIGlmIGxvYWRlZF9hc3NtOg0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRm91bmQgYXNzbTogJXMnLCBsb2FkZWRfYXNzbV9uYW1lKQ0KICAgICAgICAgICAgZm9yIHB5cnZ0X3R5cGUgaW4gbG9hZGVkX2Fzc21bMF0uR2V0VHlwZXMoKToNCiAgICAgICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdGb3VuZCBUeXBlOiAlcycsIHB5cnZ0X3R5cGUpDQogICAgICAgICAgICAgICAgaWYgcHlydnRfdHlwZS5GdWxsTmFtZSA9PSBweXJldml0Y21kX3VuaXF1ZV9pZDoNCiAgICAgICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRm91bmQgcHlSZXZpdCBjb21tYW5kIGluICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkZWRfYXNzbV9uYW1lKQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHlydnRfdHlwZQ0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnQ291bGQgbm90IGZpbmQgcHlSZXZpdCBjb21tYW5kLicpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBtbG9nZ2VyLmRlYnVnKCdDYW4gbm90IGZpbmQgYXNzbTogJXMnLCBsb2FkZWRfYXNzbV9uYW1lKQ0KDQogICAgcmV0dXJuIE5vbmUNCg0KDQpkZWYgY3JlYXRlX3RtcF9jb21tYW5kZGF0YSgpOg0KICAgIHRtcF9jbWRfZGF0YSA9IFwNCiAgICAgICAgZnJhbWV3b3JrLkZvcm1hdHRlclNlcnZpY2VzLkdldFVuaW5pdGlhbGl6ZWRPYmplY3QoDQogICAgICAgICAgICBVSS5FeHRlcm5hbENvbW1hbmREYXRhDQogICAgICAgICAgICApDQogICAgdG1wX2NtZF9kYXRhLkFwcGxpY2F0aW9uID0gSE9TVF9BUFAudWlhcHANCiAgICAjIHRtcF9jbWRfZGF0YS5Jc1JlYWRPbmx5ID0gRmFsc2UNCiAgICAjIHRtcF9jbWRfZGF0YS5WaWV3ID0gTm9uZQ0KICAgICMgdG1wX2NtZF9kYXRhLkpvdXJuYWxEYXRhID0gTm9uZQ0KICAgIHJldHVybiB0bXBfY21kX2RhdGENCg0KDQpkZWYgZXhlY3V0ZV9jb21tYW5kX2NscyhleHRjbWRfdHlwZSwgYXJndW1lbnRzPU5vbmUsDQogICAgICAgICAgICAgICAgICAgICAgICBjb25maWdfbW9kZT1GYWxzZSwgZXhlY19mcm9tX3VpPUZhbHNlKToNCg0KICAgIGNvbW1hbmRfaW5zdGFuY2UgPSBleHRjbWRfdHlwZSgpDQogICAgIyBwYXNzIHRoZSBhcmd1bWVudHMgdG8gdGhlIGluc3RhbmNlDQogICAgaWYgYXJndW1lbnRzOg0KICAgICAgICBjb21tYW5kX2luc3RhbmNlLlNjcmlwdFJ1bnRpbWVDb25maWdzLkFyZ3VtZW50cyA9IFwNCiAgICAgICAgICAgIGZyYW1ld29yay5MaXN0W3N0cl0oYXJndW1lbnRzKQ0KICAgICMgdGhpcyBpcyBhIG1hbnVhbCBleGVjdXRpb24gZnJvbSBweXRob24gY29kZSBhbmQgbm90IGJ5IHVzZXINCiAgICBjb21tYW5kX2luc3RhbmNlLkV4ZWNDb25maWdzLk1pbWljRXhlY0Zyb21VSSA9IGV4ZWNfZnJvbV91aQ0KICAgICMgZm9yY2UgdXNpbmcgdGhlIGNvbmZpZyBzY3JpcHQNCiAgICBjb21tYW5kX2luc3RhbmNlLkV4ZWNDb25maWdzLlVzZUNvbmZpZ1NjcmlwdCA9IGNvbmZpZ19tb2RlDQoNCiAgICAjIEV4ZWN1dGUoDQogICAgIyBFeHRlcm5hbENvbW1hbmREYXRhIGNvbW1hbmREYXRhLA0KICAgICMgc3RyaW5nIG1lc3NhZ2UsDQogICAgIyBFbGVtZW50U2V0IGVsZW1lbnRzDQogICAgIyApDQogICAgcmUgPSBjb21tYW5kX2luc3RhbmNlLkV4ZWN1dGUoY3JlYXRlX3RtcF9jb21tYW5kZGF0YSgpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcnLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERCLkVsZW1lbnRTZXQoKSkNCiAgICBjb21tYW5kX2luc3RhbmNlID0gTm9uZQ0KICAgIHJldHVybiByZQ0KDQoNCmRlZiBleGVjdXRlX2NvbW1hbmQocHlyZXZpdGNtZF91bmlxdWVfaWQpOg0KICAgICIiIkV4ZWN1dGVzIGEgcHlSZXZpdCBjb21tYW5kLg0KDQogICAgQXJnczoNCiAgICAgICAgcHlyZXZpdGNtZF91bmlxdWVfaWQgKHN0cik6IFVuaXF1ZS9DbGFzcyBOYW1lIG9mIHRoZSBweVJldml0IGNvbW1hbmQNCiAgICAiIiINCiAgICBjbWRfY2xhc3MgPSBmaW5kX3B5cmV2aXRjbWQocHlyZXZpdGNtZF91bmlxdWVfaWQpDQoNCiAgICBpZiBub3QgY21kX2NsYXNzOg0KICAgICAgICBtbG9nZ2VyLmVycm9yKCdDYW4gbm90IGZpbmQgY29tbWFuZCB3aXRoIHVuaXF1ZSBuYW1lOiAlcycsDQogICAgICAgICAgICAgICAgICAgICAgcHlyZXZpdGNtZF91bmlxdWVfaWQpDQogICAgICAgIHJldHVybiBOb25lDQogICAgZWxzZToNCiAgICAgICAgZXhlY3V0ZV9jb21tYW5kX2NscyhjbWRfY2xhc3MpDQoNCg0KZGVmIGV4ZWN1dGVfZXh0ZW5zaW9uX3N0YXJ0dXBfc2NyaXB0KHNjcmlwdF9wYXRoLCBleHRfbmFtZSwgc3lzX3BhdGhzPU5vbmUpOg0KICAgICIiIkV4ZWN1dGVzIGEgc2NyaXB0IHVzaW5nIHB5UmV2aXQgc2NyaXB0IGV4ZWN1dG9yLg0KDQogICAgQXJnczoNCiAgICAgICAgc2NyaXB0X3BhdGggKHN0cik6IEFkZHJlc3Mgb2YgdGhlIHNjcmlwdCBmaWxlDQogICAgICAgIGV4dF9uYW1lIChzdHIpOiBOYW1lIG9mIHRoZSBleHRlbnNpb24NCiAgICAgICAgc3lzX3BhdGhzIChsaXN0KTogYWRkaXRpb25hbCBzZWFyY2ggcGF0aHMNCiAgICAiIiINCiAgICBjb3JlX3N5c3BhdGhzID0gW01BSU5fTElCX0RJUiwgTUlTQ19MSUJfRElSXQ0KICAgIGlmIHN5c19wYXRoczoNCiAgICAgICAgc3lzX3BhdGhzLmV4dGVuZChjb3JlX3N5c3BhdGhzKQ0KICAgIGVsc2U6DQogICAgICAgIHN5c19wYXRocyA9IGNvcmVfc3lzcGF0aHMNCg0KICAgIHNjcmlwdF9kYXRhID0gcnVudGltZS50eXBlcy5TY3JpcHREYXRhKCkNCiAgICBzY3JpcHRfZGF0YS5TY3JpcHRQYXRoID0gc2NyaXB0X3BhdGgNCiAgICBzY3JpcHRfZGF0YS5Db25maWdTY3JpcHRQYXRoID0gTm9uZQ0KICAgIHNjcmlwdF9kYXRhLkNvbW1hbmRVbmlxdWVJZCA9ICcnDQogICAgc2NyaXB0X2RhdGEuQ29tbWFuZE5hbWUgPSAnU3RhcnRpbmcge30nLmZvcm1hdChleHRfbmFtZSkNCiAgICBzY3JpcHRfZGF0YS5Db21tYW5kQnVuZGxlID0gJycNCiAgICBzY3JpcHRfZGF0YS5Db21tYW5kRXh0ZW5zaW9uID0gZXh0X25hbWUNCiAgICBzY3JpcHRfZGF0YS5IZWxwU291cmNlID0gJycNCg0KICAgIHNjcmlwdF9ydW50aW1lX2NmZyA9IHJ1bnRpbWUudHlwZXMuU2NyaXB0UnVudGltZUNvbmZpZ3MoKQ0KICAgIHNjcmlwdF9ydW50aW1lX2NmZy5Db21tYW5kRGF0YSA9IGNyZWF0ZV90bXBfY29tbWFuZGRhdGEoKQ0KICAgIHNjcmlwdF9ydW50aW1lX2NmZy5TZWxlY3RlZEVsZW1lbnRzID0gTm9uZQ0KICAgIHNjcmlwdF9ydW50aW1lX2NmZy5TZWFyY2hQYXRocyA9IGZyYW1ld29yay5MaXN0W3N0cl0oc3lzX3BhdGhzIG9yIFtdKQ0KICAgIHNjcmlwdF9ydW50aW1lX2NmZy5Bcmd1bWVudHMgPSBmcmFtZXdvcmsuTGlzdFtzdHJdKFtdKQ0KICAgIHNjcmlwdF9ydW50aW1lX2NmZy5FbmdpbmVDb25maWdzID0gXA0KICAgICAgICBydW50aW1lLmNyZWF0ZV9pcHllbmdpbmVfY29uZmlncygNCiAgICAgICAgICAgIGNsZWFuPVRydWUsDQogICAgICAgICAgICBmdWxsX2ZyYW1lPVRydWUsDQogICAgICAgICAgICBwZXJzaXN0ZW50PVRydWUsDQogICAgICAgICkNCiAgICBzY3JpcHRfcnVudGltZV9jZmcuUmVmcmVzaEVuZ2luZSA9IEZhbHNlDQogICAgc2NyaXB0X3J1bnRpbWVfY2ZnLkNvbmZpZ01vZGUgPSBGYWxzZQ0KICAgIHNjcmlwdF9ydW50aW1lX2NmZy5EZWJ1Z01vZGUgPSBGYWxzZQ0KICAgIHNjcmlwdF9ydW50aW1lX2NmZy5FeGVjdXRlZEZyb21VSSA9IEZhbHNlDQoNCiAgICBydW50aW1lLnR5cGVzLlNjcmlwdEV4ZWN1dG9yLkV4ZWN1dGVTY3JpcHQoDQogICAgICAgIHNjcmlwdF9kYXRhLA0KICAgICAgICBzY3JpcHRfcnVudGltZV9jZmcNCiAgICApDQoNCiIiIlNlc3Npb24gZGlhZ25vc3RpY3MuIiIiDQpmcm9tIHB5cmV2aXQgaW1wb3J0IEhPU1RfQVBQDQoNCmZyb20gcHlyZXZpdC51c2VyY29uZmlnIGltcG9ydCB1c2VyX2NvbmZpZw0KZnJvbSBweXJldml0LmZyYW1ld29yayBpbXBvcnQgRHJpdmVJbmZvLCBQYXRoDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzLmxvZ2dlciBpbXBvcnQgZ2V0X2xvZ2dlcg0KDQoNCiNweWxpbnQ6IGRpc2FibGU9VzA3MDMsQzAzMDIsQzAxMDMNCm1sb2dnZXIgPSBnZXRfbG9nZ2VyKF9fbmFtZV9fKQ0KDQoNCmRlZiBjaGVja19taW5faG9zdF92ZXJzaW9uKCk6DQogICAgIyBnZXQgcmVxdWlyZWQgdmVyc2lvbiBhbmQgYnVpbGQgZnJvbSB1c2VyIGNvbmZpZw0KICAgIHJlcV9idWlsZCA9IHVzZXJfY29uZmlnLnJlcXVpcmVkX2hvc3RfYnVpbGQNCiAgICBpZiByZXFfYnVpbGQ6DQogICAgICAgIGlmIEhPU1RfQVBQLmJ1aWxkICE9IHJlcV9idWlsZDoNCiAgICAgICAgICAgIG1sb2dnZXIud2FybmluZygnWW91IGFyZSBub3QgdXNpbmcgdGhlIHJlcXVpcmVkIGhvc3QgYnVpbGQ6ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXFfYnVpbGQpDQoNCg0KZGVmIGNoZWNrX2hvc3RfZHJpdmVfZnJlZXNwYWNlKCk6DQogICAgIyBnZXQgbWluIGZyZWUgc3BhY2UgZnJvbSB1c2VyIGNvbmZpZw0KICAgIG1pbl9mcmVlc3BhY2UgPSB1c2VyX2NvbmZpZy5taW5faG9zdF9kcml2ZWZyZWVzcGFjZQ0KICAgIGlmIG1pbl9mcmVlc3BhY2U6DQogICAgICAgICMgZmluZCBob3N0IGRyaXZlIGFuZCBjaGVjayBmcmVlIHNwYWNlDQogICAgICAgIGhvc3RfZHJpdmUgPSBQYXRoLkdldFBhdGhSb290KEhPU1RfQVBQLnByb2NfcGF0aCkNCiAgICAgICAgZm9yIGRyaXZlIGluIERyaXZlSW5mby5HZXREcml2ZXMoKToNCiAgICAgICAgICAgIGlmIGRyaXZlLk5hbWUgPT0gaG9zdF9kcml2ZToNCiAgICAgICAgICAgICAgICBmcmVlX2hkX3NwYWNlID0gZmxvYXQoZHJpdmUuVG90YWxGcmVlU3BhY2UpIC8gKDEwMjQgKiogMykNCg0KICAgICAgICAgICAgICAgIGlmIGZyZWVfaGRfc3BhY2UgPCBtaW5fZnJlZXNwYWNlOg0KICAgICAgICAgICAgICAgICAgICBtbG9nZ2VyLndhcm5pbmcoJ1JlbWFpbmluZyBzcGFjZSBvbiBsb2NhbCBkcml2ZSAnDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXMgbGVzcyB0aGFuICVzR0IuLi4nLCBtaW5fZnJlZXNwYWNlKQ0KDQoNCmRlZiBzeXN0ZW1fZGlhZygpOg0KICAgICIiIlZlcmlmaWVzIHN5c3RlbSBzdGF0dXMgaXMgYXBwcm9wcmlhdGUgZm9yIGEgcHlSZXZpdCBzZXNzaW9uLiIiIg0KICAgICMgY2hlY2tpbmcgYXZhaWxhYmxlIGRyaXZlIHNwYWNlDQogICAgY2hlY2tfaG9zdF9kcml2ZV9mcmVlc3BhY2UoKQ0KDQogICAgIyBjaGVjayBpZiB1c2VyIGlzIHJ1bm5pbmcgdGhlIHJlcXVpcmVkIGhvc3QgdmVyc2lvbiBhbmQgYnVpbGQNCiAgICBjaGVja19taW5faG9zdF92ZXJzaW9uKCkNCg0KIiIiVUkgbWFrZXIuIiIiDQppbXBvcnQgc3lzDQppbXBvcnQgaW1wDQoNCmZyb20gcHlyZXZpdCBpbXBvcnQgSE9TVF9BUFAsIEVYRUNfUEFSQU1TLCBQeVJldml0RXhjZXB0aW9uDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzIGltcG9ydCBhc3NtdXRpbHMNCmZyb20gcHlyZXZpdC5jb3JldXRpbHMubG9nZ2VyIGltcG9ydCBnZXRfbG9nZ2VyDQpmcm9tIHB5cmV2aXQuY29yZXV0aWxzIGltcG9ydCBhcHBsb2NhbGVzDQoNCmlmIG5vdCBFWEVDX1BBUkFNUy5kb2NfbW9kZToNCiAgICBmcm9tIHB5cmV2aXQuY29yZXV0aWxzIGltcG9ydCByaWJib24NCg0KI3B5bGludDogZGlzYWJsZT1XMDcwMyxDMDMwMixDMDEwMyxDMDQxMw0KaW1wb3J0IHB5cmV2aXQuZXh0ZW5zaW9ucyBhcyBleHRzDQpmcm9tIHB5cmV2aXQuZXh0ZW5zaW9ucyBpbXBvcnQgY29tcG9uZW50cw0KZnJvbSBweXJldml0LnVzZXJjb25maWcgaW1wb3J0IHVzZXJfY29uZmlnDQoNCg0KbWxvZ2dlciA9IGdldF9sb2dnZXIoX19uYW1lX18pDQoNCg0KQ09ORklHX1NDUklQVF9USVRMRV9QT1NURklYID0gdSdcdTI1Q0YnDQoNCg0KY2xhc3MgVUlNYWtlclBhcmFtczoNCiAgICAiIiJVSSBtYWtlciBwYXJhbWV0ZXJzLg0KDQogICAgQXJnczoNCiAgICAgICAgcGFyX3VpIChfUHlSZXZpdFVJKTogUGFyZW50IFVJIGl0ZW0NCiAgICAgICAgcGFyX2NtcCAoR2VuZXJpY1VJQ29tcG9uZW50KTogUGFyZW50IFVJIGNvbXBvbmVudA0KICAgICAgICBjbXBfaXRlbSAoR2VuZXJpY1VJQ29tcG9uZW50KTogVUkgY29tcG9uZW50IGl0ZW0NCiAgICAgICAgYXNtX2luZm8gKEFzc2VtYmx5SW5mbyk6IEFzc2VtYmx5IGluZm8NCiAgICAgICAgY3JlYXRlX2JldGEgKGJvb2wsIG9wdGlvbmFsKTogQ3JlYXRlIGJldGEgYnV0dG9uLiBEZWZhdWx0cyB0byBGYWxzZQ0KICAgICIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBwYXJfdWksIHBhcl9jbXAsIGNtcF9pdGVtLCBhc21faW5mbywgY3JlYXRlX2JldGE9RmFsc2UpOg0KICAgICAgICBzZWxmLnBhcmVudF91aSA9IHBhcl91aQ0KICAgICAgICBzZWxmLnBhcmVudF9jbXAgPSBwYXJfY21wDQogICAgICAgIHNlbGYuY29tcG9uZW50ID0gY21wX2l0ZW0NCiAgICAgICAgc2VsZi5hc21faW5mbyA9IGFzbV9pbmZvDQogICAgICAgIHNlbGYuY3JlYXRlX2JldGFfY21kcyA9IGNyZWF0ZV9iZXRhDQoNCg0KZGVmIF9tYWtlX2J1dHRvbl90b29sdGlwKGJ1dHRvbik6DQogICAgdG9vbHRpcCA9IGJ1dHRvbi50b29sdGlwICsgJ1xuXG4nIGlmIGJ1dHRvbi50b29sdGlwIGVsc2UgJycNCiAgICB0b29sdGlwICs9ICdCdW5kbGUgTmFtZTpcbnt9ICh7fSknXA0KICAgICAgICAuZm9ybWF0KGJ1dHRvbi5uYW1lLCBidXR0b24udHlwZV9pZC5yZXBsYWNlKCcuJywgJycpKQ0KICAgIGlmIGJ1dHRvbi5hdXRob3I6DQogICAgICAgIHRvb2x0aXAgKz0gJ1xuXG5BdXRob3Iocyk6XG57fScuZm9ybWF0KGJ1dHRvbi5hdXRob3IpDQogICAgcmV0dXJuIHRvb2x0aXANCg0KDQpkZWYgX21ha2VfYnV0dG9uX3Rvb2x0aXBfZXh0KGJ1dHRvbiwgYXNtX25hbWUpOg0KDQogICAgdG9vbHRpcF9leHQgPSAnJw0KDQogICAgaWYgYnV0dG9uLm1pbl9yZXZpdF92ZXIgYW5kIG5vdCBidXR0b24ubWF4X3Jldml0X3ZlcjoNCiAgICAgICAgdG9vbHRpcF9leHQgKz0gJ0NvbXBhdGlibGUgd2l0aCB7fSB7fSBhbmQgYWJvdmVcblxuJ1wNCiAgICAgICAgICAgIC5mb3JtYXQoSE9TVF9BUFAucHJvY19uYW1lLA0KICAgICAgICAgICAgICAgICAgICBidXR0b24ubWluX3Jldml0X3ZlcikNCg0KICAgIGlmIGJ1dHRvbi5tYXhfcmV2aXRfdmVyIGFuZCBub3QgYnV0dG9uLm1pbl9yZXZpdF92ZXI6DQogICAgICAgIHRvb2x0aXBfZXh0ICs9ICdDb21wYXRpYmxlIHdpdGgge30ge30gYW5kIGVhcmxpZXJcblxuJ1wNCiAgICAgICAgICAgIC5mb3JtYXQoSE9TVF9BUFAucHJvY19uYW1lLA0KICAgICAgICAgICAgICAgICAgICBidXR0b24ubWF4X3Jldml0X3ZlcikNCg0KICAgIGlmIGJ1dHRvbi5taW5fcmV2aXRfdmVyIGFuZCBidXR0b24ubWF4X3Jldml0X3ZlcjoNCiAgICAgICAgaWYgaW50KGJ1dHRvbi5taW5fcmV2aXRfdmVyKSAhPSBpbnQoYnV0dG9uLm1heF9yZXZpdF92ZXIpOg0KICAgICAgICAgICAgdG9vbHRpcF9leHQgKz0gJ0NvbXBhdGlibGUgd2l0aCB7fSB7fSB0byB7fVxuXG4nXA0KICAgICAgICAgICAgICAgIC5mb3JtYXQoSE9TVF9BUFAucHJvY19uYW1lLA0KICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uLm1pbl9yZXZpdF92ZXIsIGJ1dHRvbi5tYXhfcmV2aXRfdmVyKQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgdG9vbHRpcF9leHQgKz0gJ0NvbXBhdGlibGUgd2l0aCB7fSB7fSBvbmx5XG5cbidcDQogICAgICAgICAgICAgICAgLmZvcm1hdChIT1NUX0FQUC5wcm9jX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICBidXR0b24ubWluX3Jldml0X3ZlcikNCg0KICAgIGlmIGlzaW5zdGFuY2UoYnV0dG9uLCAoY29tcG9uZW50cy5MaW5rQnV0dG9uLCBjb21wb25lbnRzLkludm9rZUJ1dHRvbikpOg0KICAgICAgICB0b29sdGlwX2V4dCArPSAnQ2xhc3MgTmFtZTpcbnt9XG5cbkFzc2VtYmx5IE5hbWU6XG57fVxuXG4nLmZvcm1hdCgNCiAgICAgICAgICAgIGJ1dHRvbi5jb21tYW5kX2NsYXNzIG9yICdSdW5zIGZpcnN0IG1hdGNoaW5nIERCLklFeHRlcm5hbENvbW1hbmQnLA0KICAgICAgICAgICAgYnV0dG9uLmFzc2VtYmx5KQ0KICAgIGVsc2U6DQogICAgICAgIHRvb2x0aXBfZXh0ICs9ICdDbGFzcyBOYW1lOlxue31cblxuQXNzZW1ibHkgTmFtZTpcbnt9XG5cbidcDQogICAgICAgICAgICAuZm9ybWF0KGJ1dHRvbi51bmlxdWVfbmFtZSwgYXNtX25hbWUpDQoNCiAgICBpZiBidXR0b24uY29udHJvbF9pZDoNCiAgICAgICAgdG9vbHRpcF9leHQgKz0gJ0NvbnRyb2wgSWQ6XG57fSdcDQogICAgICAgICAgICAuZm9ybWF0KGJ1dHRvbi5jb250cm9sX2lkKQ0KDQogICAgcmV0dXJuIHRvb2x0aXBfZXh0DQoNCg0KZGVmIF9tYWtlX3Rvb2x0aXBfZXh0X2lmX3JlcXVlc3RlZChidXR0b24sIGFzbV9uYW1lKToNCiAgICBpZiB1c2VyX2NvbmZpZy50b29sdGlwX2RlYnVnX2luZm86DQogICAgICAgIHJldHVybiBfbWFrZV9idXR0b25fdG9vbHRpcF9leHQoYnV0dG9uLCBhc21fbmFtZSkNCg0KDQpkZWYgX21ha2VfdWlfdGl0bGUoYnV0dG9uKToNCiAgICBpZiBidXR0b24uaGFzX2NvbmZpZ19zY3JpcHQoKToNCiAgICAgICAgcmV0dXJuIGJ1dHRvbi51aV90aXRsZSArICcge30nLmZvcm1hdChDT05GSUdfU0NSSVBUX1RJVExFX1BPU1RGSVgpDQogICAgZWxzZToNCiAgICAgICAgcmV0dXJuIGJ1dHRvbi51aV90aXRsZQ0KDQoNCmRlZiBfbWFrZV9mdWxsX2NsYXNzX25hbWUoYXNtX25hbWUsIGNsYXNzX25hbWUpOg0KICAgIGlmIGFzbV9uYW1lIGFuZCBjbGFzc19uYW1lOg0KICAgICAgICByZXR1cm4gJ3t9Lnt9Jy5mb3JtYXQoYXNtX25hbWUsIGNsYXNzX25hbWUpDQogICAgcmV0dXJuIE5vbmUNCg0KDQpkZWYgX3NldF9oaWdobGlnaHRzKGJ1dHRvbiwgdWlfaXRlbSk6DQogICAgdWlfaXRlbS5yZXNldF9oaWdobGlnaHRzKCkNCiAgICBpZiBidXR0b24uaGlnaGxpZ2h0X3R5cGUgPT0gZXh0cy5NREFUQV9ISUdITElHSFRfVFlQRV9VUERBVEVEOg0KICAgICAgICB1aV9pdGVtLmhpZ2hsaWdodF9hc191cGRhdGVkKCkNCiAgICBlbGlmIGJ1dHRvbi5oaWdobGlnaHRfdHlwZSA9PSBleHRzLk1EQVRBX0hJR0hMSUdIVF9UWVBFX05FVzoNCiAgICAgICAgdWlfaXRlbS5oaWdobGlnaHRfYXNfbmV3KCkNCg0KDQpkZWYgX2dldF9lZmZlY3RpdmVfY2xhc3NuYW1lKGJ1dHRvbik6DQogICAgIiIiVmVyaWZpZXMgaWYgYnV0dG9uIGhhcyBjbGFzc19uYW1lIHNldC4NCg0KICAgIFRoaXMgbWVhbnMgdGhhdCB0eXBlbWFrZXIgaGFzIGNyZWF0ZWQgYSBleGVjdXRvciB0eXBlIGZvciB0aGlzIGNvbW1hbmQuDQogICAgSWYgY2xhc3NfbmFtZSBpcyBub3Qgc2V0LCB0aGlzIGZ1bmN0aW9uIHJldHVybnMgYnV0dG9uLnVuaXF1ZV9uYW1lLg0KICAgIFRoaXMgYWxsb3dzIGZvciB0aGUgVUkgYnV0dG9uIHRvIGJlIGNyZWF0ZWQgYW5kIGxpbmtlZCB0byB0aGUgcHJldmlvdXNseSANCiAgICBjcmVhdGVkIGFzc2VtYmx5Lg0KICAgIElmIHRoZSB0eXBlIGRvZXMgbm90IGV4aXN0IGluIHRoZSBhc3NlbWJseSwgdGhlIFVJIGJ1dHRvbiB3aWxsIG5vdCB3b3JrLA0KICAgIGhvd2V2ZXIgdGhpcyBhbGxvd3MgdXBkYXRpbmcgdGhlIGNvbW1hbmQgd2l0aCB0aGUgY29ycmVjdCBleGVjdXRvciB0eXBlLA0KICAgIG9uY2UgY29tbWFuZCBzY3JpcHQgaGFzIGJlZW4gZml4ZWQgYW5kIHB5cmV2aXQgaXMgcmVsb2FkZWQuDQoNCiAgICBBcmdzOg0KICAgICAgICBidXR0b24gKHB5cmV2aXQuZXh0ZW5zaW9ucy5nZW5lcmljY29tcHMuR2VuZXJpY1VJQ29tbWFuZCk6IGJ1dHRvbg0KDQogICAgUmV0dXJuczoNCiAgICAgICAgKHN0cik6IGNsYXNzX25hbWUgKG9yIHVuaXF1ZV9uYW1lIGlmIGNsYXNzX25hbWUgaXMgTm9uZSkNCiAgICAiIiINCiAgICByZXR1cm4gYnV0dG9uLmNsYXNzX25hbWUgaWYgYnV0dG9uLmNsYXNzX25hbWUgZWxzZSBidXR0b24udW5pcXVlX25hbWUNCg0KDQpkZWYgX3Byb2R1Y2VfdWlfc2VwYXJhdG9yKHVpX21ha2VyX3BhcmFtcyk6DQogICAgIiIiQ3JlYXRlIGEgc2VwYXJhdG9yLg0KDQogICAgQXJnczoNCiAgICAgICAgdWlfbWFrZXJfcGFyYW1zIChVSU1ha2VyUGFyYW1zKTogU3RhbmRhcmQgcGFyYW1ldGVycyBmb3IgbWFraW5nIHVpIGl0ZW0uDQogICAgIiIiDQogICAgcGFyZW50X3VpX2l0ZW0gPSB1aV9tYWtlcl9wYXJhbXMucGFyZW50X3VpDQogICAgZXh0X2FzbV9pbmZvID0gdWlfbWFrZXJfcGFyYW1zLmFzbV9pbmZvDQoNCiAgICBpZiBub3QgZXh0X2FzbV9pbmZvLnJlbG9hZGluZzoNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnQWRkaW5nIHNlcGFyYXRvciB0bzogJXMnLCBwYXJlbnRfdWlfaXRlbSkNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgaWYgaGFzYXR0cihwYXJlbnRfdWlfaXRlbSwgJ2FkZF9zZXBhcmF0b3InKTogICAgIyByZSBpc3N1ZSAjMzYxDQogICAgICAgICAgICAgICAgcGFyZW50X3VpX2l0ZW0uYWRkX3NlcGFyYXRvcigpDQogICAgICAgIGV4Y2VwdCBQeVJldml0RXhjZXB0aW9uIGFzIGVycjoNCiAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoJ1VJIGVycm9yOiAlcycsIGVyci5tc2cpDQoNCiAgICByZXR1cm4gTm9uZQ0KDQoNCmRlZiBfcHJvZHVjZV91aV9zbGlkZW91dCh1aV9tYWtlcl9wYXJhbXMpOg0KICAgICIiIkNyZWF0ZSBhIHNsaWRlIG91dC4NCg0KICAgIEFyZ3M6DQogICAgICAgIHVpX21ha2VyX3BhcmFtcyAoVUlNYWtlclBhcmFtcyk6IFN0YW5kYXJkIHBhcmFtZXRlcnMgZm9yIG1ha2luZyB1aSBpdGVtLg0KICAgICIiIg0KICAgIHBhcmVudF91aV9pdGVtID0gdWlfbWFrZXJfcGFyYW1zLnBhcmVudF91aQ0KICAgIGV4dF9hc21faW5mbyA9IHVpX21ha2VyX3BhcmFtcy5hc21faW5mbw0KDQogICAgaWYgbm90IGV4dF9hc21faW5mby5yZWxvYWRpbmc6DQogICAgICAgIG1sb2dnZXIuZGVidWcoJ0FkZGluZyBzbGlkZSBvdXQgdG86ICVzJywgcGFyZW50X3VpX2l0ZW0pDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHBhcmVudF91aV9pdGVtLmFkZF9zbGlkZW91dCgpDQogICAgICAgIGV4Y2VwdCBQeVJldml0RXhjZXB0aW9uIGFzIGVycjoNCiAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoJ1VJIGVycm9yOiAlcycsIGVyci5tc2cpDQoNCiAgICByZXR1cm4gTm9uZQ0KDQoNCmRlZiBfcHJvZHVjZV91aV9zbWFydGJ1dHRvbih1aV9tYWtlcl9wYXJhbXMpOg0KICAgICIiIkNyZWF0ZSBhIHNtYXJ0IGJ1dHRvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIHVpX21ha2VyX3BhcmFtcyAoVUlNYWtlclBhcmFtcyk6IFN0YW5kYXJkIHBhcmFtZXRlcnMgZm9yIG1ha2luZyB1aSBpdGVtLg0KICAgICIiIg0KICAgIHBhcmVudF91aV9pdGVtID0gdWlfbWFrZXJfcGFyYW1zLnBhcmVudF91aQ0KICAgIHBhcmVudCA9IHVpX21ha2VyX3BhcmFtcy5wYXJlbnRfY21wDQogICAgc21hcnRidXR0b24gPSB1aV9tYWtlcl9wYXJhbXMuY29tcG9uZW50DQogICAgZXh0X2FzbV9pbmZvID0gdWlfbWFrZXJfcGFyYW1zLmFzbV9pbmZvDQoNCiAgICBpZiBub3Qgc21hcnRidXR0b24uaXNfc3VwcG9ydGVkOg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgaWYgc21hcnRidXR0b24uaXNfYmV0YSBhbmQgbm90IHVpX21ha2VyX3BhcmFtcy5jcmVhdGVfYmV0YV9jbWRzOg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgbWxvZ2dlci5kZWJ1ZygnUHJvZHVjaW5nIHNtYXJ0IGJ1dHRvbjogJXMnLCBzbWFydGJ1dHRvbikNCiAgICB0cnk6DQogICAgICAgIHBhcmVudF91aV9pdGVtLmNyZWF0ZV9wdXNoX2J1dHRvbigNCiAgICAgICAgICAgIGJ1dHRvbl9uYW1lPXNtYXJ0YnV0dG9uLm5hbWUsDQogICAgICAgICAgICBhc21fbG9jYXRpb249ZXh0X2FzbV9pbmZvLmxvY2F0aW9uLA0KICAgICAgICAgICAgY2xhc3NfbmFtZT1fZ2V0X2VmZmVjdGl2ZV9jbGFzc25hbWUoc21hcnRidXR0b24pLA0KICAgICAgICAgICAgaWNvbl9wYXRoPXNtYXJ0YnV0dG9uLmljb25fZmlsZSBvciBwYXJlbnQuaWNvbl9maWxlLA0KICAgICAgICAgICAgdG9vbHRpcD1fbWFrZV9idXR0b25fdG9vbHRpcChzbWFydGJ1dHRvbiksDQogICAgICAgICAgICB0b29sdGlwX2V4dD1fbWFrZV90b29sdGlwX2V4dF9pZl9yZXF1ZXN0ZWQoc21hcnRidXR0b24sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0X2FzbV9pbmZvLm5hbWUpLA0KICAgICAgICAgICAgdG9vbHRpcF9tZWRpYT1zbWFydGJ1dHRvbi5tZWRpYV9maWxlLA0KICAgICAgICAgICAgY3R4aGVscHVybD1zbWFydGJ1dHRvbi5oZWxwX3VybCwNCiAgICAgICAgICAgIGF2YWlsX2NsYXNzX25hbWU9c21hcnRidXR0b24uYXZhaWxfY2xhc3NfbmFtZSwNCiAgICAgICAgICAgIHVwZGF0ZV9pZl9leGlzdHM9VHJ1ZSwNCiAgICAgICAgICAgIHVpX3RpdGxlPV9tYWtlX3VpX3RpdGxlKHNtYXJ0YnV0dG9uKSkNCiAgICBleGNlcHQgUHlSZXZpdEV4Y2VwdGlvbiBhcyBlcnI6DQogICAgICAgIG1sb2dnZXIuZXJyb3IoJ1VJIGVycm9yOiAlcycsIGVyci5tc2cpDQogICAgICAgIHJldHVybiBOb25lDQoNCiAgICBzbWFydGJ1dHRvbl91aSA9IHBhcmVudF91aV9pdGVtLmJ1dHRvbihzbWFydGJ1dHRvbi5uYW1lKQ0KDQogICAgbWxvZ2dlci5kZWJ1ZygnSW1wb3J0aW5nIHNtYXJ0IGJ1dHRvbiBhcyBtb2R1bGU6ICVzJywgc21hcnRidXR0b24pDQogICAgdHJ5Og0KICAgICAgICAjIHJlcGxhY2luZyBFWEVDX1BBUkFNUy5jb21tYW5kX25hbWUgdmFsdWUgd2l0aCBidXR0b24gbmFtZSBzbyB0aGUNCiAgICAgICAgIyBpbml0IHNjcmlwdCBjYW4gbG9nIHVuZGVyIGl0cyBvd24gbmFtZQ0KICAgICAgICBwcmV2X2NvbW1hbmRuYW1lID0gXA0KICAgICAgICAgICAgX19idWlsdGluc19fWydfX2NvbW1hbmRuYW1lX18nXSBcDQogICAgICAgICAgICBpZiAnX19jb21tYW5kbmFtZV9fJyBpbiBfX2J1aWx0aW5zX18gZWxzZSBOb25lDQogICAgICAgIHByZXZfY29tbWFuZHBhdGggPSBcDQogICAgICAgICAgICBfX2J1aWx0aW5zX19bJ19fY29tbWFuZHBhdGhfXyddIFwNCiAgICAgICAgICAgIGlmICdfX2NvbW1hbmRwYXRoX18nIGluIF9fYnVpbHRpbnNfXyBlbHNlIE5vbmUNCiAgICAgICAgcHJldl9zaGlmdGNsaWNrID0gXA0KICAgICAgICAgICAgX19idWlsdGluc19fWydfX3NoaWZ0Y2xpY2tfXyddIFwNCiAgICAgICAgICAgIGlmICdfX3NoaWZ0Y2xpY2tfXycgaW4gX19idWlsdGluc19fIGVsc2UgRmFsc2UNCiAgICAgICAgcHJldl9kZWJ1Z21vZGUgPSBcDQogICAgICAgICAgICBfX2J1aWx0aW5zX19bJ19fZm9yY2VkZGVidWdtb2RlX18nXSBcDQogICAgICAgICAgICBpZiAnX19mb3JjZWRkZWJ1Z21vZGVfXycgaW4gX19idWlsdGluc19fIGVsc2UgRmFsc2UNCg0KICAgICAgICBfX2J1aWx0aW5zX19bJ19fY29tbWFuZG5hbWVfXyddID0gc21hcnRidXR0b24ubmFtZQ0KICAgICAgICBfX2J1aWx0aW5zX19bJ19fY29tbWFuZHBhdGhfXyddID0gc21hcnRidXR0b24uc2NyaXB0X2ZpbGUNCiAgICAgICAgX19idWlsdGluc19fWydfX3NoaWZ0Y2xpY2tfXyddID0gRmFsc2UNCiAgICAgICAgX19idWlsdGluc19fWydfX2ZvcmNlZGRlYnVnbW9kZV9fJ10gPSBGYWxzZQ0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICBtbG9nZ2VyLmVycm9yKCdTbWFydCBidXR0b24gc2V0dXAgZXJyb3I6ICVzIHwgJXMnLCBzbWFydGJ1dHRvbiwgZXJyKQ0KICAgICAgICByZXR1cm4gc21hcnRidXR0b25fdWkNCg0KICAgIHRyeToNCiAgICAgICAgIyBzZXR1cCBzeXMucGF0aHMgZm9yIHRoZSBzbWFydCBjb21tYW5kDQogICAgICAgIGN1cnJlbnRfcGF0aHMgPSBsaXN0KHN5cy5wYXRoKQ0KICAgICAgICBmb3Igc2VhcmNoX3BhdGggaW4gc21hcnRidXR0b24ubW9kdWxlX3BhdGhzOg0KICAgICAgICAgICAgaWYgc2VhcmNoX3BhdGggbm90IGluIGN1cnJlbnRfcGF0aHM6DQogICAgICAgICAgICAgICAgc3lzLnBhdGguYXBwZW5kKHNlYXJjaF9wYXRoKQ0KDQogICAgICAgICMgaW1wb3J0aW5nIHNtYXJ0IGJ1dHRvbiBzY3JpcHQgYXMgYSBtb2R1bGUNCiAgICAgICAgaW1wb3J0ZWRzY3JpcHQgPSBpbXAubG9hZF9zb3VyY2Uoc21hcnRidXR0b24udW5pcXVlX25hbWUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNtYXJ0YnV0dG9uLnNjcmlwdF9maWxlKQ0KICAgICAgICAjIHJlc2V0dGluZyBFWEVDX1BBUkFNUy5jb21tYW5kX25hbWUgdG8gb3JpZ2luYWwNCiAgICAgICAgX19idWlsdGluc19fWydfX2NvbW1hbmRuYW1lX18nXSA9IHByZXZfY29tbWFuZG5hbWUNCiAgICAgICAgX19idWlsdGluc19fWydfX2NvbW1hbmRwYXRoX18nXSA9IHByZXZfY29tbWFuZHBhdGgNCiAgICAgICAgX19idWlsdGluc19fWydfX3NoaWZ0Y2xpY2tfXyddID0gcHJldl9zaGlmdGNsaWNrDQogICAgICAgIF9fYnVpbHRpbnNfX1snX19mb3JjZWRkZWJ1Z21vZGVfXyddID0gcHJldl9kZWJ1Z21vZGUNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnSW1wb3J0IHN1Y2Nlc3NmdWw6ICVzJywgaW1wb3J0ZWRzY3JpcHQpDQogICAgICAgIG1sb2dnZXIuZGVidWcoJ1J1bm5pbmcgc2VsZiBpbml0aWFsaXplcjogJXMnLCBzbWFydGJ1dHRvbikNCg0KICAgICAgICAjIHJlc2V0IHN5cy5wYXRocyBiYWNrIHRvIG5vcm1hbA0KICAgICAgICBzeXMucGF0aCA9IGN1cnJlbnRfcGF0aHMNCg0KICAgICAgICByZXMgPSBGYWxzZQ0KICAgICAgICB0cnk6DQogICAgICAgICAgICAjIHJ1bm5pbmcgdGhlIHNtYXJ0IGJ1dHRvbiBpbml0aWFsaXplciBmdW5jdGlvbg0KICAgICAgICAgICAgcmVzID0gaW1wb3J0ZWRzY3JpcHQuX19zZWxmaW5pdF9fKHNtYXJ0YnV0dG9uLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNtYXJ0YnV0dG9uX3VpLCBIT1NUX0FQUC51aWFwcCkNCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBidXR0b25fZXJyOg0KICAgICAgICAgICAgbWxvZ2dlci5lcnJvcignRXJyb3IgaW5pdGlhbGl6aW5nIHNtYXJ0IGJ1dHRvbjogJXMgfCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgICAgIHNtYXJ0YnV0dG9uLCBidXR0b25fZXJyKQ0KDQogICAgICAgICMgaWYgdGhlIF9fc2VsZmluaXRfXyBmdW5jdGlvbiByZXR1cm5zIEZhbHNlDQogICAgICAgICMgcmVtb3ZlIHRoZSBidXR0b24NCiAgICAgICAgaWYgcmVzIGlzIEZhbHNlOg0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnU2VsZkluaXQgcmV0dXJuZWQgRmFsc2Ugb24gU21hcnRidXR0b246ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgc21hcnRidXR0b25fdWkpDQogICAgICAgICAgICBzbWFydGJ1dHRvbl91aS5kZWFjdGl2YXRlKCkNCg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdTZWxmSW5pdCBzdWNjZXNzZnVsIG9uIFNtYXJ0YnV0dG9uOiAlcycsIHNtYXJ0YnV0dG9uX3VpKQ0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICBtbG9nZ2VyLmVycm9yKCdTbWFydCBidXR0b24gc2NyaXB0IGltcG9ydCBlcnJvcjogJXMgfCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgc21hcnRidXR0b24sIGVycikNCiAgICAgICAgcmV0dXJuIHNtYXJ0YnV0dG9uX3VpDQoNCiAgICBfc2V0X2hpZ2hsaWdodHMoc21hcnRidXR0b24sIHNtYXJ0YnV0dG9uX3VpKQ0KDQogICAgcmV0dXJuIHNtYXJ0YnV0dG9uX3VpDQoNCg0KZGVmIF9wcm9kdWNlX3VpX2xpbmtidXR0b24odWlfbWFrZXJfcGFyYW1zKToNCiAgICAiIiJDcmVhdGUgYSBsaW5rIGJ1dHRvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIHVpX21ha2VyX3BhcmFtcyAoVUlNYWtlclBhcmFtcyk6IFN0YW5kYXJkIHBhcmFtZXRlcnMgZm9yIG1ha2luZyB1aSBpdGVtLg0KICAgICIiIg0KICAgIHBhcmVudF91aV9pdGVtID0gdWlfbWFrZXJfcGFyYW1zLnBhcmVudF91aQ0KICAgIHBhcmVudCA9IHVpX21ha2VyX3BhcmFtcy5wYXJlbnRfY21wDQogICAgbGlua2J1dHRvbiA9IHVpX21ha2VyX3BhcmFtcy5jb21wb25lbnQNCiAgICBleHRfYXNtX2luZm8gPSB1aV9tYWtlcl9wYXJhbXMuYXNtX2luZm8NCg0KICAgIGlmIG5vdCBsaW5rYnV0dG9uLmlzX3N1cHBvcnRlZDoNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KICAgIGlmIGxpbmtidXR0b24uaXNfYmV0YSBhbmQgbm90IHVpX21ha2VyX3BhcmFtcy5jcmVhdGVfYmV0YV9jbWRzOg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgbWxvZ2dlci5kZWJ1ZygnUHJvZHVjaW5nIGJ1dHRvbjogJXMnLCBsaW5rYnV0dG9uKQ0KICAgIHRyeToNCiAgICAgICAgbGlua2VkX2FzbSA9IE5vbmUNCiAgICAgICAgIyBhdHRlbXAgdG8gZmluZCB0aGUgYXNzZW1ibHkgZmlsZQ0KICAgICAgICBsaW5rZWRfYXNtX2ZpbGUgPSBsaW5rYnV0dG9uLmdldF90YXJnZXRfYXNzZW1ibHkoKQ0KICAgICAgICAjIGlmIG5vdCBmb3VuZCwgc2VhcmNoIHRoZSBsb2FkZWQgYXNzZW1ibGllcw0KICAgICAgICAjIHRoaXMgaXMgdXN1YWxseSBhIHNsb3dlciBwcm9jZXNzDQogICAgICAgIGlmIGxpbmtlZF9hc21fZmlsZToNCiAgICAgICAgICAgIGxpbmtlZF9hc20gPSBhc3NtdXRpbHMubG9hZF9hc21fZmlsZShsaW5rZWRfYXNtX2ZpbGUpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICBsaW5rZWRfYXNtX2xpc3QgPSBhc3NtdXRpbHMuZmluZF9sb2FkZWRfYXNtKGxpbmtidXR0b24uYXNzZW1ibHkpDQogICAgICAgICAgICAjIGNhbmNlbCBidXR0b24gY3JlYXRpb24gaWYgbm90IGZvdW5kDQogICAgICAgICAgICBpZiBub3QgbGlua2VkX2FzbV9saXN0Og0KICAgICAgICAgICAgICAgIG1sb2dnZXIuZXJyb3IoIkNhbiBub3QgZmluZCB0YXJnZXQgYXNzZW1ibHkgZm9yICVzIiwgbGlua2J1dHRvbikNCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQ0KICAgICAgICAgICAgbGlua2VkX2FzbSA9IGxpbmtlZF9hc21fbGlzdFswXQ0KDQogICAgICAgIGxpbmtlZF9hc21fbmFtZSA9IGxpbmtlZF9hc20uR2V0TmFtZSgpLk5hbWUNCiAgICAgICAgcGFyZW50X3VpX2l0ZW0uY3JlYXRlX3B1c2hfYnV0dG9uKA0KICAgICAgICAgICAgYnV0dG9uX25hbWU9bGlua2J1dHRvbi5uYW1lLA0KICAgICAgICAgICAgYXNtX2xvY2F0aW9uPWxpbmtlZF9hc20uTG9jYXRpb24sDQogICAgICAgICAgICBjbGFzc19uYW1lPV9tYWtlX2Z1bGxfY2xhc3NfbmFtZSgNCiAgICAgICAgICAgICAgICBsaW5rZWRfYXNtX25hbWUsDQogICAgICAgICAgICAgICAgbGlua2J1dHRvbi5jb21tYW5kX2NsYXNzDQogICAgICAgICAgICAgICAgKSwNCiAgICAgICAgICAgIGljb25fcGF0aD1saW5rYnV0dG9uLmljb25fZmlsZSBvciBwYXJlbnQuaWNvbl9maWxlLA0KICAgICAgICAgICAgdG9vbHRpcD1fbWFrZV9idXR0b25fdG9vbHRpcChsaW5rYnV0dG9uKSwNCiAgICAgICAgICAgIHRvb2x0aXBfZXh0PV9tYWtlX3Rvb2x0aXBfZXh0X2lmX3JlcXVlc3RlZChsaW5rYnV0dG9uLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4dF9hc21faW5mby5uYW1lKSwNCiAgICAgICAgICAgIHRvb2x0aXBfbWVkaWE9bGlua2J1dHRvbi5tZWRpYV9maWxlLA0KICAgICAgICAgICAgY3R4aGVscHVybD1saW5rYnV0dG9uLmhlbHBfdXJsLA0KICAgICAgICAgICAgYXZhaWxfY2xhc3NfbmFtZT1fbWFrZV9mdWxsX2NsYXNzX25hbWUoDQogICAgICAgICAgICAgICAgbGlua2VkX2FzbV9uYW1lLA0KICAgICAgICAgICAgICAgIGxpbmtidXR0b24uYXZhaWxfY29tbWFuZF9jbGFzcw0KICAgICAgICAgICAgICAgICksDQogICAgICAgICAgICB1cGRhdGVfaWZfZXhpc3RzPVRydWUsDQogICAgICAgICAgICB1aV90aXRsZT1fbWFrZV91aV90aXRsZShsaW5rYnV0dG9uKSkNCiAgICAgICAgbGlua2J1dHRvbl91aSA9IHBhcmVudF91aV9pdGVtLmJ1dHRvbihsaW5rYnV0dG9uLm5hbWUpDQoNCiAgICAgICAgX3NldF9oaWdobGlnaHRzKGxpbmtidXR0b24sIGxpbmtidXR0b25fdWkpDQoNCiAgICAgICAgcmV0dXJuIGxpbmtidXR0b25fdWkNCiAgICBleGNlcHQgUHlSZXZpdEV4Y2VwdGlvbiBhcyBlcnI6DQogICAgICAgIG1sb2dnZXIuZXJyb3IoJ1VJIGVycm9yOiAlcycsIGVyci5tc2cpDQogICAgICAgIHJldHVybiBOb25lDQoNCg0KZGVmIF9wcm9kdWNlX3VpX3B1c2hidXR0b24odWlfbWFrZXJfcGFyYW1zKToNCiAgICAiIiJDcmVhdGUgYSBwdXNoIGJ1dHRvbi4NCg0KICAgIEFyZ3M6DQogICAgICAgIHVpX21ha2VyX3BhcmFtcyAoVUlNYWtlclBhcmFtcyk6IFN0YW5kYXJkIHBhcmFtZXRlcnMgZm9yIG1ha2luZyB1aSBpdGVtLg0KICAgICIiIg0KICAgIHBhcmVudF91aV9pdGVtID0gdWlfbWFrZXJfcGFyYW1zLnBhcmVudF91aQ0KICAgIHBhcmVudCA9IHVpX21ha2VyX3BhcmFtcy5wYXJlbnRfY21wDQogICAgcHVzaGJ1dHRvbiA9IHVpX21ha2VyX3BhcmFtcy5jb21wb25lbnQNCiAgICBleHRfYXNtX2luZm8gPSB1aV9tYWtlcl9wYXJhbXMuYXNtX2luZm8NCg0KICAgIGlmIG5vdCBwdXNoYnV0dG9uLmlzX3N1cHBvcnRlZDoNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KICAgIGlmIHB1c2hidXR0b24uaXNfYmV0YSBhbmQgbm90IHVpX21ha2VyX3BhcmFtcy5jcmVhdGVfYmV0YV9jbWRzOg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgbWxvZ2dlci5kZWJ1ZygnUHJvZHVjaW5nIGJ1dHRvbjogJXMnLCBwdXNoYnV0dG9uKQ0KICAgIHRyeToNCiAgICAgICAgcGFyZW50X3VpX2l0ZW0uY3JlYXRlX3B1c2hfYnV0dG9uKA0KICAgICAgICAgICAgYnV0dG9uX25hbWU9cHVzaGJ1dHRvbi5uYW1lLA0KICAgICAgICAgICAgYXNtX2xvY2F0aW9uPWV4dF9hc21faW5mby5sb2NhdGlvbiwNCiAgICAgICAgICAgIGNsYXNzX25hbWU9X2dldF9lZmZlY3RpdmVfY2xhc3NuYW1lKHB1c2hidXR0b24pLA0KICAgICAgICAgICAgaWNvbl9wYXRoPXB1c2hidXR0b24uaWNvbl9maWxlIG9yIHBhcmVudC5pY29uX2ZpbGUsDQogICAgICAgICAgICB0b29sdGlwPV9tYWtlX2J1dHRvbl90b29sdGlwKHB1c2hidXR0b24pLA0KICAgICAgICAgICAgdG9vbHRpcF9leHQ9X21ha2VfdG9vbHRpcF9leHRfaWZfcmVxdWVzdGVkKHB1c2hidXR0b24sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0X2FzbV9pbmZvLm5hbWUpLA0KICAgICAgICAgICAgdG9vbHRpcF9tZWRpYT1wdXNoYnV0dG9uLm1lZGlhX2ZpbGUsDQogICAgICAgICAgICBjdHhoZWxwdXJsPXB1c2hidXR0b24uaGVscF91cmwsDQogICAgICAgICAgICBhdmFpbF9jbGFzc19uYW1lPXB1c2hidXR0b24uYXZhaWxfY2xhc3NfbmFtZSwNCiAgICAgICAgICAgIHVwZGF0ZV9pZl9leGlzdHM9VHJ1ZSwNCiAgICAgICAgICAgIHVpX3RpdGxlPV9tYWtlX3VpX3RpdGxlKHB1c2hidXR0b24pKQ0KICAgICAgICBwdXNoYnV0dG9uX3VpID0gcGFyZW50X3VpX2l0ZW0uYnV0dG9uKHB1c2hidXR0b24ubmFtZSkNCg0KICAgICAgICBfc2V0X2hpZ2hsaWdodHMocHVzaGJ1dHRvbiwgcHVzaGJ1dHRvbl91aSkNCg0KICAgICAgICByZXR1cm4gcHVzaGJ1dHRvbl91aQ0KICAgIGV4Y2VwdCBQeVJldml0RXhjZXB0aW9uIGFzIGVycjoNCiAgICAgICAgbWxvZ2dlci5lcnJvcignVUkgZXJyb3I6ICVzJywgZXJyLm1zZykNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KDQpkZWYgX3Byb2R1Y2VfdWlfcHVsbGRvd24odWlfbWFrZXJfcGFyYW1zKToNCiAgICAiIiJDcmVhdGUgYSBwdWxsZG93biBidXR0b24uDQoNCiAgICBBcmdzOg0KICAgICAgICB1aV9tYWtlcl9wYXJhbXMgKFVJTWFrZXJQYXJhbXMpOiBTdGFuZGFyZCBwYXJhbWV0ZXJzIGZvciBtYWtpbmcgdWkgaXRlbS4NCiAgICAiIiINCiAgICBwYXJlbnRfcmliYm9uX3BhbmVsID0gdWlfbWFrZXJfcGFyYW1zLnBhcmVudF91aQ0KICAgIHB1bGxkb3duID0gdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudA0KDQogICAgbWxvZ2dlci5kZWJ1ZygnUHJvZHVjaW5nIHB1bGxkb3duIGJ1dHRvbjogJXMnLCBwdWxsZG93bikNCiAgICB0cnk6DQogICAgICAgIHBhcmVudF9yaWJib25fcGFuZWwuY3JlYXRlX3B1bGxkb3duX2J1dHRvbihwdWxsZG93bi51aV90aXRsZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1bGxkb3duLmljb25fZmlsZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9pZl9leGlzdHM9VHJ1ZSkNCiAgICAgICAgcHVsbGRvd25fdWkgPSBwYXJlbnRfcmliYm9uX3BhbmVsLnJpYmJvbl9pdGVtKHB1bGxkb3duLnVpX3RpdGxlKQ0KDQogICAgICAgIF9zZXRfaGlnaGxpZ2h0cyhwdWxsZG93biwgcHVsbGRvd25fdWkpDQoNCiAgICAgICAgcmV0dXJuIHB1bGxkb3duX3VpDQogICAgZXhjZXB0IFB5UmV2aXRFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICBtbG9nZ2VyLmVycm9yKCdVSSBlcnJvcjogJXMnLCBlcnIubXNnKQ0KICAgICAgICByZXR1cm4gTm9uZQ0KDQoNCmRlZiBfcHJvZHVjZV91aV9zcGxpdCh1aV9tYWtlcl9wYXJhbXMpOg0KICAgICIiIlByb2R1Y2UgYSBzcGxpdCBidXR0b24uDQoNCiAgICBBcmdzOg0KICAgICAgICB1aV9tYWtlcl9wYXJhbXMgKFVJTWFrZXJQYXJhbXMpOiBTdGFuZGFyZCBwYXJhbWV0ZXJzIGZvciBtYWtpbmcgdWkgaXRlbS4NCiAgICAiIiINCiAgICBwYXJlbnRfcmliYm9uX3BhbmVsID0gdWlfbWFrZXJfcGFyYW1zLnBhcmVudF91aQ0KICAgIHNwbGl0ID0gdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudA0KDQogICAgbWxvZ2dlci5kZWJ1ZygnUHJvZHVjaW5nIHNwbGl0IGJ1dHRvbjogJXN9Jywgc3BsaXQpDQogICAgdHJ5Og0KICAgICAgICBwYXJlbnRfcmliYm9uX3BhbmVsLmNyZWF0ZV9zcGxpdF9idXR0b24oc3BsaXQudWlfdGl0bGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGxpdC5pY29uX2ZpbGUsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfaWZfZXhpc3RzPVRydWUpDQogICAgICAgIHNwbGl0X3VpID0gcGFyZW50X3JpYmJvbl9wYW5lbC5yaWJib25faXRlbShzcGxpdC51aV90aXRsZSkNCg0KICAgICAgICBfc2V0X2hpZ2hsaWdodHMoc3BsaXQsIHNwbGl0X3VpKQ0KDQogICAgICAgIHJldHVybiBzcGxpdF91aQ0KICAgIGV4Y2VwdCBQeVJldml0RXhjZXB0aW9uIGFzIGVycjoNCiAgICAgICAgbWxvZ2dlci5lcnJvcignVUkgZXJyb3I6ICVzJywgZXJyLm1zZykNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KDQpkZWYgX3Byb2R1Y2VfdWlfc3BsaXRwdXNoKHVpX21ha2VyX3BhcmFtcyk6DQogICAgIiIiQ3JlYXRlIHNwbGl0IHB1c2ggYnV0dG9uLg0KDQogICAgQXJnczoNCiAgICAgICAgdWlfbWFrZXJfcGFyYW1zIChVSU1ha2VyUGFyYW1zKTogU3RhbmRhcmQgcGFyYW1ldGVycyBmb3IgbWFraW5nIHVpIGl0ZW0uDQogICAgIiIiDQogICAgcGFyZW50X3JpYmJvbl9wYW5lbCA9IHVpX21ha2VyX3BhcmFtcy5wYXJlbnRfdWkNCiAgICBzcGxpdHB1c2ggPSB1aV9tYWtlcl9wYXJhbXMuY29tcG9uZW50DQoNCiAgICBtbG9nZ2VyLmRlYnVnKCdQcm9kdWNpbmcgc3BsaXRwdXNoIGJ1dHRvbjogJXMnLCBzcGxpdHB1c2gpDQogICAgdHJ5Og0KICAgICAgICBwYXJlbnRfcmliYm9uX3BhbmVsLmNyZWF0ZV9zcGxpdHB1c2hfYnV0dG9uKHNwbGl0cHVzaC51aV90aXRsZSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGxpdHB1c2guaWNvbl9maWxlLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9pZl9leGlzdHM9VHJ1ZSkNCiAgICAgICAgc3BsaXRwdXNoX3VpID0gcGFyZW50X3JpYmJvbl9wYW5lbC5yaWJib25faXRlbShzcGxpdHB1c2gudWlfdGl0bGUpDQoNCiAgICAgICAgX3NldF9oaWdobGlnaHRzKHNwbGl0cHVzaCwgc3BsaXRwdXNoX3VpKQ0KDQogICAgICAgIHJldHVybiBzcGxpdHB1c2hfdWkNCiAgICBleGNlcHQgUHlSZXZpdEV4Y2VwdGlvbiBhcyBlcnI6DQogICAgICAgIG1sb2dnZXIuZXJyb3IoJ1VJIGVycm9yOiAlcycsIGVyci5tc2cpDQogICAgICAgIHJldHVybiBOb25lDQoNCg0KZGVmIF9wcm9kdWNlX3VpX3N0YWNrcyh1aV9tYWtlcl9wYXJhbXMpOg0KICAgICIiIkNyZWF0ZSBhIHN0YWNrIG9mIHVpIGl0ZW1zLg0KDQogICAgQXJnczoNCiAgICAgICAgdWlfbWFrZXJfcGFyYW1zIChVSU1ha2VyUGFyYW1zKTogU3RhbmRhcmQgcGFyYW1ldGVycyBmb3IgbWFraW5nIHVpIGl0ZW0uDQogICAgIiIiDQogICAgcGFyZW50X3VpX3BhbmVsID0gdWlfbWFrZXJfcGFyYW1zLnBhcmVudF91aQ0KICAgIHN0YWNrX3BhcmVudCA9IHVpX21ha2VyX3BhcmFtcy5wYXJlbnRfY21wDQogICAgc3RhY2tfY21wID0gdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudA0KICAgIGV4dF9hc21faW5mbyA9IHVpX21ha2VyX3BhcmFtcy5hc21faW5mbw0KDQogICAgIyBpZiBzdWJfY21wIGlzIGEgc3RhY2ssIGFzayBwYXJlbnRfdWlfaXRlbSB0byBvcGVuIGEgc3RhY2sNCiAgICAjIChwYXJlbnRfdWlfaXRlbS5vcGVuX3N0YWNrKS4NCiAgICAjIEFsbCBzdWJzZXF1ZW50IGl0ZW1zIHdpbGwgYmUgcGxhY2VkIHVuZGVyIHRoaXMgc3RhY2suIENsb3NlIHRoZSBzdGFjaw0KICAgICMgKHBhcmVudF91aV9pdGVtLmNsb3NlX3N0YWNrKSB0byBmaW5pc2ggYWRkaW5nIGl0ZW1zIHRvIHRoZSBzdGFjay4NCiAgICB0cnk6DQogICAgICAgIHBhcmVudF91aV9wYW5lbC5vcGVuX3N0YWNrKCkNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnT3BlbmVkIHN0YWNrOiAlcycsIHN0YWNrX2NtcC5uYW1lKQ0KDQogICAgICAgIGlmIEhPU1RfQVBQLmlzX29sZGVyX3RoYW4oJzIwMTcnKToNCiAgICAgICAgICAgIF9jb21wb25lbnRfY3JlYXRpb25fZGljdFtleHRzLlNQTElUX0JVVFRPTl9QT1NURklYXSA9IFwNCiAgICAgICAgICAgICAgICBfcHJvZHVjZV91aV9wdWxsZG93bg0KICAgICAgICAgICAgX2NvbXBvbmVudF9jcmVhdGlvbl9kaWN0W2V4dHMuU1BMSVRQVVNIX0JVVFRPTl9QT1NURklYXSA9IFwNCiAgICAgICAgICAgICAgICBfcHJvZHVjZV91aV9wdWxsZG93bg0KDQogICAgICAgICMgY2FwdHVyaW5nIGFuZCBsb2dnaW5nIGFueSBlcnJvcnMgb24gc3RhY2sgaXRlbQ0KICAgICAgICAjIChlLmcgd2hlbiBwYXJlbnRfdWlfcGFuZWwncyBzdGFjayBpcyBmdWxsIGFuZCBjYW4gbm90IGFkZCBhbnkNCiAgICAgICAgIyBtb3JlIGl0ZW1zIGl0IHdpbGwgcmFpc2UgYW4gZXJyb3IpDQogICAgICAgIF9yZWN1cnNpdmVseV9wcm9kdWNlX3VpX2l0ZW1zKA0KICAgICAgICAgICAgVUlNYWtlclBhcmFtcyhwYXJlbnRfdWlfcGFuZWwsDQogICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrX3BhcmVudCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2tfY21wLA0KICAgICAgICAgICAgICAgICAgICAgICAgICBleHRfYXNtX2luZm8sDQogICAgICAgICAgICAgICAgICAgICAgICAgIHVpX21ha2VyX3BhcmFtcy5jcmVhdGVfYmV0YV9jbWRzKSkNCg0KICAgICAgICBpZiBIT1NUX0FQUC5pc19vbGRlcl90aGFuKCcyMDE3Jyk6DQogICAgICAgICAgICBfY29tcG9uZW50X2NyZWF0aW9uX2RpY3RbZXh0cy5TUExJVF9CVVRUT05fUE9TVEZJWF0gPSBcDQogICAgICAgICAgICAgICAgX3Byb2R1Y2VfdWlfc3BsaXQNCiAgICAgICAgICAgIF9jb21wb25lbnRfY3JlYXRpb25fZGljdFtleHRzLlNQTElUUFVTSF9CVVRUT05fUE9TVEZJWF0gPSBcDQogICAgICAgICAgICAgICAgX3Byb2R1Y2VfdWlfc3BsaXRwdXNoDQoNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgcGFyZW50X3VpX3BhbmVsLmNsb3NlX3N0YWNrKCkNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0Nsb3NlZCBzdGFjazogJXMnLCBzdGFja19jbXAubmFtZSkNCiAgICAgICAgICAgIHJldHVybiBzdGFja19jbXANCiAgICAgICAgZXhjZXB0IFB5UmV2aXRFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICAgICAgbWxvZ2dlci5lcnJvcignRXJyb3IgY3JlYXRpbmcgc3RhY2sgfCAlcycsIGVycikNCg0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICBtbG9nZ2VyLmVycm9yKCdDYW4gbm90IGNyZWF0ZSBzdGFjayB1bmRlciB0aGlzIHBhcmVudDogJXMgfCAlcycsDQogICAgICAgICAgICAgICAgICAgICAgcGFyZW50X3VpX3BhbmVsLCBlcnIpDQoNCg0KZGVmIF9wcm9kdWNlX3VpX3BhbmVscHVzaGJ1dHRvbih1aV9tYWtlcl9wYXJhbXMpOg0KICAgICIiIkNyZWF0ZSBhIHB1c2ggYnV0dG9uIHdpdGggdGhlIGdpdmVuIHBhcmFtZXRlcnMuDQoNCiAgICBBcmdzOg0KICAgICAgICB1aV9tYWtlcl9wYXJhbXMgKFVJTWFrZXJQYXJhbXMpOiBTdGFuZGFyZCBwYXJhbWV0ZXJzIGZvciBtYWtpbmcgdWkgaXRlbS4NCiAgICAiIiINCiAgICBwYXJlbnRfdWlfaXRlbSA9IHVpX21ha2VyX3BhcmFtcy5wYXJlbnRfdWkNCiAgICAjIHBhcmVudCA9IHVpX21ha2VyX3BhcmFtcy5wYXJlbnRfY21wDQogICAgcGFuZWxwdXNoYnV0dG9uID0gdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudA0KICAgIGV4dF9hc21faW5mbyA9IHVpX21ha2VyX3BhcmFtcy5hc21faW5mbw0KDQogICAgaWYgcGFuZWxwdXNoYnV0dG9uLmlzX2JldGEgYW5kIG5vdCB1aV9tYWtlcl9wYXJhbXMuY3JlYXRlX2JldGFfY21kczoNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KICAgIG1sb2dnZXIuZGVidWcoJ1Byb2R1Y2luZyBwYW5lbCBidXR0b246ICVzJywgcGFuZWxwdXNoYnV0dG9uKQ0KICAgIHRyeToNCiAgICAgICAgcGFyZW50X3VpX2l0ZW0uY3JlYXRlX3BhbmVsX3B1c2hfYnV0dG9uKA0KICAgICAgICAgICAgYnV0dG9uX25hbWU9cGFuZWxwdXNoYnV0dG9uLm5hbWUsDQogICAgICAgICAgICBhc21fbG9jYXRpb249ZXh0X2FzbV9pbmZvLmxvY2F0aW9uLA0KICAgICAgICAgICAgY2xhc3NfbmFtZT1fZ2V0X2VmZmVjdGl2ZV9jbGFzc25hbWUocGFuZWxwdXNoYnV0dG9uKSwNCiAgICAgICAgICAgIHRvb2x0aXA9X21ha2VfYnV0dG9uX3Rvb2x0aXAocGFuZWxwdXNoYnV0dG9uKSwNCiAgICAgICAgICAgIHRvb2x0aXBfZXh0PV9tYWtlX3Rvb2x0aXBfZXh0X2lmX3JlcXVlc3RlZChwYW5lbHB1c2hidXR0b24sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0X2FzbV9pbmZvLm5hbWUpLA0KICAgICAgICAgICAgdG9vbHRpcF9tZWRpYT1wYW5lbHB1c2hidXR0b24ubWVkaWFfZmlsZSwNCiAgICAgICAgICAgIGN0eGhlbHB1cmw9cGFuZWxwdXNoYnV0dG9uLmhlbHBfdXJsLA0KICAgICAgICAgICAgYXZhaWxfY2xhc3NfbmFtZT1wYW5lbHB1c2hidXR0b24uYXZhaWxfY2xhc3NfbmFtZSwNCiAgICAgICAgICAgIHVwZGF0ZV9pZl9leGlzdHM9VHJ1ZSkNCg0KICAgICAgICBwYW5lbHB1c2hidXR0b25fdWkgPSBwYXJlbnRfdWlfaXRlbS5idXR0b24ocGFuZWxwdXNoYnV0dG9uLm5hbWUpDQoNCiAgICAgICAgX3NldF9oaWdobGlnaHRzKHBhbmVscHVzaGJ1dHRvbiwgcGFuZWxwdXNoYnV0dG9uX3VpKQ0KDQogICAgICAgIHJldHVybiBwYW5lbHB1c2hidXR0b25fdWkNCiAgICBleGNlcHQgUHlSZXZpdEV4Y2VwdGlvbiBhcyBlcnI6DQogICAgICAgIG1sb2dnZXIuZXJyb3IoJ1VJIGVycm9yOiAlcycsIGVyci5tc2cpDQogICAgICAgIHJldHVybiBOb25lDQoNCg0KZGVmIF9wcm9kdWNlX3VpX3BhbmVscyh1aV9tYWtlcl9wYXJhbXMpOg0KICAgICIiIkNyZWF0ZSBhIHBhbmVsIHdpdGggdGhlIGdpdmVuIHBhcmFtZXRlcnMuDQoNCiAgICBBcmdzOg0KICAgICAgICB1aV9tYWtlcl9wYXJhbXMgKFVJTWFrZXJQYXJhbXMpOiBTdGFuZGFyZCBwYXJhbWV0ZXJzIGZvciBtYWtpbmcgdWkgaXRlbS4NCg0KICAgIFJldHVybnM6DQogICAgICAgIChSZXZpdE5hdGl2ZVJpYmJvblBhbmVsKTogVGhlIGNyZWF0ZWQgcGFuZWwNCiAgICAiIiINCiAgICBwYXJlbnRfdWlfdGFiID0gdWlfbWFrZXJfcGFyYW1zLnBhcmVudF91aQ0KICAgIHBhbmVsID0gdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudA0KDQogICAgaWYgcGFuZWwuaXNfYmV0YSBhbmQgbm90IHVpX21ha2VyX3BhcmFtcy5jcmVhdGVfYmV0YV9jbWRzOg0KICAgICAgICByZXR1cm4gTm9uZQ0KDQogICAgbWxvZ2dlci5kZWJ1ZygnUHJvZHVjaW5nIHJpYmJvbiBwYW5lbDogJXMnLCBwYW5lbCkNCiAgICB0cnk6DQogICAgICAgIHBhcmVudF91aV90YWIuY3JlYXRlX3JpYmJvbl9wYW5lbChwYW5lbC5uYW1lLCB1cGRhdGVfaWZfZXhpc3RzPVRydWUpDQogICAgICAgIHBhbmVsX3VpID0gcGFyZW50X3VpX3RhYi5yaWJib25fcGFuZWwocGFuZWwubmFtZSkNCg0KICAgICAgICAjIHNldCBiYWNrZ3JvdW5kcw0KICAgICAgICBwYW5lbF91aS5yZXNldF9iYWNrZ3JvdW5kcygpDQogICAgICAgIGlmIHBhbmVsLnBhbmVsX2JhY2tncm91bmQ6DQogICAgICAgICAgICBwYW5lbF91aS5zZXRfYmFja2dyb3VuZChwYW5lbC5wYW5lbF9iYWNrZ3JvdW5kKQ0KICAgICAgICAjIG92ZXJyaWRlIHRoZSB0aXRsZSBiYWNrZ3JvdW5kIGlmIGV4aXN0cw0KICAgICAgICBpZiBwYW5lbC50aXRsZV9iYWNrZ3JvdW5kOg0KICAgICAgICAgICAgcGFuZWxfdWkuc2V0X3RpdGxlX2JhY2tncm91bmQocGFuZWwudGl0bGVfYmFja2dyb3VuZCkNCiAgICAgICAgIyBvdmVycmlkZSB0aGUgc2xpZGVvdXQgYmFja2dyb3VuZCBpZiBleGlzdHMNCiAgICAgICAgaWYgcGFuZWwuc2xpZGVvdXRfYmFja2dyb3VuZDoNCiAgICAgICAgICAgIHBhbmVsX3VpLnNldF9zbGlkZW91dF9iYWNrZ3JvdW5kKHBhbmVsLnNsaWRlb3V0X2JhY2tncm91bmQpDQoNCiAgICAgICAgX3NldF9oaWdobGlnaHRzKHBhbmVsLCBwYW5lbF91aSkNCg0KICAgICAgICBwYW5lbF91aS5zZXRfY29sbGFwc2UocGFuZWwuY29sbGFwc2VkKQ0KDQogICAgICAgIHJldHVybiBwYW5lbF91aQ0KICAgIGV4Y2VwdCBQeVJldml0RXhjZXB0aW9uIGFzIGVycjoNCiAgICAgICAgbWxvZ2dlci5lcnJvcignVUkgZXJyb3I6ICVzJywgZXJyLm1zZykNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KDQpkZWYgX3Byb2R1Y2VfdWlfdGFiKHVpX21ha2VyX3BhcmFtcyk6DQogICAgIiIiQ3JlYXRlIGEgdGFiIHdpdGggdGhlIGdpdmVuIHBhcmFtZXRlcnMuDQoNCiAgICBBcmdzOg0KICAgICAgICB1aV9tYWtlcl9wYXJhbXMgKFVJTWFrZXJQYXJhbXMpOiBTdGFuZGFyZCBwYXJhbWV0ZXJzIGZvciBtYWtpbmcgdWkgaXRlbS4NCiAgICAiIiINCiAgICBwYXJlbnRfdWkgPSB1aV9tYWtlcl9wYXJhbXMucGFyZW50X3VpDQogICAgdGFiID0gdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudA0KDQogICAgbWxvZ2dlci5kZWJ1ZygnVmVyaWZ5aW5nIHRhYjogJXMnLCB0YWIpDQogICAgaWYgdGFiLmhhc19jb21tYW5kcygpOg0KICAgICAgICBtbG9nZ2VyLmRlYnVnKCdUYWJzIGhhcyBjb21tYW5kOiAlcycsIHRhYikNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnUHJvZHVjaW5nIHJpYmJvbiB0YWI6ICVzJywgdGFiKQ0KICAgICAgICB0cnk6DQogICAgICAgICAgICBwYXJlbnRfdWkuY3JlYXRlX3JpYmJvbl90YWIodGFiLm5hbWUsIHVwZGF0ZV9pZl9leGlzdHM9VHJ1ZSkNCiAgICAgICAgICAgIHRhYl91aSA9IHBhcmVudF91aS5yaWJib25fdGFiKHRhYi5uYW1lKQ0KDQogICAgICAgICAgICBfc2V0X2hpZ2hsaWdodHModGFiLCB0YWJfdWkpDQoNCiAgICAgICAgICAgIHJldHVybiB0YWJfdWkNCiAgICAgICAgZXhjZXB0IFB5UmV2aXRFeGNlcHRpb24gYXMgZXJyOg0KICAgICAgICAgICAgbWxvZ2dlci5lcnJvcignVUkgZXJyb3I6ICVzJywgZXJyLm1zZykNCiAgICAgICAgICAgIHJldHVybiBOb25lDQogICAgZWxzZToNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnVGFiIGRvZXMgbm90IGhhdmUgYW55IGNvbW1hbmRzLiBTa2lwcGluZzogJXMnLCB0YWIubmFtZSkNCiAgICAgICAgcmV0dXJuIE5vbmUNCg0KDQpfY29tcG9uZW50X2NyZWF0aW9uX2RpY3QgPSB7DQogICAgZXh0cy5UQUJfUE9TVEZJWDogX3Byb2R1Y2VfdWlfdGFiLA0KICAgIGV4dHMuUEFORUxfUE9TVEZJWDogX3Byb2R1Y2VfdWlfcGFuZWxzLA0KICAgIGV4dHMuU1RBQ0tfQlVUVE9OX1BPU1RGSVg6IF9wcm9kdWNlX3VpX3N0YWNrcywNCiAgICBleHRzLlBVTExET1dOX0JVVFRPTl9QT1NURklYOiBfcHJvZHVjZV91aV9wdWxsZG93biwNCiAgICBleHRzLlNQTElUX0JVVFRPTl9QT1NURklYOiBfcHJvZHVjZV91aV9zcGxpdCwNCiAgICBleHRzLlNQTElUUFVTSF9CVVRUT05fUE9TVEZJWDogX3Byb2R1Y2VfdWlfc3BsaXRwdXNoLA0KICAgIGV4dHMuUFVTSF9CVVRUT05fUE9TVEZJWDogX3Byb2R1Y2VfdWlfcHVzaGJ1dHRvbiwNCiAgICBleHRzLlNNQVJUX0JVVFRPTl9QT1NURklYOiBfcHJvZHVjZV91aV9zbWFydGJ1dHRvbiwNCiAgICBleHRzLkNPTlRFTlRfQlVUVE9OX1BPU1RGSVg6IF9wcm9kdWNlX3VpX3B1c2hidXR0b24sDQogICAgZXh0cy5VUkxfQlVUVE9OX1BPU1RGSVg6IF9wcm9kdWNlX3VpX3B1c2hidXR0b24sDQogICAgZXh0cy5MSU5LX0JVVFRPTl9QT1NURklYOiBfcHJvZHVjZV91aV9saW5rYnV0dG9uLA0KICAgIGV4dHMuSU5WT0tFX0JVVFRPTl9QT1NURklYOiBfcHJvZHVjZV91aV9wdXNoYnV0dG9uLA0KICAgIGV4dHMuU0VQQVJBVE9SX0lERU5USUZJRVI6IF9wcm9kdWNlX3VpX3NlcGFyYXRvciwNCiAgICBleHRzLlNMSURFT1VUX0lERU5USUZJRVI6IF9wcm9kdWNlX3VpX3NsaWRlb3V0LA0KICAgIGV4dHMuUEFORUxfUFVTSF9CVVRUT05fUE9TVEZJWDogX3Byb2R1Y2VfdWlfcGFuZWxwdXNoYnV0dG9uLA0KICAgIH0NCg0KDQpkZWYgX3JlY3Vyc2l2ZWx5X3Byb2R1Y2VfdWlfaXRlbXModWlfbWFrZXJfcGFyYW1zKToNCiAgICBjbXBfY291bnQgPSAwDQogICAgZm9yIHN1Yl9jbXAgaW4gdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudDoNCiAgICAgICAgdWlfaXRlbSA9IE5vbmUNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnQ2FsbGluZyBjcmVhdGUgZnVuYyAlcyBmb3I6ICVzJywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbXBvbmVudF9jcmVhdGlvbl9kaWN0W3N1Yl9jbXAudHlwZV9pZF0sDQogICAgICAgICAgICAgICAgICAgICAgICAgIHN1Yl9jbXApDQogICAgICAgICAgICB1aV9pdGVtID0gX2NvbXBvbmVudF9jcmVhdGlvbl9kaWN0W3N1Yl9jbXAudHlwZV9pZF0oDQogICAgICAgICAgICAgICAgVUlNYWtlclBhcmFtcyh1aV9tYWtlcl9wYXJhbXMucGFyZW50X3VpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Yl9jbXAsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aV9tYWtlcl9wYXJhbXMuYXNtX2luZm8sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aV9tYWtlcl9wYXJhbXMuY3JlYXRlX2JldGFfY21kcykpDQogICAgICAgICAgICBpZiB1aV9pdGVtOg0KICAgICAgICAgICAgICAgIGNtcF9jb3VudCArPSAxDQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoNCiAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoJ0NhbiBub3QgZmluZCBjcmVhdGUgZnVuY3Rpb24gZm9yOiAlcycsIHN1Yl9jbXApDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgY3JlYXRlX2VycjoNCiAgICAgICAgICAgIG1sb2dnZXIuY3JpdGljYWwoDQogICAgICAgICAgICAgICAgJ0Vycm9yIGNyZWF0aW5nIGl0ZW06ICVzIHwgJXMnLCBzdWJfY21wLCBjcmVhdGVfZXJyDQogICAgICAgICAgICApDQoNCiAgICAgICAgbWxvZ2dlci5kZWJ1ZygnVUkgaXRlbSBjcmVhdGVkIGJ5IGNyZWF0ZSBmdW5jIGlzOiAlcycsIHVpX2l0ZW0pDQoNCiAgICAgICAgaWYgdWlfaXRlbSBcDQogICAgICAgICAgICAgICAgYW5kIG5vdCBpc2luc3RhbmNlKHVpX2l0ZW0sIGNvbXBvbmVudHMuR2VuZXJpY1N0YWNrKSBcDQogICAgICAgICAgICAgICAgYW5kIHN1Yl9jbXAuaXNfY29udGFpbmVyOg0KICAgICAgICAgICAgc3ViY21wX2NvdW50ID0gX3JlY3Vyc2l2ZWx5X3Byb2R1Y2VfdWlfaXRlbXMoDQogICAgICAgICAgICAgICAgVUlNYWtlclBhcmFtcyh1aV9pdGVtLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWlfbWFrZXJfcGFyYW1zLmNvbXBvbmVudCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Yl9jbXAsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aV9tYWtlcl9wYXJhbXMuYXNtX2luZm8sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aV9tYWtlcl9wYXJhbXMuY3JlYXRlX2JldGFfY21kcykpDQoNCiAgICAgICAgICAgICMgaWYgY29tcG9uZW50IGRvZXMgbm90IGhhdmUgYW55IHN1YiBjb21wb25lbnRzIGhpZGUgaXQNCiAgICAgICAgICAgIGlmIHN1YmNtcF9jb3VudCA9PSAwOg0KICAgICAgICAgICAgICAgIHVpX2l0ZW0uZGVhY3RpdmF0ZSgpDQoNCiAgICByZXR1cm4gY21wX2NvdW50DQoNCg0KaWYgbm90IEVYRUNfUEFSQU1TLmRvY19tb2RlOg0KICAgIGN1cnJlbnRfdWkgPSByaWJib24uZ2V0X2N1cnJlbnRfdWkoKQ0KDQoNCmRlZiB1cGRhdGVfcHlyZXZpdF91aSh1aV9leHQsIGV4dF9hc21faW5mbywgY3JlYXRlX2JldGE9RmFsc2UpOg0KICAgICIiIlVwZGF0ZXMvQ3JlYXRlcyBweVJldml0IHVpIGZvciB0aGUgZXh0ZW5zaW9uIGFuZCBhc3NlbWJseSBkbGwgYWRkcmVzcy4NCg0KICAgIEFyZ3M6DQogICAgICAgIHVpX2V4dCAoR2VuZXJpY1VJQ29udGFpbmVyKTogVUkgY29udGFpbmVyLg0KICAgICAgICBleHRfYXNtX2luZm8gKEFzc2VtYmx5SW5mbyk6IEFzc2VtYmx5IGluZm8uDQogICAgICAgIGNyZWF0ZV9iZXRhIChib29sLCBvcHRpb25hbCk6IENyZWF0ZSBiZXRhIHVpLiBEZWZhdWx0cyB0byBGYWxzZS4NCiAgICAiIiINCiAgICBtbG9nZ2VyLmRlYnVnKCdDcmVhdGluZy9VcGRhdGluZyB1aSBmb3IgZXh0ZW5zaW9uOiAlcycsIHVpX2V4dCkNCiAgICBjbXBfY291bnQgPSBfcmVjdXJzaXZlbHlfcHJvZHVjZV91aV9pdGVtcygNCiAgICAgICAgVUlNYWtlclBhcmFtcyhjdXJyZW50X3VpLCBOb25lLCB1aV9leHQsIGV4dF9hc21faW5mbywgY3JlYXRlX2JldGEpKQ0KICAgIG1sb2dnZXIuZGVidWcoJyVzIGNvbXBvbmVudHMgd2VyZSBjcmVhdGVkIGZvcjogJXMnLCBjbXBfY291bnQsIHVpX2V4dCkNCg0KDQpkZWYgc29ydF9weXJldml0X3VpKHVpX2V4dCk6DQogICAgIiIiU29ydHMgcHlSZXZpdCBVSS4NCg0KICAgIEFyZ3M6DQogICAgICAgIHVpX2V4dCAoR2VuZXJpY1VJQ29udGFpbmVyKTogVUkgY29udGFpbmVyLg0KICAgICIiIg0KICAgICMgb25seSB3b3JrcyBvbiBwYW5lbHMgc28gZmFyDQogICAgIyByZS1vcmRlcmluZyBvZiB1aSBjb21wb25lbnRzIGRlZXBlciB0aGFuIHBhbmVscyBoYXZlIG5vdCBiZWVuIGltcGxlbWVudGVkDQogICAgZm9yIHRhYiBpbiBjdXJyZW50X3VpLmdldF9weXJldml0X3RhYnMoKToNCiAgICAgICAgZm9yIGxpdGVtIGluIHVpX2V4dC5maW5kX2xheW91dF9pdGVtcygpOg0KICAgICAgICAgICAgaWYgbGl0ZW0uZGlyZWN0aXZlOg0KICAgICAgICAgICAgICAgIGlmIGxpdGVtLmRpcmVjdGl2ZS5kaXJlY3RpdmVfdHlwZSA9PSAnYmVmb3JlJzoNCiAgICAgICAgICAgICAgICAgICAgdGFiLnJlb3JkZXJfYmVmb3JlKGxpdGVtLm5hbWUsIGxpdGVtLmRpcmVjdGl2ZS50YXJnZXQpDQogICAgICAgICAgICAgICAgZWxpZiBsaXRlbS5kaXJlY3RpdmUuZGlyZWN0aXZlX3R5cGUgPT0gJ2FmdGVyJzoNCiAgICAgICAgICAgICAgICAgICAgdGFiLnJlb3JkZXJfYWZ0ZXIobGl0ZW0ubmFtZSwgbGl0ZW0uZGlyZWN0aXZlLnRhcmdldCkNCiAgICAgICAgICAgICAgICBlbGlmIGxpdGVtLmRpcmVjdGl2ZS5kaXJlY3RpdmVfdHlwZSA9PSAnYWZ0ZXJhbGwnOg0KICAgICAgICAgICAgICAgICAgICB0YWIucmVvcmRlcl9hZnRlcmFsbChsaXRlbS5uYW1lKQ0KICAgICAgICAgICAgICAgIGVsaWYgbGl0ZW0uZGlyZWN0aXZlLmRpcmVjdGl2ZV90eXBlID09ICdiZWZvcmVhbGwnOg0KICAgICAgICAgICAgICAgICAgICB0YWIucmVvcmRlcl9iZWZvcmVhbGwobGl0ZW0ubmFtZSkNCg0KDQpkZWYgY2xlYW51cF9weXJldml0X3VpKCk6DQogICAgIiIiQ2xlYW51cCB0aGUgcHlyZXZpdCBVSS4NCg0KICAgIEhpZGUgYWxsIGl0ZW1zIHRoYXQgd2VyZSBub3QgdG91Y2hlZCBhZnRlciBhIHJlbG9hZA0KICAgIG1lYW5pbmcgdGhleSBoYXZlIGJlZW4gcmVtb3ZlZCBpbiBleHRlbnNpb24gZm9sZGVyIHN0cnVjdHVyZQ0KICAgIGFuZCB0aHVzIGFyZSBub3QgdXBkYXRlZC4NCiAgICAiIiINCiAgICB1bnRvdWNoZWRfaXRlbXMgPSBjdXJyZW50X3VpLmdldF91bmNoYW5nZWRfaXRlbXMoKQ0KICAgIGZvciBpdGVtIGluIHVudG91Y2hlZF9pdGVtczoNCiAgICAgICAgaWYgbm90IGl0ZW0uaXNfbmF0aXZlKCk6DQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgbWxvZ2dlci5kZWJ1ZygnRGVhY3RpdmF0aW5nOiAlcycsIGl0ZW0pDQogICAgICAgICAgICAgICAgaXRlbS5kZWFjdGl2YXRlKCkNCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZGVhY3RfZXJyOg0KICAgICAgICAgICAgICAgIG1sb2dnZXIuZGVidWcoZGVhY3RfZXJyKQ0KDQoNCmRlZiByZWZsb3dfcHlyZXZpdF91aShkaXJlY3Rpb249YXBwbG9jYWxlcy5ERUZBVUxUX0xBTkdfRElSKToNCiAgICAiIiJTZXQgdGhlIGZsb3cgZGlyZWN0aW9uIG9mIHRoZSB0YWJzLiIiIg0KICAgIGlmIGRpcmVjdGlvbiA9PSAiTFRSIjoNCiAgICAgICAgY3VycmVudF91aS5zZXRfTFRSX2Zsb3coKQ0KICAgIGVsaWYgZGlyZWN0aW9uID09ICJSVEwiOg0KICAgICAgICBjdXJyZW50X3VpLnNldF9SVExfZmxvdygpDQo=</item>
                        <item name="Title" type_name="gh_string" type_code="10">Py3</item>
                      </items>
                      <chunks count="1">
                        <chunk name="LanguageSpec">
                          <items count="2">
                            <item name="Taxon" type_name="gh_string" type_code="10">*.*.python</item>
                            <item name="Version" type_name="gh_string" type_code="10">3.*</item>
                          </items>
                        </chunk>
                      </chunks>
                    </chunk>
                    <chunk name="ScriptEditor">
                      <items count="1">
                        <item name="StartBounds" type_name="gh_drawing_rectangle" type_code="34">
                          <X>1920</X>
                          <Y>189</Y>
                          <W>754</W>
                          <H>898</H>
                        </item>
                      </items>
                    </chunk>
                  </chunks>
                </chunk>
              </chunks>
            </chunk>
          </chunks>
        </chunk>
      </chunks>
    </chunk>
    <chunk name="Thumbnail">
      <items count="1">
        <item name="Thumbnail" type_name="gh_drawing_bitmap" type_code="37">
          <bitmap length="1134">iVBORw0KGgoAAAANSUhEUgAAAJYAAABkCAIAAADrOV6nAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAQDSURBVHhe7dldUxpnGMbxfNpO2siLwvKywLKuEIya1BDiCxWURYIYNG0OqqikatIDG1+r02oyRrK4u0Fk8hHSYUjbhJNw5l5w/eY+YHlm7pP/7MwzcOsWdYFPBOv/hFUCxITwmBAeE8JjQnhMCI8J4TEhPCaEx4TwmBAeE8JjQnhMCI8J4TEhPCaEx4TwmBAeE8JjQnhMCI8J4TEhPCaEx4TwmBAeE8JjQnhMCI8J4TEhPCaEx4TwmBAeE8JjQnhMCI8J4TEhPCaEZ9GEhmGYpmkaHY9pGobRvqU3WDGhfqmf/H2ye7i7f7Tf4ewd7h3/dXx5edm+qwdYLqGu65X3F9v7L/feHuye7X173jRn7+3B1v72+cV5D76LlktYv6oXnhYWy8X1kxelo42Vw7XV1hxvlE42Vo/WVw7Xml8era8erZf+3Fg5KP16UFo7Li9uLuUWcle1q/aN3c5aCev1enmj7HA6kqW0XIh4kt5I8V50eSRaHJEmBoPxsFKIDS0NR5dHAxlJmPYEMtLAhCuUlSPPRh6vTPe7nM9/ed5oNNr3djVrJazVajs7Ow6n48dnj6T8kGvSrSzGlOLw4FxUHAq4nK5YeiT285hSHPanA+4pwTXpdk8JUk5RlobHlscdA47N3zbr9Xr73q5mrYSapl3Xr1/9/krJRMOFiFy4Ky9GQ4mw2yP4ZTGohFK5dLI4E8or8kL0vwnnI9JCRJpTXmyWG9cNTdPa93Y1ayWsVqumYVYvq7GFUXE+HMopoQXFd0+MDkdzxSeZvJpVs/FsQszJzaMvJjAvD87fPa+cfzA/tG/sdpZL2LrOeCdFcT4sZmVRDXtnguO5+NLTpVQuPao+CKqDflUS1bCoNk8/TzYsTPmzT7K8ztyw1nXG5rDFCqOun7y2uMOTDnjmAsHsYFxNPFQfBVVZmBV9Gcn5eKBv3ObPSN7ZoHc26JkLDuVj9n47rzM3rFarvf7jtd1pF1NS/7Rwe+x7TzogpET3jN+V8rlSPveMX0iJnnSg76H9hwd3WqfNSYu+VMjmtG1vbV9d9daLaK2EmqY1Go2tl1u37/fZp1z2yQFnUnBMt8b974fmOJOCM+n58vG7+3dK5bWPjY+8ztwwXdc1TYvMxvoTgjDpFyZ8nUx/QpBnht5dvDN0/jpjAbquv69UTs9Oz96cdTinZ6eVi0oP9rNowlZF02j++dAh0zB1XW/f0hssmpA6x4TwmBAeE8JjQnhMCI8J4TEhPCaEx4TwmBAeE8JjQnhMCI8J4TEhPCaEx4TwmBAeE8JjQnhMCI8J4TEhPCaEx4TwmBAeE8JjQnhMCI8J4TEhPCaEx4TwmBAeE8JjQnhMCI8J4TEhvK8SEqjPCQnaP7R/knSrJ0oKAAAAAElFTkSuQmCC</bitmap>
        </item>
      </items>
    </chunk>
  </chunks>
</Archive>